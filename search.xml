<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>æ— èŠ</title>
      <link href="/2019/11/15/%E5%BF%83%E8%AE%B0/20191115%E5%BF%83%E8%AE%B0/"/>
      <url>/2019/11/15/%E5%BF%83%E8%AE%B0/20191115%E5%BF%83%E8%AE%B0/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ã€€ã€€è·ç¦»ä¸Šä¸€æ¬¡æ›´æ–°åšå®¢ï¼Œå¿«å››ä¸ªå¤šæœˆäº†ï¼Œè¿™æ®µæ—¶é—´å‘ç”Ÿäº†å¾ˆå¤šäº‹æƒ…ã€‚å¤§éƒ¨åˆ†éƒ½æ˜¯å¼€å¿ƒğŸ˜Šçš„äº‹æƒ…ï¼Œæ‰€ä»¥ä¸­é—´ä¹Ÿæœ‰ä¸€äº›éº»çƒ¦å’Œé—¹å¿ƒã€‚ä½†éƒ½æŒºå¥½ä¸ç®¡æ˜¯è¿‡ç¨‹è¿˜æ˜¯ç»“æœã€‚éƒ½æŒºæ„‰å¿«ã€‚è¿™æ®µæ—¶é—´ä¸»è¦æ˜¯è€ƒç§‘äºŒï¼Œç»“å©šï¼Œè½¬æ­£ã€‚10æœˆ4å·ç»“å©šï¼Œç»“å©šå‰ç”±äºæˆ‘å’Œæˆ‘è€å©†ä¸¤ä¸ªäººæŠŠå¾ˆå¤šäº‹æƒ…æƒ³çš„æ¯”è¾ƒç®€å•ï¼Œå¯¼è‡´å‘ç”Ÿäº†ä¸€äº›æ²Ÿé€šä¸å½“å¯¼è‡´çš„ä¸æ„‰å¿«ï¼Œæœ€åè¿˜æ˜¯é¡ºé¡ºåˆ©åˆ©ï¼Œæ„Ÿè°¢ä¸»ï¼Œæ„Ÿè°¢å¼Ÿå…„å§å¦¹ï¼Œè¿˜æœ‰çˆ¶æ¯ï¼Œå®¶äººï¼Œäº²æˆšï¼Œé‚»é‡Œã€‚ä»–ä»¬éƒ½å¸®äº†å¾ˆå¤šå¿™ã€‚åŒæ–¹çˆ¶æ¯çš„æ“åŠ³ï¼Œäº²æˆšçš„å¿™å‰å¿™åã€‚å¤ªè¾›è‹¦ä»–ä»¬äº†ã€‚æœ‰æ—¶çœŸçš„æ„Ÿè§‰è‡ªå·±æœ‰äº›ä¸å¤ªæ‡‚äº‹ã€‚ä¸æ„¿æ„å»åšï¼Œå»è¯´ã€‚ä¹Ÿè®¸è¿™æ˜¯äººéœ€è¦çš„ä¸€äº›æˆé•¿ã€‚ä¸æ“…é•¿äººé™…å…³ç³»ï¼Œä½†å¾€å¾€ä½ åœ¨è¿™ä¸ªç”Ÿæ´»åœˆå†…ï¼Œä½ éœ€è¦å»å’Œåˆ«äººæ²Ÿé€šï¼Œè¯´è¯ç­‰ç­‰ã€‚æ•´ä¸ªå©šç¤¼æŒºå®Œç¾ï¼Œä¸€ç›´æ‹…å¿ƒå¤©æ°”ç­‰ç­‰ï¼Œæ„Ÿè°¢ä¸»ï¼Œæ¥å®Œè€å©†ï¼Œä¸ä¹…åæ‰ä¸‹çš„é›¨ã€‚çƒ­çƒ­é—¹é—¹ï¼Œéå¸¸æ„‰å¿«å¼€å¿ƒã€‚  å¯èƒ½æœ‰ä¸€ç‚¹ç‚¹å°çš„é—æ†¾å°±æ˜¯ï¼Œæˆ‘ä¸¤äººæ²¡æœ‰å©šå‡ï¼Œå¯¼è‡´æ•´ä¸ªåä¸€ç´§å¼ è€Œå¿™ç¢Œçš„åº¦è¿‡ã€‚æ²¡èƒ½å¥½å¥½é™ªå¥¹å‡ºå»æ—…æ¸¸ï¼Œæ²¡æœ‰ä¸€ä¸ªèœœæœˆæ—…æ¸¸ã€‚åœ¨æ­¤åº”è¯¥è®°å½•ä¸‹æ¥ï¼Œä¸€å®šè¦å¸¦å¥¹å‡ºå»ç©ç©ã€‚<br>ã€€ã€€é©¾ç…§ï¼Œè·ä¸Šä¸€æ¬¡ç§‘äºŒå¤±åˆ©åï¼Œä¸ä¹…åˆè€ƒäº†ä¸€æ¬¡ï¼Œé¡ºåˆ©é€šè¿‡ï¼Œåä¸€å‰ç§‘ä¸‰ä¹Ÿå­¦äº†å¾ˆä¹…ï¼Œç”±äºç»“å©šå‰å¤ªå¤šäº‹ï¼Œå°±æ²¡å»è€ƒï¼Œä¸€ç›´æ‹–åˆ°11æœˆæ‰è€ƒè¯•ç»ƒäº†å‡ æ¬¡ã€‚æ‰“ç®—ä¸‹ä¸‹å‘¨ä¸€ï¼Œé¡ºåˆ©é€šè¿‡ï¼Œæ±‚ä¸»å¸®åŠ©ã€‚ä¸å¸Œæœ›åœ¨è¿™ä¸ªäº‹æƒ…æµªè´¹å¤ªå¤šæ—¶é—´å’Œç²¾åŠ›ã€‚<br>ã€€ã€€å·¥ä½œï¼Œä¸‰ä¸ªæœˆçš„é€‚åº”æœŸå·²ç»ç»“æŸï¼Œå·²ç»æˆä¸ºæ­£å¼å‘˜å·¥ï¼Œå…¥èŒå¿«å››ä¸ªæœˆäº†ï¼Œä¹Ÿæ˜¯ä¸Šæ¬¡åšå®¢æ›´æ–°æ—¶é—´ã€‚è¿™å››ä¸ªæœˆå·¥ä½œä¸ç®—å¿™ç¢Œï¼Œæ²¡æœ‰å¤ªå¤šäº‹æƒ…ã€‚ä¸å¤ªå¿™ç¢Œï¼Œæ„Ÿè§‰æœ‰äº›å®‰é€¸ã€‚è¿™ä¸€å‘¨çªç„¶æœ‰å¾ˆå¼ºåŠ›çš„å­¦ä¹ æ¬²æœ›ã€‚æˆ–è‡ªæˆ‘çº¦æŸï¼Œè§‰å¾—è‡ªå·±ä¸åº”è¯¥è¿™æ ·ï¼Œåº”è¯¥è‡ªæˆ‘å……å®ä¸€ä¸‹ï¼Œç»ƒç»ƒç®—æ³•ï¼Œæ²‰æ²‰åº•ã€‚å¥½å¥½åšä¸ªå­¦ä¹ è®¡åˆ’ï¼Œè®©è‡ªå·±çš„è„‘å­åŠ¨ä¸€åŠ¨ã€‚æ¯å¤©è¿›æ­¥ä¸€ç‚¹ç‚¹ï¼Œå¾ªåºæ¸è¿›ã€‚å‰å‡ å¤©çœ‹åˆ°å“¥åˆ†äº«ä¸€ç›˜æ–‡ç« â€ç»™å¤§è„‘æŒ‚ä¸ªå¤–ç½®ç¡¬ç›˜â€ï¼Œæ—¢åšç¬”è®°ã€‚è®°å½•æ¯å¤©éƒ½å¹²äº†å•¥ã€‚äººçš„é—å¿˜æ€§æ¯”è¾ƒå¼ºï¼Œå®ƒå¯¹äº‹æƒ…åªä¼šè®°å½•æœ€è§¦åŠçš„ä¸€ç‚¹ã€‚ä¸€ä»¶äº‹æƒ…ï¼Œå®ƒåªä¼šè®°å½•ä¸€å°æ®µï¼Œå‰©ä¸‹çš„å°±éœ€è¦å¤–éƒ¨è®°å½•ã€‚å½“å›æ”¾æ—¶å¤§è„‘å´ä¼šè¿…é€Ÿæƒ³èµ·å¾ˆå¤šç»†èŠ‚ï¼Œå¾ˆç¥å¥‡ã€‚ç”±äºä»¥ä¸Šçš„è‡ªæˆ‘åˆºæ¿€å’Œçº¦æŸã€‚æ‰€ä»¥åˆé‡æ–°å¼€å§‹å†…å¿ƒçš„è®°å½•ã€‚è¿™æ¬¡å°è¯•åœ¨æ‰‹æœºä¸Šåšå¿ƒè®°ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥éšæ—¶éšåœ°ï¼Œç«‹åˆ»å»å†™ã€‚ä½†æ˜¯è¿˜æ˜¯ä¸æ¸…æ¥šæ˜¯å¦ä¾¿æ·æ–¹ä¾¿ã€‚å°±çœ‹è¿™ç¯‡æ–‡ç« èƒ½å¤Ÿå‘å‡ºå»ä¸ï¼Œå˜¿å˜¿ã€‚æœ€åæ¥ä¸€é¦–æœ€è¿‘å¬çš„æ¯”è¾ƒé¡ºè€³çš„æ­Œæ›²â€ä½ çš„é…’é¦†å¯¹æˆ‘æ‰“äº†çƒŠâ€ã€‚</p>        <div id="aplayer-fQcndvdw" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;"></div>  <script>  var options = {"narrow":false,"autoplay":false,"showlrc":3,"mode":"random","music":[{"title":"ä½ çš„é…’é¦†å¯¹æˆ‘æ‰“äº†çƒŠ","author":"é™ˆé›ªå‡","url":"/audio/ä½ çš„é…’é¦†å¯¹æˆ‘æ‰“äº†çƒŠ_é™ˆé›ªå‡.mp3","pic":"/audio/é™ˆé›ªå‡.png","lrc":"/audio/ä½ çš„é…’é¦†å¯¹æˆ‘æ‰“äº†çƒŠ_é™ˆé›ªå‡.lrc"}]};  options.element = document.getElementById("aplayer-fQcndvdw");  var ap = new APlayer(options);    window.aplayers || (window.aplayers = []);  window.aplayers.push(ap);  </script>]]></content>
      
      <categories>
          
          <category> å¿ƒè®° </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>ç­‰å¾…</title>
      <link href="/2019/07/21/%E5%BF%83%E8%AE%B0/20190721%E5%BF%83%E8%AE%B0/"/>
      <url>/2019/07/21/%E5%BF%83%E8%AE%B0/20190721%E5%BF%83%E8%AE%B0/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ã€€ã€€ä¸Šå‘¨ï¼Œä¸€ç›´åœ¨ç­‰å¾…ä¹‹å‰é¢è¯•ç»“æœï¼ŒåŸä»¥ä¸ºä¼šæœ‰è‡ªå·±æƒ³å»çš„å…¬å¸ï¼Œæ²¡æƒ³åˆ°æ²¡ä»»ä½•æ¶ˆæ¯ï¼Œä¸Šå‘¨æ²¡æ€ä¹ˆåˆ·ç®€å†ï¼Œæ²¡æƒ³åˆ°å‘¨å››å­¦å®Œè½¦ä¹‹åæœ‰ä¸¤å®¶çº¦é¢è¯•ï¼Œç„¶åè¿™å‘¨ä¹Ÿä¸æƒ³åˆ·ç®€å†ï¼Œå‘¨ä¸€åˆšå¥½é€šçŸ¥ï¼Œä¸Šå‘¨å…­çš„é¢è¯•é€šè¿‡ã€‚è¯´æ˜¯ä¸‹å‘¨ä¸‰å…¥èŒï¼Œéœ€è¦èµ°æµç¨‹ï¼Œå‘¨ä¸‰å‘offerã€‚è¿™å‘¨å°±ç›¸å¯¹æ¯”è¾ƒè½»æ¾ï¼Œä¼‘æ¯ä¼‘æ¯ï¼Œå‘¨äº”ä½“ä¸ªæ£€ï¼ŒåŠå¼ å¡ã€‚ç­‰å€™å…¥èŒã€‚å‘¨å¤©ï¼Œä¸ˆæ¯å¨˜ç”Ÿæ—¥ï¼Œåƒé¡¿äº†é¡¿çƒ¤è‚‰ï¼Œå¥½ä¹…æ²¡åœ¨å¤–é¢åƒé¥­äº†ï¼ŒæŒºé¦™ï¼Œæ»‹æ¶¦ï¼Œèˆ’å¦ã€‚</p><div align="center"><p><img src="/img/xj/2019072101.png" alt="ç¾é£Ÿ"></p></div><p></p><p>ã€€ã€€å½“ä½ æ”¾ä¸‹é¢å­èµšé’±çš„æ—¶å€™ï¼Œè¯´æ˜ä½ å·²ç»æ‡‚äº‹äº†ã€‚å½“ä½ ç”¨é’±èµšå›é¢å­çš„æ—¶å€™ï¼Œè¯´æ˜ä½ å·²ç»æˆåŠŸäº†ã€‚å½“ä½ ç”¨é¢å­å¯ä»¥èµšé’±çš„æ—¶å€™ï¼Œè¯´æ˜ä½ å·²ç»æ˜¯äººç‰©äº†ã€‚å½“ä½ è¿˜åœç•™åœ¨é‚£é‡Œå–é…’ã€å¹ç‰›ï¼Œå•¥ä¹Ÿä¸æ‡‚è¿˜è£…æ‡‚ï¼Œåªçˆ±æ‰€è°“çš„é¢å­çš„æ—¶å€™ï¼Œè¯´æ˜ä½ è¿™è¾ˆå­ä¹Ÿå°±è¿™æ ·äº†ã€‚</p>        <div id="aplayer-LXuGMRFv" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;"></div>  <script>  var options = {"narrow":false,"autoplay":false,"showlrc":3,"mode":"random","music":[{"title":"å†œå¤«æ¸”å¤«","author":"å¤§ä¹”å°ä¹”","url":"/audio/å†œå¤«æ¸”å¤«-å¤§ä¹”å°ä¹”.mp3","pic":"/audio/å¤§ä¹”å°ä¹”.png","lrc":"/audio/å†œå¤«æ¸”å¤«-å¤§ä¹”å°ä¹”.txt"},{"title":"ç­‰å¾…æˆˆå¤š","author":"æ—åŠ›å°§","url":"/audio/ç­‰å¾…æˆˆå¤š-æ—åŠ›å°§.mp3","pic":"/audio/æ—åŠ›å°§.png","lrc":"/audio/ç­‰å¾…æˆˆå¤š-æ—åŠ›å°§.txt"}]};  options.element = document.getElementById("aplayer-LXuGMRFv");  var ap = new APlayer(options);    window.aplayers || (window.aplayers = []);  window.aplayers.push(ap);  </script>]]></content>
      
      <categories>
          
          <category> å¿ƒè®° </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>æ±‚èŒ</title>
      <link href="/2019/07/14/%E5%BF%83%E8%AE%B0/20190714%E5%BF%83%E8%AE%B0/"/>
      <url>/2019/07/14/%E5%BF%83%E8%AE%B0/20190714%E5%BF%83%E8%AE%B0/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ã€€ã€€å‘¨ä¸€é¢è¯•äº†ä¸€ä¸‹æƒ³å»çš„è¿™å®¶å…¬å¸ï¼Œæ€»ä½“èŠçš„è¿˜è¡Œï¼ŒèŠä¸‹æ¥æ„Ÿè§‰ï¼Œå°±æ˜¯è‡ªå·±å·¥ä½œè¿™å‡ å¹´ä¸€ç›´æ²¡æœ‰æŠŠæŠ€æœ¯æŒ–æ·±ï¼ŒæŠ€æœ¯å¹¿è€Œä¸æ·±ï¼ŒçŸ¥é“å¾ˆå¤šï¼Œä»€ä¹ˆéƒ½ä¼šä¸€ç‚¹ã€‚ä½†æ˜¯å¾€æ·±æŒ–ä¸€ç‚¹ï¼Œå°±ä¸å¤ªè¡Œäº†ã€‚å¯èƒ½æ˜¯ä¹‹å‰çš„å·¥ä½œæœ‰å…³ï¼Œä¸€ç›´åšçš„æ¯”è¾ƒååº”ç”¨ï¼Œè¿˜æœ‰è‡ªå·±çš„åŸå› å¯¼è‡´æ²¡æœ‰å»æ·±æŒ–ã€‚æœ€è¿‘çš„å‡ æ¬¡é¢è¯•è§‰å¾—ï¼Œè‡ªå·±ä¸¤ä¸ªæ–¹å‘å‘å±•ï¼šmcuã€linuxã€‚mcuè¿™å—çš„éœ€è¦å­¦ä¹ çš„ä¸œè¥¿ï¼Œç†Ÿæ‚‰ä¸€äº›ç³»ç»Ÿï¼Œè¿˜æœ‰ä¸€äº›æ— çº¿æ¨¡å—ï¼ˆè“ç‰™ï¼Œzigbeeï¼‰ã€‚linuxè¿™å—å¤šäº†ï¼Œå†…å­˜ç®¡ç†ï¼Œå†…å­˜åˆ†é…ï¼Œç³»ç»Ÿè°ƒç”¨ç­‰ç­‰ã€‚è¿™å®¶é¢è¯•æ„Ÿè§‰æŒºå¥½ï¼ŒhrèŠçš„è¿‡ç¨‹ä¸­ï¼Œæœ‰äº›è¡¨è¾¾å¤ªè¿‡äº†ã€‚è¿‡äºè¡¨ç°è‡ªå·±æƒ³æ¥ã€‚æ™šä¸Šå’Œè€å©†èŠå¤©ï¼Œæœ¬æƒ³è¯´è¯´é¢è¯•ä¸Šçš„ä¸€äº›äº‹æƒ…ï¼Œæƒ³å¬å¬å»ºè®®ï¼Œå´é—¹çš„æƒ…ç»ªä¸å¥½ã€‚å¥¹æœ€è¿‘ä¹Ÿæ¯”è¾ƒç´¯ã€‚åˆšè¿›æ–°çš„å…¬å¸ï¼Œå·¥ä½œæ¯”è¾ƒå¿™ï¼Œä¸‹ç­æ¯”è¾ƒæ™šï¼Œæ²¡èƒ½å»é™ªå¥¹ï¼Œè¿˜æƒ¹å¥¹ä¸å¼€å¿ƒã€‚å“ï¼Œå¿ƒç–¼ã€‚<br>ã€€ã€€å‘¨äºŒé¢è¯•ï¼ŒèŠä¸‹æ¥çš„æ„Ÿè§‰å°±æ˜¯éœ€è¦çš„æŠ€æœ¯åå‘äºmcuï¼Œä¸ªäººä¹‹å‰æ¥è§¦çš„å¤ªå°‘ï¼Œè€Œä¸”æ¥è§¦çš„éƒ½æ˜¯æ¯”è¾ƒlowçš„èŠ¯ç‰‡ï¼Œç›®å‰å¾ˆå°‘ç”¨ï¼Œç®—èŒä½ä¸åŒ¹é…æ²¡äº‹ã€‚ä¸‹åˆåˆ·äº†åˆ·ç®€å†ï¼Œæ„Ÿè§‰æ²¡å•¥å¥½å…¬å¸ï¼Œçƒ¦èºã€‚åˆ·è§†é¢‘ï¼Œå •è½ã€‚å‘¨ä¸‰æƒ³ç€çœ‹çœ‹ä¹¦ï¼Œé™é™å¿ƒã€‚æ—©ä¸Šèµ·æ¥å´åˆ·äº†åˆ·è§†é¢‘ã€‚ç„¶åæŠŠåšå®¢é‡æ–°æ•´ç†çš„ä¸€ä¸‹ï¼Œæ–°å¢äº†éŸ³ä¹å’Œè§†é¢‘çš„å†…å®¹ã€‚<br>ã€€ã€€ä¸€ä¸ªäººéœ€è¦è¿½æ±‚çš„å“è´¨ç”Ÿæ´»åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿæœ€é‡è¦çš„å…¶å®åœ¨ä¸ä¸€ä¸ªäººå¯¹ç”Ÿæ´»çš„æ€åº¦ï¼Œä½ æ—¢è¦æœ‰æ¥å—æœ€å¥½çš„ä¸€åˆ‡çš„èƒ½åŠ›ï¼Œä¹Ÿè¦æœ‰é¢å¯¹æœ€åçš„å¦ç„¶å¿ƒæ€ã€‚<br>ã€€ã€€å‘¨ä¸‰å •è½ä¸€å¤©ï¼Œæ™šä¸Šåƒå®Œé¥­ï¼Œå¿ƒæƒ…ä¸æ˜¯ç‰¹åˆ«å¥½ï¼Œç„¶åå°±æ˜¯å‡ºé—¨çæºœè¾¾ï¼Œæ•£æ•£å¿ƒï¼Œå‡å‡è‚‰ã€‚çƒ¦èºä¸å®‰ï¼Œå‘¨å››è¦è€ƒç§‘ç›®äºŒï¼Œè¿‡äºç´§å¼ ä¸å®‰ï¼Œå·¥ä½œä¹Ÿæ²¡ç€è½ï¼Œå¿ƒæƒ…ä¸çˆ½ã€‚</p><div align="center"><p><img src="/img/xj/2019071401.png" alt="æ•£æ­¥æ•£å¿ƒ"></p></div><p></p><p>ã€€ã€€å‘¨å››è€ƒç§‘ç›®äºŒï¼Œä¸€æ™šä¸Šæ²¡æ€ä¹ˆç¡å¥½ï¼Œå¾ˆç´§å¼ ğŸ˜“ï¼Œä¸€å¤§æ—©å»ç»ƒäº†ç»ƒè½¦ï¼Œ10ç‚¹ç»“æŸä¸€ç›´åˆ°ä¸‹åˆ2ç‚¹åŠæ‰è€ƒè¯•ï¼Œç„¶åæŒ‚äº†ï¼Œç¬¬ä¸€æ¬¡ï¼Œå€’è½¦å…¥åº“ï¼Œç›´æ¥æ‡µé€¼ï¼Œåé¢æ— ä»»ä½•å¿ƒç†èµ°å®Œå…¨ç¨‹ï¼Œè‡ªæˆ‘æ„Ÿè§‰è‰¯å¥½ã€‚ç¬¬äºŒæ¬¡ï¼Œå¡é“åé›ã€‚å€’è½¦å…¥åº“okï¼Œæ„Ÿè§‰è‰¯å¥½ï¼Œç„¶åè¿‡äºéª„å‚²ï¼Œå¡é“ç›´æ¥åé›ã€‚å½’æ ¹ç»“åº•ï¼Œå°±æ˜¯è½¦ä¸å¥½ã€‚ä¸‹åˆå›å®¶ï¼Œæ¥åˆ°é¢è¯•é€šçŸ¥ï¼Œå‘¨å…­é¢è¯•ï¼Œå› å‘¨å…­å­¦è½¦ï¼Œç„¶åçº¦çš„2ç‚¹åŠé¢è¯•ã€‚<br>ã€€ã€€å‘¨äº”é†’çš„å¾ˆæ—©ï¼Œç„¶åæ— æ„é—´åˆ·åˆ°ã€Šæ˜æ—¥ä¹‹å­ã€‹ï¼Œæœ‰äº›æ”¶ç›Šï¼Œæ¯ä¸ªäººéƒ½å»è¿›è¡Œä¸€æ¬¡é¢è¯•è¡¨æ¼”ï¼Œä¸é¢è¯•å®˜çš„äº¤æµï¼Œæœ‰çš„è¯å¤šï¼Œæœ‰çš„ç´§å¼ ï¼Œè¯¥è¯´çš„å’Œä¸è¯¥è¯´çš„ï¼Œéƒ½å»è¯´ã€‚è®©è‡ªå·±æ„Ÿè§‰ä¹‹å‰çš„é¢è¯•å°±æœ‰äº›è¯ç—¨ï¼Œå¤ªè¿‡äºæš´éœ²è‡ªå·±ï¼Œåº”è¯¥ä¸‰æ€äºŒåè¡Œã€‚ä¸‹åˆä¸¤ç‚¹å¤šï¼Œçªç„¶è¯´æ˜¯æœ‰é¢è¯•ï¼Œä¸åˆ°ä¸¤å°æ—¶çš„åœ°é“ï¼Œå†’é›¨å»é¢è¯•ï¼Œåæ±½è½¦ä»ªè¡¨ç›˜ï¼Œç®—æ˜¯è·¨è¡Œä¸šï¼Œéœ€è¦å­¦çš„ä¸œè¥¿æ¯”è¾ƒå¤šã€‚æŠ€æœ¯å’Œhré¢è¯•è¿˜è¡Œã€‚<br>ã€€ã€€å‘¨å…­é¢è¯•ï¼ŒæŠ€æœ¯é¢æ„Ÿè§‰ä¸€èˆ¬ï¼Œé¢è¯•å®˜æ‰“æ–­è‡ªæˆ‘ä»‹ç»ï¼Œçº ç»“æ— å…³ç´§è¦çš„ä¸œè¥¿ï¼Œç„¶åè¿˜åœ¨ç©æ‰‹æœºã€‚hré¢è¯•èŠäº†å¾ˆå¤šã€‚ä¸€å‘¨ä¸‹æ¥ï¼Œå·¥ä½œæ²¡æœ‰ç€è½ï¼Œè½¦ä¹Ÿæ²¡è¿‡ï¼Œä½†æ˜¯å¿ƒç†æœ‰äº›é‡Šæ”¾ã€‚ä¸€å¹´çš„éš¾å¤„ä¸€å¤©å½“ï¼Œä¸å¿…ä¸ºæ˜å¤©æ‹…å¿§ï¼Œä½ æ— æ³•å»å†³å®šæ˜å¤©ä¼šå‘ç”Ÿä»€ä¹ˆï¼Œä¹Ÿæ— å¦¨é¢„æ–™ï¼Œä½•å¿…ç»™è‡ªå·±é‚£ä¹ˆå¤§çš„å‹åŠ›ã€‚</p>        <div id="aplayer-pDJISkDH" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;"></div>  <script>  var options = {"narrow":false,"autoplay":false,"showlrc":3,"mode":"random","music":[{"title":"å‡¡äº‹éƒ½æœ‰ç¥çš„ç¾æ„","author":"å±å¤©éŸ³ä¹äº‹å·¥","url":"/audio/å‡¡äº‹éƒ½æœ‰ç¥çš„ç¾æ„-å±å¤©éŸ³ä¹äº‹å·¥.mp3","pic":"/audio/å±å¤©éŸ³ä¹äº‹å·¥.png","lrc":"/audio/å‡¡äº‹éƒ½æœ‰ç¥çš„ç¾æ„-å±å¤©éŸ³ä¹äº‹å·¥.lrc"}]};  options.element = document.getElementById("aplayer-pDJISkDH");  var ap = new APlayer(options);    window.aplayers || (window.aplayers = []);  window.aplayers.push(ap);  </script>]]></content>
      
      <categories>
          
          <category> å¿ƒè®° </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>å¤±ä¸šè°ƒæ•´</title>
      <link href="/2019/07/07/%E5%BF%83%E8%AE%B0/20190707%E5%BF%83%E8%AE%B0/"/>
      <url>/2019/07/07/%E5%BF%83%E8%AE%B0/20190707%E5%BF%83%E8%AE%B0/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>ã€€ã€€æœ€è¿‘ç¦»èŒï¼Œçªç„¶æœ‰ä¸ªæƒ³æ³•ï¼Œè¿‘ä¸€å¹´çš„å·¥ä½œï¼Œè‡ªå·±ä¸€ç›´æ˜¯æ¯”è¾ƒå®‰é€¸ï¼Œè‡ªä»ä¸Šæ¬¡åšå®¢æ›´æ–°ï¼Œè¿™ä¸€å¹´å†…éƒ½æ²¡æ€ä¹ˆæ›´æ–°ï¼Œä¸€ç›´è®©è‡ªå·±çš„å¿ƒé™ä¸ä¸‹æ¥ï¼Œæ€»æ˜¯è§‰å¾—è‡ªå·±è„‘å­å¾ˆç´¯ï¼Œä¸æƒ³å»æ€è€ƒä»»ä½•äº‹ï¼Œå¥½ä¸å®¹æ˜“æœ€è¿‘ç©ºé—²ä¸‹æ¥ï¼Œæƒ³ç€è‡ªå·±å¯ä»¥å¥½å¥½å†™ç‚¹ä¸œè¥¿ï¼Œè®©è‡ªå·±çš„ç”Ÿæ´»ä¸è¿™ä¹ˆæ··ä¹±ã€‚æœ‰ä¸ªæ–°çš„æ‰“ç®—ï¼Œå¼€å§‹æ¯å‘¨çš„ä¸€ä¸ªå¿ƒè®°ï¼Œè®°å½•ä¸€å‘¨ä¸­è‡ªå·±çš„æƒ³æ³•ï¼Œé‡è§çš„äººï¼Œé‡è§çš„äº‹ï¼Œç”Ÿæ´»ç­‰ç­‰ã€‚æ­£å¥½ä»Šå¤©æœ‰ç©ºï¼Œç¡äº†åŠå¤©ï¼Œæ„Ÿè§‰è‡ªå·±æœ‰äº›æ— èŠï¼Œé—²ç€ä¹Ÿæ˜¯é—²ç€ï¼Œå°±å†™æ¥ç©ç©ã€‚<br>ã€€ã€€ä¸Šå‘¨äº”è¢«å‘ŠçŸ¥ç¦»èŒï¼Œå‘¨äº”åŒ†å¿™æ”¶æ‹¾äº†ä¸œè¥¿ï¼Œæ•´ç†äº†ä¸€ä¸‹ç”µè„‘ï¼Œè‡ªå·±çš„ä¸œè¥¿å¸¦èµ°èµ°äººï¼Œå› ä¸€äº›æ‰‹ç»­æ²¡æœ‰åŠå®Œï¼Œæ‰€ä»¥è¿™å‘¨åˆå»äº†ä¸€å¤©åŠï¼Œå‘¨äºŒå¤„ç†å®Œç¦»èŒæ‰‹ç»­ï¼Œä¸­åˆå›æ¥åœ¨å®¶ç¡äº†ä¸€è§‰ï¼Œå‚æ™šèµ·æ¥åƒäº†ç‚¹é¥­ï¼Œåˆ·åˆ·è§†é¢‘ï¼Œåˆ·åˆ·å·¥ä½œï¼Œæ”¶åˆ°ä¸ªé¢è¯•é€šçŸ¥ï¼Œæƒ³ç€ç¬¬äºŒå¤©çœ‹çœ‹ä¹¦ï¼Œå› ä¸ºè¿™ä¸€å¹´æ¥ï¼Œä¸€ç›´åšçš„æ˜¯mcuè¿™å—çš„ä¸œè¥¿ï¼Œlinuxç›¸å…³å¿˜çš„å·®ä¸å¤šäº†ï¼Œè€Œä¸”é¢è¯•è¿™å®¶ï¼Œå¤§éƒ¨åˆ†å’Œlinuxç›¸å…³ï¼Œå‘¨ä¸‰èµ·æ¥ï¼Œæ”¶æ‹¾äº†å¨æˆ¿ï¼Œå› ä¸ºé•¿æ—¶é—´å¶å°”åœ¨è€å©†å®¶ï¼Œé™ªè€å©†ï¼Œæ—¶ä¸æ—¶å›æ¥ä¸€æ¬¡å°±æ˜¯åƒé¥­ï¼Œç¡è§‰ã€‚å› æ­¤æˆ¿é—´ä¸€ç›´å¾ˆä¹±ï¼Œæ²¡æ—¶é—´æ”¶æ‹¾ï¼Œæ­£å¥½è¿™æ®µæ—¶é—´æ”¶æ‹¾æ”¶æ‹¾ã€‚ä¸‹åˆçœ‹äº†ä¼šæŠ€æœ¯ä¹¦ï¼Œæ¯”è¾ƒçƒ¦èºï¼Œå°±æƒ³ç€å†™ç‚¹ä¸œè¥¿ã€‚<br>ã€€ã€€è¿™å‘¨é¢è¯•ä¸‰å®¶å…¬å¸ï¼Œç¬¬ä¸€å®¶é¢è¯•æ„Ÿè§‰ä¸‹æ¥ï¼Œlinuxçš„ä¸€äº›ä¸“ä¸šçŸ¥è¯†æœ‰äº›å¿˜è®°äº†ï¼Œsocketå’Œdhcpäº¤äº’è¿‡ç¨‹ï¼Œtcp/ipç­‰ã€‚æŠ€æœ¯é¢è¯•æ„Ÿè§‰ä¸€èˆ¬ï¼Œhré¢è¯•è§‰å¾—æœ¬äººä¸å¤ªæ„¿æ„åŠ ç­ã€‚ç¬¬äºŒå®¶ç¬”è¯•é¢˜ç®€å•ï¼Œé¢è¯•å®˜æŠ€æœ¯ä¸€èˆ¬ï¼Œhræ²¡æ€ä¹ˆèŠã€‚ç¬¬ä¸‰å®¶ï¼Œç”±äºæ˜¯å¤–åŒ…å…¬å¸ï¼Œä¸»è¦æ˜¯æŠ€æœ¯é¢ï¼Œå°±å¤§é¢˜ä»‹ç»äº†ä¸€ä¸‹ä¸ªäººçš„å·¥ä½œç»å†ï¼Œæ€»ä½“æ„Ÿè§‰è¿˜è¡Œã€‚hrç”±äºå¿™ï¼ŒæœªèŠï¼Œè¯´æ˜¯ç”µè¯è”ç³»è°ˆè–ªèµ„ã€‚ä¸‹å‘¨ä¸€æœ‰å®¶é¢è¯•ï¼Œæœ‰äº›æƒ³å»ã€‚æ‰€ä»¥æœ€è¿‘ä¸€ç›´æ²¡æ€ä¹ˆåˆ·ç®€å†ã€‚<br>ã€€ã€€å‘¨æœ«å­¦è½¦ï¼Œæ¨¡æ‹Ÿäº†ä¸€ä¸‹åœºåœ°ï¼Œæ„Ÿè§‰è¿˜è¡Œï¼Œæ­£å¥½æœ€è¿‘æ¯”è¾ƒç©ºé—²ï¼Œæƒ³ç€ä¸‹å‘¨å››è€ƒç§‘ç›®äºŒï¼Œå¸Œæœ›èƒ½ä¸€æ¬¡è¿‡ã€‚å‘¨æœ«æ„Ÿè§‰è¿˜æ˜¯è¿‡çš„æ¯”è¾ƒå¿™ï¼Œå»è€å©†å®¶é™ªé™ªå¥¹ï¼Œæ„Ÿè§‰æŒºæ”¾æ¾çš„ï¼Œå°±æ˜¯å›æ¥æ¯”è¾ƒç´¯ã€‚æ—©ä¸Šåœ¨è€å©†å®¶çœ‹äº†æœ¬ä¹¦ã€Šç”Ÿæ´»éœ€è¦ä»ªå¼æ„Ÿã€‹åŸæœ¬ä»¥ä¸ºè¿™æœ¬ä¹¦æ˜¯è®²çš„å¦‚ä½•å»äº«å—ç”Ÿæ´»ï¼Œè®©å¹³å‡¡æ™®é€šçš„ç”Ÿæ´»è¿‡çš„ä¸å¹³å‡¡ã€‚ç„¶åå´ä¸æ˜¯ï¼Œè€Œæ˜¯ä¸€ç§çœŸæ­£çš„å»å¯¹å¾…ç”Ÿæ´»ã€‚åšä¸€ä»¶äº‹æƒ…è®¤çœŸå»åšï¼Œä¸è¦è®©è‡ªå·±æ‡’æƒ°ä¸‹æ¥ã€‚ä¸è¦æ€»æ˜¯è¯´è‡ªå·±å¾ˆå¿™ï¼Œè„‘å­å¾ˆä¹±ï¼Œå¿ƒé‡Œå‹åŠ›å¾ˆå¤§ã€‚å»çœ‹ä¸ªç”µå½±ï¼Œåƒé¡¿å¥½åƒçš„ï¼Œæ”¾æ¾ä¸€ä¸‹ã€‚å…¶å®è‡ªå·±åº”è¯¥å­¦ä¼šçº¦æŸè‡ªå·±ã€‚éœ€è¦åŠ¨èµ·æ¥ï¼Œå»çœ‹ä¹¦ï¼Œåšäº‹æƒ…ï¼Œæ•´ç†å®¶åŠ¡ã€‚è€Œä¸æ˜¯è‡ªä»¥ä¸ºçš„æ”¾æ¾ï¼Œå…¶å®é‚£ç§æ›´ç´¯ï¼Œå¿ƒè„‘æ›´åŠ æ··ä¹±ã€‚</p><div align="center"><p><img src="/img/xj/2019070701.png" alt="ç”Ÿæ´»éœ€è¦ä»ªå¼æ„Ÿ"></p></div><br>ã€€ã€€ä¸“å¿ƒåšä¸€ä»¶äº‹ï¼Œæ— è®ºå¹²ä»€ä¹ˆï¼Œéƒ½åº”è¯¥å…¨èº«å¿ƒçš„å»æŠ•å…¥å…¶ä¸­ã€‚<br>ã€€ã€€ä¸€äº›çš„å¼€å§‹ï¼Œä»ç‚¹æ»´åšèµ·ã€‚å‡¡äº‹éƒ½æ˜¯å¾ˆç®€å•ï¼Œåªæ˜¯ä½ æ„¿ä¸æ„¿æ„ï¼Œè®©å…¶å½¢æˆä¸€ç§ä¹ æƒ¯ã€‚åšæ­£ç¡®æœ‰æ„ï¼ˆæœ‰ç›Šï¼‰çš„äº‹ï¼Œä½ å°±ä¸ä¼šæ„Ÿè§‰è‡ªå·±å¾ˆç´¯ã€‚ä¸ä¼šæ‹–å»¶ã€‚<p></p>        <div id="aplayer-fKfVDNwR" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;"></div>  <script>  var options = {"narrow":false,"autoplay":false,"showlrc":3,"mode":"random","music":[{"title":"é™ä¸‹æ¥","author":"å¤§ä¹”å°ä¹”","url":"/audio/é™ä¸‹æ¥-å¤§ä¹”å°ä¹”.mp3","pic":"/audio/å¤§ä¹”å°ä¹”.png","lrc":"/audio/é™ä¸‹æ¥-å¤§ä¹”å°ä¹”.txt"}]};  options.element = document.getElementById("aplayer-fKfVDNwR");  var ap = new APlayer(options);    window.aplayers || (window.aplayers = []);  window.aplayers.push(ap);  </script>]]></content>
      
      <categories>
          
          <category> å¿ƒè®° </category>
          
      </categories>
      
      
    </entry>
    
    <entry>
      <title>Linuxç³»ç»Ÿå¼€å‘ç¯å¢ƒæ­å»º</title>
      <link href="/2019/06/18/%E7%AC%94%E8%AE%B0/0aLinux%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
      <url>/2019/06/18/%E7%AC%94%E8%AE%B0/0aLinux%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>&emsp;&emsp;ç»å¸¸ä½¿ç”¨linuxç³»ç»Ÿ(Ubuntu),é»˜è®¤éƒ½ä¼šå®‰è£…ä¸€äº›è½¯ä»¶ï¼Œæ–¹ä¾¿å¼€å‘ã€‚è®°å½•ä¸€ä¸‹å¸¸ç”¨çš„ä¸€äº›è½¯ä»¶é…ç½®å’Œå¼€å‘ç¯å¢ƒæ­å»ºã€‚åŒ…æ‹¬<code>samba</code>,<code>ssh</code>,<code>tmux</code>ç­‰</p><h3 id="ä¸€ã€PS1"><a href="#ä¸€ã€PS1" class="headerlink" title="ä¸€ã€PS1"></a>ä¸€ã€PS1</h3><p>ä¿®æ”¹<code>PS1</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi ~/.bashrc</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä»¥ä¸‹å†…å®¹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS1=<span class="string">"â•”â•‘<span class="variable">$&#123;debian_chroot:+($debian_chroot)&#125;</span>\[\033[1;35m\]\w\[\033[00m\]\nâ•šâ•&gt;&gt;"</span></span><br></pre></td></tr></table></figure><h3 id="äºŒ-vim-bundle"><a href="#äºŒ-vim-bundle" class="headerlink" title="äºŒ.vim,bundle"></a>äºŒ.vim,bundle</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install vim</span><br><span class="line">sudo apt-get install git</span><br><span class="line">sudo apt-get install ctags</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/gmarik/vundle.git ~/.vim/bundle/Vundle.vim</span><br></pre></td></tr></table></figure><p>æ–°å»ºæ–‡ä»¶<code>.vimrc</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.vimrc</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä»¥ä¸‹å†…å®¹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> nu</span><br><span class="line"><span class="built_in">set</span> ts=4</span><br><span class="line"><span class="built_in">set</span> noexpandtab</span><br><span class="line">%retab!</span><br><span class="line"><span class="built_in">set</span> list</span><br><span class="line"><span class="built_in">set</span> listchars=tab:&gt;-,trail:-</span><br><span class="line"><span class="built_in">set</span> listchars=tab:&gt;-,trail:-</span><br><span class="line"><span class="built_in">set</span> tags=tags;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">" å®šä¹‰å¿«æ·é”®çš„å‰ç¼€ï¼Œå³&lt;Leader&gt;</span></span><br><span class="line"><span class="string">let mapleader="</span>;<span class="string">"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span> å¼€å¯æ–‡ä»¶ç±»å‹ä¾¦æµ‹</span><br><span class="line">filetype on</span><br><span class="line"><span class="string">" æ ¹æ®ä¾¦æµ‹åˆ°ä¸åŒç±»å‹åŠ è½½å¯¹åº”æ’ä»¶</span></span><br><span class="line"><span class="string">filetype plugin on</span></span><br><span class="line"><span class="string">"</span> å®šä¹‰å¿«æ·é”®åˆ°è¡Œé¦–å’Œè¡Œå°¾</span><br><span class="line">nmap LB 0</span><br><span class="line">nmap LE $</span><br><span class="line"><span class="string">" è®¾ç½®å¿«æ·å°†é€‰ä¸­æ–‡æœ¬å—å¤åˆ¶åˆ°ç³»ç»Ÿå‰ªè´´æ¿</span></span><br><span class="line"><span class="string">vnoremap &lt;Leader&gt;y "</span>+y</span><br><span class="line"><span class="string">" è®¾ç½®å¿«æ·é”®å°†ç³»ç»Ÿå‰ªè´´æ¿å†…å®¹ç²˜è´´è‡³vim</span></span><br><span class="line"><span class="string">nmap &lt;Leader&gt;p "</span>+p</span><br><span class="line"><span class="string">" å®šä¹‰å¿«æ·é”®å…³é—­å½“å‰åˆ†å‰²çª—å£</span></span><br><span class="line"><span class="string">nmap &lt;Leader&gt;q :q&lt;CR&gt;</span></span><br><span class="line"><span class="string">"</span> å®šä¹‰å¿«æ·é”®ä¿å­˜å½“å‰çª—å£å†…å®¹</span><br><span class="line">nmap &lt;Leader&gt;w :w&lt;CR&gt;</span><br><span class="line"><span class="string">" å®šä¹‰å¿«æ·é”®ä¿å­˜æ‰€æœ‰çª—å£å†…å®¹å¹¶é€€å‡ºvim</span></span><br><span class="line"><span class="string">nmap &lt;Leader&gt;WQ :wa&lt;CR&gt;:q&lt;CR&gt;</span></span><br><span class="line"><span class="string">"</span> ä¸åšä»»ä½•ä¿å­˜ï¼Œç›´æ¥é€€å‡º</span><br><span class="line">nmap &lt;Leader&gt;Q :qa!&lt;CR&gt;</span><br><span class="line"><span class="string">" ä¾æ¬¡éå†å­çª—å£</span></span><br><span class="line"><span class="string">nnoremap nw &lt;C-W&gt;&lt;C-W&gt;</span></span><br><span class="line"><span class="string">"</span> è·³è½¬è‡³å³æ–¹çª—å£</span><br><span class="line">nnoremap &lt;Leader&gt;lw &lt;C-W&gt;l</span><br><span class="line"><span class="string">" è·³è½¬è‡³å·¦æ–¹çª—å£</span></span><br><span class="line"><span class="string">nnoremap &lt;Leader&gt;hw &lt;C-W&gt;h</span></span><br><span class="line"><span class="string">"</span> è·³è½¬è‡³ä¸Šæ–¹çª—å£</span><br><span class="line">nnoremap &lt;Leader&gt;kw &lt;C-W&gt;k</span><br><span class="line"><span class="string">" è·³è½¬è‡³ä¸‹æ–¹çª—å£</span></span><br><span class="line"><span class="string">nnoremap &lt;Leader&gt;jw &lt;C-W&gt;j</span></span><br><span class="line"><span class="string">"</span> å®šä¹‰å¿«æ·é”®åœ¨ç»“å¯¹ç¬¦ä¹‹é—´è·³è½¬</span><br><span class="line">nmap &lt;Leader&gt;M %</span><br><span class="line"></span><br><span class="line"><span class="string">" å¼€å¯å®æ—¶æœç´¢åŠŸèƒ½</span></span><br><span class="line"><span class="string">set incsearch</span></span><br><span class="line"><span class="string">"</span> æœç´¢æ—¶å¤§å°å†™ä¸æ•æ„Ÿ</span><br><span class="line"><span class="built_in">set</span> ignorecase</span><br><span class="line"><span class="string">" å…³é—­å…¼å®¹æ¨¡å¼</span></span><br><span class="line"><span class="string">set nocompatible</span></span><br><span class="line"><span class="string">"</span> vim è‡ªèº«å‘½ä»¤è¡Œæ¨¡å¼æ™ºèƒ½è¡¥å…¨</span><br><span class="line"><span class="built_in">set</span> wildmenu</span><br><span class="line"></span><br><span class="line"><span class="string">" å°†å¤–éƒ¨å‘½ä»¤ wmctrl æ§åˆ¶çª—å£æœ€å¤§åŒ–çš„å‘½ä»¤è¡Œå‚æ•°å°è£…æˆä¸€ä¸ª vim çš„å‡½æ•°</span></span><br><span class="line"><span class="string">fun! ToggleFullscreen()</span></span><br><span class="line"><span class="string">call system("</span>wmctrl -ir <span class="string">" . v:windowid . "</span> -b toggle,fullscreen<span class="string">")</span></span><br><span class="line"><span class="string">endf</span></span><br><span class="line"><span class="string">"</span> å…¨å±å¼€/å…³å¿«æ·é”®</span><br><span class="line">map &lt;silent&gt; &lt;F11&gt; :call ToggleFullscreen()&lt;CR&gt;</span><br><span class="line"><span class="string">" å¯åŠ¨ vim æ—¶è‡ªåŠ¨å…¨å±</span></span><br><span class="line"><span class="string">autocmd VimEnter * call ToggleFullscreen()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span>æ€»æ˜¯æ˜¾ç¤ºçŠ¶æ€æ </span><br><span class="line"><span class="built_in">set</span> laststatus=2</span><br><span class="line"><span class="string">" æ˜¾ç¤ºå…‰æ ‡å½“å‰ä½ç½®</span></span><br><span class="line"><span class="string">set ruler</span></span><br><span class="line"><span class="string">"</span> é«˜äº®å½“å‰è¡Œ/åˆ—</span><br><span class="line"><span class="built_in">set</span> cursorline</span><br><span class="line"><span class="string">"set cursorcolumn</span></span><br><span class="line"><span class="string">"</span> é«˜äº®æ˜¾ç¤ºæœç´¢ç»“æœ</span><br><span class="line"><span class="built_in">set</span> hlsearch</span><br><span class="line"></span><br><span class="line"><span class="string">" ç¦æ­¢æŠ˜è¡Œ</span></span><br><span class="line"><span class="string">set nowrap</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span> å¼€å¯è¯­æ³•é«˜äº®åŠŸèƒ½</span><br><span class="line">syntax <span class="built_in">enable</span></span><br><span class="line"><span class="string">" å…è®¸ç”¨æŒ‡å®šè¯­æ³•é«˜äº®é…è‰²æ–¹æ¡ˆæ›¿æ¢é»˜è®¤æ–¹æ¡ˆ</span></span><br><span class="line"><span class="string">syntax on</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span> è‡ªé€‚åº”ä¸åŒè¯­è¨€çš„åªèƒ½ç¼©è¿›</span><br><span class="line">filetype indent on</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">" vundle ç¯å¢ƒè®¾ç½®</span></span><br><span class="line"><span class="string">filetype off</span></span><br><span class="line"><span class="string">set rtp+=~/.vim/bundle/Vundle.vim</span></span><br><span class="line"><span class="string">"</span> vundleç®¡ç†çš„æ’ä»¶åˆ—è¡¨å¿…é¡»ä½äºvundle<span class="comment">#begin()å’Œvundle#end()ä¹‹é—´</span></span><br><span class="line">call vundle<span class="comment">#begin()</span></span><br><span class="line"></span><br><span class="line">Plugin <span class="string">'taglist.vim'</span></span><br><span class="line">Bundle <span class="string">'majutsushi/tagbar'</span></span><br><span class="line">Plugin <span class="string">'OmniCppComplete'</span></span><br><span class="line">Plugin <span class="string">'AutoComplPop'</span></span><br><span class="line">Plugin <span class="string">'a.vim'</span></span><br><span class="line">Bundle <span class="string">'gabrielelana/vim-Markdown'</span></span><br><span class="line">Bundle <span class="string">'iamcco/Markdown-preview.vim'</span></span><br><span class="line"><span class="string">" Markdown</span></span><br><span class="line"><span class="string">Bundle 'jszakmeister/Markdown2ctags'</span></span><br><span class="line"><span class="string">"</span> Add support <span class="keyword">for</span> Markdown files <span class="keyword">in</span> tagbar.</span><br><span class="line"><span class="built_in">let</span> g:tagbar_type_Markdown = &#123;</span><br><span class="line">    \ <span class="string">'ctagstype'</span>: <span class="string">'Markdown'</span>,</span><br><span class="line">    \ <span class="string">'ctagsbin'</span> : <span class="string">'/home/***/.vim/bundle/Markdown2ctags/Markdown2ctags.py'</span>,</span><br><span class="line">    \ <span class="string">'ctagsargs'</span> : <span class="string">'-f - --sort=yes'</span>,</span><br><span class="line">    \ <span class="string">'kinds'</span> : [</span><br><span class="line">    \ <span class="string">'s:sections'</span>,</span><br><span class="line">    \ <span class="string">'i:images'</span></span><br><span class="line">    \ ],</span><br><span class="line">    \ <span class="string">'sro'</span> : <span class="string">'|'</span>,</span><br><span class="line">    \ <span class="string">'kind2scope'</span> : &#123;</span><br><span class="line">    \ <span class="string">'s'</span> : <span class="string">'section'</span>,</span><br><span class="line">    \ &#125;,</span><br><span class="line">    \ <span class="string">'sort'</span>: 0,</span><br><span class="line">\ &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">let</span> g:Markdown_enable_spell_cheking=0</span><br><span class="line"><span class="built_in">let</span> g:Markdown_enable_mappings=0</span><br><span class="line"></span><br><span class="line"><span class="string">" æ’ä»¶åˆ—è¡¨ç»“æŸ</span></span><br><span class="line"><span class="string">call vundle#end()</span></span><br><span class="line"><span class="string">filetype plugin indent on</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">let Tlist_Show_One_File=1</span></span><br><span class="line"><span class="string">let Tlist_Exit_OnlyWindow=1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span> è®¾ç½®tagbarä½¿ç”¨çš„ctagsçš„æ’ä»¶ï¼Œå¿…é¡»è¦è®¾ç½®å¯¹</span><br><span class="line"><span class="built_in">let</span> g:tagbar_ctags_bin=<span class="string">'/usr/bin/ctags'</span></span><br><span class="line"><span class="string">" è®¾ç½®tagbarçš„çª—å£å®½åº¦</span></span><br><span class="line"><span class="string">let g:tagbar_width=30</span></span><br><span class="line"><span class="string">"</span> è®¾ç½®tagbarçš„çª—å£æ˜¾ç¤ºçš„ä½ç½®ï¼Œä¸ºå³è¾¹</span><br><span class="line"><span class="built_in">let</span> g:tagbar_left=1</span><br><span class="line"><span class="string">" æ‰“å¼€æ–‡ä»¶è‡ªåŠ¨ æ‰“å¼€tagbar</span></span><br><span class="line"><span class="string">autocmd BufReadPost *.cpp,*.c,*.h,*.hpp,*.cc,*.cxx call tagbar#autoopen()</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">set nocompatible</span></span><br><span class="line"><span class="string">set backspace=indent,eol,start</span></span><br><span class="line"><span class="string">set completeopt=longest,menu</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"</span> å¤´æ–‡ä»¶/æºæ–‡ä»¶åˆ‡æ¢ </span><br><span class="line">nnoremap &lt;silent&gt; &lt;F12&gt; :A&lt;CR&gt;</span><br><span class="line"><span class="string">" åˆ‡æ¢è‡³å…‰æ ‡æ‰€åœ¨æ–‡ä»¶</span></span><br><span class="line"><span class="string">nnoremap &lt;silent&gt; &lt;F11&gt; :IHV&lt;CR&gt; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">autocmd BufWritePost <span class="variable">$MYVIMRC</span> source <span class="variable">$MYVIMRC</span></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">set nopaste</span></span><br><span class="line"><span class="string">set noautoindent</span></span><br><span class="line"><span class="string">set nosmartindent</span></span><br></pre></td></tr></table></figure><p>éšåä½¿ç”¨å®‰è£…æ’ä»¶</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim</span><br><span class="line">:BundleInstall</span><br></pre></td></tr></table></figure><h3 id="ä¸‰ã€tmux"><a href="#ä¸‰ã€tmux" class="headerlink" title="ä¸‰ã€tmux"></a>ä¸‰ã€tmux</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install tmux</span><br><span class="line">vim ~/.tmux.conf</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä»¥ä¸‹å†…å®¹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">######################</span></span><br><span class="line"><span class="comment"># general</span></span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"><span class="built_in">set</span> -g xterm-keys on</span><br><span class="line"><span class="built_in">set</span> -g display-panes-time 3000</span><br><span class="line"><span class="built_in">set</span> -g base-index 1</span><br><span class="line"><span class="built_in">set</span> -g pane-base-index 1</span><br><span class="line"><span class="built_in">set</span> -g mouse-resize-pane on</span><br><span class="line"><span class="built_in">set</span> -g mouse-select-pane on</span><br><span class="line"><span class="built_in">set</span> -g mouse-select-window on</span><br><span class="line"><span class="built_in">set</span> -g pane-active-border-fg white</span><br><span class="line"><span class="built_in">set</span> -g pane-active-border-bg white</span><br><span class="line"><span class="built_in">set</span> -g pane-border-fg blue</span><br><span class="line"><span class="built_in">set</span> -g pane-border-bg black</span><br><span class="line">setw -g mode-mouse on</span><br><span class="line"><span class="built_in">bind</span> r <span class="built_in">source</span>-file ~/.tmux.conf \; display-message <span class="string">"Config reloaded..."</span></span><br><span class="line"><span class="built_in">set</span> -g renumber-windows on</span><br><span class="line"><span class="built_in">set</span> -g <span class="built_in">history</span>-limit 20000</span><br><span class="line"></span><br><span class="line"><span class="comment"># it is terrible for using vim</span></span><br><span class="line"><span class="built_in">set</span> -g escape-time 0</span><br><span class="line"></span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"><span class="comment"># status bar</span></span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"><span class="built_in">set</span> -g status-position bottom</span><br><span class="line"><span class="built_in">set</span> -g status on</span><br><span class="line"><span class="built_in">set</span> -g status-bg colour103</span><br><span class="line"><span class="built_in">set</span> -g status-fg colour232</span><br><span class="line"><span class="built_in">set</span> -g status-key vi</span><br><span class="line"><span class="built_in">set</span> -g status-interval 1</span><br><span class="line"><span class="built_in">set</span> -g status-utf8 on</span><br><span class="line"><span class="built_in">set</span> -g status-justify <span class="string">"centre"</span></span><br><span class="line"><span class="built_in">set</span> -g status-left-length 60</span><br><span class="line"><span class="built_in">set</span> -g status-right-length 90</span><br><span class="line"><span class="built_in">set</span> -g status-left <span class="string">"#(~/.tmux-pl-src/powerline.sh left)"</span><span class="string">'#&#123;?client_prefix,  #[reverse bold] PREFIX ,          &#125;'</span></span><br><span class="line"><span class="built_in">set</span> -g status-right <span class="string">"#(~/.tmux-pl-src/powerline.sh right)"</span></span><br><span class="line">setw -g window-status-current-bg colour15</span><br><span class="line">setw -g window-status-current-fg colour124</span><br><span class="line">setw -g window-status-current-attr italics,bold</span><br><span class="line">setw -g window-status-current-format <span class="string">' #I '</span></span><br><span class="line">setw -g window-status-format <span class="string">' #I '</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"><span class="comment"># vim</span></span><br><span class="line"><span class="comment">######################</span></span><br><span class="line">setw -g mode-keys vi</span><br><span class="line"><span class="built_in">bind</span> -t vi-copy v begin-selection</span><br><span class="line"><span class="built_in">bind</span> -t vi-copy y copy-selection</span><br><span class="line"><span class="built_in">bind</span> -t vi-copy = end-of-line</span><br><span class="line"><span class="built_in">bind</span> -t vi-copy - start-of-line</span><br><span class="line"></span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"><span class="comment"># general key map</span></span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"><span class="built_in">set</span> -g repeat-time 1500</span><br><span class="line"><span class="built_in">set</span> -g prefix M<span class="_">-e</span></span><br><span class="line">unbind-key C-b</span><br><span class="line"><span class="built_in">bind</span> M<span class="_">-e</span> send-prefix</span><br><span class="line"><span class="built_in">bind</span> -n M-2 display-panes</span><br><span class="line"><span class="built_in">bind</span> -n M-3 <span class="built_in">command</span>-prompt <span class="string">"select-window -t :'%%'"</span></span><br><span class="line"><span class="built_in">bind</span> -n M-Right next-window</span><br><span class="line"><span class="built_in">bind</span> -n M-Left previous-window</span><br><span class="line"><span class="built_in">bind</span> -n M-\ last-window</span><br><span class="line"><span class="built_in">bind</span> -n M-= new-window -c <span class="string">"#&#123;pane_current_path&#125;"</span></span><br><span class="line"><span class="built_in">bind</span> -n M-- <span class="built_in">kill</span>-window</span><br><span class="line"><span class="built_in">bind</span> -n M-x <span class="built_in">kill</span>-pane</span><br><span class="line"><span class="built_in">bind</span> -n M-c copy-mode</span><br><span class="line"><span class="built_in">bind</span> -n M-] paste-buffer</span><br><span class="line"><span class="built_in">bind</span> c new-windows -c <span class="string">"#&#123;pane_current_path&#125;"</span></span><br><span class="line"><span class="built_in">bind</span> _ split-window -v -c <span class="string">"#&#123;pane_current_path&#125;"</span></span><br><span class="line"><span class="built_in">bind</span> | split-window -h -c <span class="string">"#&#123;pane_current_path&#125;"</span></span><br><span class="line"><span class="built_in">bind</span> <span class="string">'"'</span> select-layout tiled</span><br><span class="line"><span class="built_in">bind</span> -r h select-layout main-horizontal \; swap-pane -D</span><br><span class="line"><span class="built_in">bind</span> -r v select-layout main-vertical \; swap-pane -D</span><br><span class="line"><span class="built_in">bind</span> -n F1 save-buffer -b 0 ~/.sdbuf \; run <span class="string">"cat ~/.sdbuf | sdcv"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">bind</span> k select-pane -U           <span class="comment">#é€‰æ‹©ä¸Šçª—å£</span></span><br><span class="line"><span class="built_in">bind</span> j select-pane -D           <span class="comment">#é€‰æ‹©ä¸‹çª—å£</span></span><br><span class="line"><span class="built_in">bind</span> h select-pane -L           <span class="comment">#é€‰æ‹©å·¦çª—å£</span></span><br><span class="line"><span class="built_in">bind</span> l select-pane -R           <span class="comment">#é€‰æ‹©å³çª—å£</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># rename window</span></span><br><span class="line">setw -g automatic-rename on</span><br><span class="line"><span class="built_in">set</span>-window-option -g window-status-format <span class="string">'#[dim]#I:#[default]#W#[fg=grev,dim]'</span></span><br><span class="line"><span class="built_in">set</span>-window-option -g window-status-current-format <span class="string">'#[fg=red,bold]#I#[fg=red]:#[fg=red]#W#[fg=dim]'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#List of plugins</span></span><br><span class="line"><span class="built_in">set</span> -g @plugin <span class="string">'tmux-plugins/tpm'</span></span><br><span class="line"><span class="built_in">set</span> -g @plugin <span class="string">'tmux-plugins/tmux-sensible'</span></span><br><span class="line"><span class="built_in">set</span> -g @plugin <span class="string">'tmux-plugins/tmux-resurrect'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># tmux-resurrect</span></span><br><span class="line"><span class="built_in">set</span> -g @resurrect-save-bash-history <span class="string">'on'</span></span><br><span class="line"><span class="built_in">set</span> -g @resurrect-capture-pane-contents <span class="string">'on'</span></span><br><span class="line"><span class="built_in">set</span> -g @resurrect-strategy-vim <span class="string">'session'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -g @resurrect-save <span class="string">'S'</span></span><br><span class="line"><span class="built_in">set</span> -g @resurrect-restore <span class="string">'R'</span></span><br><span class="line"><span class="comment">#Initialize TMUX plugin manager (keep this line at the bottom)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">bind</span> K <span class="built_in">kill</span>-server</span><br><span class="line"></span><br><span class="line">run <span class="string">'~/.tmux/plugins/tpm/tpm'</span></span><br></pre></td></tr></table></figure><p><code>tmux</code>å¸¸ç”¨æ“ä½œ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">alt+e  <span class="comment">#å¿«æ·å‰ç¼€ prefix</span></span><br><span class="line">prefix new <span class="comment">#æ–°å»ºä¼šè¯</span></span><br><span class="line">prefix s <span class="comment">#åˆ—å‡ºä¼šè¯ï¼Œåˆ‡æ¢ä¼šè¯</span></span><br><span class="line">prefix $ <span class="comment">#é‡å‘½åä¼šè¯</span></span><br><span class="line">prefix | <span class="comment">#åˆ†å‰²çª—å£</span></span><br><span class="line">prefix c <span class="comment">#æ–°å»ºçª—å£</span></span><br><span class="line">prefix num <span class="comment">#åˆ‡æ¢çª—å£</span></span><br><span class="line">prefix , <span class="comment">#é‡å‘½åçª—å£</span></span><br><span class="line"><span class="built_in">exit</span> <span class="comment">#é€€å‡º</span></span><br></pre></td></tr></table></figure><p>å…¶ä»–å¿«æ·é”®ï¼ŒæŸ¥çœ‹é…ç½®</p><h3 id="å››ã€samba-ssh"><a href="#å››ã€samba-ssh" class="headerlink" title="å››ã€samba,ssh"></a>å››ã€samba,ssh</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install samba samba-common</span><br><span class="line">sudo vim /etc/samba/smb.conf</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä»¥ä¸‹å†…å®¹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[<span class="built_in">test</span>]</span><br><span class="line">  path = /home/<span class="built_in">test</span></span><br><span class="line">  valid users = <span class="built_in">test</span></span><br><span class="line">  browseable = yes</span><br><span class="line">  writable = yes</span><br><span class="line">  public = no</span><br></pre></td></tr></table></figure><p>ä¸ºæ­¤ç”¨æˆ·<code>test</code>è®¾ç½®å¯†ç </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo smbpasswd -a <span class="built_in">test</span></span><br></pre></td></tr></table></figure><p>é‡å¯æœåŠ¡å™¨</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /etc/init.d/samba restart</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> samba </tag>
            
            <tag> ssh </tag>
            
            <tag> tmux </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>GerritæœåŠ¡å™¨çš„æ­å»ºä¸ä½¿ç”¨</title>
      <link href="/2019/05/31/%E7%AC%94%E8%AE%B0/08Gerrit%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/"/>
      <url>/2019/05/31/%E7%AC%94%E8%AE%B0/08Gerrit%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ä¸€ã€å‰æœŸå‡†å¤‡"><a href="#ä¸€ã€å‰æœŸå‡†å¤‡" class="headerlink" title="ä¸€ã€å‰æœŸå‡†å¤‡"></a>ä¸€ã€å‰æœŸå‡†å¤‡</h2><h3 id="1ã€java"><a href="#1ã€java" class="headerlink" title="1ã€java"></a>1ã€java</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:openjdk-r/ppa</span><br><span class="line"></span><br><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line">sudo apt-get install openjdk-8-jdk</span><br></pre></td></tr></table></figure><h3 id="2ã€git"><a href="#2ã€git" class="headerlink" title="2ã€git"></a>2ã€git</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git</span><br></pre></td></tr></table></figure><h3 id="3ã€apache2"><a href="#3ã€apache2" class="headerlink" title="3ã€apache2"></a>3ã€apache2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install apache2</span><br><span class="line"></span><br><span class="line">sudo /etc/init.d/apach2 start  <span class="comment">#æ˜¯å¦å¯æ­£å¸¸å¯åŠ¨</span></span><br></pre></td></tr></table></figure><h3 id="4ã€ä¸‹è½½gerrit"><a href="#4ã€ä¸‹è½½gerrit" class="headerlink" title="4ã€ä¸‹è½½gerrit"></a>4ã€ä¸‹è½½gerrit</h3><p><a href="https://pan.baidu.com/s/1GwVTqH_YVLO38_PYUpusXw" target="_blank" rel="noopener">gerrit.2.15.2ç™¾åº¦ç›˜</a> æå–ç ï¼šotlq<br><a href="https://www.gerritcodereview.com/2.15.html" target="_blank" rel="noopener">å®˜æ–¹ä¸‹è½½åœ°å€</a></p><h2 id="äºŒã€æ­å»ºGerrit"><a href="#äºŒã€æ­å»ºGerrit" class="headerlink" title="äºŒã€æ­å»ºGerrit"></a>äºŒã€æ­å»ºGerrit</h2><h3 id="1ã€æ–°å»ºç”¨æˆ·"><a href="#1ã€æ–°å»ºç”¨æˆ·" class="headerlink" title="1ã€æ–°å»ºç”¨æˆ·"></a>1ã€æ–°å»ºç”¨æˆ·</h3><p>ä½¿ç”¨ç‹¬ç«‹çš„è´¦æˆ·ï¼Œæ¥é…ç½®gerrit</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo adduser gerrit</span><br></pre></td></tr></table></figure><p>å°†<code>gerrit</code>åŠ å…¥åˆ°<code>sudo</code>æƒé™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 777 /etc/sudoers</span><br><span class="line">sudo vim /etc/sudoers</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä¸‹é¢ä¸€å¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gerrit  ALL=(ALL:ALL)ALL</span><br></pre></td></tr></table></figure><p>åˆ‡æ¢ç”¨æˆ·ä¸º<code>gerrit</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su gerrit</span><br></pre></td></tr></table></figure><h3 id="2ã€å®‰è£…gerrit"><a href="#2ã€å®‰è£…gerrit" class="headerlink" title="2ã€å®‰è£…gerrit"></a>2ã€å®‰è£…gerrit</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar gerrit.2.15.2.war init --batch --dev -d ~/gerrittest</span><br></pre></td></tr></table></figure><p>å‡ºç°<code>Starting Gerrit Code Review: OK</code>ï¼Œè¡¨ç¤º<code>Gerrit</code>æœåŠ¡æ­£åœ¨è¿è¡Œã€‚</p><h3 id="3ã€åå‘ä»£ç†"><a href="#3ã€åå‘ä»£ç†" class="headerlink" title="3ã€åå‘ä»£ç†"></a>3ã€åå‘ä»£ç†</h3><h4 id="3-1ã€ä¿®æ”¹gerrité…ç½®"><a href="#3-1ã€ä¿®æ”¹gerrité…ç½®" class="headerlink" title="3.1ã€ä¿®æ”¹gerrité…ç½®"></a>3.1ã€ä¿®æ”¹gerrité…ç½®</h4><p><code>vim gerrittest/etc/gerrit.config</code>:<br>ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹<br><code>192.168.40.130</code>ä¸ºæœ¬æœºipåœ°å€ï¼Œé€šè¿‡<code>ifconfig</code>å¯æŸ¥çœ‹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[gerrit]</span><br><span class="line">    basePath = git</span><br><span class="line">    serverId = c5447167-daf0-49e2-a79f-e154d0841461</span><br><span class="line">    canonicalWebUrl = http://192.168.40.130:8081/  <span class="comment"># ä¿®æ”¹ä¸ºip:8081</span></span><br><span class="line">[database]</span><br><span class="line">    <span class="built_in">type</span> = h2</span><br><span class="line">    database = /home/gerrittest/gerrit/db/ReviewDB</span><br><span class="line">[noteDb <span class="string">"changes"</span>]</span><br><span class="line">    disableReviewDb = <span class="literal">true</span></span><br><span class="line">    primaryStorage = note db</span><br><span class="line">    <span class="built_in">read</span> = <span class="literal">true</span></span><br><span class="line">    sequence = <span class="literal">true</span></span><br><span class="line">    write = <span class="literal">true</span></span><br><span class="line">[index]</span><br><span class="line">    <span class="built_in">type</span> = LUCENE</span><br><span class="line">[auth]</span><br><span class="line">    <span class="built_in">type</span> = HTTP <span class="comment">#DEVELOPMENT_BECOME_ANY_ACCOUNT # ä¿®æ”¹ä¸ºHTTP</span></span><br><span class="line">[receive]</span><br><span class="line">    enableSignedPush = <span class="literal">false</span></span><br><span class="line">[sendemail]</span><br><span class="line">    smtpServer = localhost</span><br><span class="line">[container]</span><br><span class="line">    user = gerrittest</span><br><span class="line">    javaHome = /usr/lib/jvm/java-8-oracle/jre</span><br><span class="line">[sshd]</span><br><span class="line">    listenAddress = *:29418</span><br><span class="line">[httpd]</span><br><span class="line">    listenUrl = proxy-http://192.168.40.130:8081/ <span class="comment"># ä¿®æ”¹proxy-http://ip:8081</span></span><br><span class="line">[cache]</span><br><span class="line">    directory = cache</span><br><span class="line">[plugins]</span><br><span class="line">    allowRemoteAdmin = <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="3-2-Apacge2é…ç½®"><a href="#3-2-Apacge2é…ç½®" class="headerlink" title="3.2 Apacge2é…ç½®"></a>3.2 Apacge2é…ç½®</h4><p>éœ€è¦ä½¿èƒ½å¿…è¦çš„Apache2æ¨¡å—ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a2enmod proxy_http</span><br><span class="line">a2dissite 000-default</span><br><span class="line">a2enmod ssl          ; <span class="comment"># å¯é€‰ï¼ŒHTTPSæˆ–SSLéœ€è¦</span></span><br></pre></td></tr></table></figure><p><code>sudo vim /etc/apache2/apache2.conf</code><br>æœ€åé¢ï¼Œæ·»åŠ ä¸€ä¸‹å†…å®¹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">    ServerName 192.168.40.130</span><br><span class="line">    ProxyRequests Off</span><br><span class="line">    ProxyVia Off</span><br><span class="line">    ProxyPreserveHost On</span><br><span class="line">    &lt;Proxy *&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Location <span class="string">"/"</span>&gt;</span><br><span class="line">        AuthType Basic</span><br><span class="line">        AuthName <span class="string">"Gerrit Code Review"</span></span><br><span class="line">        Require valid-user</span><br><span class="line">    AuthBasicProvider file</span><br><span class="line">        AuthUserFile /etc/apache2/passwords</span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line"></span><br><span class="line">    AllowEncodedSlashes On</span><br><span class="line">    ProxyPass /  http://192.168.40.130:8081/ nocanon</span><br><span class="line">    ProxyPassReverse / http://192.168.40.130:8081/ nocanon</span><br><span class="line"></span><br><span class="line">    ErrorLog /var/<span class="built_in">log</span>/apache2/gerrit.error.log</span><br><span class="line">    CustomLog /var/<span class="built_in">log</span>/apache2/gerrit.access.log combined</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure><p><code>sudo vim /etc/apache2/ports.conf</code><br>æ·»åŠ ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Listen 8080</span><br></pre></td></tr></table></figure><h4 id="3-3-è®¾ç½®Gerritè´¦æˆ·å’Œå¯†ç "><a href="#3-3-è®¾ç½®Gerritè´¦æˆ·å’Œå¯†ç " class="headerlink" title="3.3 è®¾ç½®Gerritè´¦æˆ·å’Œå¯†ç "></a>3.3 è®¾ç½®Gerritè´¦æˆ·å’Œå¯†ç </h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo touch /etc/apache2/passwords</span><br><span class="line">sudo htpasswd -b /etc/apache2/passwords admin 123456 <span class="comment"># administrator</span></span><br><span class="line">sudo htpasswd -b /etc/apache2/passwords gerrit1 123456 <span class="comment"># general usr</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨gerrit &amp; apache2</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ~/gerrittest/bin/gerrit.sh restart</span><br><span class="line">sudo /etc/init.d/apache2 restart</span><br></pre></td></tr></table></figure><h3 id="4ã€ä½¿ç”¨Gerrit"><a href="#4ã€ä½¿ç”¨Gerrit" class="headerlink" title="4ã€ä½¿ç”¨Gerrit"></a>4ã€ä½¿ç”¨Gerrit</h3><p>ä½¿ç”¨æµè§ˆå™¨ç™»å½•<code>http:192.168.40.130:8080</code><br>ç™»å½•<code>admin</code></p><p>ç™»å½•æˆåŠŸåï¼Œè¯¥ç”¨æˆ·ä¸ºç®¡ç†å‘˜</p><h4 id="1ã€SSHç™»å½•"><a href="#1ã€SSHç™»å½•" class="headerlink" title="1ã€SSHç™»å½•"></a>1ã€SSHç™»å½•</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> </span><br><span class="line">ssh-keygen -t rsa   <span class="comment">#ç”Ÿæˆssk key </span></span><br><span class="line">cat ~/.ssh/id_rsa.pub  <span class="comment">#æŸ¥çœ‹ssh key</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDBlBpZtMRBI/O077EM0fqrhUrzCRP7yxLMrSfKXMO2BK5pb5ITnnyiEMdurxo31iD9uaF3y/+Yr/H8K4IRtBdHM4ZQseAqmz9Z/X7Q97PkrI8rwocIbs4BUSYap2j/lUzHGcRdzYGR/8XpXCSIwO4OFjsBJZluOKpuNNJUq8o5ZAS7NTQTi83JwgiKQrByuUYPpVqzgf6RGEI0lmesLxRNIbA5FMxfDuKyPIGPvuz4BRayREcwdkeBrJyKVgQf16lPlvJxzCOgnY01xsdCMXEF5Ri2MLYfysYlhehs+UCabLwmTi+Xpe3ioDOe6YnYx7QQzvi/YuXXew8SYwRGKxod gerrit@ubuntu</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>å…¶ä»–</code>æµè§ˆå™¨ç™»å½•<code>gerrit1</code>è´¦æˆ·</p><div align="left"><p><img src="/img/note_08/01.png" alt></p></div><p></p><p>éªŒè¯ssh keyæ˜¯å¦é…ç½®æˆåŠŸ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh gerrit1@192.168.40.130 -p 29418</span><br></pre></td></tr></table></figure><p>å‡ºç°ä¸‹é¢å†…å®¹è¡¨ç¤ºæˆåŠŸï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> ****    Welcome to Gerrit Code Review    ****</span><br><span class="line"></span><br><span class="line">  Hi gerrit1, you have successfully connected over SSH.</span><br><span class="line"></span><br><span class="line">  Unfortunately, interactive shells are disabled.</span><br><span class="line">  To <span class="built_in">clone</span> a hosted Git repository, use:</span><br><span class="line"></span><br><span class="line">  git <span class="built_in">clone</span> ssh://gerrit1@192.168.40.130:29418/REPOSITORY_NAME.git</span><br><span class="line"></span><br><span class="line">Connection to 192.168.40.130 closed.</span><br></pre></td></tr></table></figure><h4 id="2ã€æ·»åŠ é¡¹ç›®"><a href="#2ã€æ·»åŠ é¡¹ç›®" class="headerlink" title="2ã€æ·»åŠ é¡¹ç›®"></a>2ã€æ·»åŠ é¡¹ç›®</h4><p>ä½¿ç”¨<code>admin</code>è´¦æˆ·ï¼Œåœ¨gerritç®¡ç†é¡µé¢è¿›è¡Œæ·»åŠ è´¦æˆ·</p><div align="left"><p><img src="/img/note_08/02.png" alt></p></div><p></p><h4 id="3ã€ä»£ç ä¿®æ”¹"><a href="#3ã€ä»£ç ä¿®æ”¹" class="headerlink" title="3ã€ä»£ç ä¿®æ”¹"></a>3ã€ä»£ç ä¿®æ”¹</h4><p>æ‹‰å–ä»£ç </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir code</span><br><span class="line"><span class="built_in">cd</span> code</span><br><span class="line">git <span class="built_in">clone</span> ssh://gerrit1@192.168.40.130:29418/demo</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/note_08/03.png" alt></p></div><p></p><p>æ›´æ–°git hooks</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitdir=$(git rev-parse --git-dir); scp -p -P 29418 gerrit1@192.168.40.130:hooks/commit-msg <span class="variable">$&#123;gitdir&#125;</span>/hooks/</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>  <span class="string">"init code"</span>&gt;ReadMe.txt  <span class="comment"># åˆ›å»ºæ–°æ–‡ä»¶</span></span><br><span class="line">git add ReadMe.txt  <span class="comment"># æ·»åŠ æ–°æ–‡ä»¶</span></span><br><span class="line">git commit -m <span class="string">"init code commit"</span></span><br></pre></td></tr></table></figure><p><code>git commit</code>å‡ºé”™ï¼Œæç¤ºéœ€è¦è®¾ç½®<code>user.email</code>,<code>user.name</code>è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå…ˆè®¾ç½®<code>gerrit.config</code>çš„<code>sendemail</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/gerrittest/etc/gerrit.config</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹<code>sendemail</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[sendemail]</span><br><span class="line">        <span class="built_in">enable</span> = <span class="literal">true</span></span><br><span class="line">        smtpServer = smtp.163.com</span><br><span class="line">        smtpServerPort = 465</span><br><span class="line">        smtpEncryption = ssl</span><br><span class="line">        smtpUser = ã€é‚®ç®±è´¦å·ã€‘</span><br><span class="line">        smtpPass = ã€æˆæƒå¯†ç ã€‘  <span class="comment">#æˆæƒå¯†ç </span></span><br><span class="line">        sslVerify = <span class="literal">false</span></span><br><span class="line">        from = ã€é‚®ç®±è´¦å·ã€‘</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/gerrittest/etc/secure.config</span><br></pre></td></tr></table></figure><p>æ·»åŠ <code>sendemail</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[sendemail]</span><br><span class="line">        smtpPass = ã€æˆæƒå¯†ç ã€‘</span><br></pre></td></tr></table></figure><p>ä¹‹åé‡å¯<code>gerrit</code>ï¼Œ<code>apache</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/gerrittest/bin/gerrit.sh restart</span><br><span class="line">/etc/init.d/apache2 restart</span><br></pre></td></tr></table></figure><p>éšåè®¾ç½®<code>gerrit1</code>çš„<code>user.email</code>,<code>user.name</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.email <span class="string">"gerrit205@163.com"</span></span><br><span class="line">git config --global user.name <span class="string">"gerrit1"</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git commit</span><br><span class="line">git push origin HEAD:refs/<span class="keyword">for</span>/master</span><br></pre></td></tr></table></figure><p><code>git push</code>å‡ºç°é”™è¯¯,è¿™é‡Œéœ€è¦<code>gerrit1</code>ç™»å½•gerritç®¡ç†é¡µé¢ï¼Œè®¾ç½®<code>name</code>å’Œ<code>email</code></p><div align="left"><p><img src="/img/note_08/07.png" alt></p></div><p></p><div align="left"><p><img src="/img/note_08/08.png" alt></p></div><br>éšåä¼šæ”¶åˆ°é€šè¿‡<code>gerrit.config</code>ä¸­æ·»åŠ çš„é‚®ç®±å‘é€çš„é‚®ä»¶ï¼Œå¤åˆ¶æ”¶åˆ°çš„é“¾æ¥ï¼Œåœ¨<code>gerrit1</code>æ‰€ç™»å½•çš„æµè§ˆå™¨ï¼Œè¿›è¡ŒéªŒè¯ã€‚éšåå°±å¯çœ‹åˆ°ä¸Šå›¾ä¸­æ˜¾ç¤ºçš„é‚®ç®±ã€‚<p></p><p>éšåé€šè¿‡<code>admin</code>å°†<code>gerrit1</code>æ·»åŠ åˆ°<code>Administrators</code>ç»„:</p><div align="left"><p><img src="/img/note_08/04.png" alt></p></div><p></p><p>ä¹‹åé‡æ–°<code>git push</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin HEAD:refs/<span class="keyword">for</span>/master</span><br></pre></td></tr></table></figure><p>æˆåŠŸå¦‚ä¸‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Counting objects: 3, <span class="keyword">done</span>.</span><br><span class="line">Writing objects: 100% (3/3), 284 bytes | 0 bytes/s, <span class="keyword">done</span>.</span><br><span class="line">Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">remote: Processing changes: new: 1, <span class="keyword">done</span>    </span><br><span class="line">remote: </span><br><span class="line">remote: New Changes:</span><br><span class="line">remote:   http://192.168.40.130:8081/<span class="comment">#/c/demo/+/21 init code commit</span></span><br><span class="line">remote: </span><br><span class="line">To ssh://gerrit1@192.168.40.130:29418/demo</span><br><span class="line"> * [new branch]      HEAD -&gt; refs/<span class="keyword">for</span>/master</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>gerrit1</code>è¿›å…¥gerritç®¡ç†é¡µé¢</p><div align="left"><p><img src="/img/note_08/05.png" alt></p></div><p></p><div align="left"><p><img src="/img/note_08/06.png" alt></p></div><br>æ·»åŠ <code>Reviewers</code><p></p><div align="left"><p><img src="/img/note_08/09.png" alt></p></div><p></p><p><code>gerrit1</code>æ•´ä¸ªä»£ç å°±æäº¤å®Œæˆäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯Reviewersäººå‘˜è¿›è¡Œä»£ç è¯„å®¡å’Œå…¥åº“ã€‚<br>è¿™é‡Œæ˜¯<code>admin</code>ç”¨æˆ·è¿›è¡Œå…¥åº“</p><div align="left"><p><img src="/img/note_08/10.png" alt></p></div><p></p><div align="left"><p><img src="/img/note_08/11.png" alt></p></div><p></p><p>æ•´ä¸ªä»£ç å°±å…¥åº“å®Œæˆã€‚</p>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Gerrit </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>GerritæœåŠ¡å™¨çš„æ­å»ºä¸ä½¿ç”¨</title>
      <link href="/2019/05/31/%E7%AC%94%E8%AE%B0/09Gerrit%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/"/>
      <url>/2019/05/31/%E7%AC%94%E8%AE%B0/09Gerrit%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%90%AD%E5%BB%BA/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ä¸€ã€å‰æœŸå‡†å¤‡"><a href="#ä¸€ã€å‰æœŸå‡†å¤‡" class="headerlink" title="ä¸€ã€å‰æœŸå‡†å¤‡"></a>ä¸€ã€å‰æœŸå‡†å¤‡</h2><h3 id="1ã€java"><a href="#1ã€java" class="headerlink" title="1ã€java"></a>1ã€java</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:openjdk-r/ppa</span><br><span class="line"></span><br><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line">sudo apt-get install openjdk-8-jdk</span><br></pre></td></tr></table></figure><h3 id="2ã€git"><a href="#2ã€git" class="headerlink" title="2ã€git"></a>2ã€git</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git</span><br></pre></td></tr></table></figure><h3 id="3ã€apache2"><a href="#3ã€apache2" class="headerlink" title="3ã€apache2"></a>3ã€apache2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install apache2</span><br><span class="line"></span><br><span class="line">sudo /etc/init.d/apach2 start  <span class="comment">#æ˜¯å¦å¯æ­£å¸¸å¯åŠ¨</span></span><br></pre></td></tr></table></figure><h3 id="4ã€ä¸‹è½½gerrit"><a href="#4ã€ä¸‹è½½gerrit" class="headerlink" title="4ã€ä¸‹è½½gerrit"></a>4ã€ä¸‹è½½gerrit</h3><p><a href="https://pan.baidu.com/s/1GwVTqH_YVLO38_PYUpusXw" target="_blank" rel="noopener">gerrit.2.15.2ç™¾åº¦ç›˜</a> æå–ç ï¼šotlq<br><a href="https://www.gerritcodereview.com/2.15.html" target="_blank" rel="noopener">å®˜æ–¹ä¸‹è½½åœ°å€</a></p><h2 id="äºŒã€æ­å»ºGerrit"><a href="#äºŒã€æ­å»ºGerrit" class="headerlink" title="äºŒã€æ­å»ºGerrit"></a>äºŒã€æ­å»ºGerrit</h2><h3 id="1ã€æ–°å»ºç”¨æˆ·"><a href="#1ã€æ–°å»ºç”¨æˆ·" class="headerlink" title="1ã€æ–°å»ºç”¨æˆ·"></a>1ã€æ–°å»ºç”¨æˆ·</h3><p>ä½¿ç”¨ç‹¬ç«‹çš„è´¦æˆ·ï¼Œæ¥é…ç½®gerrit</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo adduser gerrit</span><br></pre></td></tr></table></figure><p>å°†<code>gerrit</code>åŠ å…¥åˆ°<code>sudo</code>æƒé™</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 777 /etc/sudoers</span><br><span class="line">sudo vim /etc/sudoers</span><br></pre></td></tr></table></figure><p>æ·»åŠ ä¸‹é¢ä¸€å¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gerrit  ALL=(ALL:ALL)ALL</span><br></pre></td></tr></table></figure><p>åˆ‡æ¢ç”¨æˆ·ä¸º<code>gerrit</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su gerrit</span><br></pre></td></tr></table></figure><h3 id="2ã€å®‰è£…gerrit"><a href="#2ã€å®‰è£…gerrit" class="headerlink" title="2ã€å®‰è£…gerrit"></a>2ã€å®‰è£…gerrit</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar gerrit.2.15.2.war init --batch --dev -d ~/gerrittest</span><br></pre></td></tr></table></figure><p>å‡ºç°<code>Starting Gerrit Code Review: OK</code>ï¼Œè¡¨ç¤º<code>Gerrit</code>æœåŠ¡æ­£åœ¨è¿è¡Œã€‚</p><h3 id="3ã€åå‘ä»£ç†"><a href="#3ã€åå‘ä»£ç†" class="headerlink" title="3ã€åå‘ä»£ç†"></a>3ã€åå‘ä»£ç†</h3><h4 id="3-1ã€ä¿®æ”¹gerrité…ç½®"><a href="#3-1ã€ä¿®æ”¹gerrité…ç½®" class="headerlink" title="3.1ã€ä¿®æ”¹gerrité…ç½®"></a>3.1ã€ä¿®æ”¹gerrité…ç½®</h4><p><code>vim gerrittest/etc/gerrit.config</code>:<br>ä¿®æ”¹ä¸ºä»¥ä¸‹å†…å®¹<br><code>192.168.40.130</code>ä¸ºæœ¬æœºipåœ°å€ï¼Œé€šè¿‡<code>ifconfig</code>å¯æŸ¥çœ‹</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[gerrit]</span><br><span class="line">    basePath = git</span><br><span class="line">    serverId = c5447167-daf0-49e2-a79f-e154d0841461</span><br><span class="line">    canonicalWebUrl = http://192.168.40.130:8081/  <span class="comment"># ä¿®æ”¹ä¸ºip:8081</span></span><br><span class="line">[database]</span><br><span class="line">    <span class="built_in">type</span> = h2</span><br><span class="line">    database = /home/gerrittest/gerrit/db/ReviewDB</span><br><span class="line">[noteDb <span class="string">"changes"</span>]</span><br><span class="line">    disableReviewDb = <span class="literal">true</span></span><br><span class="line">    primaryStorage = note db</span><br><span class="line">    <span class="built_in">read</span> = <span class="literal">true</span></span><br><span class="line">    sequence = <span class="literal">true</span></span><br><span class="line">    write = <span class="literal">true</span></span><br><span class="line">[index]</span><br><span class="line">    <span class="built_in">type</span> = LUCENE</span><br><span class="line">[auth]</span><br><span class="line">    <span class="built_in">type</span> = HTTP <span class="comment">#DEVELOPMENT_BECOME_ANY_ACCOUNT # ä¿®æ”¹ä¸ºHTTP</span></span><br><span class="line">[receive]</span><br><span class="line">    enableSignedPush = <span class="literal">false</span></span><br><span class="line">[sendemail]</span><br><span class="line">    smtpServer = localhost</span><br><span class="line">[container]</span><br><span class="line">    user = gerrittest</span><br><span class="line">    javaHome = /usr/lib/jvm/java-8-oracle/jre</span><br><span class="line">[sshd]</span><br><span class="line">    listenAddress = *:29418</span><br><span class="line">[httpd]</span><br><span class="line">    listenUrl = proxy-http://192.168.40.130:8081/ <span class="comment"># ä¿®æ”¹proxy-http://ip:8081</span></span><br><span class="line">[cache]</span><br><span class="line">    directory = cache</span><br><span class="line">[plugins]</span><br><span class="line">    allowRemoteAdmin = <span class="literal">true</span></span><br></pre></td></tr></table></figure><h4 id="3-2-Apacge2é…ç½®"><a href="#3-2-Apacge2é…ç½®" class="headerlink" title="3.2 Apacge2é…ç½®"></a>3.2 Apacge2é…ç½®</h4><p>éœ€è¦ä½¿èƒ½å¿…è¦çš„Apache2æ¨¡å—ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a2enmod proxy_http</span><br><span class="line">a2dissite 000-default</span><br><span class="line">a2enmod ssl          ; <span class="comment"># å¯é€‰ï¼ŒHTTPSæˆ–SSLéœ€è¦</span></span><br></pre></td></tr></table></figure><p><code>sudo vim /etc/apache2/apache2.conf</code><br>æœ€åé¢ï¼Œæ·»åŠ ä¸€ä¸‹å†…å®¹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:8080&gt;</span><br><span class="line">    ServerName 192.168.40.130</span><br><span class="line">    ProxyRequests Off</span><br><span class="line">    ProxyVia Off</span><br><span class="line">    ProxyPreserveHost On</span><br><span class="line">    &lt;Proxy *&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">    &lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Location <span class="string">"/"</span>&gt;</span><br><span class="line">        AuthType Basic</span><br><span class="line">        AuthName <span class="string">"Gerrit Code Review"</span></span><br><span class="line">        Require valid-user</span><br><span class="line">    AuthBasicProvider file</span><br><span class="line">        AuthUserFile /etc/apache2/passwords</span><br><span class="line">    &lt;/Location&gt;</span><br><span class="line"></span><br><span class="line">    AllowEncodedSlashes On</span><br><span class="line">    ProxyPass /  http://192.168.40.130:8081/ nocanon</span><br><span class="line">    ProxyPassReverse / http://192.168.40.130:8081/ nocanon</span><br><span class="line"></span><br><span class="line">    ErrorLog /var/<span class="built_in">log</span>/apache2/gerrit.error.log</span><br><span class="line">    CustomLog /var/<span class="built_in">log</span>/apache2/gerrit.access.log combined</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure><p><code>sudo vim /etc/apache2/ports.conf</code><br>æ·»åŠ ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Listen 8080</span><br></pre></td></tr></table></figure><h4 id="3-3-è®¾ç½®Gerritè´¦æˆ·å’Œå¯†ç "><a href="#3-3-è®¾ç½®Gerritè´¦æˆ·å’Œå¯†ç " class="headerlink" title="3.3 è®¾ç½®Gerritè´¦æˆ·å’Œå¯†ç "></a>3.3 è®¾ç½®Gerritè´¦æˆ·å’Œå¯†ç </h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo touch /etc/apache2/passwords</span><br><span class="line">sudo htpasswd -b /etc/apache2/passwords admin 123456 <span class="comment"># administrator</span></span><br><span class="line">sudo htpasswd -b /etc/apache2/passwords gerrit1 123456 <span class="comment"># general usr</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨gerrit &amp; apache2</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ~/gerrittest/bin/gerrit.sh restart</span><br><span class="line">sudo /etc/init.d/apache2 restart</span><br></pre></td></tr></table></figure><h3 id="4ã€ä½¿ç”¨Gerrit"><a href="#4ã€ä½¿ç”¨Gerrit" class="headerlink" title="4ã€ä½¿ç”¨Gerrit"></a>4ã€ä½¿ç”¨Gerrit</h3><p>ä½¿ç”¨æµè§ˆå™¨ç™»å½•<code>http:192.168.40.130:8080</code><br>ç™»å½•<code>admin</code></p><p>ç™»å½•æˆåŠŸåï¼Œè¯¥ç”¨æˆ·ä¸ºç®¡ç†å‘˜</p><h4 id="1ã€SSHç™»å½•"><a href="#1ã€SSHç™»å½•" class="headerlink" title="1ã€SSHç™»å½•"></a>1ã€SSHç™»å½•</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> </span><br><span class="line">ssh-keygen -t rsa   <span class="comment">#ç”Ÿæˆssk key </span></span><br><span class="line">cat ~/.ssh/id_rsa.pub  <span class="comment">#æŸ¥çœ‹ssh key</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDBlBpZtMRBI/O077EM0fqrhUrzCRP7yxLMrSfKXMO2BK5pb5ITnnyiEMdurxo31iD9uaF3y/+Yr/H8K4IRtBdHM4ZQseAqmz9Z/X7Q97PkrI8rwocIbs4BUSYap2j/lUzHGcRdzYGR/8XpXCSIwO4OFjsBJZluOKpuNNJUq8o5ZAS7NTQTi83JwgiKQrByuUYPpVqzgf6RGEI0lmesLxRNIbA5FMxfDuKyPIGPvuz4BRayREcwdkeBrJyKVgQf16lPlvJxzCOgnY01xsdCMXEF5Ri2MLYfysYlhehs+UCabLwmTi+Xpe3ioDOe6YnYx7QQzvi/YuXXew8SYwRGKxod gerrit@ubuntu</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>å…¶ä»–</code>æµè§ˆå™¨ç™»å½•<code>gerrit1</code>è´¦æˆ·</p><div align="left"><p><img src="/img/note_08/01.png" alt></p></div><p></p><p>éªŒè¯ssh keyæ˜¯å¦é…ç½®æˆåŠŸ</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh gerrit1@192.168.40.130 -p 29418</span><br></pre></td></tr></table></figure><p>å‡ºç°ä¸‹é¢å†…å®¹è¡¨ç¤ºæˆåŠŸï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> ****    Welcome to Gerrit Code Review    ****</span><br><span class="line"></span><br><span class="line">  Hi gerrit1, you have successfully connected over SSH.</span><br><span class="line"></span><br><span class="line">  Unfortunately, interactive shells are disabled.</span><br><span class="line">  To <span class="built_in">clone</span> a hosted Git repository, use:</span><br><span class="line"></span><br><span class="line">  git <span class="built_in">clone</span> ssh://gerrit1@192.168.40.130:29418/REPOSITORY_NAME.git</span><br><span class="line"></span><br><span class="line">Connection to 192.168.40.130 closed.</span><br></pre></td></tr></table></figure><h4 id="2ã€æ·»åŠ é¡¹ç›®"><a href="#2ã€æ·»åŠ é¡¹ç›®" class="headerlink" title="2ã€æ·»åŠ é¡¹ç›®"></a>2ã€æ·»åŠ é¡¹ç›®</h4><p>ä½¿ç”¨<code>admin</code>è´¦æˆ·ï¼Œåœ¨gerritç®¡ç†é¡µé¢è¿›è¡Œæ·»åŠ è´¦æˆ·</p><div align="left"><p><img src="/img/note_08/02.png" alt></p></div><p></p><h4 id="3ã€ä»£ç ä¿®æ”¹"><a href="#3ã€ä»£ç ä¿®æ”¹" class="headerlink" title="3ã€ä»£ç ä¿®æ”¹"></a>3ã€ä»£ç ä¿®æ”¹</h4><p>æ‹‰å–ä»£ç </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir code</span><br><span class="line"><span class="built_in">cd</span> code</span><br><span class="line">git <span class="built_in">clone</span> ssh://gerrit1@192.168.40.130:29418/demo</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/note_08/03.png" alt></p></div><p></p><p>æ›´æ–°git hooks</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitdir=$(git rev-parse --git-dir); scp -p -P 29418 gerrit1@192.168.40.130:hooks/commit-msg <span class="variable">$&#123;gitdir&#125;</span>/hooks/</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>  <span class="string">"init code"</span>&gt;ReadMe.txt  <span class="comment"># åˆ›å»ºæ–°æ–‡ä»¶</span></span><br><span class="line">git add ReadMe.txt  <span class="comment"># æ·»åŠ æ–°æ–‡ä»¶</span></span><br><span class="line">git commit -m <span class="string">"init code commit"</span></span><br></pre></td></tr></table></figure><p><code>git commit</code>å‡ºé”™ï¼Œæç¤ºéœ€è¦è®¾ç½®<code>user.email</code>,<code>user.name</code>è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå…ˆè®¾ç½®<code>gerrit.config</code>çš„<code>sendemail</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/gerrittest/etc/gerrit.config</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹<code>sendemail</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[sendemail]</span><br><span class="line">        <span class="built_in">enable</span> = <span class="literal">true</span></span><br><span class="line">        smtpServer = smtp.163.com</span><br><span class="line">        smtpServerPort = 465</span><br><span class="line">        smtpEncryption = ssl</span><br><span class="line">        smtpUser = ã€é‚®ç®±è´¦å·ã€‘</span><br><span class="line">        smtpPass = ã€æˆæƒå¯†ç ã€‘  <span class="comment">#æˆæƒå¯†ç </span></span><br><span class="line">        sslVerify = <span class="literal">false</span></span><br><span class="line">        from = ã€é‚®ç®±è´¦å·ã€‘</span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/gerrittest/etc/secure.config</span><br></pre></td></tr></table></figure><p>æ·»åŠ <code>sendemail</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[sendemail]</span><br><span class="line">        smtpPass = ã€æˆæƒå¯†ç ã€‘</span><br></pre></td></tr></table></figure><p>ä¹‹åé‡å¯<code>gerrit</code>ï¼Œ<code>apache</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/gerrittest/bin/gerrit.sh restart</span><br><span class="line">/etc/init.d/apache2 restart</span><br></pre></td></tr></table></figure><p>éšåè®¾ç½®<code>gerrit1</code>çš„<code>user.email</code>,<code>user.name</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.email <span class="string">"gerrit205@163.com"</span></span><br><span class="line">git config --global user.name <span class="string">"gerrit1"</span></span><br></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git commit</span><br><span class="line">git push origin HEAD:refs/<span class="keyword">for</span>/master</span><br></pre></td></tr></table></figure><p><code>git push</code>å‡ºç°é”™è¯¯,è¿™é‡Œéœ€è¦<code>gerrit1</code>ç™»å½•gerritç®¡ç†é¡µé¢ï¼Œè®¾ç½®<code>name</code>å’Œ<code>email</code></p><div align="left"><p><img src="/img/note_08/07.png" alt></p></div><p></p><div align="left"><p><img src="/img/note_08/08.png" alt></p></div><br>éšåä¼šæ”¶åˆ°é€šè¿‡<code>gerrit.config</code>ä¸­æ·»åŠ çš„é‚®ç®±å‘é€çš„é‚®ä»¶ï¼Œå¤åˆ¶æ”¶åˆ°çš„é“¾æ¥ï¼Œåœ¨<code>gerrit1</code>æ‰€ç™»å½•çš„æµè§ˆå™¨ï¼Œè¿›è¡ŒéªŒè¯ã€‚éšåå°±å¯çœ‹åˆ°ä¸Šå›¾ä¸­æ˜¾ç¤ºçš„é‚®ç®±ã€‚<p></p><p>éšåé€šè¿‡<code>admin</code>å°†<code>gerrit1</code>æ·»åŠ åˆ°<code>Administrators</code>ç»„:</p><div align="left"><p><img src="/img/note_08/04.png" alt></p></div><p></p><p>ä¹‹åé‡æ–°<code>git push</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git push origin HEAD:refs/<span class="keyword">for</span>/master</span><br></pre></td></tr></table></figure><p>æˆåŠŸå¦‚ä¸‹ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Counting objects: 3, <span class="keyword">done</span>.</span><br><span class="line">Writing objects: 100% (3/3), 284 bytes | 0 bytes/s, <span class="keyword">done</span>.</span><br><span class="line">Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">remote: Processing changes: new: 1, <span class="keyword">done</span>    </span><br><span class="line">remote: </span><br><span class="line">remote: New Changes:</span><br><span class="line">remote:   http://192.168.40.130:8081/<span class="comment">#/c/demo/+/21 init code commit</span></span><br><span class="line">remote: </span><br><span class="line">To ssh://gerrit1@192.168.40.130:29418/demo</span><br><span class="line"> * [new branch]      HEAD -&gt; refs/<span class="keyword">for</span>/master</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>gerrit1</code>è¿›å…¥gerritç®¡ç†é¡µé¢</p><div align="left"><p><img src="/img/note_08/05.png" alt></p></div><p></p><div align="left"><p><img src="/img/note_08/06.png" alt></p></div><br>æ·»åŠ <code>Reviewers</code><p></p><div align="left"><p><img src="/img/note_08/09.png" alt></p></div><p></p><p><code>gerrit1</code>æ•´ä¸ªä»£ç å°±æäº¤å®Œæˆäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯Reviewersäººå‘˜è¿›è¡Œä»£ç è¯„å®¡å’Œå…¥åº“ã€‚<br>è¿™é‡Œæ˜¯<code>admin</code>ç”¨æˆ·è¿›è¡Œå…¥åº“</p><div align="left"><p><img src="/img/note_08/10.png" alt></p></div><p></p><div align="left"><p><img src="/img/note_08/11.png" alt></p></div><p></p><p>æ•´ä¸ªä»£ç å°±å…¥åº“å®Œæˆã€‚</p>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Gerrit </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>è¿›ç¨‹</title>
      <link href="/2018/09/03/%E7%AC%94%E8%AE%B0/09%E8%BF%9B%E7%A8%8B/"/>
      <url>/2018/09/03/%E7%AC%94%E8%AE%B0/09%E8%BF%9B%E7%A8%8B/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>IDä¸º0çš„è¿›ç¨‹é€šå¸¸æ˜¯è°ƒç”¨è¿›ç¨‹ï¼Œå¸¸è¢«ç§°ä¸ºäº¤æ¢è¿›ç¨‹ã€‚è¿˜è¿›ç¨‹æ˜¯å†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œä¸æ‰§è¡Œä»»ä½•ç£ç›˜ä¸Šçš„ç¨‹åºï¼Œå› æ­¤ç§°ä¸ºç³»ç»Ÿè¿›è¡Œã€‚<br>IDä¸º1é€šå¸¸æ˜¯initè¿›ç¨‹ï¼Œåœ¨è‡ªä¸¾è¿‡ç¨‹ç»“æŸæ—¶ç”±å†…æ ¸è°ƒç”¨ã€‚<br>IDä¸º2æ—¶é¡µå®ˆæŠ¤è¿›ç¨‹ï¼Œè´Ÿè´£è™šæ‹Ÿå­˜å‚¨å™¨ç³»ç»Ÿçš„åˆ†é¡µæ“ä½œ</p><p>å­è¿›ç¨‹ç»§æ‰¿çˆ¶è¿›ç¨‹çš„å±æ€§ï¼š</p><ul><li>å…±äº«æ–‡ä»¶ï¼š çˆ¶è¿›ç¨‹çš„æ‰€æœ‰æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦éƒ½è¢«å¤åˆ¶åˆ°å­è¿›ç¨‹ä¸­</li><li>å®é™…ç”¨æˆ·IDã€å®é™…ç»„IDã€æœ‰æ•ˆç”¨æˆ·IDã€æœ‰æ•ˆç»„ID</li><li>é™„å±ç»„ID</li><li>è¿›ç¨‹ç»„ID</li><li>ä¼šè¯ID</li><li>è®¾å¤‡ç”¨æˆ·IDæ ‡å¿—å’Œè®¾å¤‡ç»„IDæ ‡å¿—</li><li>å½“å‰å·¥ä½œç›®å½•</li><li>æ ¹ç›®å½•</li><li>æ–‡ä»¶æ¨¡å¼åˆ›å»ºå±è”½å­—</li><li>ä¿¡å·å±è”½å’Œå®‰æ’</li><li>å¯¹ä»»ä¸€æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦çš„æ‰§è¡Œæ—¶å…³é—­ï¼ˆclose-on-execï¼‰æ ‡å¿—</li><li>ç¯å¢ƒ</li><li>è¿æ¥çš„å…±äº«å­˜å‚¨æ®µ</li><li>å­˜å‚¨æ˜ å°„</li><li>èµ„æºé™åˆ¶</li></ul><p>å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹çš„åŒºåˆ«ï¼š</p><ul><li>forkçš„è¿”å›å€¼ä¸åŒ</li><li>è¿›ç¨‹IDä¸åŒ</li><li>ä¸¤ä¸ªè¿›ç¨‹çš„çˆ¶è¿›ç¨‹IDä¸åŒï¼šå­è¿›ç¨‹çš„çˆ¶è¿›ç¨‹IDæ—¶åˆ›å»ºå®ƒçš„è¿›ç¨‹IDï¼Œè€Œçˆ¶è¿›ç¨‹çš„çš„çˆ¶è¿›ç¨‹IDåˆ™ä¸å˜</li><li>å­è¿›ç¨‹çš„tms_utimeã€tms_stimeã€tms_cutimeå’Œtms_ustimeçš„å€¼è®¾ç½®ä¸º0</li><li>å­è¿›ç¨‹ä¸ç»§æ‰¿çˆ¶è¿›ç¨‹è®¾ç½®çš„æ–‡ä»¶é”</li><li>å­è¿›ç¨‹çš„æœªå¤„ç†é—¹é’Ÿè¢«æ¸…æ¥šã€‚</li><li>å­è¿›ç¨‹çš„æœªå¤„ç†ä¿¡å·é›†è®¾å¤‡ä¸ºç©ºå¯‚ã€‚</li></ul><p>forkçš„ä¸¤ç§ç”¨æ³•ï¼š<br>-ï¼ˆ1ï¼‰ã€çˆ¶è¿›ç¨‹å¸Œæœ›å¤åˆ¶è‡ªå·±ï¼Œä½¿çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹åŒæ—¶æ‰§è¡Œä¸åŒçš„ä»£ç æ®µã€‚è¿™åœ¨ç½‘ç»œæœåŠ¡è¿›ç¨‹ä¸­æ—¶å¸¸ç”¨çš„â€“çˆ¶è¿›ç¨‹ç­‰å¾…å®¢æˆ·ç«¯çš„æœåŠ¡è¯·æ±‚ã€‚å½“è¿™ç§è¯·æ±‚åˆ°è¾¾æ—¶ï¼Œçˆ¶è¿›ç¨‹è°ƒç”¨forkï¼Œä½¿å­è¿›ç¨‹å¤„ç†æ­¤è¯·æ±‚ã€‚çˆ¶è¿›ç¨‹åˆ™ç»§ç»­ç­‰å¾…ä¸‹ä¸€ä¸ªæœåŠ¡è¯·æ±‚ã€‚<br>-ï¼ˆ2ï¼‰ã€ä¸€ä¸ªè¿›ç¨‹è¦æ‰§è¡Œä¸€ä¸ªä¸åŒçš„ç¨‹åºã€‚è¿™å¯¹shellæ˜¯å¸¸è§çš„æƒ…å†µã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå­è¿›ç¨‹ä»forkè¿”å›åç«‹å³è°ƒç”¨exec</p><p>æŸäº›æ“ä½œç³»ç»Ÿå°†ç¬¬2ä¸­ç”¨æ³•çš„ä¸¤ä¸ªæ“ä½œï¼ˆforkä¹‹åæ‰§è¡Œexecï¼‰ç»„åˆæˆä¸€ä¸ªæ“ä½œï¼Œåƒå‘¢å„ä½spawnã€‚unixç³»ç»Ÿå°†è¿™ä¸¤ä¸ªæ“ä½œåˆ†æï¼Œå› ä¸ºåœ¨å¾ˆå¤šåœºåˆéœ€è¦å•ç‹¬ä½¿ç”¨forkï¼Œå…¶åå¹¶ä¸æ˜¯è·Ÿéšexecã€‚å¦å¤–ï¼Œå°†è¿™ä¸¤ä¸ªæ“ä½œåˆ†å¼€ï¼Œä½¿å¾—å­è¿›ç¨‹åœ¨forkå’Œexecä¹‹é—´å¯ä»¥æ›´æ”¹è‡ªå·±çš„å±æ€§ï¼Œå¦‚I/Oé‡å®šå‘ï¼Œç”¨æˆ·IDã€ä¿¡å·å®‰æ’ç­‰ã€‚</p><p>vfork<br>exit<br>_exit</p><p>å½“ä¸€ä¸ªè¿›ç¨‹æ­£å¸¸æˆ–å¼‚å¸¸ç»ˆæ­¢æ—¶ï¼Œå†…æ ¸å°±ä¼šæƒ³èµ·çˆ¶è¿›ç¨‹å‘ç”ŸSIGCHLDä¿¡å·ã€‚å› ä¸ºå­è¿›ç¨‹ç»ˆæ­¢æ˜¯å¼‚æ­¥äº‹ä»¶ï¼ˆè¿™å¯ä»¥åœ¨çˆ¶è¿›ç¨‹å…è®¸çš„ä»»ä½•æ—¶å€™å‘ç”Ÿï¼‰</p><p>exec</p>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è¿›ç¨‹æ§åˆ¶ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>çº¿ç¨‹</title>
      <link href="/2018/08/22/%E7%AC%94%E8%AE%B0/07%E7%BA%BF%E7%A8%8B/"/>
      <url>/2018/08/22/%E7%AC%94%E8%AE%B0/07%E7%BA%BF%E7%A8%8B/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>çº¿ç¨‹åŒæ­¥</p><ul><li>äº’æ–¥é‡ï¼šç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®æ•°æ®</li><li>è¯»å†™é”ï¼šåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å†™æ•°æ®ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»æ•°æ®</li><li>æ¡ä»¶å˜é‡ï¼šç¡®ä¿çº¿ç¨‹çš„å…ˆåé¡ºåº</li><li>è‡ªæ—‹é”ï¼šç”¨äºcpuçš„å ç”¨è¾ƒå°‘</li><li>å±éšœ</li></ul><p>å¦‚ä½•ä½¿ç”¨å¤šä¸ªæ§åˆ¶çº¿ç¨‹åœ¨å•ç‹¬ç¯å¢ƒä¸­æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚ä¸€ä¸ªè¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®è¯¥è¿›ç¨‹çš„ç»„æˆéƒ¨ä»¶ï¼ˆæ–‡ä»¶æè¿°ç¬¦å’Œå†…å­˜ï¼‰ã€‚</p><p>1ã€ç®€åŒ–å¤„ç†å¼‚æ­¥äº‹ä»¶çš„code,æ¯ä¸ªçº¿ç¨‹åœ¨è¿›ç¨‹äº‹ä»¶å¤„ç†æ—¶å¯ä»¥é‡‡ç”¨åŒæ­¥ç¼–ç¨‹æ¨¡å¼ã€‚<br>2ã€å¤šä¸ªçº¿ç¨‹è‡ªåŠ¨åœ°å¯ä»¥è®¿é—®ç›¸åŒåœ°å€çš„å­˜å‚¨åœ°å€ç©ºé—´å°±å’Œæ–‡ä»¶æè¿°ç¬¦ã€‚<br>3ã€é—®é¢˜åˆ†è§£ä»è€Œæé«˜ç¨‹åºçš„ååé‡ã€‚å¤šçº¿ç¨‹ä»»åŠ¡äº¤å‰è¿›è¡Œã€‚<br>4ã€äº¤äº’çš„ç¨‹åºåŒæ ·å¯ä»¥é€šè¿‡ä½¿ç”¨å¤šçº¿ç¨‹æ¥æ”¹å–„æƒ³è¦æ—¶é—´ï¼Œå¤šçº¿ç¨‹å¯ä»¥å§ç¨‹åºä¸­å¤„ç†ç”¨æˆ·è¾“å…¥è¾“å‡ºçš„éƒ¨åˆ†ä¸å…¶ä»–éƒ¨åˆ†åˆ†å¼€ã€‚</p><p>æ¯ä¸ªçº¿ç¨‹éƒ½åŒ…å«æœ‰è¡¨ç¤ºæ‰§è¡Œç¯å¢ƒæ‰€å¿…é¡»çš„ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬è¿›ç¨‹ä¸­è¡¨ç¤ºçº¿ç¨‹çš„çº¿ç¨‹IDã€ä¸€ç»„å¯„å­˜å™¨å€¼ã€æ ˆã€è°ƒåº¦ä¼˜å…ˆçº§å’Œç­–ç•¥ã€ä¿¡å·å±è”½å­—ã€errnoå˜é‡ä»¥åŠçº¿ç¨‹ç§æœ‰æ•°æ®ã€‚<br>ä¸€ä¸ªè¿›ç¨‹çš„æ‰€æœ‰ä¿¡æ¯å¯¹è¯¥è¿›ç¨‹çš„æ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯å…±äº«çš„ï¼ŒåŒ…æ‹¬å¯æ‰§è¡Œç¨‹åºä»£ç ã€ç¨‹åºçš„å…¨å±€å†…å­˜å’Œå †å†…å­˜ã€æ ˆä»¥åŠæ–‡ä»¶æè¿°ç¬¦ã€‚</p><h2 id="çº¿ç¨‹ID"><a href="#çº¿ç¨‹ID" class="headerlink" title="çº¿ç¨‹ID"></a><strong>çº¿ç¨‹ID</strong></h2><p>çº¿ç¨‹IDã€‚pthread_tæ•°æ®ç±»å‹è¡¨ç¤ºã€‚ä¸èƒ½æŠŠå®ƒä½œä¸ºæ•´æ•°å¤„ç†ã€‚å¿…é¡»ä½¿ç”¨å‡½æ•°æ¥å¯¹ä¸¤ä¸ªçº¿ç¨‹IDè¿›è¡Œæ¯”è¾ƒ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_equal</span><span class="params">(<span class="keyword">pthread_t</span> tid1, <span class="keyword">pthread_t</span> tid2)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›å€¼ï¼šè‹¥ç›¸ç­‰ï¼Œè¿”å›é0æ•°å€¼ï¼›å¦åˆ™ï¼Œè¿”å›ã€‚</span></span><br></pre></td></tr></table></figure><p>çº¿ç¨‹ä¸­é€šè¿‡è°ƒç”¨pthread_selfå‡½æ•°è·å–è‡ªèº«çš„çº¿ç¨‹ID</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="keyword">pthread_t</span> pthread_self(<span class="keyword">void</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼šè°ƒç”¨çº¿ç¨‹çš„çº¿ç¨‹ID</span></span><br></pre></td></tr></table></figure><h2 id="çº¿ç¨‹åˆ›å»º"><a href="#çº¿ç¨‹åˆ›å»º" class="headerlink" title="çº¿ç¨‹åˆ›å»º"></a><strong>çº¿ç¨‹åˆ›å»º</strong></h2><p>æ¯ä¸€ä¸ªè¿›ç¨‹åªæœ‰ä¸€ä¸ªæ§åˆ¶çº¿ç¨‹ã€‚æ–°å¢çš„çº¿ç¨‹å¯ä»¥é€šè¿‡è°ƒç”¨pthread_cerateå‡½æ•°åˆ›å»º</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_create</span><span class="params">(<span class="keyword">pthread_t</span> *<span class="keyword">restrict</span> tidp,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">const</span> <span class="keyword">pthread_attr_t</span> *<span class="keyword">restrict</span> attr,</span></span></span><br><span class="line">                     void *(*start_rtn)(void *), void *restrict arg );</span><br><span class="line"><span class="comment">// è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œè¿”å›0,ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·</span></span><br></pre></td></tr></table></figure><p>å½“pthread_createæˆåŠŸè¿”å›æ—¶ï¼Œæ–°åˆ›å»ºçº¿ç¨‹çš„çº¿ç¨‹IDä¼šè¢«è®¾å¤‡æˆtidpæŒ‡å‘çš„å†…å­˜å•å…ƒã€‚attrå‚æ•°ç”¨äºå®šåˆ¶å„ç§ä¸åŒçš„çº¿ç¨‹å±æ€§ã€‚å½“å‰å¯è®¾ç½®ä¸ºNULL,åˆ›å»ºä¸€ä¸ªå…·æœ‰é»˜è®¤å±æ€§çš„çº¿ç¨‹ã€‚<br>æ–°åˆ›å»ºçš„çº¿ç¨‹ä»start_rtnå‡½æ•°çš„åœ°å€å¼€å§‹è¿è¡Œï¼Œè¯¥å‡½æ•°åªæœ‰ä¸€ä¸ªå±‹ç±»å‹æŒ‡é’ˆå‚æ•°arg,å¦‚æœéœ€è¦å‘start_rtnå‡½æ•°ä¼ é€’çš„å‚æ•°æœ‰ä¸€ä¸ªä»¥ä¸Šï¼Œé‚£ä¹ˆéœ€è¦æŠŠè¿™äº›å‚æ•°æ”¾åˆ°ä¸€ä¸ªç»“æ„ä¸­ï¼Œç„¶åæŠŠè¿™ä¸ªç»“æ„çš„åœ°å€ä½œä¸ºargå‚æ•°ä¼ å…¥ã€‚</p><p>çº¿ç¨‹åˆ›å»ºæ—¶å¹¶ä¸èƒ½ä¿è¯é‚£ä¸ªçº¿ç¨‹ä¼šå…ˆè¿è¡Œï¼šæ˜¯æ–°åˆ›å»ºçš„çº¿ç¨‹ï¼Œè¿˜æ˜¯è°ƒç”¨çº¿ç¨‹ã€‚å…ˆåˆ›å»ºçš„çº¿ç¨‹å¯ä»¥è®¿é—®è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå¹¶ä¸”é›†æˆè°ƒç”¨çº¿ç¨‹çš„æµ®ç‚¹ç¯å¢ƒå’Œä¿¡å·å±è”½å­—ï¼Œä½†æ˜¯è¯¥çº¿ç¨‹çš„æŒ‚èµ·ä¿¡å·é›†ä¼šè¢«æ¶ˆé™¤ã€‚<br>pthreadå‡½æ•°åœ¨è°ƒç”¨å¤±è´¥æ—¶é€šå¸¸ä¼šè¿”å›é”™è¯¯ç errnoï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæä¾›errnoçš„å‰¯æœ¬ã€‚</p><p>ä¾‹å­ï¼š æ‰“å°çº¿ç¨‹IDï¼š è¿›ç¨‹IDã€æ–°çº¿ç¨‹çš„çº¿ç¨‹IDä»¥åŠå‡ºäº‹çº¿ç¨‹çš„çº¿ç¨‹ID.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// pthread_test1.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_t</span> ntid;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printids</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line"></span><br><span class="line">    pid = getpid();</span><br><span class="line"></span><br><span class="line">    tid = pthread_self();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s pid %lu tid %lu (0x%lx)\n"</span>,s,(<span class="keyword">unsigned</span> <span class="keyword">long</span>)pid, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)tid, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)tid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thr_fn</span><span class="params">(<span class="keyword">void</span> *agr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printids(<span class="string">"new thread:"</span>);</span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">void</span> *)<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    err = pthread_create(&amp;ntid, <span class="literal">NULL</span>,thr_fn, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err!=<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't create thread,err:%d\n"</span>,err);</span><br><span class="line">    &#125;</span><br><span class="line">    printids(<span class="string">"main thread:"</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc pthread_test1.c -l pthread</span><br><span class="line">./a.out</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/note_07/01.png" alt></p></div><p></p><h2 id="çº¿ç¨‹ç»ˆæ­¢"><a href="#çº¿ç¨‹ç»ˆæ­¢" class="headerlink" title="çº¿ç¨‹ç»ˆæ­¢"></a><strong>çº¿ç¨‹ç»ˆæ­¢</strong></h2><p>å¦‚æœè¿›ç¨‹ä¸­ä»»æ„çº¿ç¨‹è°ƒç”¨exitã€_Exitå’Œ_exitï¼Œé‚£ä¹ˆæ•´ä¸ªè¿›ç¨‹å°±ä¼šç»ˆæ­¢ã€‚<br>å•ä¸ªè¿›ç¨‹å¯ä»¥é€šè¿‡3ä¸­æ–¹å¼é€€å‡ºï¼Œå› æ­¤å¯ä»¥åœ¨ä¸ç»ˆæ­¢æ•´ä¸ªè¿›ç¨‹çš„æƒ…å†µä¸‹ï¼Œåœæ­¢å®ƒçš„æ§åˆ¶æµï¼š<br>ï¼ˆ1ï¼‰ã€çº¿ç¨‹å¯ä»¥ç®€å•åœ°ä»å¯åŠ¨ä¾‹ç¨‹ä¸­è¿”å›ï¼Œè¿”å›å€¼æ˜¯çº¿ç¨‹çš„é€€å‡ºç ã€‚<br>ï¼ˆ2ï¼‰ã€çº¿ç¨‹å¯ä»¥è¢«åŒä¸€è¿›ç¨‹ä¸­çš„å…¶ä»–çº¿ç¨‹å–æ¶ˆã€‚<br>ï¼ˆ3ï¼‰ã€çº¿ç¨‹è°ƒç”¨pthread_exit</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pthread_exit</span><span class="params">(<span class="keyword">void</span> *rval_ptr)</span></span></span><br></pre></td></tr></table></figure><p>rval_ptrå‚æ•°æ˜¯ä¸€ä¸ªæ— ç±»å‹æŒ‡é’ˆï¼Œä¸ä¼ ç»™å¯åŠ¨ä¾‹ç¨‹çš„å•ä¸ªå‚æ•°ç±»ä¼¼ã€‚è¿›ç¨‹ä¸­å…¶ä»–çº¿ç¨‹ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨pthread_joinå‡½æ•°è®¿é—®åˆ°è¿™ä¸ªæŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_join</span><span class="params">(<span class="keyword">pthread_t</span> thread, <span class="keyword">void</span> **rval_ptr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œè¿”å›0ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·</span></span><br></pre></td></tr></table></figure><p>è°ƒç”¨çº¿ç¨‹å°†ä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°æŒ‡å®šçš„çº¿ç¨‹è°ƒç”¨pthread_exitã€ä»å¯åŠ¨ä¾‹ç¨‹ä¸­è¿”å›æˆ–è€…è¢«å–æ¶ˆã€‚å¦‚æœçº¿ç¨‹ç®€å•åœ°ä»å®ƒçš„å¯åŠ¨ä¾‹ç¨‹è¿”å›ï¼Œrval_ptrå°±åŒ…å«è¿”å›ç ã€‚å¦‚æœçº¿ç¨‹è¢«å–æ¶ˆï¼Œç”±rval_ptræŒ‡å®šçš„å†…å­˜å•å…ƒå°±è®¾å¤‡ä¸ºPTHREAD_CANCELEDã€‚<br>è°ƒç”¨pthread_joinè‡ªåŠ¨æŠŠçº¿ç¨‹ç½®äºåˆ†ç¦»çŠ¶æ€ï¼Œè¿™æ ·èµ„æºå°±å¯ä»¥æ¢å¤ã€‚å¦‚æœçº¿ç¨‹å·²ç»å¤„äºåˆ†ç¦»çŠ¶æ€ï¼Œpthread_joinè°ƒç”¨å°±ä¼šå¤±è´¥ï¼Œè¿”å›EINVALã€‚<br>å¦‚æœå¯¹çº¿ç¨‹çš„è¿”å›å€¼ä¸æ„Ÿå…´è¶£ï¼Œå¯ä»¥æŠŠrval_ptrè®¾ç½®ä¸ºNULLã€‚è¿™ç§æƒ…å†µè°ƒç”¨pthread_joinå‡½æ•°å¯ä»¥ç­‰å¾…æŒ‡å®šçš„çº¿ç¨‹ç»ˆæ­¢ï¼Œä½†å¹¶ä¸è·å–çº¿ç¨‹çš„ç»ˆæ­¢çŠ¶æ€ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thr_fn1</span><span class="params">(<span class="keyword">void</span> *agr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread 1 returning\n"</span>);</span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">void</span> *)<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thr_fn2</span><span class="params">(<span class="keyword">void</span> *agr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread 2 exiting\n"</span>);</span><br><span class="line">    pthread_exit((<span class="keyword">void</span> *)<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> tid1,tid2;</span><br><span class="line">    <span class="keyword">void</span> *tret;</span><br><span class="line"></span><br><span class="line">    err = pthread_create(&amp;tid1, <span class="literal">NULL</span>, thr_fn1, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err!=<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't create thread 1\n"</span>);</span><br><span class="line"></span><br><span class="line">    err = pthread_create(&amp;tid2, <span class="literal">NULL</span>, thr_fn2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err!=<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't create thread 2\n"</span>);</span><br><span class="line"></span><br><span class="line">    err = pthread_join(tid1, &amp;tret);</span><br><span class="line">    <span class="keyword">if</span>(err!=<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't join with thread 1\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread 1 exit code %ld\n"</span>,(<span class="keyword">long</span>)tret);</span><br><span class="line"></span><br><span class="line">    err = pthread_join(tid2, &amp;tret);</span><br><span class="line">    <span class="keyword">if</span>(err!=<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't join with thread 2\n"</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread 2 exit code %ld\n"</span>,(<span class="keyword">long</span>)tret);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/note_07/02.png" alt></p></div><p></p><p>ä»¥ä¸‹ç¨‹åºç»™å‡ºäº†ç”¨è‡ªåŠ¨å˜é‡ï¼ˆåˆ†é…åœ¨æ ˆä¸Šï¼‰ä½œä¸ºpthread_exitçš„å‚æ•°æ—¶å‡ºç°é—®é¢˜</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> a,b,c,d;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printfoo</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *s,<span class="keyword">const</span> struct foo *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>, s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" structure at 0x%lx\n"</span>,(<span class="keyword">unsigned</span> <span class="keyword">long</span>)fp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" foo.a = %d\n"</span>, fp-&gt;a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" foo.b = %d\n"</span>, fp-&gt;b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" foo.c = %d\n"</span>, fp-&gt;c);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">" foo.d = %d\n"</span>, fp-&gt;d);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thr_fn1</span><span class="params">(<span class="keyword">void</span> *agr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> <span class="title">foo</span>=&#123;</span><span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;;</span><br><span class="line">    printfoo(<span class="string">"thread 1:\n"</span>, &amp;foo);</span><br><span class="line">    pthread_exit((<span class="keyword">void</span> *)&amp;foo);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thr_fn2</span><span class="params">(<span class="keyword">void</span> *agr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"thread 2 ID is %lu\n"</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)pthread_self());</span><br><span class="line">    pthread_exit((<span class="keyword">void</span> *)<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pthread_t</span> tid1,tid2;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">fp</span>;</span></span><br><span class="line"></span><br><span class="line">    err = pthread_create(&amp;tid1, <span class="literal">NULL</span>, thr_fn1, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err!=<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't create thread 1\n"</span>);</span><br><span class="line">    err = pthread_join(tid1, (<span class="keyword">void</span> *)&amp;fp);</span><br><span class="line">    <span class="keyword">if</span>(err!=<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't join with thread 1\n"</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"parent starting second thread\n"</span>);</span><br><span class="line"></span><br><span class="line">    err = pthread_create(&amp;tid2, <span class="literal">NULL</span>, thr_fn2, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span>(err!=<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"can't create thread 2\n"</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    printfoo(<span class="string">"parent:\n"</span>,fp);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/note_07/03.png" alt></p></div><p></p><p>çº¿ç¨‹å¯ä»¥é€šè¿‡pthread_cancelå‡½æ•°æ¥è¯·æ±‚å–æ¶ˆåŒä¸€è¿›ç¨‹ä¸­çš„å…¶ä»–çº¿ç¨‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cancel</span><span class="params">(<span class="keyword">pthread_t</span> tid)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼šå¦‚æˆåŠŸï¼Œè¿”å›0ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–ç ã€‚</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼špthead_cancelå¹¶ä¸ç­‰å¾…çº¿ç¨‹ç»ˆæ­¢ï¼Œå®ƒä»…ä»…æå‡ºè¯·æ±‚ã€‚<br>çº¿ç¨‹å¯ä»¥å®‰æ’å®ƒé€€å‡ºæ—¶éœ€è¦è°ƒç”¨çš„å‡½æ•°ï¼Œè¿™æ ·çš„å‡½æ•°ç§°ä¸º<code>çº¿ç¨‹æ¸…ç†å¤„ç†ç¨‹åºï¼ˆthread cleanup handlerï¼‰</code>ã€‚ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å»ºç«‹æœµå„¿æ¸…ç†å¤„ç†ç¨‹åºã€‚å¤„ç†ç¨‹åºè®°å½•åœ¨æ ˆä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä»¬çš„æ‰§è¡Œé¡ºåºä¸å®ƒä»¬æ³¨å†Œæ—¶ç›¸åã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">void pthread_cleanup_push(void (*rtn)(void *), void *arg);</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pthread_cleanup_pop</span><span class="params">(<span class="keyword">int</span> execute)</span></span>;</span><br></pre></td></tr></table></figure><h2 id="çº¿ç¨‹åŒæ­¥"><a href="#çº¿ç¨‹åŒæ­¥" class="headerlink" title="çº¿ç¨‹åŒæ­¥"></a><strong>çº¿ç¨‹åŒæ­¥</strong></h2><p>ä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹åœ¨åŒä¸€æ—¶é—´ä¿®æ”¹åŒä¸€å˜é‡æ—¶ï¼Œä¹Ÿéœ€è¦è¿›è¡ŒåŒæ­¥ï¼Œå¢é‡æ“ä½œé€šå¸¸åˆ†è§£ä¸ºä»¥ä¸‹3æ­¥ï¼š<br>ï¼ˆ1ï¼‰ã€ä»å†…å­˜å•å…ƒè¯»å…¥å¯„å­˜å™¨ã€‚<br>ï¼ˆ2ï¼‰ã€åœ¨å¯„å­˜å™¨ä¸­å¯¹å˜é‡åšå¢é‡æ“ä½œã€‚<br>ï¼ˆ3ï¼‰ã€æŠŠæ–°çš„å€¼å†™å›å†…å­˜å•å…ƒã€‚</p><h3 id="1ã€äº’æ–¥é‡ï¼ˆmutexï¼‰"><a href="#1ã€äº’æ–¥é‡ï¼ˆmutexï¼‰" class="headerlink" title="1ã€äº’æ–¥é‡ï¼ˆmutexï¼‰"></a><strong>1ã€äº’æ–¥é‡ï¼ˆmutexï¼‰</strong></h3><p>æœ¬è´¨ä¸Šä¸ºä¸€æŠŠé”ã€‚<br>äº’æ–¥å˜é‡æ˜¯ç”¨pthead_nutex_tæ•°æ®ç±»å‹è¡¨ç¤ºçš„ã€‚åœ¨ä½¿ç”¨äº’æ–¥å˜é‡ä»¥å‰ï¼Œå¿…é¡»é¦–å…ˆå¯¹å®ƒè¿›è¡Œåˆå§‹åŒ–ï¼Œå¯ä»¥æŠŠå®ƒè®¾ç½®ä¸ºå¸¸é‡PTHREAD_MUTEX_INITIALIZER(åªé€‚ç”¨äºé™æ€åˆ†é…çš„äº’æ–¥é‡)ã€‚ä¹Ÿå¯ä»¥é€šè¿‡è°ƒç”¨pthread_mutex_initå‡½æ•°è¿›è¡Œåˆå§‹åŒ–ã€‚å¦‚æœæ˜¯åŠ¨æ€åˆ†é…äº’æ–¥é‡ï¼ˆä¾‹å¦‚ï¼šmallocå‡½æ•°ï¼‰ï¼Œåœ¨æ˜¯å¦å†…å­˜å‰éœ€è¦è°ƒç”¨pthread_mutex_destoryã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_init</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex, <span class="keyword">const</span> <span class="keyword">pthread_mutexattr_t</span> *restict attr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_destroy</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä¸¤ä¸ªå‡½æ•°çš„è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œè¿”å›0ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨é»˜è®¤çš„å±æ€§åˆå§‹åŒ–äº’æ–¥é‡ï¼Œåªéœ€æŠŠattrè®¾ä¸ºNULLã€‚</p><p>å¯¹äº’æ–¥é‡è¿›è¡ŒåŠ é”ã€‚éœ€è¦è°ƒç”¨pthread_mutex_lockã€‚å¦‚æœäº’æ–¥é‡å·²ç»ä¸Šé”ï¼Œè°ƒç”¨çº¿ç¨‹å°†é˜»å¡ç›´åˆ°äº’æ–¥é‡è¢«è§£é”ã€‚å¯¹äº’æ–¥é‡è§£é”ï¼Œéœ€è¦è°ƒç”¨pthread_mutex_unlock.</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_lock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_trylock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_unlock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *mutex)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰€æœ‰å‡½æ•°çš„è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œè¿”å›0ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·</span></span><br></pre></td></tr></table></figure><p>å¦‚æœçº¿ç¨‹ä¸å¸Œæœ›è¢«é˜»å¡ï¼Œå®ƒå¯ä»¥ä½¿ç”¨pthread_mutex_trylockå°è¯•å¯¹äº’æ–¥é‡è¿›è¡ŒåŠ é”ã€‚å¦‚æœè°ƒç”¨pthread_mutex_trylockæ—¶äº’æ–¥é‡å¤„äºæœªé”å®šçŠ¶æ€ï¼Œé‚£ä¹ˆpthread_mutex_trylockå°†é”ä½äº’æ–¥é‡ï¼Œä¸ä¼šå‡ºç°é˜»å¡ç›´æ¥è¿”å›0ï¼Œå¦åˆ™pthread_mutex_trylockå°±ä¼šå¤±è´¥ï¼Œä¸èƒ½é”ä½äº’æ–¥é‡ï¼Œè¿”å›EBUSYã€‚</p><h3 id="é¿å…æ­»é”"><a href="#é¿å…æ­»é”" class="headerlink" title="é¿å…æ­»é”"></a><strong>é¿å…æ­»é”</strong></h3><p>ä½¿ç”¨å¤šä¸ªäº’æ–¥é‡æ—¶å¯¼è‡´æ­»é”ã€‚éœ€è¦ä»¥ç›¸åŒé¡ºåºåŠ é”ï¼Œè¿™æ ·å¯ä»¥é¿å…æ­»é”ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NHASH 29</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HASH(id) (((unsigned long)id)%NHASH)</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">fh</span>[<span class="title">NHASH</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_mutex_t</span> hashlock = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">foo</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> f_count;</span><br><span class="line">    <span class="keyword">pthread_mutex_t</span> f_lock;</span><br><span class="line">    <span class="keyword">int</span> f_id;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">f_next</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">struct foo *<span class="title">foo_malloc</span><span class="params">(<span class="keyword">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">fp</span>;</span></span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line">    <span class="keyword">if</span> ((fp = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct foo)))!= <span class="literal">NULL</span>)&#123;</span><br><span class="line">        fp-&gt;f_count = <span class="number">1</span>;</span><br><span class="line">        fp-&gt;f_id = id;</span><br><span class="line">        <span class="keyword">if</span>(pthread_mutex_init(&amp;fp-&gt;f_lock, <span class="literal">NULL</span>)!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">free</span>(fp);</span><br><span class="line">            <span class="keyword">return</span> (<span class="literal">NULL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        idx = HASH(id);</span><br><span class="line">        pthread_muext_lock(&amp;hashlock);</span><br><span class="line">        fp-&gt;f_next = fh[idx];</span><br><span class="line">        fh[idx] = fp;</span><br><span class="line">        pthread_mutex_lock(&amp;fp-&gt;f_lock);</span><br><span class="line">        pthread_mutex_unlock(&amp;hashlock);</span><br><span class="line">         pthread_mutex_unlock(&amp;fp-&gt;f_lock);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fp;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo_hold</span><span class="params">(struct foo *fp)</span> <span class="comment">/* add a reference to the object */</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;fp-&gt;f_lock);</span><br><span class="line">    fp-&gt;f_count++;</span><br><span class="line">    pthread_mutex_unlock(&amp;fp-&gt;f_lock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">struct foo *<span class="title">foo_find</span><span class="params">(<span class="keyword">int</span> id)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">fp</span>;</span></span><br><span class="line">    pthread_mutex_lock(&amp;hashlock);</span><br><span class="line">    <span class="keyword">for</span> (fp=fh[HASH(id)]; fp!=<span class="literal">NULL</span>; fp=fp-&gt;f_next)&#123;</span><br><span class="line">        <span class="keyword">if</span> (fp-&gt;f_id = id)&#123;</span><br><span class="line">            foo_hold(fp);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;hashlock);</span><br><span class="line">    <span class="keyword">return</span>(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä¾‹å­çœ‹å‡º,åˆ†é…å‡½æ•°ç°åœ¨é”ä½äº†æ•£åˆ—åˆ—è¡¨é”ï¼ŒæŠŠå¿ƒå¾—ç»“æ„æ·»åŠ åˆ°çœ‹æ•£åˆ—é€šä¸­ï¼Œè€Œä¸”åœ¨å¯¹æ•£åˆ—åˆ—è¡¨çš„é”è§£é”ä¹‹å‰ï¼Œå…ˆé”å®šäº†æ–°ç»“æ„ä¸­çš„äº’æ–¥é‡ã€‚å› ä¸ºæ–°çš„ç»“æ„æ˜¯æ”¾åœ¨å…¨å±€åˆ—è¡¨ä¸­çš„ï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥æ‰¾åˆ°å®ƒï¼Œæ‰€ä»¥åœ¨åˆå§‹åŒ–å®Œæˆä¹‹åï¼Œéœ€è¦é˜»å¡å…¶ä»–çº¿ç¨‹å°è¯•è®¿é—®å¿ƒæœºæ„ã€‚<br>foo_findå‡½æ•°é”ä½æ•£åˆ—åˆ—è¡¨é”ï¼Œç„¶åæ‰€æœ‰è¢«è¯·æ±‚çš„ç»“æ„ï¼Œå¦‚æœæ‰¾åˆ°äº†å°±å¢åŠ å…¶å¼•ç”¨è®¡æ•°ï¼Œå¹¶è¿”å›æŒ‡å‘è¯¥ç»“æ„çš„æŒ‡é’ˆã€‚æ³¨æ„ï¼šåŠ é”é¡ºåºï¼Œå…ˆåœ¨foo_findå‡½æ•°ä¸­é”å®šæ•£åˆ—åˆ—è¡¨é”ï¼Œç„¶åå†åœ¨foo_holeå‡½æ•°ä¸­é”å®šfooç»“æ„ä¸­çš„f_lockäº’æ–¥é‡ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo_rele</span><span class="params">(struct foo *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">tfp</span>;</span></span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line"></span><br><span class="line">    pthread_mutex_lock(&amp;fp-&gt;f_lock);</span><br><span class="line">    <span class="keyword">if</span> (fp-&gt;f_count == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        pthread_mutex_unlock(&amp;fp-&gt;f_lock);</span><br><span class="line">        pthread_mutex_lock(&amp;hashlock);</span><br><span class="line">        pthread_mutex_lock(&amp;fp-&gt;f_lock);</span><br><span class="line">        <span class="comment">/* need to recheck the condition */</span></span><br><span class="line">        <span class="keyword">if</span> (fp-&gt;f_count !=<span class="number">1</span>)&#123;</span><br><span class="line">            fp-&gt;f_count--;</span><br><span class="line">            pthread_mutex_unlock(&amp;fp-&gt;f_lock);</span><br><span class="line">            pthread_mutex_unlock(&amp;hashlock);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*remove from list */</span></span><br><span class="line">        idx = HASH(fp-&gt;f_id);</span><br><span class="line">        tfp = fh[idx];</span><br><span class="line">        <span class="keyword">if</span>(tfp == fp)&#123;</span><br><span class="line">            fh[idx] = fp-&gt;f_next;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">while</span> (tfp-&gt;f_next!=fp)</span><br><span class="line">                tfp = tfp-&gt;f_next;</span><br><span class="line">            tfp-&gt;f_next = fp-&gt;f_next;</span><br><span class="line">        &#125;</span><br><span class="line">        pthread_mutex_unlock(&amp;hashlock);</span><br><span class="line">        pthread_mutex_unlock(&amp;fp-&gt;f_lock);</span><br><span class="line">        pthread_mutex_destory(&amp;fp-&gt;f_lock);</span><br><span class="line">        <span class="built_in">free</span>(fp);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        fp-&gt;fcount--;</span><br><span class="line">        pthread_mutex_unlock(&amp;fp-&gt;f_lock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>foo_releå‡½æ•°å°±å˜å¾—æ›´åŠ å¤æ‚ï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ªå¼•ç”¨ï¼Œå°±éœ€è¦å¯¹è¿™ä¸ªæœºæ„äº’æ–¥é‡è¿›è¡Œè§£é”ï¼Œå› ä¸ºéœ€è¦ä»æ•£åˆ—è¡¨ä¸­åˆ é™¤è¿™ä¸ªç»“æ„ï¼Œè¿™æ ·æ‰å¯ä»¥è·å–æ•£åˆ—è¡¨åˆ—è¡¨é”ï¼Œç„¶åé‡æ–°è·å–ç»“æ„äº’æ–¥é¢†ã€‚ä»ä¸Šä¸€æ¬¡è·å–ç»“æ„äº’æ–¥é‡ä»¥æ¥æˆ‘ä»¬å¯èƒ½è¢«é˜»å¡ç€ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°æ£€æŸ¥æ¡ä»¶ï¼Œåˆ¤æ–­æ˜¯ä½›è¿˜éœ€è¦é‡Šæ”¾è¿™ä¸ªç»“æ„ã€‚å¦‚æœå¦ä¸€ä¸ªçº¿ç¨‹åœ¨æˆ‘ä»¬ä¸ºæ»¡è¶³é”é¡ºåºè€Œé˜»å¡æ—¶å‘ç°äº†è¿™ä¸ªç»“æ„å¹¶å¯¹å…¶å¼•ç”¨è®¡æ•°+1ï¼Œé‚£ä¹ˆåªéœ€ç®€å•åœ°å¯¹æ•´ä¸ªå¼•ç”¨è®¡æ•°-1ï¼Œå¯¹æ‰€æœ‰çš„ä¸œè¥¿è§£é”ï¼Œç„¶åè¿”å›ã€‚</p><p>ä¸Šè¿°é”çš„æ–¹å¼å¾ˆå¤æ‚ï¼Œéœ€è¦é‡æ–°è®¾è®¡ï¼Œå¯ä»¥ä½¿ç”¨æ•£åˆ—åˆ—è¡¨é”æ¥ä¿æŠ¤ç»“æ„å¼•ç”¨è®¡æ•°ï¼Œæ˜¯äº‹æƒ…å¤§å¤§ç®€åŒ–ã€‚ç»“æ„äº’æ–¥é‡å¯ä»¥ç”¨äºä¿æŠ¤fooç»“æ„ä¸­çš„å…¶ä»–ä»»ä½•ä¸œè¥¿ã€‚å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo_rele</span><span class="params">(struct foo *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">foo</span> *<span class="title">tfp</span>;</span></span><br><span class="line">    <span class="keyword">int</span> idx;</span><br><span class="line"></span><br><span class="line">    pthread_mutex_lock(&amp;hasklock);</span><br><span class="line">    <span class="keyword">if</span>(--fp-&gt;f_count==<span class="number">0</span>)&#123;</span><br><span class="line">        idx = HASH(fp-&gt;f_id);</span><br><span class="line">        tfp = fh[idx];</span><br><span class="line">        <span class="keyword">if</span>(tfp == fp)&#123;</span><br><span class="line">            fh[idx]=fp-&gt;f_next;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">while</span>(tfp-&gt;f_next!=fp)</span><br><span class="line">                tfp = tfp-&gt;f_next;</span><br><span class="line">            tfp-&gt;f_next = fp-&gt;f_next;</span><br><span class="line">        &#125;</span><br><span class="line">        pthread_mutex_unlock(&amp;hashlock);</span><br><span class="line">        pthread_mutex_destroy(&amp;fp-&gt;f_lock);</span><br><span class="line">        <span class="built_in">free</span>(fp);</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        pthread_mutex_unlock(&amp;hashlock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3ã€å‡½æ•°pthread-mutex-timedlock"><a href="#3ã€å‡½æ•°pthread-mutex-timedlock" class="headerlink" title="3ã€å‡½æ•°pthread_mutex_timedlock"></a><strong>3ã€å‡½æ•°pthread_mutex_timedlock</strong></h3><p>å½“çº¿ç¨‹å¸ˆå¾’è·å–ä¸€ä¸ªå·²åŠ é”çš„äº’æ–¥é‡æ—¶ï¼Œpthread_mutex_timedlockäº’æ–¥é‡åŸè¯­å…è®¸ç»‘å®šçº¿ç¨‹é˜»å¡æ—¶é—´ã€‚pthread_mutex_timedlockå‡½æ•°ä¸pthread_mutex_lockæ—¶åŸºæœ¬ç­‰å°±æŒ‰çš„ï¼Œä½†æ˜¯åœ¨è¾¾åˆ°è¶…æ—¶æ—¶é—´å€¼æ—¶ï¼Œpthread_mutex_timedlockä¸ä¼šå¯¹äº’æ–¥é‡è¿›è¡ŒåŠ é”ï¼Œè€Œæ˜¯è¿”å›é”™è¯¯ç ETIMEDOUTã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_mutex_timedlock</span><span class="params">(<span class="keyword">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex, </span></span></span><br><span class="line"><span class="function"><span class="params">                            <span class="keyword">const</span> struct timespec *<span class="keyword">restrict</span> tsptr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œè¿”å›0ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·</span></span><br></pre></td></tr></table></figure><h3 id="4ã€è¯»å†™é”"><a href="#4ã€è¯»å†™é”" class="headerlink" title="4ã€è¯»å†™é”"></a><strong>4ã€è¯»å†™é”</strong></h3><p>è¯»å†™é”ï¼ˆreader-writer lockï¼‰ä¸äº’æ–¥é‡ç±»ä¼¼ï¼Œä¸è¿‡è¯»å†™é”å…è®¸æ›´é«˜çš„å¹¶è¡Œæ€§ã€‚äº’æ–¥é”è¦ä¹ˆé”ä½çŠ¶æ€ã€è¦ä¹ˆä¸åŠ é”çŠ¶æ€ã€‚è€Œä¸”ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¯¹å…¶åŠ é”ã€‚<br>è¯»å†™é”å¯ä»¥æœ‰3ç§çŠ¶æ€ï¼šè¯»æ¨¡å¼ä¸‹åŠ é”çŠ¶æ€ã€å†™æ¨¡å¼ä¸‹åŠ é”çŠ¶æ€ã€ä¸åŠ é”çŠ¶æ€ã€‚ä¸€æ¬¡åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥å æœ‰å†™æ¨¡å¼ä¸‹çš„è¯»å†™é”ï¼Œä½†æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶å æœ‰è¯»æ¨¡å¼çš„è¯»å†™é”ã€‚<br>è¯»å†™é”ï¼Œé€‚ç”¨äºè¯»æ¬¡æ•°è¿œå¤§äºå†™æ¨¡å¼çš„æƒ…å†µã€‚è¯»å†™é”ä¹Ÿå«<code>å…±äº«äº’æ–¥é”(shared-exclusiv lock)</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_init</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *<span class="keyword">restrict</span> rwlock,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> <span class="keyword">pthread_rwlockattr_t</span> *<span class="keyword">restrict</span> attr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_destroy</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *rwlock)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡½æ•°è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œè¿”å›0ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·ã€‚</span></span><br></pre></td></tr></table></figure><p>å¸Œæœ›è¯»å†™é”ç”±é»˜è®¤çš„å±æ€§ï¼Œå¯ä»¥ä¼ ä¸€ä¸ªnullæŒ‡é’ˆç»™attrã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_rdlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *rwlock)</span></span>;  <span class="comment">//è¯»æ¨¡å¼ä¸‹é”å®šè¯»å†™é”</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_wrlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *rwlock)</span></span>;  <span class="comment">//å†™æ¨¡å¼ä¸‹é”å®šè¯»å†™é”</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_unlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *rwlock)</span></span>;  <span class="comment">//è§£é”</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼šå¦‚æˆåŠŸ,è¿”å›0; å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·</span></span><br></pre></td></tr></table></figure><h3 id="5ã€å¸¦æœ‰è¶…æ—¶çš„è¯»å†™é”"><a href="#5ã€å¸¦æœ‰è¶…æ—¶çš„è¯»å†™é”" class="headerlink" title="5ã€å¸¦æœ‰è¶…æ—¶çš„è¯»å†™é”"></a><strong>5ã€å¸¦æœ‰è¶…æ—¶çš„è¯»å†™é”</strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_timedrdlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *<span class="keyword">restrict</span> rwlock,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">const</span> struct timespec *<span class="keyword">restrict</span> tsptr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_rwlock_timedwrlock</span><span class="params">(<span class="keyword">pthread_rwlock_t</span> *<span class="keyword">restrict</span> rwlock,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">const</span> struct timespec *<span class="keyword">restrict</span> tsptr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œè¿”å›0ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·</span></span><br></pre></td></tr></table></figure><h3 id="6ã€æ¡ä»¶å˜é‡"><a href="#6ã€æ¡ä»¶å˜é‡" class="headerlink" title="6ã€æ¡ä»¶å˜é‡"></a><strong>6ã€æ¡ä»¶å˜é‡</strong></h3><p>æ¡ä»¶å˜é‡æ—¶çº¿ç¨‹å¯ç”¨çš„å¦ä¸€ç§åŒæ­¥æœºåˆ¶ã€‚ä½¿ç”¨æ¡ä»¶å˜é‡ä¹‹å‰ï¼Œå¿…å…ˆå¯¹å®ƒè¿›è¡Œåˆå§‹åŒ–ã€‚ç”±pthread_cond_tæ•°æ®ç±»å‹è¡¨ç¤ºæ¡ä»¶å˜é‡ã€‚<br>ä¸¤ç§æ–¹å¼åˆå§‹åŒ–ï¼š1ã€æŠŠå¸¸é‡PTHREAD_COND_INITIALIZERèµ‹ç»™é™æ€åˆ†é…çš„æ¡ä»¶å˜é‡ã€‚2ã€ä½¿ç”¨pthread_cond_initå‡½æ•°å‡ºäº‹å“ˆåŠ¨æ€åˆ†é…çš„æ¡ä»¶å˜é‡ã€‚<br>ä½¿ç”¨pthread_cond_destoryå‡½æ•°å¯¹æ¡ä»¶å˜é‡è¿›è¡Œååˆå§‹åŒ–ï¼ˆdeinitializeï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_init</span><span class="params">(<span class="keyword">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> <span class="keyword">pthread_condattr_t</span> *<span class="keyword">restrict</span> attr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_destory</span><span class="params">(<span class="keyword">pthread_cond_t</span> *cond)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œè¿”å›0ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·ã€‚</span></span><br></pre></td></tr></table></figure><p>é»˜è®¤attrå¯ä»¥NULLã€‚<br>ä½¿ç”¨pthread_cond_waitç­‰å¾…æ¡ä»¶å˜çœŸã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_crond_wait</span><span class="params">(<span class="keyword">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_crond_timedwait</span><span class="params">(<span class="keyword">pthread_cond_t</span> *<span class="keyword">restrict</span> cond,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">pthread_mutex_t</span> *<span class="keyword">restrict</span> mutex</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">const</span> struct timespec *<span class="keyword">restrict</span> tsptr)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œè¿”å›0ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·</span></span><br></pre></td></tr></table></figure><p>è·å–è¶…æ—¶çš„ç»å¯¹å€¼æ—¶é—´ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">maketimeout</span><span class="params">(struct timespec *tsp, <span class="keyword">long</span> minutes)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">now</span>;</span></span><br><span class="line">    <span class="comment">/* get the current time */</span></span><br><span class="line">    gettimeofday(&amp;now, <span class="literal">NULL</span>);</span><br><span class="line">    tsp-&gt;tv_sec = now.tv_sec;</span><br><span class="line">    tsp-&gt;tv_nesc = now.tv_usec*<span class="number">1000</span>; <span class="comment">// usec to nsec</span></span><br><span class="line">    <span class="comment">/* add the offset to get timeout value */</span></span><br><span class="line">    tsp-&gt;tv_esc += minutes *<span class="number">60</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¶…æ—¶åˆ°æœŸæ—¶æ—¶é—´è¿˜æ²¡æœ‰å‡ºç°ï¼Œpthread_cond_timewaitå°†é‡æ–°è·å–äº’æ–¥é‡ï¼Œç„¶åè¿”å›é”™è¯¯ETIMEDOUTã€‚ä»pthread_cond_waitæˆ–pthread_cond_timedwaitè°ƒç”¨æˆåŠŸæ—¶ï¼Œç°å……éœ€è¦é‡æ–°è®¡ç®—æ¡ä»¶ï¼Œå› ä¸ºå¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½è¿è¡Œå¹¶æ”¹å˜äº†æ¡ä»¶ã€‚</p><p>æœ‰ä¸¤ä¸ªå‡½æ•°å¯ä»¥ç”¨äºé€šçŸ¥çº¿ç¨‹æ¡ä»¶å·²ç»æ»¡è¶³ã€‚pthread_cond_signalå‡½æ•°è‡³å°‘èƒ½å”¤é†’ä¸€ä¸ªç­‰å¾…è¯¥æ¡ä»¶çš„<code>çº¿ç¨‹</code>ï¼Œè€Œpthread_cond_broadcastå‡½æ•°åˆ™èƒ½å”¤é†’ç­‰å¾…è¯¥æ¡ä»¶çš„<code>æ‰€æœ‰çº¿ç¨‹</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_signal</span><span class="params">(<span class="keyword">pthrad_cond_t</span> *crond)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_cond_broadcast</span><span class="params">(<span class="keyword">pthrad_cond_t</span> *cond)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œè¿”å›0ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·ã€‚</span></span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šå‡½æ•°ä¸ºç»™çº¿ç¨‹æˆ–æ¡ä»¶å‘ä¿¡å·ã€‚æ³¨æ„ï¼šä¸€å®šè¦åœ¨æ”¹å˜æ¡ä»¶çŠ¶æ€ä»¥åå†ç»™çº¿ç¨‹å‘ä¿¡å·ã€‚</p><p>ç»“åˆä½¿ç”¨æ¡ä»¶å˜é‡å’Œäº’æ–¥é‡å¯¹æƒ³æˆè¿›è¡ŒåŒæ­¥</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="comment">/*   ... more stuff here ... */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">msg</span> *<span class="title">workq</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_cond_t</span> qready = PTHREAD_COND_INITIALIZER;</span><br><span class="line"><span class="keyword">pthread_mutex_t</span> qlock = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">process_msg</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">msg</span> *<span class="title">mp</span>;</span></span><br><span class="line">    <span class="keyword">for</span>(;;)&#123;</span><br><span class="line">        pthread_mutex_lock(&amp;qlock);</span><br><span class="line">        <span class="keyword">while</span>(workq == <span class="literal">NULL</span>)</span><br><span class="line">            pthread_cond_wait(&amp;qready, &amp;qlock);</span><br><span class="line">        mp = workq;</span><br><span class="line">        workq = mp-&gt;m_next;</span><br><span class="line">        pthread_mutex_unlock(&amp;qlock);</span><br><span class="line">        <span class="comment">/* now process the message mp */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">enqueue_msg</span><span class="params">(struct msg *mp)</span></span>&#123;</span><br><span class="line">    pthread_mutex_lock(&amp;qlock);</span><br><span class="line">    mp-&gt;m_next = workq;</span><br><span class="line">    workq = mp;</span><br><span class="line">    pthread_mutex_unlock(&amp;qlock);</span><br><span class="line">    pthread_cond_signal(&amp;qready);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="7ã€è‡ªæ—‹é”"><a href="#7ã€è‡ªæ—‹é”" class="headerlink" title="7ã€è‡ªæ—‹é”"></a><strong>7ã€è‡ªæ—‹é”</strong></h3><p>è·å–é”ä¹‹å‰ä¸€ç›´å¤„äºå¿™ç­‰ï¼ˆè‡ªæ—‹ï¼‰é˜»å¡çŠ¶æ€ã€‚è‡ªæ—‹é”ç”¨äºä»¥ä¸‹æƒ…å†µï¼šé”è¢«æŒæœ‰çš„æ—¶é—´çŸ­ï¼Œè€Œä¸”çº¿ç¨‹å¹¶ä¸å¸Œæœ›åœ¨é‡æ–°è°ƒåº¦ä¸ŠèŠ±è´¹å¤ªå¤šçš„æˆæœ¬ã€‚<br>åˆå§‹åŒ–å’Œååˆå§‹åŒ–</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_spin_init</span><span class="params">(<span class="keyword">pthread_spilock_t</span> *lock, <span class="keyword">int</span> pshared)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_spin_destroy</span><span class="params">(<span class="keyword">pthread_spilock_t</span> *lock)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œè¿”å›0ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·ã€‚</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨pthread_spin_lockæˆ–pthread_spin_trylockå¯¹è‡ªæ—‹é”è¿›è¡ŒåŠ é”ï¼Œå‰è€…åœ¨è·å–é”ä¹‹å‰ä¸€ç›´å’¨è¯¢å•Šï¼Œåè€…å¦‚æœä¸èƒ½è·å–é”ï¼Œå°±ä¼šç«‹å³è¿”å›EBUSYé”™è¯¯ï¼Œæ³¨æ„,pthread_spin_trylockä¸èƒ½è‡ªæ—‹ã€‚ä¸ç®¡ä»¥ä½•ç§æ–¹å¼åŠ é”ï¼Œè‡ªæ—‹é”éƒ½å¯ä»¥è°ƒç”¨pthread_spin_unlockå‡½æ•°è§£é”ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_spin_lock</span><span class="params">(<span class="keyword">pthread_spinlock_t</span> *lock)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_spin_trylock</span><span class="params">(<span class="keyword">pthread_spinlock_t</span> *lock)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_spin_unlock</span><span class="params">(<span class="keyword">pthread_spinlock_t</span> *lock)</span></span>;</span><br><span class="line"></span><br><span class="line">è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œè¿”å›<span class="number">0</span>ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·ã€‚</span><br></pre></td></tr></table></figure><h3 id="8ã€å±éšœ"><a href="#8ã€å±éšœ" class="headerlink" title="8ã€å±éšœ"></a><strong>8ã€å±éšœ</strong></h3><p>å±éšœ(barrier)æ—¶ç”¨æˆ·åè°ƒå¤šä¸ªçº¿ç¨‹å¹¶è¡Œå·¥ä½œçš„åŒæ­¥æœºåˆ¶ã€‚å±éšœå…è®¸æ¯ä¸ªçº¿ç¨‹ç­‰å¾…ï¼ŒçŸ¥é“æ‰€æœ‰çš„åˆä½œçº¿ç¨‹éƒ½åˆ°è¾¾æŸä¸€ç‚¹ï¼Œç„¶åä»è¯¥ç‚¹ç»§ç»­æ‰§è¡Œã€‚pthread_joinå‡½æ•°å°±æ˜¯ä¸€ç§å±éšœï¼Œå…è®¸ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é€€å‡ºã€‚<br>ä½†æ˜¯å±éšœå…è®¸ä»»æ„æ•°é‡çš„çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°æ‰€æœ‰çš„çº¿ç¨‹å®Œæˆå¤„ç†å·¥ä½œï¼Œè€Œçº¿ç¨‹ä¸éœ€è¦é€€å‡ºã€‚æ‰€æœ‰çº¿ç¨‹è¾¾åˆ°å±éšœåå¯ä»¥ç»§ç»­å·¥ä½œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_barrier_init</span><span class="params">(<span class="keyword">pthread_barrier_t</span> *<span class="keyword">restrict</span> barrier, <span class="keyword">const</span> <span class="keyword">pthread_barrierattr_t</span> *<span class="keyword">restrict</span> attr, <span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span></span>;  <span class="comment">// ä¸ºåˆ†é…èµ„æº</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_barrier_destroy</span><span class="params">(<span class="keyword">pthread_barrier_t</span> *barrier)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œè¿”å›0ï¼›å¦åˆ™ï¼Œè¿”å›é”™è¯¯ç¼–å·ã€‚</span></span><br></pre></td></tr></table></figure><p>countæŒ‡å®šå…è®¸æ‰€æœ‰çº¿ç¨‹è¿è¡Œä¹‹å‰ï¼Œå¿…é¡»åˆ°è¾¾å±éšœçš„çº¿ç¨‹æ•°ç›®ã€‚attrå‚æ•°æŒ‡å®šå±éšœå¯¹è±¡çš„å±æ€§ã€‚é»˜è®¤ä¸ºNULLã€‚</p>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> çº¿ç¨‹ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ç½‘ç«™æ”¶è—</title>
      <link href="/2018/08/01/%E6%9D%82%E8%AF%BB/02%E7%BD%91%E7%AB%99%E6%94%B6%E8%97%8F/"/>
      <url>/2018/08/01/%E6%9D%82%E8%AF%BB/02%E7%BD%91%E7%AB%99%E6%94%B6%E8%97%8F/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><span class="reprint">è½¬</span></p><div class="web_site"></div><h2 id="è§†é¢‘ç½‘ç«™"><a href="#è§†é¢‘ç½‘ç«™" class="headerlink" title="è§†é¢‘ç½‘ç«™"></a><strong><a href="http://ghmagical.com/search/navigation" target="_blank" rel="noopener">è§†é¢‘ç½‘ç«™</a></strong></h2><p><a href="https://www.imooc.com/" title="æ…•è¯¾ç½‘" target="_blank" rel="noopener">æ…•è¯¾ç½‘</a>  <a href="http://www.jikexueyuan.com/" target="_blank" rel="noopener">æå®¢å­¦é™¢</a></p><hr><h2 id="å‰ç«¯"><a href="#å‰ç«¯" class="headerlink" title="å‰ç«¯"></a><strong>å‰ç«¯</strong></h2><h3 id="å¼€å‘æ‰‹å†Œ"><a href="#å¼€å‘æ‰‹å†Œ" class="headerlink" title="å¼€å‘æ‰‹å†Œ"></a><strong>å¼€å‘æ‰‹å†Œ</strong></h3><p><a href="http://www.runoob.com/" target="_blank" rel="noopener">èœé¸Ÿæ•™ç¨‹</a>  <a href="http://www.w3school.com.cn/" target="_blank" rel="noopener">w3school</a>  <a href="http://css.doyoe.com/" target="_blank" rel="noopener">csså‚è€ƒæ‰‹å†Œ</a></p><h3 id="css"><a href="#css" class="headerlink" title="css"></a><strong>css</strong></h3><p><a href="https://daneden.github.io/animate.css/" target="_blank" rel="noopener">AnimateåŠ¨ç”»åº“</a>  <a href="http://www.iecss.com/" target="_blank" rel="noopener">ieé»˜è®¤css</a></p><h3 id="html"><a href="#html" class="headerlink" title="html"></a><strong>html</strong></h3><p><a href="http://www.html5cn.org/" target="_blank" rel="noopener">HTML5ä¸­å›½</a>  <a href="http://html5.360.cn/" target="_blank" rel="noopener">HTML5åŸºåœ°</a>  <a href="http://ask.dcloud.net.cn/explore/" target="_blank" rel="noopener">5+App</a></p><h3 id="JavaScript"><a href="#JavaScript" class="headerlink" title="JavaScript"></a><strong>JavaScript</strong></h3><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/" target="_blank" rel="noopener">MDN(JavaScript)</a>  <a href="http://bonsaiden.github.io/JavaScript-Garden/zh/" target="_blank" rel="noopener">JavaScript ç§˜å¯†èŠ±å›­</a>  <a href="https://github.com/jobbole/awesome-javascript-cn/" target="_blank" rel="noopener">JavaScriptèµ„æºå¤§å…¨</a></p><h3 id="JavaScriptåº“"><a href="#JavaScriptåº“" class="headerlink" title="JavaScriptåº“"></a><strong>JavaScriptåº“</strong></h3><p><a href="http://jquery.com/" target="_blank" rel="noopener">JQuery</a>  <a href="http://www.css88.com/doc/zeptojs_api/#ajax/" target="_blank" rel="noopener">Zepto</a>  <a href="https://angularjs.org/" target="_blank" rel="noopener">AngularJS</a>  <a href="http://docs.kissyui.com/" target="_blank" rel="noopener">KISSY</a>KISSY  <a href="http://extjs.org.cn/" target="_blank" rel="noopener">ExtJS</a></p><h3 id="JQuery"><a href="#JQuery" class="headerlink" title="JQuery"></a><strong>JQuery</strong></h3><p><a href="http://www.jquery123.com/" target="_blank" rel="noopener">jQueryä¸­æ–‡æ–‡æ¡£</a>  <a href="http://www.jq22.com/" target="_blank" rel="noopener">JQueryæ’ä»¶åº“</a>  <a href="http://www.htmleaf.com/" target="_blank" rel="noopener">JQueryä¹‹å®¶</a>  <a href="http://www.htmleaf.com/jQuery/Layout-Interface/201501281289.html" target="_blank" rel="noopener">jQuery Transit åŠ¨ç”»åº“</a>  <a href="http://www.jqueryfuns.com/" target="_blank" rel="noopener">JQueryFuns</a>  <a href="http://www.dowebok.com/77.html" target="_blank" rel="noopener">FullPage.js</a></p><h3 id="ç§»åŠ¨æ¡†æ¶"><a href="#ç§»åŠ¨æ¡†æ¶" class="headerlink" title="ç§»åŠ¨æ¡†æ¶"></a><strong>ç§»åŠ¨æ¡†æ¶</strong></h3><p><a href="http://www.ionic.wang/" target="_blank" rel="noopener">Ionic</a>]<a href="http://www.ionic.wang/" target="_blank" rel="noopener">Ionic</a>  <a href="http://jquerymobile.com/" target="_blank" rel="noopener">JQueryMobile</a>  <a href="http://www.dcloud.io/docs/api/index.shtml" target="_blank" rel="noopener">5+App</a>  <a href="http://framework7.io/" target="_blank" rel="noopener">Framework7</a>  <a href="http://frozenui.github.io/" target="_blank" rel="noopener">FrozenUI</a>  <a href="http://mobileangularui.com/" target="_blank" rel="noopener">Mobile Angular UI</a></p><h3 id="å“åº”å¼æ¡†æ¶"><a href="#å“åº”å¼æ¡†æ¶" class="headerlink" title="å“åº”å¼æ¡†æ¶"></a><strong>å“åº”å¼æ¡†æ¶</strong></h3><p><a href="http://www.bootcss.com/" target="_blank" rel="noopener">Bootstrap</a>  <a href="http://www.material-ui.com/#/" target="_blank" rel="noopener">Material-UI</a> <a href="http://getuikit.com/" target="_blank" rel="noopener">UIkit</a>  <a href="http://amazeui.org/" target="_blank" rel="noopener">AmazeUI</a></p><hr><h2 id="åšå®¢ç¤¾åŒº"><a href="#åšå®¢ç¤¾åŒº" class="headerlink" title="åšå®¢ç¤¾åŒº"></a><strong>åšå®¢ç¤¾åŒº</strong></h2><h3 id="ç¤¾åŒº"><a href="#ç¤¾åŒº" class="headerlink" title="ç¤¾åŒº"></a><strong>ç¤¾åŒº</strong></h3><p><a href="http://www.w3cfuns.com/" target="_blank" rel="noopener">W3Cfuns</a>ã€€<a href="http://blog.csdn.net/web/index.html" target="_blank" rel="noopener">CSDN</a>  <a href="http://www.cnblogs.com/" target="_blank" rel="noopener">åšå®¢å›­</a>  <a href="http://web.jobbole.com/" target="_blank" rel="noopener">ä¼¯ä¹åœ¨çº¿</a>  <a href="http://www.oschina.net/" target="_blank" rel="noopener">å¼€æºä¸­å›½</a>  <a href="http://www.ituring.com.cn/" target="_blank" rel="noopener">å›¾çµç¤¾åŒº</a>  <a href="https://www.epubit.com/" target="_blank" rel="noopener">å¼‚æ­¥ç¤¾åŒº</a>  <a href="https://www.v2ex.com/" target="_blank" rel="noopener">V2EX</a></p><h3 id="åšå®¢"><a href="#åšå®¢" class="headerlink" title="åšå®¢"></a><strong>åšå®¢</strong></h3><p><a href="http://www.ruanyifeng.com/home.html" target="_blank" rel="noopener">é˜®ä¸€å³°</a>  <a href="http://www.zhangxinxu.com/" target="_blank" rel="noopener">å¼ é‘«æ—­</a>  <a href="https://www.biaodianfu.com/" target="_blank" rel="noopener">æ ‡ç‚¹ç¬¦</a>  <a href="http://ghmagical.com/" target="_blank" rel="noopener">TG</a>  <a href="https://pengloo53.bitcron.com/" target="_blank" rel="noopener">LPâ€™s Blog</a>  <a href="http://www.laozuo.org/myvps" target="_blank" rel="noopener">è€å·¦åšå®¢</a>  <a href="http://wuzuozhi.com/" target="_blank" rel="noopener">å°å´åŒå­¦</a>  <a href="https://daliuzi.cn/" target="_blank" rel="noopener">å¤§åˆ˜å­</a>  <a href="https://www.qiansw.com/" target="_blank" rel="noopener">åƒæ€ç½‘</a>  <a href="https://www.appgao.com/" target="_blank" rel="noopener">åº”ç”¨ä¾ </a></p><hr><h2 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a><strong>å·¥å…·</strong></h2><h3 id="åœ¨çº¿å·¥å…·"><a href="#åœ¨çº¿å·¥å…·" class="headerlink" title="åœ¨çº¿å·¥å…·"></a><strong>åœ¨çº¿å·¥å…·</strong></h3><p><a href="https://www.biaodianfu.com/editor.html" target="_blank" rel="noopener">å¼€æºåœ¨çº¿ç¼–è¾‘å™¨æ¨è</a></p><h3 id="Linuxå·¥å…·"><a href="#Linuxå·¥å…·" class="headerlink" title="Linuxå·¥å…·"></a><strong>Linuxå·¥å…·</strong></h3><h3 id="Windowså·¥å…·"><a href="#Windowså·¥å…·" class="headerlink" title="Windowså·¥å…·"></a><strong>Windowså·¥å…·</strong></h3><p><a href="http://www.internetdownloadmanager.com/" target="_blank" rel="noopener">IDM</a>  <a href="/">Sublime Text</a>  <a href="https://pan.baidu.com/s/11LuWv8bZEO108mWK-JP2BQ" target="_blank" rel="noopener">é¾™å·é£</a>  <a href="https://pan.baidu.com/s/11LuWv8bZEO108mWK-JP2BQ" target="_blank" rel="noopener">æ–‡ä»¶åˆå¹¶åŠ©æ‰‹</a> <a href="https://pan.baidu.com/s/11LuWv8bZEO108mWK-JP2BQ" target="_blank" rel="noopener">æ–‡ä»¶åˆå¹¶åŠ©æ‰‹</a>  <a href="https://pan.baidu.com/s/11LuWv8bZEO108mWK-JP2BQ" target="_blank" rel="noopener">IPOP4.1</a>  <a href="https://pan.baidu.com/s/11LuWv8bZEO108mWK-JP2BQ" target="_blank" rel="noopener">WinSCP</a> <a href="https://pan.baidu.com/s/11LuWv8bZEO108mWK-JP2BQ" target="_blank" rel="noopener">XCOM</a></p><h3 id="Chromeæ’ä»¶"><a href="#Chromeæ’ä»¶" class="headerlink" title="Chromeæ’ä»¶"></a><strong>Chromeæ’ä»¶</strong></h3><p><a href="https://pan.baidu.com/s/1K9mOaoFwp7v4elLN4_H0GA" title="è°·æ­Œè®¿é—®åŠ©æ‰‹" target="_blank" rel="noopener">è°·æ­Œè®¿é—®åŠ©æ‰‹2.1.9</a>  <a href="http://shouqu.me/how.html" target="_blank" rel="noopener">æ”¶è¶£</a>  <a href="./">OneTab</a>  <a href="./">ColorZilla</a>  <a href="https://www.baidufe.com/fehelper" target="_blank" rel="noopener">FeHelper</a>  <a href="https://github.com/jinliming2/Chrome-Charset)" target="_blank" rel="noopener">Charset</a>  <a href="http://www.internetdownloadmanager.com/" target="_blank" rel="noopener">IDM</a>  <a href="./">ColorZilla</a>  <a href="https://pan.baidu.com/s/1K9mOaoFwp7v4elLN4_H0GA" title="ä¸ºæµè§ˆå™¨æä¾›ç”¨æˆ·è„šæœ¬æ”¯æŒã€‚ ç™¾åº¦ç½‘ç›˜è½¬IDMä¸‹è½½" target="_blank" rel="noopener">æš´åŠ›çŒ´</a></p><h3 id="å…¶ä»–å·¥å…·"><a href="#å…¶ä»–å·¥å…·" class="headerlink" title="å…¶ä»–å·¥å…·"></a><strong>å…¶ä»–å·¥å…·</strong></h3><p><a href="https://pan.baidu.com/s/1YcZItb6KXlmOP8tk3cslEA)" target="_blank" rel="noopener">Synergy1.8.2</a>  <a href="https://github.com/akaxincom/openzaly" title="ç§æœ‰çš„èŠå¤©æœåŠ¡å™¨ï¼Œå³è‡ªå·±æ­å»ºç±»ä¼¼ QQ çš„èŠå¤©æœåŠ¡" target="_blank" rel="noopener">openzaly</a></p><hr><h2 id="ç”µå­ä¹¦"><a href="#ç”µå­ä¹¦" class="headerlink" title="ç”µå­ä¹¦"></a><strong>ç”µå­ä¹¦</strong></h2><h3 id="ä¸“ä¸šä¹¦ç±"><a href="#ä¸“ä¸šä¹¦ç±" class="headerlink" title="ä¸“ä¸šä¹¦ç±"></a><strong>ä¸“ä¸šä¹¦ç±</strong></h3><p><a href="http://www.kancloud.cn/" target="_blank" rel="noopener">çœ‹äº‘</a>  <a href="http://www.aseoe.com/webook/" target="_blank" rel="noopener">çˆ±æ€æº</a>  <a href="http://www.jb51.net/books/" target="_blank" rel="noopener">è„šæœ¬ä¹‹å®¶</a></p><h3 id="å…¶ä»–ä¹¦ç±"><a href="#å…¶ä»–ä¹¦ç±" class="headerlink" title="å…¶ä»–ä¹¦ç±"></a><strong>å…¶ä»–ä¹¦ç±</strong></h3><h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a><strong>å…¶ä»–</strong></h3><p><a href="https://bookfere.com/" target="_blank" rel="noopener">ä¹¦ä¼´</a></p><hr><h2 id="å¸¸ç”¨APP"><a href="#å¸¸ç”¨APP" class="headerlink" title="å¸¸ç”¨APP"></a><strong>å¸¸ç”¨APP</strong></h2><p><a href="./">è—ä¹¦é¦†</a>  <a href="./">ä¸€ä¸ªæœ¨å‡½</a>  <a href="./">æ—¶å…‰ç›¸å†Œ</a>  <a href="./">ESæ–‡ä»¶æµè§ˆå™¨</a>  <a href="./">å¤¸å…‹æµè§ˆå™¨</a>  <a href="./">ä¸è¦éŸ³ä¹</a>  <a href="https://www.airdroid.com/zh-cn/index.html" title="è¿œç¨‹ç®¡æ§" target="_blank" rel="noopener">AirDroid</a>  <a href="https://pan.baidu.com/s/1vSA_6Sh5Z3JGQUBClv6qyw" title="APPä½¿ç”¨æƒ…å†µç»Ÿè®¡" target="_blank" rel="noopener">UBhind</a>  <a href="https://pan.baidu.com/s/1vSA_6Sh5Z3JGQUBClv6qyw" title="å…¨é¢å±æ‰‹åŠ¿" target="_blank" rel="noopener">æµä½“æ‰‹åŠ¿</a>  <a href="https://pan.baidu.com/s/1vSA_6Sh5Z3JGQUBClv6qyw" title="ä¼šç”¨åˆ™åŠŸèƒ½å¾ˆå¼ºå¤§ï¼Œä¸ä¼šç”¨å’‹å¤„å¤„BUG,è‡ªå·±ä½“ä¼š" target="_blank" rel="noopener">åº”ç”¨æ§åˆ¶å™¨</a></p><hr><h2 id="å¸¸ç”¨ç½‘ç«™"><a href="#å¸¸ç”¨ç½‘ç«™" class="headerlink" title="å¸¸ç”¨ç½‘ç«™"></a><strong>å¸¸ç”¨ç½‘ç«™</strong></h2><p><a href="http://www.right.com.cn/forum/forum.php" title="flipped205,F" target="_blank" rel="noopener">æ©å±±æ— çº¿è®ºå›</a> <a href="http://www.21ic.com/" title="fanxingyiye" target="_blank" rel="noopener">21ic</a>    <a href="http://www.ydss.cn/" target="_blank" rel="noopener">ç§»åŠ¨å”å”</a></p>]]></content>
      
      <categories>
          
          <category> æ‚è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç½‘ç«™ </tag>
            
            <tag> è½¬è½½ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Linux é”</title>
      <link href="/2018/07/20/%E7%AC%94%E8%AE%B0/0dLinux%E9%94%81/"/>
      <url>/2018/07/20/%E7%AC%94%E8%AE%B0/0dLinux%E9%94%81/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="è®°å½•é”ï¼ˆfcntlï¼‰"><a href="#è®°å½•é”ï¼ˆfcntlï¼‰" class="headerlink" title="è®°å½•é”ï¼ˆfcntlï¼‰"></a><strong>è®°å½•é”ï¼ˆfcntlï¼‰</strong></h2><p>ã€€ä¸¤ä¸ªè¿›ç¨‹åŒæ—¶å¯¹æ–‡ä»¶è¿›è¡Œæ“ä½œï¼šå½“ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨è¯»æˆ–è€…ä¿®æ”¹æ–‡ä»¶çš„æŸä¸ªéƒ¨åˆ†æ—¶ï¼Œä½¿ç”¨è®°å½•é”å¯ä»¥é˜»æ­¢å…¶ä»–è¿›ç¨‹ä¿®æ”¹åŒä¸€æ–‡ä»¶åŒºã€‚å¦ä¸€æœ¯è¯­<code>å­—èŠ‚èŒƒå›´é”</code>ã€‚<br>fcntlå‡½æ•°åŸå‹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fcntl</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> cmd, ...<span class="comment">/*struct flock *flockptr */</span>)</span></span>;  <span class="comment">// è¿”å›å€¼ï¼šè‹¥æˆåŠŸï¼Œä¾èµ–äºcmd,å¦åˆ™ï¼Œè¿”å›-1</span></span><br></pre></td></tr></table></figure><p>ã€€ã€€å¯¹äºè®°å½•é”ï¼Œcmdæ˜¯F_GETLK,F_SETLKæˆ–F_SETLKWã€‚ç¬¬ä¸‰ä¸ªå‚æ•°ï¼ˆæˆ‘ä»¬å°†è°ƒç”¨flockptrï¼‰æ˜¯ä¸€ä¸ªæŒ‡å‘flockç»“æ„çš„æŒ‡é’ˆã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">flock</span>&#123;</span></span><br><span class="line">    <span class="keyword">short</span> l_type;           <span class="comment">/* F_RDLCK, F_WRLCK, or F_UNLCK */</span></span><br><span class="line">    <span class="keyword">short</span> l_whence;         <span class="comment">/* SEEK_SET, SEEK_CUR or SEEK_END */</span></span><br><span class="line">    <span class="keyword">short</span> l_start;          <span class="comment">/* offset in bytes, relative to l_whence */</span></span><br><span class="line">    <span class="keyword">short</span> l_len;            <span class="comment">/* length, in bytes, 0 means lock to EOF */</span></span><br><span class="line">    <span class="keyword">short</span> l_pid;            <span class="comment">/* returned with F_GETLK */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>flockç»“æ„è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li>é”ç±»å‹ï¼šF_RDLCK(å…±äº«è¯»é”)ã€F_WRLCK(ç‹¬å æ€§å†™é”)æˆ–F_UNLCK(è§£é”ä¸€ä¸ªåŒºåŸŸ)</li><li>è¦åŠ é”æˆ–è§£é”åŒºåŸŸçš„èµ·å§‹å­—èŠ‚åç§»é‡(l_startå’Œl_whence)</li><li>åŒºåŸŸå­—èŠ‚é•¿åº¦(l_len)</li><li>è¿›ç¨‹ID(l_pid)æŒæœ‰çš„é”èƒ½é˜»å¡å½“å‰è¿›ç¨‹(ä»…ç”±F_GETLK)è¿”å›</li></ul><p>å…³äºé”åŒºåŸŸè¯´æ˜ï¼š</p><ul><li>åŒºåŸŸèµ·å§‹åç§»é‡çš„ä¸¤ä¸ªå…ƒç´ ä¸lseekå‡½æ•°ä¸­æœ€åçš„ä¸¤ä¸ªå‚æ•°ç±»ä¼¼ã€‚l_whenceå¯é€‰çš„å€¼æ˜¯SEEK_SETã€SEEK_CURå’ŒSEEK_ENDã€‚</li><li>é”å¯ä»¥åœ¨æ–‡ä»¶å°¾ç«¯å¤„å¼€å§‹æˆ–è¶Šè¿‡å°¾ç«¯å¤„å¼€å§‹ï¼Œä½†ä¸èƒ½åœ¨æ–‡ç« èµ·å§‹ä½ç½®ä¹‹å‰å¼€å§‹ã€‚</li><li>å¦‚l_len=0ï¼Œåˆ™è¡¨ç¤ºé”çš„èŒƒå›´å¯ä»¥æ‰©å±•åˆ°æœ€å¤§å¯èƒ½çš„åç§»é‡ã€‚è¿™æ„å‘³ç€ä¸ç®¡å‘è¯¥æ–‡ä»¶è¿½åŠ å¤šå°‘æ•°æ®ã€‚å®ƒä»¬éƒ½å¯ä»¥å¤„äºé”çš„èŒƒå›´å†…ã€‚</li><li>ä¸ºäº†å¯¹æ•´ä¸ªæ–‡ä»¶åŠ é”ï¼Œæˆ‘ä»¬è®¾ç½®l_startå’Œl_whenceæŒ‡å‘æ–‡ä»¶çš„èµ·å§‹ä½ç½®ï¼Œå¹¶æŒ‡å®šl_len=0ã€‚ï¼ˆå¸¸ç”¨çš„æŒ‡å®šæ–‡ä»¶èµ·å§‹ä½ç½®ï¼Œl_start=0,l_whenceä¸ºSEEK_SETï¼‰ã€‚</li></ul><p>ä¸¤ç§é”ç±»å‹ï¼šå…±äº«è¯»é”ï¼ˆL_RDLCKï¼‰å’Œç‹¬å æ€§å†™é”ï¼ˆL_WRLCKï¼‰ã€‚<br>ä¸åŒè¿›ç¨‹ä¸‹ï¼Œä¸åŒç±»å‹é”å½¼æ­¤ä¹‹é—´çš„å…¼å®¹æ€§ï¼š</p><div align="center"><p><img src="/img/note_0d/01.png" alt="ä¸åŒç±»å‹é”æ‰¹æ¬¡ä¹‹é—´çš„å…¼å®¹æ€§"></p></div><p></p><p>ã€€ã€€å…±äº«è¯»é”å’Œç‹¬å æ€§å†™é”çš„åŸåˆ™ï¼šå¤šä¸ªè¿›ç¨‹ï¼Œå¦‚æœåœ¨ä¸€ä¸ªç»™å®šå­—èŠ‚ä¸Šæœ‰ä¸€ä¸ªæˆ–å¤šä¸ªè¯»é”æ—¶ï¼Œåˆ™ä¸èƒ½åœ¨è¯¥å­—èŠ‚ä¸ŠåŠ å†™é”ï¼›å¦‚æœåœ¨ä¸€ä¸ªå­—èŠ‚ä¸Šå·²ç»æœ‰ä¸€æŠŠç‹¬å æ€§å†™é”ï¼Œåˆ™ä¸èƒ½å†å¯¹å®ƒåŠ ä»»æ„è¯»é”ã€‚<br>ã€€ã€€ä»¥ä¸Šæƒ…å†µåªé’ˆå¯¹äºå¤šä¸ªè¿›ç¨‹ã€‚å¦‚æœä¸€ä¸ªè¿›ç¨‹ä¸­å¯¹ä¸€ä¸ªæ–‡ä»¶åŒºåŸŸæœ‰ä¸€æŠŠé”ï¼Œåæ¥è¿›ç¨‹åˆä¼å›¾åœ¨åŒä¸€æ–‡ä»¶å†åŠ ä¸€æŠŠé”ï¼Œé‚£ä¹ˆæ–°é”å°†<code>æ›¿æ¢</code>å·²æœ‰é”ã€‚<br>ã€€ã€€åŠ è¯»é”æ—¶ï¼Œè¯¥æè¿°ç¬¦å¿…é¡»æ˜¯è¯»æ‰“å¼€ã€‚åŠ é”æ—¶ï¼Œè¯¥æè¿°ç¬¦å¿…é¡»æ˜¯å†™æ‰“å¼€ã€‚</p><p>fcntlçš„3ä¸ªå‘½ä»¤ï¼š</p><ul><li>F_GETLK: æ˜¯å¦å­˜åœ¨ä¸€æŠŠé”ã€‚å¦‚å­˜åœ¨ï¼Œåˆ™å°†ç°æœ‰é”ä¿¡æ¯é‡å†™flockptræŒ‡å‘çš„ä¿¡æ¯ã€‚å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™é™¤äº†l_typeè®¾ç½®ä¸ºF_UNLCKä¹‹å¤–ï¼Œå…¶ä»–ä¿¡æ¯ä¿å­˜ä¸å˜ã€‚</li><li>F_SETLK: è®¾ç½®ç”±flockptræ‰€æè¿°çš„é”ã€‚è·å–ä¸€æŠŠè¯»é”ï¼ˆl_type=F_RDLCKï¼‰æˆ–è€…å†™é”ï¼ˆl_type=F_WRLCKï¼‰ã€‚è€Œå…¼å®¹æ€§è§„åˆ™ï¼Œé˜»æ­¢ç³»ç»Ÿç»™å‡ºè¿™æŠŠé”ï¼Œé‚£ä¹ˆfcntlå°±ä¼šç«‹å³å‡ºé”™è¿”å›ã€‚æ­¤æ—¶errnoè®¾ç½®ä¸ºEACCESå’ŒEAGAINï¼ˆä¸€èˆ¬ä¸èƒ½æ»¡è¶³ï¼Œéƒ½è¿”å›è¯¥å€¼ï¼‰ã€‚æ­¤å‘½ä»¤ä¹Ÿå¯ç”¨äºæ¸…é™¤ç”±flockptræŒ‡å®šé”ï¼ˆl_type=F_UNLCKï¼‰ã€‚</li><li>F_SETLKW: æ˜¯F_SETLKçš„é˜»å¡ç‰ˆæœ¬ï¼Œï¼ˆW=waitï¼‰ã€‚æ‰€ä»¥åœ¨è¯·æ±‚çš„è¯»é”æˆ–å†™é”å› å¦ä¸€ä¸ªè¿›ç¨‹å½“å‰å·²ç»å¯¹è¯·æ±‚åŒºåŸŸçš„æŸä¸ªéƒ¨åˆ†è¿›è¡ŒåŠ é”è€Œä¸èƒ½æˆäºˆï¼Œé‚£ä¹ˆè°ƒç”¨å°±ä¼šè¢«ç½®ä¸ºä¼‘çœ ã€‚å¦‚æœè¯·æ±‚åˆ›å»ºçš„é”å·²ç»å¯ç”¨ï¼Œæˆ–è€…ä¼‘çœ ç”±ä¿¡å·ä¸­æ–­ï¼Œåˆ™è¯¥è¿›ç¨‹è¢«å”¤é†’ã€‚</li></ul><p><strong>demo:</strong><br>é€šç”¨å¤´éƒ¨ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é€šç”¨code</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lock_reg</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> cmd, <span class="keyword">int</span> type, <span class="keyword">off_t</span> offset, <span class="keyword">int</span> whence, <span class="keyword">off_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">flock</span> <span class="title">lock</span>;</span></span><br><span class="line"></span><br><span class="line">    lock.l_type = type;</span><br><span class="line">    lock.l_start = offset;</span><br><span class="line">    lock.l_whence = whence;</span><br><span class="line">    lock.l_len = len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (fcntl(fd, cmd, &amp;lock));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> read_lock(fd, offset, whence, len) \</span></span><br><span class="line">            lock_reg((fd), F_SETLK, F_RDLCK, (offset), (whence), (len))</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> readw_lock(fd, offset, whence, len) \</span></span><br><span class="line">            lock_reg((fd), F_SETLKW, F_RDLCK, (offset), (whence), (len))</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> write_lock(fd, offset, whence, len) \</span></span><br><span class="line">            lock_reg((fd), F_SETLK, F_WRLCK, (offset), (whence), (len))</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> writew_lock(fd, offset, whence, len) \</span></span><br><span class="line">            lock_reg((fd), F_SETLKW, F_WRLCK, (offset), (whence), (len))</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> un_lock(fd, offset, whence, len) \</span></span><br><span class="line">            lock_reg((fd), F_SETLK, F_UNLCK, (offset), (whence), (len))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">getRandomString</span><span class="params">(<span class="keyword">int</span> length)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> j, i;</span><br><span class="line">    <span class="keyword">char</span>* <span class="built_in">string</span>;</span><br><span class="line">    <span class="keyword">char</span> tmp[<span class="number">4</span>]=<span class="string">"Aa0"</span>;</span><br><span class="line">    srand((<span class="keyword">unsigned</span>) time(<span class="literal">NULL</span> ));</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">string</span> = (<span class="keyword">char</span>*) <span class="built_in">malloc</span>( <span class="keyword">sizeof</span>(<span class="keyword">char</span>)*length)) == <span class="literal">NULL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%d,malloc error\n"</span>,__LINE__);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">" "</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; length - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        j = rand() % <span class="number">3</span>;</span><br><span class="line">        <span class="built_in">string</span>[i] = tmp[j] + rand()%<span class="number">10</span>;</span><br><span class="line">        <span class="keyword">if</span> (j!=<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="built_in">string</span>[i] += rand()%<span class="number">16</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">string</span>[length - <span class="number">1</span>] = <span class="string">'\0'</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d,write_buf:  %s\n"</span>,__LINE__, <span class="built_in">string</span> );</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†™æ–‡ä»¶ a.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// a.c  å†™æ–‡ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        srand(time(<span class="number">0</span>));</span><br><span class="line">        sleep(<span class="number">10</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"start\n"</span>);</span><br><span class="line">        fd = open(<span class="string">"./a.txt"</span>, O_WRONLY | O_CREAT | O_TRUNC, S_IWUSR | S_IRUSR | S_IWGRP| S_IRUSR | S_IWOTH | S_IROTH);</span><br><span class="line">        <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (write_lock(fd, <span class="number">0</span>, SEEK_SET, <span class="number">0</span>))&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d,%d,%s\n"</span>,__LINE__,errno,(<span class="keyword">char</span> *)strerror(errno));</span><br><span class="line">                close(fd);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            len = rand()%<span class="number">200</span> + <span class="number">50</span>;</span><br><span class="line">            <span class="keyword">if</span> (len == write(fd, getRandomString(len), len)) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d,write success\n"</span>, __LINE__);</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d,write fail\n"</span>, __LINE__);</span><br><span class="line">            &#125;</span><br><span class="line">            close(fd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯»æ–‡ä»¶ b.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// b.c è¯»æ–‡ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">256</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"start\n"</span>);</span><br><span class="line">        fd = open(<span class="string">"./a.txt"</span>, O_RDONLY);</span><br><span class="line">        <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (read_lock(fd, <span class="number">0</span>, SEEK_SET, <span class="number">0</span>))&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d,%d,%s\n"</span>,__LINE__,errno,(<span class="keyword">char</span> *)strerror(errno));</span><br><span class="line">                close(fd);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            len = read(fd, buf, <span class="number">256</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">-1</span> == len)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d,read failed\n"</span>, __LINE__);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d,read success\n"</span>,__LINE__);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"%d,%s\n\n"</span>,__LINE__, buf);</span><br><span class="line">            &#125;</span><br><span class="line">            close(fd);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ–‡ä»¶æè¿°ç¬¦"><a href="#æ–‡ä»¶æè¿°ç¬¦" class="headerlink" title="æ–‡ä»¶æè¿°ç¬¦"></a><strong>æ–‡ä»¶æè¿°ç¬¦</strong></h2><p><strong>open å‡½æ•°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‡½æ•°å¤´æ–‡ä»¶</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡½æ•°åŸå‹</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags)</span></span>;                  <span class="comment">/* æ‰“å¼€ç°æœ‰æ–‡ä»¶ */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">open</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *pathname, <span class="keyword">int</span> flags, <span class="keyword">mode_t</span> mode)</span></span>;     <span class="comment">/* æ‰“å¼€çš„æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™å…ˆåˆ›å»ºå®ƒ */</span></span><br></pre></td></tr></table></figure><p>è¿”å›-1,åˆ™å‡ºé”™ã€‚æˆåŠŸï¼Œåˆ™è¿”å›æ–‡ä»¶æè¿°ç¬¦</p><p>å‚æ•°è¯´æ˜ï¼š</p><table><thead><tr><th align="left">flags</th><th align="left">å«ä¹‰</th></tr></thead><tbody><tr><td align="left">O_RDONLY</td><td align="left">ä»¥åªè¯»æ–¹å¼æ‰“å¼€æ–‡ä»¶</td></tr><tr><td align="left">O_WRONLY</td><td align="left">ä»¥åªå†™æ–¹å¼æ‰“å¼€æ–‡ä»¶</td></tr><tr><td align="left">O_RDWR</td><td align="left">ä»¥è¯»å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶</td></tr><tr><td align="left">O_CREAT</td><td align="left">è‹¥æ‰€æ‰“å¼€æ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºæ­¤æ–‡ä»¶ã€‚ä½¿ç”¨æ­¤é€‰é¡¹æ—¶ï¼Œéœ€åŒæ—¶ä½¿ç”¨ç¬¬ä¸‰ä¸ªå‚æ•°modeè¯´æ˜è¯¥æ–°æ–‡ä»¶çš„å­˜å–è®¸å¯æƒä½ã€‚</td></tr><tr><td align="left">O_EXCL</td><td align="left">å¦‚æœåŒæ—¶æŒ‡å®šäº†O_CREATE,è€Œæ–‡ä»¶å·²ç»å­˜åœ¨ï¼Œåˆ™å¯¼è‡´è°ƒç”¨å‡ºé”™</td></tr><tr><td align="left">O_TRUNC</td><td align="left">å¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œè€Œä¸”ä¸ºåªè¯»æˆ–åªå†™æ–¹å¼æ‰“å¼€ï¼Œåˆ™å°†å…¶é•¿åº¦æˆªçŸ­ä¸º0</td></tr><tr><td align="left">O_NOCTTY</td><td align="left">å¦‚æœpathnameæŒ‡å®šçš„æ˜¯ç»ˆç«¯è®¾å¤‡(tty)ï¼Œåˆ™ä¸å°†æ­¤è®¾å¤‡åˆ†é…ä½œä¸ºè¿›ç¨‹çš„æ§åˆ¶ç»ˆç«¯</td></tr><tr><td align="left">O_APPEND</td><td align="left">æ¯æ¬¡å†™æ—¶éƒ½åŠ åˆ°æ–‡ä»¶çš„å°¾ç«¯</td></tr><tr><td align="left">O_NONBLOCK</td><td align="left">å¦‚æœpathnameæŒ‡å®šçš„æ˜¯ä¸€ä¸ªFIFOã€ä¸€ä¸ªå—ç‰¹æ®Šæ–‡ä»¶æˆ–ä¸€ä¸ªå­—ç¬¦ç‰¹æ®Šæ–‡ä»¶ï¼Œåˆ™æ­¤é€‰æ‹©é¡¹ä¸ºæ­¤æ–‡ä»¶çš„æœ¬æ¬¡æ‰“å¼€æ“ä½œå’Œåç»­çš„I/Oæ“ä½œè®¾å¤‡ä¸ºéé˜»å¡æ–¹å¼</td></tr><tr><td align="left">O_NONELAY</td><td align="left">O_NONBLOCK</td></tr><tr><td align="left">O_SYNC</td><td align="left">åªåœ¨æ•°æ®è¢«å†™å…¥å¤–å­˜æˆ–å…¶ä»–è®¾å¤‡ä¹‹åæ“ä½œæ‰è¿”å›</td></tr></tbody></table><table><thead><tr><th align="left">modeå–å€¼</th><th align="left">å¯¹åº”å…«è¿›åˆ¶æ•°</th><th align="left">å«ä¹‰</th></tr></thead><tbody><tr><td align="left">S_SVTX</td><td align="left">01000</td><td align="left">ç²˜è´´ä½</td></tr><tr><td align="left">S_IRUSR</td><td align="left">00400</td><td align="left">æ–‡ä»¶æ‰€æœ‰è€…çš„è¯»æƒé™ä½</td></tr><tr><td align="left">S_IWUSR</td><td align="left">00200</td><td align="left">æ–‡ä»¶æ‰€æœ‰è€…çš„å†™æƒé™ä½</td></tr><tr><td align="left">S_IXUSR</td><td align="left">00100</td><td align="left">æ–‡ä»¶æ‰€æœ‰è€…çš„æ‰§è¡Œæƒé™ä½</td></tr><tr><td align="left">S_IRGRP</td><td align="left">00040</td><td align="left">æ‰€æœ‰è€…åŒç»„ç”¨æˆ·çš„è¯»æƒé™ä½</td></tr><tr><td align="left">S_IWGRP</td><td align="left">00020</td><td align="left">æ‰€æœ‰è€…åŒç»„ç”¨æˆ·çš„å†™æƒé™ä½</td></tr><tr><td align="left">S_IXGRP</td><td align="left">00010</td><td align="left">æ‰€æœ‰è€…åŒç»„ç”¨æˆ·çš„æ‰§è¡Œæƒé™ä½</td></tr><tr><td align="left">S_IROTH</td><td align="left">00004</td><td align="left">å…¶ä»–ç»„ç”¨æˆ·çš„è¯»æƒé™ä½</td></tr><tr><td align="left">S_IWOTH</td><td align="left">00002</td><td align="left">å…¶ä»–ç»„ç”¨æˆ·çš„å†™æƒé™ä½</td></tr><tr><td align="left">S_IXOTH</td><td align="left">00001</td><td align="left">å…¶ä»–ç»„ç”¨æˆ·çš„æ‰§è¡Œæƒé™ä½</td></tr></tbody></table><h2 id="æ–‡ä»¶æµ"><a href="#æ–‡ä»¶æµ" class="headerlink" title="æ–‡ä»¶æµ"></a><strong>æ–‡ä»¶æµ</strong></h2><p><strong>fopen å‡½æ•°</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¤´æ–‡ä»¶</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//å‡½æ•°åŸå‹</span></span><br><span class="line"><span class="function">FILE *<span class="title">fopen</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode)</span></span>;</span><br></pre></td></tr></table></figure><p>è¿”å›å€¼ï¼šå¤±è´¥è¿”å›NULL</p><table><thead><tr><th align="left">modeå–å€¼</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left">r</td><td align="left">ä»¥åªè¯»æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¿…é¡»å­˜åœ¨ã€‚</td></tr><tr><td align="left">r+</td><td align="left">ä»¥è¯»/å†™æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¿…é¡»å­˜åœ¨ã€‚</td></tr><tr><td align="left">rb+</td><td align="left">ä»¥è¯»/å†™æ–¹å¼æ‰“å¼€ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåªå…è®¸è¯»/å†™æ•°æ®ã€‚</td></tr><tr><td align="left">rt+</td><td align="left">ä»¥è¯»/å†™æ–¹å¼æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…è®¸è¯»å’Œå†™ã€‚</td></tr><tr><td align="left">w</td><td align="left">æ‰“å¼€åªå†™æ–‡ä»¶ï¼Œè‹¥æ–‡ä»¶å­˜åœ¨åˆ™é•¿åº¦æ¸…ä¸º 0ï¼Œå³è¯¥æ–‡ä»¶å†…å®¹æ¶ˆå¤±ï¼Œè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºè¯¥æ–‡ä»¶ã€‚</td></tr><tr><td align="left">w+</td><td align="left">æ‰“å¼€å¯è¯»/å†™æ–‡ä»¶ï¼Œè‹¥æ–‡ä»¶å­˜åœ¨åˆ™æ–‡ä»¶é•¿åº¦æ¸…ä¸ºé›¶ï¼Œå³è¯¥æ–‡ä»¶å†…å®¹ä¼šæ¶ˆå¤±ã€‚è‹¥æ–‡ä»¶ä¸å­˜åœ¨åˆ™å»ºç«‹è¯¥æ–‡ä»¶ã€‚</td></tr><tr><td align="left">a</td><td align="left">ä»¥é™„åŠ çš„æ–¹å¼æ‰“å¼€åªå†™æ–‡ä»¶ã€‚è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šå»ºç«‹è¯¥æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œå†™å…¥çš„æ•°æ®ä¼šè¢«åŠ åˆ°æ–‡ä»¶å°¾ï¼Œå³æ–‡ä»¶åŸå…ˆçš„å†…å®¹ä¼šè¢«ä¿ç•™ï¼ˆEOF ç¬¦ä¿ç•™ï¼‰ã€‚</td></tr><tr><td align="left">a+</td><td align="left">ä»¥é™„åŠ æ–¹å¼æ‰“å¼€å¯è¯»/å†™çš„æ–‡ä»¶ã€‚è‹¥æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™ä¼šå»ºç«‹è¯¥æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨ï¼Œåˆ™å†™å…¥çš„æ•°æ®ä¼šè¢«åŠ åˆ°æ–‡ä»¶å°¾åï¼Œå³æ–‡ä»¶åŸå…ˆçš„å†…å®¹ä¼šè¢«ä¿ç•™ï¼ˆåŸæ¥çš„ EOF ç¬¦ä¸ä¿ç•™ï¼‰ã€‚</td></tr><tr><td align="left">wb</td><td align="left">ä»¥åªå†™æ–¹å¼æ‰“å¼€æˆ–æ–°å»ºä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œåªå…è®¸å†™æ•°æ®ã€‚</td></tr><tr><td align="left">wb+</td><td align="left">ä»¥è¯»/å†™æ–¹å¼æ‰“å¼€æˆ–å»ºç«‹ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…è®¸è¯»å’Œå†™ã€‚</td></tr><tr><td align="left">wt+</td><td align="left">ä»¥è¯»/å†™æ–¹å¼æ‰“å¼€æˆ–å»ºç«‹ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…è®¸è¯»å†™ã€‚</td></tr><tr><td align="left">at+</td><td align="left">ä»¥è¯»/å†™æ–¹å¼æ‰“å¼€ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œå…è®¸è¯»æˆ–åœ¨æ–‡æœ¬æœ«è¿½åŠ æ•°æ®ã€‚</td></tr><tr><td align="left">ab+</td><td align="left">ä»¥è¯»/å†™æ–¹å¼æ‰“å¼€ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå…è®¸è¯»æˆ–åœ¨æ–‡ä»¶æœ«è¿½åŠ æ•°æ®ã€‚</td></tr></tbody></table><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//è·å–æŸä¸ªæ–‡ä»¶æµçš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="keyword">int</span> i_fp = <span class="number">-1</span>;</span><br><span class="line">FILE *fp = fopen(<span class="string">"/tmp/test.txt"</span>,<span class="string">"r+"</span>);</span><br><span class="line">i_fp = fileno(fp);</span><br><span class="line">fclose(fp);</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> é” </tag>
            
            <tag> æ–‡ä»¶ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>å‰ç«¯å°å·¥å…·</title>
      <link href="/2018/07/19/%E5%89%8D%E7%AB%AF/02%E5%89%8D%E7%AB%AF%E5%B0%8F%E5%B7%A5%E5%85%B7/"/>
      <url>/2018/07/19/%E5%89%8D%E7%AB%AF/02%E5%89%8D%E7%AB%AF%E5%B0%8F%E5%B7%A5%E5%85%B7/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="æ—¶é’Ÿ-Clock-Shop"><a href="#æ—¶é’Ÿ-Clock-Shop" class="headerlink" title="æ—¶é’Ÿ(Clock Shop)"></a><strong>æ—¶é’Ÿ(<a href="https://a-jie.github.io/clock-shop/" title="ç½‘ç«™æ”¶é›†å„ç§æ—¶é’Ÿçš„ä»£ç " target="_blank" rel="noopener">Clock Shop</a>)</strong></h2><div id="clock"></div><p><code>CSS</code></p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#clock</span> &#123;</span><br><span class="line">    <span class="attribute">max-height</span>: <span class="number">900px</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#clock</span> <span class="selector-tag">canvas</span>&#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>JS</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @constructor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">var</span> Clock = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @type &#123;Clock&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> me = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> config = &#123;</span><br><span class="line">            starCount: <span class="number">500</span>,</span><br><span class="line">            showFps: <span class="literal">true</span>,</span><br><span class="line">            drawDigital: <span class="literal">true</span>,</span><br><span class="line">            star: &#123;</span><br><span class="line">                minOpacity: <span class="number">0.1</span>,</span><br><span class="line">                fade: <span class="literal">true</span>,</span><br><span class="line">                fadeSpeed: <span class="number">0.02</span>,</span><br><span class="line">                color: <span class="string">'#0a0'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            hour: &#123;</span><br><span class="line">                foreground: <span class="string">'#aaa'</span>,</span><br><span class="line">                background: <span class="string">'#000'</span>,</span><br><span class="line">                width: <span class="number">3</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            minute: &#123;</span><br><span class="line">                foreground: <span class="string">'#aaa'</span>,</span><br><span class="line">                background: <span class="string">'#000'</span>,</span><br><span class="line">                width: <span class="number">3</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            second: &#123;</span><br><span class="line">                foreground: <span class="string">'#aaa'</span>,</span><br><span class="line">                background: <span class="string">'#000'</span>,</span><br><span class="line">                width: <span class="number">3</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">            milli: &#123;</span><br><span class="line">                foreground: <span class="string">'rgba(0,0,0,0.1)'</span>,</span><br><span class="line">                background: <span class="string">'#000'</span>,</span><br><span class="line">                width: <span class="number">3</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @type &#123;Element&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> canvas = <span class="built_in">document</span>.createElement(<span class="string">'canvas'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @type &#123;CanvasRenderingContext2D&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> engine = canvas.getContext(<span class="string">'2d'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * requestor</span></span><br><span class="line"><span class="comment">         * @type &#123;*|Function&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> frame = <span class="built_in">window</span>.requestAnimationFrame || <span class="built_in">window</span>.mozRequestAnimationFrame || <span class="built_in">window</span>.webkitRequestAnimationFrame || <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">                cb</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> setTimeout(cb, <span class="number">30</span>)</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @type &#123;&#123;&#125;&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> star = [];</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * @type &#123;number&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> size = <span class="number">0.9</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @type &#123;number&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> radius = size / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @type &#123;Date&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> current = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @type &#123;&#123;refresh: number, tick: number, start: Date&#125;&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> fps = &#123;</span><br><span class="line">            val: <span class="number">0</span>,</span><br><span class="line">            refresh: <span class="number">50</span>,</span><br><span class="line">            tick: <span class="number">0</span>,</span><br><span class="line">            start: <span class="keyword">new</span> <span class="built_in">Date</span>()</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @type &#123;&#123;width: number, height: number, size: number, radius: number, middle: number&#125;&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> meta = &#123;</span><br><span class="line">            width: <span class="number">0</span>,</span><br><span class="line">            height: <span class="number">0</span>,</span><br><span class="line">            size: <span class="number">0</span>,</span><br><span class="line">            radius: <span class="number">0</span>,</span><br><span class="line">            middle: <span class="number">0</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * init</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">this</span>.run = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            generateStar();</span><br><span class="line">            <span class="built_in">document</span>.body.appendChild(canvas);</span><br><span class="line"></span><br><span class="line">            canvas.setAttribute(<span class="string">'width'</span>, <span class="built_in">window</span>.innerWidth);</span><br><span class="line">            canvas.setAttribute(<span class="string">'height'</span>, <span class="built_in">window</span>.innerHeight);</span><br><span class="line"></span><br><span class="line">            frame(tick);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * render frame</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> tick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            current = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">            solveMeta();</span><br><span class="line"></span><br><span class="line">            engine.fillStyle = <span class="string">'#000'</span>;</span><br><span class="line">            engine.clearRect(<span class="number">0</span>, <span class="number">0</span>, meta.width, meta.height);</span><br><span class="line">            engine.fillRect(<span class="number">0</span>, <span class="number">0</span>, meta.width, meta.height);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//draw part</span></span><br><span class="line">            drawFps();</span><br><span class="line">            drawStar();</span><br><span class="line"></span><br><span class="line">            drawBackgroundTime();</span><br><span class="line">            drawPattern();</span><br><span class="line">            drawForegroundTime();</span><br><span class="line"></span><br><span class="line">            drawDigital();</span><br><span class="line"></span><br><span class="line">            frame(tick);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * draw digital watch</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> drawDigital = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (config.drawDigital) &#123;</span><br><span class="line">                <span class="keyword">var</span> time = [</span><br><span class="line">                n(current.getHours()),</span><br><span class="line">                current.getSeconds() % <span class="number">2</span> ? <span class="string">':'</span> : <span class="string">' '</span>,</span><br><span class="line">                n(current.getMinutes())</span><br><span class="line">                ].join(<span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> size = <span class="number">30</span>;</span><br><span class="line">                <span class="keyword">var</span> padding = <span class="number">10</span>;</span><br><span class="line">                engine.font = size + <span class="string">'px Arial'</span>;</span><br><span class="line">                <span class="keyword">var</span> m = engine.measureText(time);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//engine.fillStyle = 'rgba(0,0,0,0.5)';</span></span><br><span class="line">                <span class="comment">//engine.fillRect(</span></span><br><span class="line">                <span class="comment">//    meta.middle.x - m.width / 2 - padding,</span></span><br><span class="line">                <span class="comment">//    meta.middle.y - size / 2 - padding,</span></span><br><span class="line">                <span class="comment">//    m.width + padding * 2,</span></span><br><span class="line">                <span class="comment">//    size + padding * 2</span></span><br><span class="line">                <span class="comment">//);</span></span><br><span class="line"></span><br><span class="line">                engine.fillStyle = <span class="string">'#fff'</span>;</span><br><span class="line">                engine.fillText(</span><br><span class="line">                    time,</span><br><span class="line">                    meta.middle.x - m.width / <span class="number">2</span>,</span><br><span class="line">                    meta.middle.y + size / <span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * @param ne</span></span><br><span class="line"><span class="comment">         * @returns &#123;*&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> n = <span class="function"><span class="keyword">function</span> (<span class="params">ne</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (ne &lt; <span class="number">10</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'0'</span> + ne;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> ne;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * draw lines for evers hour and minute</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> drawPattern = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">//#1</span></span><br><span class="line">            engine.strokeStyle = <span class="string">'rgba(255,255,255,0.2)'</span>;</span><br><span class="line">            engine.lineWidth = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">            engine.beginPath();</span><br><span class="line">            engine.arc(meta.middle.x, meta.middle.y, meta.radius * <span class="number">0.8</span> - meta.radius / <span class="number">12</span>, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</span><br><span class="line">            engine.stroke();</span><br><span class="line">            engine.closePath();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//#1.5</span></span><br><span class="line">            engine.strokeStyle = <span class="string">'rgba(255,255,255,0.2)'</span>;</span><br><span class="line">            engine.beginPath();</span><br><span class="line">            engine.arc(meta.middle.x, meta.middle.y, meta.radius * <span class="number">0.8</span> + meta.radius / <span class="number">12</span>, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</span><br><span class="line">            engine.stroke();</span><br><span class="line">            engine.closePath();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//#2</span></span><br><span class="line">            engine.strokeStyle = <span class="string">'rgba(0,0,0,0.5)'</span>;</span><br><span class="line">            engine.lineWidth = meta.radius / <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">            engine.beginPath();</span><br><span class="line">            engine.arc(meta.middle.x, meta.middle.y, meta.radius * <span class="number">0.8</span>, <span class="number">0</span>, <span class="built_in">Math</span>.PI * <span class="number">2</span>);</span><br><span class="line">            engine.stroke();</span><br><span class="line">            engine.closePath();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> angleWidth = <span class="built_in">Math</span>.PI * <span class="number">2</span> / <span class="number">60</span>;</span><br><span class="line">            <span class="keyword">var</span> seconds = current.getSeconds() + current.getMilliseconds() / <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">60</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> angleMid = i * angleWidth - <span class="number">0.5</span> * <span class="built_in">Math</span>.PI;</span><br><span class="line">                <span class="keyword">var</span> startAngle = angleMid - <span class="built_in">Math</span>.PI / <span class="number">500</span>;</span><br><span class="line">                <span class="keyword">var</span> endAngle = angleMid + <span class="built_in">Math</span>.PI / <span class="number">500</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//var opa = (60 - seconds + i - 1) % 60;</span></span><br><span class="line">                <span class="comment">//</span></span><br><span class="line">                <span class="comment">//engine.strokeStyle = 'rgba(' + [255, 255, 255, opa / 60].join(',') + ')';</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (i === <span class="built_in">parseInt</span>(seconds)) &#123;</span><br><span class="line">                    engine.strokeStyle = <span class="string">'#0a0'</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">var</span> opa = <span class="number">1</span> - <span class="built_in">Math</span>.min(</span><br><span class="line">                        <span class="built_in">Math</span>.abs(i - <span class="number">60</span> - seconds),</span><br><span class="line">                        <span class="built_in">Math</span>.abs(i - seconds),</span><br><span class="line">                        <span class="built_in">Math</span>.abs(i + <span class="number">60</span> - seconds)) / <span class="number">15</span>;</span><br><span class="line"></span><br><span class="line">                    engine.strokeStyle = <span class="string">'rgba('</span> + [<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, opa].join(<span class="string">','</span>) + <span class="string">')'</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                engine.lineWidth = meta.radius / <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">                engine.beginPath();</span><br><span class="line">                engine.arc(meta.middle.x, meta.middle.y, meta.radius * <span class="number">0.8</span>, startAngle, endAngle);</span><br><span class="line">                engine.stroke();</span><br><span class="line">                engine.closePath();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            angleWidth = <span class="built_in">Math</span>.PI * <span class="number">2</span> / <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">12</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> angleMid = i * angleWidth - <span class="number">0.5</span> * <span class="built_in">Math</span>.PI;</span><br><span class="line">                <span class="keyword">var</span> startAngle = angleMid - <span class="built_in">Math</span>.PI / <span class="number">200</span>;</span><br><span class="line">                <span class="keyword">var</span> endAngle = angleMid + <span class="built_in">Math</span>.PI / <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">                engine.strokeStyle = <span class="string">'rgba(255,255,255,0.6)'</span>;</span><br><span class="line">                engine.lineWidth = meta.radius / <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">                engine.beginPath();</span><br><span class="line">                engine.arc(meta.middle.x, meta.middle.y, meta.radius * <span class="number">0.75</span>, startAngle, endAngle);</span><br><span class="line">                engine.stroke();</span><br><span class="line">                engine.closePath();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * draw background clock</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> drawBackgroundTime = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            drawBackgroundTimePart(meta.radius / <span class="number">3</span> + <span class="number">20</span>, current.getHours() + current.getMinutes() / <span class="number">60</span>, <span class="number">12</span>, config.hour);</span><br><span class="line">            drawBackgroundTimePart(meta.radius * <span class="number">0.65</span> + <span class="number">20</span>, current.getMinutes() + current.getSeconds() / <span class="number">60</span>, <span class="number">60</span>,</span><br><span class="line">                config.minute);</span><br><span class="line">            drawBackgroundTimePart(meta.radius + <span class="number">20</span>, current.getSeconds() + current.getMilliseconds() / <span class="number">1000</span>, <span class="number">60</span>,</span><br><span class="line">                config.second);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * draw foreground clock</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> drawForegroundTime = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            drawTimePart(meta.radius / <span class="number">3</span>, current.getHours() + current.getMinutes() / <span class="number">60</span>, <span class="number">12</span>, config.hour);</span><br><span class="line">            drawTimePart(meta.radius * <span class="number">0.65</span>, current.getMinutes() + current.getSeconds() / <span class="number">60</span>, <span class="number">60</span>, config.minute);</span><br><span class="line">            drawTimePart(meta.radius, current.getSeconds() + current.getMilliseconds() / <span class="number">1000</span>, <span class="number">60</span>, config.second);</span><br><span class="line"></span><br><span class="line">            drawTimePart(meta.radius / <span class="number">15</span>, current.getMilliseconds(), <span class="number">1000</span>, config.milli, <span class="literal">true</span>);</span><br><span class="line">            drawTimePart(meta.radius / <span class="number">15</span>, current.getMilliseconds() + <span class="number">250</span>, <span class="number">1000</span>, config.milli, <span class="literal">true</span>);</span><br><span class="line">            drawTimePart(meta.radius / <span class="number">15</span>, current.getMilliseconds() + <span class="number">500</span>, <span class="number">1000</span>, config.milli, <span class="literal">true</span>);</span><br><span class="line">            drawTimePart(meta.radius / <span class="number">15</span>, current.getMilliseconds() + <span class="number">750</span>, <span class="number">1000</span>, config.milli, <span class="literal">true</span>);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * draw bg time part</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * @param &#123;number&#125; radius</span></span><br><span class="line"><span class="comment">         * @param &#123;number&#125; time</span></span><br><span class="line"><span class="comment">         * @param &#123;number&#125; maxTime</span></span><br><span class="line"><span class="comment">         * @param &#123;&#123;&#125;&#125; config</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> drawBackgroundTimePart = <span class="function"><span class="keyword">function</span> (<span class="params">radius, time, maxTime, config</span>) </span>&#123;</span><br><span class="line">            engine.globalAlpha = <span class="number">0.5</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> angleWidth = <span class="built_in">Math</span>.PI * <span class="number">2</span> / maxTime;</span><br><span class="line">            <span class="keyword">var</span> angleMid = time * angleWidth - <span class="number">0.5</span> * <span class="built_in">Math</span>.PI;</span><br><span class="line">            <span class="keyword">var</span> startAngle = angleMid - <span class="built_in">Math</span>.PI / <span class="number">1.5</span>;</span><br><span class="line">            <span class="keyword">var</span> endAngle = angleMid + <span class="built_in">Math</span>.PI / <span class="number">1.5</span>;</span><br><span class="line"></span><br><span class="line">            engine.fillStyle = config.background;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//### 1</span></span><br><span class="line">            <span class="keyword">var</span> grd = engine.createRadialGradient(meta.middle.x, meta.middle.y, radius / <span class="number">2</span>, meta.middle.x, meta.middle.y,</span><br><span class="line">                radius);</span><br><span class="line">            grd.addColorStop(<span class="number">0</span>, <span class="string">'rgba(0,0,0,0)'</span>);</span><br><span class="line">            grd.addColorStop(<span class="number">1</span>, config.background);</span><br><span class="line">            engine.fillStyle = grd;</span><br><span class="line"></span><br><span class="line">            engine.beginPath();</span><br><span class="line">            engine.moveTo(meta.middle.x, meta.middle.y);</span><br><span class="line">            engine.arc(meta.middle.x, meta.middle.y, radius, startAngle, endAngle);</span><br><span class="line">            engine.fill();</span><br><span class="line">            engine.closePath();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//### 2</span></span><br><span class="line">            grd = engine.createRadialGradient(meta.middle.x, meta.middle.y, radius / <span class="number">2</span>, meta.middle.x, meta.middle.y,</span><br><span class="line">                radius);</span><br><span class="line">            grd.addColorStop(<span class="number">0</span>, <span class="string">'rgba(0,0,0,0)'</span>);</span><br><span class="line">            grd.addColorStop(<span class="number">1</span>, <span class="string">'rgba(0,200,0,0.5)'</span>);</span><br><span class="line">            engine.fillStyle = grd;</span><br><span class="line"></span><br><span class="line">            engine.beginPath();</span><br><span class="line">            engine.moveTo(meta.middle.x, meta.middle.y);</span><br><span class="line">            engine.arc(meta.middle.x, meta.middle.y, radius, startAngle + <span class="built_in">Math</span>.PI / <span class="number">2</span>, endAngle - <span class="built_in">Math</span>.PI / <span class="number">2</span>);</span><br><span class="line">            engine.fill();</span><br><span class="line">            engine.closePath();</span><br><span class="line"></span><br><span class="line">            engine.globalAlpha = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * draw time part</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * @param &#123;number&#125; radius</span></span><br><span class="line"><span class="comment">         * @param &#123;number&#125; time</span></span><br><span class="line"><span class="comment">         * @param &#123;number&#125; maxTime</span></span><br><span class="line"><span class="comment">         * @param &#123;&#123;&#125;&#125; config</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> drawTimePart = <span class="function"><span class="keyword">function</span> (<span class="params">radius, time, maxTime, config, anti</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> angleWidth = <span class="built_in">Math</span>.PI * <span class="number">2</span> / maxTime;</span><br><span class="line">            <span class="keyword">var</span> angleMid = time * angleWidth - <span class="number">0.5</span> * <span class="built_in">Math</span>.PI;</span><br><span class="line">            <span class="keyword">var</span> length = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (anti) &#123;</span><br><span class="line">                angleMid = <span class="number">0</span> - angleMid;</span><br><span class="line">                length = <span class="number">8</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> startAngle = angleMid - <span class="built_in">Math</span>.PI / length;</span><br><span class="line">            <span class="keyword">var</span> endAngle = angleMid + <span class="built_in">Math</span>.PI / length;</span><br><span class="line"></span><br><span class="line">            engine.strokeStyle = config.foreground;</span><br><span class="line">            engine.lineWidth = config.width;</span><br><span class="line"></span><br><span class="line">            engine.beginPath();</span><br><span class="line">            engine.arc(meta.middle.x, meta.middle.y, radius - config.width, startAngle, endAngle);</span><br><span class="line">            engine.stroke();</span><br><span class="line">            engine.closePath();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!anti) &#123;</span><br><span class="line">                engine.strokeStyle = <span class="string">'#fff'</span>;</span><br><span class="line">                engine.lineWidth = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">                engine.beginPath();</span><br><span class="line">                engine.arc(meta.middle.x, meta.middle.y, radius, angleMid - <span class="number">0.01</span>, angleMid + <span class="number">0.01</span>);</span><br><span class="line">                engine.stroke();</span><br><span class="line">                engine.closePath();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * solve and render fps</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> drawFps = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (config.showFps) &#123;</span><br><span class="line">                fps.tick--;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (fps.tick &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">var</span> diffTime = (<span class="keyword">new</span> <span class="built_in">Date</span>() - fps.start) / <span class="number">1000</span>;</span><br><span class="line">                    fps.val = <span class="built_in">parseInt</span>(fps.refresh / diffTime * <span class="number">10</span>) / <span class="number">10</span>;</span><br><span class="line">                    fps.start = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">                    fps.tick = fps.refresh;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                engine.font = <span class="string">'10px Arial'</span>;</span><br><span class="line">                engine.fillStyle = <span class="string">'#fff'</span>;</span><br><span class="line">                engine.fillText(fps.val + <span class="string">' fps | '</span> + [</span><br><span class="line">                n(current.getHours()),</span><br><span class="line">                current.getSeconds() % <span class="number">2</span> ? <span class="string">':'</span> : <span class="string">' '</span>,</span><br><span class="line">                n(current.getMinutes()),</span><br><span class="line">                current.getSeconds() % <span class="number">2</span> ? <span class="string">':'</span> : <span class="string">' '</span>,</span><br><span class="line">                n(current.getSeconds())</span><br><span class="line">                ].join(<span class="string">''</span>), <span class="number">5</span>, meta.height - <span class="number">5</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * generate Star line setup</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> generateStar = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; config.starCount; i++) &#123;</span><br><span class="line">                star.push(&#123;</span><br><span class="line">                    width: <span class="built_in">Math</span>.random(),</span><br><span class="line">                    deg: <span class="built_in">Math</span>.random() * <span class="number">360</span>,</span><br><span class="line">                    color: <span class="built_in">Math</span>.random(),</span><br><span class="line">                    colorDir: <span class="built_in">Math</span>.random() &lt; <span class="number">0.5</span> ? config.star.fadeSpeed : -config.star.fadeSpeed</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * height of canvas</span></span><br><span class="line"><span class="comment">         * @returns &#123;string&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> width = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> canvas.getAttribute(<span class="string">'width'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * height of canvas</span></span><br><span class="line"><span class="comment">         * @returns &#123;string&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> height = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> canvas.getAttribute(<span class="string">'height'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * get mid coords from the clock</span></span><br><span class="line"><span class="comment">         * @returns &#123;&#123;x: number, y: number&#125;&#125;</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> middle = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                x: width() / <span class="number">2</span>,</span><br><span class="line">                y: height() / <span class="number">2</span></span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * cache size properties</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> solveMeta = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            meta.width = width();</span><br><span class="line">            meta.height = height();</span><br><span class="line">            meta.radius = <span class="built_in">Math</span>.min(meta.width, meta.height) * radius;</span><br><span class="line">            meta.size = <span class="built_in">Math</span>.min(meta.width, meta.height);</span><br><span class="line">            meta.middle = middle();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * draw clock star lines</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">var</span> drawStar = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">            engine.strokeStyle = config.star.color;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; star.length; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> starLine = star[i];</span><br><span class="line">                <span class="keyword">var</span> relX = <span class="built_in">Math</span>.sin(starLine.deg / <span class="number">360</span> * <span class="built_in">Math</span>.PI * <span class="number">2</span>);</span><br><span class="line">                <span class="keyword">var</span> relY = <span class="built_in">Math</span>.cos(starLine.deg / <span class="number">360</span> * <span class="built_in">Math</span>.PI * <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">                engine.beginPath();</span><br><span class="line"></span><br><span class="line">                engine.moveTo(</span><br><span class="line">                    meta.middle.x,</span><br><span class="line">                    meta.middle.y);</span><br><span class="line"></span><br><span class="line">                engine.lineTo(</span><br><span class="line">                    meta.middle.x + relX * starLine.width * meta.radius,</span><br><span class="line">                    meta.middle.y + relY * starLine.width * meta.radius);</span><br><span class="line"></span><br><span class="line">                engine.lineWidth = <span class="built_in">parseInt</span>((<span class="number">1</span> - starLine.width) * <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (config.star.fade) &#123;</span><br><span class="line">                    engine.globalAlpha = config.star.minOpacity + (<span class="number">1</span> - config.star.minOpacity) * starLine.color;</span><br><span class="line">                    starLine.color += starLine.colorDir;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (starLine.color &gt;= <span class="number">1</span> || starLine.color &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        starLine.color = starLine.color | <span class="number">0</span>;</span><br><span class="line">                        starLine.colorDir = -starLine.colorDir;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                engine.stroke();</span><br><span class="line">                engine.closePath();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            engine.globalAlpha = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> c = <span class="keyword">new</span> Clock();</span><br><span class="line">    c.run();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> å‰ç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å‰ç«¯ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ç”µå½±æ”¶è—</title>
      <link href="/2018/07/06/%E6%9D%82%E8%AF%BB/01%E7%94%B5%E5%BD%B1/"/>
      <url>/2018/07/06/%E6%9D%82%E8%AF%BB/01%E7%94%B5%E5%BD%B1/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="åŠ¨ç”»ç‰‡"><a href="#åŠ¨ç”»ç‰‡" class="headerlink" title="åŠ¨ç”»ç‰‡"></a>åŠ¨ç”»ç‰‡</h2><div align="center"> <p><a href="./" title="10å²çš„å°‘å¥³åƒå¯»ä¸çˆ¶æ¯ä¸€èµ·ä»éƒ½å¸‚æ¬å®¶åˆ°äº†ä¹¡ä¸‹ã€‚æ²¡æƒ³åˆ°åœ¨æ¬å®¶çš„é€”ä¸­ï¼Œä¸€å®¶äººå‘ç”Ÿäº†æ„å¤–ã€‚ä»–ä»¬è¿›å…¥äº†æ±¤å±‹è€æ¿é­”å¥³æ§åˆ¶çš„å¥‡ç‰¹ä¸–ç•Œâ€”â€”åœ¨é‚£é‡Œä¸åŠ³åŠ¨çš„äººå°†ä¼šè¢«å˜æˆåŠ¨ç‰©ã€‚åƒå¯»çš„çˆ¸çˆ¸å¦ˆå¦ˆå› è´ªåƒå˜æˆäº†çŒªï¼Œåƒå¯»ä¸ºäº†æ•‘çˆ¸çˆ¸å¦ˆå¦ˆç»å†äº†å¾ˆå¤šç£¨éš¾ï¼Œåœ¨æœŸé—´å¥¹é‡è§äº†ç™½é¾™ï¼Œä¸€ä¸ªæ—¢èªæ˜åˆå†·é…·çš„å°‘å¹´ï¼Œåœ¨ç»å†äº†å¾ˆå¤šäº‹æƒ…ä¹‹åï¼Œåƒå¯»æœ€åæ•‘å‡ºäº†çˆ¸çˆ¸å¦ˆå¦ˆï¼Œæ‹¯æ•‘äº†ç™½é¾™ã€‚">ã€Šåƒä¸åƒå¯»ã€‹</a></p><p><img src="/img/zd_01/qyqx01.png" alt></p></div><p></p><div align="center">ã€Šå“ˆå°”ç§»åŠ¨çš„åŸå ¡ã€‹<iframe style="border: 0.2em solid #d3d3d3;    border-radius: 0.5em;" src="http://open.iqiyi.com/developer/player_js/coopPlayerIndex.html?vid=5d81e2948317330bdb8a26155ca2fb09&tvId=39683971609&accessToken=2.f22860a2479ad60d8da7697274de9346&appKey=3955c3425820435e86d0f4cdfe56f5e7&appId=1368&height=100%&width=100%" frameborder="0" allowfullscreen="true" width="85%" height="482"></iframe></div><div align="center">ã€Šç‹®å­ç‹ã€‹<p><img src="/img/zd_01/szw03.png" alt></p></div><p></p><div align="center">ã€Šé¾™çŒ«ã€‹<iframe style="border: 0.2em solid #d3d3d3;    border-radius: 0.5em;" src="http://open.iqiyi.com/developer/player_js/coopPlayerIndex.html?vid=313333eff3a610719dbf07a6592c09fe&tvId=730270600&accessToken=2.f22860a2479ad60d8da7697274de9346&appKey=3955c3425820435e86d0f4cdfe56f5e7&appId=1368&height=100%&width=100%" frameborder="0" allowfullscreen="true" width="85%" height="482"></iframe></div><div align="center">ã€Šæœºå™¨äººæ€»åŠ¨å‘˜ã€‹<iframe style="border: 0.2em solid #d3d3d3;    border-radius: 0.5em;" frameborder="0" src="https://v.qq.com/txp/iframe/player.html?vid=v00121f4a8u" allowfullscreen="true" width="85%" height="482"></iframe></div><div align="center">ã€Šç–¯ç‹‚åŠ¨ç‰©åŸã€‹<iframe style="border: 0.2em solid #d3d3d3;    border-radius: 0.5em;" frameborder="0" src="https://v.qq.com/txp/iframe/player.html?vid=l0020h13orj" allowfullscreen="true" width="85%" height="482"></iframe></div><div align="center">ã€Šå¤©ç©ºä¹‹åŸã€‹<p><img src="/img/zd_01/tkzc07.png" alt></p></div><p></p><div align="center">ã€Šé£å±‹ç¯æ¸¸è®°ã€‹<p><img src="/img/zd_01/fwhyj08.png" alt></p></div><p></p><div align="center">ã€Šå¤§åœ£å½’æ¥ã€‹<p><img src="/img/zd_01/dsgl09.png" alt></p></div><p></p><div align="center">ã€Šä¾§è€³å€¾å¬ã€‹<p><img src="/img/zd_01/ceqt10.png" alt></p></div><p></p><div align="center">ã€Šç©å…·æ€»åŠ¨å‘˜ã€‹<p><img src="/img/zd_01/wjzdy11.png" alt></p></div><p></p><div align="center">ã€Šä½ çš„åå­—ã€‚ã€‹<p><img src="/img/zd_01/ndmz12.png" alt></p></div><p></p><div align="center">ã€Šå†°é›ªå¥‡ç¼˜ã€‹<p><img src="/img/zd_01/bxqy13.png" alt></p></div><p></p><div align="center">ã€Šç§’é€Ÿäº”å˜ç±³ã€‹<p><img src="/img/zd_01/mswlm14.png" alt></p></div><p></p><div align="center">ã€Šè¤ç«ä¹‹æ£®ã€‹<p><img src="/img/zd_01/yhzs15.png" alt></p></div><p></p><div align="center">ã€Šé¬¼å¦ˆå¦ˆã€‹<p><img src="/img/zd_01/gmm16.png" alt></p></div><p></p><div align="center">ã€Šå¹½çµå…¬ä¸»ã€‹<p><img src="/img/zd_01/ylgz17.png" alt></p></div><p></p><div align="center">ã€Šç¥å·å¥¶çˆ¸ã€‹<p><img src="/img/zd_01/stnb18.png" alt></p></div><p></p><div align="center">ã€Šé©¯é¾™é«˜æ‰‹ã€‹<p><img src="/img/zd_01/xlgs19.png" alt></p></div><p></p><div align="center">ã€Šå°å€©ã€‹<p><img src="/img/zd_01/xq20.png" alt></p></div><p></p>]]></content>
      
      <categories>
          
          <category> æ‚è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç”µå½± </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>PINGåŸç†</title>
      <link href="/2018/07/05/%E7%AC%94%E8%AE%B0/01ping%E5%8E%9F%E7%90%86/"/>
      <url>/2018/07/05/%E7%AC%94%E8%AE%B0/01ping%E5%8E%9F%E7%90%86/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><div align="center"><p><img src="/img/note_01/01.png" alt></p></div><p>&emsp;&emsp;ç”±ä¸Šé¢çš„æ‰§è¡Œç»“æœå¯ä»¥çœ‹åˆ°ï¼Œpingå‘½ä»¤æ‰§è¡Œåæ˜¾ç¤ºå‡ºè¢«æµ‹è¯•ç³»ç»Ÿçš„<code>ä¸»æœºå</code>å’Œ<code>ç›¸åº”IP</code>ï¼Œè¿”å›ç»™å½“å‰ä¸»æœºçš„ICMPæŠ¥æ–‡åºåˆ—å·ï¼ˆseqï¼‰,<code>ç”Ÿå­˜æ—¶é—´</code>ï¼ˆttlï¼‰,å’Œ<code>å¾€è¿”æ—¶é—´</code>ï¼ˆtimeå•ä½æ˜¯æ¯«ç§’ï¼Œå³åƒåˆ†ä¹‹ä¸€ç§’ï¼‰ã€‚æ¨¡æ‹Ÿpingå‘½ä»¤ï¼Œè¿™äº›ä¿¡æ¯éå¸¸é‡è¦ã€‚è¦çœŸæ­£äº†è§£pingå‘½ä»¤çš„å®ç°åŸç†ï¼Œå°±è¦äº†è§£pingå‘½ä»¤æ‰€ä½¿ç”¨åˆ°çš„TCP/IPåè®®ã€‚</p><h2 id="pingå‘½ä»¤ä»‹ç»"><a href="#pingå‘½ä»¤ä»‹ç»" class="headerlink" title="pingå‘½ä»¤ä»‹ç»"></a>pingå‘½ä»¤ä»‹ç»</h2><p>&emsp;&emsp;PING(Packet Internet Groper)ï¼Œå› ç‰¹ç½‘åŒ…æ¢ç´¢å…¶ï¼Œç”¨äºæµ‹è¯•ç½‘ç»œè¿æ¥é‡çš„ç¨‹åºã€‚Pingå‘å‡ºä¸€ä¸ªICMP(Internet Control Messages Protocol)å³å› ç‰¹ç½‘ä¿¡æŠ¥æ§åˆ¶åè®®ï¼›å›å£°è¯·æ±‚æ¶ˆæ¯ç»™ç›®çš„åœ°å¹¶æŠ¥å‘Šæ˜¯å¦æ”¶åˆ°æ‰€å¸Œæœ›çš„ICMP echo(ICMPå›å£°åº”ç­”)ã€‚å®ƒæ˜¯ç”¨æ¥æ£€æŸ¥ç½‘ç»œæ˜¯å¦é€šç•…æˆ–è€…ç½‘ç»œè¿é€Ÿåº¦çš„å‘½ä»¤ã€‚å®ƒæ‰€åˆ©ç”¨çš„åŸç†æ˜¯è¿™æ ·çš„ï¼šåˆ©ç”¨ç½‘ç»œä¸Šæœºå™¨IPå¾—æ²»çš„å”¯ä¸€æ€§ï¼Œç»™ç›®æ ‡IPåœ°å€å‘é€ä¸€ä¸ªæ•°æ®åŒ…ï¼Œå†è¦æ±‚å¯¹æ–¹è¿”å›ä¸€ä¸ªåŒæ ·å¤§å°çš„æ•°æ®åŒ…æ¥ç¡®å®šä¸¤å°ç½‘ç»œæœºå™¨æ˜¯å¦è¿æ¥ç›¸é€šï¼Œæ—¶å»¶æ˜¯å¤šå°‘ã€‚<br>&emsp;&emsp;å…¶ä¸­å…³é”®åœ¨äºå‘é€ICMPæ•°æ®åŒ…ï¼Œç„¶åå¯¹æ¥æ”¶åˆ°çš„åŒ…è¿›è¡Œä¸€å®šçš„å¤„ç†ã€‚ä¸å¯é¿å…ï¼Œæˆ‘ä»¬è¦å‘é€ICMPåŒ…ï¼Œå¿…é¡»è‡ªå·±æ¥æ„å»ºä¸€ä¸ªåŒ…å‡ºæ¥ã€‚å†æ¥å›é¡¾ä¸€ä¸‹ICMP:<br>&emsp;&emsp;ICMP(Internet Control Message Protocol)Internetæ§åˆ¶ä¿æ¸©åè®®ã€‚å®ƒæ˜¯TCP/IPåè®®ç°‡çš„ä¸€ä¸ªå­åè®®ï¼Œç”¨äºåœ¨IPä¸»æœºã€è·¯ç”±å™¨ä¹‹é—´ä¼ é€’æ§åˆ¶æ¶ˆæ¯ã€‚ICMPæ˜¯é¢å‘æ— è¿æ¥çš„åè®®ã€‚<br>&emsp;&emsp;pingå‘½ä»¤å€¼ä½¿ç”¨ä¼—å¤šICMPæŠ¥æ–‡ä¸­çš„ä¸¤ç§ï¼šâ€œè¯·æ±‚å›é€(ICMP_ECHO)â€å’Œâ€œè¯·æ±‚å›åº”(ICMP_ECHOREPLY)â€ã€‚è¿™ä¸¤ç§æŠ¥æ–‡çš„æŠ¥å¤´æ ¼å¼å¦‚ä¸‹ï¼š</p><table class="table_center"><tr><td>ç±»å‹(TYPE)</td><td>ç¼–ç (CODE)</td><td>æ ¡éªŒå’Œ(CHECKSUM)</td></tr><tr><td colspan="2">æ ‡è¯†ç¬¦(ID)</td><td>é¡ºåºå·(SEQ)</td></tr></table>&emsp;&emsp;å½“TYPEå­—æ®µä¸º`ICMP_ECHO`,CODEå­—æ®µä¸º0æ—¶ï¼Œä»£è¡¨PINGè¯·æ±‚æŠ¥æ–‡;TYPEå­—æ®µä¸º`ICMP_ECHOREPLY`,CODEå­—æ®µä¸º`0`æ—¶ï¼Œä»£è¡¨PINGåº”ç­”æŠ¥æ–‡/<p>icmpç»“æ„ä½“   //  netinet/ip_icmp.h</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">icmp</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">u_int8_t</span>icmp_type;              <span class="comment">/* type of message, see below */</span></span><br><span class="line"><span class="keyword">u_int8_t</span>icmp_code;              <span class="comment">/* type sub code */</span></span><br><span class="line"><span class="keyword">u_int16_t</span>icmp_cksum;             <span class="comment">/* ones complement checksum of struct */</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line">&#123;</span><br><span class="line">u_charih_pptr;        <span class="comment">/* ICMP_PARAMPROB */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span><span class="title">ih_gwaddr</span>;</span>      <span class="comment">/* gateway address */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ih_idseq</span>                 /* <span class="title">echo</span> <span class="title">datagram</span> */</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">u_int16_t</span>icd_id;</span><br><span class="line"><span class="keyword">u_int16_t</span>icd_seq;</span><br><span class="line">&#125;ih_idseq;</span><br><span class="line"><span class="keyword">u_int32_t</span>ih_void;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ICMP_UNREACH_NEEDFRAG -- Path MTU Discovery (RFC1191) */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ih_pmtu</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">u_int16_t</span>ipm_void;</span><br><span class="line"><span class="keyword">u_int16_t</span>ipm_nextmtu;</span><br><span class="line">&#125; ih_pmtu;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ih_rtradv</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">u_int8_t</span>irt_num_addrs;</span><br><span class="line"><span class="keyword">u_int8_t</span>irt_wpa;</span><br><span class="line"><span class="keyword">u_int16_t</span>irt_lifetime;</span><br><span class="line">&#125; ih_rtradv;</span><br><span class="line">&#125; icmp_hun;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_pptricmp_hun.ih_pptr</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_gwaddricmp_hun.ih_gwaddr</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_idicmp_hun.ih_idseq.icd_id</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_seqicmp_hun.ih_idseq.icd_seq</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_voidicmp_hun.ih_void</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_pmvoidicmp_hun.ih_pmtu.ipm_void</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_nextmtuicmp_hun.ih_pmtu.ipm_nextmtu</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_num_addrsicmp_hun.ih_rtradv.irt_num_addrs</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_wpaicmp_hun.ih_rtradv.irt_wpa</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_lifetimeicmp_hun.ih_rtradv.irt_lifetime</span></span><br><span class="line"><span class="keyword">union</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">u_int32_t</span>its_otime;</span><br><span class="line"><span class="keyword">u_int32_t</span>its_rtime;</span><br><span class="line"><span class="keyword">u_int32_t</span>its_ttime;</span><br><span class="line">&#125; id_ts;</span><br><span class="line"><span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip</span> <span class="title">idi_ip</span>;</span></span><br><span class="line"><span class="comment">/* options and then 64 bits of data */</span></span><br><span class="line">&#125;id_ip;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">icmp_ra_addr</span><span class="title">id_radv</span>;</span></span><br><span class="line"><span class="keyword">u_int32_t</span>id_mask;</span><br><span class="line"><span class="keyword">u_int8_t</span>id_data[<span class="number">1</span>];</span><br><span class="line">&#125; icmp_dun;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_otimeicmp_dun.id_ts.its_otime</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_rtimeicmp_dun.id_ts.its_rtime</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_ttimeicmp_dun.id_ts.its_ttime</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_ipicmp_dun.id_ip.idi_ip</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_radvicmp_dun.id_radv</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_maskicmp_dun.id_mask</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> icmp_dataicmp_dun.id_data</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>&emsp;&emsp;ä½¿ç”¨å®å®šä¹‰è¡¨è¾¾æ›´ç®€æ´ï¼Œå…¶ä¸­ICMPæŠ¥æ–‡ä¸º8å­—èŠ‚ï¼Œæ•°æ®æŠ¥é•¿åº¦æœ€å¤§ä¸º64Kå­—èŠ‚ã€‚</p><p>&emsp;&emsp;æ ¡éªŒå’Œç®—æ³•ï¼šè¿™ä¸€ç®—æ³•ç§°ä¸ºç½‘é™…æ ¡éªŒå’Œç®—æ³•ï¼ŒæŠŠæ ¡éªŒçš„æ•°æ®16ä½è¿›è¡Œç´¯åŠ ï¼Œç„¶åå–åç ï¼Œè‹¥æ•°æ®å­—èŠ‚é•¿åº¦ä¸ºå¥‡æ•°ï¼Œåˆ™æ•°æ®å°¾éƒ¨è¡¥ä¸€ä¸ªå­—èŠ‚çš„0ä»¥å‡‘æˆå¶æ•°ã€‚æ­¤ç®—æ³•é€‚ç”¨äºIPv4ã€ICMPv4ã€ICMPv6ã€UDPå’ŒTCPæ ¡éªŒå’Œï¼Œæ ¡éªŒå’Œå­—æ®µä¸ºä¸Šè¿°ICMPæ•°æ®ç»“æ„çš„icmp_cksumå˜é‡ã€‚<br>&emsp;&emsp;æ ‡è¯†ç¬¦ï¼šç”¨äºå”¯ä¸€æ ‡è¯†ICMPæŠ¥æ–‡ï¼Œä¸ºä¸Šè¿°ICMPæ•°æ®ç»“æ„çš„icmp_idå®å®šä¹‰æŒ‡çš„å˜é‡ã€‚<br>&emsp;&emsp;é¡ºåºå·ï¼špingå‘½ä»¤çš„icmp_seqä¾¿ç”±è¿™é‡Œè¯»å‡ºï¼Œä»£è¡¨ICMPæŠ¥æ–‡çš„å‘é€é¡ºåºï¼Œä¸ºä¸Šè¿°ICMPæ•°æ®ç»“æ„çš„icmp_seqå®æ‰€æŒ‡çš„å˜é‡ã€‚</p><p><strong>ICMPå°åŒ…å</strong>ï¼š<table class="table_center"><tr><th>ICMPæŠ¥å¤´</th><th>ICMPæŠ¥æ–‡</th></tr></table><br>&emsp;&emsp;ICMPæ˜¯ä¸ºç½‘ç®¡å’Œç›®æ ‡ä¸»æœºäºŒæä¾›çš„ä¸€ç§å·®é”™æ§åˆ¶æœºåˆ¶ï¼Œä½¿å®ƒä»¬åœ¨é‡åˆ°å·®é”™æ—¶èƒ½æŠŠé”™è¯¯æŠ¥å‘Šç»™æŠ¥æ–‡æºå‘æ–¹ã€‚ICMPåè®®æ˜¯IPå±‚çš„ä¸€ä¸ªåè®®ï¼Œä½†æ˜¯ç”±äºå·®é”™æŠ¥å‘Šåœ¨å‘é€ç»™æŠ¥æ–‡æºå‘æ–¹æ—¶å¯èƒ½ä¹Ÿè¦ç»è¿‡è‹¥å¹²å­ç½‘ï¼Œå› æ­¤ç‰µæ‰¯åˆ°è·¯ç”±é€‰æ‹©ç­‰é—®é¢˜ï¼Œæ‰€ä»¥ICMPæŠ¥æ–‡é€šè¿‡IPåè®®æ¥å‘é€ã€‚ICMPæ•°æ®æŠ¥çš„æ•°æ®å‘é€å‰éœ€è¦ä¸¤çº§å°è£…ï¼šé¦–å…ˆæ·»åŠ ICMPæŠ¥å¤´å½¢æˆICMPæŠ¥æ–‡ï¼Œå†æ·»åŠ IPæŠ¥å¤´å½¢æˆIPæ•°æ®æŠ¥ã€‚å› æ­¤æˆ‘ä»¬è¿˜éœ€çŸ¥é“IPæŠ¥æ–‡çš„æ ¼å¼ã€‚</p><p>&emsp;&emsp;<strong>IPæŠ¥æ–‡æ ¼å¼</strong>ï¼š<div align="center"><img src="/img/note_01/02.png" alt></div><br>æ•´ä¸ªICMPæŠ¥æ–‡ä½œä¸ºIPæŠ¥æ–‡çš„æ•°æ®éƒ¨åˆ†ï¼Œå†ç»™ICMPæŠ¥æ–‡åŠ ä¸ªIPå¤´éƒ¨ï¼š</p><table class="table_center"><tr><th>IPå¤´éƒ¨</th><th>ICMPå¤´éƒ¨</th><th>ICMPæ•°æ®</th></tr></table><p><strong>æ³¨:</strong> ipå¤´éƒ¨çš„è€ƒè™‘ï¼Œåœ¨å‘é€ICMPæŠ¥æ–‡æ—¶ä¸éœ€è¦è€ƒè™‘IPå¤´éƒ¨ï¼Œåªéœ€è¦ç»„å»ºä¸€ä¸ªå®Œæ•´æµ‹ICMPå‘é€æŠ¥æ–‡å³TYPEä¸ºICMP_ECHOã€CODEä¸º0çš„PINGæŠ¥æ–‡ã€‚åœ¨PINGåº”ç­”æŠ¥æ–‡ä¸­å¯¹æ¥æ”¶æ•°æ®åˆ†ææ—¶ï¼Œå¿…é¡»è€ƒè™‘IPå¤´éƒ¨ï¼Œå…ˆå»é™¤IPå¤´éƒ¨åï¼Œè¿›è¡Œå¯¹ICMPæŠ¥æ–‡å¤„ç†ã€‚<br>&emsp;&emsp;PINGè¯·æ±‚ï¼ˆå‘é€ï¼‰æŠ¥æ–‡ä¸è€ƒè™‘IPå¤´éƒ¨ï¼ŒPINGåº”ç­”ï¼ˆæ¥æ”¶ï¼‰æŠ¥æ–‡è€ƒè™‘å»é™¤IPå¤´éƒ¨ã€‚</p><p>ipç»“æ„ä½“  </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  netinet/ip.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ip</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __BYTE_ORDER == __LITTLE_ENDIAN</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> ip_hl:<span class="number">4</span>;               <span class="comment">/* header length */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> ip_v:<span class="number">4</span>;                <span class="comment">/* version */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __BYTE_ORDER == __BIG_ENDIAN</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> ip_v:<span class="number">4</span>;                <span class="comment">/* version */</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> ip_hl:<span class="number">4</span>;               <span class="comment">/* header length */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">u_int8_t</span> ip_tos;                    <span class="comment">/* type of service */</span></span><br><span class="line">u_short ip_len;                     <span class="comment">/* total length */</span></span><br><span class="line">u_short ip_id;                      <span class="comment">/* identification */</span></span><br><span class="line">u_short ip_off;                     <span class="comment">/* fragment offset field */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IP_RF 0x8000                    <span class="comment">/* reserved fragment flag */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IP_DF 0x4000                    <span class="comment">/* dont fragment flag */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IP_MF 0x2000                    <span class="comment">/* more fragments flag */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IP_OFFMASK 0x1fff               <span class="comment">/* mask for fragmenting bits */</span></span></span><br><span class="line"><span class="keyword">u_int8_t</span> ip_ttl;                    <span class="comment">/* time to live */</span></span><br><span class="line"><span class="keyword">u_int8_t</span> ip_p;                      <span class="comment">/* protocol */</span></span><br><span class="line">u_short ip_sum;                     <span class="comment">/* checksum */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">ip_src</span>, <span class="title">ip_dst</span>;</span>      <span class="comment">/* source and dest address */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>PINGç¨‹åºä¸­ä¸»è¦ä½¿ç”¨ä»¥ä¸‹æ•°æ®ï¼š</p><ul><li>IPæŠ¥æ–‡å¤´éƒ¨é•¿åº¦IHL(Internet Header Length),ä»¥4å­—èŠ‚ä¸ºå•ä½è®°å½•IPå¤´éƒ¨é•¿åº¦ï¼ˆip_hlï¼‰ã€‚</li><li>ç”Ÿå‘½å‘¨æœŸ(TTL)ä»¥ç§’ä¸ºå•ä½ï¼ŒæŒ‡å‡ºIPæ•°æ®æŠ¥èƒ½åœ¨ç½‘ç»œä¸Šåœç•™çš„æœ€é•¿æ—¶é—´ï¼Œå…¶å€¼ç”±å‘é€æ–¹è®¾å®šï¼Œå¹¶åœ¨ç»è¿‡è·¯ç”±çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹æ—¶å»ºè®®ï¼Œå½“è¯¥å€¼ä¸º0æ—¶ï¼Œæ•°æ®æŠ¥è¢«ä¸¢å¼ƒï¼ˆip_ttlï¼‰ã€‚</li></ul><p>pingç¨‹åºä»£ç æµç¨‹ï¼š</p><ul><li>1ã€å‚æ•°åˆæ³•æ€§æ£€æŸ¥ï¼Œè·å–ï¼ˆè½¬æ¢ï¼‰ç›®æ ‡åœ°å€</li><li>2ã€å‘é€æŠ¥æ–‡</li><li>3ã€æ¥æ”¶æŠ¥æ–‡</li><li>4ã€æ‰“å°PINGä¿¡æ¯</li></ul><p><strong>1ã€å‚æ•°åˆæ³•æ€§æ£€æŸ¥</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">in_addr_t</span> inaddr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">dest_addr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> socket_fd;  </span><br><span class="line">    <span class="keyword">int</span> size = <span class="number">50</span> *<span class="number">1024</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">p_host</span>;</span></span><br><span class="line">    <span class="keyword">int</span> n_send = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usgae: %s [hostname/ip address]\n"</span>,argv[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºsocketå¥—æ¥å­— AF_INET ipv4  IPPROTO_ICMP icmpåè®®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    socket_fd = socket(AF_INET,SOCK_RAW,IPPROTO_ICMP); </span><br><span class="line">    <span class="keyword">if</span>(socket_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">"fail socket"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * setsockopt è¿™é‡Œä½¿ç”¨ä¸»è¦æ˜¯è®¾ç½®æ¥æ”¶æ•°æ®åŒ…ç¼“å†²åŒºï¼Œé¿å…äº†send(),recv()ä¸æ–­çš„å¾ªç¯æ”¶å‘</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(setsockopt(socket_fd,SOL_SOCKET,SO_RCVBUF,&amp;size,<span class="keyword">sizeof</span>(size)) &lt; <span class="number">0</span> )&#123;</span><br><span class="line">        perror(<span class="string">"fail setsocketopt"</span>);    </span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    bzero(&amp;dest_addr,<span class="keyword">sizeof</span>(dest_addr));</span><br><span class="line">    dest_addr.sin_family = AF_INET;</span><br><span class="line">    </span><br><span class="line">    inaddr = inet_addr(argv[<span class="number">1</span>]); <span class="comment">// å°†ç‚¹åˆ†åè¿›åˆ¶ipåœ°å€è½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åº</span></span><br><span class="line">    <span class="keyword">if</span>(inaddr == INADDR_NONE)&#123;</span><br><span class="line">        p_host = gethostbyname2_block_proc(argv[<span class="number">1</span>],<span class="number">12</span>); <span class="comment">//gethostbyname2 é˜²æ­¢é˜»å¡å¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">NULL</span> == p_host)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"unknow host:%s\n"</span>,argv[<span class="number">1</span>]);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)&amp;dest_addr.sin_addr,p_host-&gt;h_addr,p_host-&gt;h_length);    </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        dest_addr.sin_addr.s_addr = inaddr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> != p_host)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"PING %s"</span>,p_host-&gt;h_name);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"PING %s"</span>,argv[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"(%s) %d bytes of data.\n"</span>,inet_ntoa(dest_addr.sin_addr),ICMP_LEN);  </span><br><span class="line">    signal(SIGINT,statistics);</span><br><span class="line">    pHost = p_host; <span class="comment">// pHost statisticsd æ‰“å°ä¿¡æ¯ä½¿ç”¨</span></span><br><span class="line">    IP = argv[<span class="number">1</span>];  <span class="comment">// IP statisticsæ‰“å°ä¿¡æ¯ä½¿ç”¨</span></span><br><span class="line">    SocketICMP = socket_fd;  <span class="comment">//SocketICMP statistics()å‡½æ•°closeå¥—æ¥å­—ä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">while</span>(n_send &lt; SEND_NUM )&#123;</span><br><span class="line">        send_packet(socket_fd,&amp;dest_addr,n_send);</span><br><span class="line">        </span><br><span class="line">        recv_packet(socket_fd,&amp;dest_addr);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        n_send++;</span><br><span class="line">        nSend = n_send; <span class="comment">// nSend statisticsæ‰“å°ä¿¡æ¯ä½¿ç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line">    statistics();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>2ã€å‘é€æ•°æ®</strong><br>å‘é€æ•°æ®ä¸»è¦åŒ…æ‹¬ç»„å»ºICMPæŠ¥æ–‡ï¼Œå‘é€æŠ¥æ–‡ï¼›ç»„å»ºICMPæŠ¥æ–‡æ—¶éœ€è¦è®¡ç®—æ ¡éªŒå’Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">u_int16_t</span> compute_cksum(<span class="keyword">u_int16_t</span> *p_data,<span class="keyword">int</span> data_len)&#123;</span><br><span class="line">    <span class="keyword">u_int16_t</span> *p_tmp_data = p_data;</span><br><span class="line">    <span class="keyword">int</span> len = data_len;</span><br><span class="line">    <span class="keyword">u_int32_t</span> sum = <span class="number">0</span>; <span class="comment">// sum å¿…é¡»ä¸º u_int32_t ä¸èƒ½ä¸º u_int16_t   </span></span><br><span class="line">    <span class="keyword">while</span>(len &gt; <span class="number">1</span>)&#123;</span><br><span class="line">        sum += *p_tmp_data++;</span><br><span class="line">        len -= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span> == len)&#123;</span><br><span class="line">        <span class="keyword">u_int16_t</span> tmp = *p_tmp_data;</span><br><span class="line">        tmp &amp;= <span class="number">0xff00</span>;</span><br><span class="line">        sum += tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(sum &gt;&gt; <span class="number">16</span>)&#123;</span><br><span class="line">        sum = (sum &gt;&gt; <span class="number">16</span>) + (sum &amp; <span class="number">0x0000ffff</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sum = ~sum;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ç»„å»ºICMPæŠ¥æ–‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_icmp</span><span class="params">(<span class="keyword">char</span> *p_send_buffer,<span class="keyword">u_int16_t</span> seq)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">icmp</span> *<span class="title">p_icmp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> *<span class="title">p_time</span>;</span></span><br><span class="line">    </span><br><span class="line">    p_icmp = (struct icmp *)p_send_buffer;</span><br><span class="line">    p_icmp-&gt;icmp_type = ICMP_ECHO;</span><br><span class="line">    p_icmp-&gt;icmp_code = <span class="number">0</span>;</span><br><span class="line">    p_icmp-&gt;icmp_cksum = <span class="number">0</span>;</span><br><span class="line">    p_icmp-&gt;icmp_seq = seq;</span><br><span class="line">    p_icmp-&gt;icmp_id = getpid();</span><br><span class="line">    p_time = (struct timeval *)p_icmp-&gt;icmp_data;</span><br><span class="line">    gettimeofday(p_time,<span class="literal">NULL</span>);</span><br><span class="line">    p_icmp-&gt;icmp_cksum = compute_cksum((<span class="keyword">u_int16_t</span> *)p_icmp,ICMP_LEN);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(seq == <span class="number">1</span>)&#123;</span><br><span class="line">        FirstSendTime = *p_time;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">send_packet</span><span class="params">(<span class="keyword">int</span> socket_fd,struct sockaddr_in *p_dest_addr,<span class="keyword">int</span> n_send)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> send_buffer[BUFFER_LEN];</span><br><span class="line">    set_icmp(send_buffer,n_send);</span><br><span class="line">    <span class="keyword">if</span>(sendto(socket_fd,send_buffer,ICMP_LEN,<span class="number">0</span>,(</span><br><span class="line">        struct sockaddr *)p_dest_addr,<span class="keyword">sizeof</span>(struct sockaddr_in))&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">"sendto"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>3ã€æ¥æ”¶æ•°æ®</strong><br>æ¥æ”¶æ•°æ®åŒ…æ‹¬æ¥æ”¶æ•°æ®å’Œæ•°æ®åˆ†æ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">unpack</span><span class="params">(<span class="keyword">char</span> *p_recv_buffer,struct timeval *p_recv_time)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip</span> *<span class="title">p_ip</span> = (<span class="title">struct</span> <span class="title">ip</span> *)<span class="title">p_recv_buffer</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">icmp</span> *<span class="title">p_icmp</span> ;</span></span><br><span class="line">    <span class="keyword">int</span> ip_head_len;</span><br><span class="line">    <span class="keyword">double</span> rtt=<span class="number">0.0</span>; </span><br><span class="line"></span><br><span class="line">    ip_head_len = p_ip-&gt;ip_hl &lt;&lt; <span class="number">2</span>;</span><br><span class="line">    p_icmp = (struct icmp *)(p_recv_buffer + ip_head_len);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(p_icmp-&gt;icmp_type == ICMP_ECHOREPLY &amp;&amp; p_icmp-&gt;icmp_id == getpid())&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> *<span class="title">p_send_time</span> = (<span class="title">struct</span> <span class="title">timeval</span> *)<span class="title">p_icmp</span>-&gt;<span class="title">icmp_data</span>;</span></span><br><span class="line">        rtt = get_rtt(p_recv_time,p_send_time);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%u bytes from %s:icmp_seq=%u ttl=%u time=%.1f ms\n"</span>,</span><br><span class="line">            ntohs(p_ip-&gt;ip_len),inet_ntoa(p_ip-&gt;ip_src),p_icmp-&gt;icmp_seq,</span><br><span class="line">            p_ip-&gt;ip_ttl,rtt);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(rtt &lt; min || <span class="number">0</span> == min)&#123;</span><br><span class="line">            min = rtt;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(rtt &gt; max)&#123;</span><br><span class="line">            max = rtt;</span><br><span class="line">        &#125;</span><br><span class="line">        avg += rtt;</span><br><span class="line">        mdev += rtt*rtt;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">recv_packet</span><span class="params">(<span class="keyword">int</span> socket_fd,struct sockaddr_in *p_dest_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> recv_bytes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> addrlen = <span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line">    <span class="keyword">char</span> recv_buffer[BUFFER_LEN];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">recv_time</span>;</span></span><br><span class="line">    </span><br><span class="line">    signal(SIGALRM,statistics);</span><br><span class="line">    alarm(WAIT_TIME);</span><br><span class="line"></span><br><span class="line">    recv_bytes = recvfrom(socket_fd,recv_buffer,BUFFER_LEN,<span class="number">0</span>,</span><br><span class="line">        (struct sockaddr *)p_dest_addr,&amp;addrlen);</span><br><span class="line">    <span class="keyword">if</span>(recv_bytes &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">"recvfrom"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gettimeofday(&amp;recv_time,<span class="literal">NULL</span>);</span><br><span class="line">    LastRecvTime = recv_time;</span><br><span class="line">    <span class="keyword">if</span>(unpack(recv_buffer,&amp;recv_time) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    nRecv++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">get_rtt</span><span class="params">(struct timeval *p_recv_time,struct timeval *p_send_time)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tmp_time</span> = *<span class="title">p_recv_time</span>;</span></span><br><span class="line">    </span><br><span class="line">    tmp_time.tv_usec -= p_send_time-&gt;tv_usec;</span><br><span class="line">    <span class="keyword">if</span>(tmp_time.tv_usec &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        --(tmp_time.tv_sec);</span><br><span class="line">        tmp_time.tv_usec += <span class="number">1000000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    tmp_time.tv_sec -= p_send_time-&gt;tv_sec;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (tmp_time.tv_sec *<span class="number">1000.0</span>) + (tmp_time.tv_usec / <span class="number">1000.0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>4ã€æ‰“å°æ•°æ®</strong><br>ç»Ÿè®¡æ•°æ®</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">statistics</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">double</span> tmp;</span><br><span class="line">    avg /= nRecv;</span><br><span class="line">    tmp = mdev/nRecv - avg * avg;</span><br><span class="line">    mdev = <span class="built_in">sqrt</span>(tmp);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> != pHost)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"--- %s ping statistics ---\n"</span>,pHost-&gt;h_name);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"--- %s ping statistics ---\n"</span>,IP);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d packets transmitted, %d received, %d%% packet loss, time %dms\n"</span>,</span><br><span class="line">        nSend,nRecv,(nSend-nRecv)/nSend *<span class="number">100</span>,(<span class="keyword">int</span>)get_rtt(&amp;LastRecvTime,&amp;FirstSendTime));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"rtt min/avg/max/dev = %.3f/%.3f/%.3f/%.3f ms\n"</span>,min,avg,max,mdev);</span><br><span class="line">    </span><br><span class="line">    close(SocketICMP);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®Œæ•´ä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netdb.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/ip_icmp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;setjmp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SEND_NUM 100</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFFER_LEN 128</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICMP_HEAD_LEN 8</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICMP_DATA_LEN 56</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ICMP_LEN (ICMP_HEAD_LEN + ICMP_DATA_LEN)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//char SendBuffer[BUFFER_LEN];</span></span><br><span class="line"><span class="comment">//char RecvBuffer[BUFFER_LEN];</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">pHost</span>;</span></span><br><span class="line"><span class="keyword">char</span> *IP;</span><br><span class="line"><span class="keyword">int</span> nRecv = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> nSend = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">double</span> min=<span class="number">0.0</span>;</span><br><span class="line"><span class="keyword">double</span> avg=<span class="number">0.0</span>;</span><br><span class="line"><span class="keyword">double</span> max=<span class="number">0.0</span>;</span><br><span class="line"><span class="keyword">double</span> mdev =<span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">FirstSendTime</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">LastRecvTime</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WAIT_TIME 5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> SocketICMP;</span><br><span class="line"></span><br><span class="line"><span class="keyword">u_int16_t</span> compute_cksum(<span class="keyword">u_int16_t</span> *p_data,<span class="keyword">int</span> data_len)&#123;</span><br><span class="line">    <span class="keyword">u_int16_t</span> *p_tmp_data = p_data;</span><br><span class="line">    <span class="keyword">int</span> len = data_len;</span><br><span class="line">    <span class="keyword">u_int32_t</span> sum = <span class="number">0</span>; <span class="comment">// sum å¿…é¡»ä¸º u_int32_t ä¸èƒ½ä¸º u_int16_t   </span></span><br><span class="line">    <span class="keyword">while</span>(len &gt; <span class="number">1</span>)&#123;</span><br><span class="line">        sum += *p_tmp_data++;</span><br><span class="line">        len -= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">1</span> == len)&#123;</span><br><span class="line">        <span class="keyword">u_int16_t</span> tmp = *p_tmp_data;</span><br><span class="line">        tmp &amp;= <span class="number">0xff00</span>;</span><br><span class="line">        sum += tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(sum &gt;&gt; <span class="number">16</span>)&#123;</span><br><span class="line">        sum = (sum &gt;&gt; <span class="number">16</span>) + (sum &amp; <span class="number">0x0000ffff</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sum = ~sum;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">set_icmp</span><span class="params">(<span class="keyword">char</span> *p_send_buffer,<span class="keyword">u_int16_t</span> seq)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">icmp</span> *<span class="title">p_icmp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> *<span class="title">p_time</span>;</span></span><br><span class="line">    </span><br><span class="line">    p_icmp = (struct icmp *)p_send_buffer;</span><br><span class="line">    p_icmp-&gt;icmp_type = ICMP_ECHO;</span><br><span class="line">    p_icmp-&gt;icmp_code = <span class="number">0</span>;</span><br><span class="line">    p_icmp-&gt;icmp_cksum = <span class="number">0</span>;</span><br><span class="line">    p_icmp-&gt;icmp_seq = seq;</span><br><span class="line">    p_icmp-&gt;icmp_id = getpid();</span><br><span class="line">    p_time = (struct timeval *)p_icmp-&gt;icmp_data;</span><br><span class="line">    gettimeofday(p_time,<span class="literal">NULL</span>);</span><br><span class="line">    p_icmp-&gt;icmp_cksum = compute_cksum((<span class="keyword">u_int16_t</span> *)p_icmp,ICMP_LEN);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(seq == <span class="number">1</span>)&#123;</span><br><span class="line">        FirstSendTime = *p_time;</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">send_packet</span><span class="params">(<span class="keyword">int</span> socket_fd,struct sockaddr_in *p_dest_addr,<span class="keyword">int</span> n_send)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> send_buffer[BUFFER_LEN];</span><br><span class="line">    set_icmp(send_buffer,n_send);</span><br><span class="line">    <span class="keyword">if</span>(sendto(socket_fd,send_buffer,ICMP_LEN,<span class="number">0</span>,(</span><br><span class="line">        struct sockaddr *)p_dest_addr,<span class="keyword">sizeof</span>(struct sockaddr_in))&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">"sendto"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">get_rtt</span><span class="params">(struct timeval *p_recv_time,struct timeval *p_send_time)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tmp_time</span> = *<span class="title">p_recv_time</span>;</span></span><br><span class="line">    </span><br><span class="line">    tmp_time.tv_usec -= p_send_time-&gt;tv_usec;</span><br><span class="line">    <span class="keyword">if</span>(tmp_time.tv_usec &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        --(tmp_time.tv_sec);</span><br><span class="line">        tmp_time.tv_usec += <span class="number">1000000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    tmp_time.tv_sec -= p_send_time-&gt;tv_sec;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> (tmp_time.tv_sec *<span class="number">1000.0</span>) + (tmp_time.tv_usec / <span class="number">1000.0</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">statistics</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">double</span> tmp;</span><br><span class="line">    avg /= nRecv;</span><br><span class="line">    tmp = mdev/nRecv - avg * avg;</span><br><span class="line">    mdev = <span class="built_in">sqrt</span>(tmp);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> != pHost)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"--- %s ping statistics ---\n"</span>,pHost-&gt;h_name);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"--- %s ping statistics ---\n"</span>,IP);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d packets transmitted, %d received, %d%% packet loss, time %dms\n"</span>,</span><br><span class="line">        nSend,nRecv,(nSend-nRecv)/nSend *<span class="number">100</span>,(<span class="keyword">int</span>)get_rtt(&amp;LastRecvTime,&amp;FirstSendTime));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"rtt min/avg/max/dev = %.3f/%.3f/%.3f/%.3f ms\n"</span>,min,avg,max,mdev);</span><br><span class="line">    </span><br><span class="line">    close(SocketICMP);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">unpack</span><span class="params">(<span class="keyword">char</span> *p_recv_buffer,struct timeval *p_recv_time)</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ip</span> *<span class="title">p_ip</span> = (<span class="title">struct</span> <span class="title">ip</span> *)<span class="title">p_recv_buffer</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">icmp</span> *<span class="title">p_icmp</span> ;</span></span><br><span class="line">    <span class="keyword">int</span> ip_head_len;</span><br><span class="line">    <span class="keyword">double</span> rtt=<span class="number">0.0</span>; </span><br><span class="line"></span><br><span class="line">    ip_head_len = p_ip-&gt;ip_hl &lt;&lt; <span class="number">2</span>;</span><br><span class="line">    p_icmp = (struct icmp *)(p_recv_buffer + ip_head_len);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(p_icmp-&gt;icmp_type == ICMP_ECHOREPLY &amp;&amp; p_icmp-&gt;icmp_id == getpid())&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> *<span class="title">p_send_time</span> = (<span class="title">struct</span> <span class="title">timeval</span> *)<span class="title">p_icmp</span>-&gt;<span class="title">icmp_data</span>;</span></span><br><span class="line">        rtt = get_rtt(p_recv_time,p_send_time);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%u bytes from %s:icmp_seq=%u ttl=%u time=%.1f ms\n"</span>,</span><br><span class="line">            ntohs(p_ip-&gt;ip_len),inet_ntoa(p_ip-&gt;ip_src),p_icmp-&gt;icmp_seq,</span><br><span class="line">            p_ip-&gt;ip_ttl,rtt);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(rtt &lt; min || <span class="number">0</span> == min)&#123;</span><br><span class="line">            min = rtt;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(rtt &gt; max)&#123;</span><br><span class="line">            max = rtt;</span><br><span class="line">        &#125;</span><br><span class="line">        avg += rtt;</span><br><span class="line">        mdev += rtt*rtt;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">recv_packet</span><span class="params">(<span class="keyword">int</span> socket_fd,struct sockaddr_in *p_dest_addr)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> recv_bytes = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> addrlen = <span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line">    <span class="keyword">char</span> recv_buffer[BUFFER_LEN];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">recv_time</span>;</span></span><br><span class="line">    </span><br><span class="line">    signal(SIGALRM,statistics);</span><br><span class="line">    alarm(WAIT_TIME);</span><br><span class="line"></span><br><span class="line">    recv_bytes = recvfrom(socket_fd,recv_buffer,BUFFER_LEN,<span class="number">0</span>,</span><br><span class="line">        (struct sockaddr *)p_dest_addr,&amp;addrlen);</span><br><span class="line">    <span class="keyword">if</span>(recv_bytes &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">"recvfrom"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gettimeofday(&amp;recv_time,<span class="literal">NULL</span>);</span><br><span class="line">    LastRecvTime = recv_time;</span><br><span class="line">    <span class="keyword">if</span>(unpack(recv_buffer,&amp;recv_time) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    nRecv++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> sigjmp_buf jmpbuf;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">alarm_func</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">     siglongjmp(jmpbuf, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct hostent * <span class="title">gethostbyname2_block_proc</span><span class="params">(<span class="keyword">char</span> *p_hostname,<span class="keyword">int</span> timeout)</span></span>&#123;</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">p_ret_hostent</span>;</span></span><br><span class="line"> </span><br><span class="line">     signal(SIGALRM, alarm_func);</span><br><span class="line">     <span class="keyword">if</span>(sigsetjmp(jmpbuf, <span class="number">1</span>) != <span class="number">0</span>)</span><br><span class="line">     &#123;</span><br><span class="line">           alarm(<span class="number">0</span>); <span class="comment">/* å–æ¶ˆé—¹é’Ÿ */</span></span><br><span class="line">           signal(SIGALRM, SIG_IGN);</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     alarm(timeout); <span class="comment">/* è®¾ç½®è¶…æ—¶æ—¶é—´ */</span></span><br><span class="line">     p_ret_hostent = gethostbyname2(p_hostname,AF_INET); <span class="comment">// gethostbyname2æŒ‡å®šAF_IENT IPV4åœ°å€</span></span><br><span class="line">     signal(SIGALRM, SIG_IGN);</span><br><span class="line"> </span><br><span class="line">     <span class="keyword">return</span> p_ret_hostent;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">in_addr_t</span> inaddr;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">dest_addr</span>;</span></span><br><span class="line">    <span class="keyword">int</span> socket_fd;  </span><br><span class="line">    <span class="keyword">int</span> size = <span class="number">50</span> *<span class="number">1024</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">hostent</span> *<span class="title">p_host</span>;</span></span><br><span class="line">    <span class="keyword">int</span> n_send = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Usgae: %s [hostname/ip address]\n"</span>,argv[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * åˆ›å»ºsocketå¥—æ¥å­— AF_INET ipv4  IPPROTO_ICMP icmpåè®®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    socket_fd = socket(AF_INET,SOCK_RAW,IPPROTO_ICMP); </span><br><span class="line">    <span class="keyword">if</span>(socket_fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        perror(<span class="string">"fail socket"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * setsockopt è¿™é‡Œä½¿ç”¨ä¸»è¦æ˜¯è®¾ç½®æ¥æ”¶æ•°æ®åŒ…ç¼“å†²åŒºï¼Œé¿å…äº†send(),recv()ä¸æ–­çš„å¾ªç¯æ”¶å‘</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(setsockopt(socket_fd,SOL_SOCKET,SO_RCVBUF,&amp;size,<span class="keyword">sizeof</span>(size)) &lt; <span class="number">0</span> )&#123;</span><br><span class="line">        perror(<span class="string">"fail setsocketopt"</span>);    </span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    bzero(&amp;dest_addr,<span class="keyword">sizeof</span>(dest_addr));</span><br><span class="line">    dest_addr.sin_family = AF_INET;</span><br><span class="line">    </span><br><span class="line">    inaddr = inet_addr(argv[<span class="number">1</span>]); <span class="comment">// å°†ç‚¹åˆ†åè¿›åˆ¶ipåœ°å€è½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åº</span></span><br><span class="line">    <span class="keyword">if</span>(inaddr == INADDR_NONE)&#123;</span><br><span class="line">        p_host = gethostbyname2_block_proc(argv[<span class="number">1</span>],<span class="number">12</span>); <span class="comment">//gethostbyname2 é˜²æ­¢é˜»å¡å¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="literal">NULL</span> == p_host)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"unknow host:%s\n"</span>,argv[<span class="number">1</span>]);</span><br><span class="line">            <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memcpy</span>((<span class="keyword">char</span> *)&amp;dest_addr.sin_addr,p_host-&gt;h_addr,p_host-&gt;h_length);    </span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        dest_addr.sin_addr.s_addr = inaddr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> != p_host)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"PING %s"</span>,p_host-&gt;h_name);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"PING %s"</span>,argv[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"(%s) %d bytes of data.\n"</span>,inet_ntoa(dest_addr.sin_addr),ICMP_LEN);  </span><br><span class="line">    signal(SIGINT,statistics);</span><br><span class="line">    pHost = p_host; <span class="comment">// pHost statisticsd æ‰“å°ä¿¡æ¯ä½¿ç”¨</span></span><br><span class="line">    IP = argv[<span class="number">1</span>];  <span class="comment">// IP statisticsæ‰“å°ä¿¡æ¯ä½¿ç”¨</span></span><br><span class="line">    SocketICMP = socket_fd;  <span class="comment">//SocketICMP statistics()å‡½æ•°closeå¥—æ¥å­—ä½¿ç”¨</span></span><br><span class="line">    <span class="keyword">while</span>(n_send &lt; SEND_NUM )&#123;</span><br><span class="line">        send_packet(socket_fd,&amp;dest_addr,n_send);</span><br><span class="line">        </span><br><span class="line">        recv_packet(socket_fd,&amp;dest_addr);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        n_send++;</span><br><span class="line">        nSend = n_send; <span class="comment">// nSend statisticsæ‰“å°ä¿¡æ¯ä½¿ç”¨</span></span><br><span class="line">    &#125;</span><br><span class="line">    statistics();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ping </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Linux CPUä½¿ç”¨ç‡</title>
      <link href="/2018/06/26/%E7%AC%94%E8%AE%B0/0cLinuxCPU%E4%BD%BF%E7%94%A8%E7%8E%87/"/>
      <url>/2018/06/26/%E7%AC%94%E8%AE%B0/0cLinuxCPU%E4%BD%BF%E7%94%A8%E7%8E%87/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>å†…æ ¸ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/version</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/note_0c/00.png" alt></p></div><p>CPUæ´»åŠ¨ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/<span class="built_in">stat</span></span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/note_0c/01.png" alt></p></div><p>jiffiesæ˜¯å†…æ ¸ä¸­çš„ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œç”¨æ¥è®°å½•è‡ªç³»ç»Ÿå¯åŠ¨ä»¥æ¥äº§ç”Ÿçš„èŠ‚æ‹ä¹¦ï¼Œåœ¨linuxä¸­ï¼Œä¸€ä¸ªèŠ‚æ‹å¤§è‡´å¯ä»¥ç«‹å³ä¸ºæ“ä½œç³»ç»Ÿè¿›ç¨‹è°ƒåº¦çš„æœ€å°æ—¶é—´ç‰‡ï¼Œä¸åŒçš„linuxå†…æ ¸å¯èƒ½å€¼æœ‰æ‰€ä¸åŒï¼Œé€šå¸¸åœ¨1msåˆ°10msä¹‹é—´ã€‚</p><p><strong>å‚æ•°è¯´æ˜:</strong></p><table><thead><tr><th align="left">å‚æ•°</th><th align="left">è§£é‡Š(jiffies)</th></tr></thead><tbody><tr><td align="left">userï¼ˆ<code>6001460</code>ï¼‰</td><td align="left">ä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ï¼Œå¤„äºç”¨æˆ·æ€çš„è¿è¡Œæ—¶é—´ï¼Œä¸åŒ…å«niceå€¼ä¸ºè´Ÿè¿›ç¨‹</td></tr><tr><td align="left">niceï¼ˆ<code>37043</code>ï¼‰</td><td align="left">ä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ï¼Œniceå€¼ä¸ºè´Ÿçš„è¿›ç¨‹æ‰€å ç”¨çš„CPUæ—¶é—´</td></tr><tr><td align="left">systemï¼ˆ<code>95525758</code>ï¼‰</td><td align="left">ä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ï¼Œæ ¸å¿ƒæ—¶é—´</td></tr><tr><td align="left">idleï¼ˆ<code>277280659</code>ï¼‰</td><td align="left">ä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ï¼Œé™¤IOç­‰å¾…æ—¶é—´ä»¥å¤–å…¶å®ƒç­‰å¾…æ—¶é—´</td></tr><tr><td align="left">iowaitï¼ˆ<code>904849</code>ï¼‰</td><td align="left">ä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ï¼ŒIOç­‰å¾…æ—¶é—´</td></tr><tr><td align="left">irqï¼ˆ<code>0</code>ï¼‰</td><td align="left">ä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ï¼Œç¡¬ä¸­æ–­æ—¶é—´</td></tr><tr><td align="left">softirqï¼ˆ<code>200629</code>ï¼‰</td><td align="left">ä»ç³»ç»Ÿå¯åŠ¨å¼€å§‹ç´¯è®¡åˆ°å½“å‰æ—¶åˆ»ï¼Œè½¯ä¸­æ–­æ—¶é—´</td></tr><tr><td align="left">stealstolenï¼ˆ<code>0</code>ï¼‰</td><td align="left">which is the time spent in other operating systems when running in a virtualized environment(since 2.6.11)</td></tr><tr><td align="left">guestï¼ˆ<code>0</code>ï¼‰</td><td align="left">which is the time spent running a virtual  CPU  for  guest operating systems under the control of the Linux kernel(since 2.6.24)</td></tr></tbody></table><h2 id="æ€»çš„CPUä½¿ç”¨ç‡è®¡ç®—"><a href="#æ€»çš„CPUä½¿ç”¨ç‡è®¡ç®—" class="headerlink" title="æ€»çš„CPUä½¿ç”¨ç‡è®¡ç®—"></a><strong>æ€»çš„CPUä½¿ç”¨ç‡è®¡ç®—</strong></h2><p>è®¡ç®—æ–¹æ³•ï¼š</p><ul><li>1ã€é‡‡ç”¨ä¸¤ä¸ªè¶³å¤Ÿç”¨æ®µçš„æ—¶é—´é—´éš”çš„CPUå¿«ç…§ï¼Œt1,t2ã€‚ï¼ˆuser,nice,system,idleï¼‰</li><li>2ã€è®¡ç®—æ€»çš„CPUæ—¶é—´ç‰‡totalCPUTime<ul><li>a)ã€t1çš„CPUä½¿ç”¨æƒ…å†µï¼Œæ±‚å’Œs1;</li><li>b)ã€t2çš„CPUä½¿ç”¨æƒ…å†µï¼Œæ±‚å’Œs2;</li><li>c)ã€s2-s1å¾—åˆ°æ—¶é—´é—´éš”çš„æ‰€æœ‰æ—¶é—´ç‰‡ï¼Œå³totalCPUTime = s2-s1;</li></ul></li><li>3ã€è®¡ç®—ä½¿ç”¨æ—¶é—´(usr+system)<ul><li>a)ã€t1çš„ä½¿ç”¨æƒ…å†µï¼Œu1 = (user+system).</li><li>b)ã€t2çš„ä½¿ç”¨æƒ…å†µï¼Œu2 = (user+system).</li><li>c)ã€u2-u1å¾—åˆ°æ—¶é—´é—´éš”çš„ä½¿ç”¨æ—¶é—´ç‰‡ï¼Œå³useCPUTime = u2-u1;</li></ul></li><li>4ã€è®¡ç®—ä½¿ç”¨ç‡<ul><li>pcpu = 100*(userCPUTime)/totalCPUTime;</li></ul></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CPU_JIFFIES</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">20</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> user;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> nice;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> system;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> idle;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_cpu_jiffies</span><span class="params">(struct CPU_JIFFIES *jiffies)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    FILE *fp = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> buff[<span class="number">1024</span>] =&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    fp = fopen(<span class="string">"/proc/stat"</span>,<span class="string">"r"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!fp)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"error\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    fgets(buff, <span class="keyword">sizeof</span>(buff), fp);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sscanf</span>(buff, <span class="string">"%s %u %u %u %u"</span>,jiffies-&gt;name, &amp;(jiffies-&gt;user), &amp;(jiffies-&gt;nice), &amp;(jiffies-&gt;system), &amp;(jiffies-&gt;idle));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s %u %u %u %u\n"</span>, jiffies-&gt;name, jiffies-&gt;user, jiffies-&gt;nice, jiffies-&gt;system, jiffies-&gt;idle);</span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span>  <span class="title">cal_pcpu</span><span class="params">(struct CPU_JIFFIES e, struct CPU_JIFFIES s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">double</span> et, st;</span><br><span class="line">    <span class="keyword">double</span> eu, su;</span><br><span class="line">    <span class="keyword">double</span> idle ; </span><br><span class="line"></span><br><span class="line">    et = (<span class="keyword">double</span>)(e.user + e.nice + e.system + e.idle);</span><br><span class="line">    st = (<span class="keyword">double</span>)(s.user + s.nice + s.system + s.idle);</span><br><span class="line"></span><br><span class="line">    idle = (<span class="keyword">double</span>)(e.idle-s.idle);</span><br><span class="line"></span><br><span class="line">    eu = (<span class="keyword">double</span>)(e.user + e.system);</span><br><span class="line">    su = (<span class="keyword">double</span>)(s.user + s.system);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"et:%f st:%f eu:%f su:%f\n"</span>,et, st, eu,su );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%f\n"</span>,(<span class="number">100</span>*(eu-su))/(et-st));</span><br><span class="line">    <span class="keyword">return</span> (<span class="number">100</span>*(et-st-idle))/(et-st);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">CPU_JIFFIES</span> <span class="title">s</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">CPU_JIFFIES</span> <span class="title">e</span>;</span></span><br><span class="line">    <span class="keyword">int</span> pcpu=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    get_cpu_jiffies(&amp;s);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    get_cpu_jiffies(&amp;e);</span><br><span class="line">    </span><br><span class="line">    pcpu = (<span class="keyword">int</span>)cal_pcpu(e,s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, pcpu);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TOP å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">top</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/note_0c/02.png" alt></p></div><p>å†…å­˜ä½¿ç”¨<br>freeå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">free</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/note_0c/03.png" alt></p></div><p>å¤‡æ³¨ï¼š</p><ul><li>1ï¼ä¸åŒå†…æ ¸ç‰ˆæœ¬/proc/statæ–‡ä»¶æ ¼å¼ä¸å¤§ä¸€è‡´ã€‚/proc/statæ–‡ä»¶ä¸­ç¬¬ä¸€è¡Œä¸ºæ€»çš„cpuä½¿ç”¨æƒ…å†µã€‚<br>  å„ä¸ªç‰ˆæœ¬éƒ½æœ‰çš„4ä¸ªå­—æ®µ: <code>user</code>ã€<code>nice</code>ã€<code>system</code>ã€<code>idle</code><br>  2.5.41ç‰ˆæœ¬æ–°å¢å­—æ®µï¼š<code>iowait</code><br>  2.6.0-test4æ–°å¢å­—æ®µï¼š<code>irq</code>ã€<code>softirq</code><br>  2.6.11æ–°å¢å­—æ®µï¼š<code>stealstolen</code>ï¼šwhich is the time spent in other operating systems when running in a virtualized environment<br>  2.6.24æ–°å¢å­—æ®µï¼š<code>guest</code>ï¼šwhich is the time spent running a virtual  CPU  for  guest operating systems under the control of the Linux kernel</li><li>2ï¼/proc/pid/taskç›®å½•æ˜¯Linux 2.6.0-test6ä¹‹åæ‰æœ‰çš„åŠŸèƒ½ã€‚</li><li>3ï¼å…³äºå‡ºç°cpuä½¿ç”¨ç‡ä¸ºè´Ÿçš„æƒ…å†µï¼Œç›®å‰æƒ³åˆ°çš„è§£å†³æ–¹æ¡ˆæ˜¯å¦‚æœå‡ºç°è´Ÿå€¼ï¼Œè¿ç»­é‡‡æ ·è®¡ç®—cpuä½¿ç”¨ç‡ç›´åˆ°ä¸ºéè´Ÿã€‚</li><li>4ï¼æœ‰äº›çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸè¾ƒçŸ­,å¯èƒ½åœ¨æˆ‘ä»¬é‡‡æ ·æœŸé—´å°±å·²ç»æ­»æ‰äº†.</li></ul>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> cpu </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>socketå‡½æ•° å‡ ç§ä¸åŒçš„å¥—æ¥å­—ä½¿ç”¨</title>
      <link href="/2018/06/04/%E7%AC%94%E8%AE%B0/04socket%E5%87%BD%E6%95%B0/"/>
      <url>/2018/06/04/%E7%AC%94%E8%AE%B0/04socket%E5%87%BD%E6%95%B0/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>bits/socket.h</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Protocol families.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_UNSPEC   0   <span class="comment">/* Unspecified.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_LOCAL    1   <span class="comment">/* Local to host (pipes and file-domain).  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_UNIX     PF_LOCAL <span class="comment">/* POSIX name for PF_LOCAL.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_FILE     PF_LOCAL <span class="comment">/* Another non-standard name for PF_LOCAL.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_INET     2   <span class="comment">/* IP protocol family.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_AX25     3   <span class="comment">/* Amateur Radio AX.25.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_IPX      4   <span class="comment">/* Novell Internet Protocol.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_APPLETALK    5   <span class="comment">/* Appletalk DDP.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_NETROM   6   <span class="comment">/* Amateur radio NetROM.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_BRIDGE   7   <span class="comment">/* Multiprotocol bridge.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_ATMPVC   8   <span class="comment">/* ATM PVCs.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_X25      9   <span class="comment">/* Reserved for X.25 project.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_INET6    10  <span class="comment">/* IP version 6.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_ROSE     11  <span class="comment">/* Amateur Radio X.25 PLP.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_DECnet   12  <span class="comment">/* Reserved for DECnet project.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_NETBEUI  13  <span class="comment">/* Reserved for 802.2LLC project.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_SECURITY 14  <span class="comment">/* Security callback pseudo AF.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_KEY      15  <span class="comment">/* PF_KEY key management API.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_NETLINK  16</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_ROUTE    PF_NETLINK <span class="comment">/* Alias to emulate 4.4BSD.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_PACKET   17  <span class="comment">/* Packet family.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_ASH      18  <span class="comment">/* Ash.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_ECONET   19  <span class="comment">/* Acorn Econet.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_ATMSVC   20  <span class="comment">/* ATM SVCs.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_RDS      21  <span class="comment">/* RDS sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_SNA      22  <span class="comment">/* Linux SNA Project */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_IRDA     23  <span class="comment">/* IRDA sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_PPPOX    24  <span class="comment">/* PPPoX sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_WANPIPE  25  <span class="comment">/* Wanpipe API sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_LLC      26  <span class="comment">/* Linux LLC.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_CAN      29  <span class="comment">/* Controller Area Network.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_TIPC     30  <span class="comment">/* TIPC sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_BLUETOOTH    31  <span class="comment">/* Bluetooth sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_IUCV     32  <span class="comment">/* IUCV sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_RXRPC    33  <span class="comment">/* RxRPC sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_ISDN     34  <span class="comment">/* mISDN sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_PHONET   35  <span class="comment">/* Phonet sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_IEEE802154   36  <span class="comment">/* IEEE 802.15.4 sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_CAIF     37  <span class="comment">/* CAIF sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_ALG      38  <span class="comment">/* Algorithm sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_NFC      39  <span class="comment">/* NFC sockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_VSOCK    40  <span class="comment">/* vSockets.  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PF_MAX      41  <span class="comment">/* For now..  */</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Address families.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_UNSPEC   PF_UNSPEC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_LOCAL    PF_LOCAL</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_UNIX     PF_UNIX</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_FILE     PF_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_INET     PF_INET</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_AX25     PF_AX25</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_IPX      PF_IPX</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_APPLETALK    PF_APPLETALK</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_NETROM   PF_NETROM</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_BRIDGE   PF_BRIDGE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_ATMPVC   PF_ATMPVC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_X25      PF_X25</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_INET6    PF_INET6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_ROSE     PF_ROSE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_DECnet   PF_DECnet</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_NETBEUI  PF_NETBEUI</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_SECURITY PF_SECURITY</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_KEY      PF_KEY</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_NETLINK  PF_NETLINK</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_ROUTE    PF_ROUTE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_PACKET   PF_PACKET</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_ASH      PF_ASH</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_ECONET   PF_ECONET</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_ATMSVC   PF_ATMSVC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_RDS      PF_RDS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_SNA      PF_SNA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_IRDA     PF_IRDA</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_PPPOX    PF_PPPOX</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_WANPIPE  PF_WANPIPE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_LLC      PF_LLC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_CAN      PF_CAN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_TIPC     PF_TIPC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_BLUETOOTH    PF_BLUETOOTH</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_IUCV     PF_IUCV</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_RXRPC    PF_RXRPC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_ISDN     PF_ISDN</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_PHONET   PF_PHONET</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_IEEE802154   PF_IEEE802154</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_CAIF     PF_CAIF</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_ALG      PF_ALG</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_NFC      PF_NFC</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_VSOCK    PF_VSOCK</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AF_MAX      PF_MAX</span></span><br></pre></td></tr></table></figure><p>AF_xxåœ°å€ç°‡ï¼ŒBF_xxåè®®ç°‡<br>AF_xx ä¸ BF_xxå€¼ç›¸åŒ</p><p>é€šå¸¸PF_INETè¡¨ç¤ºäº’è”ç½‘åè®®ç°‡ï¼ˆTCP/IPåè®®ç°‡ï¼‰ï¼›æˆ–è€…PF_PACKETåè®®æ ˆï¼ˆåº•å±‚æ•°æ®åŒ…æ¥å£ï¼‰</p><p>ä¸åŒçš„AF_xxæˆ–BF_xxéœ€è¦çš„ç›®çš„ç»“æ„ä¸åŒ</p><p>å‡½æ•°åŸå‹<br>int socket(int domain, int type, int protocol);</p><p><code>domain</code>:åè®®åŸŸï¼Œåˆç§°åè®®ç°‡(family)ã€‚å¸¸ç”¨çš„åè®®ç°‡æœ‰AF_INET,AF_INET6ï¼ŒAF_LOCAL(æˆ–ç§°AF_UNIX,UNIXåŸŸSocket)ã€AF_ROUTEã€‚åè®®ç°‡å†³å®šSocketçš„åœ°å€ç±»å‹ã€‚åœ¨é€šä¿¡ä¸­å¿…é¡»é‡‡ç”¨å¯¹åº”çš„åœ°å€ï¼Œå¦‚AF_INETå†³å®šäº†è¦ç”¨ipv4åœ°å€(32ä½)ä¸ç«¯å£å·(16ä½)çš„ç»„åˆã€AF_UNIXå†³å®šäº†è¦ç”¨ä¸€ä¸ªç»å¯¹è·¯å¾„åä½œä¸ºåœ°å€ã€‚</p><p><code>type</code>:æŒ‡å®šSocketç±»å‹ã€‚å¸¸ç”¨çš„socketç±»å‹æœ‰SOCK_STREAM(ç”¨äºTCP)ã€SOCK_DGRAMï¼ˆç”¨äºUDPï¼‰ã€SOCK_RAWï¼ˆICMP,IGMPï¼‰ã€SOCK_PACKETã€SOCK_SEQPACKETã€FA_PACKET.</p><p><code>protocol</code>ï¼šæŒ‡å®šåè®®ã€‚å¸¸ç”¨çš„åè®®æœ‰IPPROTO_TCPã€IPPROTO_UDPã€IPPROTO_STCPã€IPPROTO_TIPCã€‚åˆ†åˆ«å¯¹åº”TCPä¼ è¾“åè®®ã€UDPä¼ è¾“åè®®ã€STCPä¼ è¾“åè®®ã€TIPCä¼ è¾“åè®®ã€‚</p><p>é“¾è·¯å±‚å¥—æ¥å­—ï¼šPF_PACKET<br>è¯¥å¥—æ¥å­—çš„æ‰“å¼€éœ€è¦ç”¨æˆ·rootæƒé™ã€‚</p><p>å…¶ä¸­socket typeæœ‰ä¸¤ç§ç±»å‹SOCK_RAW,SOCK_DGRAMã€‚<br><code>SOCK_RAW</code>:å®ƒåŒ…å«äº†MACå±‚å¤´éƒ¨ä¿¡æ¯çš„åŸå§‹åˆ†ç»„ï¼Œå½“ç„¶è¿™ç§ç±»å‹çš„å¥—æ¥å­—åœ¨å‘é€çš„æ—¶å€™éœ€è¦è‡ªå·±åŠ ä¸Šä¸€ä¸ªMACå¤´éƒ¨ï¼ˆä»¥å¤ªç½‘å¤´éƒ¨ï¼Œå…¶ç±»å‹å®šä¹‰åœ¨linux/if_ether.hä¸­ethhdrï¼‰ã€‚åº”ç”¨ï¼šdhcpcä¸­æ¥æ”¶æ¥è‡ªDHCPæœåŠ¡å™¨æ•°æ®æ—¶åˆ›å»ºè¯¥å¥—æ¥å­—ã€‚portocolä¸ºï¼šhtons(ETH_P_IP)ã€‚ struct sockaddr_ll sock;<br><code>SOCK_DGRAM</code>:å®ƒå·²ç»è¿›è¡Œäº†MACå±‚å¤´éƒ¨å¤„ç†çš„ï¼Œå³æ”¶åˆ°çš„å¸§å·²ç»å»æ‰äº†å¤´éƒ¨ã€‚åº”ç”¨ï¼šdhcpcåœ¨å‘é€Discoverç­‰æŠ¥æ–‡æ—¶ä½¿ç”¨è¯¥ç±»å‹åˆ›å»ºå¥—æ¥å­—ï¼Œå¯æ— éœ€æ·»åŠ ä»¥å¤ªç½‘å¤´éƒ¨ï¼Œåªéœ€æ·»åŠ IPå¤´éƒ¨ã€UDPå¤´éƒ¨å’ŒDataã€‚portocolä¸ºï¼šhtons(ETH_P_IP)ã€‚</p><p><code>protocol</code>æ˜¯æŒ‡å…¶é€äº¤çš„ä¸Šå±‚çš„åè®®å¥½ï¼Œå¦‚IPä¸º0x0800.å½“å…¶ä¸ºhtons(ETH_P_ALL)ï¼ˆå…¶å®å®šä¹‰ä¸º0ï¼‰æ—¶è¡¨ç¤ºæ”¶å‘æ‰€æœ‰åè®®ã€‚</p><p>åˆ›å»ºå¥½å¥—æ¥å­—åï¼Œå°±å¯ä»¥é€šè¿‡UDPä¸€æ ·çš„recvformå’Œsendtoå‡½æ•°è¿›è¡Œæ•°æ®çš„æ”¶å‘ï¼Œå…¶ç›®çš„çš„åœ°å€ç»“æ„sockaddr_llã€‚è¿™ä¸ä¼ è¾“å±‚çš„åœ°å€ç»“æ„å®šä¹‰æ˜¯ä¸ä¸€æ ·çš„ï¼Œå…¶é•¿åº¦ä¸º20å­—èŠ‚ã€‚ï¼ˆåœ¨TCP/IPçš„é“¾è·¯å±‚åœ°å€ä¸­ä½¿ç”¨18å­—èŠ‚ï¼‰ï¼Œè€Œä¼ è¾“å±‚é¢ç»“æ„é•¿åº¦ä¸º16å­—èŠ‚ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> sll_family; <span class="comment">// æ€»æ˜¯AF_INET</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> sll_protocol; <span class="comment">//ç‰©ç†å±‚çš„åè®®</span></span><br><span class="line">    <span class="keyword">int</span> sll_ifindex; <span class="comment">// æ¥å£å·</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> sll_hatype; <span class="comment">// æŠ¥æ–‡ç±»å‹</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> sll_pkttype; <span class="comment">// åˆ†ç»„ç±»å‹</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> sll_halen;   <span class="comment">// åœ°å€é•¿åº¦</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> sll_addr[<span class="number">8</span>]; <span class="comment">//ç‰©ç†å±‚åœ°å€</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>eg:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAC_BCAST_ADDR (unsigned char *) <span class="meta-string">"\xff\xff\xff\xff\xff\xff"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// dhcp discover</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dhcp_discover</span><span class="params">(...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    fd = socket(PF_PACKET,SOCK_DGRAM,htons(ETH_P_IP));</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_ll</span> <span class="title">dest</span>;</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;dest,<span class="number">0</span>,<span class="keyword">sizeof</span>(dest));</span><br><span class="line">    dest.sll_family = AF_PACKET;</span><br><span class="line">    dest.sll_protocol = htons(ETH_P_IP);</span><br><span class="line">    dest.sll_ifindex = ifindex; <span class="comment">// éšæœºæ•°</span></span><br><span class="line">    dest.sll_halen = <span class="number">6</span>;</span><br><span class="line">    <span class="built_in">memcpy</span>(dest.sll_addr,MAC_BCAST_ADDR,<span class="number">6</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒèµ„æ–™ï¼š<br>1ã€<a href="http://blog.csdn.net/luchengtao11/article/details/76635669" target="_blank" rel="noopener">raw_socketä»¥åŠæ™®é€šsocketä½¿ç”¨ç»ˆææ€»ç»“</a><br>2ã€<a href="http://blog.csdn.net/ttyttytty12/article/details/8141910" target="_blank" rel="noopener">socketå»ºç«‹</a></p>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> socket </tag>
            
            <tag> å¥—æ¥å­— </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Linuxå†…æ ¸Socketå®ç°</title>
      <link href="/2018/05/30/%E7%AC%94%E8%AE%B0/0bLinux%E5%86%85%E6%A0%B8Socket%E5%AE%9E%E7%8E%B0/"/>
      <url>/2018/05/30/%E7%AC%94%E8%AE%B0/0bLinux%E5%86%85%E6%A0%B8Socket%E5%AE%9E%E7%8E%B0/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>å†…æ ¸ç‰ˆæœ¬2.6.36</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  System call vectors.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  Argument checking cleaned up. Saved 20% in size.</span></span><br><span class="line"><span class="comment"> *  This function doesn't need to set the kernel lock because</span></span><br><span class="line"><span class="comment"> *  it is set by the callees.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE2(socketcall, <span class="keyword">int</span>, call, <span class="keyword">unsigned</span> <span class="keyword">long</span> __user *, args)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> a[<span class="number">6</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> a0, a1;</span><br><span class="line">    <span class="keyword">int</span> err;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> len;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (call &lt; <span class="number">1</span> || call &gt; SYS_RECVMMSG)</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    len = nargs[call];</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="keyword">sizeof</span>(a))</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* copy_from_user should be SMP safe. */</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(a, args, len))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    audit_socketcall(nargs[call] / <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">long</span>), a);</span><br><span class="line"></span><br><span class="line">    a0 = a[<span class="number">0</span>];</span><br><span class="line">    a1 = a[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (call) &#123;</span><br><span class="line">    <span class="keyword">case</span> SYS_SOCKET:</span><br><span class="line">        err = sys_socket(a0, a1, a[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_BIND:</span><br><span class="line">        err = sys_bind(a0, (struct sockaddr __user *)a1, a[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_CONNECT:</span><br><span class="line">        err = sys_connect(a0, (struct sockaddr __user *)a1, a[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_LISTEN:</span><br><span class="line">        err = sys_listen(a0, a1);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_ACCEPT:</span><br><span class="line">        err = sys_accept4(a0, (struct sockaddr __user *)a1,</span><br><span class="line">                  (<span class="keyword">int</span> __user *)a[<span class="number">2</span>], <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_GETSOCKNAME:</span><br><span class="line">        err =</span><br><span class="line">            sys_getsockname(a0, (struct sockaddr __user *)a1,</span><br><span class="line">                    (<span class="keyword">int</span> __user *)a[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_GETPEERNAME:</span><br><span class="line">        err =</span><br><span class="line">            sys_getpeername(a0, (struct sockaddr __user *)a1,</span><br><span class="line">                    (<span class="keyword">int</span> __user *)a[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_SOCKETPAIR:</span><br><span class="line">        err = sys_socketpair(a0, a1, a[<span class="number">2</span>], (<span class="keyword">int</span> __user *)a[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_SEND:</span><br><span class="line">        err = sys_send(a0, (<span class="keyword">void</span> __user *)a1, a[<span class="number">2</span>], a[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_SENDTO:</span><br><span class="line">        err = sys_sendto(a0, (<span class="keyword">void</span> __user *)a1, a[<span class="number">2</span>], a[<span class="number">3</span>],</span><br><span class="line">                 (struct sockaddr __user *)a[<span class="number">4</span>], a[<span class="number">5</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_RECV:</span><br><span class="line">        err = sys_recv(a0, (<span class="keyword">void</span> __user *)a1, a[<span class="number">2</span>], a[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_RECVFROM:</span><br><span class="line">        err = sys_recvfrom(a0, (<span class="keyword">void</span> __user *)a1, a[<span class="number">2</span>], a[<span class="number">3</span>],</span><br><span class="line">                   (struct sockaddr __user *)a[<span class="number">4</span>],</span><br><span class="line">                   (<span class="keyword">int</span> __user *)a[<span class="number">5</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_SHUTDOWN:</span><br><span class="line">        err = sys_shutdown(a0, a1);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_SETSOCKOPT:</span><br><span class="line">        err = sys_setsockopt(a0, a1, a[<span class="number">2</span>], (<span class="keyword">char</span> __user *)a[<span class="number">3</span>], a[<span class="number">4</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_GETSOCKOPT:</span><br><span class="line">        err =</span><br><span class="line">            sys_getsockopt(a0, a1, a[<span class="number">2</span>], (<span class="keyword">char</span> __user *)a[<span class="number">3</span>],</span><br><span class="line">                   (<span class="keyword">int</span> __user *)a[<span class="number">4</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_SENDMSG:</span><br><span class="line">        err = sys_sendmsg(a0, (struct msghdr __user *)a1, a[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_RECVMSG:</span><br><span class="line">        err = sys_recvmsg(a0, (struct msghdr __user *)a1, a[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_RECVMMSG:</span><br><span class="line">        err = sys_recvmmsg(a0, (struct mmsghdr __user *)a1, a[<span class="number">2</span>], a[<span class="number">3</span>],</span><br><span class="line">                   (struct timespec __user *)a[<span class="number">4</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SYS_ACCEPT4:</span><br><span class="line">        err = sys_accept4(a0, (struct sockaddr __user *)a1,</span><br><span class="line">                  (<span class="keyword">int</span> __user *)a[<span class="number">2</span>], a[<span class="number">3</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        err = -EINVAL;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>              <span class="comment">/* __ARCH_WANT_SYS_SOCKETCALL */</span></span></span><br></pre></td></tr></table></figure><div class="menu"></div><h2 id="ä¸€ã€åˆ›å»ºSocket"><a href="#ä¸€ã€åˆ›å»ºSocket" class="headerlink" title="ä¸€ã€åˆ›å»ºSocket"></a><strong>ä¸€ã€åˆ›å»ºSocket</strong></h2><p>ã€€ã€€Socketå†…æ ¸è°ƒç”¨æ•°SYSCALL_DEFINE3ï¼š<br>ã€€ã€€Socketçš„åˆ›å»ºæ˜¯åœ¨ç”¨æˆ·ç©ºé—´è°ƒç”¨socketç³»ç»Ÿå‡½æ•°å®Œæˆçš„ï¼Œåˆ›å»ºä¸€ä¸ªSocketè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦fdï¼Œå†…æ ¸çš„ç³»ç»Ÿè°ƒç”¨æ¥å£ä¸ºSYSCALL_DEFINE3(socket, int, family, int, type, int, protocol)ï¼Œåœ¨net/socket.cæ–‡ä»¶ä¸­ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹å†…æ ¸ä¸­çš„æºç å®ç°ã€‚</p><h3 id="1ã€SYSCALL-DEFINE3-socket-â€¦"><a href="#1ã€SYSCALL-DEFINE3-socket-â€¦" class="headerlink" title="1ã€SYSCALL_DEFINE3(socket,â€¦)"></a><strong>1ã€SYSCALL_DEFINE3(socket,â€¦)</strong></h3><p>SYSCALL_DEFINE3(<code>socket</code>, int, family, int, type, int, protocol)  // net/socket.c    line:1272</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(`socket`, <span class="keyword">int</span>, family, <span class="keyword">int</span>, type, <span class="keyword">int</span>, protocol)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> retval;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line"><span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Check the SOCK_* constants for consistency.  */</span></span><br><span class="line"><span class="comment">//è¿›è¡Œå„ç§æ£€æŸ¥æ“ä½œ</span></span><br><span class="line">BUILD_BUG_ON(SOCK_CLOEXEC != O_CLOEXEC);</span><br><span class="line">BUILD_BUG_ON((SOCK_MAX | SOCK_TYPE_MASK) != SOCK_TYPE_MASK);</span><br><span class="line">BUILD_BUG_ON(SOCK_CLOEXEC &amp; SOCK_TYPE_MASK);</span><br><span class="line">BUILD_BUG_ON(SOCK_NONBLOCK &amp; SOCK_TYPE_MASK);</span><br><span class="line"></span><br><span class="line">flags = type &amp; ~SOCK_TYPE_MASK;</span><br><span class="line"><span class="keyword">if</span> (flags &amp; ~(SOCK_CLOEXEC | SOCK_NONBLOCK))</span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line">type &amp;= SOCK_TYPE_MASK;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (SOCK_NONBLOCK != O_NONBLOCK &amp;&amp; (flags &amp; SOCK_NONBLOCK))</span><br><span class="line">flags = (flags &amp; ~SOCK_NONBLOCK) | O_NONBLOCK;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨åˆ›å»ºsocketçš„å‡½æ•°</span></span><br><span class="line">retval = `sock_create`(family, type, protocol, &amp;sock);    <span class="comment">// è¯¦è§----ç¬¬ä¸€ç« ç¬¬2èŠ‚</span></span><br><span class="line"><span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">retval = `sock_map_fd`(sock, flags &amp; (O_CLOEXEC | O_NONBLOCK));  <span class="comment">//è¯¦è§----ç¬¬ä¸€ç« ç¬¬6èŠ‚</span></span><br><span class="line"><span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> out_release;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line"><span class="comment">/* It may be already another descriptor 8) Not kernel problem. */</span></span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">out_release:</span><br><span class="line">sock_release(sock);</span><br><span class="line"><span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2ã€sock-createå‡½æ•°"><a href="#2ã€sock-createå‡½æ•°" class="headerlink" title="2ã€sock_createå‡½æ•°"></a><strong>2ã€sock_createå‡½æ•°</strong></h3><p><code>sock_create</code>  // net/socket.c  line:1260</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_create</span><span class="params">(<span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol, struct socket **res)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">return</span> `__sock_create`(current-&gt;nsproxy-&gt;net_ns, family, type, protocol, res, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœŸæ­£å®ç°å‡½æ•°__sock_create();</p><p><code>__sock_create</code>å‡½æ•°å®ç°  // net/socket.c  line 1147</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __sock_create(struct net *net, <span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol, struct socket **res, <span class="keyword">int</span> kern)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> *<span class="title">pf</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Check protocol is in range</span></span><br><span class="line"><span class="comment"> *`æ£€æŸ¥åè®®çš„èŒƒå›´ï¼Œç°åœ¨å†…æ ¸å®šä¹‰çš„æœ€å¤§èŒƒå›´ä¸º38ï¼Œè¿™é‡Œçš„familyæŒ‡çš„æ˜¯`</span></span><br><span class="line"><span class="comment"> *`AF_INET6ï¼ŒAF_INETåè®®ç°‡`</span></span><br><span class="line"><span class="comment"> *`#define NPROTO      AF_MAX  //include/linux/net.h`</span></span><br><span class="line"><span class="comment"> *`#define AF_MAX      38  // For now.. `</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (family &lt; <span class="number">0</span> || family &gt;= NPROTO)</span><br><span class="line"><span class="keyword">return</span> -EAFNOSUPPORT;</span><br><span class="line"><span class="keyword">if</span> (type &lt; <span class="number">0</span> || type &gt;= SOCK_MAX)  <span class="comment">//`typeï¼š socketçš„ç±»å‹ eg:SOCK_STREAM`</span></span><br><span class="line"><span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Compatibility.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   This uglymoron is moved from INET layer to here to avoid</span></span><br><span class="line"><span class="comment">   deadlock in module load.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (family == PF_INET &amp;&amp; type == SOCK_PACKET) &#123; <span class="comment">// å¦‚æœsoeket type ä¸ºSOCK_PACKETï¼Œéœ€è¦é‡æ–°ç»™familyèµ‹å€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> warned; <span class="comment">//é»˜è®¤åˆå§‹åŒ–ä¸º0</span></span><br><span class="line"><span class="keyword">if</span> (!warned) &#123;</span><br><span class="line">warned = <span class="number">1</span>;</span><br><span class="line">printk(KERN_INFO <span class="string">"%s uses obsolete (PF_INET,SOCK_PACKET)\n"</span>,</span><br><span class="line">       current-&gt;comm);</span><br><span class="line">&#125;</span><br><span class="line">family = PF_PACKET; <span class="comment">//èµ‹å€¼ä¸ºPF_PACKET</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = security_socket_create(family, type, protocol, kern);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Allocate the socket and allow the family to set things up. if</span></span><br><span class="line"><span class="comment"> *the protocol is 0, the family is instructed to select an appropriate</span></span><br><span class="line"><span class="comment"> *default.</span></span><br><span class="line"><span class="comment"> *`è°ƒç”¨sock_allocåˆ†é…sock`</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">sock = `sock_alloc`();</span><br><span class="line"><span class="keyword">if</span> (!sock) &#123;</span><br><span class="line"><span class="keyword">if</span> (net_ratelimit())</span><br><span class="line">printk(KERN_WARNING <span class="string">"socket: no more sockets\n"</span>);</span><br><span class="line"><span class="keyword">return</span> -ENFILE;<span class="comment">/* Not exactly a match, but its the</span></span><br><span class="line"><span class="comment">   closest posix thing */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sock-&gt;type = type;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULES</span></span><br><span class="line"><span class="comment">/* Attempt to load a protocol module if the find failed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 12/09/1996 Marcin: But! this makes REALLY only sense, if the user</span></span><br><span class="line"><span class="comment"> * requested real, full-featured networking support upon configuration.</span></span><br><span class="line"><span class="comment"> * Otherwise module support will break!</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (net_families[family] == <span class="literal">NULL</span>)</span><br><span class="line">request_module(<span class="string">"net-pf-%d"</span>, family);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">rcu_read_lock();</span><br><span class="line">pf = rcu_dereference(net_families[family]);</span><br><span class="line">err = -EAFNOSUPPORT;</span><br><span class="line"><span class="keyword">if</span> (!pf)</span><br><span class="line"><span class="keyword">goto</span> out_release;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We will call the -&gt;create function, that possibly is in a loadable</span></span><br><span class="line"><span class="comment"> * module, so we have to bump that loadable module refcnt first.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!try_module_get(pf-&gt;owner))</span><br><span class="line"><span class="keyword">goto</span> out_release;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Now protected by module ref count */</span></span><br><span class="line">rcu_read_unlock();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * static const struct net_proto_family inet_family_ops = &#123;</span></span><br><span class="line"><span class="comment"> *.family = PF_INET,</span></span><br><span class="line"><span class="comment"> *.create = inet_create,</span></span><br><span class="line"><span class="comment"> *.owner= THIS_MODULE,</span></span><br><span class="line"><span class="comment"> *&#125;; //net/ipv4/af_inet.c</span></span><br><span class="line"><span class="comment"> *`æ ¹æ®æ³¨å†Œçš„familyç±»å‹ï¼Œè°ƒç”¨ä¸åŒçš„createå‡½æ•°ï¼Œè¿™é‡Œå°±æ˜¯è°ƒç”¨inet_ctreateã€‚`</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">err = pf-&gt;`create`(net, sock, protocol, kern);</span><br><span class="line"><span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> out_module_put;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Now to bump the refcnt of the [loadable] module that owns this</span></span><br><span class="line"><span class="comment"> * socket at sock_release time we decrement its refcnt.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!try_module_get(sock-&gt;ops-&gt;owner))</span><br><span class="line"><span class="keyword">goto</span> out_module_busy;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Now that we're done with the -&gt;create function, the [loadable]</span></span><br><span class="line"><span class="comment"> * module can have its refcnt decremented</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">module_put(pf-&gt;owner);</span><br><span class="line">err = security_socket_post_create(sock, family, type, protocol, kern);</span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">goto</span> out_sock_release;</span><br><span class="line">`*res = sock`;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_module_busy:</span><br><span class="line">err = -EAFNOSUPPORT;</span><br><span class="line">out_module_put:</span><br><span class="line">sock-&gt;ops = <span class="literal">NULL</span>;</span><br><span class="line">module_put(pf-&gt;owner);</span><br><span class="line">out_sock_release:</span><br><span class="line">sock_release(sock);</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">out_release:</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="keyword">goto</span> out_sock_release;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3ã€sock-allocå‡½æ•°"><a href="#3ã€sock-allocå‡½æ•°" class="headerlink" title="3ã€sock_allocå‡½æ•°"></a><strong>3ã€sock_allocå‡½æ•°</strong></h3><p>ã€€ã€€sock_allocå‡½æ•°ç”¨äºåˆ†é…ä¸€ä¸ªsocketç»“æ„ä½“ï¼Œè¿™è¿™é‡Œæ¶‰åŠäº†inodeç»“æ„ä»¥åŠåœ¨åˆ†é…å®Œæˆåè¿”å›çš„åœ°å€æŒ‡é’ˆã€‚<br><code>sock_alloc</code>  // net/socket.c   line:471</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *sock_alloc-allocate a socket</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *Allocate a new inode and socket object. The two are bound together</span></span><br><span class="line"><span class="comment"> *and initialised. The socket is then returned. If we are out of inodes</span></span><br><span class="line"><span class="comment"> *NULL is returned.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct socket *<span class="title">sock_alloc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/*ä¸‹é¢çš„new_inode_pseudoå‡½æ•°æ˜¯åˆ†é…ä¸€ä¸ªæ–°çš„inodeç»“æ„ä½“ï¼Œä½†åœ¨å®é™…åˆ†é…è¿‡ç¨‹ä¸­ï¼Œåˆ†é…äº†ä¸€ä¸ªsocket_allocç»“æ„ä½“ï¼Œè¿”å›dçš„æ˜¯inodeåœ°å€ï¼Œ</span></span><br><span class="line"><span class="comment"> *struct socket_alloc &#123;</span></span><br><span class="line"><span class="comment">     *struct socket socket;</span></span><br><span class="line"><span class="comment">     *struct inode vfs_inode;</span></span><br><span class="line"><span class="comment"> *&#125;; //include/net/sock.h</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">inode = `new_inode(sock_mnt-&gt;mnt_sb)`; <span class="comment">// new_inode è¯¦è§ fs/inode.cä¸­å®ç°,sock_mntä»€ä¹ˆæ—¶å€™åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">if</span> (!inode)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* SOCKET_I</span></span><br><span class="line"><span class="comment"> * static inline struct socket *SOCKET_I(struct inode *inode)</span></span><br><span class="line"><span class="comment">  *&#123;</span></span><br><span class="line"><span class="comment">  *  return &amp;container_of(inode, struct socket_alloc, vfs_inode)-&gt;socket;</span></span><br><span class="line"><span class="comment"> *&#125;//include/net/sock.h</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *#define container_of(ptr, type, member) (&#123;\</span></span><br><span class="line"><span class="comment">   *const typeof( ((type *)0)-&gt;member ) *__mptr = (ptr);\</span></span><br><span class="line"><span class="comment">   *(type *)( (char *)__mptr - offsetof(type,member) );&#125;)</span></span><br><span class="line"><span class="comment">   *#endif  //drivers/staging/rtl8192e/ieee80211.h</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">sock = SOCKET_I(inode); <span class="comment">// è¯¥å®æ ¹æ®è¿”å›çš„inodeè·å–åˆ°åˆ†é…çš„socket_allocæŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">kmemcheck_annotate_bitfield(sock, type);</span><br><span class="line"><span class="comment">/* inodeå˜é‡è¿›è¡Œåˆå§‹åŒ–æ“ä½œ */</span></span><br><span class="line">inode-&gt;i_mode = S_IFSOCK | S_IRWXUGO;</span><br><span class="line">inode-&gt;i_uid = current_fsuid(); <span class="comment">// ç”¨æˆ·IDï¼Œåœ¨åé¢è°ƒç”¨bindç³»ç»Ÿè°ƒç”¨æ—¶ä¼šè¿›è¡Œå¯¹æ¯”</span></span><br><span class="line">inode-&gt;i_gid = current_fsgid(); <span class="comment">// ç»„ID</span></span><br><span class="line"></span><br><span class="line">percpu_add(sockets_in_use, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">return</span> sock;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-1ã€sock-mnt-gt-mnt-sbçš„èµ‹å€¼åˆ†é…è¿‡ç¨‹"><a href="#3-1ã€sock-mnt-gt-mnt-sbçš„èµ‹å€¼åˆ†é…è¿‡ç¨‹" class="headerlink" title="3.1ã€sock_mnt-&gt;mnt_sbçš„èµ‹å€¼åˆ†é…è¿‡ç¨‹"></a><strong>3.1ã€sock_mnt-&gt;mnt_sbçš„èµ‹å€¼åˆ†é…è¿‡ç¨‹</strong></h4><p>ã€€ã€€åœ¨sock_initå‡½æ•°ä¸­å¯¹socketç±»å‹çš„æ–‡ä»¶ç³»ç»Ÿè¿›è¡Œæ³¨å†Œ<br><code>sock_mnt</code>   // net/sock.c  line:316</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> *`<span class="title">sock_mnt</span>` __<span class="title">read_mostly</span>;</span></span><br></pre></td></tr></table></figure><p>ã€€ã€€sock_mntæ•°æ®ç±»å‹ä¸ºç»“æ„ä½“  vfsmount;<br><code>vfsmount</code>ç»“æ„ä½“ include/linux/mount.h     line:49</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> &#123;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_hash</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> *<span class="title">mnt_parent</span>;</span><span class="comment">/* fs we are mounted on */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">mnt_mountpoint</span>;</span><span class="comment">/* dentry of mountpoint */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">mnt_root</span>;</span><span class="comment">/* root of the mounted tree */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">super_block</span> *`<span class="title">mnt_sb</span>`;</span><span class="comment">/* pointer to superblock */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_mounts</span>;</span><span class="comment">/* list of children, anchored here */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_child</span>;</span><span class="comment">/* and going through their mnt_child */</span></span><br><span class="line"><span class="keyword">int</span> mnt_flags;</span><br><span class="line"><span class="comment">/* 4 bytes hole on 64bits arches without fsnotify */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_FSNOTIFY</span></span><br><span class="line">__u32 mnt_fsnotify_mask;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span> <span class="title">mnt_fsnotify_marks</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *mnt_devname;<span class="comment">/* Name of device e.g. /dev/dsk/hda1 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_list</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_expire</span>;</span><span class="comment">/* link in fs-specific expiry list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_share</span>;</span><span class="comment">/* circular list of shared mounts */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_slave_list</span>;</span><span class="comment">/* list of slave mounts */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">mnt_slave</span>;</span><span class="comment">/* slave list entry */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vfsmount</span> *<span class="title">mnt_master</span>;</span><span class="comment">/* slave is on master-&gt;mnt_slave_list */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mnt_namespace</span> *<span class="title">mnt_ns</span>;</span><span class="comment">/* containing namespace */</span></span><br><span class="line"><span class="keyword">int</span> mnt_id;<span class="comment">/* mount identifier */</span></span><br><span class="line"><span class="keyword">int</span> mnt_group_id;<span class="comment">/* peer group identifier */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * We put mnt_count &amp; mnt_expiry_mark at the end of struct vfsmount</span></span><br><span class="line"><span class="comment"> * to let these frequently modified fields in a separate cache line</span></span><br><span class="line"><span class="comment"> * (so that reads of mnt_flags wont ping-pong on SMP machines)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">atomic_t</span> mnt_count;</span><br><span class="line"><span class="keyword">int</span> mnt_expiry_mark;<span class="comment">/* true if marked for expiry */</span></span><br><span class="line"><span class="keyword">int</span> mnt_pinned;</span><br><span class="line"><span class="keyword">int</span> mnt_ghosts;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line"><span class="keyword">int</span> __percpu *mnt_writers;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">int</span> mnt_writers;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span> <span class="title">sock_fs_type</span> = &#123;</span></span><br><span class="line">.name =<span class="string">"sockfs"</span>,</span><br><span class="line">.get_sb =sockfs_get_sb,</span><br><span class="line">.kill_sb =kill_anon_super,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>sock_init</code>å‡½æ•°  //  net/socket.c   line:2392</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">sock_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *      Initialize sock SLAB cache.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">sk_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *      Initialize skbuff SLAB cache</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">skb_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *      Initialize the protocols module.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">init_inodecache();</span><br><span class="line"></span><br><span class="line">register_filesystem(&amp;sock_fs_type); <span class="comment">// æ–‡ä»¶ç³»ç»Ÿçš„æ³¨å†Œ</span></span><br><span class="line">sock_mnt = `kern_mount`(&amp;sock_fs_type); <span class="comment">// æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The real protocol initialization is performed in later initcalls.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NETFILTER</span></span><br><span class="line">netfilter_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NETWORK_PHY_TIMESTAMPING</span></span><br><span class="line">skb_timestamping_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="3-2ã€new-inodeå‡½æ•°"><a href="#3-2ã€new-inodeå‡½æ•°" class="headerlink" title="3.2ã€new_inodeå‡½æ•°"></a><strong>3.2ã€new_inodeå‡½æ•°</strong></h4><p>ã€€ã€€new_inodeå‡½æ•°åˆ›å»ºinode,å¹¶åˆå§‹åŒ–inodeçš„i_stateå˜é‡å’Œ<code>inode-&gt;isn_list</code>é“¾è¡¨ï¼Œå®é™…çš„åˆ†é…å‡½æ•°ä¸ºalloc_inodeå‡½æ•°ã€‚fs/inode.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *new_inode - obtain an inode</span></span><br><span class="line"><span class="comment"> *@sb: superblock</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *Allocates a new inode for given superblock. The default gfp_mask</span></span><br><span class="line"><span class="comment"> *for allocations related to inode-&gt;i_mapping is GFP_HIGHUSER_MOVABLE.</span></span><br><span class="line"><span class="comment"> *If HIGHMEM pages are unsuitable or it is known that pages allocated</span></span><br><span class="line"><span class="comment"> *for the page cache are not reclaimable or migratable,</span></span><br><span class="line"><span class="comment"> *mapping_set_gfp_mask() must be called with suitable flags on the</span></span><br><span class="line"><span class="comment"> *newly created inode's mapping</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">struct inode *<span class="title">new_inode</span><span class="params">(struct super_block *sb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On a 32bit, non LFS stat() call, glibc will generate an EOVERFLOW</span></span><br><span class="line"><span class="comment"> * error if st_ino won't fit in target struct field. Use 32bit counter</span></span><br><span class="line"><span class="comment"> * here to attempt to avoid that.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> last_ino;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line"></span><br><span class="line">spin_lock_prefetch(&amp;inode_lock);</span><br><span class="line"></span><br><span class="line">inode = `alloc_inode`(sb);</span><br><span class="line"><span class="keyword">if</span> (inode) &#123;</span><br><span class="line">spin_lock(&amp;inode_lock);</span><br><span class="line">`__inode_add_to_lists`(sb, <span class="literal">NULL</span>, inode);</span><br><span class="line">inode-&gt;i_ino = ++last_ino;</span><br><span class="line">`inode-&gt;i_state` = <span class="number">0</span>;</span><br><span class="line">spin_unlock(&amp;inode_lock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> inode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-2-1ã€alloc-inodeå‡½æ•°"><a href="#3-2-1ã€alloc-inodeå‡½æ•°" class="headerlink" title="3.2.1ã€alloc_inodeå‡½æ•°"></a><em>3.2.1ã€alloc_inodeå‡½æ•°</em></h5><p><code>alloc_inode</code>å‡½æ•°  // fs/inode.c        line:193</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct inode *<span class="title">alloc_inode</span><span class="params">(struct super_block *sb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¦‚æœå½“å‰æ–‡ä»¶ç³»ç»Ÿçš„è¶…çº§å—ï¼Œæœ‰è‡ªå·±çš„åˆ†é…inodeçš„å‡½æ•°ï¼Œåˆ™è°ƒç”¨å®ƒè‡ªå·±çš„åˆ†é…å‡½æ•°ï¼Œå¦åˆ™ä»å…¬ç”¨çš„é«˜é€Ÿç¼“å­˜ä¸­åˆ†é…ä¸€ä¸ªinodeã€‚å¯¹äºsocktæ¥è¯´ï¼Œåœ¨socket.cä¸­ï¼Œè°ƒç”¨çš„å‡½æ•°ä¸ºsock_alloc_inode</span></span><br><span class="line"><span class="comment"> * static const struct super_operations `sockfs_ops` = &#123;</span></span><br><span class="line"><span class="comment"> *.alloc_inode= `sock_alloc_inode`,</span></span><br><span class="line"><span class="comment"> *.destroy_inode= sock_destroy_inode,</span></span><br><span class="line"><span class="comment"> *.statfs= simple_statfs,</span></span><br><span class="line"><span class="comment"> *&#125;;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (sb-&gt;s_op-&gt;alloc_inode)</span><br><span class="line">inode = `sb-&gt;s_op-&gt;alloc_inode`(sb);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">inode = kmem_cache_alloc(inode_cachep, GFP_KERNEL);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!inode)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     *  åˆå§‹åŒ– inodeç»“æ„ä½“</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(inode_init_always(sb, inode))) &#123;</span><br><span class="line"><span class="keyword">if</span> (inode-&gt;i_sb-&gt;s_op-&gt;destroy_inode)</span><br><span class="line">inode-&gt;i_sb-&gt;s_op-&gt;destroy_inode(inode);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">kmem_cache_free(inode_cachep, inode);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> inode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="3-2-1-1ã€sock-alloc-inodeå‡½æ•°"><a href="#3-2-1-1ã€sock-alloc-inodeå‡½æ•°" class="headerlink" title="3.2.1.1ã€sock_alloc_inodeå‡½æ•°"></a><strong>3.2.1.1ã€sock_alloc_inodeå‡½æ•°</strong></h6><p><code>sock_alloc_inode</code>å‡½æ•°     // net/socket.c        line:240</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct inode *<span class="title">sock_alloc_inode</span><span class="params">(struct super_block *sb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket_alloc</span> *<span class="title">ei</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     * kmem_cache_allocåˆ†é…stuct socket_allocç»“æ„ä½“ï¼Œå¦‚ä½•åˆ†é…ï¼Ÿ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ei = `kmem_cache_alloc`(sock_inode_cachep, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!ei)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">ei-&gt;socket.wq = kmalloc(<span class="keyword">sizeof</span>(struct socket_wq), GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!ei-&gt;socket.wq) &#123;</span><br><span class="line">kmem_cache_free(sock_inode_cachep, ei);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">init_waitqueue_head(&amp;ei-&gt;socket.wq-&gt;wait);</span><br><span class="line">ei-&gt;socket.wq-&gt;fasync_list = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">ei-&gt;socket.state = SS_UNCONNECTED;</span><br><span class="line">ei-&gt;socket.flags = <span class="number">0</span>;</span><br><span class="line">ei-&gt;socket.ops = <span class="literal">NULL</span>;</span><br><span class="line">ei-&gt;socket.sk = <span class="literal">NULL</span>;</span><br><span class="line">ei-&gt;socket.file = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &amp;ei-&gt;vfs_inode; <span class="comment">//è¿”å›sturct inode `vfs_inode`;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€€ã€€å¤‡æ³¨ï¼šåœ¨åˆ†é…å‡½æ•°sock_alloc_inodeä¸­è°ƒç”¨äº†<br>ã€€ã€€ei = <code>kmem_cache_alloc</code>(sock_inode_cachep,GFP_KERNEL);è¿™é‡Œåˆ†é…çš„å¤§å°ä¸ºsocket_allocå¤§å°ï¼Œä¸‹é¢åˆ†å®œå¦‚ä½•åˆ†é…è¯¥å¤§å°?  <code>kmem_cache_create</code><br>ã€€ã€€<code>init_inodecache</code>å‡½æ•°ä¸­ï¼ˆnet/socket.cï¼‰ï¼Œå¯¹å…¶è¿›è¡Œé«˜é€Ÿç¼“å­˜çš„åˆ†é…æ“ä½œï¼Œå®šä¹‰åœ¨socket.cæ–‡ä»¶ä¸­ï¼Œè¿™é‡Œåˆ†é…çš„å¤§å°ä¸ºsocket_allocï¼Œä½†æ˜¯è¿”å›æ—¶socket_allocç»“æ„ä½“ä¸­çš„struct indoe vfs_inode;å˜é‡ã€‚è¯¥å‡½æ•°åœ¨sock_initä¸­è¢«è°ƒç”¨ã€‚</p><p><code>init_inodecache</code>å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">init_inodecache</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">sock_inode_cachep = `kmem_cache_create`(<span class="string">"sock_inode_cache"</span>,</span><br><span class="line">      <span class="keyword">sizeof</span>(struct socket_alloc),</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      (SLAB_HWCACHE_ALIGN |</span><br><span class="line">       SLAB_RECLAIM_ACCOUNT |</span><br><span class="line">       SLAB_MEM_SPREAD),</span><br><span class="line">      init_once);</span><br><span class="line"><span class="keyword">if</span> (sock_inode_cachep == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="3-2-2ã€-inode-add-to-listså‡½æ•°"><a href="#3-2-2ã€-inode-add-to-listså‡½æ•°" class="headerlink" title="3.2.2ã€__inode_add_to_listså‡½æ•°"></a><strong>3.2.2ã€__inode_add_to_listså‡½æ•°</strong></h5><p><code>__inode_add_to_lists</code>å‡½æ•°   // fs/inode.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span></span><br><span class="line">__inode_add_to_lists(struct super_block *sb, struct hlist_head *head,</span><br><span class="line">struct inode *inode)</span><br><span class="line">&#123;</span><br><span class="line">inodes_stat.nr_inodes++;</span><br><span class="line">list_add(&amp;inode-&gt;i_list, &amp;inode_in_use);</span><br><span class="line">list_add(&amp;inode-&gt;i_sb_list, &amp;sb-&gt;s_inodes);</span><br><span class="line"><span class="keyword">if</span> (head)</span><br><span class="line">hlist_add_head(&amp;inode-&gt;i_hash, head);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4ã€inet-createå‡½æ•°"><a href="#4ã€inet-createå‡½æ•°" class="headerlink" title="4ã€inet_createå‡½æ•°"></a><strong>4ã€inet_createå‡½æ•°</strong></h3><p>ã€€ã€€åœ¨socket_createå‡½æ•°ä¸­è°ƒç”¨pf-&gt;create,è¿™é‡Œçš„æŒ‡é’ˆä¸ºinet_createã€‚åœ¨æ–‡ä»¶net/ipv4/af_inetä¸­ã€‚<br><code>socket_create</code>  // net/ipv4/af_inet.c        line:268</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Create an inet socket.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">inet_create</span><span class="params">(struct net *net, struct socket *sock, <span class="keyword">int</span> protocol,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">int</span> kern)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> *<span class="title">answer</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proto</span> *<span class="title">answer_prot</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> answer_flags;</span><br><span class="line"><span class="keyword">char</span> answer_no_check;</span><br><span class="line"><span class="keyword">int</span> try_loading_module = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!inet_ehash_secret))</span><br><span class="line"><span class="keyword">if</span> (sock-&gt;type != SOCK_RAW &amp;&amp; sock-&gt;type != SOCK_DGRAM)</span><br><span class="line">build_ehash_secret();</span><br><span class="line"></span><br><span class="line">sock-&gt;state = SS_UNCONNECTED;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Look for the requested type/protocol pair. */</span></span><br><span class="line">lookup_protocol:</span><br><span class="line">err = -ESOCKTNOSUPPORT;</span><br><span class="line">rcu_read_lock();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ä»inetswä¸­æ ¹æ®ç±»å‹ï¼Œåè®®æŸ¥æ‰¾ç›¸åº”çš„socket interfaceå³ inet_protosw *answer;</span></span><br><span class="line"><span class="comment"> *      </span></span><br><span class="line"><span class="comment"> * //  include/linux/rculist.h</span></span><br><span class="line"><span class="comment"> *#define list_for_each_entry_rcu(pos, head, member) \</span></span><br><span class="line"><span class="comment"> *  for (pos = list_entry_rcu((head)-&gt;next, typeof(*pos), member); \</span></span><br><span class="line"><span class="comment"> *       prefetch(pos-&gt;member.next), &amp;pos-&gt;member != (head); \</span></span><br><span class="line"><span class="comment"> *      pos = list_entry_rcu(pos-&gt;member.next, typeof(*pos), member))</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">list_for_each_entry_rcu(answer, &amp;inetsw[sock-&gt;type], <span class="built_in">list</span>) &#123;</span><br><span class="line"></span><br><span class="line">err = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/* Check the non-wild match. */</span></span><br><span class="line"><span class="keyword">if</span> (protocol == answer-&gt;protocol) &#123;</span><br><span class="line"><span class="keyword">if</span> (protocol != IPPROTO_IP)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* Check for the two wild cases. */</span></span><br><span class="line"><span class="keyword">if</span> (IPPROTO_IP == protocol) &#123;</span><br><span class="line">protocol = answer-&gt;protocol;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (IPPROTO_IP == answer-&gt;protocol)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">err = -EPROTONOSUPPORT;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åŠ è½½æ¨¡å— </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(err)) &#123;</span><br><span class="line"><span class="keyword">if</span> (try_loading_module &lt; <span class="number">2</span>) &#123;</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Be more specific, e.g. net-pf-2-proto-132-type-1</span></span><br><span class="line"><span class="comment"> * (net-pf-PF_INET-proto-IPPROTO_SCTP-type-SOCK_STREAM)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (++try_loading_module == <span class="number">1</span>)</span><br><span class="line">request_module(<span class="string">"net-pf-%d-proto-%d-type-%d"</span>,</span><br><span class="line">       PF_INET, protocol, sock-&gt;type);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Fall back to generic, e.g. net-pf-2-proto-132</span></span><br><span class="line"><span class="comment"> * (net-pf-PF_INET-proto-IPPROTO_SCTP)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">request_module(<span class="string">"net-pf-%d-proto-%d"</span>,</span><br><span class="line">       PF_INET, protocol);</span><br><span class="line"><span class="keyword">goto</span> lookup_protocol;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line"><span class="keyword">goto</span> out_rcu_unlock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = -EPERM;</span><br><span class="line"><span class="keyword">if</span> (sock-&gt;type == SOCK_RAW &amp;&amp; !kern &amp;&amp; !capable(CAP_NET_RAW))</span><br><span class="line"><span class="keyword">goto</span> out_rcu_unlock;</span><br><span class="line"></span><br><span class="line">err = -EAFNOSUPPORT;</span><br><span class="line"><span class="keyword">if</span> (!inet_netns_ok(net, protocol))</span><br><span class="line"><span class="keyword">goto</span> out_rcu_unlock;</span><br><span class="line"></span><br><span class="line">sock-&gt;ops = answer-&gt;ops;</span><br><span class="line">answer_prot = answer-&gt;prot;</span><br><span class="line">answer_no_check = answer-&gt;no_check;</span><br><span class="line">answer_flags = answer-&gt;flags;</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">WARN_ON(answer_prot-&gt;slab == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">err = -ENOBUFS;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sk_allocè¡¨é¢ä¸Šçœ‹æ˜¯ç”Ÿæˆsockçš„ç»“æ„ä½“ï¼Œä½†æ˜¯å®é™…ä¸Šå¯¹äºtcpæ¥è¯´æ˜¯tcp_sockçš„å¤§å°çš„ç»“æ„ä½“ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨inet_sk(sk);è¿›è¡Œå¼ºåˆ¶çš„ç±»å‹è½¬æ¢ï¼Œå…·ä½“å¦‚ä½•åˆ†é…tcp_sockå¤§å°ï¼Ÿ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">sk = `sk_alloc`(net, PF_INET, GFP_KERNEL, answer_prot);</span><br><span class="line"><span class="keyword">if</span> (sk == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">err = <span class="number">0</span>;</span><br><span class="line">sk-&gt;sk_no_check = answer_no_check;</span><br><span class="line"><span class="keyword">if</span> (INET_PROTOSW_REUSE &amp; answer_flags)</span><br><span class="line">sk-&gt;sk_reuse = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">inet = inet_sk(sk);</span><br><span class="line">inet-&gt;is_icsk = (INET_PROTOSW_ICSK &amp; answer_flags) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">inet-&gt;nodefrag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (SOCK_RAW == sock-&gt;type) &#123;</span><br><span class="line">inet-&gt;inet_num = protocol;</span><br><span class="line"><span class="keyword">if</span> (IPPROTO_RAW == protocol)</span><br><span class="line">inet-&gt;hdrincl = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ipv4_config.no_pmtu_disc)</span><br><span class="line">inet-&gt;pmtudisc = IP_PMTUDISC_DONT;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">inet-&gt;pmtudisc = IP_PMTUDISC_WANT;</span><br><span class="line"></span><br><span class="line">inet-&gt;inet_id = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * skç»“æ„ä½“å˜é‡è¿›è¡Œåˆå§‹åŒ–ã€‚</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">`sock_init_data`(sock, sk);</span><br><span class="line"></span><br><span class="line">sk-&gt;sk_destruct   = inet_sock_destruct;</span><br><span class="line">sk-&gt;sk_protocol   = protocol;</span><br><span class="line">sk-&gt;sk_backlog_rcv = sk-&gt;sk_prot-&gt;backlog_rcv;</span><br><span class="line"></span><br><span class="line">inet-&gt;uc_ttl= <span class="number">-1</span>;</span><br><span class="line">inet-&gt;mc_loop= <span class="number">1</span>;</span><br><span class="line">inet-&gt;mc_ttl= <span class="number">1</span>;</span><br><span class="line">inet-&gt;mc_all= <span class="number">1</span>;</span><br><span class="line">inet-&gt;mc_index= <span class="number">0</span>;</span><br><span class="line">inet-&gt;mc_list= <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">sk_refcnt_debug_inc(sk);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (inet-&gt;inet_num) &#123;</span><br><span class="line"><span class="comment">/* It assumes that any protocol which allows</span></span><br><span class="line"><span class="comment"> * the user to assign a number at socket</span></span><br><span class="line"><span class="comment"> * creation time automatically</span></span><br><span class="line"><span class="comment"> * shares.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">inet-&gt;inet_sport = htons(inet-&gt;inet_num);</span><br><span class="line"><span class="comment">/* Add to protocol hash chains. */</span></span><br><span class="line">sk-&gt;sk_prot-&gt;hash(sk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sk-&gt;sk_prot-&gt;init) &#123;</span><br><span class="line">err = `sk-&gt;sk_prot-&gt;init(sk)`; <span class="comment">//å¦‚æœtcp  è¿™é‡Œä¸ºtcp_v4_init_sock</span></span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line">sk_common_release(sk);</span><br><span class="line">&#125;</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">out_rcu_unlock:</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-1ã€sk-allocå‡½æ•°"><a href="#4-1ã€sk-allocå‡½æ•°" class="headerlink" title="4.1ã€sk_allocå‡½æ•°"></a><strong>4.1ã€sk_allocå‡½æ•°</strong></h4><p><code>sk_alloc</code>å‡½æ•°  // net/core/sock.c        line:1096</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *sk_alloc - All socket objects are allocated here</span></span><br><span class="line"><span class="comment"> *@net: the applicable net namespace</span></span><br><span class="line"><span class="comment"> *@family: protocol family</span></span><br><span class="line"><span class="comment"> *@priority: for allocation (%GFP_KERNEL, %GFP_ATOMIC, etc)</span></span><br><span class="line"><span class="comment"> *@prot: struct proto associated with this new sock instance</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">struct sock *<span class="title">sk_alloc</span><span class="params">(struct net *net, <span class="keyword">int</span> family, <span class="keyword">gfp_t</span> priority,</span></span></span><br><span class="line"><span class="function"><span class="params">      struct proto *prot)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line"></span><br><span class="line">sk = `sk_prot_alloc`(prot, priority | __GFP_ZERO, family);</span><br><span class="line"><span class="keyword">if</span> (sk) &#123;</span><br><span class="line">sk-&gt;sk_family = family;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * See comment in struct sock definition to understand</span></span><br><span class="line"><span class="comment"> * why we need sk_prot_creator -acme</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">sk-&gt;sk_prot = sk-&gt;sk_prot_creator = prot;</span><br><span class="line">sock_lock_init(sk);</span><br><span class="line">sock_net_set(sk, get_net(net));</span><br><span class="line">atomic_set(&amp;sk-&gt;sk_wmem_alloc, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">sock_update_classid(sk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> sk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="4-1-1ã€sk-prot-allocå‡½æ•°"><a href="#4-1-1ã€sk-prot-allocå‡½æ•°" class="headerlink" title="4.1.1ã€sk_prot_allocå‡½æ•°"></a><strong>4.1.1ã€sk_prot_allocå‡½æ•°</strong></h5><p><code>sk_prot_alloc</code>å‡½æ•°        //net/core/sock.c    line:1012</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct sock *<span class="title">sk_prot_alloc</span><span class="params">(struct `proto *prot`, <span class="keyword">gfp_t</span> priority,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="keyword">int</span> family)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab</span>;</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">      * ä¸‹é¢åˆ†é…å†…å­˜ç©ºé—´æ—¶ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼š`1`ã€ä»é«˜é€Ÿç¼“å†²ä¸­åˆ†é…ï¼Œ`2`ã€æ™®é€šçš„åˆ†é…</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">`slab = prot-&gt;slab`;</span><br><span class="line"><span class="keyword">if</span> (slab != <span class="literal">NULL</span>) &#123;</span><br><span class="line">sk = `kmem_cache_alloc`(slab, priority &amp; ~__GFP_ZERO);  <span class="comment">// ç¬¬ä¸€ç§åˆ†é…æ–¹å¼</span></span><br><span class="line"><span class="keyword">if</span> (!sk)</span><br><span class="line"><span class="keyword">return</span> sk;</span><br><span class="line"><span class="keyword">if</span> (priority &amp; __GFP_ZERO) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * caches using SLAB_DESTROY_BY_RCU should let</span></span><br><span class="line"><span class="comment"> * sk_node.next un-modified. Special care is taken</span></span><br><span class="line"><span class="comment"> * when initializing object to zero.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (offsetof(struct sock, sk_node.next) != <span class="number">0</span>)</span><br><span class="line"><span class="built_in">memset</span>(sk, <span class="number">0</span>, offsetof(struct sock, sk_node.next));</span><br><span class="line"><span class="built_in">memset</span>(&amp;sk-&gt;sk_node.pprev, <span class="number">0</span>,</span><br><span class="line">       prot-&gt;obj_size - offsetof(struct sock,</span><br><span class="line"> sk_node.pprev));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">sk = `kmalloc`(prot-&gt;obj_size, priority);  <span class="comment">//ç¬¬äºŒç§åˆ†é…æ–¹å¼</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sk != <span class="literal">NULL</span>) &#123;</span><br><span class="line">kmemcheck_annotate_bitfield(sk, flags);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (security_sk_alloc(sk, family, priority))</span><br><span class="line"><span class="keyword">goto</span> out_free;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!try_module_get(prot-&gt;owner))</span><br><span class="line"><span class="keyword">goto</span> out_free_sec;</span><br><span class="line">sk_tx_queue_clear(sk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> sk;</span><br><span class="line"></span><br><span class="line">out_free_sec:</span><br><span class="line">security_sk_free(sk);</span><br><span class="line">out_free:</span><br><span class="line"><span class="keyword">if</span> (slab != <span class="literal">NULL</span>)</span><br><span class="line">kmem_cache_free(slab, sk);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">kfree(sk);</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€€ã€€sk_prot_allocå‡½æ•°ä¸­åŒ…æ‹¬å†…å­˜ç©ºé—´çš„åˆ†é…è¿‡ç¨‹ï¼Œå­˜åœ¨ä¸¤ç§åˆ†é…æ–¹å¼ï¼Œè€Œç¬¬ä¸€ç§åˆ†é…æ–¹å¼æ¶‰åŠåˆ°slabæ˜¯å¦ä¸ºç©ºï¼Œslab=prot-&gt;slab;è€Œprotä¸ºsk_prot_allocçš„ä¼ å…¥å‚æ•°ï¼Œå…¶ç»“æ„ä½“ä¸ºstruct proto *prot;  sk_prot_allocå‚æ•°protç”±sk_allocä¼ å…¥ï¼Œsk_allocå‚æ•°prot ä¸ºinet_create å‡½æ•°å‡ºå…¥çš„answer_protï¼›answer_prot = answer-&gt;protï¼Œå³sk_prot_allocä¸­çš„protä¸ºinet_createä¸­çš„answerç»“æ„ä½“é‡çš„protæˆå‘˜å˜é‡ã€‚answerä¸ºinet_createå‡½æ•°ä¸­å˜é‡ï¼Œå…¶ç»“æ„ä½“ä¸ºstruct inet_protosw *answer;å…³äºansweråˆå§‹åŒ–èµ‹å€¼list_for_each_entry_rcuï¼›<a href="#wow_1_5"><code>è¯¦çœ‹ç¬¬5å°ç»“</code></a>ã€‚<br>ã€€ã€€ç¬¬äºŒç§å†…å­˜åˆ†é…æœºåˆ¶ï¼šä¸»è¦æ˜¯prot-&gt;obj_size;å°±æ˜¯struct proto tcp_protä¸­åˆå§‹åŒ–çš„.obj_size = sizeof(struct tcp_sock); ã€‚ sk = kmalloc(prot-&gt;obj_size,priority);<br>ã€€ã€€ä¸‹å›¾ä¸º5ä¸ªç›¸å…³çš„æ•°æ®ç»“æ„ï¼Œtcp_sockç»“æ„ä½“å ç”¨çš„ç©ºé—´æ˜¯æœ€å¤§çš„ï¼Œæ‰€æœ‰åœ¨åˆ†é…å†…å­˜æ§ä»¶æ˜¯ï¼Œéƒ½æ˜¯åˆ†é…çš„tcp_sockçš„å¤§å°ï¼Œè¿™æ ·åœ¨åé¢è¿›è¡Œå¼ºåˆ¶è½¬æ¢çš„è¿‡ç¨‹ä¸­å¯ä»¥ä¿è¯æ­£ç¡®ï¼š</p><div align="center">![](/img/note_0b/01.png)</div><h4 id="4-2ã€sock-init-dataå‡½æ•°"><a href="#4-2ã€sock-init-dataå‡½æ•°" class="headerlink" title="4.2ã€sock_init_dataå‡½æ•°"></a><strong>4.2ã€sock_init_dataå‡½æ•°</strong></h4><p><code>sock_init_data</code>å‡½æ•°    // net/core/sock.c   line:1937</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sock_init_data</span><span class="params">(struct socket *sock, struct sock *sk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">skb_queue_head_init(&amp;sk-&gt;sk_receive_queue);</span><br><span class="line">skb_queue_head_init(&amp;sk-&gt;sk_write_queue);</span><br><span class="line">skb_queue_head_init(&amp;sk-&gt;sk_error_queue);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_DMA</span></span><br><span class="line">skb_queue_head_init(&amp;sk-&gt;sk_async_wait_queue);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">sk-&gt;sk_send_head=<span class="literal">NULL</span>;</span><br><span class="line">   </span><br><span class="line">init_timer(&amp;sk-&gt;sk_timer); <span class="comment">// åˆå§‹åŒ–skå®šæ—¶å™¨</span></span><br><span class="line"></span><br><span class="line">sk-&gt;sk_allocation=GFP_KERNEL;</span><br><span class="line">sk-&gt;sk_rcvbuf=sysctl_rmem_default;</span><br><span class="line">sk-&gt;sk_sndbuf=sysctl_wmem_default;</span><br><span class="line">sk-&gt;sk_state=TCP_CLOSE; <span class="comment">// åˆå§‹åŒ–sk_state = TCP_CLOSEçŠ¶æ€ï¼Œä¸ºåé¢åœ¨ç³»ç»Ÿè°ƒç”¨ä¸­ä¼šè¿›è¡Œåˆ¤æ–­</span></span><br><span class="line">sk_set_socket(sk, sock);  <span class="comment">// sk-&gt;sk_socket = sock; è®¾ç½®skä¸­æŒ‡å‘socketçš„æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">sock_set_flag(sk, SOCK_ZAPPED); <span class="comment">// è®¾ç½® SOCKETçš„flagä½ï¼Œè¡¨æ˜è¯¥socketå·²ç»ç»‘å®šä¸€ä¸ªåå­—ï¼Œè¯¥æ ‡å¿—ä»€ä¹ˆæ„æ€ï¼Ÿ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sock) &#123;</span><br><span class="line">sk-&gt;sk_type=sock-&gt;type;</span><br><span class="line">sk-&gt;sk_wq=sock-&gt;wq;</span><br><span class="line">sock-&gt;sk=sk; </span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line">sk-&gt;sk_wq=<span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">spin_lock_init(&amp;sk-&gt;sk_dst_lock);</span><br><span class="line">rwlock_init(&amp;sk-&gt;sk_callback_lock);</span><br><span class="line">lockdep_set_class_and_name(&amp;sk-&gt;sk_callback_lock,</span><br><span class="line">af_callback_keys + sk-&gt;sk_family,</span><br><span class="line">af_family_clock_key_strings[sk-&gt;sk_family]);</span><br><span class="line"></span><br><span class="line">sk-&gt;sk_state_change=sock_def_wakeup;</span><br><span class="line">sk-&gt;sk_data_ready=sock_def_readable;</span><br><span class="line">sk-&gt;sk_write_space=sock_def_write_space;</span><br><span class="line">sk-&gt;sk_error_report=sock_def_error_report;</span><br><span class="line">sk-&gt;sk_destruct=sock_def_destruct;</span><br><span class="line"></span><br><span class="line">sk-&gt;sk_sndmsg_page=<span class="literal">NULL</span>;</span><br><span class="line">sk-&gt;sk_sndmsg_off=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">sk-&gt;sk_peer_pid =<span class="literal">NULL</span>;</span><br><span class="line">sk-&gt;sk_peer_cred=<span class="literal">NULL</span>;</span><br><span class="line">sk-&gt;sk_write_pending=<span class="number">0</span>;</span><br><span class="line">sk-&gt;sk_rcvlowat=<span class="number">1</span>;</span><br><span class="line">sk-&gt;sk_rcvtimeo=MAX_SCHEDULE_TIMEOUT;</span><br><span class="line">sk-&gt;sk_sndtimeo=MAX_SCHEDULE_TIMEOUT;</span><br><span class="line"></span><br><span class="line">sk-&gt;sk_stamp = ktime_set(<span class="number">-1L</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Before updating sk_refcnt, we must commit prior changes to memory</span></span><br><span class="line"><span class="comment"> * (Documentation/RCU/rculist_nulls.txt for details)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">smp_wmb();</span><br><span class="line">atomic_set(&amp;sk-&gt;sk_refcnt, <span class="number">1</span>); <span class="comment">// skçš„å¼•ç”¨è®¡æ•°+1</span></span><br><span class="line">atomic_set(&amp;sk-&gt;sk_drops, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€€ã€€å¤‡æ³¨ï¼šæ€è€ƒ sock ä¸socket<br>ã€€ã€€å‚è€ƒèµ„æ–™ï¼š<br>ã€€ã€€ã€€ã€€<a href="http://blog.csdn.net/wangpengqi/article/details/9156083" target="_blank" rel="noopener">struct sk_buffä¸struct socketåŠstruct sock ç»“æ„ä½“åˆ†æ</a><br>ã€€ã€€ã€€ã€€<a href="http://www.cnblogs.com/image-eye/archive/2012/01/05/2313383.html" target="_blank" rel="noopener">sockç»“æ„ä½“</a><br>ã€€ã€€ã€€ã€€<a href="http://anders0913.iteye.com/blog/411986" target="_blank" rel="noopener">struct socket ç»“æ„è¯¦è§£</a><br>ã€€ã€€ã€€ã€€<a href="http://blog.51cto.com/weiguozhihui/1585297" target="_blank" rel="noopener">struct socketç»“æ„ä½“è¯¦è§£</a><br>ã€€ã€€ã€€ã€€<a href="http://blog.51cto.com/weiguozhihui/1586777" target="_blank" rel="noopener">struct sk_buffç»“æ„ä½“è¯¦è§£</a></p><h4 id="4-3ã€tcp-v4-init-sockå‡½æ•°"><a href="#4-3ã€tcp-v4-init-sockå‡½æ•°" class="headerlink" title="4.3ã€tcp_v4_init_sockå‡½æ•°"></a><strong>4.3ã€tcp_v4_init_sockå‡½æ•°</strong></h4><p><code>tcp_v4_init_sock</code>å‡½æ•°    // net/ipv4/tcp_ipv4.c    line:1857</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* <span class="doctag">NOTE:</span> A lot of things set to zero explicitly by call to</span></span><br><span class="line"><span class="comment"> *       sk_alloc() so need not be done here.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tcp_v4_init_sock</span><span class="params">(struct sock *sk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> *<span class="title">icsk</span> = <span class="title">inet_csk</span>(<span class="title">sk</span>);</span>  <span class="comment">// å¼ºåˆ¶ç±»å‹è½¬æ¢  return (struct inet_connection_sock *)sk;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span> = <span class="title">tcp_sk</span>(<span class="title">sk</span>);</span> <span class="comment">// `å¼ºåˆ¶ç±»å‹è½¬æ¢  return (struct tcp_sock *)sk`;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  tcp ç›¸å…³å˜é‡åˆå§‹åŒ–å·¥ä½œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">skb_queue_head_init(&amp;tp-&gt;out_of_order_queue);</span><br><span class="line">tcp_init_xmit_timers(sk);</span><br><span class="line">tcp_prequeue_init(tp);</span><br><span class="line"></span><br><span class="line">icsk-&gt;icsk_rto = TCP_TIMEOUT_INIT;</span><br><span class="line">tp-&gt;mdev = TCP_TIMEOUT_INIT;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* So many TCP implementations out there (incorrectly) count the</span></span><br><span class="line"><span class="comment"> * initial SYN frame in their delayed-ACK and congestion control</span></span><br><span class="line"><span class="comment"> * algorithms that we must have the following bandaid to talk</span></span><br><span class="line"><span class="comment"> * efficiently to them.  -DaveM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">tp-&gt;snd_cwnd = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* See draft-stevens-tcpca-spec-01 for discussion of the</span></span><br><span class="line"><span class="comment"> * initialization of these values.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">tp-&gt;snd_ssthresh = TCP_INFINITE_SSTHRESH;</span><br><span class="line">tp-&gt;snd_cwnd_clamp = ~<span class="number">0</span>;</span><br><span class="line">tp-&gt;mss_cache = TCP_MSS_DEFAULT;</span><br><span class="line"></span><br><span class="line">tp-&gt;reordering = sysctl_tcp_reordering;</span><br><span class="line">icsk-&gt;icsk_ca_ops = &amp;tcp_init_congestion_ops;</span><br><span class="line"></span><br><span class="line">sk-&gt;sk_state = TCP_CLOSE;</span><br><span class="line"></span><br><span class="line">sk-&gt;sk_write_space = sk_stream_write_space;</span><br><span class="line">sock_set_flag(sk, SOCK_USE_WRITE_QUEUE);</span><br><span class="line"></span><br><span class="line">icsk-&gt;icsk_af_ops = &amp;ipv4_specific;</span><br><span class="line">icsk-&gt;icsk_sync_mss = tcp_sync_mss;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TCP_MD5SIG</span></span><br><span class="line">tp-&gt;af_specific = &amp;tcp_sock_ipv4_specific;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* TCP Cookie Transactions */</span></span><br><span class="line"><span class="keyword">if</span> (sysctl_tcp_cookie_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">/* Default, cookies without s_data_payload. */</span></span><br><span class="line">tp-&gt;cookie_values =</span><br><span class="line">kzalloc(<span class="keyword">sizeof</span>(*tp-&gt;cookie_values),</span><br><span class="line">sk-&gt;sk_allocation);</span><br><span class="line"><span class="keyword">if</span> (tp-&gt;cookie_values != <span class="literal">NULL</span>)</span><br><span class="line">kref_init(&amp;tp-&gt;cookie_values-&gt;kref);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Presumed zeroed, in order of appearance:</span></span><br><span class="line"><span class="comment"> *cookie_in_always, cookie_out_never,</span></span><br><span class="line"><span class="comment"> *s_data_constant, s_data_in, s_data_out</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">sk-&gt;sk_sndbuf = sysctl_tcp_wmem[<span class="number">1</span>];</span><br><span class="line">sk-&gt;sk_rcvbuf = sysctl_tcp_rmem[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">local_bh_disable();</span><br><span class="line">percpu_counter_inc(&amp;tcp_sockets_allocated);</span><br><span class="line">local_bh_enable();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div align="center"><p><img src="/img/note_0b/02.png" alt></p></div><h3 id="5ã€sk-prot-allocå‚æ•°prot"><a href="#5ã€sk-prot-allocå‚æ•°prot" class="headerlink" title="5ã€sk_prot_allocå‚æ•°prot"></a><strong>5ã€sk_prot_allocå‚æ•°prot</strong></h3><p>ã€€ã€€ç”±ç¬¬4å°ç»“ä¸­çš„sk_prot_allocå‡½æ•°è§£é‡Šï¼Œå¯çŸ¥sk_prot_allocä¸­ä½¿ç”¨çš„protå˜é‡ï¼Œå…¶ä½œä¸ºå‚æ•°ä¼ å…¥ï¼Œæœ€æ—©å®šä¹‰åœ¨inet_createå‡½æ•°ä¸­answerç»“æ„ä½“ã€‚answeråˆå§‹åŒ–è¯¦çœ‹ä»¥ä¸‹ä»£ç <br><code>inet_create</code>å‡½æ•°</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Create an inet socket.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">inet_create</span><span class="params">(struct net *net, struct socket *sock, <span class="keyword">int</span> protocol,</span></span></span><br><span class="line"><span class="function"><span class="params">       <span class="keyword">int</span> kern)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> *<span class="title">answer</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proto</span> *<span class="title">answer_prot</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> answer_flags;</span><br><span class="line"><span class="keyword">char</span> answer_no_check;</span><br><span class="line"><span class="keyword">int</span> try_loading_module = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(!inet_ehash_secret))</span><br><span class="line"><span class="keyword">if</span> (sock-&gt;type != SOCK_RAW &amp;&amp; sock-&gt;type != SOCK_DGRAM)</span><br><span class="line">build_ehash_secret();</span><br><span class="line"></span><br><span class="line">sock-&gt;state = SS_UNCONNECTED;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Look for the requested type/protocol pair. */</span></span><br><span class="line">lookup_protocol:</span><br><span class="line">err = -ESOCKTNOSUPPORT;</span><br><span class="line">rcu_read_lock();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * ä»inetswä¸­æ ¹æ®ç±»å‹ï¼Œåè®®æŸ¥æ‰¾ç›¸åº”çš„socket interfaceå³ inet_protosw *answer;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *//  include/linux/rculist.h</span></span><br><span class="line"><span class="comment"> *#define list_for_each_entry_rcu(pos, head, member) \</span></span><br><span class="line"><span class="comment"> *for (pos = list_entry_rcu((head)-&gt;next, typeof(*pos), member); \</span></span><br><span class="line"><span class="comment"> *prefetch(pos-&gt;member.next), &amp;pos-&gt;member != (head); \</span></span><br><span class="line"><span class="comment"> *pos = list_entry_rcu(pos-&gt;member.next, typeof(*pos), member))</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">`list_for_each_entry_rcu`(answer, &amp;inetsw[sock-&gt;type], <span class="built_in">list</span>) &#123;</span><br><span class="line"></span><br><span class="line">err = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/* Check the non-wild match. */</span></span><br><span class="line"><span class="keyword">if</span> (protocol == answer-&gt;protocol) &#123;</span><br><span class="line"><span class="keyword">if</span> (protocol != IPPROTO_IP)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">/* Check for the two wild cases. */</span></span><br><span class="line"><span class="keyword">if</span> (IPPROTO_IP == protocol) &#123;</span><br><span class="line">protocol = answer-&gt;protocol;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (IPPROTO_IP == answer-&gt;protocol)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">err = -EPROTONOSUPPORT;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åŠ è½½æ¨¡å— </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (unlikely(err)) &#123;</span><br><span class="line"><span class="keyword">if</span> (try_loading_module &lt; <span class="number">2</span>) &#123;</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Be more specific, e.g. net-pf-2-proto-132-type-1</span></span><br><span class="line"><span class="comment"> * (net-pf-PF_INET-proto-IPPROTO_SCTP-type-SOCK_STREAM)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (++try_loading_module == <span class="number">1</span>)</span><br><span class="line">request_module(<span class="string">"net-pf-%d-proto-%d-type-%d"</span>,</span><br><span class="line">       PF_INET, protocol, sock-&gt;type);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Fall back to generic, e.g. net-pf-2-proto-132</span></span><br><span class="line"><span class="comment"> * (net-pf-PF_INET-proto-IPPROTO_SCTP)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">request_module(<span class="string">"net-pf-%d-proto-%d"</span>,</span><br><span class="line">       PF_INET, protocol);</span><br><span class="line"><span class="keyword">goto</span> lookup_protocol;</span><br><span class="line">&#125; <span class="keyword">else</span></span><br><span class="line"><span class="keyword">goto</span> out_rcu_unlock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = -EPERM;</span><br><span class="line"><span class="keyword">if</span> (sock-&gt;type == SOCK_RAW &amp;&amp; !kern &amp;&amp; !capable(CAP_NET_RAW))</span><br><span class="line"><span class="keyword">goto</span> out_rcu_unlock;</span><br><span class="line"></span><br><span class="line">err = -EAFNOSUPPORT;</span><br><span class="line"><span class="keyword">if</span> (!inet_netns_ok(net, protocol))</span><br><span class="line"><span class="keyword">goto</span> out_rcu_unlock;</span><br><span class="line"></span><br><span class="line">sock-&gt;ops = answer-&gt;ops;</span><br><span class="line">answer_prot = answer-&gt;prot;</span><br><span class="line">answer_no_check = answer-&gt;no_check;</span><br><span class="line">answer_flags = answer-&gt;flags;</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"></span><br><span class="line">WARN_ON(answer_prot-&gt;slab == <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">err = -ENOBUFS;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sk_allocè¡¨é¢ä¸Šå¼ç”Ÿæˆsockçš„ç»“æ„ä½“ï¼Œä½†æ˜¯å®é™…ä¸Šå¯¹äºtcpæ¥è¯´æ˜¯tcp_sockçš„å¤§å°çš„ç»“æ„ä½“ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨inet_sk(sk);è¿›è¡Œå¼ºåˆ¶çš„ç±»å‹è½¬æ¢ï¼Œå…·ä½“å¦‚ä½•åˆ†é…tcp_sockå¤§å°ï¼Ÿ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">sk = `sk_alloc`(net, PF_INET, GFP_KERNEL, answer_prot);</span><br><span class="line"><span class="keyword">if</span> (sk == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">err = <span class="number">0</span>;</span><br><span class="line">sk-&gt;sk_no_check = answer_no_check;</span><br><span class="line"><span class="keyword">if</span> (INET_PROTOSW_REUSE &amp; answer_flags)</span><br><span class="line">sk-&gt;sk_reuse = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">inet = inet_sk(sk);</span><br><span class="line">inet-&gt;is_icsk = (INET_PROTOSW_ICSK &amp; answer_flags) != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">inet-&gt;nodefrag = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (SOCK_RAW == sock-&gt;type) &#123;</span><br><span class="line">inet-&gt;inet_num = protocol;</span><br><span class="line"><span class="keyword">if</span> (IPPROTO_RAW == protocol)</span><br><span class="line">inet-&gt;hdrincl = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ipv4_config.no_pmtu_disc)</span><br><span class="line">inet-&gt;pmtudisc = IP_PMTUDISC_DONT;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">inet-&gt;pmtudisc = IP_PMTUDISC_WANT;</span><br><span class="line"></span><br><span class="line">inet-&gt;inet_id = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * skç»“æ„ä½“å˜é‡è¿›è¡Œåˆå§‹åŒ–ã€‚</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">sock_init_data(sock, sk);</span><br><span class="line"></span><br><span class="line">sk-&gt;sk_destruct   = inet_sock_destruct;</span><br><span class="line">sk-&gt;sk_protocol   = protocol;</span><br><span class="line">sk-&gt;sk_backlog_rcv = sk-&gt;sk_prot-&gt;backlog_rcv;</span><br><span class="line"></span><br><span class="line">inet-&gt;uc_ttl= <span class="number">-1</span>;</span><br><span class="line">inet-&gt;mc_loop= <span class="number">1</span>;</span><br><span class="line">inet-&gt;mc_ttl= <span class="number">1</span>;</span><br><span class="line">inet-&gt;mc_all= <span class="number">1</span>;</span><br><span class="line">inet-&gt;mc_index= <span class="number">0</span>;</span><br><span class="line">inet-&gt;mc_list= <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">sk_refcnt_debug_inc(sk);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (inet-&gt;inet_num) &#123;</span><br><span class="line"><span class="comment">/* It assumes that any protocol which allows</span></span><br><span class="line"><span class="comment"> * the user to assign a number at socket</span></span><br><span class="line"><span class="comment"> * creation time automatically</span></span><br><span class="line"><span class="comment"> * shares.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">inet-&gt;inet_sport = htons(inet-&gt;inet_num);</span><br><span class="line"><span class="comment">/* Add to protocol hash chains. */</span></span><br><span class="line">sk-&gt;sk_prot-&gt;hash(sk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sk-&gt;sk_prot-&gt;init) &#123;</span><br><span class="line">err = sk-&gt;sk_prot-&gt;init(sk); <span class="comment">//å¦‚æœtcp  è¿™é‡Œä¸º`tcp_v4_init_sock`</span></span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line">sk_common_release(sk);</span><br><span class="line">&#125;</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">out_rcu_unlock:</span><br><span class="line">rcu_read_unlock();</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€€ã€€list_for_each_entry_rcu(<code>answer</code>, &amp;inetsw[sock-&gt;type], list)ä¸­çš„answerç”±<code>inetsw</code>éå†å¾—å‡ºï¼Œå…¶ä¸­inetswçš„å®šä¹‰ä¸‹é¢ç±»å‹çš„æ•°ç»„å¦‚æœæ˜¯SOCK_STREAMç±»å‹çš„socketï¼Œè¿™é‡Œçš„prot = tcp_prot;<br><code>inetsw_array</code>   // net/ipv4/af_inet.c </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Upon startup we insert all the elements in inetsw_array[] into</span></span><br><span class="line"><span class="comment"> * the linked list inetsw.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> `<span class="title">inetsw_array</span>`[] =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">&#123;</span><br><span class="line">.type =       SOCK_STREAM,</span><br><span class="line">.protocol =   IPPROTO_TCP,</span><br><span class="line">.prot =       &amp;`tcp_prot`,</span><br><span class="line">.ops =        &amp;inet_stream_ops,</span><br><span class="line">.no_check =   <span class="number">0</span>,</span><br><span class="line">.flags =      INET_PROTOSW_PERMANENT |</span><br><span class="line">      INET_PROTOSW_ICSK,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">.type =       SOCK_DGRAM,</span><br><span class="line">.protocol =   IPPROTO_UDP,</span><br><span class="line">.prot =       &amp;udp_prot,</span><br><span class="line">.ops =        &amp;inet_dgram_ops,</span><br><span class="line">.no_check =   UDP_CSUM_DEFAULT,</span><br><span class="line">.flags =      INET_PROTOSW_PERMANENT,</span><br><span class="line">       &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       &#123;</span><br><span class="line">       .type =       SOCK_RAW,</span><br><span class="line">       .protocol =   IPPROTO_IP,<span class="comment">/* wild card */</span></span><br><span class="line">       .prot =       &amp;raw_prot,</span><br><span class="line">       .ops =        &amp;inet_sockraw_ops,</span><br><span class="line">       .no_check =   UDP_CSUM_DEFAULT,</span><br><span class="line">       .flags =      INET_PROTOSW_REUSE,</span><br><span class="line">       &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>tcp_prot</code>  // net/ipv4/tcp_ipv4.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proto</span> `<span class="title">tcp_prot</span>` = &#123;</span></span><br><span class="line">.name= <span class="string">"TCP"</span>,</span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">.close= tcp_close,</span><br><span class="line">.connect= tcp_v4_connect,</span><br><span class="line">.disconnect= tcp_disconnect,</span><br><span class="line">.accept= inet_csk_accept,</span><br><span class="line">.ioctl= tcp_ioctl,</span><br><span class="line">.init= tcp_v4_init_sock,</span><br><span class="line">.destroy= tcp_v4_destroy_sock,</span><br><span class="line">.shutdown= tcp_shutdown,</span><br><span class="line">.setsockopt= tcp_setsockopt,</span><br><span class="line">.getsockopt= tcp_getsockopt,</span><br><span class="line">.recvmsg= tcp_recvmsg,</span><br><span class="line">.sendmsg= tcp_sendmsg,</span><br><span class="line">.sendpage= tcp_sendpage,</span><br><span class="line">.backlog_rcv= tcp_v4_do_rcv,</span><br><span class="line">.hash= inet_hash,</span><br><span class="line">.unhash= inet_unhash,</span><br><span class="line">.get_port= inet_csk_get_port,</span><br><span class="line">.enter_memory_pressure= tcp_enter_memory_pressure,</span><br><span class="line">.sockets_allocated= &amp;tcp_sockets_allocated,</span><br><span class="line">.orphan_count= &amp;tcp_orphan_count,</span><br><span class="line">.memory_allocated= &amp;tcp_memory_allocated,</span><br><span class="line">.memory_pressure= &amp;tcp_memory_pressure,</span><br><span class="line">.sysctl_mem= sysctl_tcp_mem,</span><br><span class="line">.sysctl_wmem= sysctl_tcp_wmem,</span><br><span class="line">.sysctl_rmem= sysctl_tcp_rmem,</span><br><span class="line">.max_header= MAX_TCP_HEADER,</span><br><span class="line">.`obj_size`= <span class="keyword">sizeof</span>(struct tcp_sock),</span><br><span class="line">.slab_flags= SLAB_DESTROY_BY_RCU,</span><br><span class="line">.twsk_prot= &amp;tcp_timewait_sock_ops,</span><br><span class="line">.rsk_prot= &amp;tcp_request_sock_ops,</span><br><span class="line">.h.hashinfo= &amp;tcp_hashinfo,</span><br><span class="line">.no_autobind= <span class="literal">true</span>,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">.compat_setsockopt= compat_tcp_setsockopt,</span><br><span class="line">.compat_getsockopt= compat_tcp_getsockopt,</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>åœ¨inet_initå‡½æ•°ä¸­ï¼ˆaf_inet.cæ–‡ä»¶ï¼‰<br><code>inet_init</code>  // net/ipv4/af_inet.c    line:1609</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __<span class="function">init <span class="title">inet_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sk_buff</span> *<span class="title">dummy_skb</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> *<span class="title">q</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">r</span>;</span></span><br><span class="line"><span class="keyword">int</span> rc = -EINVAL;</span><br><span class="line"></span><br><span class="line">BUILD_BUG_ON(<span class="keyword">sizeof</span>(struct inet_skb_parm) &gt; <span class="keyword">sizeof</span>(dummy_skb-&gt;cb));</span><br><span class="line"></span><br><span class="line">sysctl_local_reserved_ports = kzalloc(<span class="number">65536</span> / <span class="number">8</span>, GFP_KERNEL);</span><br><span class="line"><span class="keyword">if</span> (!sysctl_local_reserved_ports)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">     <span class="comment">// è¯¥å‡½æ•°æ³¨å†Œtcp_protï¼Œåœ¨è¯¥å‡½æ•°ä¸­å¯¹tcp_prot-&gt;slabè¿›è¡Œå†…å­˜åˆ†é…</span></span><br><span class="line">rc = `proto_register`(&amp;tcp_prot, <span class="number">1</span>);  <span class="comment">// è¯¦è§ ---[5.1]</span></span><br><span class="line"><span class="keyword">if</span> (rc)</span><br><span class="line"><span class="keyword">goto</span> out_free_reserved_ports;</span><br><span class="line"></span><br><span class="line">rc = proto_register(&amp;udp_prot, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (rc)</span><br><span class="line"><span class="keyword">goto</span> out_unregister_tcp_proto;</span><br><span class="line"></span><br><span class="line">rc = proto_register(&amp;raw_prot, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (rc)</span><br><span class="line"><span class="keyword">goto</span> out_unregister_udp_proto;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Tell SOCKET that we are alive...</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">void</span>)sock_register(&amp;inet_family_ops);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SYSCTL</span></span><br><span class="line">ip_static_sysctl_init();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Add all the base protocols.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (inet_add_protocol(&amp;icmp_protocol, IPPROTO_ICMP) &lt; <span class="number">0</span>)</span><br><span class="line">printk(KERN_CRIT <span class="string">"inet_init: Cannot add ICMP protocol\n"</span>);</span><br><span class="line"><span class="keyword">if</span> (inet_add_protocol(&amp;udp_protocol, IPPROTO_UDP) &lt; <span class="number">0</span>)</span><br><span class="line">printk(KERN_CRIT <span class="string">"inet_init: Cannot add UDP protocol\n"</span>);</span><br><span class="line"><span class="keyword">if</span> (inet_add_protocol(&amp;tcp_protocol, IPPROTO_TCP) &lt; <span class="number">0</span>)</span><br><span class="line">printk(KERN_CRIT <span class="string">"inet_init: Cannot add TCP protocol\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_IP_MULTICAST</span></span><br><span class="line"><span class="keyword">if</span> (inet_add_protocol(&amp;igmp_protocol, IPPROTO_IGMP) &lt; <span class="number">0</span>)</span><br><span class="line">printk(KERN_CRIT <span class="string">"inet_init: Cannot add IGMP protocol\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Register the socket-side information for inet_create. */</span></span><br><span class="line">    <span class="comment">// `inetsw è¿›è¡Œåˆå§‹åŒ–æ“ä½œ `</span></span><br><span class="line"><span class="keyword">for</span> (r = &amp;inetsw[<span class="number">0</span>]; r &lt; &amp;inetsw[SOCK_MAX]; ++r)</span><br><span class="line">`INIT_LIST_HEAD`(r);  <span class="comment">//è¯¦è§------[5.2]</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">// `å°† inetsw_arrayåŠ å…¥åˆ°å¯¹åº”çš„inetswé“¾è¡¨ä¸­ï¼Œå°±å¯ä»¥åœ¨inet_createå‡½æ•°ä¸­è¿›è¡Œéå†`</span></span><br><span class="line"><span class="keyword">for</span> (q = inetsw_array; q &lt; &amp;inetsw_array[INETSW_ARRAY_LEN]; ++q)</span><br><span class="line">`inet_register_protosw`(q);  <span class="comment">// è¯¦è§------[5.3]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Set the ARP module up</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">arp_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Set the IP module up</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">ip_init();</span><br><span class="line"></span><br><span class="line">tcp_v4_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Setup TCP slab cache for open requests. */</span></span><br><span class="line">tcp_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Setup UDP memory threshold */</span></span><br><span class="line">udp_init();</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Add UDP-Lite (RFC 3828) */</span></span><br><span class="line">udplite4_register();</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Set the ICMP layer up</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (icmp_init() &lt; <span class="number">0</span>)</span><br><span class="line">panic(<span class="string">"Failed to create the ICMP control socket.\n"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Initialise the multicast router</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(CONFIG_IP_MROUTE)</span></span><br><span class="line"><span class="keyword">if</span> (ip_mr_init())</span><br><span class="line">printk(KERN_CRIT <span class="string">"inet_init: Cannot init ipv4 mroute\n"</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Initialise per-cpu ipv4 mibs</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (init_ipv4_mibs())</span><br><span class="line">printk(KERN_CRIT <span class="string">"inet_init: Cannot init ipv4 mibs\n"</span>);</span><br><span class="line"></span><br><span class="line">ipv4_proc_init();</span><br><span class="line"></span><br><span class="line">ipfrag_init();</span><br><span class="line"></span><br><span class="line">dev_add_pack(&amp;ip_packet_type);</span><br><span class="line"></span><br><span class="line">rc = <span class="number">0</span>;</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> rc;</span><br><span class="line">out_unregister_udp_proto:</span><br><span class="line">proto_unregister(&amp;udp_prot);</span><br><span class="line">out_unregister_tcp_proto:</span><br><span class="line">proto_unregister(&amp;tcp_prot);</span><br><span class="line">out_free_reserved_ports:</span><br><span class="line">kfree(sysctl_local_reserved_ports);</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-1ã€proto-register"><a href="#5-1ã€proto-register" class="headerlink" title="*5.1ã€proto_register *"></a>*<em>5.1ã€proto_register *</em></h4><p><code>proto_register</code> æ³¨å†Œå‡½æ•°  // net/core/sock.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">proto_register</span><span class="params">(struct proto *prot, <span class="keyword">int</span> alloc_slab)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (alloc_slab) &#123;</span><br><span class="line">         <span class="comment">// prot-&gt;obj_size ä¸º`.obj = sizeof(struct tcp_sock)`</span></span><br><span class="line">prot-&gt;slab = `kmem_cache_create`(prot-&gt;name, prot-&gt;obj_size, <span class="number">0</span>,</span><br><span class="line">SLAB_HWCACHE_ALIGN | prot-&gt;slab_flags,</span><br><span class="line"><span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (prot-&gt;slab == <span class="literal">NULL</span>) &#123;</span><br><span class="line">printk(KERN_CRIT <span class="string">"%s: Can't create sock SLAB cache!\n"</span>,</span><br><span class="line">       prot-&gt;name);</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (prot-&gt;rsk_prot != <span class="literal">NULL</span>) &#123;</span><br><span class="line">prot-&gt;rsk_prot-&gt;slab_name = kasprintf(GFP_KERNEL, <span class="string">"request_sock_%s"</span>, prot-&gt;name);</span><br><span class="line"><span class="keyword">if</span> (prot-&gt;rsk_prot-&gt;slab_name == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> out_free_sock_slab;</span><br><span class="line"></span><br><span class="line">prot-&gt;rsk_prot-&gt;slab = kmem_cache_create(prot-&gt;rsk_prot-&gt;slab_name,</span><br><span class="line"> prot-&gt;rsk_prot-&gt;obj_size, <span class="number">0</span>,</span><br><span class="line"> SLAB_HWCACHE_ALIGN, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (prot-&gt;rsk_prot-&gt;slab == <span class="literal">NULL</span>) &#123;</span><br><span class="line">printk(KERN_CRIT <span class="string">"%s: Can't create request sock SLAB cache!\n"</span>,</span><br><span class="line">       prot-&gt;name);</span><br><span class="line"><span class="keyword">goto</span> out_free_request_sock_slab_name;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (prot-&gt;twsk_prot != <span class="literal">NULL</span>) &#123;</span><br><span class="line">prot-&gt;twsk_prot-&gt;twsk_slab_name = kasprintf(GFP_KERNEL, <span class="string">"tw_sock_%s"</span>, prot-&gt;name);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (prot-&gt;twsk_prot-&gt;twsk_slab_name == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> out_free_request_sock_slab;</span><br><span class="line"></span><br><span class="line">prot-&gt;twsk_prot-&gt;twsk_slab =</span><br><span class="line">kmem_cache_create(prot-&gt;twsk_prot-&gt;twsk_slab_name,</span><br><span class="line">  prot-&gt;twsk_prot-&gt;twsk_obj_size,</span><br><span class="line">  <span class="number">0</span>,</span><br><span class="line">  SLAB_HWCACHE_ALIGN |</span><br><span class="line">prot-&gt;slab_flags,</span><br><span class="line">  <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span> (prot-&gt;twsk_prot-&gt;twsk_slab == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> out_free_timewait_sock_slab_name;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">write_lock(&amp;proto_list_lock);</span><br><span class="line">list_add(&amp;prot-&gt;node, &amp;proto_list);</span><br><span class="line">assign_proto_idx(prot);</span><br><span class="line">write_unlock(&amp;proto_list_lock);</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_free_timewait_sock_slab_name:</span><br><span class="line">kfree(prot-&gt;twsk_prot-&gt;twsk_slab_name);</span><br><span class="line">out_free_request_sock_slab:</span><br><span class="line"><span class="keyword">if</span> (prot-&gt;rsk_prot &amp;&amp; prot-&gt;rsk_prot-&gt;slab) &#123;</span><br><span class="line">kmem_cache_destroy(prot-&gt;rsk_prot-&gt;slab);</span><br><span class="line">prot-&gt;rsk_prot-&gt;slab = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">out_free_request_sock_slab_name:</span><br><span class="line"><span class="keyword">if</span> (prot-&gt;rsk_prot)</span><br><span class="line">kfree(prot-&gt;rsk_prot-&gt;slab_name);</span><br><span class="line">out_free_sock_slab:</span><br><span class="line">kmem_cache_destroy(prot-&gt;slab);</span><br><span class="line">prot-&gt;slab = <span class="literal">NULL</span>;</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> -ENOBUFS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-2ã€INIT-LIST-HEAD"><a href="#5-2ã€INIT-LIST-HEAD" class="headerlink" title="5.2ã€INIT_LIST_HEAD"></a><strong>5.2ã€INIT_LIST_HEAD</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">INIT_LIST_HEAD</span><span class="params">(struct list_head *<span class="built_in">list</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">list</span>-&gt;next = <span class="built_in">list</span>;</span><br><span class="line"><span class="built_in">list</span>-&gt;prev = <span class="built_in">list</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="5-3ã€inet-register-protosw"><a href="#5-3ã€inet-register-protosw" class="headerlink" title="5.3ã€inet_register_protosw"></a><strong>5.3ã€inet_register_protosw</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inet_register_protosw</span><span class="params">(struct inet_protosw *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">lh</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> *<span class="title">answer</span>;</span></span><br><span class="line"><span class="keyword">int</span> protocol = p-&gt;protocol;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">last_perm</span>;</span></span><br><span class="line"></span><br><span class="line">spin_lock_bh(&amp;inetsw_lock);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (p-&gt;type &gt;= SOCK_MAX)</span><br><span class="line"><span class="keyword">goto</span> out_illegal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If we are trying to override a permanent protocol, bail. */</span></span><br><span class="line">answer = <span class="literal">NULL</span>;</span><br><span class="line">last_perm = &amp;inetsw[p-&gt;type];</span><br><span class="line">list_for_each(lh, &amp;inetsw[p-&gt;type]) &#123;</span><br><span class="line">answer = list_entry(lh, struct inet_protosw, <span class="built_in">list</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Check only the non-wild match. */</span></span><br><span class="line"><span class="keyword">if</span> (INET_PROTOSW_PERMANENT &amp; answer-&gt;flags) &#123;</span><br><span class="line"><span class="keyword">if</span> (protocol == answer-&gt;protocol)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">last_perm = lh;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">answer = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (answer)</span><br><span class="line"><span class="keyword">goto</span> out_permanent;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Add the new entry after the last permanent entry if any, so that</span></span><br><span class="line"><span class="comment"> * the new entry does not override a permanent entry when matched with</span></span><br><span class="line"><span class="comment"> * a wild-card protocol. But it is allowed to override any existing</span></span><br><span class="line"><span class="comment"> * non-permanent entry.  This means that when we remove this entry, the</span></span><br><span class="line"><span class="comment"> * system automatically returns to the old behavior.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">list_add_rcu(&amp;p-&gt;<span class="built_in">list</span>, last_perm);</span><br><span class="line">out:</span><br><span class="line">spin_unlock_bh(&amp;inetsw_lock);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">out_permanent:</span><br><span class="line">printk(KERN_ERR <span class="string">"Attempt to override permanent protocol %d.\n"</span>,</span><br><span class="line">       protocol);</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">out_illegal:</span><br><span class="line">printk(KERN_ERR</span><br><span class="line">       <span class="string">"Ignoring attempt to register invalid socket type %d.\n"</span>,</span><br><span class="line">       p-&gt;type);</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div align="center"><p><img src="/img/note_0b/03.png" alt></p></div><h3 id="6ã€sock-map-fdå‡½æ•°"><a href="#6ã€sock-map-fdå‡½æ•°" class="headerlink" title="6ã€sock_map_fdå‡½æ•°"></a><strong>6ã€sock_map_fdå‡½æ•°</strong></h3><p>ã€€ã€€åœ¨ç”¨æˆ·æ§ä»¶æ§ä»¶åˆ›å»ºäº†ä¸€ä¸ªsocketåï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¸‹é¢åˆ†æä¸€ä¸‹åˆ›å»ºsocketæ—¶æ€ä¹ˆå’Œæ–‡ä»¶æè¿°ç¬¦è”ç³»ï¼Œåœ¨SYSCLALL_DEFINE3(socket,int,family,int,<br>type,int,portocol)æœ€åè°ƒç”¨socke_map_fdè¿›è¡Œå…³è”ï¼Œå…¶ä¸­è¿”å›çš„retvalå°±æ˜¯ç”¨æˆ·æ§ä»¶è·å–çš„æ–‡ä»¶æè¿°ç¬¦fd,sockå°±æ˜¯è°ƒç”¨sock_createåˆ›å»ºæˆåŠŸçš„socketã€‚<br>ã€€ã€€sock_map_fd()ä¸»è¦ç”¨äºå¯¹socketçš„<em>fileæŒ‡é’ˆåˆå§‹åŒ–ï¼Œç»è¿‡sock_map_fd()æ“ä½œåï¼Œsocketå°±é€šè¿‡å…¶</em>fileæŒ‡é’ˆä¸VFSç®¡ç†çš„æ–‡ä»¶è¿›è¡Œäº†å…³è”ï¼Œä¾¿å¯ä»¥è¿›è¡Œæ–‡ä»¶çš„å„ç§æ“ä½œï¼Œå¦‚read,write,lessk,ioctlç­‰ã€‚</p><p>ã€€ã€€retval = <code>sock_map_fd</code>(sock,flag&amp;(O_CLOEXEC|O_NOBLOCK));<br><code>sock_map_fd</code>å‡½æ•°   // net/socket.c    line:395</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_map_fd</span><span class="params">(struct socket *sock, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">newfile</span>;</span></span><br><span class="line"><span class="keyword">int</span> fd = `sock_alloc_file`(sock, &amp;newfile, flags);  </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (likely(fd &gt;= <span class="number">0</span>))</span><br><span class="line">fd_install(fd, newfile);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-1ã€sock-alloc-fileå‡½æ•°"><a href="#6-1ã€sock-alloc-fileå‡½æ•°" class="headerlink" title="6.1ã€sock_alloc_fileå‡½æ•°"></a><strong>6.1ã€sock_alloc_fileå‡½æ•°</strong></h4><p><code>sock_alloc_file</code>å‡½æ•°   // net/socket.c        line:354</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Obtains the first available file descriptor and sets it up for use.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *These functions create file structures and maps them to fd space</span></span><br><span class="line"><span class="comment"> *of the current process. On success it returns file descriptor</span></span><br><span class="line"><span class="comment"> *and file struct implicitly stored in sock-&gt;file.</span></span><br><span class="line"><span class="comment"> *Note that another thread may close file descriptor before we return</span></span><br><span class="line"><span class="comment"> *from this function. We use the fact that now we do not refer</span></span><br><span class="line"><span class="comment"> *to socket after mapping. If one day we will need it, this</span></span><br><span class="line"><span class="comment"> *function will increment ref. count on file by 1.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *In any case returned fd MAY BE not valid!</span></span><br><span class="line"><span class="comment"> *This race condition is unavoidable</span></span><br><span class="line"><span class="comment"> *with shared fd spaces, we cannot solve it inside kernel,</span></span><br><span class="line"><span class="comment"> *but we take care of internal coherence yet.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sock_alloc_file</span><span class="params">(struct socket *sock, struct file **f, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">qstr</span> <span class="title">name</span> = &#123;</span> .name = <span class="string">""</span> &#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">path</span> <span class="title">path</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">      *  #define get_unused_fd_flags(flags) `alloc_fd`(0, (flags))</span></span><br><span class="line"><span class="comment">      *  // include/linux/file.h</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">fd = `get_unused_fd_flags`(flags);  </span><br><span class="line"><span class="keyword">if</span> (unlikely(fd &lt; <span class="number">0</span>))</span><br><span class="line"><span class="keyword">return</span> fd;</span><br><span class="line"></span><br><span class="line">path.dentry = d_alloc(sock_mnt-&gt;mnt_sb-&gt;s_root, &amp;name);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!path.dentry)) &#123;</span><br><span class="line">put_unused_fd(fd);</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line">&#125;</span><br><span class="line">path.mnt = mntget(sock_mnt);</span><br><span class="line"></span><br><span class="line">path.dentry-&gt;d_op = &amp;sockfs_dentry_operations;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">      * å°†æ–‡ä»¶æ“ä½œçš„å‡½æ•°ç»‘å®šåˆ°inode,å¯¹äºdentryæ˜¯åœ¨socket_mountå‡½æ•°ä¸­socket_dentry_operationsï¼Œè¯¥å‡½æ•°åœ¨sock_initä¸­è°ƒç”¨</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">d_instantiate(path.dentry, SOCK_INODE(sock));</span><br><span class="line">SOCK_INODE(sock)-&gt;i_fop = &amp;socket_file_ops;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">      * ç”³è¯·æ–°çš„file,å°†pathå’Œfileå…³è”èµ·æ¥</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">file = alloc_file(&amp;path, FMODE_READ | FMODE_WRITE,</span><br><span class="line">  &amp;socket_file_ops);</span><br><span class="line"><span class="keyword">if</span> (unlikely(!file)) &#123;</span><br><span class="line"><span class="comment">/* drop dentry, keep inode */</span></span><br><span class="line">atomic_inc(&amp;path.dentry-&gt;d_inode-&gt;i_count);</span><br><span class="line">path_put(&amp;path);</span><br><span class="line">put_unused_fd(fd);</span><br><span class="line"><span class="keyword">return</span> -ENFILE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sock-&gt;file = file;</span><br><span class="line">file-&gt;f_flags = O_RDWR | (flags &amp; O_NONBLOCK);</span><br><span class="line">file-&gt;f_pos = <span class="number">0</span>;</span><br><span class="line">file-&gt;private_data = sock;</span><br><span class="line"></span><br><span class="line">*f = file;</span><br><span class="line"><span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="6-2ã€get-unused-fd-flagså®å®ç°"><a href="#6-2ã€get-unused-fd-flagså®å®ç°" class="headerlink" title="6.2ã€get_unused_fd_flagså®å®ç°"></a><strong>6.2ã€get_unused_fd_flagså®å®ç°</strong></h4><p><code>get_unused_fd_flags</code> å® // include/linux/file.h    line:36</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> get_unused_fd_flags(flags) alloc_fd(0, (flags))</span></span><br></pre></td></tr></table></figure><p><code>alloc_fd</code>å‡½æ•° // fs/file.c        line:427</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * allocate a file descriptor, mark it busy.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">alloc_fd</span><span class="params">(<span class="keyword">unsigned</span> start, <span class="keyword">unsigned</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> *<span class="title">files</span> = <span class="title">current</span>-&gt;<span class="title">files</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">int</span> error;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> *<span class="title">fdt</span>;</span></span><br><span class="line"></span><br><span class="line">spin_lock(&amp;files-&gt;file_lock);</span><br><span class="line">repeat:</span><br><span class="line"><span class="comment">/* å¾—åˆ°æœ¬è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦ */</span></span><br><span class="line">fdt = `files_fdtable`(files);</span><br><span class="line">fd = start; <span class="comment">// ä»startå¼€å§‹,è¿™é‡Œstartä¸º0</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * files-&gt;next_fdä¸ºä¸Šä¸€æ¬¡ç¡®å®šçš„ä¸‹ä¸€ä¸ªå¯ç”¨ç©ºé—²çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™é‡Œå¯ä»¥æé«˜è·å–çš„æ•ˆç‡ï¼Œå¦‚æœfdå°äºfiles-&gt;next_fdçš„è¯å°±å¯ä»¥ç›´æ¥ä½¿ç”¨next_fd;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (fd &lt; files-&gt;next_fd)</span><br><span class="line">fd = files-&gt;next_fd;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  å½“fdå°äºç›®å‰è¿›ç¨‹æ”¯æŒçš„æœ€å¤§çš„æè¿°ç¬¦å·ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡fds_bitä½å›¾ï¼Œä»fdä½å¼€å§‹æŸ¥æ‰¾ï¼Œæ‰¾åˆ°ä¸‹ä¸€ä½0ä½ï¼Œå³ä¸‹ä¸€ä¸ªç©ºé—²æè¿°ç¬¦</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (fd &lt; fdt-&gt;max_fds)</span><br><span class="line">fd = find_next_zero_bit(fdt-&gt;open_fds-&gt;fds_bits,</span><br><span class="line">   fdt-&gt;max_fds, fd);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¦‚éœ€è¦åˆ™æ‰©å±•æ–‡ä»¶æè¿°ç¬¦è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">error = expand_files(files, fd);</span><br><span class="line"><span class="keyword">if</span> (error &lt; <span class="number">0</span>)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If we needed to expand the fs array we</span></span><br><span class="line"><span class="comment"> * might have blocked - try again.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (error)</span><br><span class="line"><span class="keyword">goto</span> repeat;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/*</span></span><br><span class="line"><span class="comment">  * è®¾ç½®next_fdï¼Œç”¨äºä¸‹æ¬¡åŠ é€ŸæŸ¥æ‰¾ç©ºé—²çš„fd</span></span><br><span class="line"><span class="comment">  * å½“startå¤§äºnext_fdæ—¶ï¼Œä¸ä¼šè®¾ç½®next_fdä»¥é¿å…æ–‡ä»¶æè¿°ç¬¦çš„ä¸è¿ç»­ã€‚</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">if</span> (start &lt;= files-&gt;next_fd)</span><br><span class="line">files-&gt;next_fd = fd + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å°†fdæ·»åŠ åˆ°ä¸€æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ä¸­</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">FD_SET(fd, fdt-&gt;open_fds);</span><br><span class="line"><span class="keyword">if</span> (flags &amp; O_CLOEXEC)</span><br><span class="line">FD_SET(fd, fdt-&gt;close_on_exec);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">FD_CLR(fd, fdt-&gt;close_on_exec);</span><br><span class="line">error = fd;</span><br><span class="line"><span class="comment">/* Sanity check */</span></span><br><span class="line"><span class="keyword">if</span> (rcu_dereference_raw(fdt-&gt;fd[fd]) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">printk(KERN_WARNING <span class="string">"alloc_fd: slot %d not NULL!\n"</span>, fd);</span><br><span class="line">rcu_assign_pointer(fdt-&gt;fd[fd], <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">spin_unlock(&amp;files-&gt;file_lock);</span><br><span class="line"><span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div align="center"><p><img src="/img/note_0b/04.png" alt></p></div><div align="center"><p><img src="/img/note_0b/05.png" alt></p></div><h2 id="äºŒã€ç»‘å®šbind"><a href="#äºŒã€ç»‘å®šbind" class="headerlink" title="äºŒã€ç»‘å®šbind"></a><strong>äºŒã€ç»‘å®šbind</strong></h2><h3 id="1ã€SYSCALL-DEFINE3-bind-â€¦"><a href="#1ã€SYSCALL-DEFINE3-bind-â€¦" class="headerlink" title="1ã€SYSCALL_DEFINE3(bind,â€¦)"></a><strong>1ã€SYSCALL_DEFINE3(bind,â€¦)</strong></h3><p>ã€€ã€€bindç³»ç»Ÿè°ƒç”¨é€šè¿‡SYSCALL_DEFINE3è°ƒç”¨å„ä¸ªåè®®ä¸åŒçš„bindå‡½æ•°ã€‚<br>SYSCALL_DEFINE3(<code>bind</code>, int, fd, struct sockaddr __user *, umyaddr, int, addrlen)       // net/socket.c        line:1394</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(`bind`, <span class="keyword">int</span>, fd, struct sockaddr __user *, umyaddr, <span class="keyword">int</span>, addrlen)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">address</span>;</span></span><br><span class="line"><span class="keyword">int</span> err, fput_needed;</span><br><span class="line">sock = `sockfd_lookup_light`(fd, &amp;err, &amp;fput_needed); <span class="comment">// æ ¹æ®æ–‡ä»¶æè¿°ç¬¦fd,æŸ¥æ‰¾ç›¸åº”å¥—æ¥å­—socket </span></span><br><span class="line"><span class="keyword">if</span> (sock) &#123;</span><br><span class="line">err = `move_addr_to_kernel`(umyaddr, addrlen, (struct sockaddr *)&amp;address);</span><br><span class="line"><span class="keyword">if</span> (err &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">err = security_socket_bind(sock,</span><br><span class="line">   (struct sockaddr *)&amp;address,</span><br><span class="line">   addrlen);</span><br><span class="line"><span class="keyword">if</span> (!err)</span><br><span class="line">err = `sock-&gt;ops-&gt;bind`(sock,</span><br><span class="line">      (struct sockaddr *)</span><br><span class="line">      &amp;address, addrlen);</span><br><span class="line">&#125;</span><br><span class="line">fput_light(sock-&gt;file, fput_needed);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2ã€sockfd-lookup-lightå‡½æ•°"><a href="#2ã€sockfd-lookup-lightå‡½æ•°" class="headerlink" title="2ã€sockfd_lookup_lightå‡½æ•°"></a><strong>2ã€sockfd_lookup_lightå‡½æ•°</strong></h3><p><code>sockfd_lookup_light</code>å‡½æ•°     //net/socket.c        line:447</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct socket *<span class="title">sockfd_lookup_light</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> *err, <span class="keyword">int</span> *fput_needed)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line"></span><br><span class="line">*err = -EBADF;</span><br><span class="line">file = `fget_light`(fd, fput_needed); <span class="comment">//é€šè¿‡fdè·å–struct fileç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">if</span> (file) &#123;</span><br><span class="line">sock = `sock_from_file`(file, err); <span class="comment">//è¿”å›å¥—æ¥å­—æ‰€å¯¹åº”çš„å­˜å‚¨åœ¨file-&gt;private_date;åœ¨sock_aloc_fileå‡½æ•°ä¸­å¯¹å…¶è¿›è¡Œèµ‹å€¼</span></span><br><span class="line"><span class="keyword">if</span> (sock)</span><br><span class="line"><span class="keyword">return</span> sock;</span><br><span class="line">fput_light(file, *fput_needed);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="3ã€inet-bindå‡½æ•°"><a href="#3ã€inet-bindå‡½æ•°" class="headerlink" title="3ã€inet_bindå‡½æ•°"></a><strong>3ã€inet_bindå‡½æ•°</strong></h3><p>ã€€ã€€sock-&gt;ops-&gt;bindå®é™…è°ƒç”¨ä¸ºinet_bindã€‚sock-&gt;ops-&gt;bindèµ‹å€¼è¿‡ç¨‹ã€‚<br>ã€€ã€€åœ¨åˆ›å»ºTCPç±»å‹çš„socketæ—¶ï¼Œè¿›è¡Œäº†ä¸‹é¢çš„èµ‹å€¼åˆå§‹åŒ–æ“ä½œï¼Œè¿™é‡Œçš„bindå®šä¹‰ä¸ºinet_bind()å‡½æ•°ã€‚<br><code>inetsw_array</code>ç»“æ„ä½“æ•°ç»„  //  net/ipv4/af_inet.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_protosw</span> `<span class="title">inetsw_array</span>`[] =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">&#123;</span><br><span class="line">.type =       SOCK_STREAM,</span><br><span class="line">.protocol =   IPPROTO_TCP,</span><br><span class="line">.prot =       &amp;tcp_prot,</span><br><span class="line">.`ops =        &amp;inet_stream_ops`,</span><br><span class="line">.no_check =   <span class="number">0</span>,</span><br><span class="line">.flags =      INET_PROTOSW_PERMANENT |</span><br><span class="line">      INET_PROTOSW_ICSK,</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">.type =       SOCK_DGRAM,</span><br><span class="line">.protocol =   IPPROTO_UDP,</span><br><span class="line">.prot =       &amp;udp_prot,</span><br><span class="line">.ops =        &amp;inet_dgram_ops,</span><br><span class="line">.no_check =   UDP_CSUM_DEFAULT,</span><br><span class="line">.flags =      INET_PROTOSW_PERMANENT,</span><br><span class="line">       &#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">       &#123;</span><br><span class="line">       .type =       SOCK_RAW,</span><br><span class="line">       .protocol =   IPPROTO_IP,<span class="comment">/* wild card */</span></span><br><span class="line">       .prot =       &amp;raw_prot,</span><br><span class="line">       .ops =        &amp;inet_sockraw_ops,</span><br><span class="line">       .no_check =   UDP_CSUM_DEFAULT,</span><br><span class="line">       .flags =      INET_PROTOSW_REUSE,</span><br><span class="line">       &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>inet_stream_ops</code>  //  net/ipv4/af_inet.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span> <span class="title">inet_stream_ops</span> = &#123;</span></span><br><span class="line">.family   = PF_INET,</span><br><span class="line">.owner   = THIS_MODULE,</span><br><span class="line">.release   = inet_release,</span><br><span class="line">.`bind   = inet_bind`,</span><br><span class="line">.connect   = inet_stream_connect,</span><br><span class="line">.socketpair   = sock_no_socketpair,</span><br><span class="line">.accept   = inet_accept,</span><br><span class="line">.getname   = inet_getname,</span><br><span class="line">.poll   = tcp_poll,</span><br><span class="line">.ioctl   = inet_ioctl,</span><br><span class="line">.listen   = inet_listen,</span><br><span class="line">.shutdown   = inet_shutdown,</span><br><span class="line">.setsockopt   = sock_common_setsockopt,</span><br><span class="line">.getsockopt   = sock_common_getsockopt,</span><br><span class="line">.sendmsg   = inet_sendmsg,</span><br><span class="line">.recvmsg   = inet_recvmsg,</span><br><span class="line">.mmap   = sock_no_mmap,</span><br><span class="line">.sendpage   = inet_sendpage,</span><br><span class="line">.splice_read   = tcp_splice_read,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">.compat_setsockopt = compat_sock_common_setsockopt,</span><br><span class="line">.compat_getsockopt = compat_sock_common_getsockopt,</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>inet_dgram_ops</code>   //  net/ipv4/af_inet.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span> <span class="title">inet_dgram_ops</span> = &#123;</span></span><br><span class="line">.family   = PF_INET,</span><br><span class="line">.owner   = THIS_MODULE,</span><br><span class="line">.release   = inet_release,</span><br><span class="line">.`bind   = inet_bind`,</span><br><span class="line">.connect   = inet_dgram_connect,</span><br><span class="line">.socketpair   = sock_no_socketpair,</span><br><span class="line">.accept   = sock_no_accept,</span><br><span class="line">.getname   = inet_getname,</span><br><span class="line">.poll   = udp_poll,</span><br><span class="line">.ioctl   = inet_ioctl,</span><br><span class="line">.listen   = sock_no_listen,</span><br><span class="line">.shutdown   = inet_shutdown,</span><br><span class="line">.setsockopt   = sock_common_setsockopt,</span><br><span class="line">.getsockopt   = sock_common_getsockopt,</span><br><span class="line">.sendmsg   = inet_sendmsg,</span><br><span class="line">.recvmsg   = inet_recvmsg,</span><br><span class="line">.mmap   = sock_no_mmap,</span><br><span class="line">.sendpage   = inet_sendpage,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">.compat_setsockopt = compat_sock_common_setsockopt,</span><br><span class="line">.compat_getsockopt = compat_sock_common_getsockopt,</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>inet_sockraw_ops</code> //  net/ipv4/af_inet.c</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span> <span class="title">inet_sockraw_ops</span> = &#123;</span></span><br><span class="line">.family   = PF_INET,</span><br><span class="line">.owner   = THIS_MODULE,</span><br><span class="line">.release   = inet_release,</span><br><span class="line">.`bind   = inet_bind`,</span><br><span class="line">.connect   = inet_dgram_connect,</span><br><span class="line">.socketpair   = sock_no_socketpair,</span><br><span class="line">.accept   = sock_no_accept,</span><br><span class="line">.getname   = inet_getname,</span><br><span class="line">.poll   = datagram_poll,</span><br><span class="line">.ioctl   = inet_ioctl,</span><br><span class="line">.listen   = sock_no_listen,</span><br><span class="line">.shutdown   = inet_shutdown,</span><br><span class="line">.setsockopt   = sock_common_setsockopt,</span><br><span class="line">.getsockopt   = sock_common_getsockopt,</span><br><span class="line">.sendmsg   = inet_sendmsg,</span><br><span class="line">.recvmsg   = inet_recvmsg,</span><br><span class="line">.mmap   = sock_no_mmap,</span><br><span class="line">.sendpage   = inet_sendpage,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">.compat_setsockopt = compat_sock_common_setsockopt,</span><br><span class="line">.compat_getsockopt = compat_sock_common_getsockopt,</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="3-1ã€inet-bindå‡½æ•°"><a href="#3-1ã€inet-bindå‡½æ•°" class="headerlink" title="3.1ã€inet_bindå‡½æ•°"></a><strong>3.1ã€inet_bindå‡½æ•°</strong></h4><p><code>inet_bind</code>å‡½æ•°    // net/ipv4/af_inet.c    line:453</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_bind</span><span class="params">(struct socket *sock, struct sockaddr *uaddr, <span class="keyword">int</span> addr_len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> *<span class="title">addr</span> = (<span class="title">struct</span> <span class="title">sockaddr_in</span> *)<span class="title">uaddr</span>;</span>  <span class="comment">//è¦ç»‘å®šçš„sockaddr_inç»“æ„ä½“</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> = <span class="title">sock</span>-&gt;<span class="title">sk</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span> = <span class="title">inet_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> snum;   <span class="comment">//ç»‘å®šçš„ç«¯å£</span></span><br><span class="line"><span class="keyword">int</span> chk_addr_ret;  <span class="comment">//åœ°å€ç±»å‹</span></span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* If the socket has its own bind function then use it. (RAW) */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¯¹äºRAWç±»å‹çš„socketï¼Œè°ƒç”¨raw socketè‡ªå·±çš„bindå‡½æ•° raw_bind</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (`sk-&gt;sk_prot-&gt;bind`) &#123;</span><br><span class="line">err = sk-&gt;sk_prot-&gt;bind(sk, uaddr, addr_len);</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="keyword">if</span> (addr_len &lt; <span class="keyword">sizeof</span>(struct sockaddr_in)) <span class="comment">// sockaddr_iné•¿åº¦é”™è¯¯</span></span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">chk_addr_ret = inet_addr_type(sock_net(sk), addr-&gt;sin_addr.s_addr); <span class="comment">//åœ°å€ç±»å‹æ£€æŸ¥ï¼Œçœ‹çœ‹æ˜¯å¦å›ç¯åœ°å€ï¼Œå¤šæ’­åœ°å€ï¼Œç»„æ’­åœ°å€ï¼Œåœ¨ä¸‹é¢çš„åˆ¤æ–­ä¸­éœ€è¦ä½¿ç”¨åˆ°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Not specified by any standard per-se, however it breaks too</span></span><br><span class="line"><span class="comment"> * many applications when removed.  It is unfortunate since</span></span><br><span class="line"><span class="comment"> * allowing applications to make a non-local bind solves</span></span><br><span class="line"><span class="comment"> * several problems with systems using dynamic addressing.</span></span><br><span class="line"><span class="comment"> * (ie. your servers still start up even if your ISDN link</span></span><br><span class="line"><span class="comment"> *  is temporarily down)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">err = -EADDRNOTAVAIL;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sysctl_ip_nonlocal_bindè¡¨æ˜æ˜¯å¦å…è®¸ç»‘å®šéæœ¬åœ°çš„IPåœ°å€ï¼Œé»˜è®¤ä¸º0ï¼Œä¸å…è®¸ç»‘å®š</span></span><br><span class="line"><span class="comment">  *   # cd /proc/sys/net/ipv4</span></span><br><span class="line"><span class="comment"> *   # cat ip_nonlocal_bind   0</span></span><br><span class="line"><span class="comment"> *  ä»¥ä¸Šæ³¨é‡Šè¯´æ˜äº†ä½¿ç”¨è´¹æœ¬åœ°åœ°å€ç»‘å®šå¯ä»¥è§£å†³ä¸€äº›ä½¿ç”¨åŠ¨æ€åœ°å€ç»‘å®šçš„æœåŠ¡å™¨ç¨‹</span></span><br><span class="line"><span class="comment"> *  åºï¼Œæ‰€æœ‰è¿™ä¸ªå®ç°è¿˜æ˜¯æœ‰å®é™…æ„ä¹‰çš„ã€‚</span></span><br><span class="line"><span class="comment">  *  inet-&gt;freebindæ˜¯é€šè¿‡do_ip_setsockoptå‡½æ•°è¿›è¡Œè®¾ç½®çš„ï¼Œé»˜è®¤å€¼ä¸º1ï¼Œæ”¹å€¼è¡¨ç¤ºå…è®¸</span></span><br><span class="line"><span class="comment">  *  ç»‘å®šä¸€ä¸ªéæœ¬åœ°IPåœ°å€å’Œä¸å­˜åœ¨çš„IPåœ°å€ï¼Œå¯ä»¥é€šè¿‡IP_FREEBINDè®¾ç½®</span></span><br><span class="line"><span class="comment">  *   inet-&gt;tarnsparent å«ä¹‰å°±æ˜¯å¯ä»¥ä½¿ç”¨ä¸€ä¸ªæœåŠ¡å™¨ç¨‹åºç›‘å¬æ‰€æœ‰çš„IPåœ°å€ï¼Œå“ªæ€•ä¸æ˜¯</span></span><br><span class="line"><span class="comment">  *   æœ¬åœ°çš„IPåœ°å€</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">if</span> (!sysctl_ip_nonlocal_bind &amp;&amp;</span><br><span class="line">    !(inet-&gt;freebind || inet-&gt;transparent) &amp;&amp;</span><br><span class="line">    addr-&gt;sin_addr.s_addr != htonl(INADDR_ANY) &amp;&amp;</span><br><span class="line">    chk_addr_ret != RTN_LOCAL &amp;&amp;</span><br><span class="line">    chk_addr_ret != RTN_MULTICAST &amp;&amp;</span><br><span class="line">    chk_addr_ret != RTN_BROADCAST)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">snum = ntohs(addr-&gt;sin_port); <span class="comment">//è·å–ç»‘å®šç«¯å£å·</span></span><br><span class="line">err = -EACCES;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">      * å¦‚æœè¦ç»‘å®š`0-1023`ä¹‹å†…çš„ç«¯å£å·ï¼Œéœ€è¦ç”¨æˆ·å…·æœ‰CAP_NET_BIND_SERVICEæƒé™ï¼ŒPROT_SOCKå°±æ˜¯1024 </span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"><span class="keyword">if</span> (snum &amp;&amp; snum &lt; PROT_SOCK &amp;&amp; !capable(CAP_NET_BIND_SERVICE))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*      We keep a pair of addresses. rcv_saddr is the one</span></span><br><span class="line"><span class="comment"> *      used by hash lookups, and saddr is used for transmit.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *      In the BSD API these are the same except where it</span></span><br><span class="line"><span class="comment"> *      would be illegal to use them (multicast/broadcast) in</span></span><br><span class="line"><span class="comment"> *      which case the sending device address is used.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">lock_sock(sk);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Check these errors (active socket, double bind). */</span></span><br><span class="line">err = -EINVAL;</span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">      * åˆ¤æ–­sk_stateçš„çŠ¶æ€ååˆ†ä¸ºTCP_CLOSE,åœ¨åˆ›å»ºsocketæ—¶ï¼Œsk_stateåˆå§‹ä¸ºTCP_CLOSEï¼Œå¦‚æœä¸ç­‰äºTCP_CLOSEè¯´æ˜å·²ç»bindè¿‡ï¼Œè€Œnumåªæœ‰å½“raw socketæ—¶æ‰ä¸ä¸º0</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"><span class="keyword">if</span> (sk-&gt;sk_state != TCP_CLOSE || inet-&gt;inet_num) </span><br><span class="line"><span class="keyword">goto</span> out_release_sock;</span><br><span class="line"></span><br><span class="line">inet-&gt;inet_rcv_saddr = inet-&gt;inet_saddr = addr-&gt;sin_addr.s_addr; <span class="comment">//éœ€è¦ç»‘å®šçš„åœ°å€</span></span><br><span class="line"><span class="keyword">if</span> (chk_addr_ret == RTN_MULTICAST || chk_addr_ret == RTN_BROADCAST)</span><br><span class="line">inet-&gt;inet_saddr = <span class="number">0</span>;  <span class="comment">/* Use device */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Make sure we are allowed to bind here. */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  * è°ƒç”¨å››å±‚çš„bindå‡½æ•°ï¼Œå¯¹äºTCPæ¥è¯´ï¼Œå°±æ˜¯inet_csk_get_port </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="keyword">if</span> (`sk-&gt;sk_prot-&gt;get_port`(sk, snum)) &#123;</span><br><span class="line">inet-&gt;inet_saddr = inet-&gt;inet_rcv_saddr = <span class="number">0</span>;</span><br><span class="line">err = -EADDRINUSE;</span><br><span class="line"><span class="keyword">goto</span> out_release_sock;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (inet-&gt;inet_rcv_saddr)</span><br><span class="line">sk-&gt;sk_userlocks |= SOCK_BINDADDR_LOCK;  <span class="comment">//è®¾ç½®skä¸­çš„sk-&gt;userlocksè¡¨ç¤ºç»‘å®šåœ°å€</span></span><br><span class="line"><span class="keyword">if</span> (snum)</span><br><span class="line">sk-&gt;sk_userlocks |= SOCK_BINDPORT_LOCK;  <span class="comment">//è®¾ç½®skä¸­çš„sk-&gt;userlocksè¡¨ç¤ºç»‘å®šç«¯å£</span></span><br><span class="line">inet-&gt;inet_sport = htons(inet-&gt;inet_num);</span><br><span class="line">inet-&gt;inet_daddr = <span class="number">0</span>;</span><br><span class="line">inet-&gt;inet_dport = <span class="number">0</span>;</span><br><span class="line">sk_dst_reset(sk);</span><br><span class="line">err = <span class="number">0</span>;</span><br><span class="line">out_release_sock:</span><br><span class="line">release_sock(sk);</span><br><span class="line">out:</span><br><span class="line"><span class="keyword">return</span> err;</span><br></pre></td></tr></table></figure><h4 id="3-2ã€sk-gt-sk-prot-gt-bindèµ‹å€¼"><a href="#3-2ã€sk-gt-sk-prot-gt-bindèµ‹å€¼" class="headerlink" title="3.2ã€sk-&gt;sk_prot-&gt;bindèµ‹å€¼"></a><strong>3.2ã€sk-&gt;sk_prot-&gt;bindèµ‹å€¼</strong></h4><p>ã€€ã€€sk-&gt;sk_prot-&gt;bindæˆå‘˜èµ‹å€¼ï¼Œç”±ä»¥ä¸‹tcp_protã€udp_protå’Œraw_protä¸‰ä¸ªprotoç»“æ„ä½“å˜é‡çš„å„ä¸ªæˆå‘˜èµ‹å€¼å¯å€¼ï¼Œtcp_protå’Œudp_protå˜é‡ä¸å­˜åœ¨bindæˆå‘˜èµ‹å€¼ï¼Œåªæœ‰raw_protå˜é‡å­˜åœ¨bindæˆå‘˜èµ‹å€¼ä¸”.bind = raw_bindã€‚<br><code>tcp_prot</code>         // net/ipv4/tcp_ipv4.c        line:2601</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proto</span> <span class="title">tcp_prot</span> = &#123;</span></span><br><span class="line">.name= `<span class="string">"TCP"</span>`,</span><br><span class="line">.owner= THIS_MODULE,</span><br><span class="line">.close= tcp_close,</span><br><span class="line">.connect= tcp_v4_connect,</span><br><span class="line">.disconnect= tcp_disconnect,</span><br><span class="line">.accept= inet_csk_accept,</span><br><span class="line">.ioctl= tcp_ioctl,</span><br><span class="line">.init= tcp_v4_init_sock,</span><br><span class="line">.destroy= tcp_v4_destroy_sock,</span><br><span class="line">.shutdown= tcp_shutdown,</span><br><span class="line">.setsockopt= tcp_setsockopt,</span><br><span class="line">.getsockopt= tcp_getsockopt,</span><br><span class="line">.recvmsg= tcp_recvmsg,</span><br><span class="line">.sendmsg= tcp_sendmsg,</span><br><span class="line">.sendpage= tcp_sendpage,</span><br><span class="line">.backlog_rcv= tcp_v4_do_rcv,</span><br><span class="line">.hash= inet_hash,</span><br><span class="line">.unhash= inet_unhash,</span><br><span class="line">.`get_port= inet_csk_get_port`,</span><br><span class="line">.enter_memory_pressure= tcp_enter_memory_pressure,</span><br><span class="line">.sockets_allocated= &amp;tcp_sockets_allocated,</span><br><span class="line">.orphan_count= &amp;tcp_orphan_count,</span><br><span class="line">.memory_allocated= &amp;tcp_memory_allocated,</span><br><span class="line">.memory_pressure= &amp;tcp_memory_pressure,</span><br><span class="line">.sysctl_mem= sysctl_tcp_mem,</span><br><span class="line">.sysctl_wmem= sysctl_tcp_wmem,</span><br><span class="line">.sysctl_rmem= sysctl_tcp_rmem,</span><br><span class="line">.max_header= MAX_TCP_HEADER,</span><br><span class="line">.obj_size= <span class="keyword">sizeof</span>(struct tcp_sock),</span><br><span class="line">.slab_flags= SLAB_DESTROY_BY_RCU,</span><br><span class="line">.twsk_prot= &amp;tcp_timewait_sock_ops,</span><br><span class="line">.rsk_prot= &amp;tcp_request_sock_ops,</span><br><span class="line">.h.hashinfo= &amp;tcp_hashinfo,</span><br><span class="line">.no_autobind= <span class="literal">true</span>,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">.compat_setsockopt= compat_tcp_setsockopt,</span><br><span class="line">.compat_getsockopt= compat_tcp_getsockopt,</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>udp_prot</code>        // net/ipv4/udp.c    line:1860</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proto</span> <span class="title">udp_prot</span> = &#123;</span></span><br><span class="line">.name   = `<span class="string">"UDP"</span>`,</span><br><span class="line">.owner   = THIS_MODULE,</span><br><span class="line">.close   = udp_lib_close,</span><br><span class="line">.connect   = ip4_datagram_connect,</span><br><span class="line">.disconnect   = udp_disconnect,</span><br><span class="line">.ioctl   = udp_ioctl,</span><br><span class="line">.destroy   = udp_destroy_sock,</span><br><span class="line">.setsockopt   = udp_setsockopt,</span><br><span class="line">.getsockopt   = udp_getsockopt,</span><br><span class="line">.sendmsg   = udp_sendmsg,</span><br><span class="line">.recvmsg   = udp_recvmsg,</span><br><span class="line">.sendpage   = udp_sendpage,</span><br><span class="line">.backlog_rcv   = __udp_queue_rcv_skb,</span><br><span class="line">.hash   = udp_lib_hash,</span><br><span class="line">.unhash   = udp_lib_unhash,</span><br><span class="line">.rehash   = udp_v4_rehash,</span><br><span class="line">.`get_port   = udp_v4_get_port`,</span><br><span class="line">.memory_allocated  = &amp;udp_memory_allocated,</span><br><span class="line">.sysctl_mem   = sysctl_udp_mem,</span><br><span class="line">.sysctl_wmem   = &amp;sysctl_udp_wmem_min,</span><br><span class="line">.sysctl_rmem   = &amp;sysctl_udp_rmem_min,</span><br><span class="line">.obj_size   = <span class="keyword">sizeof</span>(struct udp_sock),</span><br><span class="line">.slab_flags   = SLAB_DESTROY_BY_RCU,</span><br><span class="line">.h.udp_table   = &amp;udp_table,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">.compat_setsockopt = compat_udp_setsockopt,</span><br><span class="line">.compat_getsockopt = compat_udp_getsockopt,</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>raw_port</code>        //net/ipv4/raw.c  line:842</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">proto</span> <span class="title">raw_prot</span> = &#123;</span></span><br><span class="line">.name   = `<span class="string">"RAW"</span>`,</span><br><span class="line">.owner   = THIS_MODULE,</span><br><span class="line">.close   = raw_close,</span><br><span class="line">.destroy   = raw_destroy,</span><br><span class="line">.connect   = ip4_datagram_connect,</span><br><span class="line">.disconnect   = udp_disconnect,</span><br><span class="line">.ioctl   = raw_ioctl,</span><br><span class="line">.init   = raw_init,</span><br><span class="line">.setsockopt   = raw_setsockopt,</span><br><span class="line">.getsockopt   = raw_getsockopt,</span><br><span class="line">.sendmsg   = raw_sendmsg,</span><br><span class="line">.recvmsg   = raw_recvmsg,</span><br><span class="line">.`bind   = raw_bind`,</span><br><span class="line">.backlog_rcv   = raw_rcv_skb,</span><br><span class="line">.hash   = raw_hash_sk,</span><br><span class="line">.unhash   = raw_unhash_sk,</span><br><span class="line">.obj_size   = <span class="keyword">sizeof</span>(struct raw_sock),</span><br><span class="line">.h.raw_hash   = &amp;raw_v4_hashinfo,</span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">.compat_setsockopt = compat_raw_setsockopt,</span><br><span class="line">.compat_getsockopt = compat_raw_getsockopt,</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ã€€ã€€é€šè¿‡ä»¥ä¸Štcp_protã€udp_protå’Œraw_protå‘ç°ï¼Œåœ¨tcp_protå’Œudp_protä¸å­˜åœ¨bindæˆå‘˜ï¼Œè€Œå­˜åœ¨get_protæˆå‘˜ã€‚raw_protä¸­å­˜åœ¨bindæˆå‘˜ã€‚è¿™ä¹Ÿæ˜¯inet_bindå‡½æ•°ä¸­åˆ¤æ–­<code>sk-&gt;sk_prot-&gt;bind</code>æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™è°ƒç”¨è‡ªèº«çš„bindå‡½æ•°ã€‚å¯¹äºtcpå’Œudp socketï¼Œinet_bindå‡½æ•°éšåä¼šè°ƒç”¨<code>sk-&gt;sk_prot-&gt;get_port</code>å³inet_csk_get_portï¼ˆtcpï¼‰æˆ–udp_v4_get_port(udp);</p><h3 id="4ã€inet-csk-get-portå‡½æ•°"><a href="#4ã€inet-csk-get-portå‡½æ•°" class="headerlink" title="4ã€inet_csk_get_portå‡½æ•°"></a><strong>4ã€inet_csk_get_portå‡½æ•°</strong></h3><p>ã€€ã€€inet_csk_get_portå‡½æ•°ä¸ºTCPå¥—æ¥å­—sk-&gt;sk_prot-&gt;get_portçš„èµ‹å€¼ã€‚<br><code>inet_csk_get_port</code>         // net/ipv4/tcp_ipv4.c line:2621</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Obtain a reference to a local port for the given sock,</span></span><br><span class="line"><span class="comment"> * if snum is zero it means select any available local port.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_csk_get_port</span><span class="params">(struct sock *sk, <span class="keyword">unsigned</span> <span class="keyword">short</span> snum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * TCPæ•£åˆ—è¡¨ç®¡ç†ç»“æ„å®ä¾‹tcp_hashinfo,åœ¨tcp.cæ–‡ä»¶ä¸­tcp_initå‡½æ•°ä¸­è¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"> * å·¥ä½œï¼Œåœ¨tcp_ipv4.cæ–‡ä»¶ä¸­ï¼Œstruct proto tcp_protç»“æ„ä½“å¯¹å…¶è¿›è¡Œèµ‹å€¼</span></span><br><span class="line"><span class="comment"> * .h.hasinfo=&amp;tcp_hashinfo;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_hashinfo</span> *<span class="title">hashinfo</span> = <span class="title">sk</span>-&gt;<span class="title">sk_prot</span>-&gt;<span class="title">h</span>.<span class="title">hashinfo</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> `<span class="title">inet_bind_hashbucket</span>` *<span class="title">head</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> *<span class="title">node</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_bind_bucket</span> *<span class="title">tb</span>;</span></span><br><span class="line"><span class="keyword">int</span> ret, attempts = <span class="number">5</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net</span> *<span class="title">net</span> = <span class="title">sock_net</span>(<span class="title">sk</span>);</span></span><br><span class="line"><span class="keyword">int</span> smallest_size = <span class="number">-1</span>, smallest_rover;</span><br><span class="line"></span><br><span class="line">local_bh_disable();</span><br><span class="line"><span class="keyword">if</span> (!snum) &#123; <span class="comment">//å¦‚æœç”¨æˆ·ç»‘å®šç«¯å£ä¸º0ï¼Œå°±é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„æœ¬åœ°ç«¯å£</span></span><br><span class="line"><span class="keyword">int</span> remaining, rover, low, high;</span><br><span class="line"></span><br><span class="line">again:</span><br><span class="line">`inet_get_local_port_range`(&amp;low, &amp;high); <span class="comment">//è·å–æœ¬åœ°å¯ä»¥ä½¿ç”¨çš„ç«¯å£èŒƒå›´</span></span><br><span class="line">remaining = (high - low) + <span class="number">1</span>; <span class="comment">//æœ€å¤§é‡æ–°åˆ†é…æ¬¡æ•°</span></span><br><span class="line">smallest_rover = rover = net_random() % remaining + low; <span class="comment">// éšæœºç”Ÿæˆç«¯å£å·èµ‹å€¼ç»™rover</span></span><br><span class="line"></span><br><span class="line">smallest_size = <span class="number">-1</span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * whileå¾ªç¯ä»£ç æ˜¯æ ¹æ®è·å–åˆ°çš„ç©ºé—²çš„ç«¯å£å·å’Œbhash_sizeä»bhashä¸Šå–å¾—HASHå€¼å¯¹åº”</span></span><br><span class="line"><span class="comment"> * çš„é“¾è¡¨ï¼Œç„¶åéå†é“¾è¡¨ï¼Œå¯¹æ¯”é“¾è¡¨ä¸­æ˜¯å¦æœ‰è·å–åˆ°çš„ç©ºé—²ç«¯å£ï¼Œå¦‚æœå­˜åœ¨è¯¥ç«¯å£ï¼Œè¯´æ˜</span></span><br><span class="line"><span class="comment"> * è·å–çš„è¯¥ç«¯å£å·å·²ç»è¢«å ç”¨ï¼Œå¦‚æœå·²ç»è¢«å ç”¨å°±å°†è·å–çš„+1,å¦‚æœå¤§äºæœ€å¤§å€¼ï¼Œåˆ™ä»æœ€</span></span><br><span class="line"><span class="comment"> * å°å€¼å¼€å§‹é‡æ–°éå†ç«¯å£åˆ—è¡¨ï¼ŒçŸ¥é“å°è¯•æˆåŠŸæ¬¡æ•°ä¸ºremaining</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (inet_is_reserved_local_port(rover)) <span class="comment">//å¦‚æœæ˜¯ä¿ç•™ç«¯å£ç›´æ¥å¯»æ‰¾ä¸‹ä¸€æ¥å£</span></span><br><span class="line"><span class="keyword">goto</span> next_nolock;</span><br><span class="line">head = &amp;hashinfo-&gt;bhash[inet_bhashfn(net, rover,</span><br><span class="line">hashinfo-&gt;bhash_size)];</span><br><span class="line">spin_lock(&amp;head-&gt;lock);</span><br><span class="line">inet_bind_bucket_for_each(tb, node, &amp;head-&gt;chain)</span><br><span class="line"><span class="keyword">if</span> (net_eq(ib_net(tb), net) &amp;&amp; tb-&gt;port == rover) &#123;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * åˆ¤æ–­ç«¯å£æ˜¯å¦å¯ä»¥è¢«å¤ç”¨ï¼Œå¦‚æœå¯ä»¥è¢«å¤ç”¨å³ä½¿åœ¨ç»‘å®šè¡¨ä¸­ï¼Œ</span></span><br><span class="line"><span class="comment">*ä¹Ÿä¼˜å…ˆä½¿ç”¨å¯ä»¥å¤ç”¨çš„ç«¯å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (`tb`-&gt;fastreuse &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">    sk-&gt;sk_reuse &amp;&amp;</span><br><span class="line">    sk-&gt;sk_state != TCP_LISTEN &amp;&amp;</span><br><span class="line">    (tb-&gt;num_owners &lt; smallest_size || smallest_size == <span class="number">-1</span>)) &#123;</span><br><span class="line">smallest_size = tb-&gt;num_owners; <span class="comment">//è®°å½•ç«¯å£ä½¿ç”¨è€…çš„æ¬¡æ•°</span></span><br><span class="line">smallest_rover = rover;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¦‚æœç»‘å®šç«¯å£çš„ä¸ªæ•°å¤§äºç«¯å£çš„å¯ç”¨ä¸ªæ•°ï¼Œå°±å›åˆ¤æ–­æ˜¯å¦ç»‘å®šå†²çª</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (atomic_read(&amp;hashinfo-&gt;bsockets) &gt; (high - low) + <span class="number">1</span>) &#123;</span><br><span class="line">spin_unlock(&amp;head-&gt;lock);</span><br><span class="line">snum = smallest_rover;</span><br><span class="line"><span class="keyword">goto</span> have_snum;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">goto</span> next;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">next:</span><br><span class="line">spin_unlock(&amp;head-&gt;lock);</span><br><span class="line">next_nolock:</span><br><span class="line"><span class="keyword">if</span> (++rover &gt; high)</span><br><span class="line">rover = low;</span><br><span class="line">&#125; <span class="keyword">while</span> (--remaining &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Exhausted local port range during search?  It is not</span></span><br><span class="line"><span class="comment"> * possible for us to be holding one of the bind hash</span></span><br><span class="line"><span class="comment"> * locks if this test triggers, because if 'remaining'</span></span><br><span class="line"><span class="comment"> * drops to zero, we broke out of the do/while loop at</span></span><br><span class="line"><span class="comment"> * the top level, not from the 'break;' statement.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ret = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (remaining &lt;= <span class="number">0</span>) &#123; <span class="comment">//å¦‚æœæ²¡æœ‰æŸ¥æ‰¾åˆ°ï¼Œå†ç»™æ¬¡æœºä¼š</span></span><br><span class="line"><span class="keyword">if</span> (smallest_size != <span class="number">-1</span>) &#123;</span><br><span class="line">snum = smallest_rover;</span><br><span class="line"><span class="keyword">goto</span> have_snum;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">goto</span> fail;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* OK, here is the one we will use.  HEAD is</span></span><br><span class="line"><span class="comment"> * non-NULL and we hold it's mutex.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">snum = rover;  <span class="comment">//æ‰¾åˆ°ç»‘å®šç«¯å£å·</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;  <span class="comment">//å¦‚æœæŒ‡å®šç«¯å£å·ï¼Œåˆ™åœ¨ç›¸åº”çš„é“¾è¡¨ä¸­è¿›è¡ŒæŸ¥è¯¢</span></span><br><span class="line">have_snum:</span><br><span class="line">head = &amp;hashinfo-&gt;bhash[inet_bhashfn(net, snum,</span><br><span class="line">hashinfo-&gt;bhash_size)];</span><br><span class="line">spin_lock(&amp;head-&gt;lock);</span><br><span class="line">inet_bind_bucket_for_each(tb, node, &amp;head-&gt;chain)</span><br><span class="line"><span class="keyword">if</span> (net_eq(ib_net(tb), net) &amp;&amp; tb-&gt;port == snum)</span><br><span class="line"><span class="keyword">goto</span> tb_found;  <span class="comment">// åœ¨ç»‘å®šè¡¨ä¸­æŸ¥æ‰¾ï¼Œè¡¨ç¤ºè¯¥ç«¯å£å·²ç»ç»‘å®š</span></span><br><span class="line">&#125;</span><br><span class="line">tb = <span class="literal">NULL</span>;  <span class="comment">//å¦‚æœæŒ‡å®šçš„ç«¯å£åœ¨ç»‘å®šè¡¨ä¸­æ²¡æœ‰å‘ç°ï¼Œç›´æ¥åˆ›å»º</span></span><br><span class="line"><span class="keyword">goto</span> tb_not_found;</span><br><span class="line">tb_found:</span><br><span class="line"><span class="keyword">if</span> (!hlist_empty(&amp;tb-&gt;owners)) &#123;</span><br><span class="line"><span class="keyword">if</span> (tb-&gt;fastreuse &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">    sk-&gt;sk_reuse &amp;&amp; sk-&gt;sk_state != TCP_LISTEN &amp;&amp;</span><br><span class="line">    smallest_size == <span class="number">-1</span>) &#123;</span><br><span class="line"><span class="keyword">goto</span> success; </span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">ret = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (`inet_csk(sk)-&gt;icsk_af_ops-&gt;bind_conflict`(sk, tb)) &#123; <span class="comment">// è°ƒç”¨inet_csk_bind_conflict å‡½æ•°</span></span><br><span class="line"><span class="keyword">if</span> (sk-&gt;sk_reuse &amp;&amp; sk-&gt;sk_state != TCP_LISTEN &amp;&amp;</span><br><span class="line">    smallest_size != <span class="number">-1</span> &amp;&amp; --attempts &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">spin_unlock(&amp;head-&gt;lock);</span><br><span class="line"><span class="keyword">goto</span> again;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">goto</span> fail_unlock;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">tb_not_found:</span><br><span class="line">ret = <span class="number">1</span>; <span class="comment">//å¦‚æœåœ¨ç»‘å®šè¡¨ä¸­æ²¡æœ‰å‘ç°ï¼Œåˆ™åˆ›å»º</span></span><br><span class="line"><span class="keyword">if</span> (!tb &amp;&amp; (tb = `inet_bind_bucket_create`(hashinfo-&gt;bind_bucket_cachep,</span><br><span class="line">net, head, snum)) == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">goto</span> fail_unlock;</span><br><span class="line"><span class="keyword">if</span> (hlist_empty(&amp;tb-&gt;owners)) &#123; <span class="comment">//å¦‚æœæ²¡æœ‰ç»‘å®šsocket</span></span><br><span class="line"><span class="keyword">if</span> (sk-&gt;sk_reuse &amp;&amp; sk-&gt;sk_state != TCP_LISTEN) </span><br><span class="line">tb-&gt;fastreuse = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">tb-&gt;fastreuse = <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (tb-&gt;fastreuse &amp;&amp;</span><br><span class="line">   (!sk-&gt;sk_reuse || sk-&gt;sk_state == TCP_LISTEN))</span><br><span class="line">tb-&gt;fastreuse = <span class="number">0</span>;</span><br><span class="line">success: <span class="comment">//å¦‚æœæˆåŠŸæ‰¾åˆ°ä¸€ä¸ªå¯ç”¨çš„ç«¯å£ï¼Œæ·»åŠ åˆ°ç»‘å®šè¡¨ä¸­</span></span><br><span class="line"><span class="keyword">if</span> (!inet_csk(sk)-&gt;icsk_bind_hash)</span><br><span class="line">`inet_bind_hash`(sk, tb, snum); <span class="comment">// æŠŠå½“å‰çš„sockæ’å…¥åˆ°woers</span></span><br><span class="line">WARN_ON(inet_csk(sk)-&gt;icsk_bind_hash != tb);</span><br><span class="line">ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">fail_unlock:</span><br><span class="line">spin_unlock(&amp;head-&gt;lock);</span><br><span class="line">fail:</span><br><span class="line">local_bh_enable();</span><br><span class="line"><span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-1ã€inet-get-local-port-rangeå‡½æ•°"><a href="#4-1ã€inet-get-local-port-rangeå‡½æ•°" class="headerlink" title="4.1ã€inet_get_local_port_rangeå‡½æ•°"></a><strong>4.1ã€inet_get_local_port_rangeå‡½æ•°</strong></h4><p><code>inet_get_local_port_range</code>  //  net/ipv4/inet_connection_sock.c         line:43</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inet_get_local_port_range</span><span class="params">(<span class="keyword">int</span> *low, <span class="keyword">int</span> *high)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">unsigned</span> seq;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">seq = read_seqbegin(&amp;sysctl_local_ports.lock);</span><br><span class="line"></span><br><span class="line">*low = sysctl_local_ports.range[<span class="number">0</span>];</span><br><span class="line">*high = sysctl_local_ports.range[<span class="number">1</span>];</span><br><span class="line">&#125; <span class="keyword">while</span> (read_seqretry(&amp;sysctl_local_ports.lock, seq));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>sysctl_local_ports</code>    // net/ipv4/inet_connection_sock.c    line:35</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This struct holds the first and last local port number.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">local_ports</span> <span class="title">sysctl_local_ports</span> __<span class="title">read_mostly</span> = &#123;</span></span><br><span class="line">.lock = SEQLOCK_UNLOCKED,</span><br><span class="line">.range = &#123; <span class="number">32768</span>, <span class="number">61000</span> &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ã€€ã€€inet_get_local_port_range()è·å–æœ¬åœ°å¯ç”¨ç«¯å£çš„èŒƒå›´ï¼Œç”±sysctl_local_portså®šä¹‰å¯ä»¥çŸ¥é“ç«¯å£çš„èŒƒå›´ä¸º32768-61000ã€‚å¦‚æœç”¨æˆ·æ§ä»¶ç»‘å®šçš„æœ¬åœ°ç«¯å£ä¸º0çš„è¯ï¼Œä¼šè‡ªåŠ¨ä¸ºå¥—æ¥å­—åˆ†é…ä¸€ä¸ªå¯ä»¥çš„ç«¯å£ã€‚</p><h4 id="4-2ã€æœ¬åœ°ç«¯å£å¯ä»¥è¢«å¤ç”¨çš„æ¡ä»¶"><a href="#4-2ã€æœ¬åœ°ç«¯å£å¯ä»¥è¢«å¤ç”¨çš„æ¡ä»¶" class="headerlink" title="4.2ã€æœ¬åœ°ç«¯å£å¯ä»¥è¢«å¤ç”¨çš„æ¡ä»¶"></a><strong>4.2ã€æœ¬åœ°ç«¯å£å¯ä»¥è¢«å¤ç”¨çš„æ¡ä»¶</strong></h4><p>æœ¬åœ°ç«¯å£å¯ä»¥è¢«å¤ç”¨çš„å‡ ä¸ªæ¡ä»¶å¦‚ä¸‹ï¼š</p><ul><li>1ã€ç»‘å®šåˆ°ä¸åŒæ¥å£çš„Socketså¯ä»¥å¤ç”¨æœ¬åœ°ç«¯å£</li><li>2ã€å¦‚æœæ‰€æœ‰Socketséƒ½è®¾ç½®sk-&gt;sk_reuse,å¹¶ä¸”éƒ½ä¸åœ¨TCP_LISTENçŠ¶æ€ï¼Œå¯ä»¥å¤ç”¨ç«¯å£</li><li>3ã€å¦‚æœæ‰€æœ‰Socketç»‘å®šåœ¨ä¸€ä¸ªç‰¹å®šçš„inet_sk(sk)-&gt;rcv_saddræœ¬åœ°åœ°å€ï¼Œå¹¶ä¸”åœ°å€éƒ½ä¸ç›¸åŒï¼Œå¯ä»¥å¤ç”¨</li></ul><p><code>inet_bind_bucket</code>ç»“æ„ä½“  // include/net/inet_hashtables.h</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* There are a few simple rules, which allow for local port reuse by</span></span><br><span class="line"><span class="comment"> * an application.  In essence:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *1) Sockets bound to different interfaces may share a local port.</span></span><br><span class="line"><span class="comment"> *   Failing that, goto test 2.</span></span><br><span class="line"><span class="comment"> *2) If all sockets have sk-&gt;sk_reuse set, and none of them are in</span></span><br><span class="line"><span class="comment"> *   TCP_LISTEN state, the port may be shared.</span></span><br><span class="line"><span class="comment"> *   Failing that, goto test 3.</span></span><br><span class="line"><span class="comment"> *3) If all sockets are bound to a specific inet_sk(sk)-&gt;rcv_saddr local</span></span><br><span class="line"><span class="comment"> *   address, and none of them are the same, the port may be</span></span><br><span class="line"><span class="comment"> *   shared.</span></span><br><span class="line"><span class="comment"> *   Failing this, the port cannot be shared.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The interesting point, is test #2.  This is what an FTP server does</span></span><br><span class="line"><span class="comment"> * all day.  To optimize this case we use a specific flag bit defined</span></span><br><span class="line"><span class="comment"> * below.  As we add sockets to a bind bucket list, we perform a</span></span><br><span class="line"><span class="comment"> * check of: (newsk-&gt;sk_reuse &amp;&amp; (newsk-&gt;sk_state != TCP_LISTEN))</span></span><br><span class="line"><span class="comment"> * As long as all sockets added to a bind bucket pass this test,</span></span><br><span class="line"><span class="comment"> * the flag bit will be set.</span></span><br><span class="line"><span class="comment"> * The resulting situation is that tcp_v[46]_verify_bind() can just check</span></span><br><span class="line"><span class="comment"> * for this flag bit, if it is set and the socket trying to bind has</span></span><br><span class="line"><span class="comment"> * sk-&gt;sk_reuse set, we don't even have to walk the owners list at all,</span></span><br><span class="line"><span class="comment"> * we return that it is ok to bind this socket to the requested local port.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Sounds like a lot of work, but it is worth it.  In a more naive</span></span><br><span class="line"><span class="comment"> * implementation (ie. current FreeBSD etc.) the entire list of ports</span></span><br><span class="line"><span class="comment"> * must be walked for each data port opened by an ftp server.  Needless</span></span><br><span class="line"><span class="comment"> * to say, this does not scale at all.  With a couple thousand FTP</span></span><br><span class="line"><span class="comment"> * users logged onto your box, isn't it nice to know that new data</span></span><br><span class="line"><span class="comment"> * ports are created in O(1) time?  I thought so. ;-)-DaveM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_bind_bucket</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NET_NS</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">net</span>*<span class="title">ib_net</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span>port;</span><br><span class="line"><span class="keyword">signed</span> <span class="keyword">short</span>fastreuse;</span><br><span class="line"><span class="keyword">int</span>num_owners;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span><span class="title">node</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span><span class="title">owners</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h4 id="4-3ã€inet-csk-sk-gt-icsk-af-ops-gt-bind-conflict-sk-tb-è°ƒç”¨"><a href="#4-3ã€inet-csk-sk-gt-icsk-af-ops-gt-bind-conflict-sk-tb-è°ƒç”¨" class="headerlink" title="4.3ã€inet_csk(sk)-&gt;icsk_af_ops-&gt;bind_conflict(sk, tb)è°ƒç”¨"></a><strong>4.3ã€inet_csk(sk)-&gt;icsk_af_ops-&gt;bind_conflict(sk, tb)è°ƒç”¨</strong></h4><p><code>bind_conflict</code>èµ‹å€¼   // net/ipv4/tcp_ipv4.c  line:1825</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock_af_ops</span> `<span class="title">ipv4_specific</span>` = &#123;</span></span><br><span class="line">.queue_xmit   = ip_queue_xmit,</span><br><span class="line">.send_check   = tcp_v4_send_check,</span><br><span class="line">.rebuild_header   = inet_sk_rebuild_header,</span><br><span class="line">.conn_request   = tcp_v4_conn_request,</span><br><span class="line">.syn_recv_sock   = tcp_v4_syn_recv_sock,</span><br><span class="line">.remember_stamp   = tcp_v4_remember_stamp,</span><br><span class="line">.net_header_len   = <span class="keyword">sizeof</span>(struct iphdr),</span><br><span class="line">.setsockopt   = ip_setsockopt,</span><br><span class="line">.getsockopt   = ip_getsockopt,</span><br><span class="line">.addr2sockaddr   = inet_csk_addr2sockaddr,</span><br><span class="line">.sockaddr_len   = <span class="keyword">sizeof</span>(struct sockaddr_in),</span><br><span class="line">`.bind_conflict   = inet_csk_bind_conflict`, </span><br><span class="line">#ifdef CONFIG_COMPAT</span><br><span class="line">.compat_setsockopt = compat_ip_setsockopt,</span><br><span class="line">.compat_getsockopt = compat_ip_getsockopt,</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ã€€ã€€ç”±<a href="#wow1_4_3"><code>ç¬¬ä¸€ç« 4.3èŠ‚</code></a>ä¸­tcp_v4_init_sockå‡½æ•°å¯çŸ¥ipv4_specificè¢«èµ‹å€¼äºicsk-&gt;icsk_af_ops = &ipv4_specific;è€Œstruct inet_connection_sock *icsk = inet_csk(sk);    ä»£ç å¦‚ä¸‹ï¼š</p><p><code>tcp_v4_init_sock</code>å‡½æ•°åŒç¬¬ä¸€ç« 4.3èŠ‚  // net/ipv4/tcp_ipv4.c    line:1857</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* <span class="doctag">NOTE:</span> A lot of things set to zero explicitly by call to</span></span><br><span class="line"><span class="comment"> *       sk_alloc() so need not be done here.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tcp_v4_init_sock</span><span class="params">(struct sock *sk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> `*<span class="title">icsk</span> = <span class="title">inet_csk</span>(<span class="title">sk</span>)`;</span> </span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcp_sock</span> *<span class="title">tp</span> = <span class="title">tcp_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line"></span><br><span class="line">skb_queue_head_init(&amp;tp-&gt;out_of_order_queue);</span><br><span class="line">tcp_init_xmit_timers(sk);</span><br><span class="line">tcp_prequeue_init(tp);</span><br><span class="line"></span><br><span class="line">icsk-&gt;icsk_rto = TCP_TIMEOUT_INIT;</span><br><span class="line">tp-&gt;mdev = TCP_TIMEOUT_INIT;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* So many TCP implementations out there (incorrectly) count the</span></span><br><span class="line"><span class="comment"> * initial SYN frame in their delayed-ACK and congestion control</span></span><br><span class="line"><span class="comment"> * algorithms that we must have the following bandaid to talk</span></span><br><span class="line"><span class="comment"> * efficiently to them.  -DaveM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">tp-&gt;snd_cwnd = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* See draft-stevens-tcpca-spec-01 for discussion of the</span></span><br><span class="line"><span class="comment"> * initialization of these values.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">tp-&gt;snd_ssthresh = TCP_INFINITE_SSTHRESH;</span><br><span class="line">tp-&gt;snd_cwnd_clamp = ~<span class="number">0</span>;</span><br><span class="line">tp-&gt;mss_cache = TCP_MSS_DEFAULT;</span><br><span class="line"></span><br><span class="line">tp-&gt;reordering = sysctl_tcp_reordering;</span><br><span class="line">icsk-&gt;icsk_ca_ops = &amp;tcp_init_congestion_ops;</span><br><span class="line"></span><br><span class="line">sk-&gt;sk_state = TCP_CLOSE;</span><br><span class="line"></span><br><span class="line">sk-&gt;sk_write_space = sk_stream_write_space;</span><br><span class="line">sock_set_flag(sk, SOCK_USE_WRITE_QUEUE);</span><br><span class="line"></span><br><span class="line">`icsk-&gt;icsk_af_ops = &amp;ipv4_specific;`</span><br><span class="line">icsk-&gt;icsk_sync_mss = tcp_sync_mss;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TCP_MD5SIG</span></span><br><span class="line">tp-&gt;af_specific = &amp;tcp_sock_ipv4_specific;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* TCP Cookie Transactions */</span></span><br><span class="line"><span class="keyword">if</span> (sysctl_tcp_cookie_size &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="comment">/* Default, cookies without s_data_payload. */</span></span><br><span class="line">tp-&gt;cookie_values =</span><br><span class="line">kzalloc(<span class="keyword">sizeof</span>(*tp-&gt;cookie_values),</span><br><span class="line">sk-&gt;sk_allocation);</span><br><span class="line"><span class="keyword">if</span> (tp-&gt;cookie_values != <span class="literal">NULL</span>)</span><br><span class="line">kref_init(&amp;tp-&gt;cookie_values-&gt;kref);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* Presumed zeroed, in order of appearance:</span></span><br><span class="line"><span class="comment"> *cookie_in_always, cookie_out_never,</span></span><br><span class="line"><span class="comment"> *s_data_constant, s_data_in, s_data_out</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">sk-&gt;sk_sndbuf = sysctl_tcp_wmem[<span class="number">1</span>];</span><br><span class="line">sk-&gt;sk_rcvbuf = sysctl_tcp_rmem[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">local_bh_disable();</span><br><span class="line">percpu_counter_inc(&amp;tcp_sockets_allocated);</span><br><span class="line">local_bh_enable();</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ã€€ã€€ç”±ä»¥ä¸Šä»£ç å¯çŸ¥inet_csk(sk)-&gt;icsk_af_ops-&gt;bind_conflict(sk, tb)çœŸæ­£è°ƒç”¨çš„ä¸ºï¼šinet_csk_bind_conflictå‡½æ•°ã€‚<br>ã€€ã€€inet_csk_bind_conflict æ£€æŸ¥ç«¯å£æ˜¯å¦å†²çªï¼Œè¿”å›0è¡¨ç¤ºå¯ä»¥ç»‘å®šï¼Œä¸å†²çªï¼Œè¿”å›1è¡¨ç¤ºæ— æ³•ç»‘å®šè¯¥ç«¯å£ã€‚<br><code>inet_csk_bind_conflict</code>å‡½æ•°     // net/ipv4/inet_connection_sock.c    line:57</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_csk_bind_conflict</span><span class="params">(<span class="keyword">const</span> struct sock *sk,</span></span></span><br><span class="line"><span class="function"><span class="params">   <span class="keyword">const</span> struct inet_bind_bucket *tb)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">const</span> __be32 sk_rcv_saddr = inet_rcv_saddr(sk);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk2</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">hlist_node</span> *<span class="title">node</span>;</span></span><br><span class="line"><span class="keyword">int</span> reuse = sk-&gt;sk_reuse;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Unlike other sk lookup places we do not check</span></span><br><span class="line"><span class="comment"> * for sk_net here, since _all_ the socks listed</span></span><br><span class="line"><span class="comment"> * in tb-&gt;owners list belong to the same net - the</span></span><br><span class="line"><span class="comment"> * one this bucket belongs to.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">sk_for_each_bound(sk2, node, &amp;tb-&gt;owners) &#123;</span><br><span class="line"><span class="keyword">if</span> (sk != sk2 &amp;&amp;</span><br><span class="line">    !inet_v6_ipv6only(sk2) &amp;&amp;</span><br><span class="line">    (!sk-&gt;sk_bound_dev_if ||</span><br><span class="line">     !sk2-&gt;sk_bound_dev_if ||</span><br><span class="line">     sk-&gt;sk_bound_dev_if == sk2-&gt;sk_bound_dev_if)) &#123;</span><br><span class="line"><span class="keyword">if</span> (!reuse || !sk2-&gt;sk_reuse ||</span><br><span class="line">    sk2-&gt;sk_state == TCP_LISTEN) &#123;</span><br><span class="line"><span class="keyword">const</span> __be32 sk2_rcv_saddr = inet_rcv_saddr(sk2);</span><br><span class="line"><span class="keyword">if</span> (!sk2_rcv_saddr || !sk_rcv_saddr ||</span><br><span class="line">    sk2_rcv_saddr == sk_rcv_saddr)</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> node != <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-4ã€inet-bind-bucket-create"><a href="#4-4ã€inet-bind-bucket-create" class="headerlink" title="4.4ã€inet_bind_bucket_create"></a><strong>4.4ã€inet_bind_bucket_create</strong></h4><p>ã€€ã€€inet_bind_bucket_createå‡½æ•°åˆ†é…ä¸€ä¸ªinet_bind_bucketç»“æ„ä½“å®ä¾‹å¹¶è¿›è¡Œåˆå§‹åŒ–æ“ä½œï¼Œç„¶åç»‘å®šåˆ°å·²ç»‘å®šç«¯å£çš„æ•£åˆ—è¡¨ä¸­ã€‚<br><code>inet_bind_bucket_create</code>å‡½æ•°    // net/ipv4/inet_hashtables.c     line:33</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Allocate and initialize a new local port bind bucket.</span></span><br><span class="line"><span class="comment"> * The bindhash mutex for snum's hash chain must be held here.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">struct inet_bind_bucket *<span class="title">inet_bind_bucket_create</span><span class="params">(struct kmem_cache *cachep,</span></span></span><br><span class="line"><span class="function"><span class="params"> struct net *net,</span></span></span><br><span class="line"><span class="function"><span class="params"> struct inet_bind_hashbucket *head,</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> snum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_bind_bucket</span> *<span class="title">tb</span> = <span class="title">kmem_cache_alloc</span>(<span class="title">cachep</span>, <span class="title">GFP_ATOMIC</span>);</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tb != <span class="literal">NULL</span>) &#123;</span><br><span class="line">write_pnet(&amp;tb-&gt;ib_net, hold_net(net));</span><br><span class="line">tb-&gt;port      = snum;</span><br><span class="line">tb-&gt;fastreuse = <span class="number">0</span>;</span><br><span class="line">tb-&gt;num_owners = <span class="number">0</span>;</span><br><span class="line">INIT_HLIST_HEAD(&amp;tb-&gt;owners);</span><br><span class="line">hlist_add_head(&amp;tb-&gt;node, &amp;head-&gt;chain);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> tb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-5ã€inet-bind-hash"><a href="#4-5ã€inet-bind-hash" class="headerlink" title="4.5ã€inet_bind_hash"></a><strong>4.5ã€inet_bind_hash</strong></h4><p>ã€€ã€€inet_bind_hashå‡½æ•°æ›´æ–°å˜é‡<br><code>inet_bind_hash</code>å‡½æ•°    // net/ipv4/inet_hashtables.c        line:63</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inet_bind_hash</span><span class="params">(struct sock *sk, struct inet_bind_bucket *tb,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> snum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_hashinfo</span> *<span class="title">hashinfo</span> = <span class="title">sk</span>-&gt;<span class="title">sk_prot</span>-&gt;<span class="title">h</span>.<span class="title">hashinfo</span>;</span> <span class="comment">//TCPæ•£åˆ—è¡¨ç®¡ç†ç»“æ„å®ä¾‹TCP_hashinfo</span></span><br><span class="line"></span><br><span class="line">atomic_inc(&amp;hashinfo-&gt;bsockets); <span class="comment">// ç»‘å®šæ¬¡æ•°åŠ 1</span></span><br><span class="line"></span><br><span class="line">inet_sk(sk)-&gt;inet_num = snum; <span class="comment">//ç«¯å£å·èµ‹å€¼</span></span><br><span class="line">sk_add_bind_node(sk, &amp;tb-&gt;owners); <span class="comment">//æŠŠSocketåŠ å…¥åˆ°tb-&gt;ownersçš„hashè¡¨ä¸­</span></span><br><span class="line">tb-&gt;num_owners++;  <span class="comment">//ç«¯å£ç»‘å®šæ¬¡æ•°åŠ 1</span></span><br><span class="line">inet_csk(sk)-&gt;icsk_bind_hash = tb;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="5ã€inet-hashinfo-ç»“æ„ä½“"><a href="#5ã€inet-hashinfo-ç»“æ„ä½“" class="headerlink" title="5ã€inet_hashinfo ç»“æ„ä½“"></a><strong>5ã€inet_hashinfo ç»“æ„ä½“</strong></h2><p><code>inet_hashinfo</code>ç»“æ„ä½“ //include/net/inet_hashtables.h    line:118</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_hashinfo</span> &#123;</span></span><br><span class="line"><span class="comment">/* This is for sockets with full identity only.  Sockets here will</span></span><br><span class="line"><span class="comment"> * always be without wildcards and will have the following invariant:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *          TCP_ESTABLISHED &lt;= sk-&gt;sk_state &lt; TCP_CLOSE</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * TIME_WAIT sockets use a separate chain (twchain).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_ehash_bucket</span>*<span class="title">ehash</span>;</span></span><br><span class="line"><span class="keyword">spinlock_t</span>*ehash_locks;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>ehash_mask;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>ehash_locks_mask;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Ok, let's try this, I give up, we do need a local binding</span></span><br><span class="line"><span class="comment"> * TCP hash as well as the others for fast bind/connect.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_bind_hashbucket</span>*<span class="title">bhash</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>bhash_size;</span><br><span class="line"><span class="comment">/* 4 bytes hole on 64 bit */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span>*<span class="title">bind_bucket_cachep</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* All the above members are written once at bootup and</span></span><br><span class="line"><span class="comment"> * never written again _or_ are predominantly read-access.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Now align to a new cache line as all the following members</span></span><br><span class="line"><span class="comment"> * might be often dirty.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* All sockets in TCP_LISTEN state will be in here.  This is the only</span></span><br><span class="line"><span class="comment"> * table where wildcard'd TCP sockets can exist.  Hash function here</span></span><br><span class="line"><span class="comment"> * is just local port number.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_listen_hashbucket</span><span class="title">listening_hash</span>[<span class="title">INET_LHTABLE_SIZE</span>]</span></span><br><span class="line"><span class="class">____<span class="title">cacheline_aligned_in_smp</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">atomic_t</span>bsockets;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="6ã€ç»‘å®šbindä»£ç æµç¨‹å›¾"><a href="#6ã€ç»‘å®šbindä»£ç æµç¨‹å›¾" class="headerlink" title="6ã€ç»‘å®šbindä»£ç æµç¨‹å›¾"></a><strong>6ã€ç»‘å®šbindä»£ç æµç¨‹å›¾</strong></h2><div align="center"><p><img src="/img/note_0b/06.png" alt></p></div><p>ã€€ã€€bindä¸»è¦çš„ä¸»è¦æ˜¯é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ç«¯å£å·ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰æŒ‡å®šç«¯å£å·ï¼Œåˆ™ä¼šæŒ‰ç…§ä¸€å®šçš„è§„åˆ™è¿›è¡Œé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„ç«¯å£å·ã€‚<br>ã€€ã€€å¯¹äºGoogle REUSEPORT æ–°ç‰¹æ€§ï¼Œæ”¯æŒå¤šä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹ç»‘å®šåˆ°ç›¸åŒçš„ IP å’Œç«¯å£ï¼Œä»¥æé«˜ server çš„æ€§èƒ½ã€‚<br>ã€€ã€€è¯¥ç‰¹æ€§å®ç°äº† IPv4/IPv6 ä¸‹ TCP/UDP åè®®çš„æ”¯æŒï¼Œ å·²ç»é›†æˆåˆ° kernel 3.9 ä¸­ã€‚<br>ã€€ã€€æ ¸å¿ƒçš„å®ç°ä¸»è¦æœ‰ä¸‰ç‚¹ï¼š</p><p>ã€€ã€€-ï¼ˆ1ï¼‰æ‰©å±• socket optionï¼Œå¢åŠ  SO_REUSEPORT é€‰é¡¹ï¼Œç”¨æ¥è®¾ç½® reuseportã€‚<br>ã€€ã€€-ï¼ˆ2ï¼‰ä¿®æ”¹ bind ç³»ç»Ÿè°ƒç”¨å®ç°ï¼Œä»¥ä¾¿æ”¯æŒå¯ä»¥ç»‘å®šåˆ°ç›¸åŒçš„ IP å’Œç«¯å£<br>ã€€ã€€-ï¼ˆ3ï¼‰ä¿®æ”¹å¤„ç†æ–°å»ºè¿æ¥çš„å®ç°ï¼ŒæŸ¥æ‰¾ listener çš„æ—¶å€™ï¼Œèƒ½å¤Ÿæ”¯æŒåœ¨ç›‘å¬ç›¸åŒ IP å’Œç«¯å£çš„å¤šä¸ª sock ä¹‹é—´å‡è¡¡é€‰æ‹©ã€‚è¯·å‚è€ƒï¼š <u><a href="http://blog.chinaunix.net/uid-10167808-id-3807060.html" target="_blank" rel="noopener">å¤šä¸ªè¿›ç¨‹ç»‘å®šç›¸åŒç«¯å£çš„å®ç°åˆ†æ</a></u><br>ã€€ã€€å‚è€ƒèµ„æ–™ï¼š<br>ã€€ã€€ã€€ã€€<u><a href="https://blog.csdn.net/zhangskd/article/details/13631715" target="_blank" rel="noopener">Socketå±‚å®ç°ç³»åˆ— â€” bind()çš„å®ç°</a></u><br>ã€€ã€€ã€€ã€€<u><a href="http://tsecer.blog.163.com/blog/static/1501817201281211321031" target="_blank" rel="noopener">linuxä¸­ç»‘å®šä¸€ä¸ªä¸å­˜åœ¨çš„æœ¬åœ°åœ°å€</a></u></p><h2 id="ä¸‰ã€ç›‘å¬listen"><a href="#ä¸‰ã€ç›‘å¬listen" class="headerlink" title="ä¸‰ã€ç›‘å¬listen"></a><strong>ä¸‰ã€ç›‘å¬listen</strong></h2><p>ã€€ã€€<code>SYSCALL_DEFINE2(listen, int, fd, int, backlog)</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦æ˜¯åœ¨ç”¨æˆ·ç©ºé—´ä½¿ç”¨listenç³»ç»Ÿè°ƒç”¨å‡½æ•°è¿›è¡Œè°ƒç”¨æ‰§è¡Œï¼Œåœ¨Linuxå†…æ ¸ä¸­çš„è¿˜æ˜¯ä½¿ç”¨System call vectorså®ç°</p><h3 id="1ã€SYSCALL-DEFINE2-listen-â€¦"><a href="#1ã€SYSCALL-DEFINE2-listen-â€¦" class="headerlink" title="1ã€SYSCALL_DEFINE2(listen,â€¦)"></a><strong>1ã€SYSCALL_DEFINE2(listen,â€¦)</strong></h3><p>SYSCALL_DEFINE2(<code>listen</code>, int, fd, int, backlog)    // net/socket.c        line:1422</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Perform a listen. Basically, we allow the protocol to do anything</span></span><br><span class="line"><span class="comment"> *necessary for a listen, and if that works, we mark the socket as</span></span><br><span class="line"><span class="comment"> *ready for listening.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE2(`listen`, <span class="keyword">int</span>, fd, <span class="keyword">int</span>, backlog)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line"><span class="keyword">int</span> err, fput_needed;</span><br><span class="line"><span class="keyword">int</span> somaxconn; <span class="comment">//è¡¨ç¤ºsocketç›‘å¬ï¼ˆlistenï¼‰çš„backlogä¸Šé™</span></span><br><span class="line"></span><br><span class="line">sock = sockfd_lookup_light(fd, &amp;err, &amp;fput_needed); <span class="comment">//é€šè¿‡æ–‡ä»¶æè¿°ç¬¦fdæŸ¥æ‰¾å¥—æ¥å­—sock</span></span><br><span class="line"><span class="keyword">if</span> (sock) &#123;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *   # cd /proc/sys/net/core</span></span><br><span class="line"><span class="comment"> *   # cat somaxconn         128</span></span><br><span class="line"><span class="comment"> *   è¿™é‡Œé»˜è®¤æ—¶128ï¼ŒHadoopé›†ç¾¤æ—¶ä¸€èˆ¬éƒ½ä¼šå¢å¤§è¯¥å€¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">somaxconn = sock_net(sock-&gt;sk)-&gt;core.sysctl_somaxconn;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¦‚æœbacklogå€¼å¤§äºsomaxconn,backlogå°±ä¸ºsomaxconn,ä¹Ÿå°±æ˜¯æœ€å¤§å€¼ä¸èƒ½å¤§äº</span></span><br><span class="line"><span class="comment"> * somaxconn</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span>)backlog &gt; somaxconn) </span><br><span class="line">backlog = somaxconn;</span><br><span class="line"></span><br><span class="line">err = security_socket_listen(sock, backlog);</span><br><span class="line">         <span class="comment">/*</span></span><br><span class="line"><span class="comment">          *  è°ƒç”¨å¯¹äºçš„socketå±‚çš„listenå‡½æ•°ï¼Œå¦‚æœæ˜¯TCPçš„è¯ï¼Œinet_listenï¼Œæ ¹æ®</span></span><br><span class="line"><span class="comment">          *  net/ipv4/af_inet.cæ–‡ä»¶ä¸­ï¼Œconst struct proto_ops inet_stream_ops = &#123;</span></span><br><span class="line"><span class="comment">          *                                .listen = inet_listen,&#125;;å®šä¹‰</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line"><span class="keyword">if</span> (!err)</span><br><span class="line">err = `sock-&gt;ops-&gt;listen`(sock, backlog);</span><br><span class="line"></span><br><span class="line">fput_light(sock-&gt;file, fput_needed);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="2ã€backlog"><a href="#2ã€backlog" class="headerlink" title="2ã€backlog"></a><strong>2ã€backlog</strong></h3><p>ã€€ã€€é€šè¿‡man listenå¯¹äºbacklogçš„è§£é‡Š</p><blockquote><p>ã€€ã€€The <u>backlog</u> argument defines the maximum length to which the queue of pending connections for <u>sockfd</u> may grow.  If a  connection  request  arrivesã€€when the queue is full, the client may receive an error with an indication of <code>ECONNREFUSED</code> or, if the underlying protocol supports retransmission,ã€€the request may be ignored so that a later reattempt at connection succeeds.<br>ã€€ã€€The  behavior of the <u>backlog</u> argument on TCP sockets changed with Linux 2.2.  Now it specifies the queue length for <u>completely</u> established socketsã€€waiting to be accepted, instead of the number of incomplete connection requests.  The maximum length of the queue for incomplete  sockets  can  be set  using  <u>/proc/sys/net/ipv4/tcp_max_syn_backlog</u>.   When  syncookies are enabled there is no logical maximum length and this setting is ignored.<br>ã€€ã€€See <code>tcp(7)</code> for more information.<br>ã€€ã€€If the <u>backlog</u> argument is greater than the value in <u>/proc/sys/net/core/somaxconn</u>, then it is silently truncated to that value; the default  value in this file is 128.  In kernels before 2.4.25, this limit was a hard coded value, SOMAXCONN, with the value 128.</p></blockquote><p>ã€€ã€€ä¸Šé¢çš„è§£é‡Šçš„å¤§ä½“æ„æ€ä¸ºï¼šä»Linux2.2å†…æ ¸ç‰ˆæœ¬å¼€å§‹ï¼Œbacklogçš„è¡Œä¸ºå‘ç”Ÿäº†æ”¹å˜ï¼Œç°åœ¨è¯¥å‚æ•°æŒ‡å®šäº†ç­‰å¾…acceptedçš„å…¨è¿æ¥é˜Ÿåˆ—çš„é•¿åº¦ã€‚è€Œä¸æ˜¯åŠè¿æ¥çš„è¯·æ±‚çš„é˜Ÿåˆ—é•¿åº¦ã€‚å…¨è¿æ¥éœ€è¦åœ¨å®Œæˆä¸‰æ¬¡æ¡æ‰‹ä¹‹åã€‚<br>ã€€ã€€åŠè¿æ¥æœ€å¤§é•¿åº¦å¯ä»¥ä½¿ç”¨/proc/sys/net/ipv4/tcp_max_syn_backlogè¿›è¡Œè®¾ç½®ã€‚è¿™ä¸ªé»˜è®¤å€¼ä¸ºcat /proc/sys/net/ipv4/tcp_max_syn_backlog<br>ã€€ã€€1024<br>ã€€ã€€å½“syncookiesè¢«è®¾ç½®åï¼Œè¯¥å‚æ•°è¢«å¿½ç•¥æ‰ã€‚å¦‚æœbacklogå€¼å¤§äº/proc/sys/net/core/somaxconn,å®ƒå°†è¢«æˆªæ–­ï¼Œé»˜è®¤å€¼ä¸º128ã€‚ä¹Ÿå°±æ˜¯ å½“ä¼ å‚backlogçš„å€¼ &gt;= somaxconnæ—¶ï¼Œå·²å®Œæˆè¿ç»“é˜Ÿåˆ—çš„æ•°é‡æœ€å¤šå°±æ˜¯somaxconn</p><h3 id="3ã€inet-listen"><a href="#3ã€inet-listen" class="headerlink" title="3ã€inet_listen"></a><strong>3ã€inet_listen</strong></h3><p>ã€€ã€€è¯¥å‡½æ•°ä¸»è¦æ˜¯åšä¸€äº›æ£€æŸ¥å·¥ä½œï¼Œä¾‹å¦‚å½“å‰è¿æ¥çš„çŠ¶æ€ï¼Œsockçš„ç±»å‹ï¼Œæœ€ä¸»è¦çš„å¤„ç†åœ¨inet_csk_listen_startå‡½æ•°ä¸­ã€‚<br><code>inet_listen</code>å‡½æ•°    // net/ipv4/af_inet.c    line:194</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *Move a socket into listening state.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_listen</span><span class="params">(struct socket *sock, <span class="keyword">int</span> backlog)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock</span> *<span class="title">sk</span> = <span class="title">sock</span>-&gt;<span class="title">sk</span>;</span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> old_state;</span><br><span class="line"><span class="keyword">int</span> err;</span><br><span class="line"></span><br><span class="line">lock_sock(sk);</span><br><span class="line"></span><br><span class="line">err = -EINVAL;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ£€æŸ¥sockçš„çŠ¶æ€æ˜¯å¦ä¸ºSS_UNCONNECTED,sockçš„ç±»å‹æ˜¯å¦ä¸ºSOCK_STREAM,</span></span><br><span class="line"><span class="comment"> *  åªæœ‰SOCK_STREAMç±»å‹çš„sockæ‰éœ€è¦è¿›è¡Œlistenï¼Œå»ºç«‹socketåçš„åˆå§‹çŠ¶æ€ä¸º</span></span><br><span class="line"><span class="comment"> *  SS_UNCONNECTED</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (sock-&gt;state != SS_UNCONNECTED || sock-&gt;type != SOCK_STREAM)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">old_state = sk-&gt;sk_state;  <span class="comment">// è·å–sockçš„å½“å‰çŠ¶æ€ï¼Œåç»­è¦å˜æˆè€çŠ¶æ€</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  å½“å‰è¿æ¥çš„çŠ¶æ€éœ€è¦CLOSEDçŠ¶æ€å’ŒLISTENçŠ¶æ€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!((<span class="number">1</span> &lt;&lt; old_state) &amp; (TCPF_CLOSE | TCPF_LISTEN)))</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Really, if the socket is already in listen state</span></span><br><span class="line"><span class="comment"> * we can only allow the backlog to be adjusted.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¦‚æœç°åœ¨çŠ¶æ€ä¸æ˜¯ç›‘å¬</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (old_state != TCP_LISTEN) &#123;</span><br><span class="line">err = `inet_csk_listen_start`(sk, backlog); <span class="comment">//å¯ç”¨ç›‘å¬åŠŸèƒ½</span></span><br><span class="line"><span class="keyword">if</span> (err)</span><br><span class="line"><span class="keyword">goto</span> out;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * å¦‚æœsocketçš„çŠ¶æ€å·²ç»å¤„äºç›‘å¬çŠ¶æ€ï¼Œè¿™é‡Œåªæ˜¯å¯¹backlogè¿›è¡Œè°ƒæ•´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">sk-&gt;sk_max_ack_backlog = backlog; </span><br><span class="line">err = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">release_sock(sk);</span><br><span class="line"><span class="keyword">return</span> err;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="4ã€inet-csk-listen-startå‡½æ•°"><a href="#4ã€inet-csk-listen-startå‡½æ•°" class="headerlink" title="4ã€inet_csk_listen_startå‡½æ•°"></a><strong>4ã€inet_csk_listen_startå‡½æ•°</strong></h3><p>ã€€ã€€è¯¥å‡½æ•°ä½¿TCPä¼ è¾“æ§åˆ¶å—è¿›å…¥ç›‘å¬çŠ¶æ€ï¼Œå®ç°ç›‘å¬çš„è¿‡ç¨‹æ˜¯ï¼šä¸ºç®¡ç†è¿æ¥è¯·æ±‚çš„æ•£åˆ—è¡¨åˆ†é…å­˜å‚¨ç©ºé—´ï¼Œæ¥ç€ä½¿TCPçš„sockçŠ¶æ€è¿ç§»åˆ°LISTENçŠ¶æ€ï¼Œç„¶åå°†sockåŠ å…¥åˆ°ç›‘å¬æ•£åˆ—è¡¨ä¸­ã€‚<br><code>inet_csk_listen_start</code>å‡½æ•°  // net/ipv4/inet_connection_sock.c        line:645</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">inet_csk_listen_start</span><span class="params">(struct sock *sk, <span class="keyword">const</span> <span class="keyword">int</span> nr_table_entries)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_sock</span> *<span class="title">inet</span> = <span class="title">inet_sk</span>(<span class="title">sk</span>);</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_connection_sock</span> *<span class="title">icsk</span> = <span class="title">inet_csk</span>(<span class="title">sk</span>);</span></span><br><span class="line">     <span class="comment">/*</span></span><br><span class="line"><span class="comment">      *  åˆå§‹åŒ–å…¨è¿æ¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"><span class="keyword">int</span> rc = `reqsk_queue_alloc`(&amp;icsk-&gt;icsk_accept_queue, nr_table_entries); </span><br><span class="line"><span class="keyword">if</span> (rc != <span class="number">0</span>)</span><br><span class="line"><span class="keyword">return</span> rc;</span><br><span class="line"></span><br><span class="line">sk-&gt;sk_max_ack_backlog = <span class="number">0</span>;  <span class="comment">// æœ€å¤§çš„å…¨è¿æ¥é˜Ÿåˆ—</span></span><br><span class="line">sk-&gt;sk_ack_backlog = <span class="number">0</span>;   <span class="comment">// å½“å‰çš„å…¨è¿æ¥é˜Ÿåˆ—</span></span><br><span class="line">inet_csk_delack_init(sk);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* There is race window here: we announce ourselves listening,</span></span><br><span class="line"><span class="comment"> * but this transition is still not validated by get_port().</span></span><br><span class="line"><span class="comment"> * It is OK, because this socket enters to hash table only</span></span><br><span class="line"><span class="comment"> * after validation is complete.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">sk-&gt;sk_state = TCP_LISTEN;  <span class="comment">// è®¾ç½®ç°åœ¨çš„çŠ¶æ€ä¸ºTCP_LISTENçŠ¶æ€</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * æ£€æŸ¥ç«¯å£å·æ˜¯å¦å¯ç”¨ï¼Œé˜²æ­¢bindåä¿®æ”¹</span></span><br><span class="line"><span class="comment"> *  struct proto tcp_prot = &#123;</span></span><br><span class="line"><span class="comment"> *        .unhash = inet_unhash,</span></span><br><span class="line"><span class="comment"> *        .get_port = inet_csk_get_port,&#125;</span></span><br><span class="line"><span class="comment"> *  è°ƒç”¨get_portå‡½æ•°ä¸bindæ—¶è°ƒç”¨çš„æ˜¯åŒä¸€ä¸ªå‡½æ•°å¦‚æœæ­£ç¡®è¿”å›ä¸º0ï¼Œå…¶ä¸­inet_num</span></span><br><span class="line"><span class="comment"> *  å°±æ˜¯bindçš„ç«¯å£ï¼Œå¦‚æœæ²¡æœ‰ç»‘å®šç«¯å£å°±è¿›è¡Œç»‘å®šç«¯å£æ“ä½œã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">if</span> (!sk-&gt;sk_prot-&gt;get_port(sk, inet-&gt;inet_num)) &#123;</span><br><span class="line">inet-&gt;inet_sport = htons(inet-&gt;inet_num);</span><br><span class="line"></span><br><span class="line">sk_dst_reset(sk);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *   æŠŠsocketæ·»åŠ åˆ°ç›‘å¬HASHè¡¨ä¸­ï¼Œstrutc proto tcp_prot = &#123;</span></span><br><span class="line"><span class="comment"> *        .hash = inet_hash</span></span><br><span class="line"><span class="comment"> *    &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">`sk-&gt;sk_prot-&gt;hash`(sk); </span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sk-&gt;sk_state = TCP_CLOSE; <span class="comment">//å¦‚æœç«¯å£ä¸å†å¯ç”¨ï¼Œè®¾ç½®socketçš„çŠ¶æ€ä¸ºTCP_CLOSE,å¹¶é”€æ¯å…¨è¿æ¥é˜Ÿåˆ—</span></span><br><span class="line">__reqsk_queue_destroy(&amp;icsk-&gt;icsk_accept_queue);</span><br><span class="line"><span class="keyword">return</span> -EADDRINUSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-1ã€reqsk-queue-allocå‡½æ•°"><a href="#4-1ã€reqsk-queue-allocå‡½æ•°" class="headerlink" title="4.1ã€reqsk_queue_allocå‡½æ•°"></a><strong>4.1ã€reqsk_queue_allocå‡½æ•°</strong></h4><p><code>reqsk_queue_aclloc</code>  // net/core/request_sock.c        line:37</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">reqsk_queue_alloc</span><span class="params">(struct request_sock_queue *<span class="built_in">queue</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">unsigned</span> <span class="keyword">int</span> nr_table_entries)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">size_t</span> lopt_size = <span class="keyword">sizeof</span>(struct listen_sock);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">listen_sock</span> *<span class="title">lopt</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *  è¿™é‡Œnr_table_entries æœ€å¤§å€¼ä¼ è¿›æ¥æ—¶128ï¼Œsysctl_max_backlogå€¼ä¸º256ï¼Œæ‰€ä»¥</span></span><br><span class="line"><span class="comment"> *è¿™é‡Œæœ€å°å€¼ä¸ä¼šå°äº8ï¼Œæœ€å¤§å€¼ä¸ä¼šå¤§äº128ï¼Œåœ¨[8,128]ä¹‹é—´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">nr_table_entries = <span class="keyword">min_t</span>(u32, nr_table_entries, sysctl_max_syn_backlog);</span><br><span class="line">nr_table_entries = <span class="keyword">max_t</span>(u32, nr_table_entries, <span class="number">8</span>);</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * å–ä¸€ä¸ªæœ€æ¥è¿‘z^nçš„å€¼èµ‹ç»™nr_table_entries</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">nr_table_entries = roundup_pow_of_two(nr_table_entries + <span class="number">1</span>);</span><br><span class="line">lopt_size += nr_table_entries * <span class="keyword">sizeof</span>(struct request_sock *); <span class="comment">//ç¡®å®šé˜Ÿåˆ—å¤§å°</span></span><br><span class="line"><span class="keyword">if</span> (lopt_size &gt; PAGE_SIZE)</span><br><span class="line">lopt = __vmalloc(lopt_size,</span><br><span class="line">GFP_KERNEL | __GFP_HIGHMEM | __GFP_ZERO,</span><br><span class="line">PAGE_KERNEL);<span class="comment">//å¦‚æœç”³è¯·å¾—ç©ºé—´å¤§äº1é¡µï¼Œåˆ™ç¥å¥‡è™šæ‹Ÿåœ°å€ç©ºé—´è¿ç»­</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">lopt = kzalloc(lopt_size, GFP_KERNEL);<span class="comment">//å°äº1é¡µï¼Œåœ¨å¸¸è§„å†…å­˜ä¸­åˆ†é…å†…å­˜</span></span><br><span class="line"><span class="keyword">if</span> (lopt == <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">return</span> -ENOMEM;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * forå¾ªç¯è®¡ç®—nr_table_entrieså·²2ä¸ºåº•çš„å¯¹æ•°ï¼Œè®¡ç®—ç»“æœå°±å­˜å‚¨åœ¨max_qlen_logæˆå‘˜ä¸­ï¼Œ</span></span><br><span class="line"><span class="comment"> * eg:å¦‚æœnr_table_entries = 1024,max_qlen_log = 10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">for</span> (lopt-&gt;max_qlen_log = <span class="number">3</span>; \</span><br><span class="line">(<span class="number">1</span> &lt;&lt; lopt-&gt;max_qlen_log) &lt; nr_table_entries; \</span><br><span class="line">lopt-&gt;max_qlen_log++);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*ä¸Šé¢çš„ä»£ç å®é™…ä¸Šæ˜¯ç¡®è®¤äº†åŠè¿æ¥é˜Ÿåˆ—çš„é•¿åº¦ï¼Œè¿™ä¸ªå€¼è¿˜å—ç³»ç»Ÿé…ç½®sysctl_max_syn_backlogçš„</span></span><br><span class="line"><span class="comment"> * å½±å“ï¼Œæ‰€ä»¥å¦‚æœæƒ³è°ƒå¤§ç›‘å¬å¥—æ¥å­—çš„åŠè¿æ¥é˜Ÿåˆ—ï¼Œé™¤äº†å¢å¤§listen()çš„backlogå‚æ•°å¤–ï¼Œè¿˜éœ€è¦è°ƒæ•´</span></span><br><span class="line"><span class="comment"> * sysctl_max_syn_backlogç³»ç»Ÿé…ç½®çš„å€¼ï¼Œprocæ–‡ä»¶ä¸º /proc/sys/net/ipv4/tcp_max_syn_backlog</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">get_random_bytes(&amp;lopt-&gt;hash_rnd, <span class="keyword">sizeof</span>(lopt-&gt;hash_rnd));  <span class="comment">//å¾—åˆ°ä¸€ä¸ªéšæœºæ•°ï¼Œç”¨äºHASH</span></span><br><span class="line">rwlock_init(&amp;<span class="built_in">queue</span>-&gt;syn_wait_lock);</span><br><span class="line"><span class="built_in">queue</span>-&gt;rskq_accept_head = <span class="literal">NULL</span>; <span class="comment">//å…¨è¿æ¥é˜Ÿåˆ—ç½®ä¸ºç©º</span></span><br><span class="line">lopt-&gt;nr_table_entries = nr_table_entries; <span class="comment">//åŠè¿æ¥é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦</span></span><br><span class="line"></span><br><span class="line">write_lock_bh(&amp;<span class="built_in">queue</span>-&gt;syn_wait_lock);</span><br><span class="line"><span class="built_in">queue</span>-&gt;listen_opt = lopt; <span class="comment">//åˆå§‹åŒ–åŠè¿æ¥é˜Ÿåˆ—ï¼Œå…¶å®å°±æ˜¯icsk_accept_queue.listen_opt-&gt;syn_table</span></span><br><span class="line">write_unlock_bh(&amp;<span class="built_in">queue</span>-&gt;syn_wait_lock);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-2ã€inet-hashå‡½æ•°"><a href="#4-2ã€inet-hashå‡½æ•°" class="headerlink" title="4.2ã€inet_hashå‡½æ•°"></a><strong>4.2ã€inet_hashå‡½æ•°</strong></h4><p><code>inet_hash</code>å‡½æ•°  // net/ipv4/inet_hashtables.c         line:401</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">inet_hash</span><span class="params">(struct sock *sk)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="keyword">if</span> (sk-&gt;sk_state != TCP_CLOSE) &#123;</span><br><span class="line">local_bh_disable();</span><br><span class="line">`__inet_hash`(sk);</span><br><span class="line">local_bh_enable();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> __inet_hash(struct sock *sk)</span><br><span class="line">&#123;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_hashinfo</span> *<span class="title">hashinfo</span> = <span class="title">sk</span>-&gt;<span class="title">sk_prot</span>-&gt;<span class="title">h</span>.<span class="title">hashinfo</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_listen_hashbucket</span> *<span class="title">ilb</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sk-&gt;sk_state != TCP_LISTEN) &#123; <span class="comment">// socketä¸å¤„äºç›‘å¬çŠ¶æ€</span></span><br><span class="line">__inet_hash_nolisten(sk, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WARN_ON(!sk_unhashed(sk));</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æ ¹æ®ç›‘å¬ç«¯å£å·ï¼ŒæŸ¥æ‰¾ç›¸å¯¹åº”çš„HASH</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ilb = &amp;hashinfo-&gt;listening_hash[inet_sk_listen_hashfn(sk)];</span><br><span class="line"></span><br><span class="line">spin_lock(&amp;ilb-&gt;lock);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * æŠŠsockæ·»åŠ åˆ°ç›‘å¬HASHæ¡¶çš„å¤´éƒ¨ï¼Œè¿æ¥åˆ°sk-&gt;sk_nulls_node </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">__sk_nulls_add_node_rcu(sk, &amp;ilb-&gt;head);</span><br><span class="line">sock_prot_inuse_add(sock_net(sk), sk-&gt;sk_prot, <span class="number">1</span>);</span><br><span class="line">spin_unlock(&amp;ilb-&gt;lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="5ã€ç›‘å¬listenä»£ç æµç¨‹å›¾"><a href="#5ã€ç›‘å¬listenä»£ç æµç¨‹å›¾" class="headerlink" title="5ã€ç›‘å¬listenä»£ç æµç¨‹å›¾"></a><strong>5ã€ç›‘å¬listenä»£ç æµç¨‹å›¾</strong></h3><div align="center"><p><img src="/img/note_0b/07.png" alt></p></div><ul><li>(1)listenåˆå§‹åŒ–äº†åŠè¿æ¥é˜Ÿåˆ—å’Œå…¨è¿æ¥é˜Ÿåˆ—</li><li>(2)å®ç°ä¾¦å¬ï¼Œä½¿TCPä¼ è¾“æ§åˆ¶å—çš„çŠ¶æ€è¿ç§»åˆ°LISTENçŠ¶æ€ï¼Œç„¶åå°†ä¼ è¾“æ§åˆ¶å—æ·»åŠ åˆ°ä¾¦å¬æ•£åˆ—è¡¨ä¸­</li></ul>]]></content>
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> socket </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>ç¨‹åºå‘˜ä¹¦ç±</title>
      <link href="/2018/05/29/%E6%9D%82%E8%AF%BB/03%E7%A8%8B%E5%BA%8F%E5%91%98%E4%B9%A6%E5%8D%95/"/>
      <url>/2018/05/29/%E6%9D%82%E8%AF%BB/03%E7%A8%8B%E5%BA%8F%E5%91%98%E4%B9%A6%E5%8D%95/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><span class="reprint">è½¬</span></p><h2 id="ç¨‹åºå‘˜å¿…è¯»ä¹¦ç±"><a href="#ç¨‹åºå‘˜å¿…è¯»ä¹¦ç±" class="headerlink" title="ç¨‹åºå‘˜å¿…è¯»ä¹¦ç±"></a><strong><a href="http://www.ituring.com.cn/article/198286" target="_blank" rel="noopener">ç¨‹åºå‘˜å¿…è¯»ä¹¦ç±</a></strong></h2><h4 id="å…¥é—¨ä¹¦ç±"><a href="#å…¥é—¨ä¹¦ç±" class="headerlink" title="å…¥é—¨ä¹¦ç±"></a><strong>å…¥é—¨ä¹¦ç±</strong></h4><p><strong>ç¨‹åºè®¾è®¡ï¼š</strong></p><ul><li>01.åŸºç¡€ç†è®ºï¼šç¼–ç ï¼šéšåŒ¿åœ¨è®¡ç®—æœºè½¯ç¡¬ä»¶èƒŒåçš„è¯­è¨€</li><li>02.ç¼–ç¨‹è¯­è¨€ï¼š<ul><li>Cï¼šCå’ŒæŒ‡é’ˆ</li><li>C++ï¼šC++ç¨‹åºè®¾è®¡åŸç†ä¸å®è·µ</li><li>Javaï¼šJavaæ ¸å¿ƒæŠ€æœ¯ï¼ˆç¬¬9ç‰ˆï¼‰</li><li>C#ï¼šç²¾é€šC#ï¼ˆç¬¬6ç‰ˆï¼‰</li><li>JavaScriptï¼šJavaScript DOMç¼–ç¨‹è‰ºæœ¯ï¼ˆç¬¬2ç‰ˆï¼‰</li><li>Pythonï¼šPythonåŸºç¡€æ•™ç¨‹ï¼ˆç¬¬äºŒç‰ˆï¼‰</li></ul></li><li>03.ç¼–ç¨‹è¯­è¨€ç†è®ºï¼šç¼–ç¨‹è¯­è¨€å®ç°æ¨¡å¼</li><li>04.ç¨‹åºè®¾è®¡ï¼šç¨‹åºè®¾è®¡æ–¹æ³•</li><li>05.ç®—æ³•ä¸æ•°æ®ç»“æ„ï¼šç®—æ³•ï¼ˆç¬¬4ç‰ˆï¼‰</li><li>06.ç¨‹åºè°ƒè¯•ï¼šè°ƒè¯•ä¹æ³•â€”â€”è½¯ç¡¬ä»¶é”™è¯¯çš„æ’æŸ¥ä¹‹é“</li></ul><p><strong>è½¯ä»¶å¼€å‘ï¼š</strong></p><ul><li>01.ç¼–ç¨‹å®è·µï¼šç¨‹åºè®¾è®¡å®è·µ</li><li>02.é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ï¼šHead Firstè®¾è®¡æ¨¡å¼</li><li>03.é‡æ„ï¼šé‡æ„</li><li>04.è½¯ä»¶æµ‹è¯•ï¼šHow to Break Software</li><li>05.é¡¹ç›®ç®¡ç†ï¼šæå®¢ä¸å›¢é˜Ÿ</li><li>06.ä¸“ä¸šå¼€å‘ï¼šç¨‹åºå‘˜ä¿®ç‚¼ä¹‹é“ï¼šä»å°å·¥åˆ°ä¸“å®¶</li><li>07.å¤§å¸ˆä¹‹è¨€ï¼šå¥‡æ€å¦™æƒ³ï¼š15ä½è®¡ç®—æœºå¤©æ‰åŠå…¶é‡å¤§å‘ç°</li><li>08.ç•Œé¢è®¾è®¡ï¼šå†™ç»™å¤§å®¶çœ‹çš„è®¾è®¡ä¹¦</li><li>09.äº¤äº’è®¾è®¡ï¼šé€šç”¨è®¾è®¡æ³•åˆ™</li></ul><p><strong>ä¸ªäººæˆé•¿ï¼š</strong></p><ul><li>01.èŒä¸šè§„åˆ’ï¼šè½¯ä»¶å¼€å‘è€…è·¯çº¿å›¾</li><li>02.æ€ç»´æ–¹å¼ï¼šç¨‹åºå‘˜çš„æ€ç»´ä¿®ç‚¼ï¼šå¼€å‘è®¤çŸ¥æ½œèƒ½çš„ä¹å ‚è¯¾</li><li>03.æ±‚èŒé¢è¯•ï¼šé‡‘é¢†ç®€å†ï¼šæ•²å¼€è‹¹æœå¾®è½¯è°·æ­Œçš„å¤§é—¨</li><li>04.è‹±è¯­å†™ä½œï¼šThe Only Grammar Book Youâ€™ll Ever Need</li></ul><h4 id="å¿…è¯»ä¹¦ç±"><a href="#å¿…è¯»ä¹¦ç±" class="headerlink" title="å¿…è¯»ä¹¦ç±"></a><strong>å¿…è¯»ä¹¦ç±</strong></h4><p><strong>ç¨‹åºè®¾è®¡ï¼š</strong></p><ul><li>01.åŸºç¡€ç†è®ºï¼šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿï¼ˆç¬¬2ç‰ˆï¼‰</li><li>02.ç¼–ç¨‹è¯­è¨€ï¼š<ul><li>Cï¼šCç¨‹åºè®¾è®¡è¯­è¨€ï¼ˆç¬¬2ç‰ˆï¼‰</li><li>C++ï¼šC++ç¨‹åºè®¾è®¡è¯­è¨€ï¼ˆç¬¬4ç‰ˆï¼‰</li><li>Javaï¼šEffective Javaï¼ˆç¬¬2ç‰ˆï¼‰</li><li>C#ï¼šCLR via C#ï¼ˆç¬¬4ç‰ˆï¼‰</li><li>JavaScriptï¼šJavaScriptè¯­è¨€ç²¾ç²¹</li><li>Pythonï¼šPythonå‚è€ƒæ‰‹å†Œï¼ˆç¬¬4ç‰ˆï¼‰</li></ul></li><li>03.ç¼–ç¨‹è¯­è¨€ç†è®ºï¼šç¨‹åºè®¾è®¡è¯­è¨€â€”â€”å®è·µä¹‹è·¯ï¼ˆç¬¬3ç‰ˆï¼‰</li><li>04.ç¨‹åºè®¾è®¡ï¼šè®¡ç®—æœºç¨‹åºçš„æ„é€ ä¸è§£é‡Šï¼ˆç¬¬2ç‰ˆï¼‰</li><li>05.ç®—æ³•ä¸æ•°æ®ç»“æ„ï¼šç¼–ç¨‹ç ç‘ï¼ˆç¬¬2ç‰ˆï¼‰</li><li>06.ç¨‹åºè°ƒè¯•ï¼šè°ƒè¯•ä¹æ³•â€”â€”è½¯ç¡¬ä»¶é”™è¯¯çš„æ’æŸ¥ä¹‹é“</li></ul><p><strong>è½¯ä»¶å¼€å‘ï¼š</strong></p><ul><li>01.ç¼–ç¨‹å®è·µï¼šä»£ç å¤§å…¨ï¼ˆç¬¬2ç‰ˆï¼‰</li><li>02.é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ï¼šè®¾è®¡æ¨¡å¼</li><li>03.é‡æ„ï¼šä¿®æ”¹ä»£ç çš„è‰ºæœ¯</li><li>04.è½¯ä»¶æµ‹è¯•ï¼šxUnit Test Patterns</li><li>05.é¡¹ç›®ç®¡ç†ï¼šäººæœˆç¥è¯</li><li>06.ä¸“ä¸šå¼€å‘ï¼šç¨‹åºå‘˜èŒä¸šç´ å…»</li><li>07.å¤§å¸ˆä¹‹è¨€ï¼šç¼–ç¨‹äººç”Ÿï¼š15ä½è½¯ä»¶å…ˆé©±è®¿è°ˆå½•</li><li>08.ç•Œé¢è®¾è®¡ï¼šè®¤çŸ¥ä¸è®¾è®¡ï¼šç†è§£UIè®¾è®¡å‡†åˆ™ï¼ˆç¬¬2ç‰ˆï¼‰</li><li>09.äº¤äº’è®¾è®¡ï¼šäº¤äº’è®¾è®¡ç²¾é«“ï¼ˆç¬¬3ç‰ˆï¼‰</li></ul><p><strong>ä¸ªäººæˆé•¿ï¼š</strong></p><ul><li>01.èŒä¸šè§„åˆ’ï¼šè½¯ä»¶å¼€å‘è€…è·¯çº¿å›¾</li><li>02.æ€ç»´æ–¹å¼ï¼šå¦‚ä½•æŠŠäº‹æƒ…åšåˆ°æœ€å¥½</li><li>03.æ±‚èŒé¢è¯•ï¼šç¨‹åºå‘˜é¢è¯•é‡‘å…¸ï¼ˆç¬¬5ç‰ˆï¼‰</li><li>04.è‹±è¯­å†™ä½œï¼šé£æ ¼çš„è¦ç´ </li></ul>]]></content>
      
      <categories>
          
          <category> æ‚è¯» </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è½¬è½½ </tag>
            
            <tag> æŠ€æœ¯ä¹¦ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Ubuntuä¸‹json-cå®‰è£…ä¸ä½¿ç”¨</title>
      <link href="/2018/05/25/%E5%B7%A5%E5%85%B7/04Ubuntu%E4%B8%8Bjson-c%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/"/>
      <url>/2018/05/25/%E5%B7%A5%E5%85%B7/04Ubuntu%E4%B8%8Bjson-c%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="Ubuntuä¸‹json-cå®‰è£…ä¸ä½¿ç”¨"><a href="#Ubuntuä¸‹json-cå®‰è£…ä¸ä½¿ç”¨" class="headerlink" title="Ubuntuä¸‹json-cå®‰è£…ä¸ä½¿ç”¨"></a>Ubuntuä¸‹json-cå®‰è£…ä¸ä½¿ç”¨</h2><h4 id="1ã€è·å–å¹¶ç¼–è¯‘json-c"><a href="#1ã€è·å–å¹¶ç¼–è¯‘json-c" class="headerlink" title="1ã€è·å–å¹¶ç¼–è¯‘json-c"></a>1ã€è·å–å¹¶ç¼–è¯‘json-c</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//è·å–æºä»£ç </span><br><span class="line">git <span class="built_in">clone</span> https://github.com/json-c/json-c.git</span><br><span class="line"><span class="built_in">cd</span> json-c</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure><h4 id="2ã€ä½¿ç”¨json-c"><a href="#2ã€ä½¿ç”¨json-c" class="headerlink" title="2ã€ä½¿ç”¨json-c"></a>2ã€ä½¿ç”¨json-c</h4><p>é€šè¿‡<code>sudo make install</code>å¯ä»¥çœ‹å‡ºjson-cçš„å¤´æ–‡ä»¶å’Œåº“æ‰€å®‰è£…ä½ç½®<br><img src="/img/tools_04/01.png" alt></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## æŸ¥çœ‹åº“è·¯å¾„å’Œå¤´æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤´æ–‡ä»¶æ‰€åœ¨è·¯å¾„</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/include/json-c</span><br><span class="line">ls</span><br><span class="line"><span class="comment"># åº“æ‰€åœ¨è·¯å¾„</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/lib/</span><br><span class="line">ls</span><br></pre></td></tr></table></figure><p><img src="/img/tools_04/02.png" alt><br>ä¸€èˆ¬ä½¿ç”¨ä¸­åªéœ€åœ¨ä»£ç ä¸­åŒ…å«json.h</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.c</span></span><br><span class="line">....</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;json-c/json.h&gt;</span></span></span><br><span class="line">....</span><br><span class="line">....</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘test.c</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc test.c -ljson-c</span><br></pre></td></tr></table></figure><p>æ³¨ï¼š<code>-l</code> ä»£è¡¨åº“æ–‡ä»¶è·¯å¾„</p><h4 id="3ã€å¸¸è§é—®é¢˜"><a href="#3ã€å¸¸è§é—®é¢˜" class="headerlink" title="3ã€å¸¸è§é—®é¢˜"></a>3ã€å¸¸è§é—®é¢˜</h4><p>é—®é¢˜1ï¼šæ‰§è¡Œæ—¶å‡ºé”™â€error while loading shared libraries: libjson-c.so.4: cannot open shared object file: No such file or directoryâ€</p><p>ä¿®å¤æ–¹æ³•ï¼š/etc/ld.so.confä¸­åŠ å…¥jsonåº“è·¯å¾„ã€‚å¯åœ¨<code>/etc/ld.so.conf</code>ä¸­åŠ å…¥è¯¥è¡Œ<code>/usr/local/lib</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># file /etc/ld.so.conf</span></span><br><span class="line"></span><br><span class="line">include /etc/ld.so.conf.d/*.conf</span><br><span class="line">/usr/<span class="built_in">local</span>/bin          <span class="comment">#æ–°å¢å†…å®¹</span></span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linuxå·¥å…· </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Windows æ¸…é™¤ç³»ç»Ÿåƒåœ¾è„šæœ¬</title>
      <link href="/2018/05/24/%E5%B7%A5%E5%85%B7/03Windows%E6%B8%85%E9%99%A4%E5%9E%83%E5%9C%BE%E8%84%9A%E6%9C%AC/"/>
      <url>/2018/05/24/%E5%B7%A5%E5%85%B7/03Windows%E6%B8%85%E9%99%A4%E5%9E%83%E5%9C%BE%E8%84%9A%E6%9C%AC/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line"><span class="built_in">echo</span> æ­£åœ¨æ¸…é™¤ç³»ç»Ÿåƒåœ¾æ–‡ä»¶ï¼Œè¯·ç¨ç­‰......</span><br><span class="line"><span class="built_in">del</span> /f /s /q <span class="variable">%systemdrive%</span>\*.tmp</span><br><span class="line"><span class="built_in">del</span> /f /s /q <span class="variable">%systemdrive%</span>\*._mp</span><br><span class="line"><span class="built_in">del</span> /f /s /q <span class="variable">%systemdrive%</span>\*.log</span><br><span class="line"><span class="built_in">del</span> /f /s /q <span class="variable">%systemdrive%</span>\*.gid</span><br><span class="line"><span class="built_in">del</span> /f /s /q <span class="variable">%systemdrive%</span>\*.chk</span><br><span class="line"><span class="built_in">del</span> /f /s /q <span class="variable">%systemdrive%</span>\*.old</span><br><span class="line"><span class="built_in">del</span> /f /s /q <span class="variable">%systemdrive%</span>\recycled\*.*</span><br><span class="line"><span class="built_in">del</span> /f /s /q <span class="variable">%windir%</span>\*.bak</span><br><span class="line"><span class="built_in">del</span> /f /s /q <span class="variable">%windir%</span>\prefetch\*.*</span><br><span class="line"><span class="built_in">rd</span> /s /q <span class="variable">%windir%</span>\temp &amp; <span class="built_in">md</span> <span class="variable">%windir%</span>\temp</span><br><span class="line"><span class="built_in">del</span> /f /q <span class="variable">%userprofile%</span>\cookies\*.*</span><br><span class="line"><span class="built_in">del</span> /f /q <span class="variable">%userprofile%</span>\recent\*.*</span><br><span class="line"><span class="built_in">del</span> /f /s /q "<span class="variable">%userprofile%</span>\Local Settings\Temporary Internet Files\*.*"</span><br><span class="line"><span class="built_in">del</span> /f /s /q "<span class="variable">%userprofile%</span>\Local Settings\Temp\*.*"</span><br><span class="line"><span class="built_in">del</span> /f /s /q "<span class="variable">%userprofile%</span>\recent\*.*"</span><br><span class="line"><span class="built_in">echo</span> æ¸…é™¤ç³»ç»ŸLJå®Œæˆï¼</span><br><span class="line"><span class="built_in">echo</span>. &amp; <span class="built_in">pause</span></span><br></pre></td></tr></table></figure><p><a href="/bat/clear.bat">clear.batè„šæœ¬ä¸‹è½½</a></p>]]></content>
      
      <categories>
          
          <category> å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> winå·¥å…· </tag>
            
            <tag> winè„šæœ¬ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Lucié…ç½®ç•Œé¢å¼€å‘æ¡†æ¶</title>
      <link href="/2018/05/24/%E5%89%8D%E7%AB%AF/01Luci%E9%85%8D%E7%BD%AE%E7%95%8C%E9%9D%A2%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6/"/>
      <url>/2018/05/24/%E5%89%8D%E7%AB%AF/01Luci%E9%85%8D%E7%BD%AE%E7%95%8C%E9%9D%A2%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>Lucié…ç½®ç•Œé¢å¼€å‘æ¡†æ¶</p><p>MVC:</p><blockquote><p>Model(/usr/lib/lua/luci/model/cbi)<br>Controller(/usr/lib/lua/luci/controller)<br>View()</p></blockquote><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/uhttpd -f -h /www -r LEDE -x /cgi-bin -u /ubus -t 60 -T 30 -k 20 -A 1 -n 3 -N 100 -R -p 0.0.0.0:80 -p [::]:80</span><br></pre></td></tr></table></figure><p>uhttpdæ˜¯åŸºäºubox ubus json-cçš„ï¼Œå¦‚æœåŠ ä¸Šssl,è¿˜éœ€è¦opensslåº“</p><h2 id="openwrt-libuboxï¼š"><a href="#openwrt-libuboxï¼š" class="headerlink" title="openwrt libuboxï¼š"></a>openwrt libuboxï¼š</h2><p>libuboxæ˜¯openwrtæ–°ç‰ˆæœ¬ä¸­çš„ä¸€ä¸ªåŸºç¡€åº“ï¼Œåœ¨openwrtä¸­æœ‰å¾ˆå¤šåº”ç”¨ç¨‹åºæ˜¯åŸºäºlibuboxå¼€å‘çš„ã€‚ï¼ˆå¦‚uhttpd, linubusï¼‰ã€‚</p><h3 id="libubox"><a href="#libubox" class="headerlink" title="libubox:"></a>libubox:</h3><blockquote><ul><li>æä¾›ä¸€å¥—åŸºäºäº‹ä»¶é©±åŠ¨çš„æœºåˆ¶  </li><li>æä¾›å¤šç§å¼€å‘æ”¯æŒæ¥å£ã€‚ï¼ˆå¦‚é“¾è¡¨ã€kvèŠè¡¨ã€å¹³è¡¡æŸ¥æ‰¾äºŒå‰æ ‘ã€md5ã€jsonï¼‰</li></ul></blockquote><p>ä½¿ç”¨libuboxå¼€å‘çš„å¥½å¤„æœ‰å¦‚ä¸‹å‡ ç‚¹ï¼š</p><blockquote><ul><li>1ã€å¯ä»¥æ˜¯ç¨‹åºåŸºäºäº‹ä»¶é©±åŠ¨ï¼Œä»è€Œå¯å®ç°åœ¨å•è¿›ç¨‹ä¸­å¤„ç†å¤šä¸ªä»»åŠ¡</li><li>2ã€åŸºäºlibuboxæä¾›çš„å¼€å‘APIå¯ä»¥åŠ å¿«å¼€å‘è¿›åº¦çš„åŒæ—¶æé«˜ç¨‹åºçš„ç¨³å®šæ€§</li><li>3ã€èƒ½æ›´å¥½çš„å°†ç¨‹åºèå…¥openwrtçš„å¼€å‘æ¶æ„ä¸­ï¼Œå› ä¸ºæ–°çš„openwrtå¾—å¾ˆå¤šåº”ç”¨å’Œåº“éƒ½åŸºäºlibuboxå¼€å‘çš„</li></ul></blockquote><h2 id="openwrt-ubus"><a href="#openwrt-ubus" class="headerlink" title="openwrt ubus"></a>openwrt ubus</h2><p>ubusæ˜¯æœ€æ–°openwrtå¼•å…¥çš„ä¸€ä¸ªæ¶ˆæ¯æ€»çº¿ï¼Œä¸»è¦ä½œç”¨æ˜¯å®ç°ä¸åŒåº”ç”¨ç¨‹åºä¹‹é—´çš„ä¿¡æ¯äº¤äº’ã€‚<br>ubuså¯åŠ¨åä¼šåœ¨åå°è¿è¡Œubusdè¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹ç›‘å¬ä¸€ä¸ªunixå¥—æ¥å­—ç”¨äºä¸å…¶ä»–åº”ç”¨ç¨‹åºé€šä¿¡ã€‚å…¶ä»–åº”ç”¨ç¨‹åºå¯åŸºäºlibuboxæä¾›çš„æ¥å£ï¼ˆæˆ–è‡ªå·±å®ç°ï¼‰ä¸å…¶é€šä¿¡ã€‚</p><p>ä½¿ç”¨ubusçš„æ–¹å¼ä¸»è¦æœ‰ï¼š  </p><blockquote><ul><li>1ã€å‘å…¶æ³¨å†Œæ¶ˆæ¯æˆ–æ§åˆ¶æ¥å£ã€‚  </li><li>2ã€å‘å…¶è°ƒç”¨å…¶ä»–åº”ç”¨ç¨‹åºçš„æ¶ˆæ¯æˆ–æ§åˆ¶æ¥å£ã€‚  </li><li>3ã€å‘å…¶æ³¨å†Œå…³å¿ƒäº‹ä»¶</li></ul></blockquote><p><a href="https://wiki.openwrt.org/zh-cn/doc/uci" target="_blank" rel="noopener">ubus (OpenWrt micro bus æ¶æ„)</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/uhttpd -f -h /www -r LEDE -x /cgi-bin -u /ubus -t 60 -T 30 -k 20 -A 1 -n 3 -N 100 -R -p 0.0.0.0:80 -p [::]:80</span><br></pre></td></tr></table></figure><h2 id="1ã€Lucié…ç½®ç•Œé¢å¼€å‘æ¡†æ¶-Controller"><a href="#1ã€Lucié…ç½®ç•Œé¢å¼€å‘æ¡†æ¶-Controller" class="headerlink" title="1ã€Lucié…ç½®ç•Œé¢å¼€å‘æ¡†æ¶(Controller)"></a>1ã€Lucié…ç½®ç•Œé¢å¼€å‘æ¡†æ¶(Controller)</h2><p>Controllerå®šä¹‰æ¨¡å—çš„å…¥å£</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module(<span class="string">"luci.controller.æ§åˆ¶å™¨å"</span>,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line">        entry(è·¯å¾„,è°ƒç”¨ç›®æ ‡,_(<span class="string">"æ˜¾ç¤ºåç§°"</span>),æ˜¾ç¤ºé¡ºåº)</span><br><span class="line">        <span class="keyword">end</span></span><br></pre></td></tr></table></figure><blockquote><p>ç¬¬ä¸€è¡Œè¯´æ˜äº†ç¨‹åºå’Œæ¨¡å—çš„åç§°ï¼Œeg:controller/ç›®å½•ä¸‹åˆ›å»ºparentctrl.lua,é‚£ä¹ˆä¹…åº”è¯¥å†™æˆâ€luci.controller.parentctrlâ€ã€‚å¦‚æœç¨‹åºè¾ƒå¤šï¼Œå¯ä»¥åˆ†ä¸ºå¥½å‡ ä¸ªæ¨¡å—ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨controllerä¸‹å†åˆ›å»ºä¸€ä¸ªå­ç›®å½•ï¼Œeg:controller/app/,é‚£ä¹ˆå°±å¯ä»¥ä¸‹åŸâ€luci.controller.app.parentctrlâ€ã€‚  </p></blockquote><blockquote><p>entryè¡¨ç¤ºä¸€ä¸ªæ¨¡å—çš„å…¥å£ï¼Œå®˜æ–¹ç»™å‡ºentryçš„å®šä¹‰å¦‚ä¸‹ï¼š<br><code>entry(path, target, title=nil, order=nil)</code><br>pathä¸ºè®¿é—®è·¯å¾„ï¼Œè·¯å¾„æŒ‰å­—ç¬¦ä¸²æ•°ç»„ç»™å®šçš„ï¼Œeg:{â€œadminâ€,â€more_setâ€,â€parentctrlâ€},é‚£ä¹ˆåœ¨æµè§ˆå™¨é‡Œè®¿é—®â€œ<a href="http://192.168.2.1/cgi-bin/luci/admin/more_set/parentctrlâ€" target="_blank" rel="noopener">http://192.168.2.1/cgi-bin/luci/admin/more_set/parentctrlâ€</a> æ¥è®¿é—®è¯¥è„šæœ¬ã€‚  </p><ul><li>ç¬¬ä¸€ç§ç›´æ¥è°ƒç”¨æŒ‡å®šå‡½æ•°ï¼Œæ¯”å¦‚ç›´æ¥é‡å¯è·¯ç”±å™¨ï¼Œeg:å†™æˆâ€œ<code>call(&quot;function_name&quot;)</code>â€ï¼Œç„¶ååˆåœ¨Luaæ–‡ä»¶ä¸­ç¼–å†™åä¸ºfunction_nameçš„å‡½æ•°å°±å¯ä»¥è°ƒç”¨äº†ã€‚</li><li>ç¬¬äºŒç§å¯ä»¥è®¿é—®æŒ‡å®šé¡µé¢ï¼Œeg:â€œ<code>template(&quot;pc/parentctrl&quot;)</code>â€å°±å¯ä»¥è°ƒç”¨/usr/lib/lua/luci/view/pc/parentctrl.htmlã€‚</li><li>é…ç½®ç•Œé¢ï¼Œç¬¬ä¸‰ç§æ–¹æ³•æ— éæœ€æ–¹ä¾¿çš„ï¼Œeg:â€œ<code>cbi(&quot;app/parentctrl&quot;)</code>â€å°±å¯ä»¥è°ƒç”¨/usr/lib/lua/luci/model/cbi/app/parentctrl.luaã€‚</li></ul></blockquote><p>eg:åˆ›å»º/usr/lib/lua/luci/controller/njitclient.lua</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module(<span class="string">"luci.controller.njitclient"</span>,<span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line">    entry(&#123;<span class="string">"admin"</span>, <span class="string">"network"</span>, <span class="string">"njitclient"</span>&#125;, cbi(<span class="string">"njitclient"</span>) , _(<span class="string">"NJITClient"</span>), <span class="number">100</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br></pre></td></tr></table></figure><h2 id="2ã€ç”¨Luaå’ŒUCIæ¥å£å¼€å‘LuCIé…ç½®æ¨¡å—-Model"><a href="#2ã€ç”¨Luaå’ŒUCIæ¥å£å¼€å‘LuCIé…ç½®æ¨¡å—-Model" class="headerlink" title="2ã€ç”¨Luaå’ŒUCIæ¥å£å¼€å‘LuCIé…ç½®æ¨¡å—(Model)"></a>2ã€ç”¨Luaå’ŒUCIæ¥å£å¼€å‘LuCIé…ç½®æ¨¡å—(Model)</h2><p>åŠŸèƒ½æè¿°ï¼šå¸Œæœ›å°†ç”¨æˆ·åã€å¯†ç ç­‰ä¿¡æ¯å­˜å‚¨åœ¨è·¯ç”±å™¨æ–‡ä»¶ä¸­ï¼ŒåŒæ—¶è·¯ç”±å™¨å¼€æœºæ—¶èƒ½æ ¹æ®è®¾å®šçš„é…ç½®è‡ªåŠ¨è¿è¡Œnjitclient,åŒæ—¶å¸Œæœ›åŠ¨æ€çš„ç¦æ­¢å’Œå¯ç”¨njitclientç­‰ç­‰ã€‚æ‰€æœ‰æœ€å¥½çš„æ–¹å¼ä½¿ç”¨<code>CBI Module</code>,åˆ›å»ºmodelæ–‡ä»¶ï¼Œ/usr/lib/lua/luci/model/cbi/njitclient.lua</p><p>å¼€å‘LuCIçš„é…ç½®æ¨¡å—çš„æœ‰å¾ˆå¤šæ–¹å¼ï¼Œæ¯”è¾ƒåŸºæœ¬çš„å¯ä»¥ç”¨SimpleFormï¼Œå°±è·Ÿå¼€å‘æ™®é€šçš„Webåº”ç”¨ç±»ä¼¼ï¼Œå½“ç„¶æœ€æ–¹ä¾¿çš„è¿˜æ˜¯ä½¿ç”¨UCIï¼ˆUnified Configuration Interface,ç»Ÿä¸€é…ç½®æ¥å£ï¼‰çš„æ–¹å¼ï¼Œå› ä¸ºä½¿ç”¨UCIæ¥å£å¯ä»¥ä½¿å¾—åœ¨LuCIä¸­æ— éœ€è€ƒè™‘é…ç½®æ–‡ä»¶å¦‚ä½•å­˜å‚¨å’Œè¯»å–(è¿™ç§æ–¹å¼ä¹Ÿä¼šè‡ªåŠ¨åˆ›å»ºâ€œä¿å­˜&amp;åº”ç”¨â€ã€â€œä¿å­˜â€ä»¥åŠâ€œå¤ä½â€ä¸‰ä¸ªæŒ‰é’®)ã€‚åŒæ—¶åœ¨Bashæ–‡ä»¶ä¸­ä¹Ÿå¯ä»¥éå¸¸æ–¹ä¾¿çš„å­˜å‚¨å’Œè¯»å–ã€‚</p><h2 id="å¯¹äºUCIæ–¹å¼"><a href="#å¯¹äºUCIæ–¹å¼" class="headerlink" title="å¯¹äºUCIæ–¹å¼"></a>å¯¹äºUCIæ–¹å¼</h2><p>(1)ã€åˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œå­˜å‚¨äº/etc/configã€‚eg:<code>/etc/config/njitclient</code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config login</span><br><span class="line">    option username <span class="string">''</span></span><br><span class="line">    option password <span class="string">''</span></span><br><span class="line">    option ifname <span class="string">'eth0'</span></span><br><span class="line">    option domain <span class="string">''</span></span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶çš„ç¼–å†™å‚è§<a href="https://wiki.openwrt.org/zh-cn/doc/uci" target="_blank" rel="noopener">UCIç³»ç»Ÿæ–‡æ¡£</a></p><p>(2)ã€ç„¶ååœ¨CBI Moduleçš„luaæ–‡ä»¶ä¸­é¦–å…ˆéœ€è¦æ˜ å°„ä¸å­˜å‚¨æ–‡ä»¶çš„å…³ç³»<br>eg:</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">m = Map(njitclient,<span class="string">"NJIT Client"</span>, Configure NJIT <span class="number">802.11</span>x client.<span class="string">")</span></span><br></pre></td></tr></table></figure><p>m = Map(â€œé…ç½®æ–‡ä»¶åâ€,â€é…ç½®é¡µé¢æ ‡é¢˜â€,â€é…ç½®é¡µé¢è¯´æ˜â€)</p><blockquote><p>ç¬¬ä¸€ä¸ªå‚æ•°å³ä¸ºé…ç½®æ–‡ä»¶å­˜å‚¨çš„æ–‡ä»¶åï¼Œä¸åŒ…å«è·¯å¾„ã€‚<br>ç¬¬äºŒä¸ªå‚æ•°å’Œç¬¬ä¸‰ä¸ªå‚æ•°ç”¨äºé¡µé¢æ˜¾ç¤ºã€‚</p></blockquote><div align="center"><img src="/img/web_01/01.png"></div><p>(3)ã€åˆ›å»ºä¸é…ç½®æ–‡ä»¶ä¸­å¯¹åº”çš„<code>Section</code>ï¼ŒSectionåˆ†ä¸¤ç§ï¼Œ<code>NamedSection</code>å’Œ<code>TypedSection</code>å‰è€…æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„Sectionåï¼Œåè€…æ ¹æ®é…ç½®æ–‡ä»¶ä¸­çš„Sectionç±»å‹ã€‚è¿™é‡Œä½¿ç”¨åè€…ã€‚ä»£ç å¦‚ä¸‹ï¼ŒåŒæ—¶è®¾ç½®ä¸å…è®¸å¢åŠ æˆ–åˆ é™¤Section(â€œ.addremove=falseâ€),ä»¥åŠä¸æ˜¾ç¤ºSectionåç§°(â€œ.anonymous=trueâ€)ã€‚</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">s = m:section(TypedSection, <span class="string">"login"</span>, <span class="string">""</span>)</span><br><span class="line">s.addremove = <span class="literal">false</span></span><br><span class="line">s.anonymous = <span class="literal">true</span></span><br></pre></td></tr></table></figure><p>(4)ã€æ¥ä¸‹æ¥åˆ›å»ºSectionä¸­ä¸åŒå†…å®¹çš„äº¤äº’ï¼ˆåˆ›å»ºOptionï¼‰ï¼Œå¸¸è§çš„æ¯”å¦‚æœ‰Value(æ–‡æœ¬æ¡†)ã€ListValue(ä¸‹æ‹‰æ¡†)ã€Flag(é€‰æ‹©æ¡†)ç­‰ç­‰ã€‚è¯¦è§å®˜æ–¹å‚è€ƒæ–‡æ¡£<a href="http://luci.subsignal.org/trac/wiki/Documentation/CBI" target="_blank" rel="noopener">CBI</a></p><p>åˆ›å»ºOptionçš„è¿‡ç¨‹éå¸¸ç®€å•ï¼Œåˆ›å»ºåæ— éœ€è€ƒè™‘è¯»å†™é…ç½®é—®é¢˜ï¼Œç³»ç»Ÿéƒ½ä¼šè‡ªåŠ¨å¤„ç†ï¼Œä½†æ˜¯æ ¹æ®ä¸Šè¿°çš„è¦æ±‚ï¼Œæˆ‘ä»¬åœ¨åº”ç”¨é…ç½®åå¸Œæœ›å¯ç”¨ã€æ™‹ä¸­æˆ–é‡å¯njitclientï¼Œæ‰€æœ‰æˆ‘ä»¬éœ€è¦åœ¨é¡µé¢æœ€ååˆ¤æ–­ç”¨æˆ·æ˜¯å¦ç‚¹å‡»â€œåº”ç”¨â€æŒ‰é’®ï¼Œä»¥åŠç‚¹å‡»åçš„åŠ¨ä½œã€‚  </p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> apply = luci.http.formvlaue(<span class="string">"cbi.apply"</span>)</span><br><span class="line"><span class="keyword">if</span> apply <span class="keyword">then</span></span><br><span class="line">    <span class="comment">--[[</span></span><br><span class="line"><span class="comment">        éœ€è¦å¤„ç†çš„ä»£ç </span></span><br><span class="line"><span class="comment">    ]]</span><span class="comment">--</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>modelæ–‡ä»¶å®Œæ•´ä»£ç njitclient.lua</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"luci.sys"</span>)</span><br><span class="line"></span><br><span class="line">m = Map(<span class="string">"njitclient"</span>, translate(<span class="string">"NJIT Client"</span>), translate(<span class="string">"Configure NJIT 802.11x Client"</span>))</span><br><span class="line"></span><br><span class="line">s = m:section(TypedSection, <span class="string">"login"</span>, <span class="string">""</span>)</span><br><span class="line">s.addremove = <span class="literal">false</span></span><br><span class="line">s.anonymous = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">enable = s:option(Flag,<span class="string">"enable"</span>, translate(<span class="string">"Enable"</span>))</span><br><span class="line">name = s:option(Value, <span class="string">"username"</span>, translate(<span class="string">"Username"</span>))</span><br><span class="line">pass = s:option(Value, <span class="string">"password"</span>, translate(<span class="string">"Password"</span>))</span><br><span class="line">pass.password = <span class="literal">true</span></span><br><span class="line">domain = s:option(Value, <span class="string">"domain"</span>, translate(<span class="string">"Domain"</span>))</span><br><span class="line"></span><br><span class="line">ifname = s:option(ListValue, <span class="string">"ifname"</span>, translate(<span class="string">"Interface"</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(luci.sys.net.devices()) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> v ~= <span class="string">"lo"</span> <span class="keyword">then</span></span><br><span class="line">        ifname:value(v)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> apply = luci.http.formvalue(<span class="string">"cbi.apply"</span>)</span><br><span class="line"><span class="keyword">if</span> apply the</span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">popen</span>(<span class="string">"/etc/init.d/njitclient restart"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> m</span><br></pre></td></tr></table></figure><p>å…¶ä¸­Luciå…¨éƒ¨åº“ç±»çš„å‡½æ•°å®šä¹‰å’Œä½¿ç”¨è¯´æ˜ï¼Œå¯ä»¥å‚è€ƒ<a href="http://luci.subsignal.org/api/luci/index.html" target="_blank" rel="noopener">Luci API</a></p><h2 id="3ã€Bashæ–‡ä»¶ä¸­è°ƒç”¨UCIæ¥å£"><a href="#3ã€Bashæ–‡ä»¶ä¸­è°ƒç”¨UCIæ¥å£" class="headerlink" title="3ã€Bashæ–‡ä»¶ä¸­è°ƒç”¨UCIæ¥å£"></a>3ã€Bashæ–‡ä»¶ä¸­è°ƒç”¨UCIæ¥å£</h2><p>æ¥ä¸‹æ¥ç¼–å†™njitclientè„šæœ¬ï¼Œä½¿å¾—ç¨‹åºæœ€ç»ˆè¿è¡Œèµ·æ¥ã€‚å…³äºUCIæ¥å£çš„è„šæœ¬æ–‡æ¡£ä¸­å®˜æ–¹å‚è€ƒèµ„æ–™<a href="https://wiki.openwrt.org/doc/devel/config-scripting" target="_blank" rel="noopener">Configuration in scripts</a></p><p>(1)ã€ä½¿ç”¨UCIè°ƒç”¨è„šæœ¬ï¼Œç¬¬ä¸€æ­¥éœ€è¦è¯»å–é…ç½®æ–‡ä»¶ï¼Œå‘½ä»¤ä¸ºâ€œ<code>config_load é…ç½®æ–‡ä»¶å</code>â€ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config_load njitclient</span><br></pre></td></tr></table></figure><p>(2)ã€æ¥ä¸‹æ¥éå†é…ç½®ä¸­çš„Sectionï¼Œå¯ä»¥ä½¿ç”¨â€œ<code>config_foreach éå†å‡½æ•°åä¸ºSectionç±»å‹</code>â€ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config_foreach run_njit login</span><br></pre></td></tr></table></figure><p>(3)ã€ç¼–å†™åä¸º<code>run_njit</code>å‡½æ•°ï¼Œåœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œå¯ä»¥ä½¿ç”¨â€œ<code>config_get å˜é‡å Sectionå Sectionå‚æ•°å</code>â€è·å–å˜é‡çš„å€¼ï¼Œæˆ–è€…ä½¿ç”¨â€œ<code>config_get_boolå˜é‡å Sectionå Sectionå‚æ•°å</code>â€è·å–å¸ƒå°”çš„å€¼ã€‚</p><p>njitclientå®Œæ•´è„šæœ¬å¦‚ä¸‹</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh /etc/rc.common</span><br><span class="line">START=<span class="number">50</span></span><br><span class="line">run_njit()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">local</span> enable</span><br><span class="line">    config_get bool enable $<span class="number">1</span> enable</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [$enable]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> username</span><br><span class="line">        <span class="keyword">local</span> password</span><br><span class="line">        <span class="keyword">local</span> domain</span><br><span class="line">        <span class="keyword">local</span> ifname</span><br><span class="line"></span><br><span class="line">        config_get username $<span class="number">1</span> username</span><br><span class="line">        config_get password $<span class="number">1</span> password</span><br><span class="line">        config_get domain $<span class="number">1</span> domain</span><br><span class="line">        config_get ifname $<span class="number">1</span> ifname</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ <span class="string">"$domain"</span> !=<span class="string">""</span> ]; <span class="keyword">then</span></span><br><span class="line">            njit-client $username@$domain $password $ifname &amp;</span><br><span class="line">        <span class="keyword">else</span> </span><br><span class="line">            njit-client $username $password $ifname &amp;</span><br><span class="line">        fi</span><br><span class="line"></span><br><span class="line">        echo <span class="string">"NJIT Client hase started."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">start()</span><br><span class="line">&#123;</span><br><span class="line">    config_load njitclient</span><br><span class="line">    config_foreach run_njit login</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">stop()</span><br><span class="line">&#123;</span><br><span class="line">    killall njit-client</span><br><span class="line">    killall udhcpc</span><br><span class="line"></span><br><span class="line">    echo <span class="string">"NJIT Client has stoped."</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>openwrt uhttpdäº¤äº’æµç¨‹<br>docroot ä¸º/www   </p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@LEDE:/www<span class="meta"># ls -l</span></span><br><span class="line">drwxrwxr-x    <span class="number">2</span> root     root            <span class="number">27</span> Aug <span class="number">12</span> <span class="number">00</span>:<span class="number">12</span> cgi-bin</span><br><span class="line">-rw-rw-r--    <span class="number">1</span> root     root           <span class="number">495</span> Aug <span class="number">12</span> <span class="number">00</span>:<span class="number">12</span> index.html</span><br><span class="line">drwxrwxr-x    <span class="number">4</span> root     root            <span class="number">49</span> Aug <span class="number">12</span> <span class="number">00</span>:<span class="number">12</span> luci-<span class="keyword">static</span></span><br></pre></td></tr></table></figure><p>(1)ã€é»˜è®¤index.html,è¯¥æ–‡ä»¶å†…å®¹å¦‚ä¸‹</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="meta">&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">xmlns</span>=<span class="string">"http://www.w3.org/1999/xhtml"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Cache-Control"</span> <span class="attr">content</span>=<span class="string">"no-cache"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"refresh"</span> <span class="attr">content</span>=<span class="string">"0; URL=/cgi-bin/luci"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span> <span class="attr">style</span>=<span class="string">"background-color: white"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">style</span>=<span class="string">"color: black; font-family: arial, helvetica, sans-serif;"</span> <span class="attr">href</span>=<span class="string">"/cgi-bin/luci"</span>&gt;</span>LuCI - Lua Configuration Interface<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é»˜è®¤è·³è½¬/cgi-bin/luciï¼Œæ³¨ï¼šluciè¯¥æ–‡ä»¶ç›¸å¯¹äºdocrootè€Œè¨€çš„è·¯å¾„ï¼Œå³ç›¸å¯¹äº/wwwã€‚<br>(2)ã€åˆ™å®é™…è·¯å¾„ä¸º/www/cgi-bin/luciã€‚è¯¥æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/lua  <span class="comment">--æ‰§è¡Œå‘½ä»¤çš„è·¯å¾„</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">"luci.cacheloader"</span>   <span class="comment">--å¯¼å…¥cacheloaderåŒ…</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">"luci.sgi.cgi"</span>       <span class="comment">--å¯¼å…¥sgi.sgiåŒ…</span></span><br><span class="line">luci.dispatcher.indexcache = <span class="string">"/tmp/luci-indexcache"</span> <span class="comment">--cacheç¼“å­˜è·¯å¾„åœ°å€</span></span><br><span class="line">luci.sgi.cgi.run()  <span class="comment">--æ‰§è¡Œrunæ–¹æ³•ï¼Œæ­¤æ–¹æ³•äº/usr/lib/lua/luci/sgi/cgi.lua</span></span><br></pre></td></tr></table></figure><p>(3)ã€cgi.luaæ–‡ä»¶å†…å®¹ /usr/lib/lua/luci/sgi/cgi.lua<br><a href="#cgi">cgi.luaæ–‡ä»¶å®Œæ•´å†…å®¹</a></p><p>ä»£ç è§£é‡Šï¼š  </p><blockquote><p>é¦–å…ˆæ‰§è¡Œçš„æ˜¯run()å‡½æ•°:</p></blockquote><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> r = luci.http.Request(...)   <span class="comment">--æŠŠWebè¯·æ±‚æ”¾äºrä¸­ï¼Œï¼ˆåŒ…æ‹¬ç¯å¢ƒå˜é‡ï¼Œwebè¯·æ±‚ï¼Œå‡ºé”™å¤„ç†æ¥å£ï¼‰</span></span><br></pre></td></tr></table></figure><blockquote><p>createå‡ºå¦ä¸€ä¸ªæ‰§è¡Œä½“<code>httpdispatch</code>,æ¯æ¬¡httpdispatchæ‰§è¡Œyieldè¿”å›ä¸€äº›æ•°æ®æ—¶ï¼Œrun()å‡½æ•°è¯»å–è¿™äº›æ•°æ®ï¼Œåšç›¸åº”å¤„ç†ï¼Œç„¶åå†æ¬¡æ‰§è¡Œresume(httpdispatch),â€¦å¦‚æ­¤ç›´åˆ°httpdispatchæ‰§è¡Œå®Œæ¯•ã€‚</p></blockquote><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> x = coroutine.<span class="built_in">create</span>(luci.dispatcher.httpdispatch)  <span class="comment">--åˆ›å»ºä¸€ä¸ªååŒç¨‹åº</span></span><br><span class="line"><span class="keyword">local</span> res, id, data1, data2 = coroutine.<span class="built_in">resume</span>(x, r) <span class="comment">--è¿è¡Œåˆ›å»ºçš„ååŒè¿›ç¨‹ï¼Œå³è¿è¡Œhttpdispatchï¼Œå‚æ•°ä¸ºä¸Šé¢çš„local rå˜é‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> id == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">"Status: "</span> .. <span class="built_in">tostring</span>(data1) .. <span class="string">" "</span> .. data2 .. <span class="string">"\r\n"</span>)</span><br><span class="line"><span class="keyword">elseif</span> id == <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">    hcache = hcache .. data1 .. <span class="string">": "</span> .. data2 .. <span class="string">"\r\n"</span>  <span class="comment">--å‡†å¤‡header</span></span><br><span class="line"><span class="keyword">elseif</span> id == <span class="number">3</span> <span class="keyword">then</span>    <span class="comment">--å†™header ã€blank</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(hcache)   <span class="comment">--é»˜è®¤åˆ°stdout</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">"\r\n"</span>)</span><br><span class="line"><span class="keyword">elseif</span> id == <span class="number">4</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="built_in">tostring</span>(data1 <span class="keyword">or</span> <span class="string">""</span>))  <span class="comment">--å†™å…¥body</span></span><br><span class="line"><span class="keyword">elseif</span> id == <span class="number">5</span> <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">flush</span>()</span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">close</span>()</span><br><span class="line">    active = <span class="literal">false</span></span><br><span class="line"><span class="keyword">elseif</span> id == <span class="number">6</span> <span class="keyword">then</span></span><br><span class="line">    data1:copyz(nixio.<span class="built_in">stdout</span>, data2)</span><br><span class="line">    data1:<span class="built_in">close</span>()</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>(4)ã€httpdispatchå‡½æ•° /usr/lib/lua/luci/dispatcher.lua<br><a href="#dispatcher">dispatcher.luaæ–‡ä»¶å®Œæ•´ä»£ç </a>.</p><p>ä»£ç è¯´æ˜ï¼šæ•´ä¸ªä»£ç ä¸»è¦å…³æ³¨ä¸€ä¸‹å‡½æ•°</p><blockquote><p>1ã€httpdispatchå‡½æ•°   </p></blockquote><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">httpdispatch</span><span class="params">(request, prefix)</span></span></span><br><span class="line">    http.context.request = request</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> r = &#123;&#125;</span><br><span class="line">    context.request = r</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> pathinfo = http.urldecode(request:<span class="built_in">getenv</span>(<span class="string">"PATH_INFO"</span>) <span class="keyword">or</span> <span class="string">""</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> prefix <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> _, node <span class="keyword">in</span> <span class="built_in">ipairs</span>(prefix) <span class="keyword">do</span></span><br><span class="line">            r[#r+<span class="number">1</span>] = node</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> pathinfo:<span class="built_in">gmatch</span>(<span class="string">"[^/]+"</span>) <span class="keyword">do</span></span><br><span class="line">        r[#r+<span class="number">1</span>] = node</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> stat, err = util.coxpcall(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        dispatch(context.request)</span><br><span class="line">    <span class="keyword">end</span>, error500)</span><br><span class="line"></span><br><span class="line">    http.<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">--context._disable_memtrace()</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><blockquote><p>2ã€dispatchå‡½æ•°ï¼Œ</p></blockquote><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(request)</span></span></span><br><span class="line">    <span class="comment">--context._disable_memtrace = require "luci.debug".trap_memtrace("l")</span></span><br><span class="line">    <span class="keyword">local</span> ctx = context</span><br><span class="line">    ctx.<span class="built_in">path</span> = request</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> conf = <span class="built_in">require</span> <span class="string">"luci.config"</span></span><br><span class="line">    <span class="built_in">assert</span>(conf.main,</span><br><span class="line">        <span class="string">"/etc/config/luci seems to be corrupt, unable to find section 'main'"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> i18n = <span class="built_in">require</span> <span class="string">"luci.i18n"</span></span><br><span class="line">    <span class="keyword">local</span> lang = conf.main.lang <span class="keyword">or</span> <span class="string">"auto"</span></span><br><span class="line">    <span class="keyword">if</span> lang == <span class="string">"auto"</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> aclang = http.<span class="built_in">getenv</span>(<span class="string">"HTTP_ACCEPT_LANGUAGE"</span>) <span class="keyword">or</span> <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> lpat <span class="keyword">in</span> aclang:<span class="built_in">gmatch</span>(<span class="string">"[%w-]+"</span>) <span class="keyword">do</span></span><br><span class="line">            lpat = lpat <span class="keyword">and</span> lpat:<span class="built_in">gsub</span>(<span class="string">"-"</span>, <span class="string">"_"</span>)</span><br><span class="line">            <span class="keyword">if</span> conf.languages[lpat] <span class="keyword">then</span></span><br><span class="line">                lang = lpat</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> lang == <span class="string">"auto"</span> <span class="keyword">then</span></span><br><span class="line">        lang = i18n.default</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    i18n.setlanguage(lang)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> c = ctx.tree</span><br><span class="line">    <span class="keyword">local</span> stat</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> c <span class="keyword">then</span></span><br><span class="line">        c = createtree()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> track = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> args = &#123;&#125;</span><br><span class="line">    ctx.args = args</span><br><span class="line">    ctx.requestargs = ctx.requestargs <span class="keyword">or</span> args</span><br><span class="line">    <span class="keyword">local</span> n</span><br><span class="line">    <span class="keyword">local</span> preq = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> freq = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, s <span class="keyword">in</span> <span class="built_in">ipairs</span>(request) <span class="keyword">do</span></span><br><span class="line">        preq[#preq+<span class="number">1</span>] = s</span><br><span class="line">        freq[#freq+<span class="number">1</span>] = s</span><br><span class="line">        c = c.nodes[s]</span><br><span class="line">        n = i</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> c <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        util.update(track, c)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> c.leaf <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> c.leaf <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> j=n+<span class="number">1</span>, #request <span class="keyword">do</span></span><br><span class="line">            args[#args+<span class="number">1</span>] = request[j]</span><br><span class="line">            freq[#freq+<span class="number">1</span>] = request[j]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    ctx.requestpath = ctx.requestpath <span class="keyword">or</span> freq</span><br><span class="line">    ctx.<span class="built_in">path</span> = preq</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.i18n <span class="keyword">then</span></span><br><span class="line">        i18n.loadc(track.i18n)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Init template engine</span></span><br><span class="line">    <span class="keyword">if</span> (c <span class="keyword">and</span> c.index) <span class="keyword">or</span> <span class="keyword">not</span> track.notemplate <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> tpl = <span class="built_in">require</span>(<span class="string">"luci.template"</span>)</span><br><span class="line">        <span class="keyword">local</span> media = track.mediaurlbase <span class="keyword">or</span> luci.<span class="built_in">config</span>.main.mediaurlbase</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">pcall</span>(tpl.Template, <span class="string">"themes/%s/header"</span> % fs.basename(media)) <span class="keyword">then</span></span><br><span class="line">            media = <span class="literal">nil</span></span><br><span class="line">            <span class="keyword">for</span> name, theme <span class="keyword">in</span> <span class="built_in">pairs</span>(luci.<span class="built_in">config</span>.themes) <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">if</span> name:<span class="built_in">sub</span>(<span class="number">1</span>,<span class="number">1</span>) ~= <span class="string">"."</span> <span class="keyword">and</span> <span class="built_in">pcall</span>(tpl.Template,</span><br><span class="line">                 <span class="string">"themes/%s/header"</span> % fs.basename(theme)) <span class="keyword">then</span></span><br><span class="line">                    media = theme</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="built_in">assert</span>(media, <span class="string">"No valid theme found"</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _ifattr<span class="params">(cond, key, val)</span></span></span><br><span class="line">            <span class="keyword">if</span> cond <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">local</span> env = <span class="built_in">getfenv</span>(<span class="number">3</span>)</span><br><span class="line">                <span class="keyword">local</span> scope = (<span class="built_in">type</span>(env.self) == <span class="string">"table"</span>) <span class="keyword">and</span> env.self</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">type</span>(val) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">next</span>(val) <span class="keyword">then</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        val = util.serialize_json(val)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">format</span>(</span><br><span class="line">                    <span class="string">' %s="%s"'</span>, <span class="built_in">tostring</span>(key),</span><br><span class="line">                    util.pcdata(<span class="built_in">tostring</span>( val</span><br><span class="line">                     <span class="keyword">or</span> (<span class="built_in">type</span>(env[key]) ~= <span class="string">"function"</span> <span class="keyword">and</span> env[key])</span><br><span class="line">                     <span class="keyword">or</span> (scope <span class="keyword">and</span> <span class="built_in">type</span>(scope[key]) ~= <span class="string">"function"</span> <span class="keyword">and</span> scope[key])</span><br><span class="line">                     <span class="keyword">or</span> <span class="string">""</span> ))</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        tpl.context.viewns = <span class="built_in">setmetatable</span>(&#123;</span><br><span class="line">           <span class="built_in">write</span>       = http.<span class="built_in">write</span>;</span><br><span class="line">           include     = <span class="function"><span class="keyword">function</span><span class="params">(name)</span></span> tpl.Template(name):render(<span class="built_in">getfenv</span>(<span class="number">2</span>)) <span class="keyword">end</span>;</span><br><span class="line">           translate   = i18n.translate;</span><br><span class="line">           translatef  = i18n.translatef;</span><br><span class="line">           export      = <span class="function"><span class="keyword">function</span><span class="params">(k, v)</span></span> <span class="keyword">if</span> tpl.context.viewns[k] == <span class="literal">nil</span> <span class="keyword">then</span> tpl.context.viewns[k] = v <span class="keyword">end</span> <span class="keyword">end</span>;</span><br><span class="line">           striptags   = util.striptags;</span><br><span class="line">           pcdata      = util.pcdata;</span><br><span class="line">           media       = media;</span><br><span class="line">           theme       = fs.basename(media);</span><br><span class="line">           resource    = luci.<span class="built_in">config</span>.main.resourcebase;</span><br><span class="line">           ifattr      = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span> <span class="keyword">return</span> _ifattr(...) <span class="keyword">end</span>;</span><br><span class="line">           attr        = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span> <span class="keyword">return</span> _ifattr(<span class="literal">true</span>, ...) <span class="keyword">end</span>;</span><br><span class="line">           url         = build_url;</span><br><span class="line">        &#125;, &#123;<span class="built_in">__index</span>=<span class="function"><span class="keyword">function</span><span class="params">(table, key)</span></span></span><br><span class="line">            <span class="keyword">if</span> key == <span class="string">"controller"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> build_url()</span><br><span class="line">            <span class="keyword">elseif</span> key == <span class="string">"REQUEST_URI"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> build_url(<span class="built_in">unpack</span>(ctx.requestpath))</span><br><span class="line">            <span class="keyword">elseif</span> key == <span class="string">"token"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> ctx.authtoken</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">rawget</span>(<span class="built_in">table</span>, key) <span class="keyword">or</span> <span class="built_in">_G</span>[key]</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span>&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    track.dependent = (track.dependent ~= <span class="literal">false</span>)</span><br><span class="line">    <span class="built_in">assert</span>(<span class="keyword">not</span> track.dependent <span class="keyword">or</span> <span class="keyword">not</span> track.auto,</span><br><span class="line">        <span class="string">"Access Violation\nThe page at '"</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(request, <span class="string">"/"</span>) .. <span class="string">"/' "</span> ..</span><br><span class="line">        <span class="string">"has no parent node so the access to this location has been denied.\n"</span> ..</span><br><span class="line">        <span class="string">"This is a software bug, please report this message at "</span> ..</span><br><span class="line">        <span class="string">"https://github.com/openwrt/luci/issues"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.sysauth <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> authen = track.sysauth_authenticator</span><br><span class="line">        <span class="keyword">local</span> _, sid, sdat, default_user, allowed_users</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(authen) == <span class="string">"string"</span> <span class="keyword">and</span> authen ~= <span class="string">"htmlauth"</span> <span class="keyword">then</span></span><br><span class="line">            error500(<span class="string">"Unsupported authenticator %q configured"</span> % authen)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(track.sysauth) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            default_user, allowed_users = <span class="literal">nil</span>, track.sysauth</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            default_user, allowed_users = track.sysauth, &#123; track.sysauth &#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(authen) == <span class="string">"function"</span> <span class="keyword">then</span></span><br><span class="line">            _, sid = authen(sys.user.checkpasswd, allowed_users)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            sid = http.getcookie(<span class="string">"sysauth"</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        sid, sdat = session_retrieve(sid, allowed_users)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (sid <span class="keyword">and</span> sdat) <span class="keyword">and</span> authen == <span class="string">"htmlauth"</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> user = http.<span class="built_in">getenv</span>(<span class="string">"HTTP_AUTH_USER"</span>)</span><br><span class="line">            <span class="keyword">local</span> pass = http.<span class="built_in">getenv</span>(<span class="string">"HTTP_AUTH_PASS"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> user == <span class="literal">nil</span> <span class="keyword">and</span> pass == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">                user = http.formvalue(<span class="string">"luci_username"</span>)</span><br><span class="line">                pass = http.formvalue(<span class="string">"luci_password"</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            sid, sdat = session_setup(user, pass, allowed_users)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> sid <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">local</span> tmpl = <span class="built_in">require</span> <span class="string">"luci.template"</span></span><br><span class="line"></span><br><span class="line">                context.<span class="built_in">path</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line">                http.<span class="built_in">status</span>(<span class="number">403</span>, <span class="string">"Forbidden"</span>)</span><br><span class="line">                tmpl.render(track.sysauth_template <span class="keyword">or</span> <span class="string">"sysauth"</span>, &#123;</span><br><span class="line">                    duser = default_user,</span><br><span class="line">                    fuser = user</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            http.header(<span class="string">"Set-Cookie"</span>, <span class="string">'sysauth=%s; path=%s'</span> %&#123; sid, build_url() &#125;)</span><br><span class="line">            http.redirect(build_url(<span class="built_in">unpack</span>(ctx.requestpath)))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> sid <span class="keyword">or</span> <span class="keyword">not</span> sdat <span class="keyword">then</span></span><br><span class="line">            http.<span class="built_in">status</span>(<span class="number">403</span>, <span class="string">"Forbidden"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        ctx.authsession = sid</span><br><span class="line">        ctx.authtoken = sdat.token</span><br><span class="line">        ctx.authuser = sdat.username</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> require_post_security(c.target) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> test_post_security(c) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.setgroup <span class="keyword">then</span></span><br><span class="line">        sys.process.setgroup(track.setgroup)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.setuser <span class="keyword">then</span></span><br><span class="line">        sys.process.setuser(track.setuser)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> target = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(c.target) == <span class="string">"function"</span> <span class="keyword">then</span></span><br><span class="line">            target = c.target</span><br><span class="line">        <span class="keyword">elseif</span> <span class="built_in">type</span>(c.target) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            target = c.target.target</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> (c.index <span class="keyword">or</span> <span class="built_in">type</span>(target) == <span class="string">"function"</span>) <span class="keyword">then</span></span><br><span class="line">        ctx.dispatched = c</span><br><span class="line">        ctx.requested = ctx.requested <span class="keyword">or</span> ctx.dispatched</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> c.index <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> tpl = <span class="built_in">require</span> <span class="string">"luci.template"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> util.copcall(tpl.render, <span class="string">"indexer"</span>, &#123;&#125;) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(target) == <span class="string">"function"</span> <span class="keyword">then</span></span><br><span class="line">        util.copcall(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">            <span class="keyword">local</span> oldenv = <span class="built_in">getfenv</span>(target)</span><br><span class="line">            <span class="keyword">local</span> module = <span class="built_in">require</span>(c.module)</span><br><span class="line">            <span class="keyword">local</span> env = <span class="built_in">setmetatable</span>(&#123;&#125;, &#123;<span class="built_in">__index</span>=</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span><span class="params">(tbl, key)</span></span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">rawget</span>(tbl, key) <span class="keyword">or</span> module[key] <span class="keyword">or</span> oldenv[key]</span><br><span class="line">            <span class="keyword">end</span>&#125;)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">setfenv</span>(target, env)</span><br><span class="line">        <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> ok, err</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(c.target) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            ok, err = util.copcall(target, c.target, <span class="built_in">unpack</span>(args))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            ok, err = util.copcall(target, <span class="built_in">unpack</span>(args))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">assert</span>(ok,</span><br><span class="line">               <span class="string">"Failed to execute "</span> .. (<span class="built_in">type</span>(c.target) == <span class="string">"function"</span> <span class="keyword">and</span> <span class="string">"function"</span> <span class="keyword">or</span> c.target.<span class="built_in">type</span> <span class="keyword">or</span> <span class="string">"unknown"</span>) ..</span><br><span class="line">               <span class="string">" dispatcher target for entry '/"</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(request, <span class="string">"/"</span>) .. <span class="string">"'.\n"</span> ..</span><br><span class="line">               <span class="string">"The called action terminated with an exception:\n"</span> .. <span class="built_in">tostring</span>(err <span class="keyword">or</span> <span class="string">"(unknown)"</span>))</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">local</span> root = node()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root <span class="keyword">or</span> <span class="keyword">not</span> root.target <span class="keyword">then</span></span><br><span class="line">            error404(<span class="string">"No root node was registered, this usually happens if no module was installed.\n"</span> ..</span><br><span class="line">                     <span class="string">"Install luci-mod-admin-full and retry. "</span> ..</span><br><span class="line">                     <span class="string">"If the module is already installed, try removing the /tmp/luci-indexcache file."</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            error404(<span class="string">"No page is registered at '/"</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(request, <span class="string">"/"</span>) .. <span class="string">"'.\n"</span> ..</span><br><span class="line">                     <span class="string">"If this url belongs to an extension, make sure it is properly installed.\n"</span> ..</span><br><span class="line">                     <span class="string">"If the extension was recently installed, try removing the /tmp/luci-indexcache file."</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ä»£ç ï¼š</span><br><span class="line"></span><br><span class="line">&lt;div id=<span class="string">"cgi"</span>&gt;cgi.luaå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">```lua</span><br><span class="line"><span class="comment">-- Copyright 2008 Steven Barth &lt;steven@midlink.org&gt;</span></span><br><span class="line"><span class="comment">-- Licensed to the public under the Apache License 2.0.</span></span><br><span class="line"></span><br><span class="line">exectime = <span class="built_in">os</span>.<span class="built_in">clock</span>()</span><br><span class="line">module(<span class="string">"luci.sgi.cgi"</span>, <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line"><span class="keyword">local</span> ltn12 = <span class="built_in">require</span>(<span class="string">"luci.ltn12"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"nixio.util"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"luci.http"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"luci.sys"</span>)</span><br><span class="line"><span class="built_in">require</span>(<span class="string">"luci.dispatcher"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Limited source to avoid endless blocking</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">limitsource</span><span class="params">(handle, limit)</span></span></span><br><span class="line">    limit = limit <span class="keyword">or</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">local</span> BLOCKSIZE = ltn12.BLOCKSIZE</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        <span class="keyword">if</span> limit &lt; <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">            handle:<span class="built_in">close</span>()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">local</span> <span class="built_in">read</span> = (limit &gt; BLOCKSIZE) <span class="keyword">and</span> BLOCKSIZE <span class="keyword">or</span> limit</span><br><span class="line">            limit = limit - <span class="built_in">read</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">local</span> chunk = handle:<span class="built_in">read</span>(<span class="built_in">read</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> chunk <span class="keyword">then</span> handle:<span class="built_in">close</span>() <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> chunk</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> r = luci.http.Request(</span><br><span class="line">        luci.sys.<span class="built_in">getenv</span>(),</span><br><span class="line">        limitsource(<span class="built_in">io</span>.<span class="built_in">stdin</span>, <span class="built_in">tonumber</span>(luci.sys.<span class="built_in">getenv</span>(<span class="string">"CONTENT_LENGTH"</span>))),</span><br><span class="line">        ltn12.sink.file(<span class="built_in">io</span>.<span class="built_in">stderr</span>)</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">local</span> x = coroutine.<span class="built_in">create</span>(luci.dispatcher.httpdispatch)</span><br><span class="line">    <span class="keyword">local</span> hcache = <span class="string">""</span></span><br><span class="line">    <span class="keyword">local</span> active = <span class="literal">true</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span> coroutine.<span class="built_in">status</span>(x) ~= <span class="string">"dead"</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> res, id, data1, data2 = coroutine.<span class="built_in">resume</span>(x, r)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> res <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Status: 500 Internal Server Error"</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">"Content-Type: text/plain\n"</span>)</span><br><span class="line">            <span class="built_in">print</span>(id)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> active <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> id == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">"Status: "</span> .. <span class="built_in">tostring</span>(data1) .. <span class="string">" "</span> .. data2 .. <span class="string">"\r\n"</span>)</span><br><span class="line">            <span class="keyword">elseif</span> id == <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">                hcache = hcache .. data1 .. <span class="string">": "</span> .. data2 .. <span class="string">"\r\n"</span></span><br><span class="line">            <span class="keyword">elseif</span> id == <span class="number">3</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">write</span>(hcache)</span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">"\r\n"</span>)</span><br><span class="line">            <span class="keyword">elseif</span> id == <span class="number">4</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="built_in">tostring</span>(data1 <span class="keyword">or</span> <span class="string">""</span>))</span><br><span class="line">            <span class="keyword">elseif</span> id == <span class="number">5</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">flush</span>()</span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">close</span>()</span><br><span class="line">                active = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">elseif</span> id == <span class="number">6</span> <span class="keyword">then</span></span><br><span class="line">                data1:copyz(nixio.<span class="built_in">stdout</span>, data2)</span><br><span class="line">                data1:<span class="built_in">close</span>()</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><div id="dispatcher">dispatcher.luaå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</div><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- Copyright 2008 Steven Barth &lt;steven@midlink.org&gt;</span></span><br><span class="line"><span class="comment">-- Copyright 2008-2015 Jo-Philipp Wich &lt;jow@openwrt.org&gt;</span></span><br><span class="line"><span class="comment">-- Licensed to the public under the Apache License 2.0.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> fs = <span class="built_in">require</span> <span class="string">"nixio.fs"</span></span><br><span class="line"><span class="keyword">local</span> sys = <span class="built_in">require</span> <span class="string">"luci.sys"</span></span><br><span class="line"><span class="keyword">local</span> util = <span class="built_in">require</span> <span class="string">"luci.util"</span></span><br><span class="line"><span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">"luci.http"</span></span><br><span class="line"><span class="keyword">local</span> nixio = <span class="built_in">require</span> <span class="string">"nixio"</span>, <span class="built_in">require</span> <span class="string">"nixio.util"</span></span><br><span class="line"></span><br><span class="line">module(<span class="string">"luci.dispatcher"</span>, <span class="built_in">package</span>.<span class="built_in">seeall</span>)</span><br><span class="line">context = util.threadlocal()</span><br><span class="line">uci = <span class="built_in">require</span> <span class="string">"luci.model.uci"</span></span><br><span class="line">i18n = <span class="built_in">require</span> <span class="string">"luci.i18n"</span></span><br><span class="line">_M.fs = fs</span><br><span class="line"></span><br><span class="line"><span class="comment">-- Index table</span></span><br><span class="line"><span class="keyword">local</span> index = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Fastindex</span></span><br><span class="line"><span class="keyword">local</span> fi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">build_url</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">path</span> = &#123;...&#125;</span><br><span class="line">    <span class="keyword">local</span> url = &#123; http.<span class="built_in">getenv</span>(<span class="string">"SCRIPT_NAME"</span>) <span class="keyword">or</span> <span class="string">""</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> p</span><br><span class="line">    <span class="keyword">for</span> _, p <span class="keyword">in</span> <span class="built_in">ipairs</span>(<span class="built_in">path</span>) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> p:<span class="built_in">match</span>(<span class="string">"^[a-zA-Z0-9_%-%.%%/,;]+$"</span>) <span class="keyword">then</span></span><br><span class="line">            url[#url+<span class="number">1</span>] = <span class="string">"/"</span></span><br><span class="line">            url[#url+<span class="number">1</span>] = p</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> #<span class="built_in">path</span> == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        url[#url+<span class="number">1</span>] = <span class="string">"/"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">table</span>.<span class="built_in">concat</span>(url, <span class="string">""</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">node_visible</span><span class="params">(node)</span></span></span><br><span class="line">   <span class="keyword">if</span> node <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">not</span> (</span><br><span class="line">         (<span class="keyword">not</span> node.title <span class="keyword">or</span> #node.title == <span class="number">0</span>) <span class="keyword">or</span></span><br><span class="line">         (<span class="keyword">not</span> node.target <span class="keyword">or</span> node.hidden == <span class="literal">true</span>) <span class="keyword">or</span></span><br><span class="line">         (<span class="built_in">type</span>(node.target) == <span class="string">"table"</span> <span class="keyword">and</span> node.target.<span class="built_in">type</span> == <span class="string">"firstchild"</span> <span class="keyword">and</span></span><br><span class="line">          (<span class="built_in">type</span>(node.nodes) ~= <span class="string">"table"</span> <span class="keyword">or</span> <span class="keyword">not</span> <span class="built_in">next</span>(node.nodes)))</span><br><span class="line">      )</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">node_childs</span><span class="params">(node)</span></span></span><br><span class="line">    <span class="keyword">local</span> rv = &#123; &#125;</span><br><span class="line">    <span class="keyword">if</span> node <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> k, v</span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> util.spairs(node.nodes,</span><br><span class="line">            <span class="function"><span class="keyword">function</span><span class="params">(a, b)</span></span></span><br><span class="line">                <span class="keyword">return</span> (node.nodes[a].order <span class="keyword">or</span> <span class="number">100</span>)</span><br><span class="line">                     &lt; (node.nodes[b].order <span class="keyword">or</span> <span class="number">100</span>)</span><br><span class="line">            <span class="keyword">end</span>)</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> node_visible(v) <span class="keyword">then</span></span><br><span class="line">                rv[#rv+<span class="number">1</span>] = k</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> rv</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">error404</span><span class="params">(message)</span></span></span><br><span class="line">    http.<span class="built_in">status</span>(<span class="number">404</span>, <span class="string">"Not Found"</span>)</span><br><span class="line">    message = message <span class="keyword">or</span> <span class="string">"Not Found"</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">require</span>(<span class="string">"luci.template"</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> util.copcall(luci.template.render, <span class="string">"error404"</span>) <span class="keyword">then</span></span><br><span class="line">        http.prepare_content(<span class="string">"text/plain"</span>)</span><br><span class="line">        http.<span class="built_in">write</span>(message)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">error500</span><span class="params">(message)</span></span></span><br><span class="line">    util.perror(message)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> context.template_header_sent <span class="keyword">then</span></span><br><span class="line">        http.<span class="built_in">status</span>(<span class="number">500</span>, <span class="string">"Internal Server Error"</span>)</span><br><span class="line">        http.prepare_content(<span class="string">"text/plain"</span>)</span><br><span class="line">        http.<span class="built_in">write</span>(message)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">require</span>(<span class="string">"luci.template"</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> util.copcall(luci.template.render, <span class="string">"error500"</span>, &#123;message=message&#125;) <span class="keyword">then</span></span><br><span class="line">            http.prepare_content(<span class="string">"text/plain"</span>)</span><br><span class="line">            http.<span class="built_in">write</span>(message)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">httpdispatch</span><span class="params">(request, prefix)</span></span></span><br><span class="line">    http.context.request = request</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> r = &#123;&#125;</span><br><span class="line">    context.request = r</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> pathinfo = http.urldecode(request:<span class="built_in">getenv</span>(<span class="string">"PATH_INFO"</span>) <span class="keyword">or</span> <span class="string">""</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> prefix <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> _, node <span class="keyword">in</span> <span class="built_in">ipairs</span>(prefix) <span class="keyword">do</span></span><br><span class="line">            r[#r+<span class="number">1</span>] = node</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> pathinfo:<span class="built_in">gmatch</span>(<span class="string">"[^/]+"</span>) <span class="keyword">do</span></span><br><span class="line">        r[#r+<span class="number">1</span>] = node</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> stat, err = util.coxpcall(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        dispatch(context.request)</span><br><span class="line">    <span class="keyword">end</span>, error500)</span><br><span class="line"></span><br><span class="line">    http.<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line">    <span class="comment">--context._disable_memtrace()</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">require_post_security</span><span class="params">(target)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(target) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(target.post) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> param_name, required_val, request_val</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> param_name, required_val <span class="keyword">in</span> <span class="built_in">pairs</span>(target.post) <span class="keyword">do</span></span><br><span class="line">                request_val = http.formvalue(param_name)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">type</span>(required_val) == <span class="string">"string"</span> <span class="keyword">and</span></span><br><span class="line">                    request_val ~= required_val) <span class="keyword">or</span></span><br><span class="line">                   (required_val == <span class="literal">true</span> <span class="keyword">and</span></span><br><span class="line">                    (request_val == <span class="literal">nil</span> <span class="keyword">or</span> request_val == <span class="string">""</span>))</span><br><span class="line">                <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> (target.post == <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test_post_security</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> http.<span class="built_in">getenv</span>(<span class="string">"REQUEST_METHOD"</span>) ~= <span class="string">"POST"</span> <span class="keyword">then</span></span><br><span class="line">        http.<span class="built_in">status</span>(<span class="number">405</span>, <span class="string">"Method Not Allowed"</span>)</span><br><span class="line">        http.header(<span class="string">"Allow"</span>, <span class="string">"POST"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> http.formvalue(<span class="string">"token"</span>) ~= context.authtoken <span class="keyword">then</span></span><br><span class="line">        http.<span class="built_in">status</span>(<span class="number">403</span>, <span class="string">"Forbidden"</span>)</span><br><span class="line">        luci.template.render(<span class="string">"csrftoken"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">session_retrieve</span><span class="params">(sid, allowed_users)</span></span></span><br><span class="line">    <span class="keyword">local</span> sdat = util.ubus(<span class="string">"session"</span>, <span class="string">"get"</span>, &#123; ubus_rpc_session = sid &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(sdat) == <span class="string">"table"</span> <span class="keyword">and</span></span><br><span class="line">       <span class="built_in">type</span>(sdat.values) == <span class="string">"table"</span> <span class="keyword">and</span></span><br><span class="line">       <span class="built_in">type</span>(sdat.values.token) == <span class="string">"string"</span> <span class="keyword">and</span></span><br><span class="line">       (<span class="keyword">not</span> allowed_users <span class="keyword">or</span></span><br><span class="line">        util.contains(allowed_users, sdat.values.username))</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> sid, sdat.values</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">session_setup</span><span class="params">(user, pass, allowed_users)</span></span></span><br><span class="line">    <span class="keyword">if</span> util.contains(allowed_users, user) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> login = util.ubus(<span class="string">"session"</span>, <span class="string">"login"</span>, &#123;</span><br><span class="line">            username = user,</span><br><span class="line">            password = pass,</span><br><span class="line">            timeout  = <span class="built_in">tonumber</span>(luci.<span class="built_in">config</span>.sauth.sessiontime)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(login) == <span class="string">"table"</span> <span class="keyword">and</span></span><br><span class="line">           <span class="built_in">type</span>(login.ubus_rpc_session) == <span class="string">"string"</span></span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            util.ubus(<span class="string">"session"</span>, <span class="string">"set"</span>, &#123;</span><br><span class="line">                ubus_rpc_session = login.ubus_rpc_session,</span><br><span class="line">                values = &#123; token = sys.uniqueid(<span class="number">16</span>) &#125;</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> session_retrieve(login.ubus_rpc_session)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatch</span><span class="params">(request)</span></span></span><br><span class="line">    <span class="comment">--context._disable_memtrace = require "luci.debug".trap_memtrace("l")</span></span><br><span class="line">    <span class="keyword">local</span> ctx = context</span><br><span class="line">    ctx.<span class="built_in">path</span> = request</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> conf = <span class="built_in">require</span> <span class="string">"luci.config"</span></span><br><span class="line">    <span class="built_in">assert</span>(conf.main,</span><br><span class="line">        <span class="string">"/etc/config/luci seems to be corrupt, unable to find section 'main'"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> i18n = <span class="built_in">require</span> <span class="string">"luci.i18n"</span></span><br><span class="line">    <span class="keyword">local</span> lang = conf.main.lang <span class="keyword">or</span> <span class="string">"auto"</span></span><br><span class="line">    <span class="keyword">if</span> lang == <span class="string">"auto"</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> aclang = http.<span class="built_in">getenv</span>(<span class="string">"HTTP_ACCEPT_LANGUAGE"</span>) <span class="keyword">or</span> <span class="string">""</span></span><br><span class="line">        <span class="keyword">for</span> lpat <span class="keyword">in</span> aclang:<span class="built_in">gmatch</span>(<span class="string">"[%w-]+"</span>) <span class="keyword">do</span></span><br><span class="line">            lpat = lpat <span class="keyword">and</span> lpat:<span class="built_in">gsub</span>(<span class="string">"-"</span>, <span class="string">"_"</span>)</span><br><span class="line">            <span class="keyword">if</span> conf.languages[lpat] <span class="keyword">then</span></span><br><span class="line">                lang = lpat</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> lang == <span class="string">"auto"</span> <span class="keyword">then</span></span><br><span class="line">        lang = i18n.default</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    i18n.setlanguage(lang)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> c = ctx.tree</span><br><span class="line">    <span class="keyword">local</span> stat</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> c <span class="keyword">then</span></span><br><span class="line">        c = createtree()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> track = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> args = &#123;&#125;</span><br><span class="line">    ctx.args = args</span><br><span class="line">    ctx.requestargs = ctx.requestargs <span class="keyword">or</span> args</span><br><span class="line">    <span class="keyword">local</span> n</span><br><span class="line">    <span class="keyword">local</span> preq = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> freq = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, s <span class="keyword">in</span> <span class="built_in">ipairs</span>(request) <span class="keyword">do</span></span><br><span class="line">        preq[#preq+<span class="number">1</span>] = s</span><br><span class="line">        freq[#freq+<span class="number">1</span>] = s</span><br><span class="line">        c = c.nodes[s]</span><br><span class="line">        n = i</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> c <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        util.update(track, c)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> c.leaf <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> c.leaf <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> j=n+<span class="number">1</span>, #request <span class="keyword">do</span></span><br><span class="line">            args[#args+<span class="number">1</span>] = request[j]</span><br><span class="line">            freq[#freq+<span class="number">1</span>] = request[j]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    ctx.requestpath = ctx.requestpath <span class="keyword">or</span> freq</span><br><span class="line">    ctx.<span class="built_in">path</span> = preq</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.i18n <span class="keyword">then</span></span><br><span class="line">        i18n.loadc(track.i18n)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Init template engine</span></span><br><span class="line">    <span class="keyword">if</span> (c <span class="keyword">and</span> c.index) <span class="keyword">or</span> <span class="keyword">not</span> track.notemplate <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> tpl = <span class="built_in">require</span>(<span class="string">"luci.template"</span>)</span><br><span class="line">        <span class="keyword">local</span> media = track.mediaurlbase <span class="keyword">or</span> luci.<span class="built_in">config</span>.main.mediaurlbase</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">pcall</span>(tpl.Template, <span class="string">"themes/%s/header"</span> % fs.basename(media)) <span class="keyword">then</span></span><br><span class="line">            media = <span class="literal">nil</span></span><br><span class="line">            <span class="keyword">for</span> name, theme <span class="keyword">in</span> <span class="built_in">pairs</span>(luci.<span class="built_in">config</span>.themes) <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">if</span> name:<span class="built_in">sub</span>(<span class="number">1</span>,<span class="number">1</span>) ~= <span class="string">"."</span> <span class="keyword">and</span> <span class="built_in">pcall</span>(tpl.Template,</span><br><span class="line">                 <span class="string">"themes/%s/header"</span> % fs.basename(theme)) <span class="keyword">then</span></span><br><span class="line">                    media = theme</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="built_in">assert</span>(media, <span class="string">"No valid theme found"</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _ifattr<span class="params">(cond, key, val)</span></span></span><br><span class="line">            <span class="keyword">if</span> cond <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">local</span> env = <span class="built_in">getfenv</span>(<span class="number">3</span>)</span><br><span class="line">                <span class="keyword">local</span> scope = (<span class="built_in">type</span>(env.self) == <span class="string">"table"</span>) <span class="keyword">and</span> env.self</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">type</span>(val) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">next</span>(val) <span class="keyword">then</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        val = util.serialize_json(val)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">format</span>(</span><br><span class="line">                    <span class="string">' %s="%s"'</span>, <span class="built_in">tostring</span>(key),</span><br><span class="line">                    util.pcdata(<span class="built_in">tostring</span>( val</span><br><span class="line">                     <span class="keyword">or</span> (<span class="built_in">type</span>(env[key]) ~= <span class="string">"function"</span> <span class="keyword">and</span> env[key])</span><br><span class="line">                     <span class="keyword">or</span> (scope <span class="keyword">and</span> <span class="built_in">type</span>(scope[key]) ~= <span class="string">"function"</span> <span class="keyword">and</span> scope[key])</span><br><span class="line">                     <span class="keyword">or</span> <span class="string">""</span> ))</span><br><span class="line">                )</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        tpl.context.viewns = <span class="built_in">setmetatable</span>(&#123;</span><br><span class="line">           <span class="built_in">write</span>       = http.<span class="built_in">write</span>;</span><br><span class="line">           include     = <span class="function"><span class="keyword">function</span><span class="params">(name)</span></span> tpl.Template(name):render(<span class="built_in">getfenv</span>(<span class="number">2</span>)) <span class="keyword">end</span>;</span><br><span class="line">           translate   = i18n.translate;</span><br><span class="line">           translatef  = i18n.translatef;</span><br><span class="line">           export      = <span class="function"><span class="keyword">function</span><span class="params">(k, v)</span></span> <span class="keyword">if</span> tpl.context.viewns[k] == <span class="literal">nil</span> <span class="keyword">then</span> tpl.context.viewns[k] = v <span class="keyword">end</span> <span class="keyword">end</span>;</span><br><span class="line">           striptags   = util.striptags;</span><br><span class="line">           pcdata      = util.pcdata;</span><br><span class="line">           media       = media;</span><br><span class="line">           theme       = fs.basename(media);</span><br><span class="line">           resource    = luci.<span class="built_in">config</span>.main.resourcebase;</span><br><span class="line">           ifattr      = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span> <span class="keyword">return</span> _ifattr(...) <span class="keyword">end</span>;</span><br><span class="line">           attr        = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span> <span class="keyword">return</span> _ifattr(<span class="literal">true</span>, ...) <span class="keyword">end</span>;</span><br><span class="line">           url         = build_url;</span><br><span class="line">        &#125;, &#123;<span class="built_in">__index</span>=<span class="function"><span class="keyword">function</span><span class="params">(table, key)</span></span></span><br><span class="line">            <span class="keyword">if</span> key == <span class="string">"controller"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> build_url()</span><br><span class="line">            <span class="keyword">elseif</span> key == <span class="string">"REQUEST_URI"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> build_url(<span class="built_in">unpack</span>(ctx.requestpath))</span><br><span class="line">            <span class="keyword">elseif</span> key == <span class="string">"token"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> ctx.authtoken</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">rawget</span>(<span class="built_in">table</span>, key) <span class="keyword">or</span> <span class="built_in">_G</span>[key]</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span>&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    track.dependent = (track.dependent ~= <span class="literal">false</span>)</span><br><span class="line">    <span class="built_in">assert</span>(<span class="keyword">not</span> track.dependent <span class="keyword">or</span> <span class="keyword">not</span> track.auto,</span><br><span class="line">        <span class="string">"Access Violation\nThe page at '"</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(request, <span class="string">"/"</span>) .. <span class="string">"/' "</span> ..</span><br><span class="line">        <span class="string">"has no parent node so the access to this location has been denied.\n"</span> ..</span><br><span class="line">        <span class="string">"This is a software bug, please report this message at "</span> ..</span><br><span class="line">        <span class="string">"https://github.com/openwrt/luci/issues"</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.sysauth <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> authen = track.sysauth_authenticator</span><br><span class="line">        <span class="keyword">local</span> _, sid, sdat, default_user, allowed_users</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(authen) == <span class="string">"string"</span> <span class="keyword">and</span> authen ~= <span class="string">"htmlauth"</span> <span class="keyword">then</span></span><br><span class="line">            error500(<span class="string">"Unsupported authenticator %q configured"</span> % authen)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(track.sysauth) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            default_user, allowed_users = <span class="literal">nil</span>, track.sysauth</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            default_user, allowed_users = track.sysauth, &#123; track.sysauth &#125;</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(authen) == <span class="string">"function"</span> <span class="keyword">then</span></span><br><span class="line">            _, sid = authen(sys.user.checkpasswd, allowed_users)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            sid = http.getcookie(<span class="string">"sysauth"</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        sid, sdat = session_retrieve(sid, allowed_users)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (sid <span class="keyword">and</span> sdat) <span class="keyword">and</span> authen == <span class="string">"htmlauth"</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> user = http.<span class="built_in">getenv</span>(<span class="string">"HTTP_AUTH_USER"</span>)</span><br><span class="line">            <span class="keyword">local</span> pass = http.<span class="built_in">getenv</span>(<span class="string">"HTTP_AUTH_PASS"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> user == <span class="literal">nil</span> <span class="keyword">and</span> pass == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">                user = http.formvalue(<span class="string">"luci_username"</span>)</span><br><span class="line">                pass = http.formvalue(<span class="string">"luci_password"</span>)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            sid, sdat = session_setup(user, pass, allowed_users)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> sid <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">local</span> tmpl = <span class="built_in">require</span> <span class="string">"luci.template"</span></span><br><span class="line"></span><br><span class="line">                context.<span class="built_in">path</span> = &#123;&#125;</span><br><span class="line"></span><br><span class="line">                http.<span class="built_in">status</span>(<span class="number">403</span>, <span class="string">"Forbidden"</span>)</span><br><span class="line">                tmpl.render(track.sysauth_template <span class="keyword">or</span> <span class="string">"sysauth"</span>, &#123;</span><br><span class="line">                    duser = default_user,</span><br><span class="line">                    fuser = user</span><br><span class="line">                &#125;)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            http.header(<span class="string">"Set-Cookie"</span>, <span class="string">'sysauth=%s; path=%s'</span> %&#123; sid, build_url() &#125;)</span><br><span class="line">            http.redirect(build_url(<span class="built_in">unpack</span>(ctx.requestpath)))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> sid <span class="keyword">or</span> <span class="keyword">not</span> sdat <span class="keyword">then</span></span><br><span class="line">            http.<span class="built_in">status</span>(<span class="number">403</span>, <span class="string">"Forbidden"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        ctx.authsession = sid</span><br><span class="line">        ctx.authtoken = sdat.token</span><br><span class="line">        ctx.authuser = sdat.username</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> require_post_security(c.target) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> test_post_security(c) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.setgroup <span class="keyword">then</span></span><br><span class="line">        sys.process.setgroup(track.setgroup)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> track.setuser <span class="keyword">then</span></span><br><span class="line">        sys.process.setuser(track.setuser)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> target = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(c.target) == <span class="string">"function"</span> <span class="keyword">then</span></span><br><span class="line">            target = c.target</span><br><span class="line">        <span class="keyword">elseif</span> <span class="built_in">type</span>(c.target) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            target = c.target.target</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> (c.index <span class="keyword">or</span> <span class="built_in">type</span>(target) == <span class="string">"function"</span>) <span class="keyword">then</span></span><br><span class="line">        ctx.dispatched = c</span><br><span class="line">        ctx.requested = ctx.requested <span class="keyword">or</span> ctx.dispatched</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> c <span class="keyword">and</span> c.index <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> tpl = <span class="built_in">require</span> <span class="string">"luci.template"</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> util.copcall(tpl.render, <span class="string">"indexer"</span>, &#123;&#125;) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(target) == <span class="string">"function"</span> <span class="keyword">then</span></span><br><span class="line">        util.copcall(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">            <span class="keyword">local</span> oldenv = <span class="built_in">getfenv</span>(target)</span><br><span class="line">            <span class="keyword">local</span> module = <span class="built_in">require</span>(c.module)</span><br><span class="line">            <span class="keyword">local</span> env = <span class="built_in">setmetatable</span>(&#123;&#125;, &#123;<span class="built_in">__index</span>=</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">function</span><span class="params">(tbl, key)</span></span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">rawget</span>(tbl, key) <span class="keyword">or</span> module[key] <span class="keyword">or</span> oldenv[key]</span><br><span class="line">            <span class="keyword">end</span>&#125;)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">setfenv</span>(target, env)</span><br><span class="line">        <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> ok, err</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">type</span>(c.target) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            ok, err = util.copcall(target, c.target, <span class="built_in">unpack</span>(args))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            ok, err = util.copcall(target, <span class="built_in">unpack</span>(args))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">assert</span>(ok,</span><br><span class="line">               <span class="string">"Failed to execute "</span> .. (<span class="built_in">type</span>(c.target) == <span class="string">"function"</span> <span class="keyword">and</span> <span class="string">"function"</span> <span class="keyword">or</span> c.target.<span class="built_in">type</span> <span class="keyword">or</span> <span class="string">"unknown"</span>) ..</span><br><span class="line">               <span class="string">" dispatcher target for entry '/"</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(request, <span class="string">"/"</span>) .. <span class="string">"'.\n"</span> ..</span><br><span class="line">               <span class="string">"The called action terminated with an exception:\n"</span> .. <span class="built_in">tostring</span>(err <span class="keyword">or</span> <span class="string">"(unknown)"</span>))</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">local</span> root = node()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root <span class="keyword">or</span> <span class="keyword">not</span> root.target <span class="keyword">then</span></span><br><span class="line">            error404(<span class="string">"No root node was registered, this usually happens if no module was installed.\n"</span> ..</span><br><span class="line">                     <span class="string">"Install luci-mod-admin-full and retry. "</span> ..</span><br><span class="line">                     <span class="string">"If the module is already installed, try removing the /tmp/luci-indexcache file."</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            error404(<span class="string">"No page is registered at '/"</span> .. <span class="built_in">table</span>.<span class="built_in">concat</span>(request, <span class="string">"/"</span>) .. <span class="string">"'.\n"</span> ..</span><br><span class="line">                     <span class="string">"If this url belongs to an extension, make sure it is properly installed.\n"</span> ..</span><br><span class="line">                     <span class="string">"If the extension was recently installed, try removing the /tmp/luci-indexcache file."</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createindex</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> controllers = &#123; &#125;</span><br><span class="line">    <span class="keyword">local</span> base = <span class="string">"%s/controller/"</span> % util.libpath()</span><br><span class="line">    <span class="keyword">local</span> _, <span class="built_in">path</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">path</span> <span class="keyword">in</span> (fs.glob(<span class="string">"%s*.lua"</span> % base) <span class="keyword">or</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>) <span class="keyword">do</span></span><br><span class="line">        controllers[#controllers+<span class="number">1</span>] = <span class="built_in">path</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">path</span> <span class="keyword">in</span> (fs.glob(<span class="string">"%s*/*.lua"</span> % base) <span class="keyword">or</span> <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span>) <span class="keyword">do</span></span><br><span class="line">        controllers[#controllers+<span class="number">1</span>] = <span class="built_in">path</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> indexcache <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> cachedate = fs.stat(indexcache, <span class="string">"mtime"</span>)</span><br><span class="line">        <span class="keyword">if</span> cachedate <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> realdate = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> _, obj <span class="keyword">in</span> <span class="built_in">ipairs</span>(controllers) <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">local</span> omtime = fs.stat(obj, <span class="string">"mtime"</span>)</span><br><span class="line">                realdate = (omtime <span class="keyword">and</span> omtime &gt; realdate) <span class="keyword">and</span> omtime <span class="keyword">or</span> realdate</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> cachedate &gt; realdate <span class="keyword">and</span> sys.process.info(<span class="string">"uid"</span>) == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">assert</span>(</span><br><span class="line">                    sys.process.info(<span class="string">"uid"</span>) == fs.stat(indexcache, <span class="string">"uid"</span>)</span><br><span class="line">                    <span class="keyword">and</span> fs.stat(indexcache, <span class="string">"modestr"</span>) == <span class="string">"rw-------"</span>,</span><br><span class="line">                    <span class="string">"Fatal: Indexcache is not sane!"</span></span><br><span class="line">                )</span><br><span class="line"></span><br><span class="line">                index = <span class="built_in">loadfile</span>(indexcache)()</span><br><span class="line">                <span class="keyword">return</span> index</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    index = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, <span class="built_in">path</span> <span class="keyword">in</span> <span class="built_in">ipairs</span>(controllers) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> modname = <span class="string">"luci.controller."</span> .. <span class="built_in">path</span>:<span class="built_in">sub</span>(#base+<span class="number">1</span>, #<span class="built_in">path</span><span class="number">-4</span>):<span class="built_in">gsub</span>(<span class="string">"/"</span>, <span class="string">"."</span>)</span><br><span class="line">        <span class="keyword">local</span> <span class="built_in">mod</span> = <span class="built_in">require</span>(modname)</span><br><span class="line">        <span class="built_in">assert</span>(<span class="built_in">mod</span> ~= <span class="literal">true</span>,</span><br><span class="line">               <span class="string">"Invalid controller file found\n"</span> ..</span><br><span class="line">               <span class="string">"The file '"</span> .. <span class="built_in">path</span> .. <span class="string">"' contains an invalid module line.\n"</span> ..</span><br><span class="line">               <span class="string">"Please verify whether the module name is set to '"</span> .. modname ..</span><br><span class="line">               <span class="string">"' - It must correspond to the file path!"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">local</span> idx = <span class="built_in">mod</span>.index</span><br><span class="line">        <span class="built_in">assert</span>(<span class="built_in">type</span>(idx) == <span class="string">"function"</span>,</span><br><span class="line">               <span class="string">"Invalid controller file found\n"</span> ..</span><br><span class="line">               <span class="string">"The file '"</span> .. <span class="built_in">path</span> .. <span class="string">"' contains no index() function.\n"</span> ..</span><br><span class="line">               <span class="string">"Please make sure that the controller contains a valid "</span> ..</span><br><span class="line">               <span class="string">"index function and verify the spelling!"</span>)</span><br><span class="line"></span><br><span class="line">        index[modname] = idx</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> indexcache <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> f = nixio.<span class="built_in">open</span>(indexcache, <span class="string">"w"</span>, <span class="number">600</span>)</span><br><span class="line">        f:writeall(util.get_bytecode(index))</span><br><span class="line">        f:<span class="built_in">close</span>()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Build the index before if it does not exist yet.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createtree</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> index <span class="keyword">then</span></span><br><span class="line">        createindex()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> ctx  = context</span><br><span class="line">    <span class="keyword">local</span> tree = &#123;nodes=&#123;&#125;, inreq=<span class="literal">true</span>&#125;</span><br><span class="line">    <span class="keyword">local</span> modi = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    ctx.treecache = <span class="built_in">setmetatable</span>(&#123;&#125;, &#123;<span class="built_in">__mode</span>=<span class="string">"v"</span>&#125;)</span><br><span class="line">    ctx.tree = tree</span><br><span class="line">    ctx.modifiers = modi</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- Load default translation</span></span><br><span class="line">    <span class="built_in">require</span> <span class="string">"luci.i18n"</span>.loadc(<span class="string">"base"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> scope = <span class="built_in">setmetatable</span>(&#123;&#125;, &#123;<span class="built_in">__index</span> = luci.dispatcher&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(index) <span class="keyword">do</span></span><br><span class="line">        scope._NAME = k</span><br><span class="line">        <span class="built_in">setfenv</span>(v, scope)</span><br><span class="line">        v()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">modisort</span><span class="params">(a,b)</span></span></span><br><span class="line">        <span class="keyword">return</span> modi[a].order &lt; modi[b].order</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, v <span class="keyword">in</span> util.spairs(modi, modisort) <span class="keyword">do</span></span><br><span class="line">        scope._NAME = v.module</span><br><span class="line">        <span class="built_in">setfenv</span>(v.func, scope)</span><br><span class="line">        v.func()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tree</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">modifier</span><span class="params">(func, order)</span></span></span><br><span class="line">    context.modifiers[#context.modifiers+<span class="number">1</span>] = &#123;</span><br><span class="line">        func = func,</span><br><span class="line">        order = order <span class="keyword">or</span> <span class="number">0</span>,</span><br><span class="line">        module</span><br><span class="line">            = <span class="built_in">getfenv</span>(<span class="number">2</span>)._NAME</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">assign</span><span class="params">(path, clone, title, order)</span></span></span><br><span class="line">    <span class="keyword">local</span> obj  = node(<span class="built_in">unpack</span>(<span class="built_in">path</span>))</span><br><span class="line">    obj.nodes  = <span class="literal">nil</span></span><br><span class="line">    obj.module = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    obj.title = title</span><br><span class="line">    obj.order = order</span><br><span class="line"></span><br><span class="line">    <span class="built_in">setmetatable</span>(obj, &#123;<span class="built_in">__index</span> = _create_node(clone)&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">entry</span><span class="params">(path, target, title, order)</span></span></span><br><span class="line">    <span class="keyword">local</span> c = node(<span class="built_in">unpack</span>(<span class="built_in">path</span>))</span><br><span class="line"></span><br><span class="line">    c.target = target</span><br><span class="line">    c.title  = title</span><br><span class="line">    c.order  = order</span><br><span class="line">    c.module = <span class="built_in">getfenv</span>(<span class="number">2</span>)._NAME</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- enabling the node.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">return</span> _create_node(&#123;...&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">node</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> c = _create_node(&#123;...&#125;)</span><br><span class="line"></span><br><span class="line">    c.module = <span class="built_in">getfenv</span>(<span class="number">2</span>)._NAME</span><br><span class="line">    c.auto = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> _create_node<span class="params">(path)</span></span></span><br><span class="line">    <span class="keyword">if</span> #<span class="built_in">path</span> == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> context.tree</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> name = <span class="built_in">table</span>.<span class="built_in">concat</span>(<span class="built_in">path</span>, <span class="string">"."</span>)</span><br><span class="line">    <span class="keyword">local</span> c = context.treecache[name]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> c <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> last = <span class="built_in">table</span>.<span class="built_in">remove</span>(<span class="built_in">path</span>)</span><br><span class="line">        <span class="keyword">local</span> parent = _create_node(<span class="built_in">path</span>)</span><br><span class="line"></span><br><span class="line">        c = &#123;nodes=&#123;&#125;, auto=<span class="literal">true</span>&#125;</span><br><span class="line">        <span class="comment">-- the node is "in request" if the request path matches</span></span><br><span class="line">        <span class="comment">-- at least up to the length of the node path</span></span><br><span class="line">        <span class="keyword">if</span> parent.inreq <span class="keyword">and</span> context.<span class="built_in">path</span>[#<span class="built_in">path</span>+<span class="number">1</span>] == last <span class="keyword">then</span></span><br><span class="line">          c.inreq = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        parent.nodes[last] = c</span><br><span class="line">        context.treecache[name] = c</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- Subdispatchers --</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> _firstchild<span class="params">()</span></span></span><br><span class="line">   <span class="keyword">local</span> <span class="built_in">path</span> = &#123; <span class="built_in">unpack</span>(context.<span class="built_in">path</span>) &#125;</span><br><span class="line">   <span class="keyword">local</span> name = <span class="built_in">table</span>.<span class="built_in">concat</span>(<span class="built_in">path</span>, <span class="string">"."</span>)</span><br><span class="line">   <span class="keyword">local</span> node = context.treecache[name]</span><br><span class="line"></span><br><span class="line">   <span class="keyword">local</span> lowest</span><br><span class="line">   <span class="keyword">if</span> node <span class="keyword">and</span> node.nodes <span class="keyword">and</span> <span class="built_in">next</span>(node.nodes) <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">local</span> k, v</span><br><span class="line">      <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(node.nodes) <span class="keyword">do</span></span><br><span class="line">         <span class="keyword">if</span> <span class="keyword">not</span> lowest <span class="keyword">or</span></span><br><span class="line">            (v.order <span class="keyword">or</span> <span class="number">100</span>) &lt; (node.nodes[lowest].order <span class="keyword">or</span> <span class="number">100</span>)</span><br><span class="line">         <span class="keyword">then</span></span><br><span class="line">            lowest = k</span><br><span class="line">         <span class="keyword">end</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">   <span class="built_in">assert</span>(lowest ~= <span class="literal">nil</span>,</span><br><span class="line">          <span class="string">"The requested node contains no childs, unable to redispatch"</span>)</span><br><span class="line"></span><br><span class="line">   <span class="built_in">path</span>[#<span class="built_in">path</span>+<span class="number">1</span>] = lowest</span><br><span class="line">   dispatch(<span class="built_in">path</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">firstchild</span><span class="params">()</span></span></span><br><span class="line">   <span class="keyword">return</span> &#123; <span class="built_in">type</span> = <span class="string">"firstchild"</span>, target = _firstchild &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">alias</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> req = &#123;...&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span></span><br><span class="line">        <span class="keyword">for</span> _, r <span class="keyword">in</span> <span class="built_in">ipairs</span>(&#123;...&#125;) <span class="keyword">do</span></span><br><span class="line">            req[#req+<span class="number">1</span>] = r</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        dispatch(req)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rewrite</span><span class="params">(n, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> req = &#123;...&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span></span><br><span class="line">        <span class="keyword">local</span> dispatched = util.clone(context.dispatched)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i=<span class="number">1</span>,n <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">remove</span>(dispatched, <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, r <span class="keyword">in</span> <span class="built_in">ipairs</span>(req) <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(dispatched, i, r)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> _, r <span class="keyword">in</span> <span class="built_in">ipairs</span>(&#123;...&#125;) <span class="keyword">do</span></span><br><span class="line">            dispatched[#dispatched+<span class="number">1</span>] = r</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        dispatch(dispatched)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _call<span class="params">(self, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> func = <span class="built_in">getfenv</span>()[self.name]</span><br><span class="line">    <span class="built_in">assert</span>(func ~= <span class="literal">nil</span>,</span><br><span class="line">           <span class="string">'Cannot resolve function "'</span> .. self.name .. <span class="string">'". Is it misspelled or local?'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">assert</span>(<span class="built_in">type</span>(func) == <span class="string">"function"</span>,</span><br><span class="line">           <span class="string">'The symbol "'</span> .. self.name .. <span class="string">'" does not refer to a function but data '</span> ..</span><br><span class="line">           <span class="string">'of type "'</span> .. <span class="built_in">type</span>(func) .. <span class="string">'".'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> #self.argv &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> func(<span class="built_in">unpack</span>(self.argv), ...)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> func(...)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">call</span><span class="params">(name, ...)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="built_in">type</span> = <span class="string">"call"</span>, argv = &#123;...&#125;, name = name, target = _call&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">post_on</span><span class="params">(params, name, ...)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="built_in">type</span> = <span class="string">"call"</span>,</span><br><span class="line">        post = params,</span><br><span class="line">        argv = &#123; ... &#125;,</span><br><span class="line">        name = name,</span><br><span class="line">        target = _call</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">post</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">return</span> post_on(<span class="literal">true</span>, ...)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> _template = <span class="function"><span class="keyword">function</span><span class="params">(self, ...)</span></span></span><br><span class="line">    <span class="built_in">require</span> <span class="string">"luci.template"</span>.render(self.view)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">template</span><span class="params">(name)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="built_in">type</span> = <span class="string">"template"</span>, view = name, target = _template&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _cbi<span class="params">(self, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> cbi = <span class="built_in">require</span> <span class="string">"luci.cbi"</span></span><br><span class="line">    <span class="keyword">local</span> tpl = <span class="built_in">require</span> <span class="string">"luci.template"</span></span><br><span class="line">    <span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">"luci.http"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">config</span> = self.<span class="built_in">config</span> <span class="keyword">or</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> maps = cbi.<span class="built_in">load</span>(self.model, ...)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> state = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, res <span class="keyword">in</span> <span class="built_in">ipairs</span>(maps) <span class="keyword">do</span></span><br><span class="line">        res.flow = <span class="built_in">config</span></span><br><span class="line">        <span class="keyword">local</span> cstate = res:parse()</span><br><span class="line">        <span class="keyword">if</span> cstate <span class="keyword">and</span> (<span class="keyword">not</span> state <span class="keyword">or</span> cstate &lt; state) <span class="keyword">then</span></span><br><span class="line">            state = cstate</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _resolve_path<span class="params">(path)</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">type</span>(<span class="built_in">path</span>) == <span class="string">"table"</span> <span class="keyword">and</span> build_url(<span class="built_in">unpack</span>(<span class="built_in">path</span>)) <span class="keyword">or</span> <span class="built_in">path</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span>.on_valid_to <span class="keyword">and</span> state <span class="keyword">and</span> state &gt; <span class="number">0</span> <span class="keyword">and</span> state &lt; <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">        http.redirect(_resolve_path(<span class="built_in">config</span>.on_valid_to))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span>.on_changed_to <span class="keyword">and</span> state <span class="keyword">and</span> state &gt; <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        http.redirect(_resolve_path(<span class="built_in">config</span>.on_changed_to))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span>.on_success_to <span class="keyword">and</span> state <span class="keyword">and</span> state &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        http.redirect(_resolve_path(<span class="built_in">config</span>.on_success_to))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">config</span>.state_handler <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">config</span>.state_handler(state, maps) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    http.header(<span class="string">"X-CBI-State"</span>, state <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">config</span>.noheader <span class="keyword">then</span></span><br><span class="line">        tpl.render(<span class="string">"cbi/header"</span>, &#123;state = state&#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> redirect</span><br><span class="line">    <span class="keyword">local</span> messages</span><br><span class="line">    <span class="keyword">local</span> applymap   = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">local</span> pageaction = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">local</span> parsechain = &#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, res <span class="keyword">in</span> <span class="built_in">ipairs</span>(maps) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> res.apply_needed <span class="keyword">and</span> res.parsechain <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> c</span><br><span class="line">            <span class="keyword">for</span> _, c <span class="keyword">in</span> <span class="built_in">ipairs</span>(res.parsechain) <span class="keyword">do</span></span><br><span class="line">                parsechain[#parsechain+<span class="number">1</span>] = c</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            applymap = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> res.redirect <span class="keyword">then</span></span><br><span class="line">            redirect = redirect <span class="keyword">or</span> res.redirect</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> res.pageaction == <span class="literal">false</span> <span class="keyword">then</span></span><br><span class="line">            pageaction = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> res.message <span class="keyword">then</span></span><br><span class="line">            messages = messages <span class="keyword">or</span> &#123; &#125;</span><br><span class="line">            messages[#messages+<span class="number">1</span>] = res.message</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, res <span class="keyword">in</span> <span class="built_in">ipairs</span>(maps) <span class="keyword">do</span></span><br><span class="line">        res:render(&#123;</span><br><span class="line">            firstmap   = (i == <span class="number">1</span>),</span><br><span class="line">            applymap   = applymap,</span><br><span class="line">            redirect   = redirect,</span><br><span class="line">            messages   = messages,</span><br><span class="line">            pageaction = pageaction,</span><br><span class="line">            parsechain = parsechain</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">config</span>.nofooter <span class="keyword">then</span></span><br><span class="line">        tpl.render(<span class="string">"cbi/footer"</span>, &#123;</span><br><span class="line">            flow       = <span class="built_in">config</span>,</span><br><span class="line">            pageaction = pageaction,</span><br><span class="line">            redirect   = redirect,</span><br><span class="line">            state      = state,</span><br><span class="line">            autoapply  = <span class="built_in">config</span>.autoapply</span><br><span class="line">        &#125;)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cbi</span><span class="params">(model, config)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="built_in">type</span> = <span class="string">"cbi"</span>,</span><br><span class="line">        post = &#123; [<span class="string">"cbi.submit"</span>] = <span class="string">"1"</span> &#125;,</span><br><span class="line">        <span class="built_in">config</span> = <span class="built_in">config</span>,</span><br><span class="line">        model = model,</span><br><span class="line">        target = _cbi</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _arcombine<span class="params">(self, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> argv = &#123;...&#125;</span><br><span class="line">    <span class="keyword">local</span> target = #argv &gt; <span class="number">0</span> <span class="keyword">and</span> self.targets[<span class="number">2</span>] <span class="keyword">or</span> self.targets[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">setfenv</span>(target.target, self.env)</span><br><span class="line">    target:target(<span class="built_in">unpack</span>(argv))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">arcombine</span><span class="params">(trg1, trg2)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="built_in">type</span> = <span class="string">"arcombine"</span>, env = <span class="built_in">getfenv</span>(), target = _arcombine, targets = &#123;trg1, trg2&#125;&#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> _form<span class="params">(self, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> cbi = <span class="built_in">require</span> <span class="string">"luci.cbi"</span></span><br><span class="line">    <span class="keyword">local</span> tpl = <span class="built_in">require</span> <span class="string">"luci.template"</span></span><br><span class="line">    <span class="keyword">local</span> http = <span class="built_in">require</span> <span class="string">"luci.http"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> maps = luci.cbi.<span class="built_in">load</span>(self.model, ...)</span><br><span class="line">    <span class="keyword">local</span> state = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i, res <span class="keyword">in</span> <span class="built_in">ipairs</span>(maps) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> cstate = res:parse()</span><br><span class="line">        <span class="keyword">if</span> cstate <span class="keyword">and</span> (<span class="keyword">not</span> state <span class="keyword">or</span> cstate &lt; state) <span class="keyword">then</span></span><br><span class="line">            state = cstate</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    http.header(<span class="string">"X-CBI-State"</span>, state <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line">    tpl.render(<span class="string">"header"</span>)</span><br><span class="line">    <span class="keyword">for</span> i, res <span class="keyword">in</span> <span class="built_in">ipairs</span>(maps) <span class="keyword">do</span></span><br><span class="line">        res:render()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    tpl.render(<span class="string">"footer"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">form</span><span class="params">(model)</span></span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="built_in">type</span> = <span class="string">"cbi"</span>,</span><br><span class="line">        post = &#123; [<span class="string">"cbi.submit"</span>] = <span class="string">"1"</span> &#125;,</span><br><span class="line">        model = model,</span><br><span class="line">        target = _form</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">translate = i18n.translate</span><br><span class="line"></span><br><span class="line"><span class="comment">-- This function does not actually translate the given argument but</span></span><br><span class="line"><span class="comment">-- is used by build/i18n-scan.pl to find translatable entries.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> _<span class="params">(text)</span></span></span><br><span class="line">    <span class="keyword">return</span> text</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> å‰ç«¯ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Luci </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Linux ä¸²å£è°ƒè¯•å·¥å…·</title>
      <link href="/2018/05/23/%E5%B7%A5%E5%85%B7/02Linux%E4%B8%B2%E5%8F%A3%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7/"/>
      <url>/2018/05/23/%E5%B7%A5%E5%85%B7/02Linux%E4%B8%B2%E5%8F%A3%E8%B0%83%E8%AF%95%E5%B7%A5%E5%85%B7/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>minicom</strong></p><h2 id="1ã€å®‰è£…"><a href="#1ã€å®‰è£…" class="headerlink" title="1ã€å®‰è£…"></a>1ã€å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install minicom</span><br></pre></td></tr></table></figure><h2 id="2ã€æŸ¥çœ‹ä¸²å£"><a href="#2ã€æŸ¥çœ‹ä¸²å£" class="headerlink" title="2ã€æŸ¥çœ‹ä¸²å£"></a>2ã€æŸ¥çœ‹ä¸²å£</h2><p>ä½¿ç”¨linuxä¸²å£ä¸€èˆ¬<code>/dev/ttyS*</code>,å¦‚ä½•æŸ¥çœ‹å½“å‰ä½¿ç”¨çš„æ˜¯é‚£ä¸ª<code>ttyS*</code>ã€‚<br>æ–¹å¼1ï¼šæŸ¥çœ‹ä¸²å£æ˜¯å¦å¯ç”¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">su   <span class="comment">#åˆ‡æ¢root</span></span><br><span class="line"><span class="built_in">echo</span> 123 &gt; /dev/ttyS0</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/tools_02/01.png" alt></p></div><br>å¦‚å›¾ï¼Œå¦‚æœä¸å¯ç”¨åˆ™ä¼šæç¤º<code>Input/Output error</code><p></p><p>æ–¹å¼2ï¼šé€šè¿‡æŸ¥çœ‹æ—¥å¿— </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dmesg | grep ttyS*</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/tools_02/02.png" alt></p></div><br>é’ˆå¯¹USBè®¾ç½®ï¼Œä¸€èˆ¬æŸ¥çœ‹<code>ttyUSB*</code><p></p><h2 id="3ã€ä½¿ç”¨ä¸²å£"><a href="#3ã€ä½¿ç”¨ä¸²å£" class="headerlink" title="3ã€ä½¿ç”¨ä¸²å£"></a>3ã€ä½¿ç”¨ä¸²å£</h2><p><strong>æ–¹å¼1:</strong><br>1ã€æ‰“å¼€minicom</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo minicom</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/tools_02/03.png" alt></p></div><br>2ã€è¿›å…¥minicomå¸®åŠ©é¡µ<br>æŒ‰é”®<code>ctrl+A</code>(ä¸åŒºåˆ†å¤§å°å†™)ï¼ŒéšåæŒ‰<code>z</code>,å‡ºç°å¦‚ä¸‹ï¼š<p></p><div align="left"><p><img src="/img/tools_02/04.png" alt></p></div><br>3ã€è®¾ç½®minicom<br>è®¾ç½®minicom,æŒ‰<code>o</code><p></p><div align="left"><p><img src="/img/tools_02/05.png" alt></p></div><br>ä¸Šä¸‹é€‰æ‹©<code>Serial port setup</code><p></p><div align="left"><p><img src="/img/tools_02/06.png" alt></p></div><br>ä¸€èˆ¬ä¸»è¦è®¾ç½®<code>Serial Device</code>å’Œ<code>Bits</code>,è®¾ç½®åä¹‹å<code>Save setup as dfl</code>æˆ–<code>Save setup as..</code><p></p><div align="left"><p><img src="/img/tools_02/07.png" alt></p></div><br>4ã€ä½¿ç”¨<br>ä¿å­˜ä¹‹åï¼Œå¦‚æœæ²¡æœ‰ååº”ï¼Œå¯ä»¥<code>ctrl+a</code>,<code>q</code>é€€å‡ºï¼Œé‡æ–°è¿›å…¥ã€‚<p></p><p><strong>æ–¹å¼2:</strong><br>ä½¿ç”¨æ—¶ç›´æ¥è¾“å…¥è®¾å¤‡å’Œæ³¢ç‰¹ç‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo minicom -D /dev/ttyS0 -b 115200</span><br></pre></td></tr></table></figure><h2 id="4ã€å…¶ä»–å‘½ä»¤ï¼ŒæŸ¥çœ‹å·²æ¥å…¥è®¾å¤‡"><a href="#4ã€å…¶ä»–å‘½ä»¤ï¼ŒæŸ¥çœ‹å·²æ¥å…¥è®¾å¤‡" class="headerlink" title="4ã€å…¶ä»–å‘½ä»¤ï¼ŒæŸ¥çœ‹å·²æ¥å…¥è®¾å¤‡"></a>4ã€å…¶ä»–å‘½ä»¤ï¼ŒæŸ¥çœ‹å·²æ¥å…¥è®¾å¤‡</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">df</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linuxå·¥å…· </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Gitå¸¸ç”¨å‘½ä»¤</title>
      <link href="/2018/05/15/%E5%B7%A5%E5%85%B7/01Git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
      <url>/2018/05/15/%E5%B7%A5%E5%85%B7/01Git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote><p>å®‰è£…Git</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install git</span><br></pre></td></tr></table></figure><blockquote><p>è®¾ç½®Git</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name "username"</span><br><span class="line">git config --global user.email "user@example.com"</span><br></pre></td></tr></table></figure><blockquote><p>ä»“åº“ï¼Œæäº¤ä»£ç </p></blockquote><p>æœ¬åœ°ä»“åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">echo "# test" &gt;&gt; README.md</span><br><span class="line">git init</span><br><span class="line">git add README.md</span><br><span class="line">git commit -m "first commit"</span><br><span class="line">git remote add origin https://github.com/***/*.git</span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure><p>å…‹éš†è¿œç¨‹ä»“åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/***/*.git</span><br></pre></td></tr></table></figure><blockquote><p>å…¶ä»–å‘½ä»¤</p></blockquote><p>åˆ›å»ºåˆ†æ”¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b branch_a</span><br></pre></td></tr></table></figure><p>åˆ‡æ¢ä¸ºä¸»åˆ†æ”¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout master</span><br></pre></td></tr></table></figure><p>åˆ é™¤åˆ†æ”¯</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -d branch_a</span><br></pre></td></tr></table></figure><p>æ›´æ–°ä»£ç </p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git pull</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¿®æ”¹æ–‡ä»¶çŠ¶æ€</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git status</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¿®æ”¹å†…å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff filename</span><br></pre></td></tr></table></figure><blockquote><p>æ—¥å¿—</p></blockquote><p>æŸ¥çœ‹ä»“åº“å†å²ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log</span><br></pre></td></tr></table></figure><p>è¦ä»¥æ¯ä¸ªæäº¤ä¸€è¡Œçš„æ ·å¼æŸ¥çœ‹æ—¥å¿—ï¼Œä½ å¯ä»¥ç”¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log --pretty=oneline</span><br></pre></td></tr></table></figure><p>æˆ–è€…ä¹Ÿè®¸ä½ æƒ³è¦çœ‹ä¸€ä¸ªæ‰€æœ‰åˆ†æ”¯çš„ ASCII è‰ºæœ¯æ ‘ï¼Œå¸¦æœ‰æ ‡ç­¾å’Œåˆ†æ”¯åï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log --graph --oneline --decorate --all</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ åªæƒ³çœ‹å“ªäº›æ–‡ä»¶æ”¹åŠ¨è¿‡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git log --name-status</span><br></pre></td></tr></table></figure><br><blockquote><p><span class="reprint">è½¬</span>** <a href="http://www.ituring.com.cn/article/506193" target="_blank" rel="noopener">gitå‘½ä»¤</a>**</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">git init                                                  # åˆå§‹åŒ–æœ¬åœ°gitä»“åº“ï¼ˆåˆ›å»ºæ–°ä»“åº“ï¼‰</span><br><span class="line">git config --global user.name &quot;xxx&quot;                       # é…ç½®ç”¨æˆ·å</span><br><span class="line">git config --global user.email &quot;xxx@xxx.com&quot;              # é…ç½®é‚®ä»¶</span><br><span class="line">git config --global color.ui true                         # git statusç­‰å‘½ä»¤è‡ªåŠ¨ç€è‰²</span><br><span class="line">git config --global color.status auto</span><br><span class="line">git config --global color.diff auto</span><br><span class="line">git config --global color.branch auto</span><br><span class="line">git config --global color.interactive auto</span><br><span class="line">git config --global --unset http.proxy                    # remove  proxy configuration on git</span><br><span class="line">git clone git+ssh://git@192.168.53.168/VT.git             # cloneè¿œç¨‹ä»“åº“</span><br><span class="line">git status                                                # æŸ¥çœ‹å½“å‰ç‰ˆæœ¬çŠ¶æ€ï¼ˆæ˜¯å¦ä¿®æ”¹ï¼‰</span><br><span class="line">git add xyz                                               # æ·»åŠ xyzæ–‡ä»¶è‡³index</span><br><span class="line">git add .                                                 # å¢åŠ å½“å‰å­ç›®å½•ä¸‹æ‰€æœ‰æ›´æ”¹è¿‡çš„æ–‡ä»¶è‡³index</span><br><span class="line">git commit -m &apos;xxx&apos;                                       # æäº¤</span><br><span class="line">git commit --amend -m &apos;xxx&apos;                               # åˆå¹¶ä¸Šä¸€æ¬¡æäº¤ï¼ˆç”¨äºåå¤ä¿®æ”¹ï¼‰</span><br><span class="line">git commit -am &apos;xxx&apos;                                      # å°†addå’Œcommitåˆä¸ºä¸€æ­¥</span><br><span class="line">git rm xxx                                                # åˆ é™¤indexä¸­çš„æ–‡ä»¶</span><br><span class="line">git rm -r *                                               # é€’å½’åˆ é™¤</span><br><span class="line">git log                                                   # æ˜¾ç¤ºæäº¤æ—¥å¿—</span><br><span class="line">git log -1                                                # æ˜¾ç¤º1è¡Œæ—¥å¿— -nä¸ºnè¡Œ</span><br><span class="line">git log -5</span><br><span class="line">git log --stat                                            # æ˜¾ç¤ºæäº¤æ—¥å¿—åŠç›¸å…³å˜åŠ¨æ–‡ä»¶</span><br><span class="line">git log -p -m</span><br><span class="line">git show dfb02e6e4f2f7b573337763e5c0013802e392818         # æ˜¾ç¤ºæŸä¸ªæäº¤çš„è¯¦ç»†å†…å®¹</span><br><span class="line">git show dfb02                                            # å¯åªç”¨commitidçš„å‰å‡ ä½</span><br><span class="line">git show HEAD                                             # æ˜¾ç¤ºHEADæäº¤æ—¥å¿—</span><br><span class="line">git show HEAD^                                            # æ˜¾ç¤ºHEADçš„çˆ¶ï¼ˆä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼‰çš„æäº¤æ—¥å¿— ^^ä¸ºä¸Šä¸¤ä¸ªç‰ˆæœ¬ ^5ä¸ºä¸Š5ä¸ªç‰ˆæœ¬</span><br><span class="line">git tag                                                   # æ˜¾ç¤ºå·²å­˜åœ¨çš„tag</span><br><span class="line">git tag -a v2.0 -m &apos;xxx&apos;                                  # å¢åŠ v2.0çš„tag</span><br><span class="line">git show v2.0                                             # æ˜¾ç¤ºv2.0çš„æ—¥å¿—åŠè¯¦ç»†å†…å®¹</span><br><span class="line">git log v2.0                                              # æ˜¾ç¤ºv2.0çš„æ—¥å¿—</span><br><span class="line">git diff                                                  # æ˜¾ç¤ºæ‰€æœ‰æœªæ·»åŠ è‡³indexçš„å˜æ›´</span><br><span class="line">git diff --cached                                         # æ˜¾ç¤ºæ‰€æœ‰å·²æ·»åŠ indexä½†è¿˜æœªcommitçš„å˜æ›´</span><br><span class="line">git diff HEAD^                                            # æ¯”è¾ƒä¸ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„å·®å¼‚</span><br><span class="line">git diff HEAD -- ./lib                                    # æ¯”è¾ƒä¸HEADç‰ˆæœ¬libç›®å½•çš„å·®å¼‚</span><br><span class="line">git diff origin/master..master                            # æ¯”è¾ƒè¿œç¨‹åˆ†æ”¯masterä¸Šæœ‰æœ¬åœ°åˆ†æ”¯masterä¸Šæ²¡æœ‰çš„</span><br><span class="line">git diff origin/master..master --stat                     # åªæ˜¾ç¤ºå·®å¼‚çš„æ–‡ä»¶ï¼Œä¸æ˜¾ç¤ºå…·ä½“å†…å®¹</span><br><span class="line">git remote add origin git+ssh://git@192.168.53.168/VT.git # å¢åŠ è¿œç¨‹å®šä¹‰ï¼ˆç”¨äºpush/pull/fetchï¼‰</span><br><span class="line">git branch                                                # æ˜¾ç¤ºæœ¬åœ°åˆ†æ”¯</span><br><span class="line">git branch --contains 50089                               # æ˜¾ç¤ºåŒ…å«æäº¤50089çš„åˆ†æ”¯</span><br><span class="line">git branch -a                                             # æ˜¾ç¤ºæ‰€æœ‰åˆ†æ”¯</span><br><span class="line">git branch -r                                             # æ˜¾ç¤ºæ‰€æœ‰åŸåˆ›åˆ†æ”¯</span><br><span class="line">git branch --merged                                       # æ˜¾ç¤ºæ‰€æœ‰å·²åˆå¹¶åˆ°å½“å‰åˆ†æ”¯çš„åˆ†æ”¯</span><br><span class="line">git branch --no-merged                                    # æ˜¾ç¤ºæ‰€æœ‰æœªåˆå¹¶åˆ°å½“å‰åˆ†æ”¯çš„åˆ†æ”¯</span><br><span class="line">git branch -m master master_copy                          # æœ¬åœ°åˆ†æ”¯æ”¹å</span><br><span class="line">git checkout -b master_copy                               # ä»å½“å‰åˆ†æ”¯åˆ›å»ºæ–°åˆ†æ”¯master_copyå¹¶æ£€å‡º</span><br><span class="line">git checkout -b master master_copy                        # ä¸Šé¢çš„å®Œæ•´ç‰ˆ</span><br><span class="line">git checkout features/performance                         # æ£€å‡ºå·²å­˜åœ¨çš„features/performanceåˆ†æ”¯</span><br><span class="line">git checkout --track hotfixes/BJVEP933                    # æ£€å‡ºè¿œç¨‹åˆ†æ”¯hotfixes/BJVEP933å¹¶åˆ›å»ºæœ¬åœ°è·Ÿè¸ªåˆ†æ”¯</span><br><span class="line">git checkout v2.0                                         # æ£€å‡ºç‰ˆæœ¬v2.0</span><br><span class="line">git checkout -b devel origin/develop                      # ä»è¿œç¨‹åˆ†æ”¯developåˆ›å»ºæ–°æœ¬åœ°åˆ†æ”¯develå¹¶æ£€å‡º</span><br><span class="line">git checkout -- README                                    # æ£€å‡ºheadç‰ˆæœ¬çš„READMEæ–‡ä»¶ï¼ˆå¯ç”¨äºä¿®æ”¹é”™è¯¯å›é€€ï¼‰</span><br><span class="line">git merge origin/master                                   # åˆå¹¶è¿œç¨‹masteråˆ†æ”¯è‡³å½“å‰åˆ†æ”¯</span><br><span class="line">git cherry-pick ff44785404a8e                             # åˆå¹¶æäº¤ff44785404a8eçš„ä¿®æ”¹</span><br><span class="line">git push origin master                                    # å°†å½“å‰åˆ†æ”¯pushåˆ°è¿œç¨‹masteråˆ†æ”¯</span><br><span class="line">git push origin :hotfixes/BJVEP933                        # åˆ é™¤è¿œç¨‹ä»“åº“çš„hotfixes/BJVEP933åˆ†æ”¯</span><br><span class="line">git push --tags                                           # æŠŠæ‰€æœ‰tagæ¨é€åˆ°è¿œç¨‹ä»“åº“</span><br><span class="line">git fetch                                                 # è·å–æ‰€æœ‰è¿œç¨‹åˆ†æ”¯ï¼ˆä¸æ›´æ–°æœ¬åœ°åˆ†æ”¯ï¼Œå¦éœ€mergeï¼‰</span><br><span class="line">git fetch --prune                                         # è·å–æ‰€æœ‰åŸåˆ›åˆ†æ”¯å¹¶æ¸…é™¤æœåŠ¡å™¨ä¸Šå·²åˆ æ‰çš„åˆ†æ”¯</span><br><span class="line">git pull origin master                                    # è·å–è¿œç¨‹åˆ†æ”¯masterå¹¶mergeåˆ°å½“å‰åˆ†æ”¯</span><br><span class="line">git mv README README2                                     # é‡å‘½åæ–‡ä»¶READMEä¸ºREADME2</span><br><span class="line">git reset --hard HEAD                                     # å°†å½“å‰ç‰ˆæœ¬é‡ç½®ä¸ºHEADï¼ˆé€šå¸¸ç”¨äºmergeå¤±è´¥å›é€€ï¼‰</span><br><span class="line">git rebase</span><br><span class="line">git branch -d hotfixes/BJVEP933                           # åˆ é™¤åˆ†æ”¯hotfixes/BJVEP933ï¼ˆæœ¬åˆ†æ”¯ä¿®æ”¹å·²åˆå¹¶åˆ°å…¶ä»–åˆ†æ”¯ï¼‰</span><br><span class="line">git branch -D hotfixes/BJVEP933                           # å¼ºåˆ¶åˆ é™¤åˆ†æ”¯hotfixes/BJVEP933</span><br><span class="line">git ls-files                                              # åˆ—å‡ºgit indexåŒ…å«çš„æ–‡ä»¶</span><br><span class="line">git show-branch                                           # å›¾ç¤ºå½“å‰åˆ†æ”¯å†å²</span><br><span class="line">git show-branch --all                                     # å›¾ç¤ºæ‰€æœ‰åˆ†æ”¯å†å²</span><br><span class="line">git whatchanged                                           # æ˜¾ç¤ºæäº¤å†å²å¯¹åº”çš„æ–‡ä»¶ä¿®æ”¹</span><br><span class="line">git revert dfb02e6e4f2f7b573337763e5c0013802e392818       # æ’¤é”€æäº¤dfb02e6e4f2f7b573337763e5c0013802e392818</span><br><span class="line">git ls-tree HEAD                                          # å†…éƒ¨å‘½ä»¤ï¼šæ˜¾ç¤ºæŸä¸ªgitå¯¹è±¡</span><br><span class="line">git rev-parse v2.0                                        # å†…éƒ¨å‘½ä»¤ï¼šæ˜¾ç¤ºæŸä¸ªrefå¯¹äºçš„SHA1 HASH</span><br><span class="line">git reflog                                                # æ˜¾ç¤ºæ‰€æœ‰æäº¤ï¼ŒåŒ…æ‹¬å­¤ç«‹èŠ‚ç‚¹</span><br><span class="line">git show HEAD@&#123;5&#125;</span><br><span class="line">git show master@&#123;yesterday&#125;                               # æ˜¾ç¤ºmasteråˆ†æ”¯æ˜¨å¤©çš„çŠ¶æ€</span><br><span class="line">git log --pretty=format:&apos;%h %s&apos; --graph                   # å›¾ç¤ºæäº¤æ—¥å¿—</span><br><span class="line">git show HEAD~3</span><br><span class="line">git show -s --pretty=raw 2be7fcb476</span><br><span class="line">git stash                                                 # æš‚å­˜å½“å‰ä¿®æ”¹ï¼Œå°†æ‰€æœ‰è‡³ä¸ºHEADçŠ¶æ€</span><br><span class="line">git stash list                                            # æŸ¥çœ‹æ‰€æœ‰æš‚å­˜</span><br><span class="line">git stash show -p stash@&#123;0&#125;                               # å‚è€ƒç¬¬ä¸€æ¬¡æš‚å­˜</span><br><span class="line">git stash apply stash@&#123;0&#125;                                 # åº”ç”¨ç¬¬ä¸€æ¬¡æš‚å­˜</span><br><span class="line">git grep &quot;delete from&quot;                                    # æ–‡ä»¶ä¸­æœç´¢æ–‡æœ¬â€œdelete fromâ€</span><br><span class="line">git grep -e &apos;#define&apos; --and -e SORT_DIRENT</span><br><span class="line">git gc</span><br><span class="line">git fsck</span><br></pre></td></tr></table></figure>]]></content>
      
      <categories>
          
          <category> å·¥å…· </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linuxå·¥å…· </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>TCPå’ŒUDP</title>
      <link href="/2018/05/14/%E7%AC%94%E8%AE%B0/03UDP%E5%92%8CTCP/"/>
      <url>/2018/05/14/%E7%AC%94%E8%AE%B0/03UDP%E5%92%8CTCP/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>è¡¥ç <br>æ­£æ•°ï¼šä¸åŸç ç›¸åŒ<br>è´Ÿæ•°ï¼šå–å+1</p><p>æ ¡éªŒå’Œï¼š<br>æ‰€æœ‰æ•°ä¹‹å’Œï¼Œè¶…è¿‡0xffå³255ï¼Œå°±è¦æ±‚å…¶è¡¥ç ä½œä¸ºæ ¡éªŒå’Œï¼ˆå–ååŠ 1ï¼‰</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">int</span> a[<span class="number">8</span>]=&#123;<span class="number">0x01</span>,<span class="number">0x02</span>,<span class="number">0x03</span>,<span class="number">0x04</span>,<span class="number">0x05</span>,<span class="number">0x06</span>,<span class="number">0x07</span>,<span class="number">0x08</span>&#125;;</span><br><span class="line"> <span class="keyword">int</span> i,sum=<span class="number">0</span>;</span><br><span class="line"> <span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">8</span>;i++)</span><br><span class="line">     sum+=a[i];<span class="comment">//å°†æ¯ä¸ªæ•°ç›¸åŠ </span></span><br><span class="line">     <span class="keyword">if</span>(sum&gt;<span class="number">0xff</span>)</span><br><span class="line">     &#123;</span><br><span class="line">        sum=~sum;</span><br><span class="line">                  </span><br><span class="line">        sum+=<span class="number">1</span>;</span><br><span class="line"> </span><br><span class="line">                 </span><br><span class="line">ã€€        &#125;</span><br><span class="line"> sum=sum&amp;<span class="number">0xff</span>; </span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"0x%x\n"</span>,sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="1ã€UDP"><a href="#1ã€UDP" class="headerlink" title="1ã€UDP"></a>1ã€UDP</h1><h2 id="1-1-ç®€ä»‹"><a href="#1-1-ç®€ä»‹" class="headerlink" title="1.1 ç®€ä»‹"></a>1.1 ç®€ä»‹</h2><p>UDPæ•°æ®æŠ¥å°è£…æˆä¸€ä»½IPæ•°æ®æŠ¥æ ¼å¼å¦‚å›¾<br>IPé¦–éƒ¨ï¼ˆ20å­—èŠ‚ï¼‰-UDPé¦–éƒ¨ï¼ˆ8å­—èŠ‚ï¼‰-UDPæ•°æ® ï¼ˆIPæ•°æ®æŠ¥ï¼‰<br>åº”ç”¨ç¨‹åºå¿…é¡»å…³å¿ƒIPæ•°æ®æŠ¥é•¿åº¦ã€‚å¦‚æœè¶…è¿‡ç½‘ç»œçš„MTUï¼Œé‚£ä¹ˆä¹…è¦å¯¹IPæ•°æ®åŒ…è¿›è¡Œåˆ†ç‰‡ã€‚</p><h2 id="1-2-UDPé¦–éƒ¨ï¼ˆ8å­—èŠ‚ï¼‰"><a href="#1-2-UDPé¦–éƒ¨ï¼ˆ8å­—èŠ‚ï¼‰" class="headerlink" title="1.2 UDPé¦–éƒ¨ï¼ˆ8å­—èŠ‚ï¼‰"></a>1.2 UDPé¦–éƒ¨ï¼ˆ8å­—èŠ‚ï¼‰</h2><p>16ä½æºç«¯å£å· 16ç›®çš„ç«¯å£å·  ï¼ˆ4å­—èŠ‚ï¼‰<br>16ä½UDPé•¿åº¦  16ä½UDPæ ¡éªŒå’Œ ï¼ˆ4å­—èŠ‚ï¼‰<br>æ•°æ®</p><p>UDPé•¿åº¦æŒ‡ï¼šUDPé¦–éƒ¨å’ŒUDPæ•°æ®çš„å­—èŠ‚é•¿åº¦</p><h2 id="1-3-UDPæ ¡éªŒå’Œ"><a href="#1-3-UDPæ ¡éªŒå’Œ" class="headerlink" title="1.3 UDPæ ¡éªŒå’Œ"></a>1.3 UDPæ ¡éªŒå’Œ</h2><p>UDPæ ¡éªŒå’Œè¦†ç›–UDPé¦–éƒ¨å’ŒUDPæ•°æ®ã€‚UDPå’ŒTCPåœ¨æ‰‹ä¸ä¸­éƒ½æœ‰è¦†ç›–å®ƒä»¬é¦–éƒ¨å’Œæ•°æ®çš„æ ¡éªŒå’Œã€‚UDPçš„æ ¡éªŒå’Œæ˜¯<code>å¯é€‰çš„</code>ã€‚TCPçš„æ ¡éªŒå’Œæ˜¯<code>å¿…éœ€çš„</code>ã€‚</p><p>UDPæ ¡éªŒå’Œä¸åŒä¹‹å¤„ï¼š1ã€UDPæ•°æ®æŠ¥çš„é•¿åº¦å¯ä»¥ä¸ºå¥‡æ•°å­—èŠ‚ï¼Œä½†æ˜¯æ ¡éªŒå’Œç®—æ³•æ˜¯æŠŠå¦‚å¹²ä¸ª16bitå­—èŠ‚ç›¸åŠ ã€‚è§£å†³æ–¹æ³•æ˜¯å¿…é¡»æ—¶åœ¨æœ€åå¢åŠ å¡«å……å­—èŠ‚0ï¼Œè¿™æ˜¯ä¸ºäº†æ ¡éªŒå’Œçš„è®¡ç®—ã€‚<br>2ã€UDPæ•°æ®æŠ¥å’ŒTCPæ®µéƒ½åŒ…å«ä¸€ä¸ª12å­—èŠ‚é•¿çš„ä¼ªé¦–éƒ¨ï¼Œå®ƒæ˜¯ä¸ºäº†è®¡ç®—æ ¡éªŒå’Œè€Œè®¾ç½®çš„ã€‚ä¼ªé¦–éƒ¨åŒ…å«IPé¦–éƒ¨çš„ä¸€äº›å­—æ®µã€‚å™¨ç›®çš„æ˜¯è®©UDPä¸¤æ¬¡æ£€æŸ¥æ•°æ®æ˜¯å¦å·²ç»æ­£ç¡®åˆ°è¾¾ç›®çš„åœ°ã€‚</p><p>UDPä¼ªé¦–éƒ¨ï¼š<br>32ä½æºIPåœ°å€<br>32ä½ç›®çš„IPåœ°å€   </p><p>UDPæ ¡éªŒå’Œæ˜¯ä¸€ä¸ªç«¯åˆ°ç«¯çš„æ ¡éªŒå’Œã€‚å®ƒç”±å‘é€ç«¯è®¡ç®—ï¼Œç„¶åç”±æ¥æ”¶ç«¯éªŒè¯ã€‚å…¶ç›®çš„æ˜¯ä¸ºäº†å‘ç°UDPé¦–éƒ¨å’Œæ•°æ®åœ¨å‘é€ç«¯å’Œæ¥æ”¶ç«¯ä¹‹é—´å‘ç”Ÿçš„ä»»ä½•æ”¹åŠ¨ã€‚</p><p>æ¥æ”¶æ–¹å’Œå‘é€æ–¹ï¼Œä¼ªé¦–éƒ¨ä¸­ï¼ŒæºIPåœ°å€å’Œç›®çš„IPäº¤æ¢ï¼Œä¼ªé¦–éƒ¨å’ŒUDPé¦–éƒ¨ä¸­çš„å…¶ä»–å­—æ®µéƒ½æ˜¯ç›¸åŒçš„ï¼Œå°±åƒæ•°æ®å›æ˜¾ä¸€æ ·ã€‚ç„¶è€ŒUDPæ ¡éªŒå’Œï¼ˆäº‹å®ä¸Šï¼ŒTCP/IPåè®®ç°‡ä¸­çš„æ‰€æœ‰æ ¡éªŒå’Œï¼‰æ˜¯ç®€å•çš„16bitå’Œã€‚å®ƒä»¬æ£€æµ‹ä¸å‡ºäº¤æ¢ä¸¤ä¸ª16bitçš„å·®é”™ã€‚</p><p>æ ¹æ®ä¸€äº›æ•°æ®ç»Ÿè®¡ï¼šTCPå‘ç”Ÿçš„æ ¡éªŒå’Œå·®é”™çš„æ¯”ä¾‹æ¯”UDPç›¸å¯¹è¦é«˜å¾—å¤šï¼Œå¯èƒ½åŸå› æ˜¯å› ä¸ºè¯¥ç³»ç»Ÿä¸­çš„TCPè¿æ¥ç»å¸¸æ˜¯â€œè¿œç¨‹â€è¿æ¥ï¼ˆç»è¿‡è®¸å¤šè·¯ç”±å™¨å’Œç½‘æ¡¥ç­‰ä¸­é—´è®¾å¤‡ï¼‰ï¼Œè€ŒUDPä¸€èˆ¬ä¸º<code>æœ¬åœ°é€šä¿¡</code>ã€‚</p><h2 id="11-5-IPåˆ†ç‰‡"><a href="#11-5-IPåˆ†ç‰‡" class="headerlink" title="11.5 IPåˆ†ç‰‡"></a>11.5 IPåˆ†ç‰‡</h2><p>ç‰©ç†ç½‘ç»œå±‚ä¸€èˆ¬è¦é™åˆ¶æ¯æ¬¡å‘é€æ•°æ®å¸§çš„æœ€å¤§é•¿åº¦ã€‚ä»»ä½•æ—¶å€™IPå±‚æ¥æ”¶åˆ°ä¸€ä»½è¦å‘é€çš„IPæ•°æ®æŠ¥æ—¶ï¼Œå®ƒè¦åˆ¤æ–­å‘æœ¬åœ°å“ªä¸ªæ¥å£å‘é€æ•°æ®ï¼ˆé€‰è·¯ï¼‰ï¼Œå¹¶æŸ¥è¯¢è¯¥æ¥å£è·å¾—å…¶MTUã€‚IPæŠŠMTUä¸æ•°æ®æŠ¥é•¿åº¦è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœéœ€è¦åˆ™è¿›è¡Œåˆ†ç‰‡ã€‚åˆ†ç‰‡å¯ä»¥å‘ç”Ÿåœ¨åŸå§‹å‘é€ç«¯ä¸»æœºä¸Šï¼Œä¹Ÿå¯ä»¥å‘ç”Ÿåœ¨ä¸­é—´è·¯ç”±å™¨ä¸Šã€‚</p><p>æŠŠä¸€ä»½IPæ•°æ®æŠ¥åˆ†ç‰‡åï¼Œä¹‹ååˆ°è¾¾ç›®çš„åœ°æ‰è¿›è¡Œé‡æ–°ç»„è£…ï¼ˆè¿™é‡Œçš„é‡æ–°ç»„è£…ä¸å…¶ä»–ç½‘ç»œåè®®ä¸åŒï¼Œå®ƒä»¬è¦å°±åœ¨ä¸‹ä¸€ç«™å°±è¿›è¡Œé‡æ–°ç»„è£…ï¼Œè€Œä¸æ˜¯åœ¨æœ€ç»ˆç›®çš„åœ°ï¼‰ã€‚é‡æ–°ç»„è£…ç”±ç›®çš„ç«¯çš„IPå±‚æ¥å®Œæˆã€‚å…¶ç›®çš„æ˜¯ä½¿åˆ†ç‰‡å’Œé‡æ–°ç»„è£…çš„è¿‡ç¨‹å¯¹è¿è¾“å±‚ï¼ˆTCPå’ŒUDPï¼‰æ˜¯é€æ˜çš„ã€‚å·²ç»åˆ†ç‰‡è¿‡çš„æ•°æ®æŠ¥æœ‰å¯èƒ½ä¼šå†æ¬¡åˆ†ç‰‡ï¼ˆå¯èƒ½ä¸æ­¢ä¸€æ¬¡ï¼‰ã€‚IPé¦–éƒ¨ä¸­åŒ…å«çš„æ•°æ®ä¸ºåˆ†ç‰‡å’Œé‡ç»„æä¾›äº†è¶³å¤Ÿçš„ä¿¡æ¯ã€‚</p><p>å¯¹äºå‘é€ç«¯å‘é€çš„æ¯ä»½IPæ•°æ®æŠ¥æ¥è¯´ï¼Œå…¶æ ‡è¯†å­—æ®µéƒ½åŒ…å«ä¸€ä¸ªä¸ºæŠ‘åˆ¶ã€‚è¯¥å€¼åœ¨æ•°æ®æŠ¥åˆ†ç‰‡æ—¶è¢«å¤åˆ¶åˆ°æ¯ä¸ªç‰‡ä¸­ã€‚æ ‡è¯†å­—æ®µç”¨å…¶ä¸­ä¸€ä¸ªbitæ¥è¡¨ç¤ºâ€œæ›´å¤šçš„ç‰‡â€ã€‚é™¤äº†æœ€åä¸€ç‰‡å¤–ï¼Œå…¶ä»–æ¯ä¸ªç»„æˆæ•°æ®æŠ¥çš„ç‰‡éƒ½è¦æŠŠè¯¥bitç½®1ã€‚</p><p>åˆ†ç‰‡ä¸¾ä¾‹ï¼š<br>IPé¦–éƒ¨(20å­—èŠ‚)  UDPé¦–éƒ¨(8å­—èŠ‚)  UDPæ•°æ®(1473å­—èŠ‚)<br>åˆ†æ®µ<br>IPé¦–éƒ¨(20å­—èŠ‚) UDPé¦–éƒ¨(8å­—èŠ‚)  (1472å­—èŠ‚)  IPé¦–éƒ¨(20å­—èŠ‚)(1å­—èŠ‚)</p><p>æ³¨ï¼šIPé¦–éƒ¨(20å­—èŠ‚) UDPé¦–éƒ¨(8å­—èŠ‚)  (1472å­—èŠ‚) åˆ†ç»„<br>    IPé¦–éƒ¨(20å­—èŠ‚)(1å­—èŠ‚) åˆ†ç»„</p><h2 id="11-6-ICMPä¸å¯è¾¾å·®é”™ï¼ˆéœ€åˆ†ç‰‡ï¼‰"><a href="#11-6-ICMPä¸å¯è¾¾å·®é”™ï¼ˆéœ€åˆ†ç‰‡ï¼‰" class="headerlink" title="11.6 ICMPä¸å¯è¾¾å·®é”™ï¼ˆéœ€åˆ†ç‰‡ï¼‰"></a>11.6 ICMPä¸å¯è¾¾å·®é”™ï¼ˆéœ€åˆ†ç‰‡ï¼‰</h2><p>å‘é€ICMPä¸å¯è¾¾å·®é”™çš„å¦ä¸€ç§æƒ…å†µæ˜¯ï¼Œå½“è·¯ç”±å™¨æ”¶åˆ°ä¸€ä»½éœ€è¦åˆ†ç‰‡çš„æ•°æ®æŠ¥ï¼Œè€Œåœ¨IPé¦–éƒ¨åˆè®¾ç½®ä¸åˆ†ç‰‡ï¼ˆDFï¼‰çš„æ ‡å¿—æ¯”ç‰¹ï¼Œå¦‚æœæŸä¸ªç¨‹åºéœ€è¦åˆ¤æ–­åˆ°è¾¾ç›®çš„ç«¯çš„è·¯é€”ä¸­æœ€å°MTUæ˜¯å¤šå°‘ï¼Œç§°ä½œè·¯å¾„MTUå‘ç°æœºåˆ¶ï¼Œé‚£ä¹ˆè¿™ä¸ªå·®é”™å°±å¯ä»¥è¢«æ”¹ç¨‹åºä½¿ç”¨ã€‚</p><p>è¿™ç§æƒ…å†µçš„ICMPæŠ¥æ–‡æ ¼å¼å¦‚å›¾</p><table><thead><tr><th align="center">0-7</th><th align="center">8-15</th><th align="center">16-32</th></tr></thead><tbody><tr><td align="center">ç±»å‹(3)</td><td align="center">ä»£ç (4)</td><td align="center">æ ¡éªŒå’Œ()</td></tr><tr><td align="center">æœªç”¨(å¿…é¡»ä¸º0)()())()()(()()()()</td><td align="center"></td><td align="center"></td></tr></tbody></table>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç½‘ç»œ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>Netfilteræºä»£ç åˆ†æè¯¦è§£</title>
      <link href="/2018/05/14/%E7%AC%94%E8%AE%B0/06Netfilter%20Code%E5%88%86%E6%9E%90/"/>
      <url>/2018/05/14/%E7%AC%94%E8%AE%B0/06Netfilter%20Code%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><div class="menu"></div><h2 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a><strong>ä¸€ã€æ¦‚è¿°</strong></h2><h3 id="1-Netfilter-IPTablesæ¡†æ¶ç®€ä»‹"><a href="#1-Netfilter-IPTablesæ¡†æ¶ç®€ä»‹" class="headerlink" title="1. Netfilter/IPTablesæ¡†æ¶ç®€ä»‹"></a><strong>1. Netfilter/IPTablesæ¡†æ¶ç®€ä»‹</strong></h3><p>ã€€ã€€Netfilter/IPTablesæ˜¯ç»§2.0.xçš„IPfwadmã€2.2.xçš„IPchainsä¹‹åï¼Œæ–°ä¸€ä»£çš„Linuxé˜²ç«å¢™æœºåˆ¶ã€‚Netfilteré‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œå…·æœ‰è‰¯å¥½çš„å¯æ‰©å……æ€§ã€‚å…¶é‡è¦å·¥å…·æ¨¡å—IPTablesè¿æ¥åˆ°Netfilterçš„æ¶æ„ä¸­ï¼Œå¹¶å…è®¸ä½¿ç”¨è€…å¯¹æ•°æ®æŠ¥è¿›è¡Œè¿‡æ»¤ã€åœ°å€è½¬æ¢ã€å¤„ç†ç­‰æ“ä½œã€‚<br>ã€€ã€€Netfilteræä¾›äº†ä¸€ä¸ªæ¡†æ¶ï¼Œå°†å¯¹ç½‘ç»œä»£ç çš„ç›´æ¥å¹²æ¶‰é™åˆ°æœ€ä½ï¼Œå¹¶å…è®¸ç”¨è§„å®šçš„æ¥å£å°†å…¶ä»–åŒ…å¤„ç†ä»£ç ä»¥æ¨¡å—çš„å½¢å¼æ·»åŠ åˆ°å†…æ ¸ä¸­ï¼Œå…·æœ‰æå¼ºçš„çµæ´»æ€§ã€‚</p><h3 id="2-ä¸»è¦æºä»£ç æ–‡ä»¶"><a href="#2-ä¸»è¦æºä»£ç æ–‡ä»¶" class="headerlink" title="2. ä¸»è¦æºä»£ç æ–‡ä»¶"></a><strong>2. ä¸»è¦æºä»£ç æ–‡ä»¶</strong></h3><ul><li>linuxå†…æ ¸ç‰ˆæœ¬ï¼š<code>2.4.21</code></li><li>Netfilterä¸»æ–‡ä»¶ï¼š<code>net/core/netfilter.c</code></li><li>Netfilterå¤´æ–‡ä»¶ï¼š<code>include/linux/netfilter.h</code></li><li>IPv4ç›¸å…³ï¼š   <ul><li>cæ–‡ä»¶ï¼š<code>net/ipv4/netfilter/*.c</code></li><li>å¤´æ–‡ä»¶ï¼š<code>include/linux/netfilter_ipv4.h</code>  , <code>include/linux/netfilter_ipv4/*.h</code></li></ul></li><li>IPv4åè®®æ ˆä¸»ä½“çš„éƒ¨åˆ†cæ–‡ä»¶ï¼Œç‰¹åˆ«æ˜¯ä¸æ•°æ®æŠ¥ä¼ é€è¿‡ç¨‹æœ‰å…³çš„éƒ¨åˆ†:<ul><li><code>ip_input.c</code>,<code>ip_forward.c</code>,<code>ip_output.c</code>,<code>ip_fragment.c</code>ç­‰</li></ul></li></ul><h2 id="äºŒã€Netfilter-IPTables-IPv4æ€»ä½“æ¶æ„"><a href="#äºŒã€Netfilter-IPTables-IPv4æ€»ä½“æ¶æ„" class="headerlink" title="äºŒã€Netfilter/IPTables-IPv4æ€»ä½“æ¶æ„"></a>äºŒã€Netfilter/IPTables-IPv4æ€»ä½“æ¶æ„</h2><p>ã€€ã€€Netfilterä¸»è¦é€šè¿‡è¡¨ã€é“¾å®ç°è§„åˆ™ï¼Œå¯ä»¥è¿™ä¹ˆè¯´ï¼ŒNetfilteræ˜¯è¡¨çš„å®¹å™¨ï¼Œè¡¨æ˜¯é“¾çš„å®¹å™¨ï¼Œé“¾æ˜¯è§„åˆ™çš„å®¹å™¨ï¼Œæœ€ç»ˆå½¢æˆå¯¹æ•°æ®æŠ¥å¤„ç†è§„åˆ™çš„å®ç°ã€‚<br>ã€€ã€€è¯¦ç»†åœ°è¯´ï¼ŒNetfilter/IPTablesçš„ä½“ç³»ç»“æ„å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªå¤§éƒ¨åˆ†ï¼š</p><h3 id="1-Netfilterçš„HOOKæœºåˆ¶"><a href="#1-Netfilterçš„HOOKæœºåˆ¶" class="headerlink" title="1. Netfilterçš„HOOKæœºåˆ¶"></a><strong>1. Netfilterçš„HOOKæœºåˆ¶</strong></h3><p>ã€€ã€€Netfilterçš„é€šç”¨æ¡†æ¶ä¸ä¾èµ–äºå…·ä½“çš„åè®®ï¼Œè€Œæ˜¯ä¸ºæ¯ç§ç½‘ç»œåè®®å®šä¹‰ä¸€å¥—HOOKå‡½æ•°ã€‚è¿™äº›HOOKå‡½æ•°åœ¨æ•°æ®æŠ¥ç»è¿‡åè®®æ ˆçš„å‡ ä¸ªå…³é”®ç‚¹æ—¶è¢«è°ƒç”¨ï¼Œåœ¨è¿™å‡ ä¸ªç‚¹ä¸­ï¼Œåè®®æ ˆå°†æ•°æ®æŠ¥åŠHOOKå‡½æ•°æ ‡å·ä½œä¸ºå‚æ•°ï¼Œä¼ é€’ç»™Netfilteræ¡†æ¶ã€‚</p><p>ã€€ã€€å¯¹äºå®ƒåœ¨ç½‘ç»œå †æ ˆä¸­å¢åŠ çš„è¿™äº›HOOKï¼Œå†…æ ¸çš„ä»»ä½•æ¨¡å—å¯ä»¥å¯¹æ¯ç§åè®®çš„ä¸€ä¸ªæˆ–å¤šä¸ªHOOKè¿›è¡Œæ³¨å†Œï¼Œå®ç°æŒ‚æ¥ã€‚è¿™æ ·å½“æŸä¸ªæ•°æ®æŠ¥è¢«ä¼ é€’ç»™Netfilteræ¡†æ¶æ—¶ï¼Œå†…æ ¸èƒ½æ£€æµ‹åˆ°æ˜¯å¦æœ‰ä»»ä½•æ¨¡å—å¯¹è¯¥åè®®å’ŒHOOKå‡½æ•°è¿›è¡Œäº†æ³¨å†Œã€‚è‹¥æ³¨å†Œäº†ï¼Œåˆ™è°ƒç”¨è¯¥æ¨¡å—çš„æ³¨å†Œæ—¶ä½¿ç”¨çš„å›è°ƒå‡½æ•°ï¼Œè¿™æ ·è¿™äº›æ¨¡å—å°±æœ‰æœºä¼šæ£€æŸ¥ã€ä¿®æ”¹ã€ä¸¢å¼ƒè¯¥æ•°æ®æŠ¥åŠæŒ‡ç¤ºNetfilterå°†è¯¥æ•°æ®æŠ¥ä¼ å…¥ç”¨æˆ·ç©ºé—´çš„é˜Ÿåˆ—ã€‚</p><p>ã€€ã€€è¿™æ ·ï¼ŒHOOKæä¾›äº†ä¸€ç§æ–¹ä¾¿çš„æœºåˆ¶ï¼šåœ¨æ•°æ®æŠ¥é€šè¿‡Linuxå†…æ ¸çš„ä¸åŒä½ç½®ä¸Šæˆªè·å’Œæ“ä½œå¤„ç†æ•°æ®æŠ¥ã€‚</p><h3 id="2-iptablesåŸºç¡€æ¨¡å—"><a href="#2-iptablesåŸºç¡€æ¨¡å—" class="headerlink" title="2.iptablesåŸºç¡€æ¨¡å—"></a><strong>2.iptablesåŸºç¡€æ¨¡å—</strong></h3><p>ã€€ã€€iptablesåŸºç¡€æ¨¡å—å®ç°äº†ä¸‰ä¸ªè¡¨æ¥ç­›é€‰å„ç§æ•°æ®æŠ¥ï¼Œå…·ä½“åœ°è®²ï¼ŒLinux2.4å†…æ ¸æä¾›çš„è¿™ä¸‰ç§æ•°æ®æŠ¥çš„å¤„ç†åŠŸèƒ½æ˜¯ç›¸äº’é—´ç‹¬ç«‹çš„æ¨¡å—ï¼Œéƒ½åŸºäºNetfilterçš„HOOKå‡½æ•°å’Œå„ç§è¡¨ã€é“¾å®ç°ã€‚è¿™ä¸‰ä¸ªè¡¨åŒ…æ‹¬ï¼šfilterè¡¨ï¼Œnatè¡¨ä»¥åŠmangleè¡¨ã€‚</p><h3 id="3-å…·ä½“åŠŸèƒ½æ¨¡å—"><a href="#3-å…·ä½“åŠŸèƒ½æ¨¡å—" class="headerlink" title="3.å…·ä½“åŠŸèƒ½æ¨¡å—"></a><strong>3.å…·ä½“åŠŸèƒ½æ¨¡å—</strong></h3><ol><li>æ•°æ®æŠ¥è¿‡æ»¤æ¨¡å—</li><li>è¿æ¥è·Ÿè¸ªæ¨¡å—ï¼ˆConntrackï¼‰</li><li>ç½‘ç»œåœ°å€è½¬æ¢æ¨¡å—ï¼ˆNATï¼‰</li><li>æ•°æ®æŠ¥ä¿®æ”¹æ¨¡å—ï¼ˆmangleï¼‰</li><li>å…¶å®ƒé«˜çº§åŠŸèƒ½æ¨¡å—</li></ol><p>äºæ˜¯ï¼ŒNetfilter/IPTablesæ€»ä½“æ¶æ„å¦‚ä¸‹å›¾1æ‰€ç¤ºï¼š</p><div align="center"><p><img src="/img/note_06/01.jpg" alt="Netfilter/Iptables-Ipv4æ€»ä½“æ¶æ„"></p></div><h2 id="ä¸‰ã€HOOKçš„å®ç°"><a href="#ä¸‰ã€HOOKçš„å®ç°" class="headerlink" title="ä¸‰ã€HOOKçš„å®ç°"></a>ä¸‰ã€HOOKçš„å®ç°</h2><h3 id="1-Netfilter-IPv4ä¸­çš„HOOK"><a href="#1-Netfilter-IPv4ä¸­çš„HOOK" class="headerlink" title="1.Netfilter-IPv4ä¸­çš„HOOK"></a><strong>1.Netfilter-IPv4ä¸­çš„HOOK</strong></h3><p>ã€€ã€€Netfilteræ¨¡å—éœ€è¦ä½¿ç”¨HOOKæ¥å¯ç”¨å‡½æ•°çš„åŠ¨æ€é’©æ¥ï¼Œå®ƒåœ¨IPv4ä¸­å®šä¹‰äº†äº”ä¸ªHOOKï¼ˆä½äºæ–‡ä»¶include/linux/netfilter_ipv4.hï¼ŒLine 39ï¼‰ï¼Œåˆ†åˆ«å¯¹åº”0-4çš„hooknumï¼Œç®€å•åœ°è¯´ï¼Œæ•°æ®æŠ¥ç»è¿‡å„ä¸ªHOOKçš„æµç¨‹å¦‚ä¸‹ï¼š<br>ã€€ã€€æ•°æ®æŠ¥ä»è¿›å…¥ç³»ç»Ÿï¼Œè¿›è¡ŒIPæ ¡éªŒä»¥åï¼Œé¦–å…ˆç»è¿‡ç¬¬ä¸€ä¸ªHOOKå‡½æ•°NF_IP_PRE_ROUTINGè¿›è¡Œå¤„ç†ï¼›ç„¶åå°±è¿›å…¥è·¯ç”±ä»£ç ï¼Œå…¶å†³å®šè¯¥æ•°æ®æŠ¥æ˜¯éœ€è¦è½¬å‘è¿˜æ˜¯å‘ç»™æœ¬æœºçš„ï¼›è‹¥è¯¥æ•°æ®æŠ¥æ˜¯å‘è¢«æœ¬æœºçš„ï¼Œåˆ™è¯¥æ•°æ®ç»è¿‡HOOKå‡½æ•°NF_IP_LOCAL_INå¤„ç†ä»¥åç„¶åä¼ é€’ç»™ä¸Šå±‚åè®®ï¼›è‹¥è¯¥æ•°æ®æŠ¥åº”è¯¥è¢«è½¬å‘åˆ™å®ƒè¢«NF_IP_FORWARDå¤„ç†ï¼›ç»è¿‡è½¬å‘çš„æ•°æ®æŠ¥ç»è¿‡æœ€åä¸€ä¸ªHOOKå‡½æ•°NF_IP_POST_ROUTINGå¤„ç†ä»¥åï¼Œå†ä¼ è¾“åˆ°ç½‘ç»œä¸Šã€‚æœ¬åœ°äº§ç”Ÿçš„æ•°æ®ç»è¿‡HOOKå‡½æ•°NF_IP_LOCAL_OUT å¤„ç†åï¼Œè¿›è¡Œè·¯ç”±é€‰æ‹©å¤„ç†ï¼Œç„¶åç»è¿‡NF_IP_POST_ROUTINGå¤„ç†åå‘é€å‡ºå»ã€‚<br>ã€€ã€€æ€»ä¹‹ï¼Œè¿™äº”ä¸ªHOOKæ‰€ç»„æˆçš„Netfilter-IPv4æ•°æ®æŠ¥ç­›é€‰ä½“ç³»å¦‚å›¾ï¼šï¼ˆæ³¨ï¼šä¸‹é¢æ‰€è¯´Netfilter/IPTableså‡åŸºäºIPv4ï¼Œä¸å†èµ˜è¿°ï¼‰</p><div align="center"><p><img src="/img/note_06/02.jpg" alt="æ•°æ®æŠ¥ç­›é€‰ä½“ç³»"></p></div><p>è¯¦ç»†åœ°è¯´ï¼Œå„ä¸ªHOOKåŠå…¶åœ¨IPæ•°æ®æŠ¥ä¼ é€’ä¸­çš„å…·ä½“ä½ç½®å¦‚å›¾ï¼š</p><div align="center"><p><img src="/img/note_06/03.jpg" alt="æ•°æ®æŠ¥ç­›é€‰ä½“ç³»ï¼ˆè¯¦ï¼‰"></p></div><ul><li><p><em>NF_IP_PRE_ROUTING (0)</em><br>æ•°æ®æŠ¥åœ¨è¿›å…¥è·¯ç”±ä»£ç è¢«å¤„ç†ä¹‹å‰ï¼Œæ•°æ®æŠ¥åœ¨IPæ•°æ®æŠ¥æ¥æ”¶å‡½æ•°ip_rcv()ï¼ˆä½äºnet/ipv4/ip_input.cï¼ŒLine379ï¼‰çš„æœ€åï¼Œä¹Ÿå°±æ˜¯åœ¨ä¼ å…¥çš„æ•°æ®æŠ¥è¢«å¤„ç†ä¹‹å‰ç»è¿‡è¿™ä¸ªHOOKã€‚åœ¨ip_rcv()ä¸­æŒ‚æ¥è¿™ä¸ªHOOKä¹‹å‰ï¼Œè¿›è¡Œçš„æ˜¯ä¸€äº›ä¸ç±»å‹ã€é•¿åº¦ã€ç‰ˆæœ¬æœ‰å…³çš„æ£€æŸ¥ã€‚<br>ç»è¿‡è¿™ä¸ªHOOKå¤„ç†ä¹‹åï¼Œæ•°æ®æŠ¥è¿›å…¥ip_rcv_finish()ï¼ˆä½äºnet/ipv4/ip_input.cï¼ŒLine306ï¼‰ï¼Œè¿›è¡ŒæŸ¥è·¯ç”±è¡¨çš„å·¥ä½œï¼Œå¹¶åˆ¤æ–­è¯¥æ•°æ®æŠ¥æ˜¯å‘ç»™æœ¬åœ°æœºå™¨è¿˜æ˜¯è¿›è¡Œè½¬å‘ã€‚<br>åœ¨è¿™ä¸ªHOOKä¸Šä¸»è¦æ˜¯å¯¹æ•°æ®æŠ¥ä½œæŠ¥å¤´æ£€æµ‹å¤„ç†ï¼Œä»¥æ•è·å¼‚å¸¸æƒ…å†µã€‚<br>æ¶‰åŠåŠŸèƒ½ï¼ˆä¼˜å…ˆçº§é¡ºåºï¼‰ï¼šConntrack(-200)ã€mangle(-150)ã€DNAT(-100)</p></li><li><p><em>NF_IP_LOCAL_IN (1)</em><br>ç›®çš„åœ°ä¸ºæœ¬åœ°ä¸»æœºçš„æ•°æ®æŠ¥åœ¨IPæ•°æ®æŠ¥æœ¬åœ°æŠ•é€’å‡½æ•°ip_local_deliver()ï¼ˆä½äºnet/ipv4/ip_input.cï¼ŒLine290ï¼‰çš„æœ€åç»è¿‡è¿™ä¸ªHOOKã€‚<br>ç»è¿‡è¿™ä¸ªHOOKå¤„ç†ä¹‹åï¼Œæ•°æ®æŠ¥è¿›å…¥ip_local_deliver_finish()ï¼ˆä½äºnet/ipv4/ip_input.cï¼ŒLine219ï¼‰ã€‚<br>è¿™æ ·ï¼Œiptablesæ¨¡å—å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªHOOKå¯¹åº”çš„INPUTè§„åˆ™é“¾è¡¨æ¥å¯¹æ•°æ®æŠ¥è¿›è¡Œè§„åˆ™åŒ¹é…çš„ç­›é€‰äº†ã€‚é˜²ç«å¢™ä¸€èˆ¬å»ºç«‹åœ¨è¿™ä¸ªHOOKä¸Šã€‚<br>æ¶‰åŠåŠŸèƒ½ï¼šmangle(-150)ã€filter(0)ã€SNAT(100)ã€Conntrack(INT_MAX-1)</p></li><li><p><em>NF_IP_FORWARD (2)</em><br>ç›®çš„åœ°éæœ¬åœ°ä¸»æœºçš„æ•°æ®æŠ¥ï¼ŒåŒ…æ‹¬è¢«NATä¿®æ”¹è¿‡åœ°å€çš„æ•°æ®æŠ¥ï¼Œéƒ½è¦åœ¨IPæ•°æ®æŠ¥è½¬å‘å‡½æ•°ip_forward()ï¼ˆä½äºnet/ipv4/ip_forward.cï¼ŒLine73ï¼‰çš„æœ€åç»è¿‡è¿™ä¸ªHOOKã€‚<br>ç»è¿‡è¿™ä¸ªHOOKå¤„ç†ä¹‹åï¼Œæ•°æ®æŠ¥è¿›å…¥ip_forward_finish()ï¼ˆä½äºnet/ipv4/ip_forward.cï¼ŒLine44ï¼‰<br>å¦å¤–ï¼Œåœ¨net/ipv4/ipmr.cä¸­çš„ipmr_queue_xmit()å‡½æ•°ï¼ˆLine1119ï¼‰æœ€åä¹Ÿä¼šç»è¿‡è¿™ä¸ªHOOKã€‚ï¼ˆipmrä¸ºå¤šæ’­ç›¸å…³ï¼Œä¼°è®¡æ˜¯åœ¨éœ€è¦é€šè¿‡è·¯ç”±è½¬å‘å¤šæ’­æ•°æ®æ—¶çš„å¤„ç†ï¼‰ã€‚<br>è¿™æ ·ï¼ŒIPTablesæ¨¡å—å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªHOOKå¯¹åº”çš„FORWARDè§„åˆ™é“¾è¡¨æ¥å¯¹æ•°æ®æŠ¥è¿›è¡Œè§„åˆ™åŒ¹é…çš„ç­›é€‰äº†ã€‚<br>æ¶‰åŠåŠŸèƒ½ï¼šmangle(-150)ã€filter(0)</p></li><li><p><em>NF_IP_LOCAL_OUT (3)</em><br>æœ¬åœ°ä¸»æœºå‘å‡ºçš„æ•°æ®æŠ¥åœ¨IPæ•°æ®æŠ¥æ„å»º/å‘é€å‡½æ•°ip_queue_xmit()ï¼ˆä½äºnet/ipv4/ip_output.cï¼ŒLine339ï¼‰ã€ä»¥åŠip_build_and_send_pkt()ï¼ˆä½äºnet/ipv4/ip_output.cï¼ŒLine122ï¼‰çš„æœ€åç»è¿‡è¿™ä¸ªHOOKã€‚ï¼ˆåœ¨æ•°æ®æŠ¥å¤„ç†ä¸­ï¼Œå‰è€…æœ€ä¸ºå¸¸ç”¨ï¼Œåè€…ç”¨äºé‚£äº›ä¸ä¼ è¾“æœ‰æ•ˆæ•°æ®çš„SYN/ACKåŒ…ï¼‰ã€‚<br>ç»è¿‡è¿™ä¸ªHOOKå¤„ç†åï¼Œæ•°æ®æŠ¥è¿›å…¥ip_queue_xmit2()ï¼ˆä½äºnet/ipv4/ip_output.cï¼ŒLine281ï¼‰ã€‚<br>å¦å¤–ï¼Œåœ¨ip_build_xmit_slow()ï¼ˆä½äºnet/ipv4/ip_output.cï¼ŒLine429ï¼‰å’Œip_build_xmit()ï¼ˆä½äºnet/ipv4/ip_output.cï¼ŒLine638ï¼‰ä¸­ç”¨äºè¿›è¡Œé”™è¯¯æ£€æµ‹ï¼›åœ¨igmp_send_report()ï¼ˆä½äºnet/ipv4/igmp.cï¼ŒLine195ï¼‰çš„æœ€åä¹Ÿç»è¿‡äº†è¿™ä¸ªHOOKï¼Œè¿›è¡Œå¤šæ’­æ—¶ç›¸å…³çš„å¤„ç†ã€‚<br>è¿™æ ·ï¼ŒIPTablesæ¨¡å—å°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªHOOKå¯¹åº”çš„OUTPUTè§„åˆ™é“¾è¡¨æ¥å¯¹æ•°æ®æŠ¥è¿›è¡Œè§„åˆ™åŒ¹é…çš„ç­›é€‰äº†ã€‚<br>æ¶‰åŠåŠŸèƒ½ï¼šConntrack(-200)ã€mangle(-150)ã€DNAT(-100)ã€filter(0)</p></li><li><p><em>NF_IP_POST_ROUTING (4)</em><br>æ‰€æœ‰æ•°æ®æŠ¥ï¼ŒåŒ…æ‹¬æºåœ°å€ä¸ºæœ¬åœ°ä¸»æœºå’Œéæœ¬åœ°ä¸»æœºçš„ï¼Œåœ¨é€šè¿‡ç½‘ç»œè®¾å¤‡ç¦»å¼€æœ¬åœ°ä¸»æœºä¹‹å‰ï¼Œåœ¨IPæ•°æ®æŠ¥å‘é€å‡½æ•°ip_finish_output()ï¼ˆä½äºnet/ipv4/ip_output.cï¼ŒLine184ï¼‰çš„æœ€åç»è¿‡è¿™ä¸ªHOOKã€‚<br>ç»è¿‡è¿™ä¸ªHOOKå¤„ç†åï¼Œæ•°æ®æŠ¥è¿›å…¥ip_finish_output2()ï¼ˆä½äºnet/ipv4/ip_output.cï¼ŒLine160ï¼‰å¦å¤–ï¼Œåœ¨å‡½æ•°ip_mc_output()ï¼ˆä½äºnet/ipv4/ip_output.cï¼ŒLine195ï¼‰ä¸­åœ¨å…‹éš†æ–°çš„ç½‘ç»œç¼“å­˜skbæ—¶ï¼Œä¹Ÿç»è¿‡äº†è¿™ä¸ªHOOKè¿›è¡Œå¤„ç†ã€‚<br>æ¶‰åŠåŠŸèƒ½ï¼šmangle(-150)ã€SNAT(100)ã€Conntrack(INT_MAX)</p></li></ul><p>å…¶ä¸­ï¼Œå…¥å£ä¸ºnet_rx_action()ï¼ˆä½äºnet/core/dev.cï¼ŒLine1602ï¼‰ï¼Œä½œç”¨æ˜¯å°†æ•°æ®æŠ¥ä¸€ä¸ªä¸ªåœ°ä»CPUçš„è¾“å…¥é˜Ÿåˆ—ä¸­æ‹¿å‡ºï¼Œç„¶åä¼ é€’ç»™åè®®å¤„ç†ä¾‹ç¨‹ã€‚<br>å‡ºå£ä¸ºdev_queue_xmit()ï¼ˆä½äºnet/core/dev.cï¼ŒLine1035ï¼‰ï¼Œè¿™ä¸ªå‡½æ•°è¢«é«˜å±‚åè®®çš„å®ä¾‹ä½¿ç”¨ï¼Œä»¥æ•°æ®ç»“æ„struct sk_buff *skbçš„å½¢å¼åœ¨ç½‘ç»œè®¾å¤‡ä¸Šå‘é€æ•°æ®æŠ¥ã€‚</p><h3 id="2-HOOKçš„è°ƒç”¨"><a href="#2-HOOKçš„è°ƒç”¨" class="headerlink" title="2.HOOKçš„è°ƒç”¨"></a><strong>2.HOOKçš„è°ƒç”¨</strong></h3><p>ã€€ã€€HOOKçš„è°ƒç”¨æ˜¯é€šè¿‡å®NF_HOOKå®ç°çš„ï¼Œå…¶å®šä¹‰ä½äºinclude/linux/netfilter.hï¼ŒLine122ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NF_HOOK(pf, hook, skb, indev, outdev, okfn) /</span></span><br><span class="line">(list_empty(&amp;nf_hooks[(pf)][(hook)])    /</span><br><span class="line">? (okfn)(skb)   /</span><br><span class="line">: nf_hook_slow((pf), (hook), (skb), (indev), (outdev), (okfn)))</span><br></pre></td></tr></table></figure><p>ã€€ã€€è¿™é‡Œå…ˆè°ƒç”¨list_emptyå‡½æ•°æ£€æŸ¥HOOKç‚¹å­˜å‚¨æ•°ç»„nf_hooksæ˜¯å¦ä¸ºç©ºï¼Œä¸ºç©ºåˆ™è¡¨ç¤ºæ²¡æœ‰HOOKæ³¨å†Œï¼Œåˆ™ç›´æ¥è°ƒç”¨okfnç»§ç»­å¤„ç†ã€‚å¦‚æœä¸ä¸ºç©ºï¼Œåˆ™è½¬å…¥nf_hook_slow()å‡½æ•°ã€‚<br>nf_hook_slow()å‡½æ•°ï¼ˆä½äºnet/core/netfilter.cï¼ŒLine449ï¼‰çš„å·¥ä½œä¸»è¦æ˜¯è¯»nf_hookæ•°ç»„éå†æ‰€æœ‰çš„nf_hook_opsç»“æ„ï¼Œå¹¶è°ƒç”¨nf_hookfn()å¤„ç†å„ä¸ªæ•°æ®æŠ¥ã€‚<br>å³HOOKçš„è°ƒç”¨è¿‡ç¨‹å¦‚å›¾:</p><div align="center"><p><img src="/img/note_06/04.jpg" alt="HOOKçš„è°ƒç”¨è¿‡ç¨‹"></p></div><p>ä¸‹é¢è¯´æ˜ä¸€ä¸‹NF_HOOKçš„å„ä¸ªå‚æ•°ï¼š</p><ul><li>pfï¼šåè®®æ—æ ‡è¯†ï¼Œç›¸å…³çš„æœ‰æ•ˆåè®®æ—åˆ—è¡¨ä½äºinclude/linux/socket.hï¼ŒLine 178ã€‚å¯¹äºIPv4ï¼Œåº”è¯¥ä½¿ç”¨åè®®æ—PF_INETï¼›</li><li>hookï¼šHOOKæ ‡è¯†ï¼Œå³å‰é¢æ‰€è¯´5ä¸ªHOOKå¯¹åº”çš„hooknumï¼›</li><li>skbï¼šæ˜¯å«æœ‰éœ€è¦è¢«å¤„ç†åŒ…çš„sk_buuffæ•°æ®ç»“æ„çš„æŒ‡é’ˆã€‚sk_buffæ˜¯Linuxç½‘ç»œç¼“å­˜ï¼ŒæŒ‡é‚£äº›linuxå†…æ ¸å¤„ç†IPåˆ†ç»„æŠ¥æ–‡çš„ç¼“å­˜ï¼Œå³å¥—æ¥å­—ç¼“å†²åŒºã€‚</li></ul><p>ã€€ã€€ç½‘å¡æ”¶åˆ°IPåˆ†ç»„æŠ¥æ–‡åï¼Œå°†å®ƒä»¬æ”¾å…¥sk_buffï¼Œç„¶åå†ä¼ é€ç»™ç½‘ç»œå †æ ˆï¼Œç½‘ç»œå †æ ˆå‡ ä¹ä¸€ç›´è¦ç”¨åˆ°sk_buffã€‚å…¶å®šä¹‰åœ¨include/linux/skbuff.hï¼ŒLine 129ï¼Œä¸‹é¢åˆ—å‡ºæˆ‘è®¤ä¸ºå¯¹åˆ†ææœ‰æ„ä¹‰çš„éƒ¨åˆ†æˆå‘˜ï¼š</p><ul><li><p><code>struct sock *sk;</code>ï¼šæŒ‡å‘åˆ›å»ºåˆ†ç»„æŠ¥æ–‡çš„socket;</p></li><li><p><code>struct timeval stamp;</code>ï¼šåˆ†ç»„æŠ¥æ–‡åˆ°è¾¾ç³»ç»Ÿçš„æ—¶é—´;</p></li><li><p>ä¸‹é¢æ˜¯ä¸‰ä¸ªunionï¼Œå­˜æ”¾çš„æ˜¯å„å±‚ä¸­å„ç§åè®®çš„æŠ¥æ–‡å¤´æŒ‡é’ˆï¼š</p><ul><li>hå¯¹åº”ä¼ è¾“å±‚çš„æŠ¥å¤´</li><li>nhå¯¹åº”ç½‘ç»œå±‚çš„æŠ¥å¤´</li><li>macå¯¹åº”MACå±‚çš„æŠ¥å¤´<ul><li><code>unsigned int len;</code>ï¼šå¥—æ¥å­—ç¼“å­˜æ‰€ä»£è¡¨çš„æŠ¥æ–‡é•¿åº¦ï¼Œå³ä»<code>unsigned char *data;</code>çš„ä½ç½®ç®—èµ·çš„å½“å‰æœ‰æ•ˆæŠ¥æ–‡é•¿åº¦ã€‚</li><li><code>unsigned char pkt_type;</code>ï¼šè¡¨ç¤ºæŠ¥æ–‡çš„ç±»å‹ï¼Œå…·ä½“ç±»å‹å®šä¹‰åœ¨include/linux/if_packet.hï¼ŒLine24ï¼š<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_HOST     0       <span class="comment">/* To us å‘é€åˆ°æœ¬æœºçš„æŠ¥æ–‡*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_BROADCAST    1       <span class="comment">/* To all   å¹¿æ’­æŠ¥æ–‡    */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_MULTICAST    2       <span class="comment">/* To group  å¤šæ’­æŠ¥æ–‡   */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_OTHERHOST    3       <span class="comment">/* To someone else è¡¨ç¤ºç›®çš„åœ°éæœ¬æœºä½†è¢«æœ¬æœºæ¥æ”¶çš„æŠ¥æ–‡ */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_OUTGOING     4       <span class="comment">/* Outgoing of any type ç¦»å¼€æœ¬æœºçš„æŠ¥æ–‡ */</span></span></span><br><span class="line"><span class="comment">/* These ones are invisible by user level */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_LOOPBACK     5       <span class="comment">/* MC/BRD frame looped back  æœ¬æœºå‘ç»™è‡ªå·±çš„æŠ¥æ–‡*/</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PACKET_FASTROUTE    6       <span class="comment">/* Fastrouted frame å¿«é€Ÿè·¯ç”±æŠ¥æ–‡ */</span></span></span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>indevï¼šè¾“å…¥è®¾å¤‡ï¼Œæ”¶åˆ°æ•°æ®æŠ¥çš„ç½‘ç»œè®¾å¤‡çš„net_deviceæ•°æ®ç»“æ„æŒ‡é’ˆï¼Œå³æ•°æ®æŠ¥åˆ°è¾¾çš„æ¥å£ã€‚</p><ul><li>ç”¨äºNF_IP_PRE_ROUTINGå’ŒNF_IP_LOCAL_INä¸¤ä¸ªHOOK</li></ul></li><li><p>outdevï¼šè¾“å‡ºè®¾å¤‡ï¼Œæ•°æ®æŠ¥ç¦»å¼€æœ¬åœ°æ‰€è¦ä½¿ç”¨çš„ç½‘ç»œè®¾å¤‡çš„net_deviceæ•°æ®ç»“æ„æŒ‡é’ˆã€‚</p><ul><li>ç”¨äºNF_IP_LOCAL_OUTå’ŒNF_IP_POST_ROUTINGä¸¤ä¸ªHOOK</li><li>æ³¨æ„ï¼šåœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œåœ¨ä¸€æ¬¡HOOKè°ƒç”¨ä¸­ï¼Œindevå’Œoutdevä¸­åªæœ‰ä¸€ä¸ªå‚æ•°ä¼šè¢«ä½¿ç”¨</li></ul></li><li><p>okfnï¼šä¸‹ä¸€æ­¥è¦å¤„ç†çš„å‡½æ•°ã€‚å³å¦‚æœæœ‰HOOKå‡½æ•°ï¼Œåˆ™å¤„ç†å®Œæ‰€æœ‰çš„HOOKå‡½æ•°ï¼Œä¸”æ‰€æœ‰å‘è¯¥HOOKæ³¨å†Œè¿‡çš„ç­›é€‰å‡½æ•°éƒ½è¿”å›NF_ACCEPTæ—¶ï¼Œè°ƒç”¨è¿™ä¸ªå‡½æ•°ç»§ç»­å¤„ç†ï¼›å¦‚æœæ²¡æœ‰æ³¨å†Œä»»ä½•HOOKï¼Œåˆ™ç›´æ¥è°ƒç”¨æ­¤å‡½æ•°ã€‚å…¶5ä¸ªå‚æ•°å°†ç”±å®NF_HOOKä¼ å…¥ã€‚</p></li></ul><h3 id="3-HOOKç‚¹çš„å®ç°"><a href="#3-HOOKç‚¹çš„å®ç°" class="headerlink" title="3. HOOKç‚¹çš„å®ç°"></a><strong>3. HOOKç‚¹çš„å®ç°</strong></h3><p>ã€€ã€€å¯¹åº”äºå„ä¸ªä¸åŒåè®®çš„ä¸åŒHOOKç‚¹æ˜¯ç”±ä¸€ä¸ªäºŒç»´æ•°ç»„nf_hookså­˜å‚¨çš„ï¼ˆä½äºnet/core/netfilter.cï¼ŒLine 47ï¼‰ï¼Œå…·ä½“çš„HOOKç‚¹åˆ™ç”±æ•°æ®ç»“æ„nf_hook_opsï¼ˆä½äºinclude/linux/netfilter.hï¼ŒLine 44ï¼‰å®ç°ã€‚å¦‚å›¾:</p><div align="center"><p><img src="/img/note_06/05.jpg" alt="HOOKç‚¹çš„å®ç°"></p></div><p>å…¶ä¸­ï¼Œnf_hook_opsæˆå‘˜ä¸­ï¼š</p><ul><li><code>int priority;</code> priorityå€¼è¶Šå°ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œç›¸å…³ä¼˜å…ˆçº§åœ¨include/linux/netfilter_ipv4.hï¼ŒLine52ä¸­æšä¸¾å®šä¹‰ï¼š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> NF_IP_hook_priorities &#123;</span><br><span class="line">    NF_IP_PRI_FIRST = INT_MIN,</span><br><span class="line">    NF_IP_PRI_CONNTRACK= <span class="number">-200</span>,</span><br><span class="line">    NF_IP_PRI_MANGLE = <span class="number">-150</span>,</span><br><span class="line">    NF_IP_PRI_NAT_DST = <span class="number">-100</span>,</span><br><span class="line">    NF_IP_PRI_FILTER = <span class="number">0</span>,</span><br><span class="line">    NF_IP_PRI_NAT_SRC = <span class="number">100</span>,</span><br><span class="line">    NF_IP_PRI_LAST = INT_MAX,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>nf_hookfn *hook;</code>ï¼šä¸ºå¤„ç†å‡½æ•°çš„æŒ‡é’ˆï¼Œå…¶å‡½æ•°æŒ‡é’ˆç±»å‹å®šä¹‰ä½äºinclude/linux/netfilter.hï¼ŒLine38ï¼Œä¸ºï¼š</li></ul><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">nf_hookfn</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> hooknum,</span></span></span><br><span class="line"><span class="function"><span class="params">                   struct sk_buff *skb,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> struct net_device *in,</span></span></span><br><span class="line"><span class="function"><span class="params">                   <span class="keyword">const</span> struct net_device *out,</span></span></span><br><span class="line">                   int (*okfn)(struct sk_buff *));</span><br></pre></td></tr></table></figure><p>ã€€ã€€è¿™æ˜¯nf_hook_opsä¸­æœ€å…³é”®çš„æˆå‘˜ï¼Œå…¶äº”ä¸ªå‚æ•°åˆ†åˆ«å¯¹åº”å‰é¢æ‰€è§£é‡Šçš„NF_HOOKä¸­ç¬¬2åˆ°6ä¸ªå‚æ•°ã€‚è°ƒç”¨HOOKçš„åŒ…ç­›é€‰å‡½æ•°å¿…é¡»è¿”å›ç‰¹å®šçš„å€¼ï¼Œè¿™äº›å€¼ä»¥å®çš„å½¢å¼å®šä¹‰äºå¤´æ–‡ä»¶include/linux/netfilter.hä¸­ï¼ˆLine15ï¼‰ï¼Œåˆ†åˆ«ä¸ºï¼š</p><ul><li><p>NF_DROP(0)ï¼šä¸¢å¼ƒæ­¤æ•°æ®æŠ¥ï¼Œç¦æ­¢åŒ…ç»§ç»­ä¼ é€’ï¼Œä¸è¿›å…¥æ­¤åçš„å¤„ç†æµç¨‹ï¼›</p></li><li><p>NF_ACCEPT(1)ï¼šæ¥æ”¶æ­¤æ•°æ®æŠ¥ï¼Œå…è®¸åŒ…ç»§ç»­ä¼ é€’ï¼Œç›´è‡³ä¼ é€’åˆ°é“¾è¡¨æœ€åï¼Œè€Œè¿›å…¥okfnå‡½æ•°ï¼›<br>ä»¥ä¸Šä¸¤ä¸ªè¿”å›å€¼æœ€ä¸ºå¸¸è§</p></li><li><p>NF_STOLEN(2)ï¼šæ•°æ®æŠ¥è¢«ç­›é€‰å‡½æ•°æˆªè·ï¼Œç¦æ­¢åŒ…ç»§ç»­ä¼ é€’ï¼Œä½†å¹¶ä¸é‡Šæ”¾æ•°æ®æŠ¥çš„èµ„æºï¼Œè¿™ä¸ªæ•°æ®æŠ¥åŠå…¶å æœ‰çš„sk_buffä»ç„¶æœ‰æ•ˆï¼ˆe.g. å°†åˆ†ç‰‡çš„æ•°æ®æŠ¥ä¸€ä¸€æˆªè·ï¼Œç„¶åå°†å…¶è£…é…èµ·æ¥å†è¿›è¡Œå…¶ä»–å¤„ç†ï¼‰ï¼› </p></li><li><p>NF_QUEQUE(3)ï¼šå°†æ•°æ®æŠ¥åŠ å…¥ç”¨æˆ·ç©ºé—´é˜Ÿåˆ—ï¼Œä½¿ç”¨æˆ·ç©ºé—´çš„ç¨‹åºå¯ä»¥ç›´æ¥è¿›è¡Œå¤„ç†ï¼›</p><ul><li>åœ¨nf_hook_slow()ä»¥åŠnf_reinject()å‡½æ•°ï¼ˆä½äºnet/core/netfilter.cï¼ŒLine449ï¼ŒLine505ï¼‰ä¸­ï¼Œå½“ç”±è°ƒç”¨nf_iterate()å‡½æ•°ï¼ˆä½äºnet/core/netfilter.cï¼ŒLine339ï¼Œä½œç”¨ä¸ºéå†æ‰€æœ‰æ³¨å†Œçš„HOOKå‡½æ•°ï¼Œå¹¶è¿”å›ç›¸åº”çš„NF_XXå€¼ï¼‰è€Œè¿”å›çš„verdictå€¼ä¸ºNF_QUEUEæ—¶ï¼ˆå³å½“å‰æ­£åœ¨æ‰§è¡Œçš„è¿™ä¸ªHOOKç­›é€‰å‡½æ•°è¦æ±‚å°†æ•°æ®æŠ¥åŠ å…¥ç”¨æˆ·ç©ºé—´é˜Ÿåˆ—ï¼‰ï¼Œä¼šè°ƒç”¨nf_queue()å‡½æ•°ï¼ˆä½äºnet/core/netfilter.cï¼ŒLine407ï¼‰</li><li>nf_queue()å‡½æ•°å°†è¿™ä¸ªæ•°æ®æŠ¥åŠ å…¥ç”¨æˆ·ç©ºé—´é˜Ÿåˆ—nf_infoï¼ˆä½äºinclude/linux/netfilter.hï¼ŒLine77ï¼‰ï¼Œå¹¶ä¿å­˜å…¶è®¾å¤‡ä¿¡æ¯ä»¥å¤‡ç”¨</li></ul></li><li><p>NF_REPEAT(4)ï¼šå†æ¬¡è°ƒç”¨å½“å‰è¿™ä¸ªHOOKçš„ç­›é€‰å‡½æ•°ï¼Œè¿›è¡Œé‡å¤å¤„ç†ã€‚</p></li></ul><h3 id="4-HOOKçš„æ³¨å†Œå’Œæ³¨é”€"><a href="#4-HOOKçš„æ³¨å†Œå’Œæ³¨é”€" class="headerlink" title="4. HOOKçš„æ³¨å†Œå’Œæ³¨é”€"></a><strong>4. HOOKçš„æ³¨å†Œå’Œæ³¨é”€</strong></h3><p>ã€€ã€€HOOKçš„æ³¨å†Œå’Œæ³¨é”€åˆ†åˆ«æ˜¯é€šè¿‡nf_register_hook()å‡½æ•°å’Œnf_unregister_hook()å‡½æ•°ï¼ˆåˆ†åˆ«ä½äºnet/core/netfilter.cï¼ŒLine60ï¼Œ76ï¼‰å®ç°çš„ï¼Œå…¶å‚æ•°å‡ä¸ºä¸€ä¸ªnf_hook_opsç»“æ„ï¼ŒäºŒè€…çš„å®ç°ä¹Ÿéå¸¸ç®€å•ã€‚<br>ã€€ã€€nf_register_hook()çš„å·¥ä½œæ˜¯é¦–å…ˆéå†nf_hools[][]ï¼Œç”±HOOKçš„ä¼˜å…ˆçº§ç¡®å®šåœ¨HOOKé“¾è¡¨ä¸­çš„ä½ç½®ï¼Œç„¶åæ ¹æ®ä¼˜å…ˆçº§å°†è¯¥HOOKçš„nf_hook_opsåŠ å…¥é“¾è¡¨ï¼›<br>ã€€ã€€nf_unregister_hook()çš„å·¥ä½œæ›´åŠ ç®€å•ï¼Œå…¶å®å°±æ˜¯å°†è¯¥HOOKçš„nf_hook_opsä»é“¾è¡¨ä¸­åˆ é™¤ã€‚</p><h2 id="å››ã€iptablesç³»ç»Ÿ"><a href="#å››ã€iptablesç³»ç»Ÿ" class="headerlink" title="å››ã€iptablesç³»ç»Ÿ"></a>å››ã€iptablesç³»ç»Ÿ</h2><h3 id="1-è¡¨ï¼è§„åˆ™ç³»ç»Ÿ"><a href="#1-è¡¨ï¼è§„åˆ™ç³»ç»Ÿ" class="headerlink" title="1. è¡¨ï¼è§„åˆ™ç³»ç»Ÿ"></a><strong>1. è¡¨ï¼è§„åˆ™ç³»ç»Ÿ</strong></h3><p>ã€€ã€€IPTablesæ˜¯åŸºäºNetfilteråŸºæœ¬æ¶æ„å®ç°çš„ä¸€ä¸ªå¯æ‰©å±•çš„æ•°æ®æŠ¥é«˜çº§ç®¡ç†ç³»ç»Ÿï¼Œåˆ©ç”¨tableã€chainã€ruleä¸‰çº§æ¥å­˜å‚¨æ•°æ®æŠ¥çš„å„ç§è§„åˆ™ã€‚ç³»ç»Ÿé¢„å®šä¹‰äº†ä¸‰ä¸ªtableï¼š</p><ul><li><p>filterï¼šæ•°æ®æŠ¥è¿‡æ»¤è¡¨ï¼ˆæ–‡ä»¶net/ipv4/netfilter/iptable_filter.cï¼‰<br>ç›‘å¬NF_IP_LOCAL_INã€NF_IP_FORWARDå’ŒNF_IP_LOCAL_OUTä¸‰ä¸ªHOOKï¼Œä½œç”¨æ˜¯åœ¨æ‰€æœ‰æ•°æ®æŠ¥ä¼ é€’çš„å…³é”®ç‚¹ä¸Šå¯¹å…¶è¿›è¡Œè¿‡æ»¤ã€‚</p></li><li><p>natï¼šç½‘ç»œåœ°å€è½¬æ¢è¡¨<br>ç›‘å¬NF_IP_PRE_ROUTINGã€NF_IP_POST_ROUTINGå’ŒNF_IP_LOCAL_OUTä¸‰ä¸ªHOOKï¼Œä½œç”¨æ˜¯å½“æ–°è¿æ¥çš„ç¬¬ä¸€ä¸ªæ•°æ®æŠ¥ç»è¿‡æ—¶ï¼Œåœ¨natè¡¨ä¸­å†³å®šå¯¹å…¶çš„è½¬æ¢æ“ä½œï¼›è€Œåé¢çš„å…¶å®ƒæ•°æ®æŠ¥éƒ½å°†æ ¹æ®ç¬¬ä¸€ä¸ªæ•°æ®æŠ¥çš„ç»“æœè¿›è¡Œç›¸åŒçš„è½¬æ¢å¤„ç†ã€‚</p></li><li><p>mangleï¼šæ•°æ®æŠ¥ä¿®æ”¹è¡¨ï¼ˆä½äºnet/ipv4/netfilter/iptable_mangle.cï¼‰</p></li></ul>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> netfilter </tag>
            
            <tag> iptables </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>KMPç®—æ³•ä»£ç æ¡ˆä¾‹</title>
      <link href="/2018/05/14/%E7%AC%94%E8%AE%B0/0eKMP%E7%AE%97%E6%B3%95%E4%BB%A3%E7%A0%81%E6%A1%88%E4%BE%8B/"/>
      <url>/2018/05/14/%E7%AC%94%E8%AE%B0/0eKMP%E7%AE%97%E6%B3%95%E4%BB%A3%E7%A0%81%E6%A1%88%E4%BE%8B/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> *<span class="title">computer_prefix</span><span class="params">(<span class="keyword">char</span> *str_p,<span class="keyword">int</span> *tt)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == str_p)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> m = <span class="built_in">strlen</span>(str_p);</span><br><span class="line"></span><br><span class="line">    tt[<span class="number">0</span>]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;m;i++)&#123;</span><br><span class="line">        <span class="keyword">while</span>(j&gt;<span class="number">0</span> &amp;&amp; str_p[j]!=str_p[i])</span><br><span class="line">            j=tt[j];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(str_p[j]==str_p[i])</span><br><span class="line">            j=j+<span class="number">1</span>;</span><br><span class="line">        tt[i]=j;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kmp_matcher</span><span class="params">(<span class="keyword">char</span> *<span class="keyword">str_t</span>,<span class="keyword">char</span> *str_p)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> ==<span class="keyword">str_t</span> || <span class="literal">NULL</span> == str_p)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> flag = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> n = <span class="built_in">strlen</span>(<span class="keyword">str_t</span>);</span><br><span class="line">    <span class="keyword">int</span> m = <span class="built_in">strlen</span>(str_p);</span><br><span class="line">    <span class="keyword">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> *tt = (<span class="keyword">int</span>*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>)*m);</span><br><span class="line">    computer_prefix(str_p,tt);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="literal">NULL</span> == tt)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//printf tt</span></span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;m;i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"tt[%d]=%d "</span>,i,tt[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\n"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">        <span class="keyword">while</span>(j&gt;<span class="number">0</span> &amp;&amp; <span class="keyword">str_t</span>[i] != str_p[j])</span><br><span class="line">            j = tt[j<span class="number">-1</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">str_t</span>[i] == str_p[j])</span><br><span class="line">            j++;</span><br><span class="line">        <span class="keyword">if</span>(j == m)&#123;</span><br><span class="line">            flag++;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"positon:%d\n"</span>,i-j+<span class="number">1</span>);</span><br><span class="line">            j = tt[j<span class="number">-1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(tt);</span><br><span class="line">    tt = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *str_p=<span class="string">"ababaca"</span>;</span><br><span class="line">    <span class="keyword">char</span> *<span class="keyword">str_t</span>=<span class="string">"aababacaafababaca"</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"orgin_str:%s\n"</span>,<span class="keyword">str_t</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"find_str:%s\n"</span>,str_p);</span><br><span class="line">    <span class="keyword">int</span> find_num = kmp_matcher(<span class="keyword">str_t</span>,str_p);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"find %d locations\n"</span>,find_num+<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒèµ„æ–™ï¼šç®—æ³•å¯¼è®º</p>]]></content>
      
      
        <tags>
            
            <tag> ç®—æ³• </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>TCP/IPå…¥é—¨ç»å…¸</title>
      <link href="/2018/05/14/%E7%AC%94%E8%AE%B0/05TCP-IP%E5%85%A5%E9%97%A8%E7%BB%8F%E5%85%B8/"/>
      <url>/2018/05/14/%E7%AC%94%E8%AE%B0/05TCP-IP%E5%85%A5%E9%97%A8%E7%BB%8F%E5%85%B8/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="TCP-IPå…¥é—¨ç»å…¸"><a href="#TCP-IPå…¥é—¨ç»å…¸" class="headerlink" title="TCP/IPå…¥é—¨ç»å…¸"></a>TCP/IPå…¥é—¨ç»å…¸</h1><h2 id="ç¬¬1ç« -TCP-IPåŸºç¡€"><a href="#ç¬¬1ç« -TCP-IPåŸºç¡€" class="headerlink" title="ç¬¬1ç«  TCP/IPåŸºç¡€"></a>ç¬¬1ç«  TCP/IPåŸºç¡€</h2><p>3ã€TCP/IPç‰¹æ€§ï¼š</p><blockquote><p>é€»è¾‘ç¼–å€;<br>è·¯ç”±é€‰æ‹©<br>åç§°è§£æ<br>é”™è¯¯æ§åˆ¶å’Œæµé‡æ§åˆ¶<br>åº”ç”¨æ”¯æŒ</p></blockquote><p>ï¼ˆ1ï¼‰ã€é€»è¾‘ç¼–å€<br>&emsp;&emsp;å½“ä¼ è¾“ä»‹è´¨éšè®¡ç®—æœºè¶Šæ¥è¶Šæ™®åŠæ—¶ï¼Œç‰©ç†åœ°å€æ¨¡å¼ä¸èƒ½æœ‰æ•ˆåœ°å‘æŒ¥ä½œç”¨ï¼Œç½‘ç»œç®¡ç†å‘˜ç»å¸¸ä½¿ç”¨è®¾å¤‡ï¼ˆæ¯”å¦‚è·¯ç”±å™¨ï¼‰å°†ç½‘ç»œåˆ†æ®µï¼Œä»¥å‡å°‘ç½‘ç»œçš„æ‹¥å µã€‚TCP/IPé€šè¿‡é€»è¾‘ç¼–å€æä¾›äº†è¿™æ ·çš„å­ç½‘åŒ–èƒ½åŠ›ã€‚é€»è¾‘åœ°å€æ˜¯ä¸€ä¸ªé€šè¿‡ç½‘ç»œè½¯ä»¶æ¥é…ç½®çš„åœ°å€ã€‚åœ¨TCP/IPä¸­ï¼Œè®¡ç®—æœºçš„é€»è¾‘åœ°å€ç§°ä¸ºIPåœ°å€ã€‚<br>&emsp;&emsp;ä¸€ä¸ªIPåœ°å€åŒ…æ‹¬ï¼š</p><blockquote><p>ä¸€ä¸ªè¯†åˆ«ç½‘ç»œçš„ç½‘ç»œIDæ•°å€¼<br>ä¸€ä¸ªè¯†åˆ«ç½‘ç»œä¸­å­ç½‘çš„å­ç½‘IDæ•°å€¼<br>ä¸€ä¸ªè¯†åˆ«å­ç½‘ä¸­è®¡ç®—æœºçš„ä¸»æœºIDæ•°å€¼</p></blockquote><p>é€šè¿‡ARPå’ŒRARPè¿›è¡Œé€»è¾‘åœ°å€å’Œç‰©ç†åœ°å€ä¹‹é—´çš„è½¬æ¢ã€‚</p><h2 id="ç¬¬2ç« -TCP-IPçš„å·¥ä½œæ–¹å¼"><a href="#ç¬¬2ç« -TCP-IPçš„å·¥ä½œæ–¹å¼" class="headerlink" title="ç¬¬2ç«  TCP/IPçš„å·¥ä½œæ–¹å¼"></a>ç¬¬2ç«  TCP/IPçš„å·¥ä½œæ–¹å¼</h2><h4 id="2-1ã€TCP-IPåè®®ç³»ç»Ÿ"><a href="#2-1ã€TCP-IPåè®®ç³»ç»Ÿ" class="headerlink" title="2.1ã€TCP/IPåè®®ç³»ç»Ÿ"></a><strong>2.1ã€TCP/IPåè®®ç³»ç»Ÿ</strong></h4><p>&emsp;&emsp;TCP/IPåè®®å¿…é¡»è´Ÿè´£å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š</p><blockquote><ul><li>æŠŠæ¶ˆæ¯åˆ†è§£ä¸ºå¯ç®¡ç†çš„æ•°æ®å—ï¼Œå¹¶ä¸”è¿™äº›æ•°æ®å—èƒ½å¤Ÿæœ‰æ•ˆåœ°é€šè¿‡ä¼ è¾“ä»‹è´¨</li><li>ä¸ç½‘ç»œé€‚é…å™¨ç¡¬ä»¶è¿æ¥ã€‚</li><li>å¯»å€ï¼Œå³å‘é€ç«¯è®¡ç®—æœºå¿…é¡»èƒ½å¤Ÿå®šä½åˆ°æ¥æ”¶æ•°æ®çš„è®¡ç®—æœºï¼Œæ¥æ”¶è®¡ç®—æœºå¿…é¡»èƒ½å¤Ÿæ˜¯è¢«è‡ªå·±è¦æ¥æ”¶çš„æ•°æ®</li><li>å°†æ•°æ®è·¯ç”±åˆ°ç›®çš„çš„è®¡ç®—æœºæ‰€åœ¨çš„å­ç½‘ï¼Œå³ä½¿æºå­ç½‘å’Œç›®çš„å­ç½‘åˆ†å¤„ä¸åŒçš„ç‰©ç†ç½‘ç»œã€‚</li><li>æ‰§è¡Œé”™è¯¯æ§åˆ¶ã€æµé‡æ§åˆ¶å’Œç¡®è®¤ï¼šå¯¹å¯é çš„é€šä¿¡è€Œè¨€ï¼Œå‘é€å’Œæ¥æ”¶è®¡ç®—æœºå¿…é¡»èƒ½å¤Ÿå‘ç°å¹¶çº æ­£ä¼ è¾“é”™è¯¯ï¼Œå¹¶æ§åˆ¶æ•°æ®æµã€‚</li><li>ä»åº”ç”¨ç¨‹åºæ¥æ”¶æ•°æ®å¹¶ä¼ è¾“åˆ°ç½‘ç»œ</li><li>ä»ç½‘ç»œæ¥æ”¶æ•°æ®å¹¶ä¼ è¾“åˆ°åº”ç”¨ç¨‹åºã€‚</li></ul></blockquote><p>&emsp;&emsp;ä¸ºäº†å®ç°ä¸Šè¿°åŠŸèƒ½ï¼ŒTCP/IPçš„åˆ›å»ºè€…ä½¿ç”¨æ¨¡å—åŒ–çš„è®¾è®¡ã€‚TCP/IPåè®®ç³»ç»Ÿåˆ’åˆ†ä¸ºä¸åŒçš„ç»„ä»¶ã€‚è¿™äº›ç»„ä»¶ä»ç†è®ºä¸Šæ¥è¯´æ˜¯èƒ½å¤Ÿç›¸äº’ç‹¬ç«‹åœ°æ˜¯å®ç°è‡ªå·±çš„åŠŸèƒ½ã€‚æ¯ä¸ªç»„ä»¶åˆ†åˆ«è´Ÿè´£é€šä¿¡è¿‡ç¨‹çš„ä¸€ä¸ªæ­¥éª¤ã€‚<br>&emsp;&emsp;TCP/IPæ¨¡å‹çš„åè®®å±‚:</p><table><thead><tr><th align="center">åº”ç”¨å±‚</th></tr></thead><tbody><tr><td align="center"><strong>ä¼ è¾“å±‚</strong></td></tr><tr><td align="center"><strong>ç½‘é™…å±‚</strong></td></tr><tr><td align="center"><strong>ç½‘ç»œè®¿é—®å±‚</strong></td></tr></tbody></table><blockquote><ul><li><strong>ç½‘ç»œè®¿é—®å±‚ï¼š</strong>æä¾›äº†ä¸ç‰©ç†ç½‘ç»œè¿æ¥çš„æ¥å£ã€‚é’ˆå¯¹ä¼ è¾“ä»‹è´¨è®¾ç½®<code>æ•°æ®æ ¼å¼</code>ï¼Œæ ¹æ®ç¡¬ä»¶çš„<code>ç‰©ç†åœ°å€</code>å®ç°<code>æ•°æ®çš„å¯»å€</code>ï¼Œå¯¹æ•°æ®åœ¨ç‰©ç†ç½‘ç»œä¸­çš„ä¼ è¾“æä¾›<code>é”™è¯¯æ§åˆ¶</code>ã€‚</li><li><strong>ç½‘é™…å±‚ï¼š</strong>æä¾›ç‹¬ç«‹ä¸ç¡¬ä»¶çš„<code>é€»è¾‘å¯»å€</code>ï¼Œä»è€Œè®©æ•°æ®èƒ½å¤Ÿåœ¨å…·æœ‰ä¸åŒç‰©ç†ç»“æ„çš„å­ç½‘ä¹‹é—´ä¼ åŠ›ï¼Œæä¾›è·¯ç”±åŠŸèƒ½æ¥é™ä½æµé‡ï¼Œæ”¯æŒç½‘é—´çš„æ•°æ®ä¼ é€’ï¼ˆæœ¯è¯­â€œç½‘é—´â€ï¼ˆinternetworkï¼‰æŒ‡çš„æ˜¯å¤šä¸ªå±€åŸŸç½‘äº’ç›¸è¿æ¥è€Œå½¢æˆçš„è¾ƒå¤§çš„ç½‘ç»œï¼Œæ¯”å¦‚å¤§å…¬å¸çš„ç½‘ç»œæˆ–Internetï¼‰ã€‚å®ç°ç‰©ç†åœ°å€ï¼ˆé—®ä½ è¿‡æ¥è®¿é—®å±‚ä½¿ç”¨çš„åœ°å€ï¼‰å’Œé€»è¾‘åœ°å€çš„è½¬æ¢ã€‚</li><li><strong>ä¼ è¾“å±‚ï¼š</strong>ä¸ºç½‘ç»œæä¾›äº†<code>æµé‡æ§åˆ¶</code>ï¼Œ<code>é”™è¯¯æ§åˆ¶</code>å’Œ<code>ç¡®è®¤æœåŠ¡</code>ã€‚ä»åˆ°ç½‘ç»œåº”ç”¨ç¨‹åºçš„æ¥å£ã€‚</li><li><strong>åº”ç”¨å±‚ï¼š</strong>ä¸ºç½‘ç»œ<code>æ’é”™</code>ï¼Œ<code>æ–‡ä»¶ä¼ è¾“</code>ï¼Œ<code>è¿œç¨‹æ§åˆ¶</code>å’ŒInternetæ“ä½œæä¾›äº†åº”ç”¨ç¨‹åºï¼Œè¿˜æ”¯æŒåº”ç”¨ç¼–ç¨‹<code>æ¥å£</code>ï¼ˆAPIï¼‰ï¼Œä»è€Œä½¿å¾—é’ˆå¯¹ç‰¹å®šæ“ä½œç³»ç»Ÿç¼–å†™çš„ç¨‹åºèƒ½å¤Ÿæä¾›è®¿é—®ç½‘ç»œã€‚</li></ul></blockquote><h4 id="2-2ã€TCP-IPå’ŒOSIæ¨¡å‹"><a href="#2-2ã€TCP-IPå’ŒOSIæ¨¡å‹" class="headerlink" title="2.2ã€TCP/IPå’ŒOSIæ¨¡å‹"></a><strong>2.2ã€TCP/IPå’ŒOSIæ¨¡å‹</strong></h4><p>&emsp;&emsp;<code>OSI(å¼€æ”¾ç³»ç»Ÿäº’è¿)</code>æ˜¯<code>ISO(å›½é™…æ ‡å‡†åŒ–ç»„ç»‡)</code>ä¸ºäº†æ ‡å‡†åŒ–ç½‘ç»œåè®®ç³»ç»Ÿåšå‡ºçš„è§„èŒƒï¼Œæ—¨åœ¨æé«˜ç½‘ç»œäº’è¿æ€§ï¼Œå¹¶ä¸”æ–¹ä¾¿è½¯ä»¶å¼€å‘äººå‘˜ä»¥ä¸€ç§å¼€æ”¾æ–¹å¼æ¥ä½¿ç”¨åè®®æ ‡å‡†ã€‚</p><table><thead><tr><th align="center">TCP/IP</th><th align="center">OSI</th></tr></thead><tbody><tr><td align="center">åº”ç”¨å±‚</td><td align="center">åº”ç”¨å±‚</td></tr><tr><td align="center"></td><td align="center">è¡¨ç¤ºå±‚</td></tr><tr><td align="center"></td><td align="center">ä¼šè¯å±‚</td></tr><tr><td align="center">ä¼ è¾“å±‚</td><td align="center">ä¼ è¾“å±‚</td></tr><tr><td align="center">ç½‘é™…å±‚</td><td align="center">ç½‘ç»œå±‚</td></tr><tr><td align="center">ç½‘ç»œè®¿é—®å±‚</td><td align="center">æ•°æ®é“¾è·¯å±‚</td></tr><tr><td align="center"></td><td align="center">ç‰©ç†å±‚</td></tr><tr><td align="center">&emsp;&emsp;OSIæ¨¡å‹7å±‚:</td><td align="center"></td></tr></tbody></table><blockquote><ul><li><strong>ç‰©ç†å±‚ï¼š</strong>æŠŠæ•°æ®è½¬æ¢ä¸ºä¼ è¾“ä»‹è´¨ä¸Šçš„ç”µå­æµæˆ–æ¨¡æ‹Ÿè„‰å†²ï¼Œå¹¶ä¸”ç›‘å¬æ•°æ®çš„ä¼ è¾“ã€‚</li><li><strong>æ•°æ®é“¾è·¯å±‚ï¼š</strong>æä¾›ä¸ç½‘ç»œé€‚é…å™¨ç›¸è¿çš„æ¥å£ï¼Œç»´æŠ¤å­ç½‘çš„é€»è¾‘è¿æ¥ã€‚</li><li><strong>ç½‘ç»œå±‚ï¼š</strong>æ”¯æŒé€»è¾‘å¯»å€ä¸è·¯ç”±é€‰æ‹©</li><li><strong>ä¼ è¾“å±‚ï¼š</strong>ä¸ºç½‘ç»œæä¾›é”™è¯¯æ§æ§åˆ¶å’Œæ•°æ®æµæ§åˆ¶</li><li><strong>ä¼šè¯å±‚ï¼š</strong>åœ¨è®¡ç®—æœºçš„é€šä¿¡åº”ç”¨ç¨‹åºä¹‹é—´å»ºç«‹ä¼šè¯</li><li><strong>è¡¨ç¤ºå±‚ï¼š</strong>æŠŠæ•°æ®è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼ï¼Œç®¡ç†æ•°æ®åŠ å¯†å’Œå‹ç¼©ã€‚</li><li><strong>åº”ç”¨å±‚ï¼š</strong>ä¸ºåº”ç”¨ç¨‹åºæä¾›ç½‘ç»œæ¥å£ï¼Œæ”¯æŒæ–‡ä»¶ä¼ è¾“ã€é€šä¿¡ç­‰åŠŸèƒ½çš„ç½‘ç»œåº”ç”¨ã€‚</li></ul></blockquote><p><strong>æ³¨</strong>ï¼šTCP/IPæ¨¡å‹å’ŒOSIæ¨¡å‹éƒ½æ˜¯æ ‡å‡†ï¼Œè€Œä¸æ˜¯å®ç°ã€‚<br>TCP/IPçš„å…·ä½“å®ç°æ²¡æœ‰ä¸¥æ ¼éµå®ˆä¸Šè¿°ä¸¤ä¸ªè¡¨æ ¼æ¨¡å‹ã€‚</p><p>TCP/IPåè®®æ—æŒ‰ç…§å±‚æ¬¡ç”±ä¸Šåˆ°ä¸‹ï¼Œå±‚å±‚åŒ…è£…ã€‚æœ€ä¸Šé¢çš„æ˜¯åº”ç”¨å±‚ï¼Œè¿™é‡Œé¢æœ‰httpï¼Œftp,ç­‰ç­‰æˆ‘ä»¬ç†Ÿæ‚‰çš„åè®®ã€‚è€Œç¬¬äºŒå±‚åˆ™æ˜¯ä¼ è¾“å±‚ï¼Œè‘—åçš„TCPå’ŒUDPåè®®å°±åœ¨è¿™ä¸ªå±‚æ¬¡ã€‚ç¬¬ä¸‰å±‚æ˜¯ç½‘ç»œå±‚ï¼ŒIPåè®®å°±åœ¨è¿™é‡Œï¼Œå®ƒè´Ÿè´£å¯¹æ•°æ®åŠ ä¸ŠIPåœ°å€å’Œå…¶ä»–çš„æ•°æ®ä»¥ç¡®å®šä¼ è¾“çš„ç›®æ ‡ã€‚ç¬¬å››å±‚æ˜¯æ•°æ®é“¾è·¯å±‚ï¼Œè¿™ä¸ªå±‚æ¬¡ä¸ºå¾…ä¼ é€çš„æ•°æ®åŠ å…¥ä¸€ä¸ªä»¥å¤ªç½‘åè®®å¤´ï¼Œå¹¶è¿›è¡ŒCRCç¼–ç ï¼Œä¸ºæœ€åçš„æ•°æ®ä¼ è¾“åšå‡†å¤‡ã€‚</p><h4 id="2-3ã€æ•°æ®åŒ…"><a href="#2-3ã€æ•°æ®åŒ…" class="headerlink" title="2.3ã€æ•°æ®åŒ…"></a><strong>2.3ã€æ•°æ®åŒ…</strong></h4><p>&emsp;&emsp;æ•°æ®åŒ…åœ¨æ¯ä¸€å±‚å…·æœ‰ä¸ç”¨çš„å½¢å¼å’Œåç§°<br>&emsp;&emsp;æ•°æ®åŒ…åœ¨æ¯å±‚çš„åç§°ï¼š</p><blockquote><ul><li>åœ¨åº”ç”¨å±‚ç”Ÿäº§çš„æ•°æ®åŒ…è¢«ç§°ä¸º<strong><code>æ¶ˆæ¯</code></strong>ã€‚</li><li>åœ¨ä¼ è¾“å±‚ç”Ÿäº§çš„æ•°æ®åŒ…å°è£…äº†åº”ç”¨å±‚å¾—æ¶ˆæ¯ï¼Œå¦‚æœå®ƒæ¥è‡ªäºä¼ è¾“å±‚çš„TCPåè®®ï¼Œå°±è¢«ç§°ä¸º<strong><code>åˆ†æ®µ</code></strong>ï¼›å¦‚æœæ¥è‡ªä¼ è¾“å±‚çš„UDPåè®®ï¼Œå°±è¢«ç§°ä¸º<strong><code>æ•°æ®æŠ¥</code></strong>ã€‚</li><li>åœ¨ç½‘é™…å±‚çš„æ•°æ®åŒ…å°è£…äº†ä¼ è¾“å±‚çš„ç‰‡æ®µï¼Œè¢«ç§°ä¸º<strong><code>æ•°æ®æŠ¥</code></strong>ã€‚</li><li>åœ¨ç½‘ç»œè®¿é—®å±‚çš„æ•°æ®åŒ…å°è£…æ•°æ®åŒ…ï¼ˆè€Œä¸”å¯èƒ½å¯¹å…¶è¿›è¡Œå†åˆ†è§£ï¼‰ï¼Œè¢«ç§°ä¸º<strong><code>å¸§</code></strong>ã€‚å¸§è¢«è®¿é—®å±‚é‡Œçš„æœ€ä½å­å±‚è½¬åŒ–ä¸º<strong><code>æ¯”ç‰¹æµ</code></strong>ã€‚</li></ul></blockquote><h4 id="2-4-TCP-IPç½‘ç»œæ¦‚è¿°"><a href="#2-4-TCP-IPç½‘ç»œæ¦‚è¿°" class="headerlink" title="2.4 TCP/IPç½‘ç»œæ¦‚è¿°"></a><strong>2.4 TCP/IPç½‘ç»œæ¦‚è¿°</strong></h4><p>&emsp;&emsp;å›¾2.4æè¿°äº†åŸºæœ¬çš„TCP/IPåè®®è¿ç½‘ç³»ç»Ÿã€‚å½“ç„¶ï¼Œåœ¨å®Œæ•´çš„æ•°æ®åŒ…é‡Œè¿˜åŒ…æ‹¬å…¶ä»–çš„åè®®å’ŒæœåŠ¡ï¼Œå›¾ä¸­å±•ç¤ºçš„æ˜¯æœ€ä¸»è¦çš„éƒ¨åˆ†ã€‚</p><p>åŸºæœ¬åœºæ™¯å¦‚ä¸‹ï¼š</p><blockquote><ol><li>æ•°æ®ä»å·¥ä½œäºåº”ç”¨å±‚çš„åè®®ã€ç½‘ç»œæœåŠ¡æˆ–åº”ç”¨ç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰é€šè¿‡TCPæˆ–UDPç«¯å£ä¼ é€’åˆ°ä¸¤ä¸ªä¼ è¾“å±‚åè®®ï¼ˆTCPæˆ–UDPï¼‰ä¸­çš„ä¸€ä¸ªã€‚ç¨‹åºå¯ä»¥æ ¹æ®éœ€è¦é€šè¿‡TCPæˆ–UDPè®¿é—®ç½‘ç»œã€‚</li></ol><ul><li>TCPæ˜¯é¢å‘è¿æ¥çš„åè®®ã€‚TCPèƒ½å¤Ÿç¡®ä¿æ•°æ®çš„å‘é€æŒ‡ä»¤ï¼Œå¿…UDPæ›´å¯é ï¼Œä½†ç”±äºéœ€è¦è¿›è¡Œé¢å¤–çš„é”™è¯¯æ£€æµ‹å’Œæµé‡æ§åˆ¶ï¼Œå¿…UDPçš„é€Ÿåº¦æ…¢ã€‚(è¯¦è§ç¬¬6ç« )<ul><li>UDPæ˜¯é¢å‘æ— è¿æ¥çš„åè®®ï¼Œæ¯”TCPå¿«ï¼Œä½†æ˜¯ä¸å¯é ï¼Œå®ƒæŠŠé”™è¯¯æ§åˆ¶çš„è´£ä»»æ¨ç»™äº†åº”ç”¨ã€‚</li></ul></li></ul><ol start="2"><li>æ•°æ®åˆ†æ®µä¼ é€’åˆ°ç½‘é™…å±‚ï¼ŒIPåè®®åœ¨æ­¤æä¾›é€»è¾‘å¯»å€ä¿¡æ¯ï¼Œå¹¶ä¸”æŠŠæ•°æ®å°è£…ä¸ºæ•°æ®æŠ¥ã€‚</li><li>IPæ•°æ®æŠ¥è¿›å…¥ç½‘ç»œè®¿é—®å±‚ï¼Œä¼ é€’åˆ°ä¸ç‰©ç†ç½‘ç»œç›¸è¿æ¥çš„è½¯ä»¶ç»„ä»¶ã€‚ç½‘ç»œè®¿é—®å±‚åˆ›å»ºé¢ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®å¸§ï¼Œä»è€Œè¿›å…¥åˆ°ç‰©ç†ç½‘ç»œã€‚åœ¨åƒä¸€å°ç½‘è¿™æ ·çš„é¢å±€åŸŸç½‘ç³»ç»Ÿä¸­ï¼Œå¸§å¯ä»¥åŒ…å«ä»è¡¨æ ¼é‡Œè·å–ç‰©ç†åœ°å€ä¿¡æ¯ï¼Œè€Œè¿™äº›è¡¨æ ¼æ˜¯ç”±ç½‘é™…å±‚çš„ARPç»´æŠ¤çš„ï¼ˆARPæ˜¯åœ°å€è§£æåè®®ï¼ŒIPåœ°å€è½¬æ¢ä¸ºç‰©ç†åœ°å€ã€‚ï¼‰</li><li>æ•°æ®å¸§è¢«è½¬åŒ–ä¸ºæ¯”ç‰¹æµï¼Œé€šè¿‡ç½‘ç»œä»‹è´¨è¿›è¡Œä¼ è¾“ã€‚</li></ol></blockquote><p>&emsp;&emsp;ARP(åœ°å€è§£æåè®®)ï¼Œå°†é€»è¾‘åœ°å€IPè§£ææˆç‰©ç†åœ°å€çš„åè®®<br>&emsp;&emsp;DNS(Domain Name Systemï¼ŒåŸŸåç³»ç»Ÿ)</p><h2 id="ç¬¬3ç« -ç½‘ç»œè®¿é—®å±‚"><a href="#ç¬¬3ç« -ç½‘ç»œè®¿é—®å±‚" class="headerlink" title="ç¬¬3ç«  ç½‘ç»œè®¿é—®å±‚"></a>ç¬¬3ç«  ç½‘ç»œè®¿é—®å±‚</h2><p>&emsp;&emsp;ç½‘ç»œè®¿é—®å±‚æ˜¯æœ€ç¥ç§˜ã€æœ€ä¸ç»Ÿä¸€çš„TCP/IPå±‚ï¼Œå®ƒç®¡ç†ä¸ºç‰©ç†ç½‘ç»œå‡†å¤‡æ•°æ®æ‰€å¿…é¡»çš„æœåŠ¡äºåŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š</p><blockquote><ul><li>ä¸è®¡ç®—æœºç½‘ç»œé€‚é…å™¨çš„è¿æ¥</li><li>æ ¹æ®åˆé€‚çš„è®¿é—®æ–¹å¼è°ƒæ•´æ•°æ®ä¼ è¾“ï¼Œ</li><li>æŠŠæ•°æ®è½¬åŒ–ä¸ºç”µå­æµæˆ–æ¨¡æ‹Ÿè„‰å†²çš„å½¢å¼ï¼Œä»¥åœ¨ä¼ è¾“ä»‹è´¨ä¸Šè¿›è¡Œä¼ è¾“ã€‚</li><li>å¯¹æ¥æ”¶åˆ°çš„æ•°æ®è¿›è¡Œé”™è¯¯æ£€æŸ¥ï¼›</li><li>ç»™å‘é€çš„æ•°æ®æ·»åŠ é”™è¯¯æ£€æŸ¥ä¿¡æ¯ï¼Œä»è€Œè®©æ¥æ”¶ç«¯è®¡ç®—æœºèƒ½å¤Ÿå¯¹æ•°æ®è¿›è¡Œé”™è¯¯æ£€æŸ¥ã€‚</li></ul></blockquote><p>&emsp;&emsp;TCP/IP<code>æ•°æ®è®¿é—®å±‚</code>å¯¹åº”OSI<code>æ•°æ®é“¾è·¯å±‚</code>å’Œ<code>ç‰©ç†å±‚</code>ã€‚</p><h4 id="3-2-ç½‘ç»œè®¿é—®å±‚ä¸OISæ¨¡å‹"><a href="#3-2-ç½‘ç»œè®¿é—®å±‚ä¸OISæ¨¡å‹" class="headerlink" title="3.2 ç½‘ç»œè®¿é—®å±‚ä¸OISæ¨¡å‹"></a><strong>3.2 ç½‘ç»œè®¿é—®å±‚ä¸OISæ¨¡å‹</strong></h4><p>&emsp;&emsp;å¦‚å›¾3.1æ‰€ç¤º,TCP/IPç½‘ç»œè®¿é—®å±‚å¤§è‡´å¯¹åº”OSIçš„ç‰©ç†æˆå’Œæ•°æ®é“¾è·¯å±‚ã€‚OSIçš„ç‰©ç†å±‚è´Ÿè´£æŠŠæ•°æ®å¸§è½¬æ¢ä¸ºé€‚åˆä¸ä¼ è¾“ä»‹è´¨çš„æ¯”ç‰¹æµï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒOSIç‰©ç†å±‚ç®¡ç†å’ŒåŒæ­¥å®é™…ä¼ è¾“çš„ç”µå­æˆ–æ¨¡æ‹Ÿè„‰å†²ã€‚åœ¨æ¥æ”¶ç«¯ï¼Œç‰©ç†å±‚æŠŠè¿™äº›è„‰å†²é‡æ–°ç»„åˆä¸ºæ•°æ®å¸§ã€‚<br>&emsp;&emsp;OSIæ•°æ®é“¾è·¯å±‚æ‰§è¡Œä¸¤ä¸ªç‹¬ç«‹çš„ä»»åŠ¡ï¼Œç›¸åº”åœ°åˆ’åˆ†ä¸ºä¸¤ä¸ªå­å±‚ã€‚</p><blockquote><ul><li><strong>ä»‹è´¨è®¿é—®æ§åˆ¶ï¼ˆMACï¼‰ï¼š</strong>è¿™ä¸ªå­å±‚æä¾›ä¸ç½‘ç»œé€‚é…å™¨è¿æ¥çš„æ¥å£ã€‚å®é™…ä¸Šï¼Œç½‘ç»œé€‚é…å™¨é©±åŠ¨ç¨‹åºé€šå¸¸è¢«ç§°ä¸ºMACé©±åŠ¨ï¼Œè€Œç½‘å¡åœ¨å·¥å‚å›ºåŒ–çš„ç¡¬ä»¶åœ°å€é€šå¸¸ç§°ä¸ºMACåœ°å€ã€‚</li><li><strong>é€»è¾‘é“¾è·¯æ§åˆ¶ï¼ˆLLCï¼‰ï¼š</strong>è¿™ä¸ªå­å±‚ç»è¿‡å­ç½‘ä¼ é€’çš„å¸§è¿›è¡Œé”™è¯¯æ£€æŸ¥ï¼Œå¹¶ä¸”ç®¡ç†å­ç½‘ä¸Šé€šä¿¡è®¾å¤‡ä¹‹é—´çš„é“¾è·¯ã€‚</li></ul></blockquote><p><strong>æ³¨æ„ï¼š</strong> NDISå’ŒODI</p><blockquote><p>åœ¨å®é™…çš„ç½‘ç»œåè®®å®ç°ä¸­æ²¡å¿˜äº†é©±åŠ¨ç¨‹åºæ¥å£è§„èŒƒï¼ˆNDISï¼‰å’Œå¼€å‘æ•°æ®é“¾è·¯æ¥å£ï¼ˆODIï¼‰è§„èŒƒçš„å­˜åœ¨è¿›ä¸€æ­¥å¤æ‚äº†TCP/IPå±‚ä¸OSIç³»ç»Ÿä¹‹é—´çš„åŒºåˆ«ã€‚NDIS(æœ‰Microsoftå’Œ3Comå…¬å¸å¼€å‘)å’ŒODI(ç”±Appleå’ŒNovellå¼€å‘)çš„è®¾è®¡ç›®çš„åœ¨äºè®©å•ä¸ªåè®®æ ˆï¼ˆæ¯”å¦‚TCP/IPï¼‰ä½¿ç”¨å¤šä¸ªç½‘ç»œæ˜¯é…èµ„ï¼Œå¹¶è®©å•ä¸ªç½‘ç»œé€‚é…å™¨ä½¿ç”¨å¤šä¸ªä¸Šä¼ åè®®ï¼Œè¿™æ ·å¯ä»¥è®©ä¸Šä¼ åè®®å½»åº•ç‹¬ç«‹äºç½‘ç»œè®¿é—®ç³»ç»Ÿï¼Œä»è€Œä¸ºç½‘ç»œå¢åŠ äº†å¾ˆå¼ºçš„åŠŸèƒ½ï¼Œä½†åŒæ—¶ä¹Ÿå¢åŠ äº†å¤æ‚æ€§ï¼Œä¹Ÿè®©ç³»ç»Ÿåœ°ä»‹ç»è½¯ä»¶ç»„ä»¶åœ¨åº•å±‚å¦‚ä½•äº¤äº’å˜å¾—æ›´åŠ å›°éš¾ã€‚</p></blockquote><h4 id="3-3-ç½‘ç»œä½“ç³»"><a href="#3-3-ç½‘ç»œä½“ç³»" class="headerlink" title="3.3 ç½‘ç»œä½“ç³»"></a><strong>3.3 ç½‘ç»œä½“ç³»</strong></h4><p>&emsp;&emsp;ç½‘ç»œä½“ç³»ï¼ˆæ¯”å¦‚ä»¥å¤ªç½‘ï¼‰å…·æœ‰ä¸€ç³»åˆ—çš„è§„èŒƒæ¥ç®¡ç†ä»‹è´¨è®¿é—®ã€ç‰©ç†å¯»å€ã€è®¡ç®—æœºä¸ä¼ è¾“ä»‹è´¨çš„äº¤äº’ã€‚åœ¨å†³å®šç½‘ç»œä½“ç³»æ—¶ï¼Œå®é™…ä¸Šæ˜¯åœ¨å†³å®šå¦‚ä½•è®¾è®¡ç½‘ç»œè®¿é—®å±‚ã€‚<br>&emsp;&emsp;ç½‘ç»œä½“ç³»åŒ…å«å¯¹ç‰©ç†ç½‘ç»œçš„å®šä¹‰ï¼Œä»¥åŠè¯¥ç‰©ç†ç½‘ç»œä¸Šå®šä¹‰çš„é€šä¿¡è§„èŒƒã€‚é€šä¿¡ç»†èŠ‚åŸºäºç‰©ç†ç»†èŠ‚ï¼Œæ‰€ä»¥è¿™äº›è§„èŒƒé€šå¸¸ä»¥ä¸€ä¸ªå®Œæ•´çš„åŒ…å‡ºç°ã€‚è¿™äº›è§„èŒƒåŒ…å«ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ã€‚</p><blockquote><ul><li><strong>è®¿é—®æ§åˆ¶ï¼š</strong>è®¿é—®æ–¹æ³•æ˜¯å®šä¹‰äº†è®¡ç®—æœºå¦‚ä½•å…±äº«ä¼ è¾“ä»‹è´¨çš„ä¸€ç»„è§„åˆ™ã€‚ä¸ºäº†é¿å…æ•°æ®çš„å†²çªï¼Œè®¡ç®—æœºåœ¨ä¼ è¾“æ•°æ®æ—¶å¿…é¡»éµå®ˆè¿™äº›è§„åˆ™ã€‚</li><li><strong>æ•°æ®å¸§æ ¼å¼ï¼š</strong>æ¥è‡ªäºç½‘é™…å±‚çš„IPå‡ å€çš„æ•°æ®æŠ¥ä»¥é¢„å®šä¹‰çš„æ ¼å¼å°è£…ä¸ºæ•°æ®å¸§ï¼Œå°è£…åœ¨åŒ…å¤´ä¸­çš„æ•°æ®å¿…é¡»æä¾›åœ¨ç‰©ç†ç½‘ç»œä¸Šä¼ è¾“æ•°æ®æ‰€éœ€è¦çš„ä¿¡æ¯ã€‚</li><li><strong>å¸ƒçº¿ç±»å‹ï¼š</strong>ç½‘ç»œé”ä½¿ç”¨çš„çº¿ç¼†ç±»å‹å¯¹äºå…¶ä»–è®¾è®¡å‚æ•°å…·æœ‰ä¸€å®šçš„å½±å“ï¼Œæ¯”å¦‚é€‚é…å™¨çš„ä¼ é€’çš„æ¯”ç‰¹æµçš„ç”µå­ç‰¹æ€§ã€‚</li><li><strong>å¸ƒçº¿è§„åˆ™ï¼š</strong>åè®®ã€çº¿ç¼†ç±»å‹å’Œä¼ è¾“çš„ç”µå­ç‰¹æ€§å½±å“ç€çº¿ç¼†çš„æœ€å¤§å’Œæœ€å°é•¿åº¦ã€ç”µç¼†è¿æ¥è¯¶å™¨çš„è§„èŒƒã€‚</li></ul></blockquote><p>&emsp;&emsp;æœ€ç»ˆè¦çš„æ˜¯ï¼Œç½‘ç»œè®¿é—®å±‚ä»¥ä¸Šçš„åè®®å±‚ä¸å¿…å…³å¿ƒç¡¬ä»¶è®¾è®¡çš„é—®é¢˜ã€‚TCP/IPåè®®æ ˆçš„è®¾è®¡ä¿è¯äº†ä¸ç¡¬ä»¶äº¤äº’ç›¸å…³çš„ç»†èŠ‚å‘ç”Ÿåœ¨ç½‘ç»œè®¿é—®å±‚ï¼Œä½¿å¾—TCP/IPèƒ½å¤Ÿå·¥ä½œäºå¤šç§ä¸åŒçš„ä¼ è¾“ä»‹è´¨ã€‚</p><p>&emsp;&emsp;ç½‘ç»œè®¿é—®å±‚å¦‚ä¸‹çš„ä¸€äº›ä½“ç³»ï¼š</p><blockquote><ul><li><strong>IEEE 802.3(ä»¥å¤ªç½‘)ï¼š</strong>åœ¨å¤§å¤šæ•°åŠå…¬å®¤å’Œå®¶åº­ä½¿ç”¨çš„åŸºäºçº¿ç¼†çš„ç½‘ç»œã€‚</li><li><strong>IEEE 802.11(æ— çº¿ç½‘ç»œ)ï¼š</strong>åŠå…¬å®¤ã€å®¶åº­å’Œå’–å•¡å…ä½¿ç”¨çš„æ— çº¿ç½‘ç»œæŠ€æœ¯</li><li><strong>IEEE 802.16(WiMAX)ï¼š</strong>ç”¨äºç§»åŠ¨é€šä¿¡é•¿è·ç¦»æ— çº¿è¿æ¥æŠ€æœ¯ã€‚</li><li><strong>ç‚¹åˆ°ç‚¹åè®®ï¼ˆPPPï¼‰ï¼š</strong> Modemé€šè¿‡ç”µè¯çº¿è¿›è¡Œè¿æ¥çš„æŠ€æœ¯ã€‚</li></ul></blockquote><p>&emsp;&emsp;TCP/IPè¿˜æ”¯æŒå…¶ä»–ä¸€äº›ç½‘ç»œä½“ç³»ã€‚å¦‚å›¾3.2æ‰€ç¤ºï¼Œåè®®æ ˆçš„æ¨¡å—åŒ–ç‰¹æ€§ä½¿å¾—åœ¨ç½‘ç»œè®¿é—®å±‚é‡Œä¸ç¡¬ä»¶æ‰“äº¤é“çš„è½¯ä»¶ç»„ä»¶èƒ½å¤Ÿä¸ºå’Œç¡¬ä»¶æ— å…³æ“ä½œçš„ä¸Šå±‚æä¾›æ¥å£ã€‚</p><h4 id="3-4ã€ç‰©ç†åœ°å€"><a href="#3-4ã€ç‰©ç†åœ°å€" class="headerlink" title="3.4ã€ç‰©ç†åœ°å€"></a><strong>3.4ã€ç‰©ç†åœ°å€</strong></h4><p>&emsp;&emsp;ARPå’ŒRARPä¸ºç”¨æˆ·æä¾›äº†é€»è¾‘IPåœ°å€ä¸<strong>å±€åŸŸç½‘</strong>ä¸Šä½¿ç”¨çš„ç¡¬ä»¶åœ°å€å»ºç«‹äº†ä¸€ä¸ªå¯¹åº”å…³ç³»ã€‚(è¯¦è§ç¬¬4ç« )ã€‚<br>&emsp;&emsp;ä»¥å¤ªç½‘è½¯ä»¶ä½¿ç”¨çš„åœ°å€å¹¶ä¸æ˜¯é€»è¾‘IPåœ°å€ï¼Œä½†è¿™ä¸ªåœ°å€åœ¨ç½‘é™…å±‚çš„æ¥å£ä¸Šä¸IPåœ°å€æœ‰æ˜ å°„å…³ç³»ã€‚</p><h4 id="3-5ã€ä»¥å¤ªç½‘-802-3"><a href="#3-5ã€ä»¥å¤ªç½‘-802-3" class="headerlink" title="3.5ã€ä»¥å¤ªç½‘(802.3)"></a><strong>3.5ã€ä»¥å¤ªç½‘(802.3)</strong></h4><p>&emsp;&emsp;ä»¥å¤ªç½‘æ˜¯ç›®å‰ä½¿ç”¨æœ€å¹¿æ³›çš„<strong><code>å±€åŸŸç½‘</code></strong>æŠ€æœ¯ã€‚ä»¥å¤ªç½‘ä½¿ç”¨ç§°ä¸º<strong><code>è½½æ³¢ç›‘å¬å¤šè·¯è®¿é—®/å†²çªæ£€æµ‹ï¼ˆCSMA/CDï¼‰</code></strong>çš„æ–¹æ³•ï¼Œæ¥åˆ¤æ–­è®¡ç®—æœºä½•æ—¶å¯ä»¥æŠŠæ•°æ®å‘é€åˆ°è®¿é—®ä»‹è´¨ã€‚</p><p>&emsp;&emsp;é€šè¿‡ä½¿ç”¨CSMA/CDï¼Œæ‰€æœ‰è®¡ç®—æœºéƒ½ç›‘è§†ä¼ è¾“ä»‹è´¨çš„çŠ¶æ€ï¼Œåœ¨ä¼ è¾“ä¹‹å‰ç­‰å¾…çº¿è·¯ç©ºé—²ã€‚å¦‚æœä¸¤å°è®¡ç®—æœºå°è¯•åŒæ—¶å‘é€æ•°æ®ï¼Œå°±ä¼šå‘é€å†²çªï¼Œè®¡ç®—æœºå°±ä¼šåœæ­¢å‘é€ï¼Œç­‰å¾…ä¸€ä¸ªéšæœºçš„æ—¶é—´é—´éš”ï¼Œç„¶åå†æ¬¡å°è¯•å‘é€ã€‚<br>&emsp;&emsp;ä¼ ç»Ÿä»¥å¤ªç½‘ç»å¸¸ä½¿ç”¨è¿ç»­çš„é€šèµ°ç”µç¼†ä½œä¸ºä¼ è¾“ä»‹è´¨ã€‚<br>&emsp;&emsp;ç°ä»£ä»¥å¤ªç½‘çš„å½¢å¼éƒ½æ˜¯æŠŠè®¡ç®—æœºè¿æ¥åˆ°ä¸€ä¸ªç½‘ç»œè®¾å¤‡ä¸Šï¼ˆeg äº¤æ¢æœºï¼‰ã€‚</p><h4 id="3-6ã€å‰–æä»¥å¤ªç½‘å¸§"><a href="#3-6ã€å‰–æä»¥å¤ªç½‘å¸§" class="headerlink" title="3.6ã€å‰–æä»¥å¤ªç½‘å¸§"></a><strong>3.6ã€å‰–æä»¥å¤ªç½‘å¸§</strong></h4><p>&emsp;&emsp;ç½‘ç»œè®¿é—®å±‚çš„è½¯ä»¶ä»ç½‘é™…å±‚æ¥æ”¶æ•°æ®åŒ…ï¼ŒæŠŠå®ƒè½¬åŒ–ç¬¦åˆç‰©ç†ç½‘ç»œè§„åˆ™çš„å½¢å¼ã€‚åœ¨ä»¥å¤ªç½‘ä¸­ï¼Œç½‘ç»œè®¿é—®å±‚çš„è½¯ä»¶å¿…é¡»æŠŠæ•°æ®è½¬æ¢æˆèƒ½å¤Ÿé€šè¿‡ç½‘ç»œé€‚é…å™¨ç¡¬ä»¶è¿›è¡Œè½¬åŒ–çš„å½¢å¼ã€‚</p><p>&emsp;&emsp;ä»¥å¤ªç½‘è½¯ä»¶ä»ç½‘é™…å±‚æ¥æ”¶åˆ°æ•°æ®åŒ…ä¹‹åï¼Œæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><blockquote><ul><li>1ã€æ ¹æ®éœ€è¦æŠ¥ç½‘é™…å±‚çš„æ•°æ®åˆ†è§£ä¸ºè¾ƒå°çš„å—ï¼Œå·²å¤æ ¸ä»¥å¤ªç½‘å¸§æ•°æ®æ®µçš„è¦æ±‚ã€‚ä»¥å¤ªç½‘å¸§çš„æ•´ä½“å¤§å°å¿…é¡»åœ¨64å­—èŠ‚ä¸1518å­—èŠ‚ä¹‹é—´ï¼ˆä¸åŒ…æ‹¬å‰å¯¼ç ï¼‰ã€‚æœ‰äº›ç³»ç»Ÿæ”¯æŒé†‰å€’çš„å¸§ï¼Œæœ€å¤§å¯ä»¥åˆ°9000å­—èŠ‚ã€‚è¿™ç§å¤§å‹å¸§èƒ½å¤Ÿæ”¹å˜æ•ˆç‡ï¼Œä½†å­˜åœ¨ç€å…¼å®¹æ€§é—®é¢˜ï¼Œè€Œä¸”å¹¶æ²¡æœ‰å¾—åˆ°å¹¿æ³›æ”¯æŒã€‚</li><li>2ã€æŠŠæ•°æ®å—æ‰“åŒ…æˆå¸§ã€‚æ¯ä¸€å¸§éƒ½åŒ…å«æ•°æ®åŠå…¶ä»–ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯æ˜¯ä»¥å¤ªç½‘ç½‘ç»œé€‚é…å™¨å¤„ç†å¸§æ‰€éœ€è¦çš„ã€‚IEEE802.3ä»¥å¤ªç½‘å¸§åŒ…å«ä»¥ä¸‹å†…å®¹ã€‚<ul><li><strong>å‰å¯¼ç ï¼š</strong>è¡¨ç¤ºå¸§èµ·å§‹çš„ä¸€ç³»åˆ—æ¯”ç‰¹ï¼ˆå…±8å­—èŠ‚ï¼Œæœ€åä¸€ä¸ªå­—èŠ‚æ˜¯å¸§èµ·å§‹ç¬¦ï¼‰ã€‚</li><li><strong>ç›®æ ‡åœ°å€ï¼š</strong>æ¥æ”¶å¸§çš„ç½‘ç»œé€‚é…å™¨çš„6å­—èŠ‚ï¼ˆ48bitï¼‰ç‰©ç†åœ°å€ã€‚</li><li><strong>æºåœ°å€ï¼š</strong>å‘é€å¸§çš„ç½‘ç»œé€‚é…å™¨çš„6å­—èŠ‚ï¼ˆ48bitï¼‰ç‰©ç†åœ°å€ã€‚</li><li><strong>å¯é€‰VLANæ ‡è®°ï¼š</strong>è¿™ä¸ªå¯é€‰çš„16bitå­—æ®µåœ¨802.1qæ ‡å‡†ä¸­æœ‰è®²è§£ï¼Œå…¶ç›®çš„æ˜¯å…è®¸å¤šä¸ªè™šæ‹ŸLANå¯é€šè¿‡åŒä¸€ç½‘ç»œäº¤æ¢æœºè¿è¡Œã€‚ </li></ul>  <strong>é•¿åº¦ï¼š</strong>å¦ä¸ªå­—èŠ‚ï¼Œè¡¨ç¤ºæ•°æ®æ®µçš„é•¿åº¦ã€‚ <ul><li><strong>æ•°æ®ï¼š</strong>å¸§ä¸­ä¼ è¾“çš„æ•°æ®ã€‚</li><li><strong>å¸§æ ¡éªŒåºåˆ—ï¼ˆFCSï¼‰ï¼š</strong>å¸§çš„4å­—èŠ‚(32bit)æ ¡éªŒå’Œï¼ŒFCSæ˜¯æ ¡éªŒæ•°æ®ä¼ è¾“çš„å¸¸è§æ–¹å¼ã€‚å‘é€æ–¹è®¡ç®—å¸§çš„å¾ªç¯å†—ä½™ç æ ¡éªŒï¼ˆCRCï¼‰å€¼ï¼ŒæŠŠè¿™ä¸ªå€¼å†™åˆ°å¸§é‡Œã€‚æ¥æ”¶æ–¹è®¡ç®—æœºé‡æ–°è®¡ç®—CRCï¼Œä¸FCSå­—æ®µçš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœä¸¤ä¸ªå€¼ä¸æƒ³ç”¨ï¼Œå°±è¡¨ç¤ºä¼ è¾“è¿‡ç¨‹ä¸­å‘é€äº†æ•°æ®ä¸¢å¤±æˆ–æ”¹å˜ï¼Œè¿™æ—¶å°±éœ€è¦é‡æ–°ä¼ è¾“è¿™ä¸€å¸§ã€‚</li></ul></li><li>3ã€æŠŠæ•°æ®å¸§ä¼ é€’ç»™å¯¹åº”äºOSIæ¨¡å‹ç‰©ç†å±‚çš„åº•å±‚ç»„ä»¶ï¼Œåè€…æŠŠå¸§è½¬æ¢ä¸ºæ¯”ç‰¹æµï¼Œå¹¶ä¸”é€šè¿‡ä¼ è¾“ä»‹è´¨å‘é€å‡ºå»ã€‚</li></ul></blockquote><p>&emsp;&emsp;ä»¥å¤ªç½‘ä¸Šå…¶ä»–ç½‘ç»œé€‚é…å™¨æ¥æ”¶åˆ°è¿™ä¸ªå¸§ï¼Œæ£€æŸ¥å…¶ä¸­çš„ç›®çš„åœ°å€ï¼Œå¦‚æœç›®çš„åœ°å€ä¸ç½‘ç»œé€‚é…å™¨çš„åœ°å€ç›¸åŒ¹é…ï¼Œé€‚é…å™¨è½¯ä»¶å°±ä¼šå¤„ç†æ¥æ”¶åˆ°çš„å¸§ ï¼ŒæŠŠæ•°æ®ä¼ é€’ç»™åè®®æ ˆä¸­è¾ƒé«˜çš„å±‚ã€‚</p><h2 id="ç¬¬4ç« -ç½‘é™…å±‚"><a href="#ç¬¬4ç« -ç½‘é™…å±‚" class="headerlink" title="ç¬¬4ç«  ç½‘é™…å±‚"></a>ç¬¬4ç«  ç½‘é™…å±‚</h2><p>&emsp;&emsp;ç½‘é™…å±‚æä¾›çš„åè®®å°±è´Ÿè´£å±€åŸŸç½‘<code>ç½‘æ®µä¹‹å¤–çš„ä¼ é€’</code>ï¼Œå…¶ä¸­é‡è¦çš„åè®®åŒ…æ‹¬<code>IP</code>ã€<code>ARP</code>å’Œ<code>ICMP</code>ã€‚</p><h4 id="4-1ã€å¯»å€ä¸å‘é€"><a href="#4-1ã€å¯»å€ä¸å‘é€" class="headerlink" title="4.1ã€å¯»å€ä¸å‘é€"></a><strong>4.1ã€å¯»å€ä¸å‘é€</strong></h4><p>&emsp;&emsp;ä¸Šä¸€ç« ä¸­ï¼Œä»¥å¤ªç½‘å¡çš„ç‰©ç†å¯»å€æ–¹å¼é€‚åˆ<code>å•ä¸ªå±€åŸŸç½‘ç½‘æ®µ</code>ã€‚æœ‰ä¸é—´æ–­ä»‹è´¨è¿æ¥åœ¨ä¸€èµ·çš„è‹¥å¹²å°è®¡ç®—æœºåˆ©ç”¨ç‰©ç†åœ°å€å°±å¯ä»¥å®ç°æ‰€éœ€çš„åŠŸèƒ½ã€‚åªéœ€ä½¿ç”¨ç½‘ç»œè®¿é—®å±‚çš„ä½çº§åè®®å°±å¯ä»¥æŠŠæ•°æ®ä»ç½‘ç»œé€‚é…å™¨ç›´æ¥ä¼ é€’ç»™å¦ä¸€ä¸ªç½‘ç»œé€‚é…å™¨ã€‚</p><p>ä½¿ç”¨ARP</p><div align="center"><p><img src="/img/note_05/01.png" alt="å›¾4.1 ç½‘å…³æ¥æ”¶å»å¾€å…¶ä»–ç½‘ç»œçš„æ•°æ®æŠ¥"></p></div>    1. å¦‚æœç›®çš„åœ°å€ä¸æºåœ°å€åœ¨åŒä¸€ä¸ªç½‘æ®µï¼Œæºè®¡ç®—æœºå°±æŠŠæ•°æ®åŒ…ç›´æ¥å‘é€ç»™ç›®çš„è®¡ç®—æœºã€‚IPåœ°å€å‘—ARPå³ç³»ä¸ºç‰©ç†åœ°å€ï¼Œæ•°æ®è¢«ç›´æ¥å‘é€åˆ°ç›®çš„ç½‘ç»œé€‚é…å™¨ã€‚2. å¦‚æœç›®çš„åœ°å€ä¸æºåœ°å€ä¸åœ¨ä¸€ä¸ªç½‘æ®µä¸Šï¼Œå°±æ‰§è¡Œå¦‚ä¸‹è¿‡ç¨‹ï¼š> a)ã€ç›´æ¥å°†æ•°æ®æŠ¥å‘é€ç»™ç½‘å…³ã€‚ç½‘å…³æ˜¯ä½äºå±€åŸŸç½‘ç½‘æ®µä¸Šçš„ä¸€ä¸ªè®¾å¤‡ï¼Œèƒ½å¤ŸæŠŠæ•°æ®æŠ¥è½¬å‘åˆ°å…¶ä»–ç½‘æ®µï¼ˆç½‘å…³åŸºæœ¬ç®—è·¯ç”±å™¨ï¼‰ã€‚ç½‘å…³åœ°å€å‘—ARPè§£æä¸ºç‰©ç†åœ°å€ï¼Œæ•°æ®è¢«å‘é€åˆ°ç½‘å…³çš„é€‚é…å™¨ã€‚> b)ã€æ•°æ®æŠ¥é€šè¿‡ç½‘å…³è¢«è·¯ç”±åˆ°è¾ƒé«˜çº§åˆ«çš„ç½‘æ®µï¼ˆå¦‚ä¸Šå›¾4.1ï¼‰,å†æ¬¡é‡å¤ä¸Šè¿°è¿‡ç¨‹ã€‚å¦‚æœç›®çš„åœ°å€åœ¨è¿™ä¸ªæ–°ç½‘æ®µé‡Œï¼Œæ•°æ®å°±è¢«å‘é€åˆ°ç›®çš„ï¼Œå¦åˆ™æ•°æ®æŠ¥å°±ä¼šè¢«å‘é€åˆ°å¦ä¸€ç½‘å…³ã€‚> c)ã€æ•°æ®æŠ¥ç»è¿‡ä¸€ç³»åˆ—ç½‘å…³è¢«è½¬å‘åˆ°ç›®çš„ç½‘æ®µï¼Œç›®çš„IPåœ°å€è¢«ARPè§£æä¸ºç‰©ç†åœ°å€ï¼Œæ•°æ®è¢«å‘é€åˆ°ç›®çš„ç½‘ç»œé€‚é…å™¨ã€‚<p>  ä¸ºäº†åœ¨å¤æ‚çš„è·¯ç”±å¼ç½‘ç»œä¸­ä¼ è¾“æ•°æ®ï¼Œç½‘é™…å±‚åè®®å¿…é¡»å…·æœ‰ä»¥ä¸‹åŠŸèƒ½ï¼š</p><blockquote><ul><li>è¯†åˆ«ç½‘ç»œå€¼ç­è´¹æ‰€ä»¥è®¡ç®—æœºï¼›</li><li>æä¾›ä¸€ç§æ–¹å¼æ¥åˆ¤æ–­ä½•æ—¶éœ€è¦é€šè¿‡ç½‘å…³æ¥ä¼ é€’æ¶ˆæ¯ã€‚</li><li>æä¾›ä¸€ç§ä¸ç¡¬ä»¶æ— å…³çš„æ–¹å¼æ¥æ˜¯è¢«ç›®çš„ç½‘å…³ï¼Œä»è€Œè®©æ•°æ®æŠ¥èƒ½å¤Ÿé«˜æ•ˆç‡åœ°ç»è¿‡è·¯ç”±å™¨åˆ°è¾¾æ­£ç¡®çš„ç½‘æ®µï¼›</li><li>æä¾›ä¸€ç§æ–¹å¼æŠŠç›®æ ‡è®¡ç®—æœºçš„é€»è¾‘IPåœ°å€è½¬åŒ–ä¸ºç‰©ç†åœ°å€ï¼Œè®©æ•°æ®èƒ½å¤Ÿä¼ è¾“ç»™ç›®çš„è®¡ç®—æœºçš„ç½‘ç»œé€‚é…å™¨ã€‚</li></ul></blockquote><h4 id="4-2ã€ç½‘é™…åè®®ï¼ˆIPï¼‰"><a href="#4-2ã€ç½‘é™…åè®®ï¼ˆIPï¼‰" class="headerlink" title="4.2ã€ç½‘é™…åè®®ï¼ˆIPï¼‰"></a><strong>4.2ã€ç½‘é™…åè®®ï¼ˆIPï¼‰</strong></h4><p>&emsp;&emsp;IPåè®®æä¾›äº†ä¸€ç§åˆ†å±‚çš„ã€ä¸ç¡¬ä»¶æ— å…³çš„å¯»å€ç³»ç»Ÿï¼Œå…·æœ‰åœ¨å¤æ‚çš„è·¯ç”±å¼ç½‘ç»œä¸­ä¼ é€’æ•°æ®æ‰€éœ€çš„æœåŠ¡ã€‚TCP/IPç½‘ç»œä¸Šçš„æ¯ä¸€ç½‘ç»œé€‚é…å™¨éƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„IPã€‚</p><p>IPåœ°å€åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†:</p><blockquote><ul><li>ç½‘ç»œID</li><li>ä¸»æœºID</li></ul></blockquote><p>åˆ†ç±»çš„å¯»å€ç³»ç»Ÿå’ŒCIDRï¼ˆæ— ç±»åˆ«åŸŸé—´è·¯ç”±é€‰æ‹©ï¼‰å¯»å€ã€‚<br>å­ç½‘åˆ’åˆ†</p><p>&emsp;&emsp;æ¯ä¸€ä¸ªIPæ•°æ®æŠ¥éƒ½ä»¥ä¸€ä¸ªIPæŠ¥å¤´å¼€å§‹ã€‚æºTCP/IPè½¯ä»¶æ„é€ è¿™ä¸ªIPæŠ¥å¤´ã€‚ç›®çš„è®¡ç®—æœºçš„TCP/IPè½¯ä»¶åˆ©ç”¨IPæŠ¥å¤´ä¸­å°è£…çš„ä¿¡æ¯å¤„ç†æ•°æ®ã€‚IPæŠ¥å¤´åŒ…å«å¤§é‡ä¿¡æ¯ã€‚åŒ…æ‹¬<code>æºIPåœ°å€</code>ã€<code>ç›®çš„IPåœ°å€</code>ã€<code>æ•°æ®æŠ¥é•¿åº¦</code>ã€<code>IPç‰ˆæœ¬å·</code>å’Œå¯¹<code>è·¯ç”±å™¨</code>çš„<code>ç‰¹æ®ŠæŒ‡ä»¤</code>ã€‚</p><p>&emsp;&emsp;IPæŠ¥å¤´çš„æœ€å°é•¿åº¦æ˜¯20å­—èŠ‚ï¼Œå›¾4.3æ‰€ç¤ºä¸ºIPæŠ¥å¤´çš„å†…å®¹ã€‚</p><blockquote><ul><li><strong>ç‰ˆæœ¬ï¼š</strong>è¿™ä¸ª4ä½å­—æ®µè¡¨ç¤ºæ‰€ä½¿ç”¨çš„IPç‰ˆæœ¬ã€‚ç›®å‰IPç‰ˆæœ¬æ˜¯4ï¼Œç›¸åº”çš„äºŒè¿›åˆ¶æ˜¯0100</li><li><strong>ç½‘é™…æŠ¥å¤´é•¿åº¦(IHL)ï¼š</strong>è¿™4ä½è‡ªè¯»è¡¨ç¤ºIPæŠ¥å¤´ä»¥32ä½å­—ä¸ºå•ä½çš„é•¿åº¦ã€‚IPæŠ¥å¤´çš„æœ€å°é•¿åº¦æ˜¯5ä¸ª32æ¯”ç‰¹å­—ï¼Œç›¸åº”çš„äºŒè¿›åˆ¶è¡¨ç¤º0101ã€‚</li><li><strong>æœåŠ¡ç±»å‹ï¼š</strong>æºIPèƒ½å¤ŸæŒ‡å®šç‰¹æ®Šçš„è€Œè·¯ç”±ä¿¡æ¯ã€‚æœ‰äº›è·¯ç”±å™¨ä¼šå¿½ç•¥è¿™ä¸ªå­—æ®µçš„ä¿¡æ¯ã€‚ä½†éšç€æœåŠ¡è´¨é‡ï¼ˆQosï¼‰æŠ€æœ¯çš„å‡ºç°ï¼Œè¿™ä¸ªå­—æ®µå¾—åˆ°äº†æ›´å¤šçš„é‡è§†ï¼Œè¿™ä¸ª8ä½å­—æ®µçš„ä¸»è¦ç”¨é€”æ˜¯å¯¹ç­‰å¾…é€šè¿‡è·¯ç”±å™¨çš„æ•°æ®æŠ¥åŒºåˆ†ä¼˜å…ˆçº§ï¼Œè€Œç›®å‰å¤§å¤šæ•°IPå®ç°æŠŠæ˜¯è¿™ä¸ªå­—æ®µå…¨å¡«ä¸º0</li><li><strong>æ€»é•¿åº¦ï¼š</strong>è¿™ä¸ª16ä½çš„å­—æ®µè¡¨ç¤ºIPæ•°æ®æŠ¥çš„é•¿åº¦ï¼Œå•ä½æ˜¯å­—èŠ‚ï¼Œè¿™ä¸ªé•¿åº¦åŒ…å«äº†IPæŠ¥å¤´å’Œæ•°æ®è½½è·ã€‚</li><li><strong>æ ‡è¯†ï¼š</strong>è¿™ä¸ª16ä½çš„å­—æ®µæ˜¯ä¸€ä¸ªä¾åºå˜å¤§çš„æ•°å€¼ï¼Œåˆ†é…ç»™æºIPå‘å‡ºçš„æ¶ˆæ¯ã€‚å½“ä¼ é€’åˆ°IPå±‚çš„æ¶ˆæ¯å¤ªå¤§è€Œä¸èƒ½æ”¾åˆ°ä¸€ä¸ªæ•°æ®æŠ¥é‡Œæ—¶ï¼ŒIPä¼šæŠŠæ¶ˆæ¯æŸ¥åˆ†åˆ°å¤šä¸ªæ•°æ®æŠ¥ï¼Œå¹¶å¯¹è¿™äº›æ•°æ®æŠ¥æ’åºåˆ†é…ç›¸åŒçš„æ ‡è¯†å·ã€‚æ¥æ”¶ç«¯åˆ©ç”¨è¿™äº›æ•°å€¼é‡ç»„ä¸ºåŸå§‹æ¶ˆæ¯ã€‚</li><li><strong>æ ‡è®°ï¼š</strong>è¿™ä¸ªå­—æ®µè¡¨ç¤ºåˆ†æ®µå¯èƒ½æ€§ã€‚ç¬¬1ä½æœªä½¿ç”¨ï¼Œå…¶å€¼åº”è¯¥ä¸º0.ç¬¬2ä½ä¸ºDF(ä¸åˆ†æ®µ)ï¼Œè¡¨ç¤ºæ˜¯å¦å…è®¸åˆ†æ®µï¼Œ0è¡¨ç¤ºåˆ†æ®µï¼Œ1è¡¨ç¤ºä¸å…è®¸ã€‚ç¬¬3ä½æ˜¯MFï¼ˆæ›´å¤šåˆ†æ®µï¼‰ï¼Œè¡¨ç¤ºæ˜¯å¦è¿˜æœ‰åˆ†æ®µæ­£åœ¨ä¼ è¾“ï¼Œè®¾ç½®ä¸º0è¡¨ç¤ºæ²¡æœ‰æ›´å¤šåˆ†æ®µéœ€è¦å‘é€ï¼Œæˆ–æ˜¯æ•°æ®æŠ¥æ ¹æœ¬æ²¡æœ‰åˆ†æ®µã€‚</li><li><strong>åˆ†æ®µä½ç§»ï¼š</strong>è¿™ä¸ª13ä½çš„å­—æ®µæ˜¯ä¸€ä¸ªæ•°å€¼ï¼Œè¢«èµ‹äºˆæ¯ä¸ªè¿ç»­çš„åˆ†æ®µã€‚ç›®çš„è®¾å¤‡IPåˆ©ç”¨è¿™ä¸ªå€¼ä»¥æ­£ç¡®çš„æ¬¡åºé‡ç»„åˆ†æ®µã€‚è¿™ä¸ªæ•°å€¼ä½¿ç”¨çš„å•ä½æ˜¯8å­—èŠ‚ã€‚</li><li><strong>ç”Ÿå­˜æ—¶é—´ï¼ˆTTLï¼‰ï¼š</strong>è¿™ä¸ªå­—æ®µè¡¨ç¤ºæ•°æ®æŠ¥åœ¨è¢«æŠ›å¼ƒä¹‹å‰èƒ½å¤Ÿä¿ç•™çš„æ—¶é—´ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰æˆ–è·¯ç”±å™¨è·³æ•°ã€‚æ¯ä¸ªè·¯ç”±å™¨éƒ½ä¼šæ£€æŸ¥è¿™ä¸ªå­—æ®µï¼Œå¹¶ä¸”è‡³å°‘æŠŠå®ƒå‡å»1ï¼Œæˆ–æ•°æ®æŠ¥åœ¨è·¯ç”±å™¨ä¸­å»¶è¿Ÿçš„ç§’æ•°ã€‚å½“è¿™ä¸ªå­—æ®µçš„å€¼ä¸º0æ—¶ï¼Œæ•°æ®æŠ¥å°±ä¼šè¢«æŠ›å¼ƒã€‚<br>è·³æ•°ï¼šä»£è¡¨æ•°æ®æŠ¥åˆ°è¾¾ç›®çš„ä¹‹å‰å¿…é¡»ç»è¿‡çš„è·¯ç”±å™¨çš„æ•°é‡ã€‚å¦‚æœæ•°æ®æŠ¥åœ¨åˆ°è¾¾ç›®çš„ä¹‹å‰ç»è¿‡äº†5ä¸ªè·¯ç”±å™¨ï¼Œæˆ‘ä»¬å°±è¯´è·ç¦»ç›®çš„æœ‰5è·³ã€‚</li><li><strong>åè®®ï¼š</strong>è¿™ä¸ª8ä½çš„å­—æ®µè¡¨ç¤ºæ¥æ”¶æ•°æ®è½½è·çš„åè®®ï¼Œæ¯”å¦‚åè®®æ ‡è¯†ä¸º6ï¼ˆäºŒè¿›åˆ¶00000110ï¼‰çš„æ•°æ®æŠ¥ä¼šè¢«ä¼ é€’åˆ°TCPæ¨¡å—ï¼Œä¸‹é¢ä¸ºä¸€äº›å¸¸è§çš„åè®®æ ‡è¯†å€¼ã€‚ICMP:1ï¼ŒTCP:6ï¼ŒUDP:17ã€‚</li><li><strong>æŠ¥å¤´æ ¡éªŒå’Œï¼š</strong>è¿™ä¸ªå­—æ®µåŒ…å«16ä½çš„æ ¡éªŒå’Œï¼Œåªç”¨äºæ£€éªŒæŠ¥å¤´æœ¬èº«çš„æœ‰æ•ˆæ€§ï¼Œæ•°æ®æŠ¥ç»è¿‡çš„æ¯ä¸ªè·¯ç”±å™¨éƒ½ä¼šå¯¹è¿™ä¸ªå€¼è¿›è¡Œé‡æ–°è®¡ç®—ï¼Œå› ä¸ºTTLå­—æ®µçš„å€¼æ˜¯åœ¨ä¸æ–­å˜åŒ–çš„ã€‚</li><li><strong>æºIPåœ°å€ï¼š</strong>è¿™ä¸ª32ä½å­—æ®µåŒ…å«äº†æ•°æ®æŠ¥çš„æºIPåœ°å€ã€‚</li><li><strong>ç›®çš„IPåœ°å€ï¼š</strong>è¿™ä¸ª32ä½çš„å­—æ®µåŒ…å«äº†æ•°æ®æŠ¥çš„ç›®çš„IPåœ°å€ã€‚ç›®çš„IPæ ¹æ®è¿™ä¸ªå€¼æ£€éªŒå‘é€çš„æ­£ç¡®æ€§ã€‚</li><li><strong>IPé€‰é¡¹ï¼š</strong>è¿™ä¸ªå­—æ®µæ”¯æŒä¸€äº›å¯é€‰çš„æŠ¥å¤´è®¾ç½®ï¼Œä¸»è¦ç”¨äºæµ‹è¯•ã€è°ƒè¯•å’Œå®‰å…¨çš„ç›®çš„ã€‚è¿™äº›é€‰é¡¹åŒ…æ‹¬ä¸¥æ ¼æºè·¯ç”±ï¼ˆæ•°æ®æŠ¥å¿…é¡»ç»è¿‡æŒ‡å®šçš„è·¯ç”±å™¨ï¼‰ã€ç½‘é™…æ—¶é—´æˆ³ï¼ˆç»è¿‡æ¯ä¸ªè·¯ç”±å™¨æ—¶çš„æ—¶é—´æˆ³è®°å½•ï¼‰å’Œå®‰å…¨é™åˆ¶ã€‚</li><li><strong>å¡«å……ï¼š</strong> IPé€‰é¡¹å­—æ®µçš„é•¿åº¦ä¸æ˜¯å›ºå®šçš„ã€‚å¡«å……å­—æ®µå¯ä»¥æä¾›ä¸€äº›é¢å¤–çš„0ï¼Œä»è€Œä¿è¯è¿™ä¸ªæŠ¥å¤´çš„é•¿åº¦æ˜¯32ä½çš„æ•´æ•°å€ï¼ˆæŠ¥å¤´é•¿åº¦å¿…é¡»æ˜¯32ä½å­—çš„æ•´æ•°å€ï¼Œå› ä¸ºâ€œç½‘é™…å¤´é•¿åº¦IHLâ€å­—æ®µä»¥32ä½å­—ä¸ºå•ä½è¡¨ç¤ºæŠ¥å¤´çš„é•¿åº¦ã€‚ï¼‰</li><li><strong>IPæ•°æ®è½½è·ï¼š</strong>è¿™ä¸ªå­—æ®µä¸€èˆ¬ç”¨äºä¿å­˜ä¼ è¾“ç»™TCPæˆ–UDP(åœ¨ä¼ è¾“å±‚)ã€ICMPæˆ–IGMPçš„æ•°æ®ã€‚æ•°æ®å—çš„é•¿åº¦ä¸å®šï¼Œå¯ä»¥åŒ…å«æ•°åƒå­—èŠ‚ã€‚</li></ul></blockquote><p>IPå¯»å€ï¼š<br>&emsp;&emsp;åœ°å€åˆ†ç±»ï¼š</p><blockquote><ul><li><strong>Aç±»åœ°å€ï¼š</strong> IPåœ°å€çš„å‰8ä½è¡¨ç¤ºç½‘ç»œIDï¼Œå24ä½è¡¨ç¤ºä¸»æœºIDã€‚32ä½åœ°å€ä»¥0å¼€å¤´ã€‚</li><li><strong>Bç±»åœ°å€ï¼š</strong> IPåœ°å€çš„å‰16ä½è¡¨ç¤ºç½‘ç»œIDï¼Œå16ä½è¡¨ç¤ºä¸»æœºIDã€‚32ä½åœ°å€ä»¥10å¼€å¤´ã€‚</li><li><strong>Cç±»åœ°å€ï¼š</strong> IPåœ°å€çš„å‰24ä½è¡¨ç¤ºç½‘ç»œIDï¼Œå8ä½è¡¨ç¤ºä¸»æœºIDã€‚32ä½åœ°å€ä»¥110å¼€å¤´ã€‚</li></ul></blockquote><p>&emsp;&emsp;ä½¿ç”¨çš„ä½æ•°è¶Šå¤šï¼ŒåŒ…å«çš„ç»„åˆå°±è¶Šå¤šã€‚æ˜¾è€Œæ˜“è§ï¼ŒAç±»åœ°å€æä¾›äº†è¾ƒå°‘çš„ç½‘ç»œIDï¼Œä½†æ¯ä¸ªç½‘ç»œéƒ½å…·æœ‰å¤§é‡å¯ç”¨çš„ä¸»æœºIDã€‚è®¡ç®—æœºå’Œè·¯ç”±å™¨å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªIPåœ°å€æ˜¯Aç±»ã€Bç±»æˆ–Cç±»ï¼ŸTCP/IPåœ°å€è§„åˆ™ä½¿å¾—åœ°å€æœ¬èº«å°±å¯ä»¥è¯´æ˜å…¶åˆ†ç±»ï¼Œä»¥32ä¸ºåœ°å€çš„èµ·å§‹ã€‚</p><blockquote><p><strong>æ³¨æ„ï¼š</strong> Dç±»å’ŒEç±»<br>&emsp;&emsp;Internetè§„èŒƒè¿˜å®šä¹‰äº†ç‰¹æ®Šç”¨é€”çš„Dç±»åœ°å€å’ŒEç±»åœ°å€ï¼ŒDç±»åœ°å€ç”¨äºå¤šæ’­ã€‚å¤šæ’­æ˜¯æŠŠä¸€ä¸ªæ¶ˆæ¯å‘é€ç»™ç½‘ç»œçš„å­ç½‘ï¼Œè¿™ä¸å¹¿æ’­æ˜¯ä¸åŒçš„ï¼Œåè€…éœ€è¦ç½‘ç»œä¸Šå…¨éƒ¨èŠ‚ç‚¹éƒ½è¿›è¡Œå¤„ç†ï¼ŒDç±»åœ°å€æœ€å‰é¢4ä½æ˜¯1110ï¼Œå¯¹åº”åè¿›åˆ¶æ•°å€¼æ˜¯224<del>249ï¼ŒEç±»ç½‘ç»œæ˜¯å®éªŒæ€§è´¨çš„ï¼Œä¸€èˆ¬ä¸ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚Eç±»ç½‘ç»œåœ°å€æœ€å‰é¢çš„5ä½æ˜¯11110ï¼Œå¯¹åº”åè¿›åˆ¶æ•°å€¼240</del>247ã€‚</p></blockquote><p>&emsp;&emsp;ç½‘ç»œç®¡ç†å‘˜å¯ä»¥æŠŠç½‘ç»œåˆ’åˆ†ä¸ºæ›´å°çš„æ¬¡çº§ç½‘ç»œï¼Œè¿™è¢«ç§°ä¸ºå­ç½‘ã€‚è¯è´¹å­ç½‘çš„æ˜¯æŒ‡å°±æ˜¯å€Ÿç”¨ä¸»æœºIDä¸­çš„ä¸€äº›ä½ï¼Œåœ¨ç½‘ç»œå†…åˆ›å»ºé¢å¤–çš„ç½‘ç»œã€‚æ ¹æ®å‰é¢çš„åˆ†ç±»ä»‹ç»ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“æƒ³åˆ°å…·æœ‰å¤§é‡ä¸»æœºIDçš„Aç±»å’ŒBç±»åœ°å€ä¼šå¹¿æ³›ä½¿ç”¨å­ç½‘åˆ’åˆ†æŠ€æœ¯ã€‚å½“å‰Cç±»ç½‘ç»œä¹Ÿä¼šä½¿ç”¨å­ç½‘åˆ’åˆ†æŠ€æœ¯ã€‚è¯¦è§ç¬¬5ç« ã€‚</p><blockquote><p><strong>æ³¨æ„ï¼š</strong>åœ°å€æ˜¯å¦å”¯ä¸€<br>&emsp;&emsp;ä»ç†è®ºä¸Šå°†ï¼ŒInternetä¸Šæ¯å°è®¡ç®—æœºéƒ½å¿…é¡»æœ‰ä¸€ä¸ªå”¯ä¸€çš„IPåœ°å€ã€‚åœ¨å®é™…åº”ç”¨ä¸­ï¼Œä»£ç†æœåŠ¡å™¨è½¯ä»¶å’ŒNATè®¾å¤‡çš„ä½¿ç”¨è®©æœªæ³¨å†Œå’Œéå”¯ä¸€çš„åœ°å€ä¹Ÿå¯ä»¥è¿æ¥Internetã€‚ç¬¬12ç« è®²è§£NATè®¾å¤‡ã€‚</p></blockquote><h4 id="4-3ã€ARP"><a href="#4-3ã€ARP" class="headerlink" title="4.3ã€ARP"></a><strong>4.3ã€ARP</strong></h4><p>&emsp;&emsp;ç½‘æ®µä¸Šçš„æ²¡å¤ªæ³¨è®°åœ¨å†…å­˜ä¸­éƒ½ä¿å­˜ç€ä¸€ä¸ªè¢«ç§°ä¸ºARPè¡¨æˆ–ARPç¼“å­˜çš„è¡¨æ ¼ï¼Œå…¶ä¸­åŒ…å«ç½‘æ®µä¸Šå…¶ä»–ä¸»æœºIPåœ°å€ä¸ç‰©ç†åœ°å€å¯¹åº”å…³ç³»ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å½“ä¸»æœºéœ€è¦å‘ç½‘æ®µä¸Šçš„å…¶ä»–å•Šä¸»æœºå‘é€æ•°æ®æ—¶ï¼Œå®ƒä¼šæŸ¥çœ‹ARPç¼“å­˜æ¥è·å–ç›®çš„çš„ç‰©ç†åœ°å€ï¼ŒARPç¼“å­˜æ˜¯åŠ¨æ€å˜åŒ–ã€‚å¦‚æœè¦æ¥æ”¶æ•°æ®çš„åœ°å€å½“å‰å¹¶ä¸å­˜åœ¨ä¸ARPç¼“å­˜ï¼Œä¸»æœºå°±ä¼šå‘é€åä¸ºARPè¯·æ±‚å¸§çš„å¹¿æ’­ã€‚</span><br><span class="line">ARPè¯·æ±‚å¸§åŒ…å«æœªè§£æçš„IPåœ°å€ï¼Œè¿˜åŒ…å«å‘é€è¿™ä¸ªè¯·æ±‚çš„ä¸»æœºIPåœ°å€å’Œç‰©ç†åœ°å€ã€‚ç½‘æ®µä¸Šçš„å…¶ä»–ä¸»æœºæ¥æ”¶åˆ°è¿™ä¸ªARPè¯·æ±‚ï¼Œæ‹¥æœ‰è¿™ä¸ªæœªè§£æIPåœ°å€çš„ä¸»æœºä¼šå‘å‘å‡ºè¯·æ±‚çš„ä¸»æœºå‘é€è‡ªå·±çš„ç‰©ç†åœ°å€ã€‚è¿™ä¸ªæ–°çš„IPåœ°å€å’Œç‰©ç†åœ°å€çš„å¯¹åº”å…³ç³»å°±ä¼šæ·»åŠ åˆ°è¯·æ±‚ä¸»æœºçš„ARPç¼“å­˜é‡Œã€‚</span><br></pre></td></tr></table></figure><h4 id="4-4ã€RARP"><a href="#4-4ã€RARP" class="headerlink" title="4.4ã€RARP"></a><strong>4.4ã€RARP</strong></h4><p>&emsp;&emsp;RARPçš„å«ä¹‰æ˜¯é€†å‘ARPï¼Œå½“çŸ¥é“IPåœ°å€è€Œä¸çŸ¥é“ç‰©ç†åœ°å€ä½¿ç”¨ARPï¼›è€Œåœ¨çŸ¥é“ç‰©ç†åœ°å€è€Œä¸çŸ¥é“IPåœ°å€æ—¶ï¼Œåˆ™ä½¿ç”¨RARPã€‚<br>RARPç»å¸¸ä¸BOOTPåè®®å…±åŒä½¿ç”¨æ¥å¯åŠ¨æ— ç›˜å·¥ä½œç«™ã€‚</p><p><strong>æ³¨ï¼š</strong> BOOTP(å¯åŠ¨PROM)</p><blockquote><p>å¾ˆå¤šç½‘ç»œé€‚é…å™¨å…·æœ‰ä¸€ä¸ªç©ºçš„æ’æ§½ï¼Œæ”¯æŒè¢«ç§°ä¸ºâ€œå¯åŠ¨PROMâ€çš„é›†æˆç”µè·¯ã€‚è®¡ç®—æœºä¸€åŠ ç”µï¼ŒPROMå›ºä»¶å°±ä¼šå¯åŠ¨ï¼Œä»ç½‘ç»œæœåŠ¡å™¨è€Œä¸æ˜¯æœ¬åœ°ç¡¬ç›˜æ¥è¯»å–å¹¶åŠ è½½æ“ä½œç³»ç»Ÿï¼Œä¸‹è½½åˆ°BOOTPè®¾å¤‡çš„æ“ä½œç³»ç»Ÿè¢«é¢„é…ç½®ä¸ºç‰¹å®šçš„IPåœ°å€ã€‚</p></blockquote><h4 id="4-5ã€Internetæ§åˆ¶æ¶ˆæ¯åè®®ï¼ˆICMPï¼‰"><a href="#4-5ã€Internetæ§åˆ¶æ¶ˆæ¯åè®®ï¼ˆICMPï¼‰" class="headerlink" title="4.5ã€Internetæ§åˆ¶æ¶ˆæ¯åè®®ï¼ˆICMPï¼‰"></a><strong>4.5ã€Internetæ§åˆ¶æ¶ˆæ¯åè®®ï¼ˆICMPï¼‰</strong></h4><p>&emsp;&emsp;å‘é€åˆ°è¿œç¨‹è®¡ç®—æœºçš„æ•°æ®é€šå¸¸ä¼šç»è¿‡ä¸€ä¸ªæˆ–å¤šä¸ªè·¯ç”±å™¨ï¼Œè¿™äº›è·¯ç”±å™¨åœ¨æŠŠæ•°æ®ä¼ è¾“åˆ°æœ€ç»ˆç›®çš„åœ°çš„è¿‡ç¨‹ä¸­å¯èƒ½å‘ç”Ÿå¤šç§é—®é¢˜ã€‚è·¯ç”±å™¨åˆ©ç”¨Internetæ§åˆ¶æ¶ˆæ¯åè®®ï¼ˆICMPï¼‰æ¶ˆæ¯æŠŠé—®é¢˜é€šçŸ¥ç»™æºIPï¼ŒICMPè¿˜æœ‰ç”¨äºå…¶ä»–è°ƒè¯•å’Œæ’é”™çš„åŠŸèƒ½ã€‚<br>å¸¸è§çš„ICMPæ¶ˆæ¯ï¼š</p><blockquote><ul><li><strong>Echo Requestï¼ˆå›æ˜¾è¯·æ±‚ï¼‰å’ŒEcho Replyï¼ˆå›æ˜¾åº”ç­”ï¼‰ï¼š</strong> ICMPç»å¸¸è¢«ç”¨äºæµ‹è¯•ï¼Œæ¯”å¦‚æµ‹è¯•è¿æ¥çš„pingå‘½ä»¤å®é™…å°±æ˜¯åœ¨ä½¿ç”¨ICMPã€‚</li><li><strong>Source Quenchï¼ˆæºæŠ‘åˆ¶ï¼‰ï¼š</strong>å¦‚æœä»¥å¤ªå‘Šè¯‰è®¡ç®—æœºå‘è¿œç¨‹è®¡ç®—æœºå‘é€å¤§é‡æ•°æ®ï¼Œå¯èƒ½ä¼šä½¿è·¯ç”±å™¨äº§ç”Ÿè¿‡è½½ã€‚è¿™æ—¶è·¯ç”±å™¨å¯ä»¥åˆ©ç”¨ICMOå‘æºIPå‘é€Source Quenchæ¶ˆæ¯ï¼Œè®©å®ƒé™ä½å‘é€æ•°æ®çš„é€Ÿåº¦ã€‚å¦‚æœå¿…è¦ï¼Œè¿˜å¯ä»¥å‘æºIPå‘é€é¢å¤–çš„æºæŠ‘åˆ¶æ¶ˆæ¯ã€‚</li></ul></blockquote><blockquote><ul><li><strong>Destination Unreachableï¼ˆç›®çš„ä¸å¯åˆ°è¾¾ï¼‰ï¼š</strong>å¦‚æœè·¯ç”±å™¨æ”¶åˆ°ä¸€ä¸ªä¸èƒ½ä¼ é€’çš„æ•°æ®æŠ¥ï¼ŒICMPå°±ä¼šå‘æºIPè¿”å›ä¸€ä¸ªDestination Unreachableæ¶ˆæ¯ã€‚è·¯ç”±å™¨ä¸èƒ½ä¼ é€’æ¶ˆæ¯çš„åŸå› ä¹‹ä¸€æ˜¯ç½‘ç»œç”±äºè®¾å¤‡æ•…éšœæˆ–ç»´ä¿®è€Œå…³é—­ã€‚</li></ul></blockquote><blockquote><ul><li><strong>Time Exceededï¼ˆè¶…æ—¶ï¼‰ï¼š</strong>å½“æ•°æ®æŠ¥ç”±äºTTLä¸º0è€Œè¢«æŠ›å¼ƒæ—¶ï¼ŒICMPå°±ä¼šå‘æºIPå‘é€è¿™ä¸ªæ¶ˆæ¯ã€‚è¿™è¡¨ç¤ºå¯¹äºå½“å‰TTLå€¼æ¥è¯´ï¼Œåˆ°è¾¾ç›®æ ‡éœ€è¦ç»è¿‡å¤§å¤šè·¯ç”±å™¨ï¼›æˆ–è€…æ˜¯è¯´æ˜è·¯ç”±è¡¨å‡ºäº†é—®é¢˜ï¼Œå¯¼è‡´æ•°æ®æŠ¥åœ¨åŒä¸€è·¯ç”±å™¨ä¸Šè¿ç»­å¾ªç¯ã€‚</li><li>å½“æ•°æ®æŠ¥æ— çº¿å¾ªç¯ä¸”æ°¸è¿œä¸èƒ½åˆ°è¾¾ç›®çš„åœ°æ—¶ï¼Œå°±ä¼šå‘ç”Ÿè·¯ç”±ç¯è·¯ã€‚3å°è·¯ç”±å™¨A,B,Cï¼ŒA-&gt;Bå‘é€ä¸€ä¸ªæ•°æ®æŠ¥ï¼ŒB-&gt;Cï¼ŒC-&gt;Aå°±ä¼šå½¢æˆè·¯ç”±ç¯è·¯ï¼Œæ•°æ®æŠ¥é™·å…¥å…¶ä¸­ï¼Œä¸æ–­åœ¨3å°è·¯ç”±å™¨ä¹‹é—´å¾ªç¯ï¼ŒçŸ¥é“TTLä¸º0ã€‚è¿˜æœ‰ä¸€ç§æ˜¯å½“ç½‘ç»œç®¡ç†å‘˜åœ¨è·¯ç”±è¡¨ä¸­è®¾ç½®ä¸€æ¡é™æ€è·¯ç”±æ—¶ï¼Œæœ‰æ—¶å°±å¯èƒ½å¯¼è‡´ç¯è·¯è·¯ç”±ã€‚</li><li><strong>Fragmentation Neededï¼ˆéœ€è¦åˆ†æ®µï¼‰ï¼š</strong>å¦‚æœä¸€ä¸ªæ•°æ®æŠ¥çš„â€œDonâ€™t Dragmentï¼ˆä¸å¯åˆ†è§£ï¼‰â€ä½è¢«è®¾ç½®ä¸º1ï¼Œè€Œè·¯ç”±å™¨å¿…é¡»è¦å¯¹æ•°æ®æŠ¥è¿›è¡Œåˆ†æ®µæ‰èƒ½æŠŠå®ƒè½¬å‘åˆ°ä¸‹ä¸€å°è·¯ç”±å™¨æˆ–ç›®çš„åœ°ï¼Œè¿™æ—¶ICMPå°±ä¼šå‘å‡ºè¿™æ¡æ¶ˆæ¯ã€‚</li></ul></blockquote><h4 id="4-6ã€ç½‘é™…å±‚å…¶ä»–åè®®"><a href="#4-6ã€ç½‘é™…å±‚å…¶ä»–åè®®" class="headerlink" title="4.6ã€ç½‘é™…å±‚å…¶ä»–åè®®"></a><strong>4.6ã€ç½‘é™…å±‚å…¶ä»–åè®®</strong></h4><p>&emsp;&emsp;ç”¨äºè·¯ç”±è¿›ç¨‹çš„<code>è¾¹ç•Œç½‘å…³åè®®ï¼ˆGBPï¼‰</code>å’Œ<code>è·¯ç”±ä¿¡æ¯åè®®ï¼ˆRIPï¼‰</code>ã€‚<br>&emsp;&emsp;IPSecåè®®åœ¨IPv4é‡Œæ˜¯å¯é€‰çš„ï¼Œä½†åœ¨IPv6é‡Œæ˜¯å¿…éœ€çš„ã€‚å®ƒä¹Ÿå·¥ä½œäºç½‘é™…å±‚ï¼Œæä¾›ä¸€ä¸ªå®‰å…¨çš„åŠ å¯†é€šä¿¡ã€‚</p><p>&emsp;&emsp;IPæä¾›äº†ä¸€ç§ä¸ç¡¬ä»¶æ— å…³çš„å¯»å€ç³»ç»Ÿã€‚<br>&emsp;&emsp;ARPæ˜¯æŠŠIPåœ°å€è§£æä¸ºç‰©ç†åœ°å€çš„åè®®ï¼ŒRARPæ˜¯ARPçš„é€†è¿‡ç¨‹ã€‚<br>&emsp;&emsp;ICMPæ˜¯ç”¨äºè¯Šæ–­å’Œæµ‹è¯•çš„åè®®ã€‚</p><h2 id="ç¬¬5ç« -å­ç½‘åˆ’åˆ†å’ŒCIDR"><a href="#ç¬¬5ç« -å­ç½‘åˆ’åˆ†å’ŒCIDR" class="headerlink" title="ç¬¬5ç«  å­ç½‘åˆ’åˆ†å’ŒCIDR"></a>ç¬¬5ç«  å­ç½‘åˆ’åˆ†å’ŒCIDR</h2><h4 id="5-1ã€å­ç½‘"><a href="#5-1ã€å­ç½‘" class="headerlink" title="5.1ã€å­ç½‘"></a><strong>5.1ã€å­ç½‘</strong></h4><p>&emsp;&emsp;å­ç½‘åˆ’åˆ†å¯ä»¥å°†ç½‘ç»œåˆ†è§£ä¸ºè¢«ç§°ä½å­ç½‘çš„è¾ƒå°å•å…ƒã€‚å­ç½‘çš„æ¦‚å¿µæœ€æœ€æ—©æ˜¯æºè‡ªäºåœ°å€åˆ†ç±»ç³»ç»Ÿçš„ã€‚ ç„¶åï¼Œç¡¬ä»¶å‚å•†å’ŒInternetç¤¾åŒºå»ºç«‹äº†ä¸€ç§è§£æåœ°å€çš„æ–°ç³»ç»Ÿï¼Œåä¸ºCIDR(æ— ç±»åˆ«åŸŸé—´è·¯ç”±)ï¼Œå®ƒéœ€è¦å…³å¿ƒåœ°å€ç±»åˆ«ã€‚</p><h4 id="5-2ã€åˆ’åˆ†ç½‘ç»œ"><a href="#5-2ã€åˆ’åˆ†ç½‘ç»œ" class="headerlink" title="5.2ã€åˆ’åˆ†ç½‘ç»œ"></a><strong>5.2ã€åˆ’åˆ†ç½‘ç»œ</strong></h4><p>&emsp;&emsp;ç¬¬4ç« ä»‹ç»åœ°å€åˆ†ç±»ç³»ç»Ÿè®©æ‰€æœ‰çš„ä¸»æœºèƒ½å¤Ÿè¯†åˆ«IPåœ°å€ä¸­çš„ç½‘ç»œIDï¼Œä»è€ŒæŠŠæ•°æ®åŒ…å‘é€ä¸ªæ­£ç¡®çš„ç½‘ç»œã€‚ä½†æ˜¯æ ¹æ®Aç±»Bç±»Cç±»ç½‘ç»œIDæ¥è¯†åˆ«ç½‘æ®µå…·æœ‰ä¸€äº›å±€é™æ€§ã€‚ä¸»è¦æ˜¯åœ¨ç½‘ç»œçº§åˆ«ä¹‹ä¸‹ä¸èƒ½å¯¹åœ°å€æ§ä»¶è¿›è¡Œä»»ä½•é€»è¾‘ç»†åˆ†ã€‚<br>egï¼š</p><div align="center"><p><img src="/img/note_05/02.png" alt="å›¾5.1 å°†æ•°æ®å‘é€åˆ°Aç±»ç½‘ç»œ"></p></div>  &emsp;&emsp;å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ•°æ®æŠ¥åˆ°è¾¾ç½‘å…³ï¼Œç„¶åä¼ è¾“åˆ°99.0.0.0åœ°å€æ§ä»¶ï¼Œä½†å¦‚ä½•è¦è€ƒè™‘å®ƒåœ¨è¿™ä¸ªåœ°å€æ§ä»¶ä¸­æ˜¯å¦‚ä½•ä¼ é€’çš„ï¼Œå›¾ç¤ºä¼šéå¸¸å¤æ‚ï¼Œå› ä¸ºAç´¯ç½‘ç»œèƒ½å¤Ÿå®¹çº³è¶…è¿‡1600ä¸‡å°ä¸»æœºã€‚ä¸ºäº†åœ¨å¤§å‹ç½‘ç»œé‡Œå®ç°æ›´é«˜æ•ˆçš„æ•°æ®ä¼ è¾“ï¼Œåœ°å€ç©ºè¢«è¯åˆ’åˆ†ä¸ºè¾ƒå°çš„ç½‘æ®µï¼ˆå¦‚å›¾5.2ï¼‰ã€‚æŠŠç½‘ç»œåˆ’åˆ†ä¸ºç‹¬ç«‹çš„ç‰©ç†ç½‘ç»œèƒ½å¤Ÿå¢åŠ ç½‘ç»œçš„æ•´ä½“æ€§èƒ½ï¼Œä¹Ÿå°±èƒ½å¤Ÿè®©ç½‘ç»œä½¿ç”¨æ›´å¤§çš„åœ°å€ç©ºé—´ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œåœ°å€ç©ºé—´é‡Œåˆ’åˆ†ç½‘æ®µçš„è·¯ç”±å™¨éœ€è¦é€‚å½“çš„æŒ‡ç¤ºæ¥å†³å®šæ•°æ®ä¼ è¾“åˆ°å“ªé‡Œï¼Œä¸èƒ½ä½¿ç”¨ç½‘ç»œIDï¼Œå› ä¸ºä¼ è¾“åˆ°è¿™ä¸ªç½‘ç»œçš„æ•°æ®æŠ¥å…·æœ‰ç›¸åŒçš„ç½‘ç»œIDï¼ˆ99.0.0.0ï¼‰,éå¸¸éº»çƒ¦è€Œä¸”ä¸çµæ´»ã€ä¸å®ç”¨ã€‚å”¯ä¸€å¯è¡Œçš„è§£å†³æ–¹æ³•æ˜¯åœ¨ç½‘ç»œæ ‡IDä¸‹ï¼Œå¯¹åœ°å€ç©ºé—´è¿›è¡Œç»†åˆ†ï¼Œè®©æ³¨è®°å’Œè·¯ç”±å™¨èƒ½å¤Ÿæ ¹æ®IPåœ°å€åˆ¤æ–­åº”è¯¥æŠŠæ•°æ®å‘é€åˆ°å“ªä¸ªç½‘æ®µã€‚å­ç½‘åˆ’åˆ†å°±æ˜¯åœ¨ç½‘ç»œIDä¹‹ä¸‹æä¾›äº†ç¬¬äºŒå±‚é€»è¾‘ç»„ç»‡ï¼Œè·¯ç”±å™¨æœºèƒ½å¤ŸæŠŠæ•°æ®æŠ¥å‘é€ç»™ç½‘ç»œé‡Œçš„æŸä¸ªå­ç½‘åœ°å€ï¼ˆä¸€èˆ¬å¯¹åº”äºä¸€ä¸ªç½‘æ®µï¼‰ï¼Œè€Œå½“æ•°æ®æŠ¥åˆ°è¾¾å­ç½‘è‡ªåï¼Œå°±ä¼šè¢«ARPè§£ææˆç‰©ç†åœ°å€ã€‚é‚£ä¹ˆ`å­ç½‘åœ°å€`ä»ä½•è€Œæ¥ï¼Œ32ä½IPåœ°å€å·²ç»è¢«åˆ’åˆ†ä¸º`ç½‘ç»œID`å’Œ`ä¸»æœºID`ã€‚TCP/IPçš„è®¾è®¡è€…å€Ÿç”¨äº†ä¸»æœºIDé‡Œçš„ä¸€äº›ä½æ¥å½¢æˆå­ç½‘åœ°å€ã€‚ä¸€ä¸ªåä¸º`å­ç½‘æ©ç `çš„å‚æ•°æŒ‡å®šåœ°å€ä¸­çš„å¤šå°‘ä½ç”¨äº`å­ç½‘ID`ï¼Œä¿ç•™å¤šä¸ªä¸ºä½œä¸ºå®é™…çš„ä¸»æœºIDã€‚`å­ç½‘æ©ç `ä¹Ÿæ˜¯32ä½äºŒè¿›åˆ¶å€¼ï¼Œå®ƒçš„å½¢å¼èƒ½å¤Ÿè¯´æ˜ä¸ä¹‹ç›¸å…³çš„`IPåœ°å€`çš„`å­ç½‘ID`ã€‚&emsp;&emsp;åœ¨å­ç½‘ç½‘ç»œä¸Šï¼Œè·¯ç”±å™¨å’Œä¸»æœºæ‰€ä½¿ç”¨çš„`è·¯ç”±è¡¨`åŒ…å«äº†ä¸æ¯ä¸ªIPåœ°å€ç›¸å…³çš„å­ç½‘æ©ç ä¿¡æ¯ï¼ˆæœ‰å…³è·¯ç”±ä¿¡æ¯ï¼Œè¯¦è§ç¬¬8ç« ï¼‰ã€‚&emsp;&emsp;ç”±å›¾5.5å¯çœ‹å‡ºï¼Œæ•°æ®æŠ¥æ ¹æ®ç½‘ç»œIDè¢«è·¯ç”±åˆ°ç›®æ ‡ç½‘ç»œï¼Œè€Œè¿™ä¸ª`ç½‘ç»œID`æ˜¯ç”±`åœ°å€ç±»åˆ«`å†³å®šã€‚å½“æ•°æ®æŠ¥è¾¾åˆ°ç›®æ ‡ç½‘ç»œä¹‹åï¼Œå®ƒæ ¹æ®`å­ç½‘ID`è·¯ç”±åˆ°åˆé€‚çš„`ç½‘æ®µ`ã€‚åœ¨åˆ°è¾¾è¿™ä¸ªç½‘æ®µä¹‹åï¼Œå†æ ¹æ®ä¸»æœºIDä¼ è¾“åˆ°æ­£ç¡®çš„è®¡ç®—æœºã€‚<h4 id="5-3ã€å°†å­ç½‘æ©ç è½¬åŒ–ä¸ºç‚¹åˆ†åè¿›åˆ¶æ ‡è®°"><a href="#5-3ã€å°†å­ç½‘æ©ç è½¬åŒ–ä¸ºç‚¹åˆ†åè¿›åˆ¶æ ‡è®°" class="headerlink" title="5.3ã€å°†å­ç½‘æ©ç è½¬åŒ–ä¸ºç‚¹åˆ†åè¿›åˆ¶æ ‡è®°"></a><strong>5.3ã€å°†å­ç½‘æ©ç è½¬åŒ–ä¸ºç‚¹åˆ†åè¿›åˆ¶æ ‡è®°</strong></h4><p>&emsp;&emsp;ç½‘ç»œç®¡ç†å‘˜é€šå¸¸æŠŠå­ç½‘æ©ç ä½œä¸ºTCP/IPé…ç½®çš„å‚æ•°åˆ†é…ç»™æ¯ä¸ªä¸»æœºã€‚å¦‚æœä¸»æœºé€šè¿‡DHCPï¼ˆè¯¦è§12ç« ï¼‰è·å–IPåœ°å€ï¼ŒDHCPæœåŠ¡å™¨å°±ä¼šåŒæ—¶åˆ†é…ä¸€ä¸ªå­ç½‘æ©ç ã€‚<br>ä¸€ä¸ªå­ç½‘å†…çš„æ‰€æœ‰ä¸»æœºåº”è¯¥å…·æœ‰ç›¸åŒçš„å­ç½‘IDå’Œå­ç½‘æ©ç ã€‚ä¸ºäº†ä¾¿äºäººä»¬ä½¿ç”¨ï¼Œå­ç½‘æ©ç é€šå¸¸ä»¥ç‚¹åˆ†åè¿›åˆ¶è¡¨ç¤ºã€‚<br>&emsp;&emsp;ç›¸æ¯”IPåœ°å€ï¼Œ<code>å­ç½‘æ©ç </code>çš„è½¬æ¢é€šå¸¸æ¯”è¾ƒç®€å•ï¼Œå¯¹åº”äºåœ°å€ä¸­çš„<code>ç½‘ç»œID</code>å’Œ<code>å­ç½‘ID</code>çš„<code>æ©ç ä½æ˜¯1</code>ï¼Œä»£è¡¨<code>IPåœ°å€</code>é‡Œçš„<code>ä¸»æœºID</code>æ©ç ä½0`ã€‚è¿™å°±æ„å‘³ç€1éƒ½åœ¨æ©ç çš„å·¦ä¾§ï¼Œ0éƒ½åœ¨æ©ç çš„å³ä¾§ï¼ˆé™¤äº†æå°‘çš„ä¾‹å¤–ï¼‰ã€‚</p><p>ä¾‹å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">å­ç½‘æ©ç ï¼š</span><br><span class="line">    11111111 11111111 11111111 00000000</span><br><span class="line">    ä»¥ç‚¹åˆ†åè¿›åˆ¶è¡¨ç¤ºï¼š255.255.255.0</span><br><span class="line"></span><br><span class="line">å­ç½‘æ©ç ï¼š</span><br><span class="line">   11111111 11111111 00000000 00000000</span><br><span class="line">    ä»¥ç‚¹åˆ†åè¿›åˆ¶è¡¨ç¤ºï¼š255.255.0.0</span><br></pre></td></tr></table></figure><h4 id="5-4ã€ä½¿ç”¨å­ç½‘"><a href="#5-4ã€ä½¿ç”¨å­ç½‘" class="headerlink" title="5.4ã€ä½¿ç”¨å­ç½‘"></a><strong>5.4ã€ä½¿ç”¨å­ç½‘</strong></h4><p>&emsp;&emsp;å­ç½‘æ©ç å†³å®šäº†ç½‘ç»œIDä¹‹ååˆå¤šå°‘ä½æ˜¯ä½œä¸ºå­ç½‘IDçš„ï¼Œ<strong>å­ç½‘IDçš„é•¿åº¦ä¸æ˜¯å›½å®šçš„ï¼Œå–å†³äºå­ç½‘æ©ç çš„å€¼</strong>ã€‚å­ç½‘IDè¶Šé•¿ï¼Œç•™ç»™ä¸»æœºçš„IDä½æ•°è¶Šå°‘ã€‚æ¢å¥è¯ï¼Œå¦‚æœç½‘ç»œä¸Šæœ‰å¾ˆå¤šå­ç½‘ï¼Œæ¯ä¸ªè‡ªç½‘ä¸Šçš„ä¸»æœºå®¹é‡å°±ä¼šå¾ˆå°‘ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">åœ°å€åˆ†ç±»ï¼š</span><br><span class="line">Aç±»åœ°å€ï¼šâ€œ0â€å¼€å¤´  1.0.0.0~126.0.0.0</span><br><span class="line">å³ï¼š01000000 00000000 00000000 00000000 ~ 01111110 00000000 00000000 00000000</span><br><span class="line">å¯ç”¨çš„Aç±»ç½‘ç»œæœ‰126ä¸ªï¼Œæ¯ä¸ªç½‘ç»œèƒ½å®¹çº³1äº¿å¤šä¸ªä¸»æœº</span><br><span class="line">Bç±»åœ°å€ï¼šâ€œ10â€å¼€å¤´ 128.0.0.0~191.255.255.255</span><br><span class="line">å³ï¼š10000000 00000000 00000000 00000000 ~ 10111111 11111111 11111111 11111111</span><br><span class="line">å¯ç”¨çš„Bç±»ç½‘ç»œæœ‰16382ä¸ªï¼Œæ¯ä¸ªç½‘ç»œèƒ½å®¹çº³6ä¸‡å¤šä¸ªä¸»æœº</span><br><span class="line">Cç±»åœ°å€ â€œ110â€å¼€å¤´ 192.0.0.0~223.255.255.255</span><br><span class="line">å³ï¼š11000000 00000000 00000000 00000000 ~ 11011111 11111111 11111111 11111111</span><br><span class="line">Cç±»ç½‘ç»œå¯è¾¾209ä¸‡ä½™ä¸ªï¼Œæ¯ä¸ªç½‘ç»œèƒ½å®¹çº³254ä¸ªä¸»æœº</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼š</strong>ç±»ä¸æ©ç </p><blockquote><p>åœ°å€ç±»åˆ«ä¹Ÿå†³å®šäº†å­ç½‘IDå ç”¨ä½¿ç”¨å¤šå°‘ä½ã€‚æ¯”å¦‚æ©ç ï¼š<br>11111111 11111111 11100000 00000000<br>æŒ‡å®šäº†ç½‘ç»œIDä¸å­ç½‘IDä¸€å…±å 19ä½ã€‚å¦‚æœè¿™ä¸ªæ©ç ç”¨äºä¸€ä¸ªBç±»åœ°å€ï¼ˆç½‘ç»œID 16ä½ï¼‰ï¼Œé‚£ä¹ˆå­ç½‘å°±åªæœ‰3ä½ã€‚å¦‚æœå®ƒæ˜¯Aç±»åœ°å€ï¼ˆç½‘ç»œID 8ä½ï¼‰ï¼Œå­ç½‘IDå°±æœ‰11ä½ã€‚<br>å­ç½‘IDçš„åˆ†é…ï¼ˆä»¥åŠå­ç½‘æ©ç çš„åˆ†é…ï¼‰ï¼Œå–å†³äºç½‘ç»œçš„é…ç½®ã€‚æœ€å¥½çš„æ–¹æ¡ˆï¼Œæ˜¯å…ˆè§„åˆ’ç½‘ç»œï¼Œç¡®å®šå…¨éƒ¨ç½‘æ®µçš„æ•°è®ºä¸ä½ç½®ï¼Œç„¶åä¸ºæ¯ä¸ªç½‘æ®µåˆ†é…ä¸€ä¸ªå­ç½‘IDã€‚</p></blockquote><table><thead><tr><th>æè¿°</th><th>ç‚¹åˆ†åè¿›åˆ¶å½¢å¼</th><th>äºŒè¿›åˆ¶å½¢å¼</th></tr></thead><tbody><tr><td><strong>Aç±»åœ°å€</strong></td><td></td><td></td></tr><tr><td>é»˜è®¤æ©ç </td><td>255.0.0.0</td><td>11111111 00000000 00000000 00000000</td></tr><tr><td>1ä¸ªå­ç½‘ä½</td><td>255.128.0.0</td><td>11111111 10000000 00000000 00000000</td></tr><tr><td>2ä¸ªå­ç½‘ä½</td><td>255.192.0.0</td><td>11111111 11000000 00000000 00000000</td></tr><tr><td>3ä¸ªå­ç½‘ä½</td><td>255.224.0.0</td><td>11111111 11100000 00000000 00000000</td></tr><tr><td>4ä¸ªå­ç½‘ä½</td><td>255.240.0.0</td><td>11111111 11110000 00000000 00000000</td></tr><tr><td>5ä¸ªå­ç½‘ä½</td><td>255.248.0.0</td><td>11111111 11111000 00000000 00000000</td></tr><tr><td>6ä¸ªå­ç½‘ä½</td><td>255.252.0.0</td><td>11111111 11111100 00000000 00000000</td></tr><tr><td>7ä¸ªå­ç½‘ä½</td><td>255.254.0.0</td><td>11111111 11111110 00000000 00000000</td></tr><tr><td>8ä¸ªå­ç½‘ä½</td><td>255.255.0.0</td><td>11111111 11111111 00000000 00000000</td></tr><tr><td>9ä¸ªå­ç½‘ä½</td><td>255.255.128.0</td><td>11111111 11111111 10000000 00000000</td></tr><tr><td>10ä¸ªå­ç½‘ä½</td><td>255.255.192.0</td><td>11111111 11111111 11000000 00000000</td></tr><tr><td>11ä¸ªå­ç½‘ä½</td><td>255.255.224.0</td><td>11111111 11111111  11100000 00000000</td></tr><tr><td>12ä¸ªå­ç½‘ä½</td><td>255.255.240.0</td><td>11111111 11111111 11110000 00000000</td></tr><tr><td>13ä¸ªå­ç½‘ä½</td><td>255.255.248.0</td><td>11111111 11111111 11111000 00000000</td></tr><tr><td>14ä¸ªå­ç½‘ä½</td><td>255.255.252.0</td><td>11111111 11111111 11111100 00000000</td></tr><tr><td>15ä¸ªå­ç½‘ä½</td><td>255.255.254.0</td><td>11111111 11111111 11111110 00000000</td></tr><tr><td>16ä¸ªå­ç½‘ä½</td><td>255.255.255.0</td><td>11111111 11111111 11111111 00000000</td></tr><tr><td>17ä¸ªå­ç½‘ä½</td><td>255.255.255.128</td><td>11111111 11111111 11111111 10000000</td></tr><tr><td>18ä¸ªå­ç½‘ä½</td><td>255.255.255.192</td><td>11111111 11111111 11111111 11000000</td></tr><tr><td>19ä¸ªå­ç½‘ä½</td><td>255.255.255.224</td><td>11111111 11111111 11111111 11100000</td></tr><tr><td>20ä¸ªå­ç½‘ä½</td><td>255.255.255.240</td><td>11111111 11111111 11111111 11110000</td></tr><tr><td>21ä¸ªå­ç½‘ä½</td><td>255.255.255.248</td><td>11111111 11111111 11111111 11111000</td></tr><tr><td>22ä¸ªå­ç½‘ä½</td><td>255.255.255.252</td><td>11111111 11111111 11111111 11111100</td></tr><tr><td><strong>Bç±»åœ°å€</strong></td><td></td><td></td></tr><tr><td>é»˜è®¤æ©ç </td><td>255.255.0.0</td><td>11111111 11111111 00000000 00000000</td></tr><tr><td>1ä¸ªå­ç½‘ä½</td><td>255.255.128.0</td><td>11111111 11111111 10000000 00000000</td></tr><tr><td>2ä¸ªå­ç½‘ä½</td><td>255.255.192.0</td><td>11111111 11111111 11000000 00000000</td></tr><tr><td>3ä¸ªå­ç½‘ä½</td><td>255.255.224.0</td><td>11111111 11111111 11100000 00000000</td></tr><tr><td>4ä¸ªå­ç½‘ä½</td><td>255.255.240.0</td><td>11111111 11111111 11110000 00000000</td></tr><tr><td>5ä¸ªå­ç½‘ä½</td><td>255.255.248.0</td><td>11111111 11111111 11111000 00000000</td></tr><tr><td>6ä¸ªå­ç½‘ä½</td><td>255.255.252.0</td><td>11111111 11111111 11111100 00000000</td></tr><tr><td>7ä¸ªå­ç½‘ä½</td><td>255.255.254.0</td><td>11111111 11111111 11111110 00000000</td></tr><tr><td>8ä¸ªå­ç½‘ä½</td><td>255.255.255.0</td><td>11111111 11111111 11111111 00000000</td></tr><tr><td>9ä¸ªå­ç½‘ä½</td><td>255.255.255.128</td><td>11111111 11111111 11111111 10000000</td></tr><tr><td>10ä¸ªå­ç½‘ä½</td><td>255.255.255.192</td><td>11111111 11111111 11111111 11000000</td></tr><tr><td>11ä¸ªå­ç½‘ä½</td><td>255.255.255.224</td><td>11111111 11111111 11111111 11111100</td></tr><tr><td>12ä¸ªå­ç½‘ä½</td><td>255.255.255.240</td><td>11111111 11111111 11111111 11111100</td></tr><tr><td>13ä¸ªå­ç½‘ä½</td><td>255.255.255.248</td><td>11111111 11111111 11111111 11111100</td></tr><tr><td>14ä¸ªå­ç½‘ä½</td><td>255.255.255.252</td><td>11111111 11111111 11111111 11111100</td></tr><tr><td><strong>Cç±»åœ°å€</strong></td><td></td><td></td></tr><tr><td>é»˜è®¤æ©ç </td><td>255.255.255.0</td><td>11111111 11111111 11111111 00000000</td></tr><tr><td>1ä¸ªå­ç½‘ä½</td><td>255.255.255.128</td><td>11111111 11111111 11111111 10000000</td></tr><tr><td>2ä¸ªå­ç½‘ä½</td><td>255.255.255.192</td><td>11111111 11111111 11111111 11000000</td></tr><tr><td>3ä¸ªå­ç½‘ä½</td><td>255.255.255.224</td><td>11111111 11111111 11111111 11100000</td></tr><tr><td>4ä¸ªå­ç½‘ä½</td><td>255.255.255.240</td><td>11111111 11111111 11111111 11110000</td></tr><tr><td>5ä¸ªå­ç½‘ä½</td><td>255.255.255.248</td><td>11111111 11111111 11111111 11111000</td></tr><tr><td>6ä¸ªå­ç½‘ä½</td><td>255.255.255.252</td><td>11111111 11111111 11111111 11111100</td></tr></tbody></table><p><strong>æ³¨</strong>ï¼š </p><blockquote><p>ä¸»æœºIDä¸èƒ½ä¸ºå…¨1(ä¿ç•™ç”¨äºå¹¿æ’­)æˆ–å…¨0ï¼ˆåŒåŸä¸ä½¿ç”¨ï¼‰ã€‚</p></blockquote><h4 id="5-5ã€æ— ç±»åˆ«åŸŸé—´è·¯ç”±ï¼ˆCIDRï¼‰"><a href="#5-5ã€æ— ç±»åˆ«åŸŸé—´è·¯ç”±ï¼ˆCIDRï¼‰" class="headerlink" title="5.5ã€æ— ç±»åˆ«åŸŸé—´è·¯ç”±ï¼ˆCIDRï¼‰"></a><strong>5.5ã€æ— ç±»åˆ«åŸŸé—´è·¯ç”±ï¼ˆCIDRï¼‰</strong></h4><p>&emsp;&emsp;åœ°å€åˆ†ç±»ç³»ç»Ÿç›¸å¯¹è€Œè¨€ä¸å¤Ÿçµæ´»ï¼Œéœ€è¦ä½¿ç”¨å­ç½‘åˆ’åˆ†ç³»ç»Ÿæ¥æ›´ç»†è‡´åœ°æ§åˆ¶åœ°å€æ§ä»¶ã€‚è€Œæ— ç±»åˆ«åŸŸè·¯ç”±ï¼ˆCIDRï¼‰åœ¨<strong>è·¯ç”±è¡¨</strong>ä¸­å®šä¹‰åœ°å€å—æ—¶å®¹æ˜“ä¿®æ”¹ï¼Œæ›´å…·æœ‰çµæ´»æ€§ã€‚è¿™ç§æŠ€æœ¯ä¸ä¾èµ–äºé¢„å®šä¹‰çš„8ä½ã€16ä½æˆ–24ä½ç½‘ç»œIDï¼Œè€Œæ˜¯ä½¿ç”¨ä¸€ä¸ªåä¸ºCIDRå‰ç¼€å€¼æŒ‡å®šåœ°å€ä¸­ä½œä¸ºç½‘ç»œIDçš„ä½æ•°ã€‚è¿™ä¸ªå‰ç¼€æœ‰æ—¶ä¹Ÿè¢«ç§°ä¸º<strong>å˜é•¿å­ç½‘æ©ç ï¼ˆVLSMï¼‰</strong>ã€‚è¿™ä¸ªå‰ç¼€å¯ä»¥ä½äºåœ°å€ç©ºé—´çš„ä»»ä½•ä½ç½®ï¼Œè®©ç®¡ç†è€…èƒ½å¤Ÿä»¥æ›´çµæ´»çš„æ–¹å¼å®šä¹‰å­ç½‘ï¼Œä»¥ç®€ä¾¿çš„å½¢å¼æŒ‡å®šåœ°å€ä¸­ç½‘ç»œIDéƒ¨åˆ†ä¸ä¸»æœºIDéƒ¨åˆ†ã€‚CIDRæ ‡è®°ä½¿ç”¨ä¸€ä¸ªæ–œçº¿ï¼ˆ/ï¼‰åˆ†éš”ç¬¦ï¼Œåé¢è·Ÿä¸€ä¸ªåè¿›åˆ¶æ•°å€¼è¡¨ç¤ºåœ°å€ä¸­ç½‘ç»œéƒ¨åˆ†æ‰€å çš„ä½æ•°ã€‚ä¾‹å¦‚CIDRåœ°å€205.123.196.183/25ä¸­ï¼Œ/25è¡¨ç¤ºåœ°å€ä¸­25ä½ç”¨äºç½‘ç»œIDï¼Œç›¸åº”çš„å­ç½‘æ©ç å°±æ˜¯255.255.255.128ã€‚</p><p>&emsp;&emsp;CIDRå‰ç¼€è¡¨æ˜äº†IPåœ°å€ä¸­å‰é¢çš„å¤šå°‘ä½å¯¹äºç½‘ç»œé‡Œçš„å…¨éƒ¨ä¸»æœºè¯´æ˜¯ä¸€æ ·çš„ã€‚CIDRå¼ºå¤§çš„ç‰¹æ€§ä¸ä»…ä»…èƒ½å¤Ÿå¯¹ç½‘ç»œåˆ’åˆ†å­ç½‘ï¼Œè¿˜è®©ISPæˆ–ç®¡ç†å‘˜èƒ½å¤ŸæŠŠå¤šä¸ªè¿ç»­Cç±»ç½‘ç»œèšåˆæˆ–ç»„åˆä¸ºä¸€ä¸ªå®ä½“ã€‚è¿™ç§ä¹Ÿè¡Œæå¤§çš„ç®€åŒ–äº†ç½‘é™…è·¯ç”±è¡¨ã€‚</p><p>&emsp;&emsp;ä¾‹å¦‚ï¼šä¸€ä¸ªISPå¯ä»¥åˆ†é…204.21.128.0ï¼ˆ11001100 00010101 10000000 00000000ï¼‰~204.21.255.255ï¼ˆ11001100 00010101 11111111 11111111ï¼‰çš„å…¨éƒ¨Cç±»åœ°å€ï¼Œè¿™äº›ç½‘ç»œåœ°å€çš„å‰17ä½æ˜¯ä¸€æ ·çš„ï¼Œå› æ­¤ï¼Œè¶…ç½‘æ©ç æ˜¯11111111 11111111 10000000 0000000å³255.255.128.0ã€‚<strong>è¶…ç½‘æ©ç </strong>ä¸­0å¯¹åº”çš„ä¸ºç¡®å®šäº†åœ°å€å—çš„èŒƒå›´ã€‚å› æ­¤ï¼Œæ”¯æŒCIDRè·¯ç”±è¡¨åªæ˜¯ç”¨ä¸€æ¡CIDRæ¡ç›®204.21.128.0/17æ¥å¼•ç”¨è¿™äº›åœ°å€çš„å…¨éƒ¨èŒƒå›´ã€‚</p><p><strong><code>è¶…ç½‘æ©ç ï¼š</code></strong>ä¸€ä¸ª32ä½çš„äºŒè¿›åˆ¶å€¼ï¼Œèƒ½å¤ŸæŠŠå¤šä¸ªè¿ç»­ç½‘ç»œIDèšåˆä¸ºä¸€ä¸ªæ•´ä½“ã€‚</p><h2 id="ç¬¬6ç« -ä¼ è¾“å±‚"><a href="#ç¬¬6ç« -ä¼ è¾“å±‚" class="headerlink" title="ç¬¬6ç«  ä¼ è¾“å±‚"></a>ç¬¬6ç«  ä¼ è¾“å±‚</h2><p>&emsp;&emsp;TCP/IPä¼ è¾“å±‚åŒ…å«å¾ˆå¤šæœ‰ç”¨çš„åè®®ï¼Œèƒ½å¤Ÿæä¾›æ•°æ®åœ¨ç½‘ç»œä¼ è¾“æ‰€éœ€è¦çš„å¿…è¦<strong>å¯»å€</strong>ä¿¡æ¯ã€‚ä½†<strong>å¯»å€</strong>å’Œ<strong>è·¯ç”±</strong>åªæ˜¯ä¼ è¾“å±‚çš„éƒ¨åˆ†åŠŸèƒ½ã€‚ç½‘é™…å±‚ä¸Šæ·»åŠ å¦ä¸€å±‚ï¼Œè¿™å±‚æä¾›çš„é¢å¤–å¿…é¡»è¦ç‰¹æ€§æ¥ä½¿ç”¨IPã€‚<br>ä¼ è¾“å±‚åè®®éœ€è¦æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š</p><blockquote><ul><li><strong>ä¸ºç½‘ç»œåº”ç”¨ç¨‹åºæä¾›æ¥å£ï¼š</strong>ä¹Ÿå°±æ˜¯ä¸ºåº”ç”¨ç¨‹åºæä¾›è®¿é—®ç½‘ç»œçš„é€”å¾„ã€‚è®¾è®¡è€…å¸Œæœ›ä¸ä»…èƒ½å¤Ÿå‘ç›®çš„è®¡ç®—æœºä¼ é€’æ•°æ®ï¼Œè¿˜èƒ½å¤Ÿå‘ç›®çš„è®¡ç®—æœºä¸Šçš„<code>ç‰¹å®šåº”ç”¨</code>ä¼ é€’æ•°æ®ã€‚</li><li><strong>å¤šè·¯å¤ç”¨/å¤šè·¯åˆ†è§£æœºåˆ¶ï¼š</strong>è¿™é‡Œçš„å¤šè·¯å¤ç”¨è¡¨ç¤ºä»ä¸åŒçš„åº”ç”¨ç¨‹åºå’Œè®¡ç®—æœºæ¥æ”¶æ•°æ®ï¼Œå†æŠŠæ•°æ®ä¼ é€’åˆ°ç›®çš„è®¡ç®—æœºä¸Šçš„æ¥æ”¶ç¨‹åºã€‚æ¢å¥è¯è¯´ï¼Œä¼ è¾“å±‚å¿…é¡» èƒ½å¤ŸåŒæ—¶æ”¯æŒå¤šä¸ªç½‘ç»œç¨‹åºå’Œç®¡ç†ä¼ é€’ç»™ç½‘é™…å±‚çš„æ•°æ®æµã€‚åœ¨æ¥æ”¶ç«¯ï¼Œä¼ è¾“å±‚å¿…é¡»èƒ½å¤Ÿä»ç½‘é™…å±‚å‡ é¦–æ•°æ®ï¼ŒæŠŠå®ƒè½¬å‘ç»™å¤šä¸ªç¨‹åºï¼Œè¿™ç§åŠŸèƒ½è¢«åƒå‘¢æ”¹ä¸ºå¤šè·¯åˆ†è§£ï¼Œå®ƒå¯ä»¥è®©ä¸€å°è®¡ç®—æœºåŒæ—¶æ”¯æŒå¤šä¸ªç½‘ç»œç¨‹åºï¼Œæ¯”å¦‚ä¸€ä¸ªWebæµè§ˆå™¨ã€ä¸€ä¸ªEmailå®¢æˆ·ç«¯å’Œä¸€ä¸ªæ–‡ä»¶å…±äº«åº”ç”¨ç¨‹åºã€‚å¤šè·¯å¤ç”¨/å¤šè·¯åˆ†è§£çš„å¦ä¸€ä¸ªä½œç”¨æ˜¯å¯ä»¥è®©ä¸€ä¸ªåº”ç”¨ç¨‹åºåŒæ—¶ä¿æŒä¸å¤šå°è®¡ç®—æœºçš„è¿æ¥ã€‚</li><li><strong>é”™è¯¯æ£€æŸ¥ã€æµé‡æ§åˆ¶å’ŒéªŒè¯ï¼š</strong>åè®®ç³»ç»Ÿéœ€è¦ä¸€ç§å…¨é¢æœºåˆ¶æ¥ç¡®ä¿å‘é€ç«¯ä¸æ¥æ”¶ç«¯ä¹‹é—´çš„æ•°æ®ä¼ è¾“ã€‚</li><li><strong>ä¼ è¾“æ§åˆ¶åè®®ï¼ˆTCPï¼‰ï¼š</strong> TCPæä¾›äº†å®Œå–„çš„é”™è¯¯æ§åˆ¶å’Œæµé‡æ§åˆ¶ï¼Œèƒ½å¤Ÿç¡®ä¿æ•°æ®æ­£ç¡®ä¼ è¾“ï¼Œå®ƒæ˜¯ä¸€ä¸ªé¢å‘è¿æ¥çš„åè®®ã€‚</li><li><strong>ç”¨æˆ·æ•°æ®æŠ¥åè®®ï¼ˆUDPï¼‰ï¼š</strong> UDPåªæä¾›äº†éå¸¸åŸºæœ¬çš„é”™è¯¯æ£€æŸ¥ï¼Œç”¨äºä¸é”ˆå¥¥TCPç²¾ç»†æ§åˆ¶åŠŸèƒ½çš„åœºåˆï¼Œå®ƒæ˜¯ä¸€ä¸ªæ— è¿æ¥çš„åè®®ã€‚</li></ul></blockquote><h4 id="6-2ã€ä¼ è¾“å±‚æ¦‚å¿µ"><a href="#6-2ã€ä¼ è¾“å±‚æ¦‚å¿µ" class="headerlink" title="6.2ã€ä¼ è¾“å±‚æ¦‚å¿µ"></a><strong>6.2ã€ä¼ è¾“å±‚æ¦‚å¿µ</strong></h4><p><strong>6.2.1 é¢å‘è¿æ¥çš„åè®®å’Œæ— è¿æ¥åè®®</strong><br>&emsp;&emsp;é’ˆå¯¹ä¸åŒæƒ…å†µæä¾›ä¸åŒç¨‹åº¦çš„è´¨é‡ä¿è¯ï¼Œä¼ è¾“å±‚æä¾›äº†ä¸¤ç§ä¸åŒçš„åè®®åŸå‹ã€‚</p><ul><li><strong>é¢å‘è¿æ¥çš„åè®®ï¼š</strong>ä¼šåœ¨é€šä¿¡è®¡ç®—æœºä¹‹é—´å»ºç«‹å¹¶ç»´æŠ¤ä¸€ä¸ªè¿æ¥ï¼Œå¹¶ä¸”åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ç›‘è§†è¿æ¥çŠ¶æ€ã€‚æ¢å¥è¯è¯´ï¼Œé€šè¿‡ç½‘ç»œä¼ è¾“çš„æ¯ä¸ªæ•°æ®åŒ…éƒ½ä¼šæœ‰ä¸€ä¸ªç¡®è®¤ï¼Œå‘é€ç«¯å°±æ˜¯é‚£å‡ ä¼šè®°å½•çŠ¶æ€ä¿¡æ¯æ¥ç¡®ä¿æ¯ä¸ªæ•°æ®åŒ…éƒ½è¢«æ­£ç¡®æ— è¯¯çš„æ¥æ”¶ï¼Œå¹¶ä¸”åœ¨éœ€è¦æ—¶ä¼šé‡å‘æ•°æ®ã€‚å½“æ•°æ®ä¼ è¾“ç»“æŸä¹‹åï¼Œå‘é€ç«¯å’Œæ¥æ”¶ç«¯è®¡ç®—æœºä¼šå·²é€‚å½“çš„æ–¹å¼å…³é—­è¿æ¥ã€‚</li><li><strong>æ— è¿æ¥çš„åè®®ï¼š</strong>ä»¥å•å‘æ–¹å¼å‘ç›®çš„å‘é€æ•°æ®æŠ¥ï¼Œä¸æ‰¿æ‹…é€šçŸ¥ç›®çš„è®¡ç®—æœºå…³äºæ•°æ®å‘é€çš„èŒè´£ã€‚ç›®çš„è®¡ç®—æœºæ¥æ”¶åˆ°æ•°æ®åä¹Ÿä¸éœ€è¦å‘æºè®¡ç®—æœºè¿”å›çŠ¶æ€ä¿¡æ¯ã€‚</li></ul><p><strong>6.2.2ã€ç«¯å£å’Œå¥—æ¥å­—</strong><br>&emsp;&emsp;ä¼ è¾“å±‚å†²åˆ°äº†ç½‘ç»œåº”ç”¨ç¨‹åºä¸ç½‘ç»œä¹‹é—´çš„æ¥å£ï¼Œå¹¶ä¸”èƒ½å¤Ÿç½‘ç»œæ•°æ®ä¼ é€’ç»™ç‰¹å®šçš„åº”ç”¨ç¨‹åºã€‚<br>åœ¨TCP/IPç³»ç»Ÿä¸­ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ç«¯å£å·é€šè¿‡TCPæˆ–UDPæŒ‡å®šæ•°æ®ç›®çš„åœ°ã€‚<strong><code>ç«¯å£</code></strong>æ˜¯ä¸€ä¸ªé¢„å®šä¹‰çš„å†…éƒ¨åœ°å€ï¼Œå……å½“ä»<code>åº”ç”¨ç¨‹åºåˆ°ä¼ è¾“å±‚</code>æˆ–æ˜¯<code>ä¼ è¾“å±‚åˆ°åº”ç”¨ç¨‹åº</code>ä¹‹é—´çš„é€šè·¯ï¼ˆå¦‚å›¾6.3ï¼‰ã€‚ä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯è®¡ç®—æœºé€šå¸¸åˆ©ç”¨TCPç«¯å£21æ¥è®¿é—®æœåŠ¡å™¨ä¸Šçš„FTPç¨‹åºã€‚</p><p>&emsp;&emsp;è¿›ä¸€æ­¥è§‚å¯Ÿä¼ è¾“å±‚è¿™ç§é±¼åº”ç”¨ç¨‹åºç›¸å…³çš„å¯»å€ä½“åˆ¶ï¼Œå°±ä¼šå‘ç°TCPå’ŒUDPæ•°æ®å®é™…æ˜¯è¢«å‘é€åˆ°ä¸€ä¸ªå¥—æ¥å­—ä¸Šçš„ã€‚<strong><code>å¥—æ¥å­—</code></strong>æ˜¯ä¸€ä¸ªç”±<code>IPåœ°å€å’Œç«¯å£å·</code>ç»„æˆçš„åœ°å€ã€‚ä¾‹å¦‚ï¼Œå¥—æ¥å­—åœ°å€111.121.131.141:21æŒ‡å‘IPåœ°å€ä¸º111.121.131.141çš„è®¡ç®—æœºç«¯å£21.<br>å›¾6.4æ‰€ç¤ºTCPçš„è®¡ç®—æœºåœ¨å»ºç«‹è¿æ¥æ—¶å¦‚ä½•äº¤æ¢å¥—æ¥å­—ä¿¡æ¯ã€‚</p><p>ä¸‹ä¾‹å±•ç¤ºä¸€å°è®¡ç®—æœºå¦‚ä½•é€šè¿‡å¥—æ¥å­—è®¿é—®ç›®çš„è®¡ç®—æœºä¸Šçš„ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.è®¡ç®—æœºAé€šè¿‡ä¸€ä¸ªç†ŸçŸ¥çš„ç«¯å£å‘è®¡ç®—æœºBä¸Šçš„ä¸€ä¸ªåº”ç”¨ç¨‹åºå‘èµ·è¿æ¥ï¼Œç†ŸçŸ¥ç«¯å£æ˜¯äº’è”ç½‘æ•°å­—åˆ†é…æœºæ„ï¼ˆIANAï¼‰åˆ†é…ç»™ç‰¹å®šç¨‹åºçš„ç«¯å£ã€‚è¡¨6.1å’Œ6.2åˆ—å‡ºä¸€äº›ç†ŸçŸ¥çš„TCPå’ŒUDPç«¯å£ã€‚ç†ŸçŸ¥çš„ç«¯å£ä¸IPåœ°å€ç»„åˆä¹‹åå°±æ„æˆäº†è®¡ç®—æœºAçš„ç›®çš„å¥—æ¥å­—ã€‚è¿æ¥è¯·æ±‚åŒ…å«ç€ä¸€ä¸ªæ•°æ®å­—æ®µï¼Œå‘Šè¯‰è®¡ç®—æœºBä½¿ç”¨ä»€ä¹ˆå¥—æ¥å­—ç¨‹åºè®¡ç®—æœºAè¿”å›ä¿¡æ¯ï¼Œè¿™ä¹Ÿå°±æ˜¯è®¡ç®—æœºAçš„æºå¥—æ¥å­—åœ°å€ã€‚</span><br><span class="line">2.è®¡ç®—æœºBé€šè¿‡ç†ŸçŸ¥ç«¯å£æ¥æ”¶æ¥è‡ªè®¡ç®—æœºAçš„è¯·æ±‚ï¼Œå‘ä½œä¸ºè®¡ç®—æœºAæºåœ°å€çš„å¥—æ¥å­—å‘é€ä¸€ä¸ªå“åº”ã€‚è¿™ä¸ªå¥—æ¥å­—å°±ç§°ä¸ºè®¡ç®—æœºBä¸Šçš„åº”ç”¨ç¨‹åºå‘è®¡ç®—æœºAä¸Šçš„åº”ç”¨ç¨‹åºå‘é€æ¶ˆæ¯çš„ç›®çš„åœ°å€ã€‚</span><br></pre></td></tr></table></figure><p>è¡¨6.1ç†ŸçŸ¥çš„TCPç«¯å£</p><table><thead><tr><th>æœåŠ¡</th><th>TCPç«¯å£</th><th>ç®€è¦æè¿°</th></tr></thead><tbody><tr><td>tcpmux</td><td>1</td><td>TCPç«¯å£æœåŠ¡å¤šè·¯å¤ç”¨</td></tr><tr><td>compressnet</td><td>2</td><td>ç®¡ç†å·¥å…·</td></tr><tr><td>echo</td><td>3</td><td>å‹ç¼©å·¥å…·</td></tr><tr><td>discard</td><td>7</td><td>å›æ˜¾</td></tr><tr><td>systat</td><td>11</td><td>ç”¨æˆ·</td></tr><tr><td>daytime</td><td>13</td><td>æ—¶é—´</td></tr><tr><td>netstat</td><td>15</td><td>ç½‘ç»œçŠ¶æ€</td></tr><tr><td>qotd</td><td>17</td><td>æ¯æ—¥å¼•ç”¨</td></tr><tr><td>chargen</td><td>19</td><td>å­—ç¬¦è¯´å‘¢è¿‡ç¨‹å™¨</td></tr><tr><td>ftp-data</td><td>20</td><td>æ–‡ä»¶ä¼ è¾“åè®®æ•°æ®</td></tr><tr><td>ftp</td><td>21</td><td>æ–‡ä»¶ä¼ è¾“åè®®æ§åˆ¶</td></tr><tr><td>ssh</td><td>22</td><td>å®‰å…¨Shell</td></tr><tr><td>telnet</td><td>23</td><td>ç»ˆç«¯ç½‘ç»œè¿æ¥</td></tr><tr><td>smtp</td><td>25</td><td>ç®€å•é‚®ä»¶ä¼ è¾“åè®®</td></tr><tr><td>new-fe</td><td>27</td><td>NSWç”¨æˆ·ç³»ç»Ÿ</td></tr><tr><td>time</td><td>37</td><td>æ—¶é—´æœåŠ¡ç¨‹åº</td></tr><tr><td>name</td><td>42</td><td>ä¸»æœºåç§°æœåŠ¡ç¨‹åº</td></tr><tr><td>domain</td><td>53</td><td>åŸŸåæœåŠ¡ç¨‹åºï¼ˆDNSï¼‰</td></tr><tr><td>gopher</td><td>70</td><td>GopheræœåŠ¡</td></tr><tr><td>finger</td><td>79</td><td>Finger</td></tr><tr><td>http</td><td>80</td><td>WWWæœåŠ¡</td></tr><tr><td>link</td><td>87</td><td>TTYé“¾æ¥</td></tr><tr><td>supdup</td><td>95</td><td>SUPDUPåè®®</td></tr><tr><td>pop2</td><td>109</td><td>é‚®å±€åè®®2</td></tr><tr><td>pop3</td><td>110</td><td>é‚®å±€åè®®3</td></tr><tr><td>auth</td><td>113</td><td>èº«ä»½éªŒè¯æœåŠ¡</td></tr><tr><td>uucp-path</td><td>117</td><td>UUCPè·¯å¾„æœåŠ¡</td></tr><tr><td>nntp</td><td>119</td><td>USENETç½‘ç»œæ–°é—»ä¼ è¾“åè®®</td></tr><tr><td>nbsession</td><td>139</td><td>NetBIOSä¼šè¯</td></tr></tbody></table><p>è¡¨6.2 ç†ŸçŸ¥çš„UDPç«¯å£</p><table><thead><tr><th>æœåŠ¡</th><th>UDPç«¯å£å·</th><th>æè¿°</th></tr></thead><tbody><tr><td>echo</td><td>7</td><td>å›æ˜¾</td></tr><tr><td>discard</td><td>9</td><td>æŠ›å¼ƒæˆ–ç©º</td></tr><tr><td>systat</td><td>11</td><td>ç”¨æˆ·</td></tr><tr><td>daytime</td><td>13</td><td>æ—¶é—´</td></tr><tr><td>qotd</td><td>17</td><td>æ¯æ—¥å¼•ç”¨</td></tr><tr><td>chargen</td><td>19</td><td>å­—ç¬¦ç”Ÿæˆå™¨</td></tr><tr><td>time</td><td>37</td><td>æ—¶é—´æœåŠ¡ç¨‹åº</td></tr><tr><td>domain</td><td>53</td><td>åŸŸåæœåŠ¡ç¨‹åº(DNSï¼‰</td></tr><tr><td>bootps</td><td>67</td><td>å¼•å¯¼ç¨‹åºåè®®æœåŠ¡DCHP</td></tr><tr><td>bootpc</td><td>68</td><td>å¼•å¯¼ç¨‹åºåè®®å®¢æˆ·ç«¯DCHP</td></tr><tr><td>tftp</td><td>69</td><td>ç®€å•æ–‡ä»¶ä¼ è¾“åè®®</td></tr><tr><td>ntp</td><td>123</td><td>ç½‘ç»œæ—¶é—´æœåŠ¡</td></tr><tr><td>nbname</td><td>137</td><td>NetBIOSåç§°</td></tr><tr><td>snmp</td><td>161</td><td>ç®€å•ç½‘ç»œç®¡ç†åè®®</td></tr><tr><td>snmp-trap</td><td>162</td><td>ç®€å•ç½‘ç»œç®¡ç†åè®®trap</td></tr><tr><td><strong>6.2.3ã€å¤šè·¯å¤ç”¨/å¤šè·¯åˆ†è§£</strong></td><td></td><td></td></tr><tr><td>&emsp;&emsp;å¥—æ¥å­—å¯»å€ç³»ç»Ÿä½¿ç”¨TCPå’ŒUDPèƒ½å¤Ÿæ‰§è¡Œä¼ è¾“å±‚å¦ä¸€é‡è¦ä»»åŠ¡ï¼š<strong><code>å¤šè·¯å¤ç”¨</code></strong>å’Œ<strong><code>å¤šè·¯å¯»å€</code></strong>;<code>å¤šè·¯å¤ç”¨</code>æ˜¯æŒ‡å¤šä¸ªæ¥æºçš„æ•°æ®å¯¼å‘ä¸€ä¸ªè¾“å‡ºï¼Œè€Œ<code>å¤šè·¯åˆ†è§£</code>æ˜¯æŠŠä»ä¸€ä¸ªæ¥æºæ¥æ”¶çš„æ•°æ®å‘é€å¤šä¸ªè¾“å‡ºã€‚</td><td></td><td></td></tr></tbody></table><p>&emsp;&emsp;<code>å¤šè·¯ä¼ è¾“/å¤šè·¯åˆ†è§£</code>è®©TCP/IPåè®®æ ˆè¾ƒä½å±‚çš„åè®®ä¸å¿…å…³ç³»å“ªä¸ªç¨‹åºåœ¨ä¼ è¾“æ•°æ®ã€‚ä¸åº”ç”¨ç¨‹åºç›¸å…³çš„æ“ä½œéƒ½ç”±ä¼ è¾“å±‚å®Œæˆäº†ï¼Œæ•°æ®é€šè¿‡ä¸€ä¸ªä¸åº”ç”¨ç¨‹åºæ— å…³çš„ç®¡é“åœ¨ä¼ è¾“å±‚ä¸ç½‘é™…æˆä¼ é€’ã€‚<br>&emsp;&emsp;å¤šè·¯å¤ç”¨å’Œå¤šè·¯åˆ†è§£çš„å…³é”®åœ¨äº<code>å¥—æ¥å­—åœ°å€</code>ã€‚å¥—æ¥å­—åœ°å€åŒ…å«äº†IPåœ°å€ä¸ç«¯å£å·ï¼Œä¸ºç‰¹å®šè®¡ç®—æœºä¸Šçš„ç‰¹å®šåº”ç”¨ç¨‹åºæä¾›äº†å·²ä¸ªå”¯ä¸€çš„æ ‡è¯†ã€‚å‚è§å›¾6.6ä¸­FTPæœåŠ¡å™¨ã€‚æ‰€æœ‰å®¢æˆ·ç«¯è®¡ç®—æœºä½¿ç”¨ç†ŸçŸ¥çš„TCPç«¯å£21è¿æ¥åˆ°FTPæœåŠ¡å™¨ï¼Œä½†é’ˆå¯¹æ²¡å¤ªä¸ªäººè®¡ç®—æœºçš„ç›®çš„å¥—æ¥å­—æ˜¯ä¸åŒçš„ã€‚ç±»ä¼¼åœ°ï¼Œè¿è¡Œäºè¿™å°FTPæœåŠ¡å™¨ä¸Šå…¨éƒ¨ç½‘ç»œåº”ç”¨ç¨‹åºéƒ½ä½¿ç”¨æœåŠ¡å™¨çš„IPåœ°å€ï¼Œä½†åªæœ‰FTPæœåŠ¡ç¨‹åºä½¿ç”¨ç”±IPåœ°å€å’ŒTCPç«¯å£å·21ç»„æˆçš„å¥—æ¥å­—åœ°å€ã€‚</p><h4 id="6-3ã€ç†è§£TCPå’ŒUDP"><a href="#6-3ã€ç†è§£TCPå’ŒUDP" class="headerlink" title="6.3ã€ç†è§£TCPå’ŒUDP"></a><strong>6.3ã€ç†è§£TCPå’ŒUDP</strong></h4><p><strong>6.3.1ã€TCPï¼šé¢å‘è¿æ¥çš„ä¼ è¾“åè®®</strong><br>åŒ…æ‹¬ä»¥ä¸‹é‡è¦ç‰¹æ€§ï¼š</p><blockquote><ul><li><strong>é¢å‘æµçš„å¤„ç†ï¼š</strong> TCPä»¥æµçš„æ–¹å¼å¤„ç†æ•°æ®ã€‚æ¢å¥è¯è¯´ï¼ŒTCPå¯ä»¥ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚åœ°æ¥æ”¶æ•°æ®ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ¥æ”¶ä¸€ä¸ªé¢„å®šä¹‰æ ¼å¼çš„æ•°æ®å—.TCPæŠŠæ¥æ”¶åˆ°çš„æ•°æ®ç»„æˆé•¿åº¦ä¸å®šçš„æ®µï¼Œå†ä¼ é€’åˆ°ç½‘é™…å±‚ã€‚</li><li><strong>é‡æ–°æ’åºï¼š</strong>å¦‚æœæ•°æ®ä»¥é”™è¯¯çš„é¡ºåºåˆ°è¾¾ç›®çš„ï¼ŒTCPæ¨¡å—èƒ½å¤Ÿå¯¹æ•°æ®é‡æ–°æ’åºæ¥æ¢å¤åŸå§‹æ¢å¤ã€‚</li><li><strong>æµé‡æ§åˆ¶ï¼š</strong> TCPçš„æµé‡æ§åˆ¶ç‰¹æ€§èƒ½å¤Ÿç¡®ä¿ä¼ è¾“ä¸ä¼šè¶…è¿‡ç›®çš„è®¡ç®—æœºæ¥æ”¶èƒ½åŠ›ã€‚ç”±äºç°å®ä¸–ç•Œé‡Œä¼šæœ‰å„ç§ä¸åŒçš„åº”ç”¨ç¯å¢ƒï¼Œå¤„ç†å™¨é€Ÿåº¦å’Œç¼“å­˜åŒºå¤§å°çš„å·®åˆ«ä¹Ÿå¯èƒ½å¾ˆå¤§ï¼Œæ‰€ä»¥è¿™ç§æµæ§åˆ¶èƒ½åŠ›æ˜¯éå¸¸é‡è¦çš„ã€‚</li><li><strong>ä¼˜å…ˆçº§ä¸å®‰å…¨ï¼š</strong>å›½é˜²éƒ¨å¯¹TCPçš„è§„èŒƒè¦æ±‚å¯ä»¥ä¸ºTCPè¿æ¥è®¾ç½®å¯é€‰çš„å®‰å…¨çº§åˆ«å’Œä¼˜å…ˆçº§ï¼Œä½†å¾ˆå¤šTCPå®ç°å¹¶æ²¡æœ‰æä¾›è¿™äº›å®‰å…¨å’Œä¼˜å…ˆçº§ç‰¹æ€§ã€‚</li><li><strong>é€‚å½“çš„å…³é—­ï¼š</strong> TCPåƒé‡è§†å»ºç«‹è¿æ¥ä¸€æ ·é‡è§†å…³é—­è¿æ¥çš„å·¥ä½œï¼Œä»¥ç¡®ä¿åœ¨è¿æ¥è¢«å…³é—­ä¹‹å‰ï¼Œæ‰€æœ‰çš„æ•°æ®æ®µéƒ½è¢«å‘é€å’Œæ¥æ”¶äº†ã€‚</li></ul></blockquote><p>&emsp;&emsp;ä»”ç»†è§‚å¯ŸTCPï¼Œå°±ä¼šå‘ç°å®ƒæ˜¯ä¸€ä¸ªç”±é€šå‘Šå’Œç¡®è®¤ç»„æˆçš„å¤æ‚ç³»ç»Ÿï¼Œç”¨ä»¥æ”¯æŒTCPé¢å‘è¿æ¥çš„åŠŸèƒ½ã€‚</p><p>&emsp;&emsp;TCP/IPè¿™æ ·çš„åˆ†å±‚åè®®ç³»ç»Ÿåœ¨å‘é€ç«¯è®¡ç®—æœºä¸ŠæŸä¸€å±‚ä¸æ¥æ”¶ç«¯è®¡ç®—æœº<code>ç›¸åº”çš„å±‚è¿›è¡Œæ•°æ®äº¤æ¢</code>;æ¢å¥è¯å°±è¯´ï¼Œå‘é€ç«¯è®¡ç®—æœºçš„ç½‘ç»œè®¿é—®å±‚ä¸æ¥æ”¶ç«¯è®¡ç®—æœºçš„ç½‘ç»œè®¿é—®å±‚è¿›è¡Œé€šä¿¡ï¼Œå‘é€ç«¯è®¡ç®—æœºä¸Šçš„ç½‘é™…å±‚å’Œæ¥æ”¶ç«¯è®¡ç®—æœºä¸Šçš„ç½‘é™…å±‚é€šä¿¡ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><p>&emsp;&emsp;å…¸å‹çš„ç½‘ç»œç¯å¢ƒä¸­ï¼ˆå›¾6.7ï¼‰ï¼Œæ•°æ®ä»æºå­ç½‘ç»è¿‡è·¯ç”±å™¨ä¼ é€’åˆ°ç›®çš„å­ç½‘ã€‚è¿™äº›è·¯ç”±å™¨é€šå¸¸å·¥ä½œäºç½‘é™…å±‚ï¼Œä¹Ÿå°±æ˜¯ä¼ è¾“å±‚ä¸‹é¢çš„å±‚ã€‚è¿™å…¶ä¸­çš„é‡ç‚¹åœ¨äºè·¯ç”±å™¨ä¸å…³å¿ƒä¼ è¾“å±‚çš„æ¶ˆæ¯ï¼Œä»–ä»¬åªæ˜¯æŠŠä¼ è¾“å±‚æ•°æ®å½“åšIPæ•°æ®æŠ¥çš„å†…å®¹è¿›è¡Œä¼ é€’ã€‚å°è£…åœ¨TCPåˆ†æ®µä¸­çš„è¿™äº›æ§åˆ¶å’Œæ ¡éªŒä¿¡æ¯æ”¯é˜Ÿç›®çš„çš„è®¡ç®—æœºä¸Šçš„TCPè½¯ä»¶æœ‰æ„ä¹‰ã€‚è¿™ç§å·¥ä½œæ–¹å¼èƒ½å¤ŸåŠ å¿«TCP/IPç½‘ç»œä¹‹é—´çš„è·¯ç”±è¿‡ç¨‹ï¼ˆå› ä¸ºè·¯ç”±å™¨ä¸å‚ä¸TCPç»†è‡´çš„è´¨é‡ä¿è¯ï¼‰ï¼ŒåŒæ—¶è®©TCPèƒ½å¤Ÿæ»¡è¶³ç”±ç«¯èŠ‚ç‚¹è¿›è¡Œæ ¡éªŒçš„è¦æ±‚ã€‚</p><ol><li><p><strong>TCPæ•°æ®æ ¼å¼</strong><br> TCPæ•°æ®æ ¼å¼å¦‚å›¾6.8ã€‚å…¶å¤æ‚çš„ç»“æ„æ­ç¤ºäº†TCPçš„å¤æ‚æ€§å’ŒåŠŸèƒ½å¤šæ ·æ€§ã€‚TCPæ ¼å¼ä¸­çš„å­—æ®µå¦‚ä¸‹ï¼š</p><blockquote><ul><li><strong>æºç«¯å£ï¼ˆ16ä½ï¼‰ï¼š</strong>åˆ†é…ç»™æºè®¡ç®—æœºä¸Šçš„åº”ç”¨ç¨‹åºçš„ç«¯å£å·</li><li><strong>ç›®çš„ç«¯å£ï¼ˆ16ä½ï¼‰ï¼š</strong>åˆ†é…ç»™ç›®çš„è®¡ç®—æœºä¸Šçš„åº”ç”¨ç¨‹åºçš„ç«¯å£å·ã€‚</li><li><strong>åºåˆ—å·ï¼ˆ32ä½ï¼‰ï¼š</strong>å½“SYNæ ‡è®°ä¸ä¸º1æ—¶ï¼Œè¿™æ˜¯å½“å‰æ•°æ®åˆ†æ®µç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºåˆ—å·ï¼›å¦‚æœSYNçš„å€¼æ˜¯1ï¼Œè¿™ä¸ªå­—æ®µçš„å€¼å°±æ˜¯åˆå§‹åºåˆ—å€¼(ISN),ç”¨äºå¯¹åºåˆ—å·è¿›è¡ŒåŒæ­¥ï¼Œè¿™æ—¶ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºåˆ—å·æ¯”è¿™ä¸ªå­—æ®µçš„å€¼å¤§1ï¼ˆä¹Ÿå°±æ˜¯ISN+1ï¼‰</li><li><strong>ç¡®è®¤å¥½ï¼ˆ32ä½ï¼‰ï¼š</strong>ç”¨äºç¡®è®¤å·²ç»æ¥æ”¶åˆ°çš„æ•°æ®åˆ†æ®µï¼Œå…¶å€¼æ˜¯æ¥æ”¶è®¡ç®—æœºå³å¯æ¥æ”¶ä¸‹ä¸€ä¸ªåºåˆ—å·ï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ªæ¥æ”¶åˆ°çš„å­—èŠ‚çš„åºåˆ—å·+1</li><li><strong>æ•°æ®åç§»ï¼ˆ4ä½ï¼‰ï¼š</strong>è¿™ä¸ªå­—æ®µè¡¨ç¤ºæŠ¥å¤´çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯å‘Šè¯‰æ¥æ”¶ç«¯çš„TCPè½¯ä»¶æ•°æ®ä»ä½•å¼€å§‹ï¼Œè¿™ä¸ªå€¼å¾—å•ä½æ˜¯32ä½çš„å­—</li><li><strong>ä¿ç•™ï¼ˆ6ä½ï¼‰ï¼š</strong>ä¿ç•™å­—æ®µï¼Œä¸ºTCPå°†æ¥çš„å‘å±•é¢„ç•™ç©ºé—´ï¼Œç›®å‰å…¨éƒ¨ä¸º0</li><li><strong>æ§åˆ¶æ ‡è®°ï¼ˆåˆ†åˆ«å ç”¨1ä½ï¼‰ï¼š</strong>æ§åˆ¶æ ‡è®°ç”¨äºè¡¨ç¤ºæ•°æ®åˆ†æ®µçš„ç‰¹æ®Šæ¶ˆæ¯ã€‚</li><li><strong>URGï¼š</strong>ä¸º1æ—¶è¡¨ç¤ºå½“å‰æ•°æ®åˆ†æ®µæ˜¯ç´§æ€¥çš„ï¼Œä¹Ÿä¼šè®©â€œç´§æ€¥æŒ‡é’ˆâ€å­—æ®µå€¼æœ‰æ„ä¹‰ã€‚</li><li><strong>ACKï¼š</strong>ä¸º1æ—¶è¡¨ç¤ºâ€œç¡®è®¤å·â€å­—æ®µæ˜¯æœ‰æ„ä¹‰çš„ã€‚</li><li><strong>PSHï¼š</strong>ä¸º1æ—¶è®©TCPè½¯ä»¶æŠŠç›®å‰æ”¶åˆ°çš„å…¨éƒ¨æ•°æ®éƒ½é€šè¿‡ç®¡é“ä¼ é€’ç»™æ¥æ”¶åº”ç”¨ç¨‹åºã€‚</li><li><strong>RSTï¼š</strong>ä¸º1æ—¶ä¼šé‡ç½®è¿æ¥ã€‚</li><li><strong>SYNï¼š</strong>ä¸º1æ—¶è¡¨ç¤ºåºåˆ—å·å°†è¢«åŒæ­¥ï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªè¿æ¥çš„å¼€å§‹ï¼Œè¯¦è§ä¸‰æ¬¡æ¡æ‰‹</li><li><strong>FINï¼š</strong>ä¸º1æ—¶è¡¨ç¤ºå‘é€ç«¯è®¡ç®—æœºå·²ç»æ²¡æœ‰æ•°æ®éœ€è¦å‘é€äº†ï¼Œè¿™ä¸ªæ ‡è®°ç”¨äºå…³é—­ä¸€ä¸ªè¿æ¥ã€‚</li><li><strong>çª—å£ï¼ˆ16ä½ï¼‰ï¼š</strong>ç”¨äºæµé‡æ§åˆ¶çš„å‚æ•°ã€‚å®ƒå®šä¹‰äº†å‘é€ç«¯è®¡ç®—æœºçš„å‘é€åºåˆ—å·å¯ä»¥è¶…è¿‡æœ€åä¸€ä¸ªå·²ç¡®è®¤åºåˆ—å·çš„æ•°é‡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå‘é€æ–¹ä¸å¿…ç­‰å¾…æ¯ä¸ªæ•°æ®æ®µè¢«ç¡®è®¤æ¥æ”¶ä¹‹åæ‰å‘é€ä¸‹ä¸€ä¸ªæ•°æ®åˆ†æ®µï¼Œå…è®¸å·²ç»ç¡®è®¤æ¥æ”¶çš„åºåˆ—å·ä¸æ­£åœ¨å‘é€çš„åºåˆ—å·æœ‰ä¸€å®šå·®åˆ«ï¼Œä½†å¿…é¡»åœ¨é€‚å½“èŒƒå›´ä¹‹å†…ã€‚</li><li><strong>æ ¡éªŒå’Œï¼ˆ16ä½ï¼‰ï¼š</strong>ç”¨äºæ ¡éªŒæ•°æ®åˆ†æ®µçš„å®Œæ•´æ€§ï¼Œæ¥æ”¶ç«¯è®¡ç®—æœºä¼šæ ¹æ®æ¥æ”¶åˆ°çš„æ•°æ®åˆ†æ®µè®¡ç®—æ ¡éªŒå’Œï¼Œå¹¶ä¸”æŠŠç»“æ„ä¸è¿™ä¸ªå­—æ®µçš„å€¼è¿›è¡Œæ¯”è¾ƒã€‚TCPå’ŒUDPåœ¨è®¡ç®—æ ¡éªŒå’Œæ—¶åŒ…å«ä¸€ä¸ªå…·æœ‰IPåœ°å€çš„ä¼ªæŠ¥å¤´ã€‚</li><li><strong>ç´§æ€¥æŒ‡é’ˆï¼ˆ16ä½ï¼‰ï¼š</strong>è¿™æ˜¯ä¸€ä¸ªåç§»é‡æŒ‡é’ˆï¼ŒæŒ‡å‘æ ‡è®°ç´§æ€¥ä¿¡æ¯å¼€å§‹çš„åºåˆ—å·ã€‚</li><li><strong>é€‰é¡¹ï¼š</strong>æŒ‡å®šä¸€äº›å¯é€‰è®¾ç½®ä¸­çš„æŸä¸€é¡¹</li><li><strong>æ•°æ®ï¼š</strong>æ•°æ®åˆ†æ®µä¸­çš„æ•°æ®</li></ul></blockquote></li><li><p><strong>TCPè¿æ¥</strong><br>TCPçš„ä¸€åˆ‡è¿æ¥æ“ä½œéƒ½æ˜¯åœ¨ä¸€ä¸ªè¿æ¥ä¸Šä¸‹æ–‡çš„ç¯å¢ƒä¸­å®Œæˆçš„ã€‚TCPé€šè¿‡è¿æ¥å‘é€å’Œæ¥æ”¶æ•°æ®ï¼Œè€Œè¿™ä¸ªè¿æ¥å¿…é¡»æ ¹æ®TCPçš„è§„åˆ™è¿›è¡Œè¯·æ±‚ã€æ‰“å¼€å’Œå…³é—­ã€‚<br> TCPçš„åŠŸèƒ½ä¹‹ä¸€æ˜¯ä¸ºåº”ç”¨ç¨‹åºæä¾›è®¿é—®ç½‘ç»œçš„æ¥å£ã€‚è¿™ä¸ªæ¥å£æ˜¯é€šè¿‡TCPç«¯å£æä¾›çš„ï¼Œè€Œä¸ºäº†é€šè¿‡ç«¯å£æä¾›è¿æ¥ï¼Œå¿…é¡»æ‰“å¼€TCPä¸åº”ç”¨ç¨‹åºçš„æ¥å£ã€‚TCPæ”¯æŒä»¥ä¸‹ä¸¤ç§æ‰“å¼€çŠ¶æ€ã€‚</p><blockquote><ul><li><strong>è¢«åŠ¨æ‰“å¼€ï¼š</strong>æŸä¸ªåº”ç”¨ç¨‹åºè¿›ç¨‹é€šçŸ¥TCPè½¬å‘—é€šè¿‡TCPç«¯å£æ¥æ”¶è¿æ¥ï¼Œè¿™æ ·å°±ä¼šæ‰“å¼€TCPåˆ°åº”ç”¨ç¨‹åºçš„è¿æ¥ï¼Œä»è€Œä¸ºå‚ä¸è¿æ¥çš„è¯·æ±‚åšå‡†å¤‡ã€‚</li><li><strong>ä¸»åŠ¨æ‰“å¼€ï¼š</strong>ç¨‹åºè¦æ±‚TCPå‘èµ·ä¸å¦ä¸€å°è®¡ç®—æœºï¼ˆå¤„äºè¢«åŠ¨æ‰“å¼€çŠ¶æ€ï¼‰çš„è¿æ¥ï¼Œè¿™å°±æ˜¯ä¸»åŠ¨æ‰“å¼€çŠ¶æ€ï¼ˆå®é™…ä¸Šï¼ŒTCPå¯ä»¥å¯¹ä¸€ä¸ªå¤„äºä¸»åŠ¨æ‰“å¼€çŠ¶æ€çš„è®¡ç®—æœºè§¦å‘èµ·è¿æ¥ï¼Œä»¥è§£å†³ä¸¤å°è®¡ç®—æœºå¯èƒ½åŒæ—¶å°è¯•å»ºç«‹è¿æ¥çš„é—®é¢˜ã€‚ï¼‰</li></ul></blockquote></li></ol><p>&emsp;&emsp;åœ¨é€šå¸¸æƒ…å†µä¸‹ï¼Œæƒ³æ¥æ”¶è¿æ¥çš„åº”ç”¨ç¨‹åºï¼ˆæ¯”å¦‚FTPæœåŠ¡å™¨ï¼‰ä¼šæŠŠè‡ªèº«åŠå…¶TCPç«¯å£ç½®äºè¢«åŠ¨æ‰“å¼€çŠ¶æ€ã€‚åœ¨å®¢æˆ·ç«¯è®¡ç®—æœºä¸Šï¼ŒFTPå®¢æˆ·ç«¯çš„TCPçŠ¶æ€ä¸€èˆ¬æ˜¯å…³é—­çš„ï¼Œç›´åˆ°ç”¨æˆ·å‘èµ·ä¸€ä¸ªä»FTPå®¢æˆ·ç«¯åˆ°FTPæœåŠ¡å™¨çš„è¿æ¥ï¼Œè¿™å¯¹äºå®¢æˆ·ç«¯æ¥è¯´å°±æ˜¯ä¸»åŠ¨æ‰“å¼€ã€‚å¤„äºä¸»åŠ¨æ‰“å¼€çŠ¶æ€çš„è®¡ç®—æœºï¼ˆæ¯”å¦‚å®¢æˆ·ç«¯ï¼‰ä¸Šçš„TCPè½¯ä»¶å°±ä¼šå¼€å§‹ä¸€äº›ç”¨äºå»ºç«‹è¿æ¥è¯¶çš„ä¿¡æ¯äº¤æ¢ï¼Œè¿™ç§ä¿¡æ¯äº¤æ¢è¢«ç§°ä¸ºâ€œä¸‰æ¬¡æ¡æ‰‹â€ã€‚</p><p>&emsp;&emsp;TCPå‘é€çš„æ•°æ®åˆ†æ®µæ˜¯ä¸å®šé•¿çš„ã€‚ä¸€ä¸ªæ•°æ®åˆ†æ®µå†…ï¼Œæ¯å­—èŠ‚æ•°æ®éƒ½åˆ†å“¦è¯¶ä¸€ä¸ªåºåˆ—å·ï¼Œæ¥æ”¶ç«¯å¿…é¡»ä¸ºæ¥æ”¶åˆ°çš„æ¯ä¸€ä¸ªå­—èŠ‚æ•°æ®éƒ½å‘é€ä¸€ä¸ªç¡®è®¤å·ã€‚</p><p>&emsp;&emsp;å®é™…ä¸­ï¼Œæ•°æ®åˆ†æ®µä¸­å¹¶ä¸æ˜¯ä¸ºæ¯ä¸ªå­—èŠ‚éƒ½å•ç‹¬ç¼–äº†ä¸€ä¸ªåºåˆ—å·ï¼Œè€Œæ˜¯åœ¨æŠ¥æ–‡çš„â€œåºåˆ—å·â€å­—æ®µåˆ¶å®šäº†æ•°æ®åˆ†æ®µçš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºåˆ—å·ã€‚<br>è¿™ä¸ªè§„åˆ™æœ‰ä¸ªä¾‹å¤–ï¼Œå¦‚æœæ•°æ®åˆ†æ®µæ˜¯è¿æ¥åˆæœŸä½¿ç”¨ï¼Œâ€œåºåˆ—å·â€å­—æ®µé‡Œé¢åŒ…å«çš„ISNï¼Œå®ƒçš„å€¼æ¯”æ•°æ®åˆ†æ®µä¸­ç¬¬ä¸€ä¸ªå­—èŠ‚åºåˆ—å·å°1ã€‚</p><p>&emsp;&emsp;â€œç¡®è®¤å·â€å­—æ®µä¸­çš„å€¼æ˜¯è®¡ç®—æœºå‡†å¤‡æ¥æ”¶çš„ä¸‹ä¸€ä¸ªåºåˆ—å·ã€‚<br>å¦‚æœå‘é€ç«¯è®¡ç®—æœºæ²¡æœ‰åœ¨æŒ‡å®šæ—¶é—´å†…æ”¶åˆ°ç¡®è®¤æ¶ˆæ¯ï¼Œå®ƒå°±ä»å·²ç¡®è®¤çš„ä¸‹ä¸€ä¸ªå­—èŠ‚é‡æ–°å‘é€æ•°æ®ã€‚</p><ol start="3"><li><strong>å»ºç«‹è¿æ¥</strong><br> &emsp;&emsp;ä¸ºäº†è®©åºåˆ—/ç¡®è®¤ç³»ç»Ÿæ­£å¸¸å·¥ä½œï¼Œè®¡ç®—æœºå¿…é¡»å¯¹åºåˆ—å·è¿›è¡ŒåŒæ­¥ã€‚æ¢å¥è¯è¯´ï¼Œè®¡ç®—æœºBå¿…é¡»çŸ¥é“è®¡ç®—æœºAçš„åˆå§‹åºåˆ—å·ï¼ˆISNï¼‰ï¼Œè®¡ç®—æœºAä¹Ÿå¿…é¡»çŸ¥é“è®¡ç®—æœºBä½¿ç”¨ä»€ä¹ˆISNå¼€å§‹ä¼ è¾“æ•°æ®ã€‚<br>è¿™ä¸ªåºåˆ—å·åŒæ­¥çš„è¿‡ç¨‹è¢«ç§°ä¸º<code>ä¸‰æ¬¡æ¡æ‰‹</code>ã€‚ä¸‰æ¬¡æ¡æ‰‹æ€»æ˜¯å‘é€åœ¨TCPå»ºç«‹åˆæœŸã€‚<blockquote><ol><li>è®¡ç®—æœºAå‘é€ä¸€ä¸ªæ•°æ®åˆ†æ®µ,å…¶ä¸­çš„å‚æ•°æ˜¯ï¼š<br>SYN=1<br>ACK=0<br>åºåˆ—å·=X(Xæ˜¯è®¡ç®—æœºAçš„ISN)<br>å¤„äºä¸»åŠ¨æ‰“å¼€çŠ¶æ€çš„è®¡ç®—æœºï¼ˆè®¡ç®—æœºAï¼‰å‘é€ä¸€ä¸ªæ•°æ®åˆ†æ®µï¼Œå…¶ä¸­çš„SYNä¸º1ï¼ŒACKä½0ï¼ŒSUNæ˜¯ï¼ˆåŒæ­¥synchronizeï¼‰ã€‚å®ƒè¡¨ç¤ºåœ¨å°è¯•å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œç¬¬ä¸€ä¸ªæ•°æ®åˆ†æ®µçš„æŠ¥å¤´ä¸­è¿˜åŒ…å«èˆ’é€‚åºåˆ—å·ï¼ˆISNï¼‰ï¼Œæ ‡è®°äº†è®¡ç®—æœºå°†ä¼ è¾“çš„ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºåˆ—å·ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦å‘é€ç»™è®¡ç®—æœºBçš„ç¬¬1ä¸ªå­—èŠ‚çš„åºåˆ—å·æ˜¯ISN+1ã€‚</li><li>è®¡ç®—æœºBæ¥æ”¶åˆ°è®¡ç®—æœºAçš„æ•°æ®åˆ†æ®µï¼Œè¿”å›ä¸€ä¸ªæ•°æ®åˆ†æ®µï¼Œå…¶ä¸­çš„å‚æ•°æ˜¯ï¼š<br>SYN=1(ä»çƒ­åœ¨åŒæ­¥é˜¶æ®µ)<br>ACK=1ï¼ˆâ€œç¡®è®¤å·â€å­—æ®µå°†åŒ…å«ä¸€ä¸ªå€¼ï¼‰<br>åºåˆ—å·=Yï¼ˆYä¸ºè®¡ç®—æœºBçš„ISNï¼‰<br>ç¡®è®¤å·=M+1(Mæ˜¯ä»è®¡ç®—æœºAæ¥æ”¶åˆ°çš„æœ€åä¸€ä¸ªåºåˆ—å·)</li><li>è®¡ç®—æœºAå‘è®¡ç®—æœºBå‘é€ä¸€ä¸ªæ•°æ®åˆ†æ®µï¼Œç¡®è®¤æ”¶åˆ°è®¡ç®—æœºBçš„ISN<br>SYN=0<br>ACK=1<br>åºåˆ—å·=åºåˆ—ä¸­ä¸‹ä¸€ä¸ªå·ç ï¼ˆM+1ï¼‰<br>ç¡®è®¤å·=N+1(å…¶ä¸­Næ˜¯ä»è®¡ç®—æœºBæ¥æ”¶åˆ°çš„æœ€åä¸€ä¸ªåºåˆ—å·)</li></ol></blockquote></li></ol><p>&emsp;&emsp;åœ¨è¿™ä¸‰æ¬¡æ¡æ‰‹å®Œæˆä¹‹åï¼Œè¿æ¥å°±è¢«æ‰“å¼€äº†ï¼ŒTCPæ¨¡å—å°±åˆ©ç”¨åºåˆ—å·å’Œç¡®è®¤æœºåˆ¶å‘é€å’Œæ¥æ”¶æ•°æ®ã€‚</p><ol start="4"><li><strong>TCPæµé‡æ§åˆ¶</strong><br>&emsp;&emsp;TCPä½¿ç”¨çš„æµé‡æ§åˆ¶æ–¹æ³•ç§°ä¸ºâ€œæ»‘åŠ¨çª—å£â€æ–¹æ³•ï¼ŒTCPæŠ¥å¤´ä¸­â€œçª—å£â€å­—æ®µï¼ˆä¹Ÿè¢«ç§°ä¸ºâ€œç¼“å­˜å¤§å°â€ï¼‰ï¼Œæ¥æ”¶å®¢æˆ·ç«¯åˆ©ç”¨â€œçª—å£â€è¿™ä¸ªå­—æ®µæ¥å®šä¹‰ä¸€ä¸ªè¶…è¿‡æœ€åä¸€ä¸ªå·²ç¡®è®¤åºåˆ—å·çš„åºåˆ—å·â€œçª—å£â€ï¼Œåªæœ‰è¿™ä¸ªèŒƒå›´å†…çš„åºåˆ—å·æ‰è¢«å…è®¸å‘é€ç«¯è®¡ç®—æœºå‘é€ã€‚å‘é€ç«¯åœ¨æ²¡æœ‰æ¥æ”¶åˆ°ä¸‹ä¸€ä¸ªç¡®è®¤æ¶ˆæ¯ä¹‹å‰ï¼Œä¸èƒ½å‘é€è¶…è¿‡è¿™ä¸ªçª—å£çš„åºåˆ—å·ã€‚</li><li><strong>å…³é—­è¿æ¥</strong><br>&emsp;&emsp;å½“éœ€è¦å…³é—­è¿æ¥æ—¶ï¼Œè®¡ç®—æœºå¼€å§‹å…³é—­è¿‡ç¨‹ï¼ŒA(FIN:1)-&gt;Bï¼Œä¹‹åè¿›å…¥â€œç»“æŸ-ç­‰å¾…ï¼ˆfin-waitï¼‰â€çŠ¶æ€ï¼ŒAçš„TCPè½¯ä»¶ç»§ç»­æ¥æ”¶æ•°æ®åˆ†æ®µï¼Œå¹¶å¤„ç†æ„è§åœ¨åºåˆ—ä¸­çš„æ•°æ®åˆ†æ®µï¼Œä½†ä¸åœ¨ä»åº”ç”¨ç¨‹åºæ¥æ”¶æ•°æ®äº†ã€‚å½“Bæ¥æ”¶åˆ°FINæ•°æ®åˆ†æ®µæ—¶ï¼Œå®ƒè¿”å›å¯¹FINçš„ç¡®è®¤ä¿¡æ¯ï¼Œç„¶åå‘é€å‰©ä½™çš„æ•°æ®åˆ†æ®µï¼Œé€šçŸ¥æœ¬åœ°åº”ç”¨ç¨‹åºæ¥æ”¶åˆ°äº†FINæ¶ˆæ¯,B(FIN)-&gt;Aï¼ŒAè¿”å›ç¡®è®¤æ¶ˆæ¯ï¼Œè¿æ¥å°±è¢«å…³é—­äº†ã€‚</li></ol><p><strong>6.3.2ã€UDP:æ— è¿æ¥ä¼ è¾“åè®®</strong><br>&emsp;&emsp;UDPå…·æœ‰æœ‰é™çš„é”™è¯¯æ£€éªŒåŠŸèƒ½ï¼Œæ•°æ®æŠ¥ä¸­åŒ…å«ä¸€ä¸ªæ ¡éªŒå’Œï¼Œæ¥æ”¶ç«¯è®¡ç®—æœºåˆ©ç”¨å®ƒæ¥æ ¡éªŒæ•°æ®çš„å®Œæ•´æ€§ã€‚ï¼ˆä¸€èˆ¬ï¼Œè¿™ä¸ªæ ¡éªŒå’Œæ˜¯å¯é€‰çš„ï¼Œè€Œä¸”èƒ½è¢«æ¥æ”¶ç«¯ç¦ç”¨ä»¥åŠ å¿«æ¥æ”¶æ•°æ®å¤„ç†ï¼‰ã€‚UDPæ•°æ®æŠ¥ä¸­æœ‰ä¸€ä¸ªä¼ªæŠ¥å¤´ï¼ŒåŒ…å«æ•°æ®æŠ¥çš„ç›®çš„åœ°å€ï¼Œä»è€Œæä¾›äº†å‘é€æ•°æ®æŠ¥çš„é”™è¯¯ä¼ è¾“æ‰‹æ®µã€‚ å¦å¤–ï¼Œå¦‚æœUDPæ¥æ”¶æ¨¡å—æ¥æ”¶åˆ°ä¸€ä¸ªå‘ç»™æœªæ¿€æ´»æˆ–æœªå®šä¹‰çš„UDPç«¯å£çš„æ•°æ®æŠ¥ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªICMPæ¶ˆæ¯ã€‚é€šçŸ¥æºè®¡ç®—æœºè¿™ä¸ªç«¯å£ä¸å¯è¾¾ã€‚<br>&emsp;&emsp;UDPæ²¡æœ‰é‡æ–°æ’åºçš„åŠŸèƒ½ï¼Œä½†ä¸€èˆ¬ä¸ä¼šå¯¼è‡´ä¸å¯é çš„æ¥æ”¶ã€‚</p><p><strong>æ³¨æ„ï¼š</strong> UDPå’Œå¹¿æ’­</p><blockquote><p>UDPçš„ç®€å•ã€æ— è¿æ¥è®¾è®¡è®©å®ƒæˆä¸ºç½‘ç»œå¹¿æ’­æ‰€ä½¿ç”¨çš„åè®®ï¼Œå¹¿æ’­æ˜¯ä¼šè¢«å­ç½‘å…¨éƒ¨è®¡ç®—æœºæ¥æ”¶å’Œå¤„ç†çš„å•ä¸ªæ¶ˆæ¯ã€‚</p></blockquote><p>&emsp;&emsp;UDPåè®®çš„ä¸»è¦ç”¨é€”æ˜¯<code>æŠŠæ•°æ®æŠ¥ä¼ é€’ç»™åº”ç”¨å±‚</code>ã€‚<br>&emsp;&emsp;UDPå¤´åŒ…å«4ä¸ª16ä½å­—æ®µï¼Œå¦‚å›¾6.9</p><blockquote><ul><li><strong>æºç«¯å£ï¼š</strong>å UDPæŠ¥å¤´çš„å‰16ä½ï¼Œé€šå¸¸åŒ…å«å‘é€æ•°æ®æŠ¥çš„åº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨çš„UDPç«¯å£ã€‚æ¥æ”¶ç«¯åº”ç”¨ç¨‹åºåˆ©ç”¨è¯¥å­—æ®µä½œä¸ºå‘é€å“åº”çš„ç›®çš„åœ°å€ï¼Œè¿™ä¸ªå­—æ®µå¯é€‰ï¼Œä¸å†™å…¶ç«¯å£å·ï¼Œå­—æ®µå…¨éƒ¨ç½®0ã€‚è¿™ç§æƒ…å†µé€‚ç”¨äºå•å‘æ¶ˆæ¯ï¼Œæ— éœ€å“åº”ã€‚</li><li><strong>ç›®çš„ç«¯å£ï¼š</strong>è¿™16ä½å­å¼¹åŒ…å«çš„ç«¯å£åœ°å€ï¼Œæ˜¯æ¥æ”¶ç«¯è®¡ç®—æœºä¸ŠUDPè½¯ä»¶ä½¿ç”¨çš„ç«¯å£ã€‚</li><li><strong>é•¿åº¦ï¼š</strong>è¿™16å­—æ®µä»¥å­—èŠ‚ä¸ºå•ä½è¡¨ç¤ºUDPæ•°æ®æŠ¥çš„é•¿åº¦ã€‚è¿™ä¸ªé•¿åº¦åŒ…å«UDPæŠ¥å¤´å’ŒUDPæ•°æ®è½½è·ã€‚å› ä¸ºUDPæŠ¥å¤´é•¿åº¦æ˜¯8å­—èŠ‚ï¼Œæ‰€ä»¥è¿™ä¸ªå€¼æœ€å°8</li><li><strong>æ ¡éªŒå’Œï¼š</strong>è¿™16ä¸ºå­—æ®µå¯ä»¥æ£€éªŒæ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯å¦æŸåã€‚æ ¡éªŒå’Œæ˜¯å¯¹äºŒè¿›åˆ¶æ•°æ®ä¸²æŒ‡å‘ç‰¹æ®Šè®¡ç®—è€Œå¾—åˆ°çš„ç»“æœã€‚å¯¹äºUDPæ¥è¯´ï¼Œæ ¡éªŒå’Œæ˜¯åŸºäºä¼ªæŠ¥å¤´ã€UDPæŠ¥å¤´ã€UDPæ•°æ®å’Œå¡«å……çš„0è€Œè®¡ç®—ã€‚æºè®¡ç®—æœºç”Ÿæˆæ ¡éªŒå’Œï¼Œç›®çš„è®¡ç®—æœºå¯¹å®ƒè¿›è¡Œæ ¡éªŒï¼Œè®©å¯å®¢æˆ·ç«¯ç”¨ç”¨ç¨‹åºèƒ½å¤Ÿåˆ¤æ–­æ•°æ®æŠ¥æ˜¯å¦å®Œæ•´ã€‚<br>ç”±äºUDPæŠ¥å¤´ä¸­ä¸åŒ…å«æºIPæˆ–ç›®æ ‡IPåœ°å€ï¼Œæ•°æ®æŠ¥å¯èƒ½ä¼šè¢«ä¼ è¾“åˆ°é”™è¯¯çš„è®¡ç®—æœºæˆ–æœåŠ¡ã€‚æ ¡éªŒå’Œä½¿ç”¨çš„éƒ¨åˆ†æ•°æ®æ¥è‡ªäºä»IPæŠ¥å¤´ï¼ˆè¢«ç§°ä¸ºä¼ªæŠ¥å¤´ï¼‰æå–çš„å€¼ï¼Œè¿™ä¸ªä¼ªæŠ¥å¤´åŒ…å«äº†ç›®çš„IPåœ°å€çš„ä¿¡æ¯ã€‚è®©æ¥æ”¶ç«¯è®¡ç®—æœºèƒ½å¤Ÿåˆ¤æ–­UDPæ•°æ®æŠ¥æ˜¯å¦è¢«é”™è¯¯äº¤ä»˜ã€‚</li></ul></blockquote><p><strong>æ³¨æ„ï¼š</strong>å…¶ä»–ä¼ è¾“å±‚åè®®</p><blockquote><p>DCCP(æ•°æ®æŠ¥æ‹¥å¡æ§åˆ¶åè®®)  SCTPï¼ˆæµæ§åˆ¶ä¼ è¾“åè®®ï¼‰æä¾›TCPå’ŒUDPä¸å…·å¤‡çš„å¢å¼ºç‰¹æ€§ã€‚<br>RTP(å®æ—¶ä¼ è¾“åè®®)æä¾›äº†ä¼ è¾“å®æ—¶ç¡¬ç›˜å’Œè§†é¢‘çš„ç»“æ„ã€‚</p></blockquote><p><strong>é—®ï¼š</strong>ä¸ºä»€ä¹ˆè·¯ç”±å™¨ä¸å‘å‘èµ·è¿æ¥çš„è®¡ç®—æœºå‘é€TCPè¿æ¥ç¡®è®¤ï¼Ÿ<br><strong>ç­”ï¼š</strong>è·¯ç”±å™¨å·¥ä½œäºç½‘é™…å±‚ï¼ˆä¼ è¾“å±‚ä¹‹ä¸‹ï¼‰ï¼Œå› æ­¤ä¸å¤„ç†TCPä¿¡æ¯ã€‚</p><h2 id="ç¬¬8ç« -è·¯ç”±é€‰æ‹©"><a href="#ç¬¬8ç« -è·¯ç”±é€‰æ‹©" class="headerlink" title="ç¬¬8ç«  è·¯ç”±é€‰æ‹©"></a>ç¬¬8ç«  è·¯ç”±é€‰æ‹©</h2><p>IPè½¬å‘<br>ç›´æ¥è·¯ç”±å’Œé—´æ¥è·¯ç”±<br>è·¯ç”±åè®®<br>æœ¬ç« å°†ä»‹ç»ç½‘ç»œä¸Šçš„è·¯ç”±å™¨å¦‚ä½•ç»è¿‡ä¸€ä¸ªå¤æ‚çš„é€šä¿¡è¿‡ç¨‹æ¥å†³å®šæ•°æ®ä¼ é€’åˆ°ç›®çš„åœ°å€çš„æœ€ä½³è·¯å¾„ï¼Œå†…å®¹åŒ…æ‹¬<code>è·¯ç”±å™¨</code>ã€<code>è·¯ç”±è¡¨</code>å’Œ<code>è·¯ç”±åè®®</code>;</p><h4 id="8-1-TCP-IPä¸­çš„è·¯ç”±é€‰æ‹©"><a href="#8-1-TCP-IPä¸­çš„è·¯ç”±é€‰æ‹©" class="headerlink" title="8.1 TCP/IPä¸­çš„è·¯ç”±é€‰æ‹©"></a><strong>8.1 TCP/IPä¸­çš„è·¯ç”±é€‰æ‹©</strong></h4><p>&emsp;&emsp;å¤§å¤šæ•°åŸºæœ¬å½¢å¼ä¸­ï¼Œè·¯ç”±å™¨æ˜¯è´Ÿè´£<code>æ ¹æ®é€»è¾‘åœ°å€å¯¹é€šä¿¡æµé‡è¿›è¡Œè¿‡æ»¤çš„è®¾å¤‡</code>ã€‚è·¯ç”±å™¨ä¸€æœ¬å·¥ä½œäºç½‘é™…å±‚ï¼ˆOSIæ¨¡å‹çš„ç½‘ç»œå±‚ï¼‰ä¹Ÿå»ºæˆä¸ºOSIçš„ç¬¬ä¸‰å±‚ï¼Œå› æ­¤è·¯ç”±å™¨ä¹Ÿç§°ä¸ºç¬¬3å±‚è®¾å¤‡ã€‚<br>è¿‘å¹´æ¥ï¼Œç¡¬ä»¶å‚å•†å·²ç»å¼€å‘å‡ºäº†å¯ä»¥å·¥ä½œåœ¨OSIåè®®æ ˆæ›´é«˜å±‚çš„è·¯ç”±å™¨ã€‚æœ¬ç« ä¼šä»‹ç»ç¬¬4åˆ°ç¬¬7å±‚çš„è·¯ç”±å™¨ï¼Œå°±ç›®å‰è€Œè¨€åªè€ƒè™‘å·¥ä½œäºç½‘é™…å±‚ï¼ˆç¬¬3å±‚ï¼Œå’ŒIPå¯»å€ä½äºåŒä¸€å±‚ï¼‰çš„è·¯ç”±å™¨ã€‚</p><p>&emsp;&emsp;å½“è·¯ç”±å™¨å°†æ•°æ®ä»ä¸€ä¸ªç½‘ç»œä¼ è¾“åˆ°ä¸‹ä¸€ä¸ªç½‘ç»œæ—¶ï¼Œå®ƒä¼š<code>æ›¿æ¢</code>ç½‘ç»œè®¿é—®å±‚æŠ¥å¤´ä¿¡æ¯,å› æ­¤è·¯ç”±å™¨å¯ä»¥è¿æ¥ä¸åŒç±»å‹çš„ç½‘ç»œã€‚å¾ˆå¤šè·¯ç”±å™¨è¿˜ç»´æŠ¤å…³äºæœ€ä½³è·¯å¾„çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¿™æ˜¯æ ¹æ®<code>è·ç¦»</code>ã€<code>å¸¦å®½</code>å’Œ<code>æ—¶é—´</code>ç»¼åˆè€ƒè™‘è€Œå¾—åˆ°çš„ã€‚<br><strong>8.1.1 ä»€ä¹ˆæ˜¯è·¯ç”±å™¨</strong><br>&emsp;&emsp;è·¯ç”±å™¨çœ‹ä¸Šå»å°±åƒä¸€å°å…·å¤‡ä¸¤æ¬¾ç½‘ç»œé€‚é…å™¨çš„è®¡ç®—æœºã€‚æ—©æœŸçš„è·¯ç”±å™¨å®é™…ä¸Šå°±æ˜¯å…·æœ‰ä¸¤å—æˆ–å¤šå—ç½‘ç»œé€‚é…å™¨çš„è®¡ç®—æœºï¼ˆä¹Ÿæˆå¤šå®¿ä¸»è®¡ç®—æœºï¼‰ã€‚å¦‚å›¾8.1<br>IPåœ°å€å±äºç½‘ç»œé€‚é…å™¨çš„ï¼Œä¸å±äºè®¡ç®—æœºã€‚å›¾8.1çš„è®¡ç®—æœºæœ‰ä¸¤ä¸ªIPåœ°å€ï¼Œä¸€ä¸ªé€‚é…å™¨å„ä¸€ä¸ªã€‚å®é™…ä¸Šï¼Œè¿™ä¸¤ä¸ªé€‚é…å™¨å¯ä»¥å…·æœ‰å®Œå…¨ä¸åŒçš„IPå­ç½‘å¯¹åº”äºå®Œå…¨ä¸åŒçš„çš„ç‰©ç†ç½‘ç»œã€‚å¤šå®¿ä¸»è®¡ç®—æœºä¸Šçš„åè®®è½¯ä»¶èƒ½å¤Ÿä»ç½‘æ®µAæ¥æ”¶æ•°æ®ï¼ŒæŸ¥çœ‹IPåœ°å€ä¿¡æ¯æ¥åˆ¤æ–­æ•°æ®æ˜¯å¦å±äºç½‘æ®µBã€‚å¦‚æœæ˜¯ï¼Œå°±å°†å…¶ä¸­çš„ç½‘ç»œè®¿é—®å±‚<code>æŠ¥å¤´ä¿¡æ¯</code>æ›¿æ¢ä¸º<code>åŒ…å«ç½‘æ®µBç‰©ç†åœ°å€</code>ä¿¡æ¯çš„æŠ¥å¤´,å†æŠŠæ•°æ®ä¼ é€’ç½‘è·¯Bã€‚</p><p>&emsp;&emsp;è·¯ç”±å™¨çš„å¤æ‚ç‰¹æ€§ï¼š</p><blockquote><ul><li>è·¯ç”±å™¨çš„ç«¯å£ï¼ˆé€‚é…å™¨ï¼‰è¶…è¿‡ä¸¤ä¸ªï¼Œä¹Ÿå°±æ˜¯åŒæ—¶è¿æ¥ä¸¤ä¸ªä»¥ä¸Šçš„ç½‘ç»œã€‚å†³å®šå‘é‚£å“ªé‡Œè½¬å‘æ•°æ®å°±å˜å¾—æ›´å¤æ‚äº†ï¼Œè€Œä¸”å¾ˆå¯èƒ½å¢åŠ å†—ä½™è·¯ç”±ï¼ˆäº‹å®ä¸Šï¼Œç»ˆç«¯ç”¨æˆ·åœ¨å¤§å¤šæ•°LANä¸­è§åˆ°çš„è·¯ç”±å™¨ç”¨äºè¿æ¥ä¸¤ä¸ªç½‘æ®µï¼Œä½†æ˜¯åœ¨Internetç»“æ„å†…å¯ä»¥å­˜åœ¨æ›´ä¸ºå¤æ‚çš„åœºæ™¯ï¼‰</li><li>ç”±è·¯ç”±å™¨è¿æ¥èµ·æ¥çš„ç½‘ç»œè¿˜åˆ†è´ä¸å…¶ä»–ç½‘ç»œè¿æ¥ã€‚æ¢å¥è¯è¯´ï¼Œè·¯ç”±å™¨è§‚å¯Ÿåˆ°çš„ç½‘ç»œåœ°å€å¯èƒ½å¹¶ä¸å±äºå®ƒç›´æ¥è¿æ¥çš„ç½‘ç»œï¼Œå®ƒå¿…é¡»å…·å¤‡æŸç§ç­–ç•¥æŠŠæ•°æ®è½¬å‘åˆ°è¿™äº›éç›´æ¥ç½‘ç»œä¸Šã€‚</li><li>è·¯ç”±å™¨ç½‘ç»œæä¾›äº†å†—ä½™çš„è·¯ç”±ï¼Œæ¯å°è·¯ç”±å™¨å¿…é¡»èƒ½å¤Ÿä»¥æŸç§æ–¹å¼å†³å®šä½¿ç”¨å“ªä¸ªè·¯å¾„ã€‚</li></ul></blockquote><p>&emsp;&emsp;å›¾8.1æ‰€ç¤ºçš„ç®€å•é…ç½®åŠ ä¸Šå‰é¢çš„è¿™å‡ æ¡å¤æ‚æ€§ã€‚å°±å¯ä»¥å¾—åˆ°è·¯ç”±å™¨åŠŸèƒ½æ›´è¯¦ç»†çš„æè¿°ã€‚å¦‚å›¾8.2ã€‚</p><p><strong>8.1.2 è·¯ç”±é€‰æ‹©è¿‡ç¨‹</strong><br>&emsp;&emsp;å¯¹è·¯ç”±å™¨åŠŸèƒ½çš„å…¨é¢ä»‹ç»å¦‚ä¸‹æ‰€è¿°ï¼š</p><blockquote><ol><li>è·¯ç”±å™¨ä»æ‰€è¿æ¥çš„ç½‘ç»œä¹‹ä¸€æ¥æ”¶æ•°æ®ã€‚</li><li>è·¯ç”±å™¨æŠŠæ•°æ®ä¼ é€’åˆ°åè®®æ ˆçš„ç½‘é™…å±‚ã€‚æ¢å¥è¯è¯´ï¼Œè·¯ç”±å™¨æŠ›å¼ƒç½‘ç»œè®¿é—®å±‚å±‚æŠ¥å¤´ä¿¡æ¯ï¼Œå¹¶é‡ç»„IPæ•°æ®æŠ¥ï¼ˆå¦‚æœæœ‰å¿…è¦ï¼‰ã€‚</li><li>è·¯ç”±å™¨æ£€æŸ¥IPæŠ¥å¤´ä¸­çš„ç›®çš„åœ°å€ã€‚</li><li>å¦‚æœæ•°æ®çš„ç›®çš„åœ¨å…¶ä»–ç½‘ç»œï¼Œè·¯ç”±å™¨å°±æ ¹æ®è·¯ç”±è¡¨å†³å®šå‘å“ªé‡Œè½¬å‘æ•°æ®ã€‚</li><li>åœ¨è·¯ç”±å™¨å†³å®šäº†å®ƒçš„å“ªä¸ªé€‚é…å™¨è¦æ¥æ”¶è¿™ä¸ªæ•°æ®åï¼Œå°±æŠŠæ•°æ®ä¼ é€’ç»™é€‚å½“çš„ç½‘ç»œè®¿é—®æµ‹è½¯ä»¶ï¼Œè®©æ•°æ®é€šè¿‡é€‚é…å™¨è¿›è¡Œä¼ è¾“ã€‚</li></ol></blockquote><p>&emsp;&emsp;è¿™ä¸ªè·¯ç”±é€‰æ‹©å¦‚å›¾8.3ï¼Œæœ‰äººè§‰å¾—ç¬¬4æ­¥æ˜¯å…³é”®ã€‚ä½†äº‹å®ä¸Š<code>è·¯ç”±è¡¨</code>å’Œ<code>å»ºç«‹è·¯ç”±è¡¨çš„åè®®</code>æ˜¯è·¯ç”±å™¨å…·æœ‰çš„ä¸¤ä¸ªæ˜¾è‘—ç‰¹æ€§ã€‚å¯¹äºè·¯ç”±å™¨çš„å¤§å¤šæ•°è®¨è®ºéƒ½æ˜¯å…³äº<code>å»ºç«‹è·¯ç”±è¡¨</code>ã€<code>æ±‡é›†è·¯ç”±è¡¨çš„è·¯ç”±åè®®</code>å¦‚ä½•è®©æ‰€æœ‰çš„è·¯ç”±å™¨åƒä¸€ä¸ªæ•´ä½“ä¸€æ ·æä¾›æœåŠ¡ã€‚</p><p>&emsp;&emsp;è·¯ç”±çš„ç±»å‹ä¸»è¦æœ‰ä¸¤ç§ï¼Œå®ƒä»¬çš„åç§°å°±æºè‡ªäºå…¶ä»ä½•å¤„è·å–è·¯ç”±è¡¨ä¿¡æ¯ã€‚</p><blockquote><p><strong>é™æ€è·¯ç”±ï¼š</strong>è¦æ±‚ç½‘ç»œç®¡ç†å‘˜æ‰‹åŠ¨è¾“å…¥è·¯ç”±ä¿¡æ¯ã€‚<br><strong>åŠ¨æ€è·¯ç”±ï¼š</strong>æ ¹æ®ä½¿ç”¨è·¯ç”±åè®®è·å–çš„è·¯ç”±ä¿¡æ¯æ¥åŠ¨æ€å»ºç«‹è·¯ç”±è¡¨ã€‚</p></blockquote><p><strong>æ³¨æ„ï¼š</strong>é¢„é…ç½®è·¯ç”±</p><blockquote><p>å¤§å¤šæ•°åŠ¨æ€è·¯ç”±å™¨å…è®¸è·¯ç”±å™¨è¦†ç›–åŠ¨æ€è·¯ç”±ï¼Œå¹¶ä¸”å¯¹ç‰¹å®šçš„åœ°å€é…ç½®é™æ€è·¯å¾„ã€‚é¢„é…ç½®çš„é™æ€è·¯ç”±æœ‰æ—¶å¯ä»¥ç”¨äºç½‘ç»œæ’é”™ï¼Œæœ‰æ—¶ä¹Ÿå¯ä»¥ç”¨äºå¼ºåˆ¶ä½¿ç”¨å¿«é€Ÿç½‘ç»œè¿æ¥æˆ–å¹³è¡¡ç½‘ç»œæµé‡ã€‚</p></blockquote><p><strong>8.1.3 è·¯ç”±è¡¨çš„æ¦‚å¿µ</strong><br>&emsp;&emsp;è·¯ç”±è¡¨å’Œç½‘é™…å±‚å…¶ä»–è·¯ç”±å…ƒç´ çš„ç”¨é€”åœ¨äºæŠŠæ•°æ®ä¼ é€’åˆ°æ­£ç¡®çš„æœ¬åœ°ç½‘ç»œã€‚å½“æ•°æ®åˆ°è¾¾æœ¬åœ°ç½‘ç»œä¹‹åï¼Œç½‘ç»œè®¿é—®åè®®å°±ä¼šçŸ¥é“å®ƒçš„ç›®çš„åœ°ã€‚å› æ­¤è·¯ç”±è¡¨ä¸éœ€è¦å­˜å‚¨å®Œæ•´çš„IPåœ°å€ï¼Œåªéœ€è¦åˆ—å‡ºç½‘ç»œIDå³å¯ã€‚<br>&emsp;&emsp;å›¾8.4ä¸ºä¸€ä¸ªéå¸¸åŸºæœ¬çš„è·¯ç”±è¡¨å†…å®¹ã€‚ä»æœ¬è´¨ä¸Šè®²ï¼Œè·¯ç”±è¡¨å°±æ˜¯æŠŠ<code>ç›®çš„ç½‘ç»œIDæ˜ å°„åˆ°ä¸‹ä¸€è·³çš„IPåœ°å€</code>ï¼Œå³æ•°æ®æŠ¥é€šå¾€ç›®çš„ç½‘ç»œçš„ä¸‹ä¸€ç«™ã€‚è·¯ç”±è¡¨ä¼šåŒºåˆ†ç›´æ¥è¿æ¥åˆ°è·¯ç”±å™¨æœ¬èº«çš„ç½‘ç»œå’Œé€šè¿‡å…¶ä»–è·¯ç”±å™¨é—´æ¥è¿æ¥è¿‡æ¥çš„ç½‘ç»œã€‚ä¸‹ä¸€è·³å¯ä»¥æ˜¯ç›®çš„ç½‘ç»œï¼ˆå¦‚æœæ˜¯ç›´æ¥è¿æ¥ï¼‰ï¼Œä¹Ÿå¯ä»¥æ˜¯é€šå‘ç›®çš„ç½‘ç»œçš„ä¸‹ä¸€ä¸ªä¸‹æ¸¸è·¯ç”±å™¨ã€‚å›¾8.4ä¸­è·¯ç”±å™¨ç«¯å£æ¥å£æ˜¯æŒ‡è½¬å‘æ•°æ®çš„è·¯ç”±å™¨ç«¯å£ã€‚<br>&emsp;&emsp;è·¯ç”±è¡¨ä¸­çš„â€œä¸‹ä¸€è·³â€æ¡ç›®æ˜¯ç†è§£åŠ¨æ€è·¯ç”±çš„å…³é”®ï¼Œåœ¨å¤æ‚çš„ç½‘ç»œä¸­ï¼Œå¯èƒ½å­˜åœ¨ç€é€šå‘ç›®çš„çš„å¤šæ¡è·¯å¾„ï¼Œè·¯ç”±å™¨å¿…é¡»å†³å®šä¸‹ä¸€è·³æ²¿ç€å“ªæ¡è·¯å¾„å‰è¿›ã€‚åŠ¨æ€è·¯ç”±å™¨å°±ä¸ä½¿ç”¨è·¯ç”±åè®®è·å–çš„ä¿¡æ¯æ¥åšå‡ºå†³å®šã€‚<br><strong>æ³¨æ„ï¼šè·¯ç”±è¡¨</strong></p><blockquote><p>ä¸»æœºè®¡ç®—æœºå¯ä»¥å‘åƒè·¯ç”±å™¨ä¸€æ ·å…·æœ‰è·¯ç”±è¡¨ï¼Œä½†ç”±äºä¸»æœºä¸éœ€è¦æ‰§è¡Œè·¯ç”±åŠŸèƒ½ï¼Œå®ƒçš„è·¯ç”±è¡¨é€šå¸¸ä¸ä¼šé‚£ä¹ˆå¤æ‚ã€‚ä¸»æœºé€šå¸¸ä¼šä½¿ç”¨é»˜è®¤è·¯ç”±æˆ–é»˜è®¤ç½‘å…³ã€‚å½“æ•°æ®æŠ¥ä¸èƒ½å†æœ¬åœ°ç½‘ç»œä¸Šä¼ è¾“æˆ–ä¼ é€’åˆ°å¦ä¸€å°è·¯ç”±å™¨æ—¶ï¼Œå®ƒä¼šè¢«ä¼ é€’åˆ°å……å½“é»˜è®¤ç½‘å…³çš„è·¯ç”±å™¨ã€‚</p></blockquote><p><strong>8.1.4 IPè½¬å‘</strong><br>&emsp;&emsp;ä¸»æœºå’Œè·¯ç”±å™¨éƒ½æœ‰è·¯ç”±è¡¨ï¼Œç›¸å¯¹äºè·¯ç”±å™¨ï¼Œä¸»æœºè·¯ç”±è¡¨ç®€å•å¤šäº†ï¼Œå¯èƒ½åªåŒ…å«ä¸¤è¡Œï¼Œä¸€ä¸ªæ¡ç›®ç”¨äºæœ¬åœ°ç½‘ç»œï¼Œå¦ä¸€ä¸ªç”¨äºé»˜è®¤è·¯ç”±ï¼ˆå¤„ç†ä¸èƒ½åœ¨æœ¬åœ°ç½‘æ®µä¸Šä¼ è¾“çš„æ•°æ®åŒ…ï¼‰</p><p>&emsp;&emsp;ç¬¬4ç« ï¼ŒTCP/IPè½¯ä»¶åˆ©ç”¨ARPå°†IPåœ°å€è§£ææˆæœ¬åœ°ç½‘æ®µä¸Šçš„ç‰©ç†åœ°å€ï¼Œå¦‚æœIPåœ°å€ä¸åœ¨æœ¬åœ°ç½‘æ®µä¸Šä¼šæ€ä¹ˆæ ·ï¼ŸIPä¸åœ¨æœ¬åœ°ç½‘æ®µï¼Œä¸»æœºä¼šæŠŠæ•°æ®æŠ¥å‘é€åˆ°è·¯ç”±å™¨ã€‚å®é™…ä¸Šä¸æ˜¯è¿™ä¹ˆç®€å•ã€‚<br>&emsp;&emsp;IPæŠ¥å¤´ï¼ˆå›¾4.3ï¼‰åªåŒ…å«äº†æºå’Œç›®çš„IPåœ°å€ï¼Œå®ƒæ²¡æœ‰è¶³å¤Ÿç©ºé—´æ¥åˆ—å‡ºä¼ è¾“æ•°æ®æŠ¥çš„ä¸­é—´è·¯ç”±å™¨åœ°å€ã€‚<br>&emsp;&emsp;IPè½¬å‘è¿‡ç¨‹å®é™…ä¸Šä¸ä¼šå†IPæŠ¥å¤´ä¸­å†™å…¥è·¯ç”±å™¨åœ°å€ï¼Œè€Œæ˜¯ç”±ä¸»æœºæŠŠæ•°æ®æŠ¥å’Œè·¯ç”±å™¨çš„IPåœ°å€å‘ä¸‹ä¼ é€’åˆ°ç½‘ç»œè®¿é—®å±‚ï¼Œè¯¥å±‚çš„åè®®è½¯ä»¶ä¼šä½¿ç”¨ä¸€ä¸ªç‹¬ç«‹çš„æŸ¥è¯¢è¿‡ç¨‹æŠŠæ•°æ®æŠ¥å°è£…åˆ°ä¸€ä¸ªå¸§ä¸­ï¼Œé€šè¿‡æœ¬åœ°ç½‘æ®µä¼ é€’ç»™è·¯ç”±å™¨ã€‚æ¢å¥è¯è¯´ï¼Œè¢«è½¬å‘çš„æ•°æ®æŠ¥é‡Œçš„IPåœ°å€æŒ‡å‘æœ€ç»ˆè¦æ¥æ”¶æ•°æ®çš„ä¸»æœºã€‚è€Œè¢«è½¬å‘æ•°æ®æŠ¥çš„å¸§ä¸­çš„ç‰©ç†åœ°å€æŒ‡å‘è·¯ç”±å™¨ä¸Šçš„æœ¬åœ°é€‚é…å™¨åœ°å€ã€‚<br>&emsp;&emsp;ä¸‹é¢ä»‹ç»æ•´ä¸ªè¿‡ç¨‹ï¼ˆå›¾8.5ï¼‰</p><blockquote><ol><li>ä»¥å¤ªä¸»æœºå‡†å¤‡æ”¾ä¸€ä¸ªIPæ•°æ®æŠ¥ï¼Œå®ƒæŸ¥çœ‹è‡ªå·±çš„è·¯ç”±è¡¨</li><li>å¦‚æœæ•°æ®æŠ¥ä¸èƒ½å†æœ¬åœ°ç½‘ç»œä¸Šå‘é€ï¼Œä¸»æœºå°±ä¼šä»è·¯ç”±è¡¨é‡Œè·å–ä¸ç›®çš„åœ°å€ç›¸å…³è”çš„è·¯ç”±å™¨çš„IPåœ°å€ï¼ˆå¯¹äºæœ¬åœ°ç½‘æ®µä¸Šçš„ä¸»æœºæ¥è¯´ï¼Œè¿™ä¸ªè·¯ç”±å™¨çš„IPåœ°å€ä¸€èˆ¬éƒ½æ˜¯é»˜è®¤ç½‘å…³çš„åœ°å€ï¼‰ã€‚è·¯ç”±å™¨çš„IPåœ°å€è¢«ARPåè®®è§£æä¸ºç‰©ç†åœ°å€ã€‚</li><li>æ•°æ®æŠ¥ï¼ˆç›®çš„æ˜¯è¿œç¨‹ä¸»æœºï¼‰å’Œè·¯ç”±å™¨çš„ç‰©ç†åœ°å€ä¸€èµ·è¢«ä¼ é€’ç»™ç½‘ç»œè®¿é—®å±‚ã€‚</li><li>è·¯ç”±å™¨çš„ç½‘ç»œé€‚é…å™¨ä¼šæ¥æ”¶åˆ°è¿™ä¸ªå¸§ï¼Œå› æ­¤å¸§çš„ç›®çš„ç‰©ç†åœ°å€ä¸è·¯ç”±å™¨çš„ç‰©ç†åœ°å€ç›¸åŒ¹é…ã€‚</li><li>è·¯ç”±å™¨å¯¹å¸§è¿›è¡Œæ‹†åŒ…ï¼ŒæŠŠæ•°æ®æŠ¥ä¼ é€’ç»™ç½‘é™…å±‚ã€‚</li><li>è·¯ç”±å™¨æŸ¥çœ‹æ•°æ®æŠ¥çš„IPåœ°å€ï¼Œå¦‚æœè¿™ä¸ªåœ°å€åŒ¹é…è·¯ç”±å™¨è‡ªå·±çš„IPåœ°å€ï¼Œå°±è¡¨ç¤ºæ•°æ®æ˜¯è¦å‘ç»™è·¯ç”±å™¨æœ¬èº«ï¼›å¦åˆ™ï¼Œè·¯ç”±å™¨ä¼šæŸ¥çœ‹è‡ªå·±çš„è·¯ç”±è¡¨ï¼Œæ‰¾åˆ°ä¸æ•°æ®æŠ¥ç›®çš„åœ°å€ç›¸å…³è”çš„è·¯ç”±å™¨ï¼Œå°è¯•è½¬å‘è¿™ä¸ªæ•°æ®æŠ¥ã€‚</li><li>å¦‚ä½•ä¸èƒ½æŠŠæ•°æ®æŠ¥å‘é€åˆ°ä¸è·¯ç”±å™¨ç›¸è¿æ¥çš„ä»»ä½•ç½‘æ®µï¼Œè·¯ç”±å™¨å°±æŠŠæ•°æ®æŠ¥å‘é€ç»™å¦ä¸€å°è·¯ç”±å™¨ï¼Œä¸Šè¿°è¿‡ç¨‹å°±ä¼šè½¦åŠŸå¤«è¿›è¡Œï¼ˆä»ç¬¬1æ­¥å¼€å§‹ï¼‰ï¼ŒçŸ¥é“æœ€åä¸€ä¸ªè·¯ç”±å™¨å°±èƒ½è¿‡æŠŠæ•°æ®æŠ¥ç›´æ¥ä¼ è¾“ç»™ç›®çš„ä¸»æœºã€‚</li></ol></blockquote><p>&emsp;&emsp;æ­¤è¿‡ç¨‹çš„ç¬¬6æ­¥æ˜¯è·¯ç”±å™¨çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ã€‚éœ€è¦è®°ä½çš„æ˜¯ï¼Œå¹¶ä¸æ˜¯å…·æœ‰ä¸¤å—ç½‘å¡çš„è®¾å¤‡å°±èƒ½å……å½“è·¯ç”±å™¨ã€‚å¦‚æœæ²¡æœ‰å¿…è¦çš„è½¯ä»¶æ¥æ”¯æŒIPè½¬å‘ï¼Œå°±ä¸èƒ½æŠŠæ•°æ®ä»ä¸€ä¸ªæ¥å£ä¼ é€’åˆ°å¦ä¸€ä¸ªã€‚å½“ä¸å…·å¤‡IPè½¬å‘åŠŸèƒ½çš„è®¡ç®—æœºæ¥æ”¶åˆ°ç›®æ ‡æ˜¯å…¶ä»–è®¡ç®—æœºçš„æ•°æ®æŠ¥æ—¶ï¼Œå®ƒåªä¼šå¿½ç•¥æ”¶åˆ°çš„æ•°æ®ã€‚</p><p><strong>8.1. ç›´æ¥è·¯ç”±ä¸é—´æ¥è·¯ç”±</strong><br>&emsp;&emsp;å¦‚æœä¸€å°è·¯ç”±å™¨åªè¿æ¥äº†ä¸¤ä¸ªå­ç½‘ï¼Œè·¯ç”±è¡¨å°±ä¼šç›¸å¯¹ç®€å•ã€‚å›¾8.6æ‰€ç¤ºçš„è·¯ç”±å™¨ä¸ä¼šçœ‹åˆ°æ²¡æœ‰ä¸å…¶ç«¯å£ç›¸å…³è”çš„IPåœ°å€ï¼Œè€Œä¸”å®ƒæ˜¯ç›´æ¥è¿æ¥åœ¨å…¨éƒ¨å­ç½‘ä¸Šã€‚æ¢å¥è¯è¯´ï¼Œå›¾ä¸­çš„è·¯ç”±å™¨èƒ½å¤Ÿç›´æ¥åˆ©ç”¨ç›´æ¥è·¯ç”±ä¼ é€’ä»»ä½•æ•°æ®æŠ¥ã€‚</p><p>&emsp;&emsp;å†æ¥çœ‹å›¾8.7ï¼Œæ›´å¤æ‚ä¸€ç‚¹çš„ç½‘ç»œã€‚è·¯ç”±Aæ²¡æœ‰è¿æ¥åˆ°ç½‘æ®µ3,è€Œä¸”åœ¨æ²¡æœ‰ä»»ä½•å¸®åŠ©çš„æƒ…å†µä¸‹ä¹Ÿä¸èƒ½å‘ç°ç½‘æ®µ3ï¼Œè¿™ç§æƒ…å†µä¸ºé—´æ¥è·¯ç”±ã€‚å¤§å¤šæ•°è·¯ç”±å¼ç½‘ç»œéƒ½åœ¨æŸç§ç¨‹åº¦ä¸Šä¾èµ–äºé—´æ¥è·¯ç”±ã€‚å…³äºå›¾8.7,æœ€å¤§çš„é—®é¢˜æ˜¯è·¯ç”±å™¨Aå¦‚ä½•å‘ç°ç½‘æ®µ3ï¼Ÿè·¯ç”±å™¨Aå¦‚ä½•çŸ¥é“å‘å¾€ç½‘æ®µ3çš„æ•°æ®æŠ¥åº”è¯¥è½¬å‘ç»™è·¯ç”±å™¨Bè€Œä¸æ˜¯è·¯ç”±å™¨Cå‘¢ï¼Ÿ</p><p>&emsp;&emsp;è·¯ç”±å™¨äº†è§£é—´æ¥è·¯ç”±å™¨çš„æ–¹å¼æœ‰ä¸¤ç§ï¼šä»ç³»ç»Ÿç®¡ç†å‘˜å’Œä»å…¶ä»–è·¯ç”±å™¨ã€‚<br>&emsp;&emsp;è¿™ä¸¤ç§æ–¹å¼åˆ†åˆ«å¯¹åº”é™æ€è·¯ç”±å’ŒåŠ¨æ€è·¯ç”±ã€‚ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥ç›´æ¥ä»è·¯ç”±è¡¨ä¸­è¾“å…¥ç½‘ç»œè·¯ç”±ï¼ˆé™æ€è·¯ç”±ï¼‰ï¼Œæˆ–è€…è·¯ç”±å™¨Bå¯ä»¥ç›´æ¥å‘Šè¯‰è·¯ç”±å™¨Aå…³äºç½‘æ®µ3çš„ä¿¡æ¯ï¼ˆåŠ¨æ€è·¯ç”±ï¼‰ã€‚åŠ¨æ€è·¯ç”±å…·æœ‰ä¸€ä¸ªä¼˜ç‚¹ï¼Œé¦–å…ˆï¼Œå®ƒä¸éœ€è¦äººå·¥å¹²é¢„ã€‚å…¶æ¬¡ï¼Œå®ƒå¯ä»¥å¯¹ç½‘ç»œçš„æ”¹å˜åšå‡ºç›¸åº”ã€‚å¦‚æœä¸€ä¸ªæ–°çš„ç½‘æ®µè¿æ¥åˆ°äº†è·¯ç”±å™¨Bï¼Œè·¯ç”±å™¨Bå°±èƒ½æŠŠè¿™ä¸ªæ”¹å˜é€šçŸ¥è·¯ç”±å™¨Aã€‚</p><p><strong>æ³¨æ„ï¼š</strong>é™æ€è·¯ç”±å’ŒåŠ¨æ€è·¯ç”±</p><blockquote><p>è·¯ç”±å™¨æœ‰æ—¶ä¼šåŒæ—¶ä½¿ç”¨é™æ€è·¯ç”±å’ŒåŠ¨æ€è·¯ç”±ã€‚ç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥é…ç½®ä¸€äº›é™æ€è·¯ç”±ï¼Œè®©å…¶ä»–è·¯å¾„åŠ¨æ€åˆ†é…ã€‚é™æ€è·¯ç”±æœ‰æ—¶å¯ä»¥ç”¨äºå¼ºåˆ¶æµé‡ç»è¿‡ç‰¹å®šè·¯å¾„ã€‚ä¾‹å¦‚ï¼šç³»ç»Ÿç®¡ç†å‘˜é€šè¿‡é…ç½®è·¯ç”±å™¨å¯ä»¥æŠŠæµé‡å¯¼å‘å¸¦å®½è¾ƒå¤§çš„é“¾æ¥ã€‚</p></blockquote><p><strong>8.1.6 åŠ¨æ€è·¯ç”±ç®—æ³•</strong><br>&emsp;&emsp;è·¯ç”±å™¨çš„è¡Œä¸ºå®Œå…¨ä¾èµ–äºè·¯ç”±è¡¨ã€‚ç›®å‰ä½¿ç”¨çš„è·¯ç”±åè®®æœ‰å¾ˆå¤šç§ï¼Œå…¶ä¸­å¾ˆå¤šæ˜¯å›´ç»•ç€è¿™ä¸¤ç§è·¯ç”±æ–¹æ³•ä¹‹ä¸€è®¾è®¡çš„ã€‚è¿™ä¸¤ç§æ–¹æ³•åˆ†åˆ«æ˜¯<code>è·ç¦»çŸ¢é‡è·¯ç”±</code>å’Œ<code>é“¾è·¯çŠ¶æ€è·¯ç”±</code>ã€‚<br>è¿™ä»¤ä¸­æ–¹æ³•å…¶å®å°±æ˜¯è·¯ç”±å™¨<code>ç›¸äº’é€šä¿¡</code>å’Œ<code>æ”¶é›†è·¯ç”±ä¿¡æ¯</code>æ‰€é‡‡ç”¨çš„ä¸åŒæ–¹æ³•ã€‚<br>ä½¿ç”¨ä¸¤ç§æ–¹æ³•çš„ä¸€å †è·¯ç”±åè®®ï¼š<code>RIP</code>(è·ç¦»çŸ¢é‡è·¯ç”±åè®®)å’Œ<code>OSPF</code>(é“¾è·¯çŠ¶æ€è·¯ç”±åè®®)<br><strong>è¯´æ˜ï¼š</strong>åè®®å’Œå®ç°<br>è·ç¦»çŸ¢é‡å’Œé“¾è·¯çŠ¶æ€æ˜¯è·¯ç”±åè®®çš„ç´¯å‘—ï¼Œå®é™…åè®®çš„å…·ä½“å®ç°è¿˜åŒ…æ‹¬å…¶ä»–ç‰¹å®šå’Œç»†èŠ‚ã€‚å¦å¤–ï¼Œå¾ˆå¤šè·¯ç”±å™¨æ”¯æŒå¯åŠ¨è„šæœ¬ï¼Œé™æ€è·¯ç”±æ¡ç›®ç­‰åŠŸèƒ½ï¼Œä½¿å¯¹è·ç¦»çŸ¢é‡å’Œé“¾è·¯çŠ¶æ€è·¯ç”±çš„ç†æƒ³åŒ–æè¿°å˜å¾—éå¸¸å¤æ‚ã€‚</p><h4 id="1ã€è·ç¦»çŸ¢é‡è·¯ç”±"><a href="#1ã€è·ç¦»çŸ¢é‡è·¯ç”±" class="headerlink" title="1ã€è·ç¦»çŸ¢é‡è·¯ç”±"></a><strong>1ã€è·ç¦»çŸ¢é‡è·¯ç”±</strong></h4><p>&emsp;&emsp;è·ç¦»çŸ¢é‡è·¯ç”±ï¼ˆä¹Ÿç§°ä¸ºè´å°”æ›¼-ç¦ç‰¹è·¯ç”±ï¼‰æ˜¯ä¸€ç§é«˜æ•ˆã€ç®€å•çš„è·¯ç”±æ–¹æ³•ï¼Œè¢«å¾ˆå¤šè·¯ç”±åè®®æ‰€é‡‡ç”¨ã€‚å®ƒæ›¾ç»åœ¨è·¯ç”±ç•Œå ç»Ÿæ²»åœ°ä½ï¼Œè™½ç„¶æœ€è¿‘å‡ å¹´ä¸€äº›æ›´å¤æ‚çš„è·¯ç”±æ–¹æ³•ï¼ˆæ¯”å¦‚é“¾è·¯çŠ¶æ€è·¯ç”±ï¼‰é€æ¸æµè¡Œèµ·æ¥ï¼Œä½†è·ç¦»çŸ¢é‡è·¯ç”±ä»ç„¶ç›¸å½“å¸¸è§ã€‚<br>&emsp;&emsp;è·ç¦»çŸ¢é‡è·¯ç”±è®¾è®¡ç›®æ ‡ï¼šè·¯ç”±å™¨ä¹‹é—´æ‰€éœ€é€šä¿¡æœ€å°‘ï¼Œè·¯ç”±è¡¨ä¸­å¿…é¡»ä¿ç•™çš„æ•°æ®æœ€å°‘ã€‚è¿™ç§è®¾è®¡ç†å¿µè®¤ä¸ºè·¯ç”±å™¨ä¸å¿…çŸ¥é“é€šå‘æ¯ä¸ªç½‘æ®µçš„å®Œæ•´è·¯å¾„ï¼Œè€Œæ˜¯åªéœ€çŸ¥é“å‘å“ªä¸ªæ–¹æ³•æ–¹æ•°æ®æŠ¥å³å¯ï¼ˆè¿™ä¹Ÿæ˜¯æœ¯è¯­â€œçŸ¢é‡â€çš„ç”±æ¥ï¼‰ã€‚ç½‘æ®µä¹‹é—´çš„è·ç¦»ä»¥æ•°æ®æŠ¥åœ¨ä¸¤ä¸ªç½‘ç»œä¹‹é—´ä¼ è¾“å¿…é¡»ç»è¿‡çš„è·¯ç”±å™¨çš„æ•°é‡æ¥è¡¨ç¤ºï¼Œè€Œä½¿ç”¨è·ç¦»çŸ¢é‡è·¯ç”±çš„è·¯ç”±å™¨ä¼˜åŒ–è·¯å¾„çš„æ–¹å¼æ˜¯è®©æ•°æ®æŠ¥å¿…é¡»ç»è¿‡çš„è·¯ç”±å™¨è¾¾åˆ°æœ€å°‘ã€‚è¿™ä¸ªè·ç¦»å‚æ•°è¢«ç§°ä¸ºâ€œè·³æ•°â€ã€<br>&emsp;&emsp;è·ç¦»çŸ¢é‡è·¯ç”±çš„å·¥ä½œæ–¹å¼å¦‚ä¸‹ï¼š</p><blockquote><ol><li>å½“è·¯ç”±å™¨Aåˆå§‹åŒ–æ—¶ï¼Œå®ƒæ„ŸçŸ¥åˆ°ç›´æ¥è¿æ¥çš„ç½‘æ®µï¼Œå¹¶æŠŠè¿™äº›ç½‘æ®µå†™å…¥åˆ°è‡ªå·±çš„è·¯ç”±è¡¨ä¸­ã€‚è¿™äº›ç›´è¿ç½‘æ®µçš„è·³æ•°ä¸º0ï¼Œå› æ­¤æ•°æ®æŠ¥ä»è¿™å°è·¯ç”±å™¨åˆ°è¾¾è¿™äº›ç½‘æ®µä¸éœ€è¦ç»è¿‡å…¶ä»–è·¯ç”±å™¨ï¼Œ</li><li>åœ¨å‘¨æœŸæ€§çš„æ—¶é—´é—´éš”ä¸­ï¼Œè·¯ç”±å™¨å™¨æ¥æ”¶åˆ°æ¥è‡ªé‚»å±…è·¯ç”±å™¨çš„æŠ¥å‘Šï¼Œå…¶ä¸­åŒ…å«äº†é‚»å±…è·¯ç”±å™¨æ‰€æ„ŸçŸ¥çš„ç½‘æ®µå’Œç›¸åº”çš„è·³æ•°ã€‚</li><li>å½“è·¯ç”±å™¨Aä»é‚»å±…è·¯ç”±å™¨æ”¶åˆ°æŠ¥å‘Šåï¼ŒæŒ‰ç…§å¦‚ä¸‹æ–¹æ³•æŠŠæ–°çš„è·¯ç”±ä¿¡æ¯æ·»åŠ åˆ°è‡ªå·±çš„è·¯ç”±è¡¨ä¸­ã€‚</li></ol><ul><li>å¦‚æœè·¯ç”±å™¨Bçš„ä¿¡æ¯ä¸­åŒ…å«ä¸€ä¸ªè·¯ç”±å™¨Aç›®å‰è¿˜ä¸çŸ¥é“çš„ç½‘æ®µï¼Œè·¯ç”±å™¨Aå°±æŠŠè¿™ä¸ªç½‘æ®µæ·»åŠ åˆ°è‡ªå·±çš„è·¯ç”±è¡¨ä¸­ã€‚å»å¾€è¿™ä¸ªæ–°ç½‘æ®µçš„è·¯ç”±å°±æ˜¯è·¯ç”±å™¨Bï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœè·¯ç”±å™¨Aæ”¶åˆ°å‘å‘è¿™ä¸ªæ–°ç½‘æ®µçš„æ•°æ®æŠ¥ï¼Œå®ƒä¼šè½¬å‘ç»™è·¯ç”±å™¨Bã€‚å¯¹äºè·¯ç”±å™¨Aæ¥è¯´ï¼Œè¿™ä¸ªæ–°ç½‘æ®µçš„è·³æ•°æ˜¯è·¯ç”±å™¨Bçš„ä¿¡æ¯ä¸­åˆ—å‡ºçš„è·³æ•°å†åŠ 1ï¼Œå› æ­¤å®ƒä¸è·¯ç”±å™¨Bç›¸æ¯”ï¼Œåˆ°è¾¾è¿™ä¸ªç½‘æ®µéœ€è¦å¤šä¸€è·³ã€‚</li><li>å¦‚æœè·¯ç”±å™¨Bçš„ä¿¡æ¯ä¸­åŒ…å«çš„ç½‘æ®µå·²ç»å­˜åœ¨è·¯ç”±å™¨Açš„è·¯ç”±è¡¨ä¸­ï¼Œè·¯ç”±å™¨Aå°±ä¼šæŠŠæ”¶åˆ°çš„è·³æ•°+1ï¼ŒæŠŠå¾—åˆ°çš„å€¼ä¸è‡ªå·±è·¯ç”±è¡¨ä¸­çš„å€¼ç›¸æ¯”è¾ƒï¼Œå¦‚æœç»è¿‡è·¯ç”±å™¨Bçš„è·¯ç”±æ¯”è·¯ç”±å™¨Aå·²ç»æŒæ¡çš„è·¯å¾„æ›´æœ‰æ•ˆç‡ï¼ˆè·³æ•°æ›´å°ï¼‰ï¼Œè·¯ç”±å™¨Aå°±æ›´æ–°è‡ªå·±çš„è·¯ç”±è¡¨ï¼ŒæŠŠè·¯ç”±å™¨Bä½œä¸ºé€šå‘ç›¸åº”ç½‘æ®µçš„è·¯å¾„ã€‚</li><li>å¦‚æœé€šè¿‡è·¯ç”±å™¨Bçš„è·³æ•°æ¯”è·¯ç”±å™¨Aè·¯ç”±è¡¨ä¸­çš„å½“å‰è·¯ç”±è·³æ•°å¤§ï¼Œç»è¿‡è·¯ç”±å™¨Bçš„è·¯ç”±å°±ä¸ä¼šè¢«ä½¿ç”¨ï¼Œè·¯ç”±å™¨Aç»§ç»­ä½¿ç”¨è‡ªå·±è·¯ç”±è¡¨ä¸­ä¿å­˜å’‹è·¯å¾„ã€‚</li></ul></blockquote><p>&emsp;&emsp;éšç€æ¯ä¸€è½®è·¯ç”±è¡¨çš„æ›´æ–°ï¼Œè·¯ç”±å™¨å¯¹ç½‘ç»œçš„äº†è§£è¶Šæ¥è¶Šå…¨é¢ã€‚å…³äºè·¯ç”±çš„ä¿¡æ¯é€æ¸æ•£æ­¥åˆ°åªæ•´ä¸ªç½‘ç»œã€‚å‡è®¾ç½‘ç»œä¸å‘ç”Ÿæ”¹å˜ï¼Œè·¯ç”±å™¨å°±ä¼šæœ€ç»ˆäº†è§£åˆ°é€šå‘æ¯ä¸ªç½‘æ®µçš„æœ€é«˜æ•ˆçš„è·¯å¾„ã€‚</p><p>&emsp;&emsp;å›¾8.8æ‰€ç¤ºä¸ºä¸€ä¸ªè·ç¦»çŸ¢é‡è·¯ç”±æ›´æ–°çš„ä¾‹å­ã€‚ä¸»è¦åˆ°åœ¨è¿™ä¸€æ—¶åˆ»ï¼Œå·²ç»å‘ç”Ÿä¸€äº›æ›´æ–°ã€‚å› ä¸ºè·¯ç”±å™¨Aå’Œè·¯ç”±å™¨Béƒ½å·²ç»äº†è§£åˆ°æ²¡æœ‰ç›´æ¥çš„ç½‘æ®µã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œè·¯ç”±å™¨Bå…·æœ‰é€šå‘ç½‘ç»œ14çš„æ›´ä¼˜è·¯å¾„ã€‚æ‰€ä»¥è·¯ç”±å™¨Aå°±ä¼šæ›´æ–°è‡ªå·±çš„è·¯ç”±è¡¨ï¼ŒæŠŠå‘å¾€ç½‘ç»œ14çš„æ•°æ®è½¬å‘ç»™è·¯ç”±å™¨Bã€‚å¯¹äºç½‘ç»œ7æ¥è¯´ï¼Œè·¯ç”±å™¨Aå·²ç»æŒæ¡çš„è·¯å¾„æ›´å¥½ï¼Œæ‰€ä»¥è¡¨ä¸­ç›¸åº”å†…å®¹æ²¡æœ‰æ”¹å˜ã€‚</p><h4 id="2ã€é“¾è·¯çŠ¶æ€è·¯ç”±"><a href="#2ã€é“¾è·¯çŠ¶æ€è·¯ç”±" class="headerlink" title="2ã€é“¾è·¯çŠ¶æ€è·¯ç”±"></a><strong>2ã€é“¾è·¯çŠ¶æ€è·¯ç”±</strong></h4><p>&emsp;&emsp;åœ¨å‡è®¾è·¯å¾„æ•ˆç‡ç­‰åŒäºç»è¿‡è·¯ç”±å™¨æ•°é‡æ—¶ï¼Œè·ç¦»çŸ¢é‡è·¯ç”±æ˜¯ä¸ªå¾ˆå¥½çš„æ–¹æ³•ã€‚è¿™ç§å‡è®¾çš„åˆè¡·å¾ˆå¤šå•Šï¼Œä½†åœ¨æœ‰äº›æƒ…å†µä¸‹è¿‡äºç®€å•äº†ï¼ˆå³ä½¿åœ¨è·³æ•°ä¸€æ ·çš„æƒ…å†µä¸‹ï¼Œç»è¿‡ä½é€Ÿé“¾è·¯çš„è·¯ç”±ä¹Ÿä¼šæ¯”ç»è¿‡é«˜é€Ÿé“¾è·¯çš„æ…¢ï¼‰ã€‚å¦å¤–ï¼Œè·ç¦»çŸ¢é‡è·¯ç”±å¹¶ä¸ç‰¹åˆ«ä½¿ç”¨ä¸å…·æœ‰å¤§é‡è·¯ç”±å™¨çš„ç¯å¢ƒï¼Œå› ä¸ºæ²¡å¤ªè·¯ç”±å™¨ä¸ºæ¯ä¸ªç›®çš„ç½‘å…³éƒ½å¿…é¡»ç»´æŠ¤ä¸€ä¸ªè·¯ç”±æ¡ç›®ï¼Œè€Œè¿™äº›æ¡ç›®ä¸è¿‡æ˜¯çŸ¢é‡å’Œè·³æ•°ã€‚è·¯ç”±å™¨æ— æ³•å……åˆ†åˆ©ç”¨å¯¹ç½‘ç»œç»“æ„çš„æ›´å¤šäº†è§£æ¥æé«˜å…¶æ•ˆç‡ã€‚è€Œä¸”ï¼Œå³ä½¿åœ¨å¤§é‡ä¿¡æ¯éƒ½ä¸å¿…è¦çš„æƒ…å†µä¸‹ï¼ŒåŒ…å«è·ç¦»å’Œè·³æ•°çš„å®Œæ•´è¡¨æ ¼å¿…é¡»åœ¨è·¯ç”±å™¨ä¹‹é—´è¿›è¡Œä¼ è¾“ã€‚è®¡ç®—æœºç§‘å­¦å¼€å§‹æ€è€ƒèƒ½å¦åšçš„æ›´å¥½ï¼Œç”±æ­¤è¯ç”Ÿäº†é“¾è·¯çŠ¶æ€è·¯ç”±ï¼Œè€Œä¸”å®ƒå·²ç»æˆä¸ºè·ç¦»çŸ¢é‡è·¯ç”±å™¨çš„ä¸»è¦å¯¹æ‰‹ã€‚</p><p>&emsp;&emsp;è¿æ¥çŠ¶æ€è·¯ç”±èƒŒåçš„ç†å¿µåœ¨äºæ¯ä¸ªè·¯ç”±å™¨éƒ½å°è¯•å»ºç«‹å…³äºç½‘ç»œæ‹“æ‰‘çš„å†…éƒ¨æ˜ å°„ã€‚æ¯å°è·¯ç”±å™¨å®šæœŸå‘ç½‘ç»œå‘é€çŠ¶æ€ä¿¡æ¯ï¼Œå…¶ä¸­åˆ—å‡ºäº†è‡ªå·±ç›´è¿çš„å…¶ä»–è·¯ç”±å™¨ä»¥åŠé“¾è·¯çš„çŠ¶æ€ï¼ˆé“¾è·¯åœ¨å½“å‰æ˜¯å¦å¯ç”¨ï¼‰ã€‚è·¯ç”±å™¨åˆ©ç”¨ä»å…¶ä»–è·¯ç”±å™¨æ”¶åˆ°çš„çŠ¶æ€æ¶ˆæ¯å»ºç«‹ç½‘ç»œæ‹“æ‰‘çš„æ˜ å°„ï¼Œå½“å®ƒéœ€è¦è½¬å‘æ•°æ®æŠ¥æ—¶ï¼Œä¼šæ ¹æ®ç°æœ‰æ¡ä»¶é€‰æ‹©æœ€ä½³è·¯å¾„ã€‚<br>&emsp;&emsp;è¿æ¥çŠ¶æ€è·¯ç”±åœ¨æ¯å°è·¯ç”±å™¨ä¸Šéƒ½éœ€è¦æ›´å¤šçš„å¤„ç†æ—¶é—´ã€‚ä½†å¸¦å®½æ¶ˆè€—å‡å°‘ï¼Œå› ä¸ºæ²¡å¤ªè·¯ç”±å™¨ä¸éœ€è¦ä¼ æ’­å®Œæ•´çš„è·¯ç”±è¡¨ã€‚å¦å¤–é€šè¿‡ç½‘ç»œè¿½è¸ªæ•…éšœæ›´å®¹æ˜“äº†ï¼Œå› ä¸ºç‰¹å®šè·¯ç”±å™¨å‘å‡ºçš„çŠ¶æ€æ¶ˆæ¯åœ¨ç½‘ç»œä¸Šä¼ è¾“æ—¶ä¸ä¼šè¢«æ”¹å˜ï¼ˆè€Œåœ¨å¦ä¸€æ–¹é¢ï¼Œå³ä½¿è·ç¦»çŸ¢é‡è·¯ç”±æ–¹æ³•çš„è·¯ç”±å™¨ä¼šåœ¨æ”¶åˆ°è·¯ç”±å™¨æ¶ˆæ¯æ—¶ä¿®æ”¹å…¶ä¸­çš„è·³æ•°ï¼‰ã€‚</p><h4 id="8-2-å¤æ‚ç½‘ç»œä¸Šçš„è·¯ç”±"><a href="#8-2-å¤æ‚ç½‘ç»œä¸Šçš„è·¯ç”±" class="headerlink" title="8.2 å¤æ‚ç½‘ç»œä¸Šçš„è·¯ç”±"></a><strong>8.2 å¤æ‚ç½‘ç»œä¸Šçš„è·¯ç”±</strong></h4><p>&emsp;&emsp;å¤§å‹ç½‘ç»œä¸ŠåŒ…å«æ•°ä»¥ç™¾è®¡çš„è·¯ç”±å™¨ï¼ŒInternetåˆ™åŒ…å«æ•°ä»¥åƒè®¡çš„è·¯ç”±å™¨ã€‚åœ¨åƒInternetè¿™æ ·çš„å¤§å‹ç½‘ç»œä¸Šï¼Œè®©å…¨éƒ¨è·¯ç”±å™¨éƒ½å…±äº«å‰é¢æ‰€è¿°è·¯ç”±æ–¹æ³•çš„æ‰€æœ‰ä¿¡æ¯æ˜¯ä¸å¯èƒ½çš„ã€‚å¦‚æœæ¯å°è·¯ç”±å™¨éƒ½å¤„ç†Internetä¸Šå…¶ä»–è·¯ç”±å™¨çš„è·¯ç”±ä¿¡æ¯ï¼Œè·¯ç”±åè®®çš„æµé‡å’Œè·¯ç”±è¡¨çš„è§„æ¨¡å¾ˆå¿«å°±ä¼šè®©æ•´ä¸ªç³»ç»Ÿå´©æºƒã€‚<br>&emsp;&emsp;å¯¹äºInternetä¸Šçš„è·¯ç”±å™¨ï¼Œå¹¶ä¸æ˜¯æ¯ä¸€å°è·¯ç”±å™¨éƒ½éœ€è¦çŸ¥é“å…¶ä»–æ‰€æœ‰è·¯ç”±å™¨çš„ä¿¡æ¯ã€‚<br>&emsp;&emsp;åœ¨ç½‘ç»œæœ‰æ•ˆç»„ç»‡ç¯å¢ƒä¸‹ï¼Œå¤§å¤šæ•°è·¯ç”±å™¨åªéœ€è¦ä¸ç›¸é‚»è·¯ç”±å™¨äº¤äº’åè®®ä¿¡æ¯å³å¯ã€‚</p><p>&emsp;&emsp;åœ¨å­•è‚²äº†Internetçš„ARPAnetç³»ç»Ÿä¸­ï¼Œä¸€å°ç»„æ ¸å¿ƒè·¯ç”±å™¨ä½œä¸ºç½‘ç»œäº’è”çš„ä¸­å¤®éª¨å¹²ç½‘ï¼ŒæŠŠè‡ªåŠ¨é…ç½®å’Œç®¡ç†çš„ç‹¬ç«‹ç½‘ç»œè¿æ¥åœ¨ä¸€èµ·ã€‚æ ¸å¿ƒè·¯ç”±å™¨äº†è§£æ¯ä¸ªç½‘ç»œã€‚ä½†ä¸å¿…çŸ¥é“æ¯ä¸ªå­ç½‘ã€‚åªè¦æ•°æ®æŠ¥èƒ½å¤Ÿæ‰¾åˆ°åˆ°è¾¾æ ¸å¿ƒè·¯ç”±å™¨çš„è·¯å¾„ï¼Œå°±èƒ½å¤Ÿåˆ°è¾¾æ•´ä¸ªç½‘ç»œçš„ä»»ä½•ä½ç½®ã€‚é™„å±ç½‘ç»œçš„è·¯ç”±å™¨ä¸å¿…äº†è§£ä¸–ç•Œçš„å…¨éƒ¨ç½‘ç»œã€‚è¿™ä¸ªç³»ç»Ÿçš„å‘å±•ä¸ºå¤æ‚çš„ç°ä»£Internet(è¯¦è§ç¬¬17ç« )ã€‚</p><p>&emsp;&emsp;Internetç”±å„ä¸ªç‹¬è‡ªç®¡ç†çš„ç½‘ç»œç»„æˆï¼Œè¿™äº›ç½‘ç»œæˆä¸º<code>è‡ªæ²»ç³»ç»Ÿ</code>ã€‚è‡ªæ²»ç³»ç»Ÿå¯ä»¥æ˜¯ä¸ªå…¬å¸ç½‘ç»œï¼Œä½†ç›®å‰æ›´å¸¸è§çš„æ˜¯ä¸InternetæœåŠ¡ä¾›åº”å•†ï¼ˆISPï¼‰ç›¸å…³è”çš„ç½‘ç»œã€‚è‡ªæ²»ç³»ç»Ÿçš„æ‰€æœ‰è€…ç®¡ç†æ¯å°è·¯ç”±å™¨çš„é…ç½®ç»†èŠ‚ã€‚å¤§å¤šæ•°è·¯ç”±å™¨æŒ‰ç…§å¦‚ä¸‹çš„é€šç”¨åˆ†ç±»è¿›è¡ŒæŒ‡è´£åˆ’åˆ†ï¼Œå°½ç®¡ä»¥å¤ªè·¯ç”±å™¨å¯ä»¥å……å½“å¤šé‡èŒè´£ï¼Œä½†æ˜¯è·¯ç”±å™¨æ‰€ä½¿ç”¨çš„ç¡¬ä»¶ï¼Œå°¤å…¶æ˜¯åè®®ï¼Œç¡®å®šäº†å®ƒåœ¨ç½‘ç»œä¸­çš„èŒè´£ã€‚</p><blockquote><p><strong>å¤–éƒ¨è·¯ç”±å™¨ï¼š</strong>å¤–éƒ¨è·¯ç”±å™¨åœ¨è‡ªæ²»ç½‘ç»œä¹‹é—´äº¤æ¢è·¯ç”±ä¿¡æ¯ï¼Œä»–ä»¬ç»´æŠ¤è‡ªå·±åŠé‚»å±…è‡ªæ²»ç½‘ç»œçš„è·¯ç”±ä¿¡æ¯ã€‚è¾¹ç•Œè·¯ç”±å™¨ä¼ ç»Ÿä¸Šä½¿ç”¨å¤–éƒ¨ç½‘å…³åè®®ï¼ˆEGPï¼‰,å®é™…çš„RGPç°åœ¨å·²ç»è¿‡æ—¶ï¼Œä½†å¤–éƒ¨è·¯ç”±å™¨ä½¿ç”¨æ–°è·¯ç”±åè®®ä¸€èˆ¬ä¹Ÿç§°ä¸ºEGPã€‚ç°åœ¨æµè¡Œçš„ä¸€ç§EGPæ˜¯è¾¹ç•Œç½‘å…³åè®®ï¼ˆBGPï¼‰ã€‚å¤–éƒ¨è·¯ç”±å™¨é€šå¸¸ä¹Ÿä½œä¸ºè‡ªæ²»ç½‘ç»œçš„å†…éƒ¨è·¯ç”±å™¨ã€‚<br><strong>å†…éƒ¨è·¯ç”±å™¨ï¼š</strong>è‡ªæ²»ç½‘ç»œå†…éƒ¨<code>å…±äº«è·¯ç”±ä¿¡æ¯</code>çš„è·¯ç”±å™¨è¢«ç§°ä¸º<code>å†…éƒ¨ç½‘å…³</code>ï¼Œå®ƒä»¬ä½¿ç”¨è¢«ç§°ä¸ºå†…éƒ¨ç½‘å…³åè®®ï¼ˆIGPï¼‰çš„ä¸€ç»„è·¯ç”±åè®®ï¼ŒåŒ…æ‹¬è·¯ç”±ä¿¡æ¯åè®®ï¼ˆRIPï¼‰ã€å¼€æ”¾æœ€çŸ­è·¯ç»ä¼˜å…ˆï¼ˆOSPFï¼‰ã€‚è¯¦è§æœ¬ç« åç»­ã€‚<br><strong>æ ¸å¿ƒè·¯ç”±å™¨ï¼š</strong>å°½ç®¡æœ€åˆAPRAnetéª¨å¹²ç½‘ä¸å†ä½œä¸ºInternetçš„ä¸­å¿ƒè€Œå‡ºç°ï¼Œä½†æ˜¯è‡ªæ²»ç³»ç»Ÿæœ‰æ—¶ä¼šæ„å»ºè‡ªå·±çš„éª¨å¹²ç»“æ„ï¼Œä»¥ç»†åˆ†å’Œéš”ç¦»æµé‡ã€‚æ ¸å¿ƒè·¯ç”±å™¨æ”¯æŒéª¨å¹²ç³»ç»Ÿã€‚æ ¸å¿ƒè·¯ç”±å™¨ä½¿ç”¨çš„è·¯ç”±åè®®åŒ…æ‹¬ç½‘å…³åˆ°ç½‘å…³åè®®ï¼ˆGGPï¼‰ï¼Œä»¥åŠæ–°å‡ºç°çš„SPREADåè®®ã€‚</p></blockquote><p>è¯´æ˜ï¼šè‡ªæ²»ç½‘ç»œå†…éƒ¨çš„è·¯ç”±å™¨ä¹Ÿå¯èƒ½åˆ†å±‚æ¬¡è¿›è¡Œé…ç½®ï¼Œä¸€ä¸ªå¤§å‹è‡ªæ²»ç½‘ç»œå¯èƒ½åŒ…å«å¤šç»„å†…éƒ¨è·¯ç”±ï¼Œå¹¶åˆ©ç”¨å†…éƒ¨è·¯ç”±å™¨ä¼ é€’è¿™äº›å†…éƒ¨ç»„ä¹‹é—´çš„è·¯ç”±ä¿¡æ¯ã€‚è‡ªæ²»ç½‘ç»œç®¡ç†è€…å¯ä»¥æ ¹æ®éœ€è¦è®¾è®¡è·¯ç”±å™¨é…ç½®ï¼Œå¹¶ä¸”ç›¸åº”åœ°é€‰æ‹©è·¯ç”±åè®®ã€‚</p><h4 id="8-3-å†…éƒ¨è·¯ç”±å™¨"><a href="#8-3-å†…éƒ¨è·¯ç”±å™¨" class="headerlink" title="8.3 å†…éƒ¨è·¯ç”±å™¨"></a><strong>8.3 å†…éƒ¨è·¯ç”±å™¨</strong></h4><p>&emsp;&emsp;å†…éƒ¨è·¯ç”±å™¨å·¥ä½œäºè‡ªæ²»ç½‘ç»œçš„å†…éƒ¨ï¼Œå®ƒä¼šæŒæ¡è‡ªå·±ç»„å†…å…¨éƒ¨è·¯ç”±å™¨æ‰€è¿æ¥çš„ç½‘æ®µä¿¡æ¯ï¼Œä½†ä¸éœ€è¦å®Œæ•´äº†è§£è‡ªæ²»ç³»ç»Ÿä¹‹å¤–çš„ç½‘ç»œã€‚<br>&emsp;&emsp;å†…éƒ¨è·¯ç”±åè®®æœ‰å¤šç§ï¼Œç½‘ç»œç®¡ç†å‘˜å¿…é¡»æ ¹æ®ç½‘ç»œæƒ…å†µå’Œç½‘ç»œç¡¬ä»¶å…¼å®¹æ€§é€‰æ‹©å†…éƒ¨è·¯ç”±åè®®ã€‚<br>&emsp;&emsp;ä¸¤ç§é‡è¦çš„å†…éƒ¨è·¯ç”±åè®®ï¼šè·¯ç”±ä¿¡æ¯åè®®ï¼ˆRIPï¼‰å’Œå¼€æ”¾æœ€çŸ­è·¯ç”±ä¼˜å…ˆï¼ˆOSPFï¼‰ï¼›<br>RIPæ˜¯ä¸€ç§è·ç¦»çŸ¢é‡åè®®ï¼Œè€ŒOSPFæ˜¯ä¸€ç§é“¾è·¯çŠ¶æ€åè®®ã€‚å®é™…çš„åè®®å®ç°éƒ½éœ€è¦è§£å†³ä¸€äº›ç»†èŠ‚é—®é¢˜ã€‚<br><strong>æ³¨æ„ï¼š</strong>å¤šåè®®</p><blockquote><p>å½“ä»Šå¤§å¤šæ•°è·¯ç”±å™¨éƒ½æ”¯æŒå¤šç§è·¯ç”±åè®®ã€‚</p></blockquote><p><strong>8.3.1 è·¯ç”±ä¿¡æ¯åè®®ï¼ˆRIPï¼‰</strong><br>&emsp;&emsp;RIPæ˜¯ä¸€ç§è·ç¦»çŸ¢é‡åè®®ï¼Œè¿™è¡¨ç¤ºå®ƒæ ¹æ®è·³æ•°æ¥åˆ¤æ–­åˆ°è¾¾ç›®çš„çš„æœ€ä½³è·¯å¾„ã€‚RIPæ›¾ç»éå¸¸æµåˆ©ï¼Œè™½ç„¶ç°åœ¨æœ‰äº›è¿‡æ—¶ï¼Œä½†ä»ç„¶è¢«å¹¿æ³›ä½¿ç”¨ã€‚RIP â…¡æ ‡å‡†çš„å‡ºç°è§£å†³äº†RIP â… çš„ä¸€äº›é—®é¢˜ã€‚ç°åœ¨å¾ˆå¤šéƒ½æœ‰å…¶éƒ½æ”¯æŒRIP å’ŒRIP â… ã€‚RIPâ…¡ é’ˆå¯¹äºIPv6ç½‘ç»œçš„æ‰©å±•è¢«ç§°ä¸ºRIPngã€‚</p><p><strong>æ³¨æ„ï¼š</strong> RIPè·¯ç”±</p><blockquote><p>RIPåœ¨UNIXå’ŒLinuxä¸Šæ˜¯é€šè¿‡routed daemonå®ç°çš„ã€‚</p></blockquote><p>&emsp;&emsp;ä½œä¸ºä¸€ç§è·ç¦»çŸ¢é‡åè®®ï¼ŒRIPéœ€è¦è·¯ç”±å™¨æ”¶å¬å’Œé›†æˆæ¥è‡ªå…¶ä»–è·¯ç”±å™¨ä¸Šçš„è·¯ç”±å’Œè·³æ•°ä¿¡æ¯ã€‚RIPçš„å‚ä¸è€…è¢«åˆ’åˆ†ä¸ºä¸»åŠ¨å’Œè¢«åŠ¨ä¸¤ç§ã€‚<br>&emsp;&emsp;ä¸»åŠ¨RIPèŠ‚ç‚¹é€šå¸¸æ˜¯å‚ä¸æ­£å¸¸çš„è·ç¦»çŸ¢é‡æ•°æ®äº¤æ¢è¿‡ç¨‹çš„è·¯ç”±å™¨ï¼Œå®ƒä¼šæŠŠè‡ªå·±çš„è·¯ç”±è¡¨å‘é€ç»™å…¶ä»–è·¯ç”±å™¨ï¼Œå¹¶ä¸”æ”¶å¬æ¥è‡ªå…¶ä»–è·¯ç”±å™¨çš„æ›´æ–°ä¿¡æ¯ã€‚<br>è¢«åŠ¨RIPèŠ‚ç‚¹åªæ”¶å¬è·¯ç”±æ›´æ–°ä¿¡æ¯ã€‚ä¸ä¼ æ’­è‡ªå·±çš„è·¯ç”±è¡¨ï¼Œå…¶å…¸å‹ä»£è¡¨å°±æ˜¯æ™®é€šè®¡ç®—æœºï¼ˆä¸»æœºä¹Ÿéœ€è¦è·¯ç”±è¡¨ï¼‰ã€‚</p><p>&emsp;&emsp;å¦‚æœæ¥æ”¶åˆ°çš„è·³æ•°è¿›è¡Œå¤„ç†åæ­£å¥½å’Œè·¯ç”±è¡¨ä¸­ä¿å­˜çš„è·³æ•°ä¸€æ ·ï¼Œä¼šå¦‚ä½•å¤„ç†?å¯¹äºRIFæ¥è¯´ï¼Œå¦‚æœåˆ°è¾¾åŒä¸€ç›®çš„çš„ä¸¤ä¸ªè·¯å¾„å…·æœ‰ç›¸åŒçš„è·³æ•°ï¼Œåˆ™ä¼šä½¿ç”¨è·¯ç”±è¡¨ç°æœ‰çš„è·¯å¾„ã€‚è¿™æ ·ä¼šé¿å…ç”±äºè·³æ•°ç›¸åŒè€Œå¯¼è‡´è·¯ç”±è¡¨æ¡ç›®ä¸æ–­è¢«ä¿®æ”¹ã€‚</p><p>&emsp;&emsp;RIPè·¯ç”±å™¨æ¯30ç§’å¹¿æ’­ä¸€æ¬¡æ›´æ–°æ¶ˆæ¯ï¼Œå®ƒè¿˜å¯ä»¥è¦æ±‚ç«‹å³æ›´æ–°ã€‚åƒå…¶ä»–è·ç¦»çŸ¢é‡åè®®ä¸€æ ·ï¼Œå½“ç½‘ç»œå¤„äºå¹³è¡¡çŠ¶æ€æ—¶ï¼ŒRIPå·¥ä½œæ•ˆæœæœ€å¥½ã€‚å¦‚æœè·¯ç”±å™¨æ•°é‡å˜å¾—éå¸¸å¤§ã€‚è·¯ç”±è¡¨çš„ç¼“æ…¢æ”¶æ•›å¯èƒ½å¯¼è‡´é—®é¢˜ã€‚å¤„äºè¿™ä¸ªåŸå› ï¼ŒRIPè®¾ç½®äº†ä»ç¬¬ä¸€å°è·¯ç”±å™¨åˆ°è¾¾ç›®çš„çš„æœ€å¤§è·³æ•°é™åˆ¶ï¼Œå…¶å€¼æ˜¯15,ã€‚è¿™ä¸ªè§„å®šé™åˆ¶äº†è·¯ç”±ç»„çš„æ•°é‡ï¼Œä½†å¦‚æœä»¥å±‚çº§æ–¹å¼ç»„ç»‡è·¯ç”±å™¨ï¼Œ15è·³èŒƒå›´ä¹‹å†…ä¹Ÿå¯ä»¥ç»„æˆå¤§å‹ç½‘ç»œã€‚</p><p>&emsp;&emsp;è™½ç„¶è·ç¦»çŸ¢é‡å‘æ–¹æ²¡æœ‰ç‰¹åˆ«è€ƒè™‘çº¿è·¯é€Ÿåº¦å’Œç‰©ç†ç±»å‹çš„é—®é¢˜ï¼Œä½†RIPå…è®¸ç½‘ç»œç®¡ç†å‘˜ä»¥æ‰‹åŠ¨æ–¹å¼æŠŠä½ä¿—è·¯å¾„çš„è·³æ•°è®¾ç½®å¾—å¾ˆå¤§ï¼Œä»è€Œå½±å“äº‹å‡çš„è·¯ç”±é€‰æ‹©ã€‚<br>å¤è€çš„RIPåè®®é€æ¸è¢«æ–°çš„è·¯ç”±åè®®æ‰€å–ä»£ï¼Œæ¯”å¦‚OSFP</p><p><strong>8.3.2 å¼€å‘æœ€çŸ­è·¯å¾„ä¼˜å…ˆï¼ˆOSPFï¼‰</strong><br>&emsp;&emsp;OSPFæ¯”è¾ƒæ–°çš„å†…éƒ¨åè®®ï¼Œæ­£åœ¨é€æ­¥å–ä»£RIPï¼ŒOSPFæ˜¯é“¾è·¯çŠ¶æ€åè®®ã€‚<br>&emsp;&emsp;OSPFè·¯ç”±å™¨ç»„ä¸­çš„æ²¡å¤ªè·¯ç”±å™¨éƒ½è¢«æŒ‡å®šä¸€ä¸ªè·¯ç”±å™¨ID,é€šå¸¸æ˜¯ä¸è·¯ç”±å™¨ç›¸å…³è”çš„æœ€å¤§IPåœ°å€ï¼ˆå¦‚æœè·¯ç”±å™¨ä½¿ç”¨äº†ä¸€ä¸ªç¯å›æ¥å£ï¼Œè·¯ç”±å™¨IDå°±æ˜¯æœ€å¤§çš„å›ç¯åœ°å€ï¼‰<br>&emsp;&emsp;æœ¬ç« å‰é¢è®²è¿‡ï¼Œé“¾è·¯çŠ¶æ€è·¯ç”±å™¨ä¼šå»ºç«‹ç½‘ç»œæ‹“æ‰‘çš„ä¸€ä¸ªå†…éƒ¨æ˜ å°„ï¼Œåˆ©ç”¨è·¯ç”±å™¨IDæ¥é‰´åˆ«æ‹“æ‰‘é‡Œçš„è·¯ç”±å™¨ã€‚æ¯å°è·¯ç”±å™¨éƒ½æŠŠç½‘ç»œæç»˜ä¸ºä¸€ä¸ªæ ‘å½¢ï¼Œè‡ªå·±ä½äºæ ‘çš„æ ¹éƒ¨ã€‚è¿™ä¸ªç½‘ç»œæ ‘è¢«ç§°ä¸ºæœ€çŸ­è·¯å¾„æ ‘(SPT)ï¼Œé€šè¿‡ç½‘ç»œçš„è·¯å¾„å°±å¯¹åº”äºé€šè¿‡SPTçš„è·¯å¾„ï¼Œè·¯ç”±å™¨è®¡ç®—æ¯ä¸€ä¸ªè·¯ç”±çš„å¼€é”€ã€‚å¼€é”€åº¦é‡åŒ…æ‹¬è·³æ•°å’Œå…¶ä»–ä¸€äº›å› ç´ ï¼Œæ¯”å¦‚é“¾è·¯é€Ÿåº¦å’Œé“¾è·¯çš„å¯é æ€§ã€‚</p><h4 id="8-4ã€å¤–éƒ¨è·¯ç”±å™¨ï¼šBGP"><a href="#8-4ã€å¤–éƒ¨è·¯ç”±å™¨ï¼šBGP" class="headerlink" title="8.4ã€å¤–éƒ¨è·¯ç”±å™¨ï¼šBGP"></a><strong>8.4ã€å¤–éƒ¨è·¯ç”±å™¨ï¼šBGP</strong></h4><p>&emsp;&emsp;Internetæ˜¯ç”±å¤§é‡çš„è‡ªæ²»ç³»ç»Ÿçš„å†…éƒ¨è·¯å¾„ï¼Œè‡ªæ²»ç³»ç»Ÿä¹‹é—´çš„è·¯å¾„ï¼Œä»¥åŠç©¿è¶Šè‡ªæ²»ç³»ç»Ÿçš„å†—ä½™è·¯å¾„ç»„æˆå³å¯ã€‚</p><p>&emsp;&emsp;å¤–éƒ¨è·¯ç”±åœ¨è‡ªæ²»ç³»ç»Ÿç½‘ç»œä¸­ä¼ è¾“æµé‡æ—¶å‘æŒ¥äº†é‡è¦çš„ä½œç”¨ã€‚å¦‚ä»ŠInternetä¸Šçš„å¤–éƒ¨è·¯ç”±å™¨æ‰€ä»¥ä½¿ç”¨çš„æœ€å¸¸è§åè®®æ˜¯è¾¹ç•Œç½‘å…³åè®®ï¼ˆBGPï¼‰ã€‚<br>&emsp;&emsp;å®é™…ä¸Šï¼ŒBGPç”¨é€”å¾ˆå¹¿æ³›ï¼Œå¯ä»¥ç”¨ä½œè‡ªæ²»ç³»ç»Ÿå†…çš„å†…éƒ¨åè®®ï¼Œå°†ç½‘ç»œç»†åˆ†ä¸ºæ›´å°çš„åŒºåŸŸï¼Œåœ¨è‡ªæ²»ç³»ç»Ÿçš„è¾¹ç¼˜ä½¿ç”¨çš„BGPç‰ˆæœ¬è¢«ç§°ä¸ºå¤–éƒ¨è¾¹ç•Œç½‘å…³è·¯ç”±åè®®ï¼ˆeBGPï¼‰,å®ƒå°†æ¶ˆæ¯ä»ä¸€ä¸ªè‡ªæ²»ç³»ç»Ÿä¼ è¾“åˆ°å¦å¤–ä¸€ä¸ªè‡ªæ²»ç³»ç»Ÿã€‚åœ¨è‡ªæ²»ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨çš„BGPç§°ä¸ºå†…éƒ¨è¾¹ç•Œç½‘å…³åè®®ï¼ˆiBGPï¼‰ã€‚<br>&emsp;&emsp;IANAä¸ºæ¯ä¸€ä¸ªè‡ªæ²»ç³»ç»Ÿåˆ†æ´¾äº†ä¸€ä¸ªå”¯ä¸€çš„æ•°å€¼ï¼Œç§°ä¹‹ä¸ºASå·æˆ–ASNã€‚BGPä½¿ç”¨è¿™äº›ASå·æ¥æ„å»ºInternetçš„æ˜ å°„ï¼Œå¹¶å°†åŸºäºCIDRçš„æ— ç±»åˆ«IPåœ°å€ä¸ç©¿è¶Šè‡ªæ²»ç³»ç»Ÿçš„è·¯ç”±å…³è”èµ·æ¥ã€‚ASNæä¾›äº†ä¸€ç§æ–¹æ³•æ¥è¯†åˆ«ç½‘ç»œæ˜¯å¦ç‹¬ç«‹äºç‰¹å®šçš„IPåœ°å€ï¼ˆæˆ–åœ°å€èŒƒå›´ï¼‰ã€‚è¯¥æ–¹æ³•æä¾›äº†å»å¾€è‡ªæ²»ç³»ç»Ÿçš„å†—ä½™è·¯å¾„ï¼ˆä¸é€šè¿‡IPåœ°å€æ§ä»¶çš„å•æ¡è·¯å¾„ç›¸å¯¹ï¼‰ä½†æ˜¯ç”±äºASNä¸æ˜¯åˆ†å±‚æ¬¡çš„ï¼Œå› æ­¤BGPè·¯ç”±å™¨å¿…é¡»çŸ¥é“ç½‘ç»œä¸­çš„æ‰€æœ‰å…¶ä»–BGPè·¯ç”±å™¨ã€‚</p><p><strong>æ³¨æ„ï¼šå…¬å…±ASNå’Œç§æœ‰ASN</strong></p><blockquote><p>iBGPä¸»è¦ç”¨äºåœ¨è‡ªæ²»ç³»ç»Ÿçš„å†…éƒ¨æ¥è·¯ç”±æµé‡ï¼Œå®ƒä¸éœ€è¦IANAåˆ†é…çš„å…¬å…±ASNã€‚å†…éƒ¨BGPè·¯ç”±å™¨ä½¿ç”¨ç§æœ‰ASNæ¥è½¬å‘æµé‡ï¼Œå› æ­¤ä¸ä¼šå°†æµé‡è½¬å‘åˆ°è‡ªæ²»ç³»ç»Ÿä¹‹å¤–ã€‚</p></blockquote><p>&emsp;&emsp;BGPè·¯ç”±å™¨ä½¿ç”¨å¯é åœ°TCPè¿æ¥æ¥ä¼ é€’ä¸åœ°å€èŒƒå›´ç›¸å…³çš„ä¿¡æ¯ï¼Œå¹¶æ„å»ºç”¨æ¥ä¹°æœç‹ç½‘ç»œè·¯å¾„çš„ASNé“¾ã€‚BGPåè®®åŒ…æ‹¬å¤§é‡ç”¨äºè·¯å¾„å‘ç°çš„æ¡æ¬¾ï¼Œä»¥åŠä»å¤šä¸ªé€‰æ‹©ä¸­é€‰å–æœ€é«˜æ•ˆè·¯å¾„çš„æŠ€æœ¯ã€‚</p><h4 id="8-5-æ— ç±»åˆ«è·¯ç”±"><a href="#8-5-æ— ç±»åˆ«è·¯ç”±" class="headerlink" title="8.5 æ— ç±»åˆ«è·¯ç”±"></a><strong>8.5 æ— ç±»åˆ«è·¯ç”±</strong></h4><p>&emsp;&emsp;TCP/IPè·¯ç”±ç³»ç»Ÿæ˜¯å›´ç»•ç½‘ç»œIDçš„æ¦‚å¿µè®¾è®¡çš„ï¼Œè€Œç½‘ç»œIDæ—¶åŸºäºIPåœ°å€çš„åœ°å€ç±»åˆ«ï¼ˆAã€Bå’ŒCï¼‰ã€‚åœ¨ç¬¬5ç« è®²åˆ°ï¼Œè¿™ä¸ªåœ°å€åˆ†ç±»ç³»ç»Ÿæœ‰ä¸€äº›å±€é™æ€§ï¼Œæœ‰æ—¶å¹¶ä¸èƒ½æœ‰æ•ˆçš„æŠŠä¸€æ®µåœ°å€æŒ‡å®šç»™ä¸€ä¸ªä¾›åº”å•†ã€‚â€œæ— ç±»åˆ«åŸŸé—´è·¯ç”±ï¼ˆCIDRï¼‰â€æä¾›äº†æŒ‡å®šåœ°å€å’Œç¡®å®šè·¯ç”±çš„å¦ä¸€ç§æ–¹æ³•ã€‚CIDRç³»ç»Ÿåˆ©ç”¨åœ°å€/æ©ç å¯¹æ¥æŒ‡å®šä¸»æœºï¼Œæ¯”å¦‚204.24.128.0/17,æ©ç æ•°å­—è¡¨ç¤ºåœ°å€ä¸­å¤šå°‘ä½å±äºç½‘ç»œIDã€‚<br>&emsp;&emsp;å¦‚æœè·¯ç”±åè®®æ”¯æŒCIDRï¼Œå®ƒä¼šæä¾›æ›´æœ‰æ•ˆçš„è·¯ç”±ï¼ŒCIDRè®©è·¯ç”±å™¨èƒ½æŠŠå¤šç´¯ç½‘ç»œåŒç­‰å¯¹å¾…ï¼Œä»è€Œå‡å°‘äº†è·¯ç”±å™¨ä¹‹é—´è¦ä¼ è¾“çš„ä¿¡æ¯ã€‚æœ€è¿‘ä¸€äº›è·¯ç”±åè®®ï¼Œæ¯”å¦‚OSPFå’ŒBGP4ï¼Œéƒ½æ”¯æŒæ— ç±»åˆ«å¯»å€ã€‚æœ€åˆRIPä¸æ”¯æŒCIDR,éšåçš„RIP II æ›´æ–°æ”¯æŒäº†CIDRã€‚</p><h4 id="8-6-åè®®æ ˆä¸­çš„æ›´é«˜å±‚"><a href="#8-6-åè®®æ ˆä¸­çš„æ›´é«˜å±‚" class="headerlink" title="8.6 åè®®æ ˆä¸­çš„æ›´é«˜å±‚"></a><strong>8.6 åè®®æ ˆä¸­çš„æ›´é«˜å±‚</strong></h4><p>&emsp;&emsp;åè®®å ä¸­çš„æ¯ä¸€å±‚éƒ½æä¾›äº†ä¸åŒçš„æœåŠ¡ï¼Œå¹¶ä¸”åœ¨å…¶åŒ…é‚®ä¸­å°è£…äº†ä¸åŒçš„ä¿¡æ¯ã€‚èƒ½å¤Ÿè®¿é—®æ›´é«˜å±‚åè®®çš„è·¯ç”±å™¨å¯ä»¥æ ¹æ®æ›´å¤šçš„ä¿¡æ¯æ¥å†³å®šè·¯ç”±ã€‚ä¾‹å¦‚ï¼šå·¥ä½œäºä¼ è¾“å±‚çš„è·¯ç”±å™¨èƒ½å¤Ÿæ ¹æ®æºç«¯å£å’Œç›®çš„ç«¯å£æ¨æ–­æ•°æ®çš„ç‰¹æ€§ï¼Œè€Œå·¥ä½œäºåº”ç”¨æˆçš„è·¯ç”±å™¨å¯ä»¥æ›´è¯¦ç»†çš„äº†è§£å‘é€æ•°æ®çš„åº”ç”¨ç¨‹åºå’Œåº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨çš„åè®®ã€‚</p><p>&emsp;&emsp;å·¥ä½œäºæ›´é«˜å±‚çš„è·¯ç”±å™¨æœ‰å¾ˆå¤šä¼˜ç‚¹ï¼Œæ¯”å¦‚æ›´å¥½çš„å®‰å…¨å‹ï¼Œä½¿ç”¨è¿™ç§æŠ€æœ¯çš„å¦ä¸€ä¸ªé‡è¦åŸå› æ˜¯æœåŠ¡è´¨é‡ï¼ˆQosï¼‰çš„æ¦‚å¿µã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">è‡ªæ²»ç³»ç»Ÿï¼šå‚ä¸åˆ°æ›´å¤§ç½‘ç»œçš„ç½‘ç»œï¼Œç”±è‡ªæ²»å®ä½“è¿›è¡Œç»´æŠ¤</span><br><span class="line">è¾¹ç•Œè·¯ç”±åè®®ï¼ˆBGPï¼‰ï¼šç”¨æ¥åœ¨è‡ªæ²»ç³»ç»Ÿä¹‹é—´è·¯ç”±æµé‡çš„åè®®ã€‚BGPä¹Ÿç”¨ä½œè‡ªæ²»ç³»ç»Ÿå†…çš„å†…éƒ¨åè®®ã€‚</span><br><span class="line">åŠ¨æ€è·¯ç”±ï¼šä¸€ç§è·¯ç”±æŠ€æœ¯ï¼Œè·¯ç”±å™¨åŸºäºè¯¥æŠ€æœ¯è·å¾—çš„ä¿¡æ¯æ¥æ„å»ºè·¯ç”±è¡¨ã€‚</span><br><span class="line">å¤–éƒ¨è·¯ç”±å™¨ï¼šè‡ªæ²»ç³»ç»Ÿä¸­çš„ä¸€ç§è·¯ç”±å™¨ï¼Œä¸å…¶ä»–è‡ªæ²»ç³»ç»Ÿä¼ é€’è·¯ç”±ä¿¡æ¯ã€‚</span><br><span class="line">éç›´è¿è·¯ç”±ï¼šä½äºä¸¤ä¸ªä¸èƒ½ç›´æ¥è¿æ¥çš„ç½‘ç»œä¸­çš„è·¯ç”±ã€‚</span><br><span class="line">å†…éƒ¨è·¯ç”±å™¨ï¼šè‡ªæ²»ç³»ç»Ÿå†…éƒ¨çš„è·¯ç”±å™¨ï¼Œä¸ç³»ç»Ÿå†…çš„å…¶ä»–è·¯ç”±å™¨äº¤æ¢è·¯ç”±ä¿¡æ¯ã€‚</span><br><span class="line">IPè½¬å‘ï¼šæŠŠIPæ•°æ®æŠ¥ä»åŒä¸€å°è®¾å¤‡çš„ä¸€ä¸ªç½‘ç»œæ¥å£ä¼ é€’åˆ°å¦ä¸€ç½‘ç»œæ¥å£çš„è¿‡ç¨‹ã€‚</span><br><span class="line">OSPF(å¼€å‘æœ€çŸ­è·¯å¾„ä¼˜å…ˆ)ï¼šä¸€ç§å¸¸è§çš„é“¾è·¯çŠ¶æ€å†…éƒ¨è·¯ç”±åè®®ã€‚</span><br><span class="line">RIP(è·¯ç”±ä¿¡æ¯åè®®)ï¼šä¸€ç§å¸¸è§çš„è·ç¦»å¤±çµå†…éƒ¨è·¯ç”±åè®®ã€‚</span><br><span class="line">è·¯ç”±åè®®ï¼šè·¯ç”±å™¨ç”¨äºæ±‡èšè·¯ç”±ä¿¡æ¯çš„åè®®ã€‚</span><br><span class="line">SPT(æœ€çŸ­è·¯å¾„æ ‘)ï¼šOSFPè·¯ç”±å™¨ç”Ÿæˆçš„ä¸€ç§æ ‘å½¢ç½‘ç»œæ˜ å°„ã€‚</span><br><span class="line">é™æ€è·¯ç”±ï¼šéœ€è¦ç½‘ç»œç®¡ç†å‘˜æ‰‹åŠ¨è¾“å…¥è·¯ç”±ä¿¡æ¯çš„ä¸€ç§è·¯ç”±æŠ€æœ¯ã€‚</span><br></pre></td></tr></table></figure><h2 id="ç¬¬9ç« -è¿ç½‘"><a href="#ç¬¬9ç« -è¿ç½‘" class="headerlink" title="ç¬¬9ç«  è¿ç½‘"></a><strong>ç¬¬9ç«  è¿ç½‘</strong></h2><p>æ‹¨å·è¿æ¥<br>å®½å¸¦æŠ€æœ¯ï¼Œæ¯”å¦‚ç”µç¼†å’ŒDSL<br>å¹¿åŸŸç½‘<br>æ— çº¿ç½‘ç»œè¿æ¥<br>è¿æ¥è®¾å¤‡</p><p>&emsp;&emsp;ç½‘ç»œè®¿é—®å±‚ç®¡ç†ä¸ç‰©ç†ç½‘ç»œçš„æ¥å£ï¼Œä½†æ˜¯ç‰©ç†ç½‘ç»œåˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿåœ¨ä½ã€å­—èŠ‚ã€ç«¯å£å’Œåè®®å±‚è¿™äº›æ¦‚å¿µä¹‹åï¼ŒInternetè¿æ¥éœ€è¦æŸç§å½¢å¼çš„è®¾å¤‡æŠŠè®¡ç®—æœºæˆ–æœ¬åœ°ç½‘æ®µè¿æ¥åˆ°æ›´å¤§çš„ç½‘ç»œä¸Šã€‚æœ¬ç« ä»‹ç»è®¿é—®TCP/IPç½‘ç»œæ‰€ç”¨åˆ°çš„ä¸€äº›è®¾å¤‡å’Œè¿‡ç¨‹ã€‚</p><h4 id="9-1-æ‹¨å·è¿æ¥"><a href="#9-1-æ‹¨å·è¿æ¥" class="headerlink" title="9.1 æ‹¨å·è¿æ¥"></a><strong>9.1 æ‹¨å·è¿æ¥</strong></h4><p>&emsp;&emsp;ä»¥å‰ï¼Œè¿æ¥TCP/IPç½‘ç»œï¼ˆæ¯”å¦‚Internetï¼‰çš„ä¸€ç§æœ€å¸¸çš„æ–¹å¼æ˜¯é€šè¿‡ç”µè¯çº¿ï¼ŒäºŒåœ¨æœ€è¿‘å‡ å¹´ï¼Œåƒç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨å’ŒDSLè¿™æ ·çš„å®½å¸¦æŠ€æœ¯é™ä½äº†æ‹¨å·è¿æ¥çš„é‡è¦æ€§ï¼Œä½†å¾ˆå¤šè®¡ç®—æœºä»ç„¶æ”¯æŒæ‹¨å·è¿æ¥ï¼Œè€Œä¸”ç”µè¯è°ƒåˆ¶è§£è°ƒå™¨åœ¨å¾ˆå¤šé¢†åŸŸä»ç„¶æ˜¯é‡è¦çš„è¿æ¥å·¥å…·ï¼Œ<br>è°ƒåˆ¶è§£è°ƒå™¨ï¼ˆmodemï¼‰é€šè¿‡ç”µè¯çº¿æä¾›ç½‘ç»œè®¿é—®ï¼Œå®ƒæ˜¯Modulate/DEMoudlate(è°ƒåˆ¶å™¨å’Œè§£è°ƒå™¨)ï¼Œè°ƒåˆ¶è§£è°ƒå™¨çš„ä½œç”¨åœ¨äºæŠŠæ¥è‡ªäºè®¡ç®—æœºçš„æ•°å­—ä¼ è¾“è½¬åŒ–ä¸ºèƒ½å¤Ÿé€šè¿‡ç”µè¯ç³»ç»Ÿçš„ç«¯å£è¿›è¡Œä¼ è¾“çš„æ¨¡æ‹Ÿä¿¡å·ï¼ŒåŒæ—¶ä¹ŸæŠŠæ¥è‡ªç”µè¯çº¿çš„æ¨¡æ‹Ÿä¿¡å·è½¬åŒ–ä¸ºè®¡ç®—æœºèƒ½å¤Ÿç†è§£çš„æ•°å­—ä¿¡å·ã€‚</p><p><strong>9.1.1 ç‚¹åˆ°ç‚¹è¿æ¥</strong><br>&emsp;&emsp;ç¬¬3ç« è®²è¿‡ï¼Œåƒä»¥å¤ªç½‘è¿™æ ·çš„å±€åŸŸç½‘ä½¿ç”¨ç²¾è‡´çš„è®¿é—®ç­–ç•¥è®©è®¡ç®—æœºå…±äº«äº’è”ç½‘ä»‹è´¨ã€‚ä¸ä¹‹ç›¸åçš„æ˜¯ï¼Œç”µè¯çº¿ä¸¤ç«¯çš„è®¡ç®—æœºä¸éœ€è¦ä¸å…¶ä»–è®¡ç®—æœºäº‰ç”¨ä¼ è¾“ä»‹è´¨ï¼Œå®ƒä»¬åªéœ€å½¼æ­¤ä¹‹é—´å…±äº«ä»‹è´¨å°±å¯ä»¥äº†ã€‚è¿™ç§è¿æ¥æ–¹å¼è¢«ç§°ä¸ºç‚¹åˆ°ç‚¹è¿æ¥ï¼ˆå›¾9.1ï¼‰</p><p>&emsp;&emsp;ç‚¹åˆ°ç‚¹è¿æ¥æ¯”å±€åŸŸç½‘çš„é…ç½®ç®€å•ï¼Œå› ä¸ºå®ƒä¸éœ€è¦å…·å¤‡è®©å¤šå°è®¡ç®—æœºå…±äº«ä¼ è¾“ä»‹è´¨çš„æ–¹æ³•ã€‚åŒæ—¶ï¼Œé€šè¿‡ç”µè¯çº¿çš„è¿æ¥ä¹Ÿæœ‰ä¸€äº›å±€é™æ€§ï¼Œæœ€å¤§çš„å±€é™ä¹‹ä¸€æ˜¯ç”µè¯è¿æ¥çš„ä¼ è¾“é€Ÿç‡æ¯”å±€åŸŸç½‘ï¼ˆæ¯”å¦‚ä»¥å¤ªç½‘ï¼‰è¦ä½å¾—å¤šï¼Œè¿™å¯¼è‡´ä»–ä½¿ç”¨çš„åè®®ç›¸å½“ç®€å•,è¶Šç®€å•è¶Šå¥½ã€‚ä½†æ˜¯ï¼Œéšç€è°ƒåˆ¶è§£è°ƒå™¨çš„é€Ÿåº¦è¶Šæ¥è¶Šé«˜ï¼Œè°ƒåˆ¶è§£è°ƒå™¨çš„åè®®åº”æ€¥æ‰¿æ‹…äº†é¢å¤–çš„èŒè´£ã€‚</p><p>&emsp;&emsp;æ‹¨å·åè®®çš„å¦ä¸€å·¨å¤§æŒ‘æˆ˜æ˜¯è¦æ”¯æŒå¤§é‡ä¸åŒç±»å‹çš„ç¡¬ä»¶å’Œè½¯ä»¶é…ç½®ã€‚åœ¨å±€åŸŸç½‘ä¸Šï¼Œç³»ç»Ÿç®¡ç†å‘˜ç›‘è§†å’Œæ§åˆ¶æ¯å°è®¡ç®—æœºçš„é…ç½®ï¼Œåè®®ç³»ç»Ÿä¾èµ–äºé€šä¿¡è®¾å¤‡ä¹‹é—´çš„é«˜åº¦ä¸€è‡´æ€§ã€‚æ‹¨å·è¿æ¥å´ä¸ä¹‹ä¸åŒï¼Œå®ƒå‡ ä¹å¯èƒ½å‘ç”Ÿåœ¨ä¸–ç•Œä¸Šçš„ä»»ä½•åœ°ç‚¹ï¼Œæ‹¨å·åè®®å¿…é¡»é€‚åº”é€šä¿¡è®¾å¤‡çš„ç¡¬ä»¶å’Œè½¯ä»¶æ›´å¹¿æ³›çš„å·®å¼‚æ€§ã€‚</p><p><strong>9.1.2 è°ƒåˆ¶è§£è°ƒå™¨åè®®</strong><br>&emsp;&emsp;è¿™ç§åªæ¶‰åŠä¸¤å°è®¡ç®—æœºçš„ç‚¹åˆ°ç‚¹è¿æ¥ä¹Ÿéœ€è¦å¤æ‚çš„TCP/IPæ ˆæ¥å»ºç«‹è¿æ¥å—ï¼Ÿç­”æ¡ˆæ˜¯â€œä¸â€ã€‚</p><p>&emsp;&emsp;æ—©æœŸçš„è°ƒåˆ¶è§£è°ƒå™¨åè®®åªä¸è¿‡æ˜¯ä¸€ç§åœ¨ç”µè¯çº¿ä¼ è¾“ä¿¡æ¯çš„æ–¹æ³•ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒTCP/IPçš„é€»è¾‘å¯»å€å’Œç½‘é—´é”™è¯¯æ§åˆ¶å°±æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚éšç€å±€åŸŸç½‘å’ŒInternetçš„å‡ºç°ï¼Œå·¥ç¨‹å¸ˆå¼€å§‹è€ƒè™‘è®©æ‹¨å·è¿æ¥ä½œä¸ºæä¾›ç½‘ç»œè®¿é—®çš„ä¸€ç§æ–¹å¼ã€‚è¿™æ ·è¿œç¨‹ç½‘ç»œè®¿é—®æ¦‚å¿µçš„ç¬¬ä¸€ä¸ªæ˜¯å®ç°æ˜¯å¯¹æ—©æœŸè°ƒåˆ¶è§£è°ƒå™¨åè®®çš„æ‰©å±•ï¼Œåœ¨è¿™ç§æœ€åˆçš„ä¸»æœºæ‹¨å·æ–¹æ¡ˆä¸­ï¼Œè¿æ¥åˆ°ç½‘ç»œçš„è®¡ç®—æœºè´Ÿè´£ä¸ºç½‘ç»œå‡†å¤‡æ•°æ®ã€‚æ— è®ºå’Œæ˜¾ç¤ºçš„è¿˜æ˜¯éšå¼çš„ï¼Œè¿œç¨‹è®¡ç®—æœºéƒ½åƒæ˜¯ä¸ªç»ˆç«¯ï¼ˆå›¾9.2ï¼‰ï¼Œé€šè¿‡ä¸€ä¸ªå®Œæ•´çš„ç‹¬ç«‹çš„è¿‡ç¨‹è®©è¿ç½‘ä¸»æœºåˆ©ç”¨è°ƒåˆ¶è§£è°ƒå™¨çº¿è·¯æ‰§è¡Œè¿ç½‘ä»»åŠ¡ã€å‘é€å’Œæ¥æ”¶æ•°æ®ã€‚</p><p>&emsp;&emsp;ç„¶è€Œï¼Œè¿™äº›æ—©æœŸä¸»æœºæ‹¨å·æ–¹æ¡ˆæœ‰ä¸€äº›å±€é™æ€§ã€‚å®ƒä»¬ååº”äº†æ—©æœŸçš„ä¸­å¿ƒåŒ–è®¡ç®—æœºæ¨¡å¼ï¼Œå¯¹æä¾›ç½‘ç»œè¿æ¥çš„è®¡ç®—æœºè¦æ±‚è¿‡å¤šï¼Œï¼ˆå›¾9.2é…ç½®ä¸­ï¼Œæƒ³è±¡å¦‚æœå¤šå°è®¡ç®—æœºåŒæ­¥è¿æ¥åˆ°æ‹¨å·æœåŠ¡å™¨ä¼šæ€ä¹ˆæ ·ï¼‰ï¼Œè€Œä¸”ä¹Ÿä¸èƒ½å……åˆ†å‘æŒ¥è¿œç¨‹è®¡ç®—æœºçš„å¤„ç†èƒ½åŠ›ã€‚<br>éšç€TCP/IPå’Œå…¶ä»–è·¯ç”±å™¨åè®®çš„å®ç°ï¼Œè®¾è®¡äººå‘˜æ„æƒ³å‡ºå¦ä¸€ç§è§£å†³æ–¹æ¡ˆï¼Œè®©è¿œç¨‹è®¡ç®—æœºè´Ÿè´£æ›´å¤šçš„è¿ç½‘ä»»åŠ¡ï¼Œè€Œè®©æ‹¨å·æœåŠ¡å™¨å‘æŒ¥ç±»ä¼¼è·¯ç”±å™¨çš„ä½œç”¨ï¼Œè¿™ç§æ–¹æ¡ˆï¼ˆå›¾9.3ï¼‰ä¸æ–°å¼çš„ã€å¼±ä¸­å¿ƒç”»çš„è®¡ç®—æœºç½‘ç»œæ¨¡å¼æ›´ä¸€è‡´ï¼Œä¹Ÿæ¥è¿‘ä¸TCP/IPçš„æœ¬è´¨ç‰¹å¾ã€‚åœ¨è¿™ç§å®‰æ’ä¸‹ï¼Œè¿œç¨‹è®¡ç®—æœºè¿è¡Œè‡ªå·±çš„åè®®æ ˆï¼Œè®©è°ƒåˆ¶è§£è°ƒå™¨åè®®å·¥ä½œäºç½‘ç»œè®¿é—®å±‚ï¼Œæ‹¨å·æœåŠ¡å™¨æ¥æ”¶æ•°æ®å¹¶è·¯ç”±åˆ°æ›´å¤§çš„ç½‘ç»œã€‚</p><p>&emsp;&emsp;è¿™æ ·ä¸€æ¥ï¼Œæ‹¨å·åè®®ç›´æ¥ä¸TCP/IPé…åˆå·¥ä½œï¼Œå¹¶æˆä¸ºåè®®ä¸­çš„é›†æˆéƒ¨åˆ†ã€‚æœ€å¸¸è§çš„ä¸¤ä¸ªTCP/IPè°ƒåˆ¶è§£è°ƒå™¨åè®®å¦‚ä¸‹æ‰€ç¤ºï¼š</p><blockquote><p><strong>ä¸²è¡Œçº¿è·¯ç½‘é™…åè®®ï¼ˆSLIPï¼‰ï¼š</strong>åŸºäºTCP/IPçš„æ—©æœŸè°ƒåˆ¶è§£è°ƒå™¨çš„åè®®ï¼Œç›¸å¯¹ç®€å•ï¼Œæœ‰å¾ˆå¤šå±€é™æ€§ã€‚<br><strong>ç‚¹åˆ°ç‚¹åè®®ï¼ˆPPPï¼‰ï¼š</strong>æœ€åˆå½“å‰ç”¨äºè°ƒåˆ¶è§£è°ƒå™¨è¿æ¥çš„æœ€æµè¡Œåè®®ï¼Œæ˜¯å¯¹SLIPçš„ç»†åŒ–ï¼Œå…·æœ‰SLIPæ‰€ä¸å…·å¤‡çš„å¾ˆå¤šé‡è¦ç‰¹å®šã€‚</p></blockquote><p>PPPå·²ç»å–ä»£SLIPæˆä¸ºæ‹¨å·Internetè¿æ¥çš„åè®®ã€‚</p><blockquote><p><strong>æ³¨æ„ï¼š</strong>åº•å±‚åè®®<br>SLIPå’ŒPPPéƒ½å»ºç«‹ä¸æ›´ä½çº§çš„ä¸²è¡Œé€šä¿¡åè®®ä¸Šï¼Œåè€…è´Ÿè´£ä¿¡å·è°ƒåˆ¶å’Œè§£è°ƒçš„å…·ä½“ç»†èŠ‚ã€‚è¿™äº›ä¸²è¡Œé€šä¿¡åè®®æä¾›äº†OSIæ¨¡å‹ä¸­ç‰©ç†å±‚çš„åŠŸèƒ½ã€‚</p></blockquote><p><strong>9.1.3 ç‚¹åˆ°ç‚¹åè®®ï¼ˆPPPï¼‰</strong><br>&emsp;&emsp;PPPè®¾è®¡ç›®æ ‡æ˜¯è§£å†³SLIPå­˜åœ¨çš„ä¸€äº›ç¼ºç‚¹ã€‚<br>&emsp;&emsp;PPPè®¾è®¡äººå‘˜è¿˜å¸Œæœ›PPPèƒ½å¤Ÿåœ¨è¿æ¥å»ºç«‹åˆæœŸè¿›è¡ŒåŠ¨æ€åå•†é…ç½®ï¼Œå¹¶ä¸”èƒ½å¤Ÿåœ¨ä¼šè¯è¿‡ç¨‹ä¸­ç®¡ç†é€šä¿¡è®¡ç®—æœºä¹‹é—´çš„é“¾è·¯ã€‚<br>&emsp;&emsp;PPPå®é™…ä¸Šå¼äº¤äº’ä½œç”¨çš„ä¸€ç»„åè®®ï¼Œå®ç°åŸºäºè°ƒåˆ¶è§£è°ƒå™¨è¿ç½‘æ‰€éœ€çš„å…¨éƒ¨åŠŸèƒ½ã€‚RFC 1661æŠŠPPPç»„ä»¶åˆ’åˆ†ä¸º3å¤§ç±»ï¼š</p><blockquote><p><strong>å°è£…å¤šåè®®æ•°æ®æŠ¥çš„æ–¹æ³•ï¼š</strong> SLIPå’ŒPPPéƒ½æ¥å—æ•°æ®æŠ¥ï¼Œè½¬æ¢ä¸ºé€‚åˆInternetçš„å½¢å¼ã€‚ä½†PPPä¸SLIPä¸åŒçš„æ˜¯ï¼Œå®ƒè¿˜å¿…é¡»å‡†å¤‡æ¥å—æ¥è‡ªä¸åŒåè®®ç³»ç»Ÿçš„æ•°æ®æŠ¥ã€‚<br><strong>å»ºç«‹ã€é…ç½®å’Œæµ‹è¯•è¿æ¥çš„é“¾æ¥æ§åˆ¶åè®®ï¼ˆLCPï¼‰ï¼š</strong> PPPèƒ½å¤Ÿé€šè¿‡åå•†æ–¹å¼è¿›è¡Œé…ç½®ï¼Œä»è€Œæ¶ˆé™¤äº†SLIPè¿æ¥é‡åˆ°çš„å…¼å®¹é—®é¢˜ã€‚<br><strong>æ”¯æŒé«˜å±‚åè®®ç³»ç»Ÿçš„ç½‘ç»œæ§åˆ¶åè®®ï¼ˆNCPï¼‰ç°‡ï¼š</strong> PPPå¯ä»¥åŒ…å«ä¸åŒçš„å­å±‚ï¼Œä»è€Œä¸ºTCP/IPå’Œå…¶ä»–ç½‘ç»œåè®®æä¾›å•ç‹¬çš„æ¥å£ã€‚</p></blockquote><p>PPPçš„å¤§éƒ¨åˆ†åŠŸèƒ½æ¥è‡ªäºå»ºç«‹ã€ç®¡ç†å’Œç»ˆæ­¢è¿æ¥çš„LCPåŠŸèƒ½ã€‚<br><strong>1. PPPæ•°æ®</strong><br>&emsp;&emsp;PPPï¼ˆä»¥åŠSLIPï¼‰çš„ä¸»è¦ç”¨é€”æ˜¯è½¬å‘æ•°æ®æŠ¥ï¼Œå…¶éš¾ç‚¹åœ¨ä¸å®ƒå¿…é¡»èƒ½å¤Ÿè½¬å‘å¤šé‡ç±»å‹çš„æ•°æ®æŠ¥ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ•°æ®æŠ¥å¯èƒ½æ˜¯IPæ•°æ®æŠ¥æˆ–OSIæ¨¡å‹ä¸­ç½‘ç»œå±‚çš„å…¶ä»–æ•°æ®æŠ¥ã€‚</p><blockquote><p><strong>æ³¨æ„ï¼š</strong>æ•°æ®åŒ…<br>&emsp;&emsp;PPP RFCä½¿ç”¨æœ¯è¯­â€œæ•°æ®åŒ…ï¼ˆpacketï¼‰â€æ¥æè¿°åœ¨PPPå¸§ä¸­ä¼ è¾“çš„æ•°æ®ã€‚æ•°æ®åŒ…å¯ä»¥æœ‰IPï¼ˆæˆ–å…¶ä»–é«˜å±‚åè®®ï¼‰æ•°æ®æŠ¥ç»„æˆï¼Œä¹Ÿå¯ä»¥ç”±é€šå‘ŠPPPè¿›è¡Œæ“ä½œçš„é¢å…¶ä»–æŒ‰åè®®çš„æ•°æ®ç»„æˆã€‚â€œæ•°æ®åŒ…â€è¿™ä¸ªè¯åœ¨æ•´ä¸ªç½‘ç»œç•Œç”¨äºè¡¨ç¤ºç»è¿‡ç½‘ç»œä¼ è¾“çš„æ•°æ®ï¼Œå®ƒå¹¶ä¸æ˜¯å¾ˆä¸¥å¯†çš„æœ¯è¯­ã€‚æœ¬ä¹¦ä¸­çˆ±ä¸åˆ†å†…å®¹ä¼šä½¿ç”¨æ›´ç²¾ç¡®çš„æœ¯è¯­ï¼Œæ¯”å¦‚â€œæ•°æ®æŠ¥ï¼ˆdatagramï¼‰â€ã€‚ä½†æ˜¯ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„PPPæ•°æ®åŒ…éƒ½æ˜¯æ•°æ®æŠ¥ï¼Œæ‰€ä»¥ä¸ºä¸RFCä¿æŒä¸€è‡´ï¼Œæœ¬ç« è¯¾ç¨‹ç”¨æœ¯è¯­â€œæ•°æ®åŒ…â€è¡¨ç¤ºç»è¿‡PPPä¼ è¾“çš„æ•°æ®ã€‚</p></blockquote><p>&emsp;&emsp;PPPä¹Ÿè¦è½¬å‘ä¸è‡ªå·±åè®®ç›¸å…³çš„ä¿¡æ¯ï¼Œè¿™äº›åè®®çš„ä½œç”¨æ˜¯å»ºç«‹å’Œç®¡ç†è°ƒåˆ¶è§£è°ƒå™¨è¿æ¥ã€‚é€šä¿¡è®¾å¤‡åœ¨PPPè¿æ¥è¿‡ç¨‹ä¸­ï¼Œä¼šäº¤æ¢å¤šé‡ç±»å‹çš„æ¶ˆæ¯å’Œè¯·æ±‚ã€‚é€šä¿¡è®¡ç®—æœºå¿…é¡»äº¤æ¢ç”¨äºå»ºç«‹ã€ç®¡ç†å’Œå…³é—­è¿æ¥çš„LCPæ•°æ®åŒ…ï¼Œæ”¯æŒPPPèº«ä»½éªŒè¯åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰çš„éªŒè¯æ•°æ®åŒ…ï¼Œä¸å„ç§åè®®ç°‡é€šä¿¡çš„NCPæ•°æ®åŒ…ã€‚åœ¨è¿æ¥åˆæœŸäº¤æ¢LCPæ•°æ®é…ç½®ç”¨äºå…¨éƒ¨åè®®å…±åŒçš„è¿æ¥å‚æ•°ï¼ŒNCPåè®®é…ç½®ä¸ç‰¹å®šåè®®ç°‡ç›¸å…³çš„å‚æ•°ã€‚<br>PPPå¸§çš„æ•°æ®æ ¼å¼å¦‚å›¾9.4</p><blockquote><p><strong>åè®®ï¼š</strong> 1æˆ–2å­—èŠ‚çš„å­—æ®µï¼Œæä¾›ä»£è¡¨è¢«å°è£…æ•°æ®åŒ…åè®®ç±»å‹çš„æ ‡è¯†å·ã€‚å¯èƒ½çš„ç±»å‹åŒ…æ‹¬LCPæ•°æ®åŒ…ã€NCPæ•°æ®åŒ…ã€IPæ•°æ®åŒ…å’ŒOSIæ¨¡å‹ç½‘ç»œå±‚åè®®æ•°æ®åŒ…ã€‚ICANNè´Ÿè´£è§„å®šå„ç§åè®®ç±»å‹çš„æ ‡å‡†æ ‡è¯†å·ç ã€‚</p></blockquote><blockquote><p><strong>å°è£…çš„æ•°æ®ï¼ˆé›¶æˆ–å¤šä¸ªå­—èŠ‚ï¼‰ï¼š</strong>å¸§ä¸­ä¼ è¾“çš„æ§åˆ¶æ•°æ®åŒ…æˆ–é«˜å±‚æ•°æ®æŠ¥ã€‚<br><strong>å¡«å……ï¼ˆå¯é€‰ï¼Œé•¿åº¦ä¸å®šï¼‰ï¼š</strong>åè®®å­—æ®µæŒ‡å®šçš„åè®®æ‰€éœ€çš„é¢å¤–å­—èŠ‚ã€‚æ¯ä¸ªåè®®è‡ªå·±è´Ÿè´£åŒºåˆ†å¡«å……å­—èŠ‚ä¸è¢«å°è£…çš„æ•°æ®æŠ¥ã€‚</p></blockquote><p><strong>2 PPPè¿æ¥</strong><br>PPPè¿æ¥çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><blockquote><ol><li>ä½¿ç”¨LCPåå•†è¿‡ç¨‹å»ºç«‹è¿æ¥ã€‚</li><li>å¦‚æœç¬¬1æ­¥çš„åå•†è¿‡ç¨‹æŒ‡å®šäº†èº«ä»½éªŒè¯è¦æ±‚ï¼Œé€šä¿¡è®¡ç®—æœºå°±è¿›å…¥èº«ä»½éªŒè¯é˜¶æ®µã€‚RFC 1661æä¾›äº†å¯†ç éªŒè¯åè®®ï¼ˆPAPï¼‰å’ŒæŒ‘æˆ˜æ¡æ‰‹éªŒè¯åè®®ï¼ˆCHAPï¼‰è¿™ä¸¤ä¸ªå¯é€‰çš„éªŒè¯é€‰é¡¹ã€‚PPPè¿˜æ”¯æŒå…¶ä»–èº«ä»½éªŒè¯åè®®ã€‚</li><li>PPPåˆ©ç”¨NCPæ•°æ®åŒ…æŒ‡å®šä¸ç‰¹å®šåè®®ç›¸å…³çš„é…ç½®ä¿¡æ¯ã€‚</li><li>PPPä¼ è¾“ä»é«˜å±‚åè®®æ¥æ”¶åˆ°çš„æ•°æ®ã€‚å¦‚æœç¬¬1æ­¥çš„åå•†è¿‡ç¨‹æŒ‡å®šäº†é“¾æ¥è´¨é‡ç›‘è§†ï¼Œç›‘è§†åè®®å°±ä¼šä¼ è¾“ç›‘è§†ä¿¡æ¯ã€‚NCPè¿˜å¯èƒ½ä¼ è¾“ä¸ç‰¹å®šåè®®ç›¸å…³çš„ä¿¡æ¯ã€‚</li><li>PPPäº¤æ¢LCPç»ˆæ­¢æ•°æ®åŒ…æ¥å…³é—­è¿æ¥ã€‚</li></ol></blockquote><h4 id="9-2-ç”µç¼†å®½å¸¦"><a href="#9-2-ç”µç¼†å®½å¸¦" class="headerlink" title="9.2 ç”µç¼†å®½å¸¦"></a><strong>9.2 ç”µç¼†å®½å¸¦</strong></h4><p>&emsp;&emsp;InternetæœåŠ¡çš„è¦æ±‚ï¼Œä»¥åŠä¸æ–­å¢å¼ºè®¡ç®—æœºç³»ç»Ÿçš„èƒ½åŠ›ï¼Œä¿ƒè¿›ä¸šç•Œå¯»æ‰¾æ–°çš„è¿æ¥æ–¹å¼æ¥å–ä»£é€Ÿåº¦æ…¢çš„ç”µè¯è°ƒåˆ¶è§£è°ƒå™¨ã€‚å¤„äºæˆæœ¬çš„è€ƒè™‘ï¼ŒæœåŠ¡æä¾›å•†å¹¶ä¸æ˜¯æä¾›ä¸€ä¸ªå…¨æ–°çš„å¸ƒçº¿ä½“ç³»ï¼Œè€Œæ˜¯åˆ©ç”¨ç°æœ‰çº¿è·¯æä¾›InternetæœåŠ¡ã€‚<br>ä¸€ç§åˆ†å¸ƒåˆ°æ¯å®¶æ¯æˆ·å…µå™¨å—¯å¯ä»¥æ”¯æŒInternetæœåŠ¡çš„å¸ƒçº¿ç³»ç»Ÿå°±æ˜¯ä¼˜å…ˆç”µè§†ç½‘ç»œã€‚åŸºäºç”µç¼†çš„å®½å¸¦ç›®å‰åœ¨ä¸–ç•Œå¾ˆå¤šåœ°æ–¹éƒ½å¾ˆå¸¸è§äº†ï¼Œå…¸å‹çš„ç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨è¿æ¥å¦‚å›¾9.5æ‰€ç¤ºã€‚</p><p>&emsp;&emsp;ç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨ç›´æ¥è¿æ¥åˆ°ä¸€æ¡åŒè½´ç”µç¼†ï¼Œåè€…è¢«è¿æ¥åˆ°æœ‰çº¿ç”µè§†æœåŠ¡ç½‘ç»œä¸Šã€‚è¿™ä¸ªè°ƒåˆ¶è§£è°ƒå™¨é€šå¸¸å…·æœ‰ä¸€ä¸ªä»¥å¤ªç½‘æ¥å£ï¼Œå¯ä»¥è¿æ¥åˆ°å•å°è®¡ç®—æœºæˆ–å°å‹å±€åŸŸç½‘ä¸­çš„äº¤æ¢æœºæˆ–è€…è·¯ç”±å™¨ã€‚<br>&emsp;&emsp;å‰é¢è®²åˆ°ï¼Œæœ¯è¯­â€œè°ƒåˆ¶è§£è°ƒå™¨â€æ˜¯ç”±â€œè°ƒåˆ¶å™¨â€å’Œâ€œè§£è°ƒå™¨â€çš„ç¼©å†™ã€‚ä¸ç”µè¯è°ƒåˆ¶è§£è°ƒå™¨ç›¸åŒï¼Œç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨å®ç°æ•°å­—æ•°å­—ä¿¡å·ä¸æ¨¡æ‹Ÿä¿¡å·çš„è½¬æ¢ï¼Œä»è€Œè®©æ•°æ®èƒ½å¤Ÿé€šè¿‡ç”µç¼†è¿æ¥é«˜é€Ÿè¿è¡Œã€‚<br>&emsp;&emsp;åä¸ºç”µç¼†è§£è°ƒå™¨ç»ˆç«¯ç³»ç»Ÿï¼ˆCMTSï¼‰çš„è®¾å¤‡ï¼Œåœ¨ä¼˜å…ˆç”µè§†æä¾›å•†ç½‘ç»œçš„æ¥å£ï¼Œæ¥æ”¶æ¥è‡ªç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨çš„è®¢å¥½ï¼ŒæŠŠå®ƒè½¬æ¢å›æ•°å­—å½¢å¼ã€‚æœ‰çº¿ç”µè§†æä¾›å•†å†ä»ä¸Šæ¸¸ISPç§Ÿç”¨å®½å¸¦çº¿è·¯ï¼Œåˆ©ç”¨è·¯ç”±å™¨æŠŠç”¨äºä¸Internetè¿æ¥èµ·æ¥ã€‚æä¾›å•†è¿˜å¯ä»¥æä¾›å…¶ä»–æœåŠ¡ï¼Œæ¯”å¦‚ç”¨DHCPç»™ç½‘ç»œä¸Šçš„ç”¨æˆ·åŠ¨æ€åˆ†é…IPåœ°å€ã€‚<br>&emsp;&emsp;è™½ç„¶ç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨èµ·åˆ°äº†ä¸¤ç§ä¸åŒä¼ è¾“ä»‹è´¨çš„æ¥å£å’Œä½œç”¨ï¼Œä½†å®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªæŒ‡é’ˆçš„è·¯ç”±å™¨ï¼Œæ›´åƒæ˜¯ä¸€ä¸ªç½‘æ¡¥ã€‚ç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨æ ¹æ®ç‰©ç†ï¼ˆMACï¼‰åœ°å€åœ¨ç½‘ç»œè®¿é—®å±‚è¿‡æ»¤é€šä¿¡ã€‚ç„¶è€Œè¿‘å‡ å¹´æ¥ï¼Œæœ‰äº›å‚å•†åœ¨ä¸€äº›å®¶ç”¨è·¯ç”±å™¨è®¾å¤‡ä¸­å†…ç½®äº†ç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯èƒ½ä¼šçœ‹åˆ°ä¸€äº›ç»„åˆè®¾å¤‡ï¼Œå®ƒä»¬åŒæ—¶å…·æœ‰è·¯ç”±å™¨å’Œç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨çš„åŠŸèƒ½ã€‚</p><p>&emsp;&emsp;ä¸ºé˜²æ­¢ç›—ç”¨æœåŠ¡ï¼Œæœ‰çº¿ç”µè§†å…¬å¸é€šå¸¸è¦æ±‚ç”¨æˆ·é¢„å…ˆæ³¨å†Œç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨çš„MACåœ°å€æ‰èƒ½è¿æ¥ç½‘ç»œã€‚</p><h4 id="9-3-æ•°å­—ç”¨æˆ·çº¿è·¯ï¼ˆDSLï¼‰"><a href="#9-3-æ•°å­—ç”¨æˆ·çº¿è·¯ï¼ˆDSLï¼‰" class="headerlink" title="9.3 æ•°å­—ç”¨æˆ·çº¿è·¯ï¼ˆDSLï¼‰"></a><strong>9.3 æ•°å­—ç”¨æˆ·çº¿è·¯ï¼ˆDSLï¼‰</strong></h4><p>&emsp;&emsp;å¦ä¸€ç§é€‚åˆå®ç°å®¶ç”¨å®½å¸¦ä¼ è¾“ä»‹è´¨ç”µè¯ç½‘ã€‚å½“ç„¶ï¼Œä¼ ç»Ÿçš„ç”µè¯è°ƒåˆ¶è§£è°ƒå™¨ä½¿ç”¨çš„å°±æ˜¯ç”µè¯ç½‘ã€‚ä½†ç”µè¯å…¬å¸è®¤ä¸ºä½¿ç”¨ä¸åŒçš„æ–¹æ³•å¯ä»¥å¾—åˆ°æ›´å¥½çš„æ€§èƒ½ï¼Œè¿™å°±æ˜¯æ•°å­—ç”¨æˆ·çº¿è·¯ï¼ˆDSLï¼‰ã€‚<br>&emsp;&emsp;äº‹å®ä¸Šï¼Œç”µè¯ç½‘ä½¿ç”¨çš„è€ŒåŒç»çº¿èƒ½å¤Ÿæä¾›çš„å®¹é‡è¿œè¶…è¿‡è¯­éŸ³é€šä¿¡çš„éœ€æ±‚ã€‚DSLæ”¶å‘å™¨ä½œä¸ºå±€åŸŸç½‘ä¸ç”µè¯ç½‘çš„æ¥å£ï¼Œå…¶å·¥ä½œé¢‘ç‡ä¸ä¼šå½±å“çº¿è·¯çš„è¯­éŸ³é€šä¿¡ï¼Œå› æ­¤DSLå·¥ä½œæ—¶ä¸ä¼šå ç”¨çº¿è·¯æˆ–å½±å“ç”µè¯æœåŠ¡ã€‚<br>&emsp;&emsp;ä¸ç”µç¼†ç½‘ç»œä¸€æ ·çš„æ˜¯ï¼ŒDSLç½‘ç»œè¦æ±‚åœ¨çº¿è·¯å¦ä¸€ç«¯ä¹Ÿæœ‰ä¸€å°è®¾å¤‡æ¥æ”¶ä¿¡å·ï¼Œå¹¶ä¸”é€šè¿‡æœåŠ¡æä¾›å•†çš„ç½‘ç»œè¿æ¥åˆ°Internetï¼Œè¿™ç§è®¾å¤‡å°±æ˜¯â€œæ•°å­—æœåŠ¡çº¿è·¯è®¿é—®å¤šè·¯å¤ç”¨ï¼ˆDSLAMï¼‰â€,è¯¥è®¾å¤‡å……å½“DSLè¿æ¥çš„å¦ä¸€ç«¯ï¼ˆå›¾9.6ï¼‰ã€‚ä¸ç”µç¼†ç½‘ç»œä¸Šä¸€ä¸ªç½‘æ®µçš„å…¨éƒ¨ç”¨æˆ·å…±äº«ä»‹è´¨ä¸åŒï¼Œæ¯ä¸ªDSLç”¨æˆ·åœ¨æ”¶å‘å™¨ä¸DSLAMä¹‹é—´éƒ½æ˜¯ä¸“çº¿è¿æ¥ï¼Œæ‰€ä»¥æ€§èƒ½å—é€šä¿¡é‡çš„å½±å“æ¯”è¾ƒå°ã€‚è¯»è€…å¯èƒ½è§‰å¾—ï¼Œç”µç¼†ç½‘ç»œå’ŒLANç±»ä¼¼ï¼Œè€ŒDSLçº¿è·¯åˆ™æ˜¯ç‚¹å¯¹ç‚¹ç”µè¯è¿æ¥ç±»ä¼¼ã€‚</p><p>&emsp;&emsp;DSLå…·æœ‰å¤šç§å½¢å¼ï¼ŒåŒ…æ‹¬ADSLï¼ˆéå¯¹ç§°DSLï¼Œç”¨äºå°å‹åŠå…¬å®¤å’Œå®¶åº­çš„æœ€æµè¡Œæ–¹å¼ï¼‰ã€HDSLï¼ˆé«˜é€ŸDSLï¼‰ã€VDSLï¼ˆç”šé«˜é€ŸDSLï¼‰ã€SDSL(å¯¹ç§°DSLä¸Šä¸‹è¡Œå¸¦å®½ç›¸ç­‰)å’ŒIDSLï¼ˆåŸºäºDLSçš„ISDNï¼‰ã€‚ä»åè®®å±‚æ¥çœ‹ï¼ŒDSLæ ¹æ®è£…ç½®å’Œå®ç°æœ‰å¤šç§å˜åŒ–ã€‚æœ‰äº›DSLè®¾å¤‡é›†æˆåˆ°äº†äº¤æ¢æœºæˆ–è·¯ç”±å™¨ã€‚æœ‰å†™åˆ™å……å½“äº†ç½‘æ¡¥ï¼ˆç±»ä¼¼äºç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨ï¼‰ï¼Œåœ¨ç½‘ç»œè®¿é—®å±‚æ ¹æ®ç‰©ç†ï¼ˆMACï¼‰åœ°å€è¿‡æ»¤æµé‡ã€‚DSLè®¾å¤‡é€šå¸¸ç”¨ç‚¹åˆ°ç‚¹åè®®ï¼ˆæ¯”å¦‚PPPï¼‰å°è£…æ•°æ®ï¼Œæ¯”å¦‚æœ€æµè¡Œçš„åŸºäºä»¥å¤ªç½‘çš„PPPï¼ˆPPPoeï¼‰åè®®ã€‚</p><h4 id="9-4å¹¿åŸŸç½‘"><a href="#9-4å¹¿åŸŸç½‘" class="headerlink" title="9.4å¹¿åŸŸç½‘"></a><strong>9.4å¹¿åŸŸç½‘</strong></h4><p>&emsp;&emsp;å¤§é‡è®¡ç®—æœºçš„å…¬å¸å’Œå¤§å‹æœºæ„å¯¹ç½‘ç»œè®¿é—®çš„éœ€æ±‚ä¸èƒ½åƒæ‹¨å·å’ŒDSLè¿™æ ·çš„å°å‹æŠ€æœ¯æ‰€æ»¡è¶³çš„ï¼Œå…³é”®é—®é¢˜åœ¨äºå¦‚ä½•åˆ©ç”¨ä¸“æœ‰è¿æ¥æŠŠåˆ†æ•£åœ¨ä¸åŒåœ°ç‚¹çš„åˆ†æ”¯éƒ¨é—¨è¿æ¥èµ·æ¥ï¼Œè¿˜æœ‰å…·æœ‰ç±»ä¼¼äºå±€åŸŸç½‘çš„ç§å¯†æ€§ï¼Œå¹¶ä¸”åœ¨é«˜çº§åº”ç”¨å±‚é¢æä¾›è¶³å¤Ÿçš„æ€§èƒ½ã€‚è¿™ä¸ªé—®é¢˜ä¿ƒè¿›äº†å¹¿åŸŸç½‘çš„å‘å±•ã€‚</p><p>&emsp;&emsp;å¹¿åŸŸç½‘æŠ€æœ¯èƒ½å¤Ÿåœ¨è¿œè·ç¦»æä¾›é«˜é€Ÿç‡å¸¦å®½è¿ç½‘ã€‚è™½ç„¶å¹¿åŸŸç½‘çš„æ€§èƒ½ä¸æ˜¯åƒå±€åŸŸç½‘é‚£æ ·å¿«ï¼Œä½†é€šå¸¸æ¯”åˆ©ç”¨æ ‡å‡†è¿ç½‘æŠ€æœ¯é€šè¿‡Internetè¿æ¥è¿œç¨‹ä¸»æœºçš„é€Ÿåº¦è¦å¿«ï¼ˆè€Œä¸”æ›´å®‰å…¨ï¼‰ã€‚å¹¿åŸŸç½‘é£æ ¼çš„è¿æ¥é€šå¸¸ä¼šä»¥æŸç§æ–¹å¼æä¾›å¯¹å¤§å®¹é‡å…¬å¸ç½‘ç»œçš„è®¿é—®ï¼Œä»æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œå¹¿åŸŸç½‘å°±æ˜¯Internetæœ¬äº‹çš„æ ¸å¿ƒã€‚</p><p>å¹¿åŸŸç½‘çš„ä¸€äº›å½¢å¼åŒ…æ‹¬ï¼š</p><blockquote><p>å¸§ä¸­ç»§<br>ç»¼åˆä¸šåŠ¡æ•°å­—ç½‘ï¼ˆISDNï¼‰<br>é«˜çº§æ•°æ®é“¾è·¯æ§åˆ¶ï¼ˆHDLCï¼‰<br>å¼‚æ­¥ä¼ è¾“æ¨¡å¼ï¼ˆATMï¼‰</p></blockquote><p>&emsp;&emsp;è™½ç„¶è¿™äº›çœ‹ä¸Šå»éå¸¸å¤æ‚ï¼Œæœ‰äº›å“äººï¼ˆå®é™…ä¸Šä¹Ÿæ˜¯ï¼‰ï¼Œä½†å®é™…ä¸Šå®ƒä»¬ä¹Ÿæ˜¯ç”±äºå·¥ä½œäºTCP/IPç½‘ç»œè®¿é—®å±‚åè®®è¿›è¡Œç®¡ç†çš„ç‰©ç†ç½‘ç»œè§„èŒƒçš„å¦ä¸€ç§å½¢å¼ï¼ˆå¹¿åŸŸç½‘åè®®å‡ ä¹ä¸€ç›´æ˜¯OSIæ¨¡å‹çš„ä¸­å¿ƒï¼Œæ‰€ä»¥ä¸€å®šè®°ä½ç½‘ç»œè®¿é—®å±‚å¯¹åº”OSIæ¨¡å‹çš„ç‰©ç†å±‚å’Œæ•°æ®é“¾è·¯å±‚ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ç¬¬1å±‚å’Œç¬¬2å±‚ï¼‰ã€‚</p><p>&emsp;&emsp;å…¸å‹çš„å¹¿åŸŸç½‘åœºæ™¯å¦‚å›¾9.7æ‰€ç¤ºã€‚æœåŠ¡æä¾›å•†è¿è¡Œä¸€ä¸ªå¹¿åŸŸç½‘ï¼Œæä¾›å¯¹Internetçš„è®¿é—®ï¼Œä¹Ÿæä¾›å¯¹ç”¨æˆ·åˆ†æ”¯æœºæ„çš„è®¿é—®ã€‚ä¸€ä¸ªæœ¬åœ°ç¯è·¯æŠŠæœåŠ¡å•†çš„åŠå…¬å®¤è¿æ¥åˆ°æ‰€è°“çš„è¾¹ç•Œç‚¹ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·è¿æ¥åˆ°ç½‘ç»œçš„ç‚¹ã€‚å®¢æˆ·æä¾›è·¯ç”±å™¨è¿‡å…¶ä»–å¿…è¦çš„ä¸“ç”¨è®¾å¤‡ï¼Œä»è€Œé€šè¿‡å±€åŸŸç½‘è¿æ¥åˆ°å¹¿åŸŸç½‘ã€‚</p><p>&emsp;&emsp;æä¾›å•†ç¡®ä¿ä»è¾¹ç•Œç‚¹ä¹‹åçš„ä¸“ç”¨å®½å¸¦å’ŒæœåŠ¡çº§åˆ«ã€‚æœåŠ¡çš„å®‰æ’æ˜¯å¤šç§å¤šæ ·çš„ï¼Œå¯ä»¥ç”¨ç§Ÿå€Ÿçº¿è·¯ç»„æˆï¼Œä¹Ÿå¯ä»¥åŸºäºç”µè·¯æˆ–åŒ…äº¤æ¢è®¡é‡æ”¶è´¹ã€‚</p><h4 id="9-5-æ— çº¿ç½‘ç»œè¿æ¥"><a href="#9-5-æ— çº¿ç½‘ç»œè¿æ¥" class="headerlink" title="9.5 æ— çº¿ç½‘ç»œè¿æ¥"></a><strong>9.5 æ— çº¿ç½‘ç»œè¿æ¥</strong></h4><blockquote><p>802.11ç½‘ç»œ<br>ç§»åŠ¨IP<br>è“ç‰™</p></blockquote><p>è¿™äº›æŠ€æœ¯<code>é›†æˆ</code>åˆ°<code>äº§å“</code>å’Œ<code>æœåŠ¡çš„æ–¹å¼</code>å–å†³äºå‚å•†ã€‚<br><strong>9.5.1 802.11ç½‘ç»œ</strong><br>&emsp;&emsp;ç‰©ç†ç½‘ç»œçš„ç»†èŠ‚å­˜åœ¨äºTCP/IPåè®®æ ˆçš„ç½‘ç»œè®¿é—®å±‚ã€‚å¯¹æ— çº¿TCP/IPç½‘ç»œçš„æœ€ç®€å•ç†è§£å°±æ˜¯åœ¨ç½‘ç»œè®¿é—®å±‚ä½¿ç”¨æ— çº¿æ–¹å¼è¿æ¥åˆ°æ™®é€šç½‘ç»œã€‚æµè¡Œçš„IEEE &emsp;&emsp;802.11è§„èŒƒä¸ºç½‘ç»œè®¿é—®å±‚è¿›è¡Œæ— çº¿ç½‘ç»œè¿æ¥æä¾›äº†ä¸€ä¸ªæ¨¡å‹ã€‚<br>&emsp;&emsp;802.11åè®®æ ˆå¦‚å›¾9.8æ‰€ç¤ºã€‚ç½‘ç»œè®¿é—®å±‚çš„æ— çº¿ç»„ä»¶ä¸ä»¥å‰å­¦ä¹ çš„å…¶ä»–ç½‘ç»œä½“ç³»æ˜¯åŒç­‰çš„ã€‚äº‹å®ä¸Šï¼Œ802.11å› ä¸ºä¸IEEE 802.3ä»¥å¤ªç½‘æ ‡æ¡©çš„ç›¸ä¼¼æ€§å’Œå…¼å®¹æ€§ï¼Œç»å¸¸è¢«ç§°ä¸ºæ— çº¿ä»¥å¤ªç½‘ã€‚</p><p>&emsp;&emsp;ä»å›¾çœ‹å‡ºï¼Œ802.11è§„èŒƒä½äºOSIå‚è€ƒæ¨¡å‹çš„MACå­å±‚ã€‚MACå­å±‚å±äºOSIæ¨¡å‹çš„æ•°æ®è”ç»œå±‚ã€‚ä»ç¬¬2ç« ä¸­å¯ä»¥çŸ¥é“ï¼ŒOSIæ¨¡å‹æ•°æ®è”ç»œå±‚å’Œç‰©ç†å±‚å¯¹åº”äºTCP/IPçš„ç½‘ç»œè®¿é—®å±‚ã€‚ç‰©ç†å±‚çš„å„ç§é€‰é¡¹åˆ†åˆ«ä»£è¡¨äº†ä¸åŒçš„æ— çº¿å¹¿æ’­å½¢å¼ï¼ŒåŒ…æ‹¬è·³é¢‘æ‰©é¢‘ï¼ˆFHSSï¼‰ã€ç›´æ¥åºåˆ—æ‰©é¢‘ï¼ˆDSSSï¼‰ã€æ­£äº¤é¢‘åˆ†å¤ç”¨ï¼ˆOFDMï¼‰å’Œé«˜é€Ÿç‡ç›´æ¥åºåˆ—å¤ç”¨ï¼ˆHR/DSSSï¼‰ã€‚<br>&emsp;&emsp;æ— çº¿ç½‘ç»œä¸ä¼˜å…ˆç½‘ç»œçš„ä¸»è¦åŒºåˆ«å°±æ˜¯èŠ‚ç‚¹æ—¶ç§»åŠ¨çš„ï¼Œæ¢å¥è¯è¯´ï¼Œç½‘ç»œå¿…é¡»èƒ½å¤Ÿé€‚åº”è®¾å¤‡ä½ç½®çš„æ”¹å˜ã€‚ä½†å‰é¢çš„å­¦ä¹ å¯ä»¥çŸ¥é“ï¼ŒTCP/IPç½‘ç»œçš„åŸå§‹ä¼ è¾“ç³»ç»Ÿæ˜¯å»ºç«‹åœ¨è¿™æ ·ä¸€ç§å‡è®¾ä¸Šï¼šæ¯å°è®¾å¤‡éƒ½ä½äºå›ºå®šä½ç½®ã€‚å¦‚æœä¸€å°è®¡ç®—æœºç§»åŠ¨åˆ°å¦ä¸€ä¸ªç½‘æ®µï¼Œå®ƒå¿…é¡»é…ç½®ä¸ºä¸åŒçš„åœ°å€ï¼Œå¦åˆ™å°†æ— æ³•å·¥ä½œã€‚ä½†æ— çº¿ç½‘ç»œä¸Šçš„è®¾å¤‡ä¼šæŒç»­ç§»åŠ¨ï¼Œè€Œä¸”åœ¨è¿™ä¸ªç¯å¢ƒä¸­è™½ç„¶ä¿ç•™äº†ä»¥å¤ªç½‘çš„å¾ˆå¤šä¼ ç»Ÿï¼Œä½†æƒ…å†µå¯å®šä¼šå¤æ‚çš„å¤šï¼Œè¦æ±‚ä½¿ç”¨æ–°çš„ä¸åŒç­–ç•¥ã€‚<br><strong>æ³¨æ„ï¼š</strong>802.11å®¶æ—</p><blockquote><p>&emsp;&emsp;802.11å®é™…ä¸Šæ˜¯ä¸€ç³»åˆ—æ ‡å‡†çš„ç»Ÿç§°ï¼Œæœ€åˆçš„802.11æ ‡å‡†ï¼ˆ1997ï¼‰æ”¯æŒåœ¨2.4GHzé¢‘ç‡èŒƒå›´å†…æœ€é«˜é€Ÿç‡2Mbit/sã€‚802.11aæ ‡å‡†æ”¯æŒ5GHzé¢‘ç‡èŒƒå›´å†…æœ€é«˜é€Ÿç‡54Mbit/sã€‚802.11bæ ‡å‡†æ”¯æŒ2.4GHzé¢‘ç‡èŒƒå›´å†…ä¼ è¾“é€Ÿç‡5.5Mbit/så’Œ11Mbit/sã€‚æœ€åå‡ºç°çš„æ ‡å‡†æœ‰802.11g(åœ¨2003å¹´è¢«é‡‡çº³)å’Œ802.11nï¼ˆ2009ï¼‰ã€‚</p></blockquote><p><strong>1. ç‹¬ç«‹ç½‘ç»œå’Œç½‘ç»œåŸºç¡€</strong><br>&emsp;&emsp;æ— çº¿ç½‘ç»œçš„æœ€ç®€å•å½¢å¼å°±æ˜¯ä¸¤å°æˆ–å¤šå°å…·æœ‰æ— çº¿ç‹ç‚çš„è€Œè›‡å¸ç›´æ¥ç›¸äº’é€šä¿¡ï¼Œè¿™ç§ç±»å‹çš„ç½‘ç»œçš„æ­£å¼åç§°ä¸ºç‹¬ç«‹åŸºæœ¬æœåŠ¡é›†ï¼ˆç‹¬ç«‹BBSæˆ–IBBSï¼‰ï¼Œé€šå¸¸è¢«ç§°ä¸ºad hocç½‘ç»œã€‚ç‹¬ç«‹BSSå¯¹äºå°èŒƒå›´å†…å°‘é‡è®¡ç®—æœºæ¥è¯´å°±å¤Ÿç”¨äº†ã€‚ç‹¬ç«‹BSSç½‘ç»œã€‚ç‹¬ç«‹BSSç½‘ç»œæœ‰ä¸€å®šå±€é™æ€§ï¼Œå› ä¸ºå®ƒä¸»è¦ä¾èµ–å‚ä¸è¿ç½‘çš„è®¡ç®—æœºï¼Œæ²¡æœ‰æä¾›ç®¡ç†è¿æ¥çš„åŸºç¡€è®¾å¤‡ï¼Œä¹Ÿå°±ä¸èƒ½é“¾æ¥æ›´å¤§çš„ç½‘ç»œï¼Œæ¯”å¦‚å±€åŸŸç½‘æˆ–Internetã€‚<br>&emsp;&emsp;å¦ä¸€ç§æ— çº¿ç½‘ç»œè¢«ç§°ä¸ºåŸºç¡€åŸºæœ¬æœåŠ¡é›†ï¼ˆåŸºç¡€BBSï¼‰ï¼Œåœ¨å…¬å¸ç½‘ç»œå’Œå…¶ä»–æœºæ„æ˜¯å¾ˆå¸¸è§çš„ã€‚åŸºç¡€BBSä¾èµ–äºä¸€ä¸ªè¢«ç§°ä¸ºè®¿é—®ç‚¹ï¼ˆAcess Point,APï¼‰çš„å›ºå®šè®¾å¤‡ä¸æ— çº¿è®¾å¤‡å®ç°é€šä¿¡ï¼ˆå›¾9.10ï¼‰ã€‚APåˆ©ç”¨æ— çº¿å¹¿æ’­ä¸æ— çº¿ç½‘ç»œé€šä¿¡ï¼Œå®ƒè¿˜é€šè¿‡ä¼ ç»Ÿè¿æ¥æ–¹å¼è¿æ¥åˆ°æ™®é€šä»¥å¤ªç½‘ã€‚æ— çº¿è®¾å¤‡é€šè¿‡APè¿›è¡Œé€šä¿¡ã€‚å¦‚æœä¸€å°æ— çº¿è®¾å¤‡æƒ³ä¸åŒä¸€åŒºåŸŸä¸­çš„å…¶ä»–æ— çº¿è®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œå®ƒæŠŠå¸§å‘é€ç»™APï¼Œè®©APæŠŠæ¶ˆæ¯è½¬å‘ç»™ç›®çš„ã€‚å¯¹äºä¸ä¼ ç»Ÿç½‘ç»œçš„é€šä¿¡ï¼ŒAPå°±å……å½“ç½‘æ¡¥çš„ä½œç”¨ï¼ŒæŠŠå‘ç»™ä¼ ç»Ÿç½‘ç»œä¸Šè®¾å¤‡çš„å¸§è¿›è¡Œè½¬å‘ï¼Œå¹¶ä¸”æŠŠæ— çº¿ç½‘ç»œçš„é€šä¿¡éš”ç¦»åœ¨æ— çº¿åŒºåŸŸä¸­ã€‚<br>&emsp;&emsp;å›¾9.10æ‰€ç¤ºçš„ç½‘ç»œè®©è®¡ç®—æœºåƒæœ‰çº¿ä»¥å¤ªç½‘ç»œä¸Šé‚£æ ·å·¥ä½œã€‚è€Œä¸”å¤šä¸ªè®¿é—®ç‚¹é€šè¿‡ä¼ ç»Ÿä»¥å¤ªç½‘è¿æ¥åœ¨ä¸€èµ·æ¥ä¸ºè¾ƒå¤§åŒºåŸŸæä¾›æœåŠ¡æ—¶ï¼ˆè§å›¾9.11ï¼‰åŸºç¡€BBSçš„é…ç½®ä¹Ÿæœ‰å¾ˆå¤šå¥½å¤„ã€‚<br>&emsp;&emsp;802.11dçš„è®¾è®¡ç›®æ ‡å°±æ˜¯æ»¡è¶³å›¾9.11æ‰€ç¤ºçš„ç½‘ç»œéœ€æ±‚ï¼Œå…¶é‡Œé¢æ˜¯è®©ç§»åŠ¨è®¾å¤‡åœ¨ç½‘ç»œæœåŠ¡åŒºåŸŸä¸­æ¼«æ¸¸æ—¶ä¿æŒè¿æ¥ã€‚é¦–å…ˆè¯´æ˜ï¼šå¦‚æœè®¾å¤‡éœ€è¦æ¥å—å…¨éƒ¨ç½‘ç»œä¼ è¾“ï¼Œç½‘ç»œå¿…é¡»çŸ¥é“é€šè¿‡å“ªä¸ªAPèƒ½åˆ°è¾¾è¯¥è®¾å¤‡ï¼Œè¿™å½“ç„¶è¦è€ƒè™‘åˆ°è®¾å¤‡æ˜¯å¯ç§»åŠ¨çš„ï¼Œè€Œä¸”é€‚åˆçš„APä¹Ÿå¯èƒ½ä¸ºæœªåŠ æç¤ºçš„æƒ…å†µä¸‹å‘é€æ”¹å˜ã€‚å¦å¤–è¦è¯´æ˜çš„æ˜¯ï¼Œæºåœ°å€å’Œç›®çš„åœ°å€çš„ä¼ ç»Ÿæ¦‚å¿µå¯¹äºåœ¨æ— çº¿ç½‘ç»œä¼ è¾“æ•°æ®æ¥è¯´å·²ç»ä¸å¤Ÿç”¨äº†ï¼Œ802.11å¸§å…·æœ‰å¦‚ä¸‹4ä¸­åœ°å€ï¼š</p><blockquote><p><strong>ç›®çš„åœ°å€ï¼š</strong>å¸§ä¼ è¾“çš„ç›®çš„è®¾å¤‡ã€‚<br><strong>æºåœ°å€ï¼š</strong>å‘é€å¸§çš„è®¾å¤‡ã€‚<br><strong>æ¥æ”¶è€…çš„åœ°å€ï¼š</strong>åº”è¯¥å¤„ç†è¿™ä¸ª802.11å¸§çš„æ— çº¿è®¾å¤‡ã€‚å¦‚æœå¸§è¦ä¼ è¾“åˆ°æ— çº¿è®¾å¤‡ï¼Œæ¥æ”¶è€…åœ°å€å°±ä¸ç›®çš„åœ°å€æ˜¯ä¸€è‡´çš„ã€‚å¦‚æœå¸§è¦ä¼ è¾“åˆ°æ— çº¿ç½‘ç»œä¹‹å¤–ï¼Œæ¥æ”¶è€…åœ°å€å°±æ˜¯æŸä¸ªAPçš„åœ°å€ï¼Œè¯¥APä¼šæ¥æ”¶è¿™ä¸ªå¸§å¹¶ä¸”æŠŠå®ƒè½¬å‘ç»™ä»¥å¤ªç½‘ç»œã€‚<br><strong>å‘å°„è€…åœ°å€ï¼š</strong>æŠŠå¸§è½¬å‘ç»™æ— çº¿ç½‘ç»œçš„è®¾å¤‡åœ°å€ã€‚</p></blockquote><p>802.11çš„å¸§æ ¼å¼å¦‚å›¾9.12æ‰€ç¤ºï¼Œå…¶ä¸­ä¸€äº›é‡è¦å­—æ®µå¦‚ä¸‹æ‰€ç¤ºï¼š</p><blockquote><p><strong>å¸§æ§åˆ¶ï¼š</strong>ä¸€äº›è¾ƒå°å­—æ®µçš„é›†åˆï¼Œæè¿°äº†åè®®ç‰ˆæœ¬ã€å¸§ç±»å‹å’Œè§£é‡Šå¸§å†…å®¹æ‰€éœ€çš„å…¶ä»–å€¼ã€‚<br><strong>æœŸé™/IDï¼š</strong>è®¾ç½®ä¼ è¾“å¤§è‡´åº”è¯¥æŒç»­å¤šé•¿çš„æ—¶é—´ã€‚è¿˜å¯ä»¥è¯·æ±‚APç¼“å­˜çš„å¸§ã€‚<br><strong>åœ°å€å­—æ®µï¼š</strong>48ä½çš„ç‰©ç†åœ°å€ã€‚ç”±äº802.11æœ‰æ—¶éœ€è¦æœ€å¤š4ä¸­ä¸åŒçš„åœ°å€ï¼Œæ‰€æœ‰ä¼šæ ¹æ®ä¸åŒç±»å‹çš„å¸§ä½¿ç”¨ä¸åŒçš„åœ°å€å­—æ®µã€‚ç¬¬1ä¸ªå­—æ®µé€šå¸¸æ˜¯æ¥æ”¶è€…åœ°å€ï¼Œç¬¬2ä¸ªå­—æ®µé€šå¸¸æ˜¯å‘å°„è€…çš„åœ°å€ã€‚<br><strong>åºåˆ—æ§åˆ¶ï¼š</strong>ç‰‡é€‰åºåˆ—ï¼ˆç”¨äºé‡ç»„ç‰‡é€‰ï¼‰ä»¥åŠå¸§çš„åºåˆ—å·ã€‚<br><strong>å¸§ä¸»ä½“ï¼š</strong>å¸§ä¸­ä¼ è¾“çš„æ•°æ®ã€‚ç¬¬2ç« ä¸­å·²ç»ä»‹ç»è¿‡ï¼Œå¸§ä¸­ä¼ è¾“çš„æ•°æ®è¿˜åŒ…æ‹¬ä¸Šå±‚åè®®çš„æŠ¥å¤´æ­‡æ¯ã€‚<br><strong>å¸§æ ¡éªŒåºåˆ—ï¼ˆFCSï¼‰ï¼š</strong>ä¸€ä¸ªå¾ªç¯å†—ä½™æ ¡éªŒå€¼ï¼Œç”¨äºæ£€æŸ¥ä¼ è¾“é”™è¯¯å¹¶éªŒè¯å¸§åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ²¡æœ‰æ”¹å˜ã€‚</p></blockquote><p>ç”±äº802.11æ˜¯ä¸ªç½‘ç»œè®¿é—®å±‚çš„åè®®é›†ï¼Œæ‰€ä»¥802.11å¸§ä¸­ä½¿ç”¨çš„åœ°å€æ˜¯48ä½ç‰©ç†åœ°å€ï¼Œè€Œä¸æ˜¯IPåœ°å€ã€‚å½“è®¾å¤‡åœ¨æ— çº¿ç½‘ç»œä¸­ç§»åŠ¨æ—¶ï¼Œå®ƒä¼šå‘æœ€è¿‘å¯ç”¨çš„Pè¿›è¡Œæ³¨å†Œï¼ˆä»æŠ€æœ¯ä¸Šè®²ï¼Œå®ƒä¼šå‘ä¿¡å·æœ€å¼ºã€å¹²æ‰°æ€§æœ€å°çš„APæ³¨å†Œï¼‰ã€‚è¿™ä¸ªæ³¨å†Œè¿‡ç¨‹è¢«ç§°ä¸ºå…³è”ï¼ˆassociationï¼‰ã€‚å½“è®¾å¤‡æ¼«æ¸¸åˆ°å¦ä¸€ä¸ªè®¿é—®ç‚¹é™„è¿‘æ—¶ï¼Œå®ƒä¼šé‡æ–°å…³è”åˆ°æ–°çš„APã€‚è¿™ä¸ªå…³è”è¿‡ç¨‹è®©ç½‘ç»œèƒ½å¤ŸçŸ¥é“åˆ°è¾¾ä»»ä½•ä¸€è®¾å¤‡åº”è¯¥ä½¿ç”¨å“ªä¸ªAP.</p><p><strong>æ³¨æ„ï¼š</strong> WiFiè”ç›Ÿ</p><blockquote><p>ä¸ºäº†ç¡®ä¿802.11è®¾å¤‡çš„å…¼å®¹æ€§ï¼Œåä¸ºæ— çº¿ä»¥å¤ªç½‘å…¼å®¹è”ç›Ÿï¼ˆWECAæˆç«‹äº1991å¹´ï¼‰çš„ç»„ç»‡æä¾›äº†ä¸€ä¸ªé’ˆå¯¹æ— çº¿äº§å“çš„è®¤è¯é¡¹ç›®ã€‚è¯¥ç»„ç»‡åæ¥å°†å…¶åå­—å‘½åä¸ºWiFiè”ç›Ÿï¼Œå¦‚æœæƒ³å¾—åˆ°Wi-Fiï¼ˆæ— çº¿ä¿çœŸï¼‰è®¤è¯ï¼Œå¿…é¡»å¯¹äº§å“è¿›è¡Œæµ‹è¯•ï¼Œå·²éªŒè¯å®ƒä¸å…¶ä»–æ— çº¿è®¾å¤‡ä¹‹é—´å…·æœ‰äº’æ“ä½œæ€§ã€‚æœ‰å…³WiFiè”ç›Ÿçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®<a href="http://www.wi-if.orgã€‚" target="_blank" rel="noopener">www.wi-if.orgã€‚</a></p></blockquote><p><strong>2. 802.11å®‰å…¨</strong><br>&emsp;&emsp;å¾ˆæ˜æ˜¾ï¼Œæ²¡æœ‰ä¿æŠ¤çš„æ— çº¿ç½‘ç»œæ—¶å¾ˆä¸å®‰å…¨çš„ã€‚åœ¨å¯¹ä¼ ç»Ÿç½‘ç»œè¿›è¡Œçªƒå¬æ—¶ï¼Œè‡³å°‘éœ€è¦è¿æ¥åˆ°ä¼ è¾“ä»‹è´¨ä¸Šã€‚è€Œå¯¹äºæ— çº¿ç½‘ç»œæ¥è¯´ï¼Œåœ¨å…¶å¹¿æ’­èŒƒå›´ä¹‹å†…å°±å¯ä»¥è¿›è¡Œæ”»å‡»ã€‚å¦‚æœç½‘ç»œæ²¡æœ‰è®¾å…šçš„ä¿è¯æªæ–½ï¼Œä¸ä»…å®¹æ˜“è¢«çªƒå¬ï¼Œè€Œä¸”å¾ˆå®¹æ˜“å°±è®©éæ³•ç”¨æˆ·è¿›å…¥ç½‘ç»œã€‚<br>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ã€‚IEEEåˆ¶å®šäº†ä¸€ä¸ªå¯é€‰çš„å®‰å…¨åè®®æ ‡å‡†ç”¨äº802.11ï¼›æœ‰çº¿ç­‰æ•ˆä¿å¯†ï¼ˆWired Equivalent Privacy,WEPï¼‰æ ‡å‡†ï¼Œå…¶ç›®çš„æ˜¯æä¾›ä¸ä¼ ç»Ÿä¼˜å…ˆç½‘ç»œå¤§è‡´ç›¸åŒçš„ä¿å¯†ç•Œåˆ«ã€‚<br>WEPçš„ç›®æ ‡åœ¨äºè§£å†³å¦‚ä¸‹é—®é¢˜ï¼š</p><blockquote><p><strong>æœºå¯†æ€§ï¼š</strong>é˜²æ­¢çªƒå¬<br><strong>å®Œæ•´æ€§ï¼š</strong>ä»¿çœŸæ•°æ®è¢«ç¯¡æ”¹<br><strong>èº«ä»½éªŒè¯ï¼š</strong>å¯¹è¿æ¥å›¢é˜Ÿè¿›è¡ŒéªŒè¯ï¼Œç¡®ä¿ä»–ä»¬æœ‰æ“ä½œç½‘ç»œçš„å¿…è¦æƒé™ã€‚</p></blockquote><p>WEPä½¿ç”¨RC4ç®—æ³•è¿›è¡ŒåŠ å¯†æ¥å®ç°<code>æœºå¯†æ€§</code>å’Œ<code>å®Œæ•´æ€§</code>çš„ç›®æ ‡ã€‚å‘é€è®¾å¤‡ä¼šç”Ÿæˆä¸€ä¸ªå®Œæ•´æ€§æ ¡éªŒå€¼ï¼ˆIntegrity Check Value,ICVï¼‰,è¿™ä¸ªå€¼æ˜¯åŸºäºå¸§å†…å®¹è¿›è¡Œæ ‡å‡†è®¡ç®—è€Œå¾—åˆ°çš„ï¼Œå®ƒä½¿ç”¨RC4ç®—æ³•è¿›è¡ŒåŠ å¯†ï¼Œä¼ è¾“ç»™æ¥æ”¶æ–¹ã€‚æ¥æ”¶è®¾å¤‡å¯¹å¸§è¿›è¡Œè§£å¯†ï¼Œè®¡ç®—ICVçš„å€¼ï¼Œå¦‚æœè®¡ç®—åçš„ICVå€¼ä¸å¸§ä¸­ä¼ è¾“çš„æ•°å€¼ç›¸åŒï¼Œå°±è¡¨ç¤ºå¸§æ²¡æœ‰è¢«ä¿®æ”¹ã€‚<br>&emsp;&emsp;ç„¶è€Œ,WEPå—åˆ°äº†å®‰å…¨ä¸“å®¶ä»¬çš„åå¯¹ã€‚å¤§å¤šæ•°è½¬æ¥ä»»åŠ¡WEPæ˜¯æ— æ•ˆçš„ã€‚æœ‰äº›å¯¹äºWEPçš„ä¹‹ä¸€å®é™…ä¸Šæ˜¯åå¯¹RC4åŠ å¯†ç®—æ³•çš„å®ç°ã€‚WEPåœ¨ç†è®ºä¸Šä½¿ç”¨64ä¸ºå¯†é’¥ï¼Œä½†å…¶ä¸­24ä½æ˜¯ç”¨äºåˆå§‹åŒ–çš„ï¼Œåªæœ‰40ä½ç”¨ä½œå…±äº«å¯†é’¥ã€‚ä¸“å®¶è®¤ä¸º40ä½çš„å¯†é’¥å¤ªçŸ­äº†ï¼Œæ‰€ä»¥WEPä¸èƒ½å®ç°æœ‰æ•ˆçš„å®åã€‚ä¸“å®¶è¿˜æ‰§æ³¥å¯†é’¥ç®¡ç†ç³»ç»Ÿå’Œç”¨äºå¯åŠ¨åŠ å¯†çš„24ä½åˆå§‹åŒ–çŸ¢é‡ã€‚<br>&emsp;&emsp;WEP2æ˜¯å¯¹WEPçš„å‡çº§ï¼ŒæŠŠåˆå§‹åŒ–çŸ¢é‡å¢åŠ çš„128ä½ï¼Œå¹¶ä¸”ä½¿ç”¨Kerberosèº«ä»½éªŒè¯æ¥ç®¡ç†å¯†é’¥çš„ä½¿ç”¨ä¸åˆ†å‘ã€‚ç„¶è€Œï¼ŒWEP2å¹¶æ²¡æœ‰è§£å†³WEPçš„å…¨éƒ¨é—®é¢˜ï¼Œå› æ­¤å‡ºç°äº†å…¶ä»–ä¸€äº›åè®®ï¼Œæ¯”å¦‚å¯æ‰©å±•èº«ä»½éªŒè¯åè®®(Extensible Authentication Protocol,EAP),å¯ä»¥è§£å†³WEPé¢ä¸´çš„éš¾é¢˜ã€‚<br>&emsp;&emsp;ä½œä¸ºä¸€ä¸ªæ›´å¥½çš„æ— çº¿å®‰å…¨åè®®ï¼Œ802.11iæ ‡å‡†è‰æ¡ˆå‡ºç°äº2004å¹´ï¼Œå¹¶åœ¨2007å¹´æ”¶å…¥802,11æ ‡å‡†ã€‚è¿™ä¸ªæ–°æ–¹æ³•ä¹Ÿè¢«åƒå‘¢æ”¹ä¸ºWiFiä¿æŠ¤è®¿é—®2(WiFi Protected AcessII,WPA2),ä½¿ç”¨AESå—å¯†ç è€Œä¸æ˜¯RC4è¿›è¡ŒåŠ å¯†ï¼Œè€Œä¸”å…·æœ‰æ›´å®‰å…¨çš„èº«ä»½éªŒè¯å’Œå¯†ç åˆ†å‘è¿‡ç¨‹ï¼ŒWPA2æ˜¯æ— çº¿å®‰å…¨é¢†åŸŸçš„ä¸€å¤§è¿›æ­¥ï¼Œè€Œä¸”ä½œä¸ºæ— çº¿ç½‘ç»œè¿æ¥ä½¿ç”¨çš„é¦–é€‰å®‰å…¨æ–¹æ³•å¯¹WEPè¿›è¡Œæ›¿æ¢ã€‚</p><p>&emsp;&emsp;å…¶ä»–å®‰å…¨æ–¹æ³•ï¼šæ— çº¿è·¯ç”±å™¨è®¾ç½®å…è®¸è®¿é—®ç½‘ç»œè®¡ç®—çš„MACåœ°å€ã€‚å¯æœ‰æ•ˆçš„é˜²æ­¢é‚»å±…ç›—ç”¨å¸¦å®½ï¼Œä½†æœ‰ç»éªŒçš„å…¥ä¾µè€…èƒ½å¤Ÿç»•è¿‡è¿™ç§æ§åˆ¶ã€‚</p><p><strong>9.5.2 ç§»åŠ¨IP</strong><br>&emsp;&emsp;ä¸–ç•Œå„åœ°ç§»åŠ¨è®¾å¤‡ç»™åº”ç­”æœºåˆ¶æå‡ºäº†ä¸€ä¸ªé—®é¢˜ã€‚Internet å¯»å€ç³»ç»Ÿæ˜¯åˆ†çº§ç»„ç»‡çš„ï¼Œå…¶å‰ææ˜¯ç›®æ ‡è®¾å¤‡ä½äºç”±IPåœ°å€å®šä¹‰çš„ç½‘æ®µä¸­ã€‚ç”±äºç§»åŠ¨è®¾å¤‡å¯èƒ½ä½äºä»»ä½•ä¸€ä¸ªä½ç½®ï¼Œæ‰€ä»¥é€šä¿¡è§„åˆ™å°±å˜å¾—å¤æ‚å¤šè·¯ã€‚ä¸ºäº†ç»´æŠ¤ä¸€ä¸ªTCPè¿æ¥ï¼Œè®¾å¤‡å¿…é¡»å…·æœ‰å›ºå®šIPåœ°å€ï¼Œè¿™æ„å‘³ç€æ¼«æ¸¸è®¾å¤‡ä¸èƒ½ç®€å•åœ°ä½¿ç”¨ä¸€ä¸ªç”±æœ€è¿‘å‘å°„å™¨åˆ†é…çš„åœ°å€ã€‚å¦å¤–ç”±äºè¿™ä¸ªé—®é¢˜ä¸Internetå¯»å€ç›¸å…³ï¼Œå®ƒä¸èƒ½ç½‘ç»œè®¿é—®å±‚å¾—ä»¥è§£å†³ï¼Œéœ€è¦å¯¹ç½‘é™…æˆçš„IPåè®®è¿›è¡Œæ‹“å±•ã€‚ç§»åŠ¨IPæ‹“å±•åœ¨RFC 3220ä¸­å®šä¹‰ï¼Œä¹‹ååˆè¿›è¡Œè¿‡å¤šæ¬¡æ›´æ–°ï¼Œæœ€æ–°çš„IPv4ç§»åŠ¨æ ‡å‡†æ˜¯RFC5944ã€‚<br>&emsp;&emsp;ç§»åŠ¨IPç»™å›ºå®šIPåœ°å€å…³è”ä¸Šä¸€ä¸ªè¾…åŠ©åœ°å€æ¥è§£å†³å¯»å€é—®é¢˜ã€‚ç§»åŠ¨IPç¯å¢ƒå¦‚å›¾8.13æ‰€ç¤ºï¼Œè®¾å¤‡å…·æœ‰å±äºå®¶ä¹¡ç½‘ç»œçš„å›ºå®šåœ°å€ã€‚å®¶ä¹¡ç½‘ç»œä¸Šæœ‰ä¸€ä¸ªè¢«ç§°ä¸ºâ€œå®¶ä¹¡ä»£ç†ï¼ˆHome Agentï¼‰â€çš„ä¸“ç”¨è·¯ç”±å™¨ï¼Œå®ƒç»´æŠ¤ä¸€ä¸ªè¡¨æ ¼ï¼ŒæŠŠè®¾å¤‡çš„å½“å‰ä½ç½®ä¸å›ºå®šåœ°å€ç»‘å®šã€‚å½“æ¶‰ç¬”è¿›å…¥åˆ°ä¸€ä¸ªæ–°ç½‘ç»œæ—¶ï¼Œå®ƒå°†æ³¨å†Œåˆ°è¯¥ç½‘ç»œä¸­è¿è¡Œçš„å¤–åœ°ä»£ç†ï¼ˆForeign Agentï¼‰ä¸­ã€‚å¤–åœ°ä»£ç†å°±æŠŠç§»åŠ¨è®¾å¤‡æ·»åŠ åˆ°è®¿é—®è€…åˆ—è¡¨ï¼Œå¹¶ä¸”æŠŠè®¾å¤‡å½“å‰ä½ç½®çš„ä¿¡æ¯å‘é€ç»™å®¶ä¹¡ä»£ç†ï¼Œå®¶ä¹¡ä»£ç†å°±ä¼šç”¨è®¾å¤‡å½“å‰ä½ç½®ä¿¡æ¯æ›´æ–°è‡ªå·±çš„ç§»åŠ¨æ€§ç»‘å®šè¡¨ã€‚å½“å‘å¾€è¿™å°è®¾å¤‡çš„æ•°æ®æŠ¥åˆ°è¾¾å®¶ä¹¡ç½‘ç»œæ—¶ï¼Œå®ƒè¢«å°è£…åˆ°ä¸€ä¸ªç›®æ ‡ä¸ºå¤–åœ°ç½‘ç»œçš„æ•°æ®åŒ…ï¼Œæœ€ç»ˆåˆ°è¾¾è¯¥è®¾å¤‡ã€‚</p><p><strong>9.5.3 è“ç‰™</strong><br>&emsp;&emsp;è“ç‰™åè®®æ˜¯æ— çº¿è®¾å¤‡çš„å¦ä¸€ç§è§„èŒƒã€‚ä¸802.11ä¸€æ ·ï¼Œè“ç‰™æ ‡å‡†å®šä¹‰äº†OSIæ¨¡å‹ä¸­æ•°æ®é“¾è·¯å±‚çš„ç‰©ç†å±‚ï¼ˆç­‰æ•ˆäºTCP/IPç½‘ç»œè®¿é—®å±‚ï¼‰ã€‚åœ¨æŸç§æƒ…å†µä¸‹802.11å¯ä»¥ä»£æ›¿è“ç‰™ï¼Œä½†æ˜¯è“ç‰™çš„æ”¯æŒè€…æ€»æ˜¯å¾ˆæ„¿æ„è¡¨æ˜è“ç‰™æ²¡æœ‰802.11çš„ä¸€äº›å®‰å…¨é—®é¢˜ï¼Œç„¶è€Œè“ç‰™å’Œ802.11è¢«çœ‹åšæ˜¯äº’è¡¥æŠ€æœ¯ã€‚802.11æ˜¯ä¸ºæä¾›ä¸ä»¥å¤ªç½‘åŒç­‰çš„æ— çº¿ç½‘ç»œï¼Œè€Œè“ç‰™è‡´åŠ›äºåœ¨çŸ­è·ç¦»èŒƒå›´ä¹‹å†…ä¸ºæ— çº¿è®¾å¤‡æä¾›å¯é çš„ï¼Œé«˜æ€§èƒ½çš„ç¯å¢ƒã€‚è“ç‰™çš„è®¾è®¡ç›®æ ‡æ˜¯å®ç°ä¸€ä¸ªå°å·¥ä½œåŒºåŸŸå†…ä¸€ç»„æ— çº¿äº¤äº’è®¾å¤‡çš„é€šä¿¡ã€‚åœ¨è“ç‰™çš„è§„èŒƒä¸­ï¼Œè¿™ä¸ªå°åŒºåŸŸè¢«ç§°ä¸ºä¸ªåŸŸç½‘ï¼ˆPersonal Area Netwoek,PANï¼‰.<br>&emsp;&emsp;åƒå…¶ä»–æ— çº¿å½¢å¼ä¸€æ ·ï¼Œè“ç‰™ä½¿ç”¨APæŠŠæ— çº¿ç½‘ç»œè¿æ¥åˆ°ä¼ ç»Ÿç½‘ç»œï¼ˆåœ¨è“ç‰™å±äºä¸­ï¼Œè¿™ä¸ªAPè¢«ç§°ä¸ºâ€œç½‘ç»œAPâ€æˆ–NAPï¼‰ã€‚è“ç‰™å°è£…åè®®èƒ½å¤Ÿå¯¹è¿›è¡ŒTCP/IPæ•°æ®åŒ…è¿›è¡Œå°è£…ï¼Œä»è€Œåœ¨è“ç‰™ç½‘ç»œè¿›è¡Œä¼ è¾“ã€‚<br>&emsp;&emsp;å½“ç„¶ï¼Œå¦‚æœä¸€ä¸ªè“ç‰™è®¾å¤‡å¯ä»¥é€šè¿‡Internetè®¿é—®ï¼Œåˆ™å®ƒå¿…é¡»èƒ½é€šè¿‡TCP/IPè®¿é—®ã€‚å‚å•†é¢„æƒ³ç”Ÿäº§ä¸€ç±»å…¼å®¹Internetçš„è“ç‰™è®¾å¤‡ï¼Œé€šè¿‡å…·æœ‰è“ç‰™åŠŸèƒ½çš„Internetç½‘æ¡¥è¿æ¥åˆ°Internet(å›¾9.14)ã€‚è“ç‰™NAPè®¾å¤‡å……å½“ç½‘æ¡¥ï¼Œé€šè¿‡å…·æœ‰è“ç‰™åŠŸèƒ½çš„Internetç½‘æ¡¥ï¼Œæ¥æ”¶è¾“å…¥çš„TCP/IPæ•°æ®ï¼Œç„¶åç”¨è“ç‰™ç½‘ç»œè®¿é—®åè®®æ›¿æ¢è¾“å…¥çš„ç½‘ç»œè®¿é—®å±‚åè®®ã€‚ä»è€ŒæŠŠæ•°æ®ä¼ è¾“åˆ°æ¥æ”¶è®¾å¤‡ã€‚</p><h4 id="9-6-è¿æ¥è®¾å¤‡"><a href="#9-6-è¿æ¥è®¾å¤‡" class="headerlink" title="9.6 è¿æ¥è®¾å¤‡"></a><strong>9.6 è¿æ¥è®¾å¤‡</strong></h4><p>&emsp;&emsp;å‰é¢ä»‹ç»äº†TCP/IPç½‘ç»œä¸­ä¸è·¯ç”±å™¨ç›¸å…³çš„é‡è¦ä¸»é¢˜ï¼Œè™½ç„¶è·¯ç”±å™¨æ—¶éå¸¸é‡è¦å’ŒåŸºç¡€çš„æ¦‚å¿µï¼Œä½†TCP/IPç½‘ç»œè¿˜æœ‰å…¶ä»–å¾ˆå¤šè¿æ¥è®¾å¤‡ã€‚<br>&emsp;&emsp;å„ç§å„æ ·çš„è¿æ¥è®¾å¤‡éƒ½åœ¨TCP/IPç½‘ç»œ<code>æµé‡ç®¡ç†</code>ä¸­æ‰®æ¼”ä¸åŒçš„è§’è‰²ï¼Œä¸‹é¢å°†åˆ†è´ä»‹ç»ç½‘æ¡¥ã€HUBå’Œäº¤æ¢æœºã€‚</p><p><strong>9.6.1 ç½‘æ¡¥</strong><br>&emsp;&emsp;ç½‘æ¡¥æ˜¯æ ¹æ®ç‰©ç†åœ°å€è¿‡æ»¤å’Œè½¬å‘æ•°æ®åŒ…çš„è¿æ¥è®¾å¤‡ï¼Œå®ƒå·¥ä½œäºOSIæ¨¡å‹çš„æ•°æ®é“¾è·¯å±‚ï¼ˆå¯¹åº”äºTCP/IPç½‘ç»œçš„ç½‘ç»œè®¿é—®å±‚ï¼‰ã€‚è¿‘äº›å¹´æ¥ï¼Œç½‘ç»œå€¾å‘äºä½¿ç”¨åŠŸèƒ½æ›´å¼ºçš„è®¾å¤‡ï¼Œæ¯”å¦‚äº¤æ¢æœºï¼Œæ‰€ä»¥ç½‘æ¡¥çš„ä½¿ç”¨è¶Šæ¥è¶Šå°‘ã€‚ä½†ç½‘æ¡¥çš„é›†æ•£å•æ€§æ•²å¥½é€‚åˆä½œä¸ºè®¨è®ºè¿æ¥è®¾å¤‡çš„è§¦å‘ç‚¹ã€‚<br>&emsp;&emsp;è™½ç„¶ç½‘æ¡¥ä¸æ˜¯è·¯ç”±å™¨ï¼Œä½†ä»ç„¶è¢«ä½¿ç”¨ä¸€ä¸ªè·¯ç”±è¡¨ä½œä¸ºä¼ è¾“ä¿¡æ¯çš„æ ¹æ®ã€‚è¿™ä¸ªæœºé‡ç‰©ç†åœ°å€çš„è·¯ç”±è¡¨ä¸åé¢è¦ä»‹ç»çš„è·¯ç”±è¡¨ç›¸æ¯”ï¼Œä¸ä»…å…·æœ‰ä¸åŒçš„å½¢å¼ï¼Œè€Œä¸”ä¹Ÿç®€å•å¾—å¤šã€‚<br>&emsp;&emsp;ç½‘æ¡¥ç›‘å¬å®ƒæ‰€è¿æ¥çš„æ¯ä¸€ä¸ªç½‘æ®µï¼Œå»ºç«‹ä¸€ä¸ªè¡¨æ¥ååº”ç‰©ç†åœ°å€ä½äºå“ªä¸ªç½‘æ®µã€‚å½“æ•°æ®åœ¨ä¸€ä¸ªç½‘æ®µä¸Šä¼ è¾“æ—¶ï¼Œç½‘æ¡¥ä¼šæŸ¥çœ‹æ•°æ®çš„ç›®çš„åœ°å€ï¼Œä¸è·¯ç”±è¡¨è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœç›®çš„åœ°å€å±äºå‘é€æ•°æ®çš„ç½‘æ®µï¼Œç½‘æ¡¥å°±å¿½ç•¥è¿™ä¸ªæ•°æ®ã€‚å¦‚æœç›®çš„åœ°å€åœ¨ä¸åŒçš„ç½‘æ®µï¼Œç½‘æ¡¥å°±æŠŠæ•°æ®è½¬å‘åˆ°æ˜¯çš„ç½‘æ®µã€‚å¦‚æœç›®çš„åœ°å€ä¸åœ¨è·¯ç”±è¡¨ä¸­ï¼Œç½‘æ¡¥å°±ä¼šæŠŠæ•°æ®è½¬å‘åˆ°é™¤ç½‘æ®µä¹‹å¤–çš„å…¨éƒ¨ç½‘æ®µã€‚<br><strong>æ³¨æ„ï¼š</strong>ç½‘ç»œåœ°å€ vs é€»è¾‘åœ°å€</p><blockquote><p>è¦è®°ä½ï¼Œç½‘æ¡¥ä½¿ç”¨åœ¨åŸºäºç¡¬ä»¶dç‰©ç†åœ°å€ä¸é€»è¾‘IPåœ°å€ä¸åŒï¼Œè¿™ä¸¤è€…ä¹‹å‰çš„å»å‘—ï¼Œè¯¦è§ç¬¬1~ç¬¬4ç« ï¼Œ</p></blockquote><p>&emsp;&emsp;ç½‘æ¡¥å±‚ä½œä¸ºå±€åŸŸç½‘ä¸Šè¿‡æ»¤æµé‡çš„ä¸€ç§å»‰ä»·è®¾å¤‡å¤§é‡ä½¿ç”¨ï¼Œç”¨äºå¢åŠ ç½‘ç»œä¸Šèƒ½å¤Ÿèå®‰çš„è®¡ç®—æœºæ•°é‡ã€‚å‰é¢å·²ç»ä»‹ç»è¿‡ï¼Œç°åœ¨ä¸€äº›ç½‘ç»œè®¿é—®è®¾å¤‡éƒ½é›†æˆäº†ç½‘æ¡¥çš„åŠŸèƒ½ã€‚æ¯”å¦‚ç”µç¼†è°ƒåˆ¶è§£è°ƒå™¨å’ŒæŸäº›DSLè®¾å¤‡ã€‚ç”±äºç½‘æ¡¥å€¼ä½¿ç”¨ç½‘ç»œè®¿é—®å±‚çš„ç‰©ç†åœ°å€ï¼Œä¸æ£€æŸ¥IPæ•°æ®æŠ¥å¤´çš„é€»è¾‘åœ°å€ä¿¡æ¯ï¼Œæ‰€ä»¥ä¸é€‚åˆè¿æ¥éåŒç±»ç½‘ç»œã€‚ç½‘æ¡¥ä¹Ÿä¸èƒ½ç”¨äºåœ¨å¤§å‹ç½‘ç»œï¼ˆæ¯”å¦‚Internetï¼‰ä¸Šå®ç°æ•°æ®è½¬å‘çš„IPè·¯ç”±å’Œä¼ è¾“æ–¹æ¡ˆã€‚</p><p><strong>9.6.2 HUB</strong><br>&emsp;&emsp;ä»¥å¤ªç½‘å‡ºç°çš„æ—©æœŸï¼Œå¤§å¤šæ•°ç½‘ç»œçš„è¿æ¥æ–¹å¼æ˜¯ç”¨ä¸€æ¡è¿ç»­çš„åŒè½´ç”µç¼†æŠŠè®¡ç®—æœºè¿æ¥èµ·æ¥ï¼Œç„¶è€Œï¼Œéšåå‡ å¹´ï¼Œå·¥ç¨‹å¸ˆçœ‹åˆ°äº†ä½¿ç”¨ä¸­å¿ƒè®¾å¤‡å°†è®¡ç®—æœºè¿æ¥åœ¨ä¸€èµ·æ‰€å…·æœ‰çš„ä¼˜åŠ¿ï¼ˆå›¾9.15ï¼‰ã€‚<br>&emsp;&emsp;åœ¨ç¬¬3ç« è®²è¿‡ï¼Œç»å…¸çš„ä»¥å¤ªç½‘æ¦‚å¿µæ˜¯è®©å…¨éƒ¨è®¡ç®—æœºå…±äº«ä¼ è¾“ä»‹è´¨ã€‚æ¯æ¬¡ä¼ è¾“éƒ½ä¼šè¢«å…¨éƒ¨ç½‘ç»œé€‚é…å™¨ç›‘å¬ã€‚ä»¥å¤ªç½‘HUBä½œä¸ºä¸€ä¸ªç‰©ç†è®¾å¤‡<code>ä»ä¸€ä¸ªç«¯å£æ¥æ”¶æ•°æ®ï¼Œç„¶åæŠŠæ•°æ®é‡å¤åˆ°åŒºåŸŸå…¨éƒ¨ç«¯å£</code>(è§å›¾9.15)ã€‚æ¢å¥è¯è¯´ï¼Œå…¨éƒ¨è®¡ç®—æœºéƒ½å¥½åƒæ˜¯è¢«ä¸€æ¡è¿ç»­çº¿è·¯è¿æ¥åœ¨ä¸€èµ·çš„ã€‚HUBä¸ä¼šè¿‡æ¥æˆ–è·¯ç”±ä»»ä½•æ•°æ®ï¼Œåªæ˜¯æ¥æ”¶å’Œé‡æ–°å‘é€ä¿¡å·ã€‚<br>&emsp;&emsp;æ™ºèƒ½HUBï¼Œæ¯”å¦‚æ£€æµ‹çº¿è·¯æ•…éšœå’Œå…³é—­ç«¯å£ã€‚ç›®å‰HUBåŸºæœ¬ä¸Šå·²ç»è¢«äº¤æ¢æœºå–ä»£äº†ã€‚<br><strong>9.3 äº¤æ¢æœº</strong><br>&emsp;&emsp;åŸºäºHUBçš„ä»¥å¤ªç½‘ï¼Œä»ç„¶é¢ä¸´ä¼ ç»Ÿä»¥å¤ªç½‘çš„é—®é¢˜ï¼šæ€§èƒ½å²æµé‡çš„ä¸Šå‡è€Œä¸‹é™ã€‚åªæœ‰å½“çº¿è·¯ç©ºé—²æ—¶ï¼Œè®¡ç®—æœºæ‰èƒ½è¿›è¡Œä¼ è¾“ã€‚è€Œä¸”æ¯ä¸ªç½‘ç»œé€‚é…å™¨éƒ½å¿…é¡»æ¥å—å’Œå¤„ç†ç½‘ç»œä¸Šçš„æ¯ä¸ªå¸§ã€‚ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜æ¯”HUBæ›´æ™ºèƒ½çš„è®¾å¤‡â€”äº¤æ¢æœºâ€”å‡ºç°äº†ã€‚åœ¨å…¶æœ€åŸºæœ¬å½¢å¼ä¸‹ï¼Œäº¤æ¢æœºç±»ä¼¼äºå›¾9.15ä¸­æ‰€ç¤ºçš„HUBï¼Œæ¯å°è®¡ç®—æœºä¹Ÿæ˜¯é€šè¿‡ä¸€æ¡çº¿è·¯è¿æ¥åˆ°äº¤æ¢æœºã€‚ä½†æ˜¯ï¼Œäº¤æ¢æœºçŸ¥é“åº”è¯¥æ¥æ”¶åˆ°å‘é€ç»™å“ªä¸ªç«¯å£ã€‚å¤§å¤šæ•°å«äº¤æ¢æœºæŠŠç«¯å£ä¸æ‰€è¿æ¥è®¾å¤‡å™¨çš„ç‰©ç†åœ°å€å…³è”èµ·æ¥ã€‚å½“ä¸€ä¸ªç«¯å£æ‰€è¿æ¥çš„è®¡ç®—æœºå‘é€æ•°æ®å¸§æ—¶ï¼Œäº¤æ¢æœºä¼šæŸ¥çœ‹å¸§çš„ç›®çš„åœ°å€ã€‚æŠŠå¸§å‘é€ç»™ä¸ç›®çš„åœ°å€ç›¸å…³è”çš„ç«¯å£ã€‚æ¢å¥è¯è¯´ï¼Œäº¤æ¢æœºåªå‘åº”è¯¥æ¥æ”¶æ•°æ®çš„é€‚é…å™¨å‘é€æ•°æ®å¸§ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ¯ä¸ªé€‚é…å™¨å°±ä¸éœ€æŸ¥çœ‹ç½‘ç»œä¸Šä¼ è¾“çš„å…¨éƒ¨å¸§ã€‚å› æ­¤äº¤æ¢æœºå‡å°‘äº†å¤šä½™çš„ä¼ è¾“ã€‚ä»è€Œæ”¹å–„äº†ç½‘ç»œæ€§èƒ½ã€‚</p><p>&emsp;&emsp;æ³¨æ„ï¼Œå‰é¢æè¿°çš„1ç±»äº¤æ¢æœºåˆ¶æ“ä½œç‰©ç†åœ°å€ï¼Œä¸å¤„ç†IPåœ°å€ã€‚äº¤æ¢æœºä¸æ˜¯è·¯ç”±å™¨ï¼Œå®é™…ä¸Šä»–æ›´åƒç½‘æ¡¥ï¼Œå‡†ç¡®åœ°è¯´åƒå¤šä¸ªç½‘æ¡¥ç»“åˆåœ¨ä¸€èµ·ã€‚äº¤æ¢æœºå¯¹æ¯ä¸ªç½‘ç»œè¿æ¥è¿›è¡Œéš”ç¦»ï¼Œä»è€Œåªè®©é’ˆå¯¹ç‰¹å®šè®¡ç®—æœºçš„æ•°æ®è¿›è¡Œç‰¹å®šçº¿è·¯ï¼ˆå›¾9.17ï¼‰ã€‚<br>&emsp;&emsp;ç°åœ¨çš„äº¤æ¢æ–¹å¼æœ‰å¤šç§ï¼Œæœ€å¸¸è§çš„ä¸¤ç§äº¤æ¢æ–¹æ³•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><blockquote><p><strong>ç›´é€šå¼ï¼š</strong>äº¤æ¢æœºä¸€è·å¾—ç›®çš„åœ°å€å°±è½¬å‘å¸§ã€‚<br><strong>å­˜å‚¨è½¬å‘ï¼š</strong>å«æ··è¿¹åœ¨è½¬å‘ä¹‹å‰æ¥æ”¶æ•´ä¸ªå¸§ã€‚è¿™ç§æ³•æ³•ä¼šå‡ç¼“è½¬å‘è¿‡ç¨‹ï¼Œä½†æœ‰æ—¶å¯ä»¥æ”¹å–„æ•´ä½“æ€§èƒ½ã€‚å› ä¸ºå¯ä»¥è¿‡æ»¤å‡ºç¢ç‰‡å’Œå…¶ä»–æ— æ•ˆçš„å¸§ã€‚</p></blockquote><p>&emsp;&emsp;äº¤æ¢æœºåœ¨ä»Šå¹´æ¥å˜å¾—éå¸¸æµè¡Œã€‚å…¬å¸å±€åŸŸç½‘é€šå¸¸ä¼šä½¿ç”¨åˆ†å±‚å¼çš„äº¤æ¢æœºå’Œäº’è¿å¼çš„äº¤æ¢æœºæ¥ä¼˜åŒ–æ€§èƒ½ã€‚</p><p><strong>æ³¨æ„ï¼š</strong>äº¤æ¢æœºå’Œåˆ†å±‚</p><blockquote><p>&emsp;&emsp;å‚å•†ç°åœ¨æŠŠå‰é¢ä»‹ç»è¿™ç§åŸºç¡€äº¤æ¢æœºæ¦‚å¿µçœ‹åšæ˜¯ä¸€ä¸ªæ›´å¤§ç±»åˆ«äº¤æ¢è®¾å¤‡çš„ä¿„è¯‘ä¸­ç‰¹ä¾‹ã€‚æ›´è´Ÿè´£çš„äº¤æ¢æœºå·¥ä½œäºæ›´é«˜çš„åè®®å±‚ï¼Œèƒ½å¤Ÿæ ¹æ®å„ç§å‚æ•°å†³å®šå¦‚ä½•è½¬å‘ã€‚æ›´å¤æ‚çš„äº¤æ¢æœºå·¥ä½œäºæ›´é«˜çš„åè®®å±‚ï¼Œèƒ½å¤Ÿæ ¹æ®å„ç§å‚æ•°å†³å®šå¦‚ä½•è½¬å‘ï¼Œè½½è¿™ç§æ›´é€šç”¨çš„äº¤æ¢æ–¹æ³•ä¸­ï¼Œè®¾å¤‡æ ¹æ®å…¶å·¥ä½œçš„OSIåè®®å±‚è¿›è¡Œåˆ†ç±»ã€‚å‰é¢ä»‹ç»çš„åŸºæœ¬äº¤æ¢æœºå·¥ä½œäºOSIæ¨¡å‹çš„æ•°æ®é“¾è·¯å±‚ï¼Œè¢«ç§°ä¸ºç¬¬2å±‚äº¤æ¢æœºã€‚æ ¹æ®IPåœ°è´¨ä¿¡æ¯è¿›è¡Œè½¬å‘çš„äº¤æ¢æœºå·¥ä½œäºOSIæ¨¡å‹çš„æ•°æ®é“¾è·¯å±‚ï¼Œè¢«ç§°ä¸ºç¬¬2å±‚äº¤æ¢æœºã€‚æ ¹æ®IPåœ°è´¨ä¿¡æ¯è¿›è¡Œè½¬å‘çš„é¢äº¤æ¢æœºå·¥ä½œäºOSIæ¨¡å‹çš„ç½‘ç»œå±‚ï¼Œè¢«ç§°ä¸ºç¬¬3å±‚äº¤æ¢æœºï¼ˆæ˜¾ç„¶ï¼Œç¬¬3å±‚äº¤æ¢åŸºç¡€ä¸Šå°±æ˜¯æŸç§è·¯ç”±å™¨ï¼‰å¦‚æœæœ¬èŠ‚æ²¡æœ‰æ˜ç¡®è¯´æ˜äº¤æ¢æœºæ˜¯å·¥ä½œäºå“ªä¸€å±‚çš„ï¼Œå®ƒä¸€èˆ¬å°±æ˜¯å·¥ä½œäºç¬¬2å±‚çš„ï¼Œæ ¹æ®ç‰©ç†ï¼ˆMACï¼‰åœ°å€è¿›è¡Œè¿‡æ»¤ã€‚</p></blockquote><h2 id="ç¬¬10ç« -åç§°è§£æ"><a href="#ç¬¬10ç« -åç§°è§£æ" class="headerlink" title="ç¬¬10ç«  åç§°è§£æ"></a><strong>ç¬¬10ç«  åç§°è§£æ</strong></h2><p>&emsp;&emsp;æœ€åˆçš„åç§°è§£ææ˜¯åœ¨æ¯å°ä¸»æœºä¸Šä¿å­˜ä¸€ä»½hostæˆ–host.txtæ•°æ®è¡¨ã€‚éœ€è¦æ‰‹åŠ¨æ›´æ–°ï¼Œæ¯”è¾ƒè´Ÿè´£ã€‚ä¹‹åå‡ºç°DNSæœåŠ¡å™¨ï¼Œæ‰€æœ‰çš„åç§°ç”±ä¸“é—¨çš„DNSæœåŠ¡å™¨ï¼Œè¿›è¡Œè§£æåç§°ï¼ŒDNSæœåŠ¡å™¨å¹¶ä¸”è¿›è¡Œåˆ†å±‚ã€‚å¦å¤–DNSåç§°ç©ºé—´æ˜¯ä¸ªå¤šæ¬¡æ’åºçš„åŸŸåï¼ˆå›¾10.4ï¼‰ã€‚TLD(Top Level Domain)é¡¶çº§åŸŸåï¼Œæ˜¯ä¸–ç•Œä¸Šæœ€è‘—åçš„DNSåç§°ç©ºé—´ã€‚åŸŸåå¯ä»¥åŒ…å«ä¸»æœºå,è¿™ç§åŸŸåè¢«åƒå‘¢æ”¹ä¸ºå®Œå…¨é™å®šåŸŸåï¼ˆFQDNï¼‰ã€‚<br>&emsp;&emsp;NetBIOS Microsoftç½‘ç»œä¸­å¸¸ç”¨çš„åç§°è§£æç³»ç»Ÿã€‚<br>&emsp;&emsp;DNSå®ç°ï¼ŒDNSå¿…é¡»è¢«å®ç°ä¸ºæœåŠ¡æˆ–åå°ç¨‹åºã€‚WindowsæœåŠ¡å™¨è‡ªå¸¦ä¸€ä¸ªDNSæœåŠ¡ï¼Œå½“ç„¶ï¼Œæœ‰äº›ç®¡ç†å‘˜ä¼šå€¾å‘äºä½¿ç”¨ç¬¬ä¸‰æ–¹çš„DNSå®ç°ã€‚åœ¨UNIX/Linuxä¸Šåˆ™å¾ˆå¤šDNSå®ç°ï¼Œå…¶ä¸­æœ€é•¿ç”¨çš„Berkeley Internet Name Domain(BIND)ã€‚</p><p><strong>DNSå®‰å…¨æ‰©å±•ï¼ˆDNNSECï¼‰</strong><br>&emsp;&emsp;DNSæ•°æ®æ˜¯å…¬å…±çš„ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®‰å…¨å‹ä¸åœ¨æ„å‘³ç€ç§å¯†æ€§ã€‚ä½†æ˜¯å®¢æˆ·ç«¯ä»ç„¶éœ€è¦ä¸€äº›æ–¹æ³•æ¥ç¡®ä¿å¯¹DNSè¯·æ±‚çš„<code>ç­”å¤æ˜¯æ¥è‡ªäºçœŸå®çš„DNSæœåŠ¡å™¨</code>,è€Œä¸”è¿™ä¸ªæœåŠ¡å™¨åº”è¯¥ç”±åŒºåŸŸè¿›è¡Œç›‘ç®¡ã€‚æ”»å‡»è€…å·²ç»å¼€å‘äº†é›†ä¸­æŠ€æœ¯æ¥é’ˆå¯¹DNSæŸ¥è¯¢å‘é€ä¼ªé€ çš„å“åº”ã€‚æˆªè·äº†DNSè¯·æ±‚çš„æ”»å‡»è€…å¯ä»¥å‘é€ä¼ªé€ çš„å“åº”ï¼Œå°†å¯çŸ­ç«¯é‡å®šå‘åˆ°ç§˜å¯†çš„DNSæœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨å……å½“å¯åŠ¨æ”»å‡»çš„ä¸€ç§æ‰‹æ®µã€‚åªæ˜¯ä¼ªé€ çš„å›å¤å…ˆäºçœŸæ˜¯çš„å›å¤è¾¾åˆ°DNSå®¢æˆ·ç«¯ï¼Œåˆ™è¯¥å®¢æˆ·ç«¯å°±è½å…¥äº†åœˆå¥—ã€‚è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆæ˜¯æä¾›ä¸€ç§æ–¹å¼æ¥<code>éªŒè¯è¿”å›çš„DNSæ•°æ®æºçš„æœ‰æ•ˆæ€§</code>ã€‚DNSå®‰å…¨æ‰©å±•ï¼ˆDNSSECï¼‰æä¾›äº†éªŒè¯DNSæ•°æ®æœ‰æ•ˆæ€§çš„ç³»ç»Ÿï¼Œå¦‚ä»Šå¾ˆå¤šæ“ä½œç³»ç»Ÿéƒ½æä¾›äº†DNSSECé€‰é¡¹ï¼Œä½†æ˜¯è¯¥DNSSECä»ç„¶æ²¡æœ‰å¤§èŒƒå›´çš„å®ç°ã€‚ä½†æ˜¯æœ‰äº›é«˜æ€§èƒ½ï¼ˆhigh-profileï¼‰çš„åŸŸå·²ç»å…¨é¢æ”¯æŒDNSSECï¼Œæ˜¯çš„DNSSECæ…¢æ…¢è¢«å…¬ä¼—æ‰€æ¥æ”¶ã€‚DNSSECä½¿ç”¨<code>åŠ å¯†å¯†é’¥</code>å’Œ<code>æ•°å­—ç­¾å</code>æ¥æä¾›å®‰å…¨ã€‚è¯¦è§ï¼ˆç¬¬11ç« ï¼‰ã€‚DNSSECéœ€è¦æ”¯æŒDNSæ‰©å±•æœºåˆ¶ï¼ˆEDNSï¼‰ã€‚ENDSçš„DOæŠ¥å¤´ä½è¡¨ç¤ºä¸€ä¸ªDNSSECæŸ¥è¯¢ã€‚<br>&emsp;&emsp;DNSSECæ·»åŠ äº†ä¸€ä¸ªéªŒè¯è¿‡ç¨‹æ¥ç¡®ä¿DNSæŸ¥è¯¢çš„ç»“æœæ˜¯å¯ä¿¡çš„ã€‚ä¸åŸºæœ¬çš„DNSåç§°è§£æè¿‡ç¨‹ç›¸ä¼¼ï¼ŒDNSSECä»ä¸€ç³»åˆ—æ­¥éª¤åˆ°è¾¾ä¸ç»™å®šæŸ¥è¯¢ä¸­çš„åç§°ç›¸å…³è”çš„åŒºåŸŸã€‚ä½†æ˜¯DNSSECå¢åŠ äº†ä¸€ä¸ªä¿¡ä»»é“¾(chain-of-trust)ç±»å‹çš„éªŒè¯ï¼Œå…¶ç†å¿µæ˜¯<code>ä»ä¸€ä¸ªå—ä¿¡ä»»çš„æ¥æ—¶ï¼Œå°†çƒçƒæ²¿ç€ä¸€ç³»åˆ—ä¸€ç›´çš„å’ŒéªŒè¯è¿‡çš„æ­¥éª¤å‘ä¸‹ä¼ è¾“ï¼Œç›´åˆ°åˆ°è¾¾è¿™æ ·ä¸€ä¸ªæœåŠ¡å™¨ï¼›è¯¥æœåŠ¡å™¨æ‹¥æœ‰ä¸€ä¸ªç”¨ç”¨æ¥éªŒè¯DNSæ•°æ®æ¥æºçš„ç­¾åã€‚</code>ä¸ºäº†å®ç°è¯¥ç›®æ ‡ï¼ŒDNSSECæ·»åŠ äº†4ä¸ªæ–°çš„NDSèµ„æºè®°å½•ç±»å‹ã€‚</p><blockquote><p>DNSKEY: ç”¨æ¥ç­¾åå’ŒéªŒè¯DNSèµ„æºè®°å½•é›†çš„å…¬å…±å¯†é’¥ã€‚<br>DS:æŒ‡å‘ï¼ˆå¹¶éªŒè¯ï¼‰å­åŒºåŸŸDNSKEYçš„èµ„æºè®°å½•ã€‚</p></blockquote><p><strong>DNS å·¥å…·</strong><br>&emsp;&emsp;1.ä½¿ç”¨pingæ£€æŸ¥åç§°è§£æ<br>&emsp;&emsp;2.ä½¿ç”¨NSLookupæ£€æŸ¥åç§°è§£æ<br>ä½¿ç”¨NSLookupå·¥å…·æŸ¥è¯¢NDSæœåŠ¡å™¨ï¼ŒæŸ¥çœ‹èµ„æºè®°å½•ç­‰ä¿¡æ¯ã€‚åœ¨éœ€è¦å¯¹DNSé—®é¢˜è¿›è¡Œ<code>æ’é”™</code>æ—¶è¿™ä¸ªå·¥å…·ä¹Ÿååˆ†æœ‰ç”¨ï¼ŒNSLookupå·¥å…·å¯ä»¥æŒ‰ç…§ä¸‹é¢ä¸¤ä¸ªæ¨¡å¼è¿›è¡Œæ“ä½œã€‚</p><blockquote><p><strong>æ‰¹å¤„ç†æ¨¡å¼ï¼š</strong>åœ¨å£æ©±é‡Œæ¨¡å¼ä¸­ï¼Œç”¨æˆ·å¯ä»¥å¯åŠ¨NSLookupæä¾›ä¸€äº›è¾“å…¥å‚æ•°ï¼ŒNSLookupä¼šæ ¹æ®å‚æ•°æ‰§è¡Œè¢«è¯·æ±‚çš„åŠŸèƒ½ï¼Œæ˜¾ç¤ºç»“æœï¼Œæœ€ç»ˆå…³é—­è‡ªå·±ã€‚<br><strong>äº¤äº’å¼æ¨¡å¼ï¼š</strong>åœ¨äº¤äº’å¼æ¨¡å¼ä¸‹ä¸­ï¼Œç”¨æˆ·å¯åŠ¨NSLookupæ—¶ä¸éœ€è¦æä¾›è¾“å…¥å‚æ•°ã€‚NSLookupä¼šæç¤ºç”¨æˆ·è¾“å…¥å‚æ•°ã€‚åœ¨ç”¨æˆ·è¾“å…¥å‚æ•°åï¼ŒNSLookupå°†æ‰§è¡Œè¢«è¯·æ±‚çš„æ“ä½œï¼Œæ˜¾ç¤ºç»“æ„å¹¶é‡æ–°è¿”å›æç¤ºç¬¦çŠ¶æ€ï¼Œç­‰å¾…æ¥ä¸‹æ¥è¢«è¾“å…¥çš„å‚æ•°ã€‚å¤§å¤šæ•°ç®¡ç†å‘˜éƒ½ä¼šä½¿ç”¨äº¤äº’å¼æ¨¡å¼ï¼Œè¿™æ˜¯å› ä¸ºåœ¨éœ€è¦æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œæ—¶ï¼Œè¿™ç§æ¨¡å¼æ›´æ–¹ä¾¿ã€‚</p></blockquote><p><strong>åŸŸåä¿¡æ¯æœç´¢(DIG)</strong><br>&emsp;&emsp;Linuxï¼ˆåœ¨æœåŠ¡å™¨æœºæˆ¿ä¸­å¾ˆå¸¸è§ï¼‰ä¸Šä¸€ä¸ªç•™å­¦çš„DNSå‘½ä»¤å·¥å…·æ˜¯åŸŸåä¿¡æ¯æœç´¢ï¼ˆDomain Information Groperï¼ŒDIGï¼‰è®¸å¤šç®¡ç†å‘˜è®¤ä¸ºDIGè¦æ¯”NSLookupæ›´çµæ´»ã€‚ï¼ˆdig ï¼‰</p><p><strong>åŠ¨æ€DNS</strong>ï¼š<br>&emsp;&emsp;ä¸Šè¿°æ‰€ä»‹ç»çš„DNSéƒ½æ˜¯ç”¨äºä¸»æœºåå’ŒIPåœ°å€æ°¸ä¹…ï¼ˆåŠæ°¸ä¹…ï¼‰å…³è”æƒ…å†µä¸‹ã€‚è®¡ç®—æœºæ¯æ¬¡å¯åŠ¨æ—¶ï¼ŒDHCPéƒ½ä¼šåˆ†é…ä¸€ä¸ªæ–°çš„IPåœ°å€ã€‚è¿™æ„å‘³ç€,DNSæœåŠ¡å™¨å¿…é¡»é€šè¿‡æŸç§æ³•æ³•è·æ‚‰è¯¥è®¡ç®—æœºæ­£åœ¨ä½¿ç”¨çš„IPåœ°å€ã€‚<br>&emsp;&emsp;ç”±äºåŠ¨æ€IPåœ°å€çš„é€æ¸æµè¡Œï¼ŒDNSå‚å•†å¿…é¡»åŠ ä»¥é€‚åº”ï¼Œç°åœ¨ï¼Œä¸€äº›IPå®ç°ï¼ˆåŒ…æ‹¬BINDï¼‰æä¾›äº†åŠ¨æ€æ›´æ–°DNSè®°å½•çš„åŠŸèƒ½ã€‚åœ¨å›¾10.9æ‰€ç¤ºå…¸å‹åœºæ™¯ä¸­ï¼Œä¸»æœºä»DHCPæœåŠ¡å™¨è·å¾—IPåœ°å€ï¼Œå¿…é¡»ä½¿ç”¨è¿™ä¸ªæ–°åœ°å€æ›´æ–°DNSæœåŠ¡å™¨ã€‚ï¼ˆDHCPè¯¦è§ç¬¬12ç« ï¼‰<br>&emsp;&emsp;ä¼ä¸šç›®å½•ç³»ç»Ÿï¼ˆæ¯”å¦‚Microsoftçš„æ´»åŠ¨ç›®å½•ï¼‰åœ¨ç›®å½•ç»“æ„ä¸­ä½¿ç”¨åŠ¨æ€DNSæ¥ç®¡ç†DHCPå®¢æˆ·ç«¯ç³»ç»Ÿã€‚æ‡‚å°DNSæœåŠ¡åœ¨Internetä¸Šä¹Ÿæ˜¯å¸¸è§ã€‚æœ‰äº›åœ¨çº¿æœåŠ¡æä¾›äº†ä¸€ç§æ–¹æ³•ï¼Œå¯ä»¥è®©ä½¿ç”¨åŠ¨æ€åœ°å€çš„è®¡ç®—æœºæ³¨å†Œä¸€ä¸ªæ°¸ä¹…çš„DNSåç§°ã€‚ç”¨æˆ·å¯ä»¥è®¿é—®è¿™äº›æœåŠ¡ï¼Œæ¥è¿œç¨‹è¿æ¥åˆ°ä½¿ç”¨DNSåç§°çš„å®¶åº­ç½‘ç»œä¸­ï¼Œæˆ–è€…æ˜¯è¿è¡Œæ²¡æœ‰é™æ€åœ°å€çš„ä¸ªäººç«™ç‚¹ã€‚<br><strong>æ³¨æ„ï¼š</strong> DNSæœåŠ¡å‘ç°</p><blockquote><p>&emsp;&emsp;DNSæœ€è¿‘çš„å¦å¤–ä¸€ä¸ªåˆ›æ–°æ˜¯DNSæœåŠ¡å‘ç°ï¼Œæœ‰å…³DNSæœåŠ¡å‘ç°çš„è¯¦æƒ…è§‰å…¶ä»–é›¶é…ç½®æŠ€æœ¯ä»‹ç»ï¼Œè¯¦è§12ç« ã€‚</p></blockquote><p><strong>NetBIOSåç§°è§£æ</strong><br>&emsp;&emsp;NetBIOSæ˜¯ä¸€ä¸ªAPIå’Œåç§°è§£æç³»ç»Ÿï¼Œæœ€åˆæ˜¯ç”±IBMå¼€å‘ï¼Œå¦‚ä»Šåœ¨Microsoftçš„Windowsç½‘ç»œä¸­å¾ˆå¸¸è§ã€‚NetBIOSè¢«å¼€å‘å‡ºæ¥çš„ç›®çš„æ˜¯å°†å…¶ç”¨äºä¸ä½¿ç”¨TCP/IPçš„ç½‘ç»œã€‚ï¼Œæµè¡Œå’ŒSambaæ–‡ä»¶æœåŠ¡å’Œå…¶ä»–ç‹¬ç«‹çš„å·¥å…·ä¹Ÿéƒ½æ”¯æŒNetBIOSåç§°è§£æã€‚<br>1.NetBIOSåç§°çš„è§£ææ–¹æ³•<br>&emsp;&emsp;åœ¨TCP/IPç½‘ç»œä¸Šï¼ŒNetBIOSåç§°å³ç³»çš„æœ€ç»ˆç›®çš„æ˜¯ä¸ºä¸€ä¸ªç»™å®šçš„NetBIOSåç§°æä¾›IPåœ°å€ã€‚<br>&emsp;&emsp;NetBIOSåç§°æ˜¯ç”±15ä¸ªå­—ç¬¦ç»„æˆçš„ã€‚ä¾‹å¦‚Workstation1ã€HBServerå’ŒCorpServerã€‚NetBIOSä¸å…è®¸åœ¨ç½‘ç»œä¸Šç”±é‡å¤çš„è®¡ç®—æœºåã€‚<br><strong>æ³¨æ„ï¼š</strong>NetBIOSåç§°</p><blockquote><p>&emsp;&emsp;ä»æŠ€æœ¯è§’åº¦è®²ï¼ŒNetBIOSåç§°ç”±16ä¸ªå­—ç¬¦ã€‚ä½†æ˜¯ï¼Œç¬¬16ä¸ªå­—ç¬¦æ˜¯ç”±åº•å±‚åº”ç”¨ç¨‹åºä½¿ç”¨çš„ï¼Œé€šå¸¸ä¸ç”¨ç”¨æˆ·ç›´æ¥é…ç½®ã€‚éšæ‰ˆçš„å†…å®¹å°†è®¨è®ºè¿™äº›å­—ç¬¦ã€‚</p></blockquote><p>&emsp;&emsp;NetBIOSåç§°ä¸ä¸»æœºåç±»ä¼¼ï¼Œæ²¡æœ‰å±‚æ¬¡ã€‚é›†ä¸­å°†NetBIOSåç§°è§£æä¸ºç›¸åº”IPåœ°å€çš„æ–¹æ³•ï¼š</p><blockquote><p>åŸºäºå¹¿æ’­çš„åç§°è§£æ<br>LMHostsæ–‡ä»¶åç§°è§£æ<br>WINSåç§°è§£æ</p></blockquote><p>ï¼ˆ1ï¼‰ã€åŸºäºå¹¿æ’­çš„åç§°è§£æ<br>&emsp;&emsp;NetBIOSåç§°è§£æå¯ä»¥é€šè¿‡å¹¿æ’­å®Œæˆã€‚è®¡ç®—æœºä¼šä½¿ç”¨å¹¿æ’­ä¸æœ¬ç½‘æ®µä¸­å…¶ä»–æ‰€æœ‰æœºå™¨è”ç³»ï¼Œè¦æ±‚è¿”å›ç‰¹å®šè®¡ç®—æœºçš„åœ°å€ã€‚ç½‘æ®µä¸Šçš„è®¡ç®—æœºç›‘å¬åˆ°å¹¿æ’­åï¼Œåªæœ‰æŒ‡å®šçš„è®¡ç®—æœºæ‰ä¼šå“åº”è¿™ä¸ªè¯·æ±‚ã€‚è¿™ç§åç§°è§£æçš„æ–¹æ³•è¢«ç§°ä¸ºB-Nodeåç§°è§£æã€‚å®ƒå¯ä»¥åœ¨LANç¯å¢ƒä¸­å¾ˆå¥½å·¥ä½œï¼Œä½†å¦‚æœç½‘ç»œä¸ä»…ä»…å±€é™äºLANï¼Œè¿™ç§æ–¹æ³•å°±æ— æ³•å·¥ä½œï¼ˆç”±äºè·¯ç”±å™¨ä¼šé˜»æ­¢å¹¿æ’­ä¼ é€’ï¼‰ã€‚<br>ï¼ˆ2ï¼‰ã€LMHostsæ–‡ä»¶åç§°è§£æ<br>&emsp;&emsp;Windowsç³»ç»Ÿè¿˜å¯ä»¥ä½¿ç”¨LMHostsæ–‡ä»¶å°†NetBIOSåç§°è§£ææˆIPåœ°å€ã€‚LMHostsæ–‡ä»¶ä¸ä¸»æœºæ–‡ä»¶å¾ˆç›¸ä¼¼ï¼Œä¼šå°†NetBIOSåç§°ä¸IPåœ°å€å…³è”ã€‚</p><h2 id="ç¬¬11ç« -TCP-IP-å®‰å…¨"><a href="#ç¬¬11ç« -TCP-IP-å®‰å…¨" class="headerlink" title="ç¬¬11ç«  TCP/IP å®‰å…¨"></a><strong>ç¬¬11ç«  TCP/IP å®‰å…¨</strong></h2><h5 id="1-ä»€ä¹ˆæ˜¯é˜²ç«å¢™"><a href="#1-ä»€ä¹ˆæ˜¯é˜²ç«å¢™" class="headerlink" title="1. ä»€ä¹ˆæ˜¯é˜²ç«å¢™"></a><strong>1. ä»€ä¹ˆæ˜¯é˜²ç«å¢™</strong></h5><p>&emsp;&emsp;æ—©æœŸçš„é˜²ç«å¢™åªæ˜¯åŒ…è¿‡æ»¤ï¼Œè®¸å¤šåŒ…è¿‡æ»¤é˜²ç«å¢™ä¼šæŸ¥çœ‹å°è£…åœ¨ä¼ è¾“å±‚æŠ¥å¤´ä¸­çš„TCPå’ŒUDPç«¯å£å·ã€‚å› ä¸ºå¤§å¤šæ•°InternetæœåŠ¡éƒ½ä¸ç«¯å£å·ç›¸å…³è”ï¼Œå› æ­¤é€šè¿‡æ£€æŸ¥æ•°æ®åŒ…çš„ç›®çš„ç«¯å£å·å¯ä»¥ç¡®å®šæ•°æ®åŒ…çš„ä¼å›¾ã€‚è¿™ç§å½¢å¼çš„æ•°æ®åŒ…è¿‡æ»¤å¯ä»¥è®©ç®¡ç†å‘˜å£°ç§°â€œå¤–éƒ¨çš„å®¢æˆ·ç«¯æ— æ³•è®¿é—®å†…éƒ¨å¾€æ¥ä¸Šçš„TelnetæœåŠ¡â€ã€‚å­˜åœ¨é—®é¢˜ï¼Œç«¯å£é‡ç½®é…ç½®<br>&emsp;&emsp;åœ¨é˜²ç«å¢™çš„è¿›åŒ–è¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº†å¦å¤–ä¸€ç§ç§°ä¹‹ä¸ºæœ‰çŠ¶æ€é˜²ç«å¢™çš„è®¾å¤‡ã€‚æœ‰çŠ¶æ€é˜²ç«å¢™ä¸ä»…ä»…æ˜¯å•ç‹¬ä»·å·®æ¯ä¸€ä¸ªæ•°æ®åŒ…ï¼Œè¿˜ä¼šæ£€æŸ¥æ•°æ®åŒ…åŒ…å«åœ¨å“ªä¸ªé€šä¿¡ä¼šè¯æ–°åºåˆ—ä¸­ã€‚è¿™ç§çŠ¶æ€æ•æ„Ÿæ€§æœ‰åŠ©äºæœ‰çŠ¶æ€é˜²ç«å¢™ç›‘è§†è¯¸å¦‚æ— æ•ˆæ•°æ®åŒ…ã€ä¼šè¯åŠ«æŒä¼å›¾ï¼Œä»¥åŠæŸäº›æ‹’ç»æœåŠ¡æ”»å‡»è¿™æ ·çš„æ”»å‡»æ‰‹æ®µã€‚<br>&emsp;&emsp;åº”ç”¨å±‚é˜²ç«å¢™æ˜¯æœ€æ–°ä¸€ä»£é˜²ç«å¢™ã€‚åœ¨TCP/IPåº”ç”¨å±‚ã€‚å¯ä»¥æ›´å…¨é¢åœ°ç†è§£ä¸åè®®å’ŒæœåŠ¡ç›¸å…³è”çš„æ•°æ®æŠ¥ã€‚</p><p><strong>DMZ</strong><br>&emsp;&emsp;é˜²ç«å¢™ä¸ºå†…éƒ¨ç½‘ç»œæä¾›äº†ä¸€ç§å—ä¿æŠ¤çš„ç©ºé—´ï¼Œæ˜¯ç½‘ç»œå¾ˆéš¾ä»å¤–éƒ¨è¿›è¡Œè®¿é—®ï¼Œè¿™ä¸ªæ¦‚å¿µå¯¹äºWebå®¢æˆ·ç«¯å·¥ä½œç»„ï¼ˆå…¶ä¸­åŒ…å«çƒ§å½•æ»¡è¶³å†…éƒ¨éœ€è¦çš„æ–‡ä»¶æœåŠ¡å™¨ï¼‰æ˜¯å¾ˆé€‚åˆçš„ã€‚ä¸è¿‡åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œä¸€ä¸ªå…¬å¸é€šå¸¸ä¸ä¼šç¦æ­¢å¤–éƒ¨ç½‘ç»œè®¿é—®è‡ªå·±çš„æ‰€æœ‰èµ„æºã€‚ä¾‹å¦‚ï¼Œéœ€è¦ä»å¤–éƒ¨è®¿é—®å…¬å…±WebæœåŠ¡å™¨ï¼Œè®¸å¤šå…¬å¸è¿˜å®‰è£…äº†FTPæœåŠ¡å™¨ã€E-mailæœåŠ¡å™¨å’Œå…¶ä»–éœ€è¦ä»Internetè®¿é—®çš„ç³»ç»Ÿã€‚å°½ç®¡ä»ç†è®ºä¸Šè®²ï¼Œåªè¦å¼€å‘é˜²ç«å¢™çš„ç«¯å£å°±å¯ä»¥å…è®¸å¤–éƒ¨å®¢æˆ·è®¿é—®ç‰¹å®šç³»ç»Ÿä¸Šçš„ç‰¹å®šæœåŠ¡ï¼Œä½†æ˜¯ï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´ï¼ŒæœåŠ¡å™¨å¯ä»¥ä»å¤–éƒ¨è¿›è¡Œæ“ä½œï¼Œå…¶ç»“æœæ˜¯å¯¼è‡´ä¸€ç³»åˆ—ç½‘ç»œç®¡ç†å‘˜ä¸å¸Œæœ›çœ‹åˆ°çš„æµé‡å’Œå®‰å…¨å‹é—®é¢˜ã€‚<br>&emsp;&emsp;ä¸€ç§æ–¹æ³•æ˜¯å°†æœåŠ¡å™¨æ”¾åœ¨é˜²ç«å¢™ä¹‹å¤–ï¼ˆInternetâ€”-æœåŠ¡å™¨â€”-é˜²ç«å¢™ï¼‰ï¼ˆå›¾11.2ï¼‰ã€‚ä½¿ä¹‹ä¸å†…éƒ¨ç½‘ç»œçš„å®¢æˆ·ç«¯éš”ç¦»ã€‚å¦å¤–æ›¿æ¢æ–¹æ¡ˆï¼ˆç›¸å¯¹äºå›¾11.2æ‰€ç¤ºæ–¹æ¡ˆï¼‰å›¾11.3ã€‚ä½¿ç”¨ä¸¤ä¸ªé˜²ç«å¢™ã€‚å¦ä¸ªé˜²ç«å¢™ä¹‹å‰çš„ç©ºé—´è¢«ç§°ä¸ºDMZ(ä¸€ç§å†›äº‹æœ¯è¯­â€”-Demilitarized Zoneéå†›äº‹åœ°å¸¦)ã€‚ä¸å¼€æ”¾çš„Internetç›¸æ¯”ï¼ŒDMZå¯èƒ½æä¾›æ›´å¥½çš„å®‰å…¨æ€§ï¼Œä½†æ˜¯å…¶å®‰å…¨æ€§æ¯”å†…éƒ¨ç½‘ç»œä½<br>&emsp;&emsp;å›¾11.3æ‰€ç¤ºçš„åœºæ™¯è¿˜å¯èƒ½å‡ºç°ä¸‹é¢çš„æƒ…å†µï¼›åªä½¿ç”¨ä¸€ä¸ªèƒ½å¤Ÿè¿æ¥å¤šä¸ªç½‘æ®µä¸­çš„é˜²ç«å¢™ï¼Œå¦‚å›¾11.4æ‰€ç¤ºï¼Œå¦‚æœé˜²ç«å¢™/è·¯ç”±å™¨æœ‰3ä¸ªæˆ–æ›´å¤šçš„æ¥å£ï¼Œå¯ä»¥å°†å†…éƒ¨ç½‘ç»œå’ŒDMZåˆ†åˆ«è¿æ¥åˆ°è¿™äº›æ¥å£ä¸Šï¼ŒåŒæ—¶ä¸ºæ¯ä¸ªæ¥å£åº”ç”¨ä¸åŒçš„è¿‡æ»¤è§„åˆ™ã€‚</p><p><strong>é˜²ç«å¢™è§„åˆ™</strong><br>&emsp;&emsp;é€šå¸¸å…è®¸ç½‘ç»œç®¡ç†å‘˜åˆ›å»ºçš„å†…å®¹åŒ…æ‹¬ï¼š</p><blockquote><p>èµ„æºåœ°å€æˆ–åœ°å€èŒƒå›´<br>ç›®çš„åœ°å€èŒƒå›´<br>æœåŠ¡<br>è¡Œä¸º</p></blockquote><p>è¿™äº›å‚æ•°æä¾›äº†å¤§é‡é€‰é¡¹ï¼Œç”¨æˆ·å¯ä»¥å…³é—­æ‰€æœ‰æ¥è‡ªè·å–ç½‘ç‰¹å®šåœ°å€èŒƒå›´çš„æµé‡ã€‚å¯ä»¥å…³é—­æ¥è‡ªäºç‰¹å®šåœ°å€çš„ç‰¹å®šæœåŠ¡ï¼Œä¾‹å¦‚Telnetæˆ–FTPã€‚</p><p><strong>ä»£ç†æœåŠ¡</strong><br>&emsp;&emsp;æ‰€æœ‰ç”¨æ¥ä¿æŠ¤å’Œç®€åŒ–å†…éƒ¨ç½‘ç»œï¼Œå°†æ½œåœ¨ä¸å®‰å…¨Internetæ´»åŠ¨é™åˆ¶åœ¨è¾¹ç•Œä¹‹å¤–çš„æŠ€æœ¯ä¸­å¿ƒï¼Œé˜²ç«å¢™æ˜¯æ ¸å¿ƒæŠ€æœ¯ã€‚å¦ä¸€ç§ç›¸å…³çš„æŠ€æœ¯æ˜¯<code>ä»£ç†æœåŠ¡</code>ã€‚ä»£ç†æœåŠ¡å™¨å¯ä»¥æ¥è´§å¯¹Internetèµ„æºçš„è¯·æ±‚ï¼Œå¹¶æ›¿æ¢å®¢æˆ·ç«¯è½¬å‘è¿™äº›è¯·æ±‚ï¼Œå®ƒåœ¨å®¢æˆ·ç«¯å’Œè¯·æ±‚ç›®çš„çš„æœåŠ¡å™¨ä¹‹é—´æ‰®æ¼”äº†ä¸€ä¸ªä¸­ä»‹çš„è§’è‰²ï¼ˆå›¾11.6ï¼‰ã€‚å°½ç®¡ä»£ç†æœåŠ¡å™¨ä¸è¶³ä»¥é€šè¿‡è‡ªå·±åŒ…å«ç½‘ç»œï¼Œä½†æ˜¯å®ƒé€šå¸¸è¢«ç”¨äºä¸é˜²ç«å¢™è”åˆä½¿ç”¨ï¼ˆå°¤å…¶æ˜¯åœ¨ç½‘ç»œåœ°å€è½¬æ¢ç¯å¢ƒä¸­ï¼‰ã€‚<br>&emsp;&emsp;ä»£ç†æœåŠ¡å™¨å¯ä»¥ä½¿å¾—å®¢æˆ·ç«¯å…äºç›´æ¥ä¸æ¶æ„ç½‘ç«™è”ç³»ã€‚ä¸€äº›ä»£ç†è¿˜å¯ä»¥æ‰§è¡Œ<code>å†…å®¹è¿‡æ»¤</code>ã€‚æŸ¥çœ‹ä¿¡æ¯æ˜¯å¦æ¥è‡ªäº<code>é»‘åå•çš„æœåŠ¡å™¨</code>ï¼Œæˆ–è€…å†…å®¹æ˜¯å¦å¸¦æœ‰æ½œåœ¨çš„å±é™©ã€‚ä»£ç†æœåŠ¡å™¨è¿˜å¸¸è¢«ç”¨æ¥<code>é™åˆ¶</code>å†…éƒ¨ç½‘ç»œå®¢æˆ·ç«¯çš„<code>æµè§ˆèŒƒå›´</code>ã€‚<br>&emsp;&emsp;åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œä½¿ç”¨ä»£ç†æœåŠ¡å™¨çš„ä¸»è¦ç›®çš„æ˜¯<code>æ€§èƒ½</code>ï¼Œè€Œéå®‰å…¨æ€§ã€‚ä»£ç†æœåŠ¡å™¨è¿˜å¯ä»¥æ‰§è¡Œå¯¹æœåŠ¡å™¨çš„<code>å†…å®¹ç¼“å­˜</code>ã€‚å†…å®¹ç¼“å­˜ä»£ç†æœåŠ¡å™¨ä¼šä¿å­˜è¢«è®¿é—®è¿‡ç½‘é¡µçš„æ‹·è´ã€‚å¯¹è¿™äº›ç½‘é¡µçš„å†æ¬¡è¯·æ±‚å°†ç›´æ¥ç”¨æœ¬åœ°æ‹·è´å“åº”ã€‚</p><p><strong>é€†å‘ä»£ç†</strong><br>&emsp;&emsp;ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ä»£ç†æœåŠ¡å™¨ï¼ˆåœ¨ä¸€èŠ‚ä¸­æè¿°ï¼‰ä»£ç†çš„æ˜¯å¯¹å‘å¤–å‘é€åˆ°Internetä¸Šçš„è¯·æ±‚ã€‚å¦ä¸€ç§å½¢å¼çš„ä»£ç†æœåŠ¡å™¨è¢«ç§°ä¸º<code>é€†å‘ä»£ç†</code>ï¼Œå®ƒæ¥æ”¶æ¥è‡ªå¤–éƒ¨èµ„æºè¯·æ±‚ï¼Œå°†è¿™äº›è¯·æ±‚è½¬å‘ç»™å†…éƒ¨ç½‘ç»œã€‚ä¸å¸¸è§„ä»£ç†æœåŠ¡å™¨ç›¸åŒï¼Œé€†å‘ä»£ç†ä¹Ÿæä¾›ç¼“å­˜å’Œå†…å®¹è¿‡æ»¤ç‰¹æ€§ã€‚å› ä¸ºé€†å‘ä»£ç†ä¸»è¦ç”¨äº<code>ä¿è¯</code>è®¡ç®—æœºèƒ½å¤Ÿåœ¨<code>Internetä¸Šæä¾›æœåŠ¡</code>ï¼Œå› æ­¤<code>å®‰å…¨æ€§</code>ç‰¹åˆ«é‡è¦ã€‚</p><h4 id="2-æ”»å‡»æŠ€æœ¯"><a href="#2-æ”»å‡»æŠ€æœ¯" class="headerlink" title="2. æ”»å‡»æŠ€æœ¯"></a><strong>2. æ”»å‡»æŠ€æœ¯</strong></h4><p>&emsp;&emsp;æœ‰è‹¥å¹²ä¸ªæ–¹æ³•æ¥è·å¾—å…¥å£å’Œå–å¾—è¶³å¤Ÿçš„æƒé™ï¼Œå°½ç®¡ä¸å¯èƒ½æè¿°å…¨å®ƒä»¬ï¼Œä½†æ˜¯å¯ä»¥æŠŠè¿™äº›æŠ€æœ¯åˆ†ä¸º3ä¸ªåŸºæœ¬çš„ç±»åˆ«ã€‚</p><blockquote><p>&emsp;&emsp;<strong>è¯ä¹¦æ”»å‡»ï¼š</strong>è¿™äº›é«˜æ”»å‡»é›†ä¸­åœ¨è·å¾—è¯ä¹¦ä»¥æ­£å¸¸è¿›å…¥ç³»ç»Ÿã€‚åœ¨æœ¬è´¨ä¸Šï¼Œè¿™äº›æ”»å‡»ç”šè‡³å‘ç”Ÿåœ¨å…¥ä¾µè€…æ¸—å…¥å®‰å…¨ç³»ç»Ÿä¹‹å‰ã€‚è¿™ä¸€æŠ€æœ¯ çš„ä¸€ç§å˜å‹æ˜¯æƒé™æå‡ï¼Œå³æ”»å‡»è€…å…ˆè·å¾—ä½çº§åˆ«çš„è®¿é—®æƒï¼Œç„¶åå†è®¾æ³•è·å¾—æ›´é«˜çš„æƒé™çº§åˆ«ã€‚<br>&emsp;&emsp;<strong>ç½‘ç»œå±‚æ”»å‡»ï¼š</strong>æ”»å‡»è€…é€šè¿‡æ‰¾åˆ°ä¸€ä¸ªå¼€æ”¾çš„ç«¯å£ã€æ— ä¿æŠ¤çš„æœåŠ¡æˆ–è€…æ˜¯é˜²ç«å¢™ä¸­çš„ç¼ºå£å·å·è¿›å…¥ã€‚å…¶ä»–ç½‘ç»œå±‚æ”»å‡»æŠ€æœ¯åˆ©ç”¨TCP/IPåè®®ç³»ç»Ÿçš„å¸­ä½å·®åˆ«ï¼Œä»¥è·å¾—ä¿¡æ¯æˆ–é‡æ–°è·¯ç”±è¿æ¥ã€‚<br>&emsp;&emsp;<strong>åº”ç”¨å±‚æ”»å‡»ï¼š</strong>æ”»å‡»è€…åˆ©ç”¨ç³»ç»Ÿä¸Šè¿è¡Œçš„æŸä¸ªåº”ç”¨ç¨‹åºï¼ˆä¾‹å¦‚WebæœåŠ¡å™¨ï¼‰çš„ä»£ç ä¸­çš„å·²çŸ¥ç¼ºé™·ï¼Œæ¬ºéª—è¯¥åº”ç”¨ç¨‹åºæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œæˆ–è€…æ˜¯ä»¥ä¸€ç§ç¨‹åºè®¾è®¡äººå‘˜ä»æœªæƒ³åˆ°çš„æ–¹å¼è¿è¡Œã€‚</p></blockquote><p>&emsp;&emsp;ä¸€æ¬¡å…¨é¢çš„è€Œå¿˜äº†å…¥ä¾µï¼Œé€šå¸¸ç»„åˆä½¿ç”¨è¿™äº›æ”»å‡»æŠ€æœ¯ã€‚å…¸å‹æƒ…å†µä¸‹ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šä½¿ç”¨åº”ç”¨å±‚æ”»å‡»ä½œä¸ºæœ€åˆçš„å›¾ç‰‡ï¼Œç„¶åæŠŠæƒé™é€æ­¥æå‡è‡³ç®¡ç†å‘˜çº§åœ°ä½ï¼Œå†æ¥ç€æ‰“å¼€ä¸€ä¸ªéšè—çš„åé—¨ï¼Œä»¥ä¾¿æ— é™åˆ¶çš„è®¿é—®æ•´ä¸ªç³»ç»Ÿã€‚â€åé—¨â€å¸¸ç”¨çš„æŠ€æœ¯æ˜¯å®‰è£…ä¸€ä¸ªrootkitæ¥åœ¨ç³»ç»Ÿä¸Šæ‰¾åˆ°ä¸€ä¸ªç«‹è¶³ç‚¹ï¼Œç„¶åå†æ©ç›–å…¥ä¾µã€‚<br>1ã€è¯ä¹¦æ”»å‡»ï¼š<br>å¸¸ç”¨çš„å¯†ç æ”»å‡»æ–¹æ³•åŒ…æ‹¬ï¼š</p><blockquote><p>çœ‹çœ‹æœºç®±å¤–é¢ï¼›<br>ç‰¹æ´›ä¼Šæœ¨é©¬<br>çŒœæµ‹<br>çªƒå¬</p></blockquote><p>2ã€ç‰¹æ´›ä¼Šæœ¨é©¬<br>&emsp;&emsp;æ—©æœŸçš„ç‰¹æ´›ä¼Šæœ¨é©¬æ˜¯ï¼Œä¼ªé€ ç™»å½•å±å¹•ã€‚è¿™ç§å·å–å¯†ç çš„æŠ€æœ¯é’ˆå¯¹å…¬å…±è®¾ç½®è€Œè®¾è®¡ã€‚å¹¶ä¸æ˜¯æ‰€æœ‰çš„ç‰¹æ´›ä¼Šæœ¨é©¬éƒ½æ•æ‰å¯†ç ï¼Œè€Œä¸”å¹¶ä¸æ˜¯æ‰€æœ‰å¯†ç ç‰¹æ´›ä¼Šéƒ½åƒæœ¬èŠ‚æ‰€æè¿°çš„é‚£ä¸ªç¤ºä¾‹é‚£æ ·æœ¨é©¬å¼ èƒ†ã€‚è®¸å¤šæœ¨é©¬ç¨‹åºï¼Œæœ‰äº›è¡¨ç°ä¸ºæ¸¸æˆæˆ–å‡çš„ç³»ç»Ÿå·¥å…·ã€‚<br>3ã€çŒœæµ‹<br>4ã€çªƒå¬<br>&emsp;&emsp;åŒ…å—…æ¢å™¨ï¼ˆPacket Snifferï¼‰å’Œå…¶ä»–ç›‘è§†ç½‘ç»œæµé‡çš„å·¥å…·ï¼Œå¯ä»¥è½»æ¾åœ°æ•è·ä»¥æ˜æ–‡å½¢å¼åœ¨ç½‘ç»œä¸Šä¼ è¾“çš„å¯†ç ã€‚è®¸å¤šç»å…¸çš„TCP/IPå®ç”¨ç¨‹åºï¼›ä¾‹å¦‚Telnetå’Œr*å·¥å…·ï¼Œæˆ–è€…æ˜¯SNMP,éƒ½è¢«è®¾è®¡ä¸ºæ˜æ–‡å½¢å¼ä¼ è¾“å¯†ç ã€‚åŠ å¯†SSLå’ŒIPSecã€‚</p><p><strong>ç½‘ç»œå±‚æ”»å‡»</strong><br>&emsp;&emsp;é€šè¿‡ç«¯å£æ¥è¿›è¡Œæ”»å‡»ã€‚ä¸€èˆ¬ä½¿ç”¨Nmapå’ŒNessusä¹‹ç±»çš„æ‰«æå·¥å…·ï¼Œå¯ä»¥è‡ªåŠ¨å®ŒæˆæŸ¥æ‰¾å¼€å‘ç«¯å£çš„è¿‡ç¨‹ã€‚<br><strong>åº”ç”¨å±‚æ”»å‡»</strong><br>&emsp;&emsp;ç¼“å­˜åŒºæº¢å‡ºã€‚å¦‚æœç”¨æˆ·çš„è€Œè¾“å…¥æº¢å‡ºè¯¥ç¼“å†²åŒºï¼Œå¥‡æ€ªçš„äº‹å°±ä¼šå‘ç”Ÿã€‚å¦‚æœè¾“å…¥æ²¡æœ‰è¢«é€‚å½“ç®¡ç†ï¼Œé‚£ä¹ˆæº¢å‡ºç¼“å†²åŒºçš„æ•°æ®å°±å¯èƒ½è¾¹é•¿ä¸ºé©»ç•™åœ¨CPUçš„æ‰§è¡ŒåŒºåŸŸä¸­ï¼Œé‚£ä»¥ä¸ºè¿™ç»è¿‡ç¼“å†²åŒºæº¢å‡ºå‘é€ç»™è®¡ç®—æœºçš„å‘½ä»¤ï¼Œå¯èƒ½ä¼šè¢«å®é™…æ‰§è¡Œï¼ˆå›¾11.8ï¼‰ã€‚é¿å…ç¼“å†²åŒºæº¢å‡ºé—®é¢˜ï¼Œåº”ç”¨ç¨‹åºå¿…é¡»æä¾›ä¸€ç§æ–¹æ³•ï¼Œåœ¨å°†æ•°æ®å†™å…¥åº”ç”¨ç¨‹åºä¸€å‡ºå»ä¹‹å‰ï¼Œæ¥æ”¶å¹¶æ£€æŸ¥æ•°æ®çš„å¤§å°ã€‚è¾ƒå¥½çš„è§£å†³åŠæ³•æ˜¯åœ¨å…»æˆè‰¯å¥½çš„ç¨‹åºè®¾è®¡ä¹ æƒ¯ã€‚<br><strong>rootè®¿é—®</strong><br>&emsp;&emsp;åœ¨å…¥ä¾µè€…è¿›å…¥ç½‘ç»œä¹‹åï¼Œé¦–è¦ä»»åŠ¡æ˜¯ä¸Šä¼ ä¸€ä¸ªrookit,ç”¨äºåœ¨ç³»ç»Ÿä¸Šå»ºç«‹ä¸€ä¸ªæ›´åŠ ç¨³å›ºçš„ç«‹è¶³ç‚¹ã€‚rootkitè¿˜å…·æœ‰é¢å¤–ç‰¹æ€§ï¼ŒKey loggersèƒ½å¤Ÿæ•è·å’Œè®°å½•é”®ç›˜è¾“å…¥ã€‚<br><strong>ç½‘ç»œé’“é±¼</strong><br>&emsp;&emsp;è¶…æ–‡æœ¬é“¾æ¥ï¼Œä»¥æŒ‡å‘ä¸€ä¸ªä¸åŒçš„ç½‘ç«™ã€‚ä¸ä»”ç»†æ£€æŸ¥URLï¼Œå¾ˆå®¹æ˜“ä¸Šå½“ã€‚æœ€å¥½ç­–ç•¥ï¼Œä¸è¦ç‚¹å‡»ä¸æ˜é“¾æ¥ã€‚è¿˜æœ‰ä¸€ç§è¢«ç§°ä¸º<code>è·¨ç«™è„šæœ¬ç­–ç•¥</code>ï¼Œåˆ©ç”¨ä»£ç æ³¨å…¥ï¼Œç»•è¿‡æµè§ˆå™¨å®‰å…¨æªæ–½ï¼Œä»¥å‘èµ·ç”¨æˆ·æ­£åœ¨æŸ¥çœ‹çš„é¡µé¢ä¸æ˜“è¿½è¸ªçš„æŸä¸ªæ¶æ„è„šæœ¬ã€‚<br><strong>æ‹’ç»æœåŠ¡æ”»å‡»</strong><br>&emsp;&emsp;è¿›æ¥ï¼Œä¸€ç§ç‹‚çƒ­çš„Internetå…¥ä¾µæ˜¯æ‹’ç»æœåŠ¡ï¼ˆDenial of Service,DoSï¼‰æ”»å‡»ã€‚DoSä¸€æ—¦å‘èµ·ï¼Œå‡ ä¹ä¸å¯èƒ½åœæ­¢ï¼Œå› ä¸ºå®ƒå¹¶ä¸è¦æ±‚æ”»å‡»è€…åœ¨ç³»ç»Ÿä¸Šæ‹¥æœ‰ç‰¹å®šæƒé™ã€‚DoSæ”»å‡»çš„å…³é”®æ˜¯ç”¨å¤§é‡çš„è¯·æ±‚é˜»å¡ç³»ç»Ÿï¼Œä½¿ç³»ç»Ÿèµ„æºå…¨éƒ¨è€—å°½ï¼Œæ€§èƒ½é™ä½ã€‚æœ€å±é™©çš„DoSæ”»å‡»æ˜¯åˆ†å¸ƒå¼DoSæ”»å‡»ã€‚åœ¨åˆ†å¸ƒå¼DoSæ”»å‡»ä¸­ï¼Œæ”»å‡»è€…åˆ©ç”¨è‹¥å¹²å°è¿œç¨‹è®¡ç®—æœºï¼Œåªä¼šå…¶ä»–è¿œç¨‹è®¡ç®—æœºå‘èµ·ä¸€åœºååŒæ”»å‡»ã€‚æœ‰æ—¶ï¼Œå‡ ç™¾å°æˆ–å‡ åƒå°è®¡ç®—æœºå¯èƒ½å‚ä¸åˆ°é’ˆå¯¹æŸä¸ªIPåœ°å€çš„æ”»å‡»ã€‚</p><p><strong>é˜²èŒƒæªæ–½</strong></p><blockquote><p>ä½¿ç”¨æ­£ç¡®é…ç½®çš„é˜²ç«å¢™<br>ä½¿ç”¨å®‰å…¨çš„å¯†ç ã€‚å°½ç®¡å…·ä½“ç­–ç•¥ä¸åŒï¼Œä½†æ˜¯å¤§å¤šæ•°ä¸“å®¶éƒ½å»ºç«‹å¯†ç çš„æœ€çŸ­é•¿åº¦ä¸º6~8ä¸ªå­—ç¬¦ï¼Œè€Œä¸”é¢ä¸­è¦åŒ…å«å­—ç¬¦ã€æ•°å­—å’Œæ ‡ç‚¹ç¬¦å·ã€‚<br>ä¸è¦å•å‡»å¯ç–‘çš„é“¾æ¥<br>ä½¿ç”¨æœ€ä½çš„æƒé™æ¥æ“ä½œ<br>windowsç³»ç»Ÿï¼Œå®‰è£…ç—…æ¯’é˜²æŠ¤è½¯ä»¶<br>å…³é—­ä¸éœ€è¦çš„æœåŠ¡<br>å¦‚æœå¿…é¡»è¦è®¿é—®å†…éƒ¨ç½‘ç»œï¼Œè¯·ä½¿ç”¨VPNæ¥è¿›è¡ŒåŠ å¯†é€šä¿¡ã€‚<br>ä½¿ç”¨é˜²ç«å¢™ï¼Œå…³é—­æ‰€æœ‰ç«¯å£ï¼Œå…³é—­æ‰€æœ‰ç½‘ç»œæœåŠ¡ï¼Œé™¤éä½ æ˜¯çœŸçš„éœ€è¦çš„è¿™äº›æœåŠ¡ã€‚<br>åœ¨æ²™ç®±ç¯å¢ƒä¸­è¿è¡ŒæœåŠ¡ï¼Œ<br>æ— çº¿ç½‘ç»œä¸­ä½¿ç”¨åŠ å¯†<br>ç»å¸¸å®‰å…¨æ›´æ–°</p></blockquote><h4 id="4-åŠ å¯†å’Œä¿å¯†"><a href="#4-åŠ å¯†å’Œä¿å¯†" class="headerlink" title="4. åŠ å¯†å’Œä¿å¯†"></a><strong>4. åŠ å¯†å’Œä¿å¯†</strong></h4><p>&emsp;&emsp;æœ¬èŠ‚å…ˆè®¨è®ºäº†æœºå¯†æ€§çš„ç›®çš„ï¼ˆç¡®ä¿æ•°æ®çš„ç§˜å¯†ï¼‰ã€‚å®‰å…¨ç³»ç»Ÿè¿˜å¿…é¡»æ»¡è¶³å¦‚ä¸‹éœ€æ±‚ï¼š</p><blockquote><p><strong>èº«ä»½éªŒè¯ï¼š</strong>ç¡®ä¿æ•°æ®æ¥è‡ªäº§ç”Ÿå®ƒçš„æºå¤´ã€‚<br><strong>å®Œæ•´æ€§ï¼š</strong>ç¡®ä¿æ•°æ®åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æœªè¢«ç¯¡æ”¹ã€‚</p></blockquote><p>æœ¬ç« åç»­å†…å®¹é‡ç‚¹å…³æ³¨å¦‚ä½•ä¿æŠ¤TCP/IPå…å—<code>çªƒå¬</code>ã€<code>æˆªè·</code>å’Œ<code>æ“çºµ</code>ã€‚</p><p><strong>ç®—æ³•å’Œå¯†é’¥</strong><br>å¯¹ç§°åŠ å¯†ï¼Œéå¯¹ç§°åŠ å¯†ï¼Œæ•°å­—ç­¾åï¼Œæ•°å­—è¯ä¹¦ã€‚<br><strong>ä¿æŠ¤TCP/IP</strong><br>ï¼ˆ1ï¼‰ã€SSLå’ŒTLS<br>&emsp;&emsp;å®‰å…¨å¥—æ¥å±‚ï¼ˆSecure Sockets Layer,SSLï¼‰æ˜¯ç¾å›½Netscapeå…¬å¸ä¸ºä¿æŠ¤Webé€šä¿¡è€Œå¼•å…¥çš„ä¸€ä¸ªTCP/IPå®‰å…¨åè®®é›†ã€‚SSLçš„<code>ç›®çš„</code>ï¼Œåœ¨<code>ä¼ è¾“å±‚</code>çš„<code>å¥—æ¥å­—</code>å’Œ<code>æä¾›é‚£äº›å¥—æ¥å­—è®¿é—®ç½‘ç»œçš„åº”ç”¨ç¨‹åº</code>ä¹‹é—´æä¾›ä¸€å±‚å®‰å…¨ã€‚<br>å›¾11.15æ˜¾ç¤ºäº†SSLåœ¨TCP/IPåè®®æ ˆä¸­çš„ä½ç½®ã€‚ç†å¿µæ˜¯ï¼Œåœ¨SSLè¢«æ¿€æ´»æ—¶ï¼Œç½‘ç»œæœåŠ¡ï¼ˆä¾‹å¦‚FTPå’ŒHTTPï¼‰ä¾¿å°†å—åˆ°å®‰å…¨çš„SSLåè®®çš„ä¿æŠ¤ï¼Œä»¥å…é­æ”»å‡»ï¼Œä¼ è¾“å±‚å®‰å…¨ï¼ˆTransport Layer Security TLSï¼‰ã€‚ä»¥SSL3.0ä¸ºåŸºç¡€ï¼Œæ‰€ä»¥é€šå¸¸è¢«è®¤ä¸ºæ˜¯SSLçš„åç»­äº§å“ï¼Œç°åœ¨å®ƒå·²æˆä¸ºä¸šç•Œæ ‡å‡†ã€‚ä½†æ˜¯ï¼Œåœ¨äº§å“åç§°å’ŒçœŸæ˜¯çš„è½¯ä»¶ä¸­ï¼Œä»ç„¶ç§°å…¶ä¸ºSSLã€‚TLSåè®®ä¸SSLç±»ä¼¼ã€‚<br>&emsp;&emsp;ä»”ç»†æŸ¥çœ‹SSLå±‚ï¼Œå¯ä»¥å‘ç°å®ƒåŒ…å«ä¸¤ä¸ªå­å±‚ï¼ˆè§å›¾11.16ï¼‰ã€‚SSLè®°å½•åè®®ï¼ˆRecord Protocolï¼‰æ˜¯è®¿é—®TCPçš„ä¸€ä¸ªæ ‡å‡†åº“ã€‚åœ¨è¿™ä¸ªè®°å½•åè®®ä¹‹ä¸Šï¼Œæ˜¯ä¸€ç»„æ‰§è¡Œç‰¹å®šæœåŠ¡çš„SSLç›¸å…³åè®®ã€‚</p><blockquote><p>SSLæ¡æ‰‹åè®®ï¼ˆHandshake Protocolï¼‰ï¼šç”¨æ¥è®¿é—®TCPçš„åŸºç¡€åè®®ã€‚<br>SSLæ›´æ”¹å¯†æ–‡è§„èŒƒåè®®ï¼ˆChange Cipher Spec Protocolï¼‰:æ”¯æŒå¯¹åŠ å¯†å¥—ä»¶è®¾ç½®çš„æ›´æ”¹ã€‚<br>SSLå‘Šå¯†åè®®ï¼ˆAlert Protocolï¼‰ï¼šå‘å‡ºå‘Šè­¦ã€‚</p></blockquote><p>SSLé‡‡ç”¨å…¬å¼€å¯†é’¥åŠ å¯†ï¼Œå¹¶æä¾›å¯¹æ•°å­—è¯ä¹¦çš„æ”¯æŒï¼Œå¸¦æœ‰SSLåŠ å¯†çš„HTTP Webåè®®ç‰ˆæœ¬è¢«ç§°ä¸ºHTTPSã€‚SSLåœ¨ä¼ è¾“å±‚ä¹‹ä¸Šã€‚</p><blockquote><p><strong>æ³¨æ„ï¼š</strong> SSLå’ŒTLSéƒ½æ˜¯ç”¨äºé¢å‘è¿æ¥çš„TCPè¿æ¥ï¼Œç§°ä¹‹ä¸ºæ•°æ®æŠ¥æŠ¥ä¼ è¾“åè®®å®‰å…¨ï¼ˆDatagram Transport Protocol Security,DTLSï¼‰çš„å¦å¤–ä¸€ç§åè®®æä¾›äº†ç±»ä¼¼äºTLSçš„å®‰å…¨ï¼Œå®ƒå¯ä»¥æ”¯æŒä½¿ç”¨UDPçš„æ— è¿æ¥é€šä¿¡ã€‚</p></blockquote><p>ï¼ˆ2ï¼‰IPSec<br>&emsp;&emsp;IPå®‰å…¨ï¼ˆIPSecï¼‰æ˜¯TCP/IPç½‘ç»œä¸Šä½¿ç”¨çš„å¦ä¸€ç§å®‰å…¨åè®®ç³»ç»Ÿã€‚ã€‚IPSecåœ¨TCP/IPåè®®æ ˆä¸­è¿è¡Œï¼Œä½äºä¼ è¾“å±‚ä¹‹ä¸‹ã€‚IPSecæä¾›å¯¹<code>æœºå¯†æ€§</code>ã€<code>è®¿é—®æ§åˆ¶</code>ã€<code>èº«ä»½éªŒè¯</code>å’Œ<code>æ•°æ®å®Œæ•´æ€§</code>æ”¯æŒã€‚IPSecè¿˜å¯<code>é˜²æŠ¤é‡æ”¾æ”»å‡»</code>ã€‚ç›¸äº’é€šä¿¡çš„ä¸¤å°è®¡ç®—æœºçš„åè®®æ ˆéƒ½å¿…é¡»æ”¯æŒIPSecã€‚IPSecéå¸¸é€‚ç”¨äºä¸ºåƒè·¯ç”±å™¨å’Œé˜²ç«å¢™ä¹‹ç±»çš„ç½‘ç»œè®¾å¤‡æä¾›å®‰å…¨ã€‚IPSecå¯ä»¥ä»¥ä¸‹é¢ä¸¤ç§æ¨¡å¼ä¹‹ä¸€è¿è¡Œã€‚</p><blockquote><p>ä¼ é€æ¨¡å¼ä¸ºIPæ•°æ®åŒ…çš„è½½è·æä¾›åŠ å¯†ã€‚è¯¥è½½è·ç„¶åè¢«å°è£…è¿›ä¸€ä¸ªæ­£å¸¸çš„IPæ•°æ®åŒ…ä¸­è¿›è¡Œä¼ é€ã€‚<br>éš§é“æ¨¡å¼åŠ å¯†æ•´ä¸ªIPæ•°æ®åŒ…ã€‚åŠ å¯†åçš„æ•°æ®åŒ…ï¼Œç„¶åè¢«ä½œä¸ºè½½è·å°è£…åˆ°è¿›å¦ä¸€ä¸ªå¤–éƒ¨æ•°æ®åŒ…ã€‚</p></blockquote><p>IPSecéš§é“æ¨¡å¼é€šå¸¸ç”¨äºè™šæ‹Ÿä¸“ç”¨ç½‘ç»œï¼ˆVPN)äº§å“,å®ƒä»¬ç”¨æ¥åœ¨å…¬å…±ç½‘ç»œä¸­åˆ›å»ºä¸€ä¸ªå®Œå…¨ä¸“ç”¨çš„é€šä¿¡éš§é“ã€‚<br>&emsp;&emsp;IPSecä½¿ç”¨è®¸å¤šåŠ å¯†ç®—æ³•å’Œå¯†é’¥åˆ†å‘æŠ€æœ¯ï¼Œæ•°æ®ä½¿ç”¨åƒAESã€RC5æˆ–Blowfishè¿™æ ·çš„å¸¸è§„åŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†ï¼Œèº«ä»½éªŒè¯åå¯†é’¥åˆ†å‘å¯èƒ½ä¼šä½¿ç”¨å…¬å¼€å¯†é’¥æŠ€æœ¯ã€‚</p><p>ï¼ˆ3ï¼‰ã€è™šæ‹Ÿä¸“ç”¨ç½‘ç»œï¼ˆVPNï¼‰<br>&emsp;&emsp;è™šæ‹Ÿè®¿é—®è¿™ä¸ªé—®é¢˜å®é™…ä¸Šå·²ç»æ˜¯è´¯ç©¿TCP/IPå‘å±•çš„ä¸€ä¸ªé‡è¦é—®é¢˜ã€‚å¦‚ä½•è¿æ¥è·ç¦»ä¸æ˜¯å¾ˆè¿‘ï¼Œä¸å¤Ÿé‡‡ç”¨LANæ ·å¼ç”µç¼†è¿æ¥çš„è®¡ç®—æœºå‘¢ï¼Ÿç³»ç»Ÿç®¡ç†å‘˜æ€»æ˜¯ä¾èµ–ä»¥ä¸‹ä¸¤ç§é‡è¦çš„æ–¹æ³•è¿›è¡Œè¿œç¨‹è¿æ¥ã€‚</p><blockquote><p>æ‹¨å·ï¼šè¿œç¨‹ç”¨ç”¨é€šè¿‡è°ƒåˆ¶è§£è°ƒå™¨è¿æ¥åˆ°æŸä¸ªæ‹¨å·æœåŠ¡å™¨ï¼Œåè€…å……å½“åˆ°ç½‘ç»œçš„ä¸€ä¸ªç½‘å…³ã€‚<br>å¹¿åŸŸç½‘ï¼ˆWANï¼‰ï¼šä¸¤ä¸ªç½‘ç»œé€šè¿‡ç§Ÿç”¨ç”µè¯å…¬å¸æˆ–InternetæœåŠ¡æä¾›å•†çš„ä¸“ç”¨çº¿è·¯è¿æ¥åœ¨ä¸€èµ·ã€‚</p></blockquote><p>&emsp;&emsp;è¿™ä¸¤ç§æ–¹å¼éƒ½æœ‰ç¼ºç‚¹ã€‚æ‹¨å·è¿æ¥é€Ÿåº¦æ…¢ï¼Œè€Œä¸”ä»–ä»¬ä¾èµ–äºç”µè¯è¿æ¥çš„è´¨é‡ã€‚WANè¿æ¥æœ‰æ—¶ä¹Ÿæ¯”è¾ƒæ…¢ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œæ„å»ºå’Œç»´æŠ¤WANä¼šæ¯”è¾ƒæ˜‚è´µï¼Œè€Œä¸”å®ƒä¸å¯ç§»åŠ¨ã€‚é’ˆå¯¹è¿™äº›é—®é¢˜çš„ä¸€ç§è§£å†³æ–¹æ³•æ˜¯ï¼šé€šè¿‡å¼€æ”¾å¼çš„Internetç›´æ¥è¿æ¥åˆ°è¿œç¨‹ç½‘ç»œã€‚è¿™ä¸ªæ–¹æ³•å¿«é€Ÿã€æ–¹ä¾¿ï¼Œä½†æ˜¯Internetä¸Šå……æ»¡æ•Œæ„å’Œä¸å®‰å…¨å› ç´ ï¼Œå¦‚æœä¸æä¾›æŸç§é˜²æ­¢çªƒå¬çš„æ–¹å¼ï¼Œé‚£ä¹ˆè¿™æ ·çš„é€‰æ‹©å®Œå…¨ä¸å¯è¡Œã€‚ä¸“å®¶è€ƒè™‘æ˜¯å¦æœ‰æŸç§æ–¹å¼å¯ä»¥åˆ©ç”¨åŠ å¯†å·¥å…·æ¥åˆ›å»ºä¸€ä¸ªç©¿è¿‡å…¬ç”¨ç½‘ç»œçš„ä¸“ç”¨éš§é“ã€‚è¿™ä¸ªè§£å†³æ–¹ä¾¿ä¾¿å½¢æˆäº†æˆ‘ä»¬ç°åœ¨æ‰€çŸ¥é“çš„è™šæ‹Ÿä¸“ç”¨ç½‘ç»œï¼ˆVitural Private Network,VPNï¼‰ã€‚VPNå»ºç«‹ä¸€ä¸ªæ¨ªç©¿ç½‘ç»œçš„ç‚¹å¯¹ç‚¹â€œéš§é“â€ã€‚</p><blockquote><p><strong>æ³¨æ„ï¼š</strong> VPNåè®®<br>&emsp;&emsp;æœ¬ç« å‰é¢æ‰€è®²çš„IPSecæ˜¯ä¸€ç§æ”¯æŒå®‰å…¨ç½‘ç»œè¿æ¥çš„åè®®ï¼Œè€ŒVPNå°±æ˜¯è¿æ¥çš„æœ¬èº«ã€‚VPNåº”ç”¨ç¨‹åºå°±æ˜¯åˆ›å»ºå’Œç»´æŠ¤è¿™äº›ä¸“ç”¨è¿œç¨‹è¿æ¥çš„ç¨‹åºã€‚æœ‰äº›VPNå·¥å…·åˆ©ç”¨IPSecè¿›è¡ŒåŠ å¯†ï¼Œæœ‰äº›åˆ™ä¾èµ–äºå…¶ä»–SSLæˆ–å…¶ä»–åŠ å¯†æŠ€æœ¯ã€‚Microsoftçš„ç³»ç»Ÿé€šè¿‡â€œç‚¹å¯¹ç‚¹éš§é“åè®®â€ï¼ˆæºè‡ªPPPè°ƒåˆ¶è§£è°ƒå™¨åè®®ï¼‰æä¾›VPNéš§é“åŠŸèƒ½ï¼›æ¯”è¾ƒæ–°çš„Microsoftç³»ç»Ÿä¸ºVPNä¼šè¯é‡‡ç”¨â€œç¬¬2å±‚éš§é“åè®®â€ï¼ˆL2TPï¼‰ã€‚</p></blockquote><p>&emsp;&emsp;å¦‚æœä¼ è¾“é“¾ä¸­çš„æ¯ä¸€å°è·¯ç”±å™¨éƒ½éœ€è¦çŸ¥é“åŠ å¯†å¯†é’¥ï¼Œé‚£ä¹ˆæœ¬ç« å‰é¢æ‰€æè¿°çš„åŠ å¯†æŠ€æœ¯å°†æ— æ³•å¾ˆå¥½åœ°å‘æŒ¥ä½œç”¨ã€‚åŠ å¯†æ˜¯<code>é’ˆå¯¹ç‚¹å¯¹ç‚¹è¿æ¥çš„</code>ã€‚è¿™é‡Œçš„ç†å¿µæ˜¯ï¼šè¿œç¨‹æœåŠ¡å™¨ä¸ŠVPNå®¢æˆ·ç«¯è½¯ä»¶ä¸ä¸€å°å……å½“æ‰€æœ‰ç½‘ç»œç½‘å…³çš„VPNæœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼ˆå›¾11.17ï¼‰ã€‚VPNå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤æ¢é€šè¿‡Internetæ”¿ç­–ä¼ é€’çš„ã€å¯è·¯ç”±çš„æ˜æ–‡TCP/IPæ•°æ®æŠ¥ã€‚ä¸è¿‡ï¼Œé€šè¿‡VPNè¿æ¥å‘é€çš„è½½è·ï¼ˆå³æ•°æ®ï¼‰ï¼Œå®é™…ä¸Šå°±æ˜¯åŠ å¯†åçš„æ•°æ®æŠ¥ã€‚åŠ å¯†åçš„æ•°æ®æŠ¥ï¼ˆåœ¨å¼€å‘çš„Internetä¸Šæ˜¯ä¸å¯è¯»çš„ï¼‰è¢«å°è£…å…¥å¯è¯»å–æ˜æ–‡çš„æ•°æ®æŠ¥ä¸­ï¼Œåœ¨è½¬å‘ç»™VPNæœåŠ¡å™¨ã€‚VPNæœåŠ¡å™¨è½¯ä»¶æ¥ç€æå–åŠ å¯†åçš„æ•°æ®æŠ¥ï¼Œåˆ©ç”¨åŠ å¯†å¯†é’¥è§£å¯†è¯¥æ•°æ®æŠ¥ï¼Œç„¶åå°†å°è£…æ•°æ®è½¬å‘è‡³å—ä¿æŠ¤ç½‘ç»œä¸Šçš„ç›®çš„åœ°å€ã€‚</p><p>ï¼ˆ4ï¼‰ã€Kerberos<br>&emsp;&emsp;Kerberosæ˜¯ä¸€ç§åŸºäºç½‘ç»œçš„<code>èº«ä»½éªŒè¯</code>å’Œ<code>è®¿é—®æ§åˆ¶</code>ç³»ç»Ÿã€‚ç”¨äºæ”¯æŒ<code>è·¨æ•Œæ„</code>ç½‘ç»œçš„å®‰å…¨è®¿é—®ã€‚å¯¹äºæ•Œæ„ç½‘ç»œçš„å®‰å…¨é€šä¿¡é—®é¢˜ï¼Œè¾ƒç®€æ´çš„å›ç­”å°±æ˜¯åŠ å¯†ã€‚è¾ƒé•¿çš„å›ç­”åˆ™æ˜¯æä¾›ä¸€ç§æ‰‹æ®µï¼Œæ¥ä¿æŠ¤åŠ å¯†å¯†é’¥çš„å®‰å…¨ã€‚Kerberosæä¾›ä¸€ç§ç³»ç»Ÿçš„æ–¹æ³•ï¼Œç”¨äºå‘é€šä¿¡ä¸»æœºåˆ†å‘å¯†é’¥ï¼Œå¹¶æ£€éªŒæƒ…ä¹¦è®¿é—®æŸä¸€æœåŠ¡çš„å®¢æˆ·ç«¯çš„è¯ä¹¦ã€‚<br>&emsp;&emsp;Kerberosç³»ç»Ÿä½¿ç”¨è¢«ç§°ä¸º<code>å¯†é’¥åˆ†å‘ä¸­å¿ƒï¼ˆKey Distribution Center,KDCï¼‰</code>çš„æœåŠ¡å™¨æ¥ç®¡ç†å¯†é’¥åˆ†å‘è¿‡ç¨‹ã€‚Kerberosèº«ä»½éªŒè¯è¿‡ç¨‹æ¶‰åŠä»¥ä¸‹<code>3ä¸ªå®ä½“çš„å…³ç³»</code>ã€‚</p><blockquote><p><strong>å®¢æˆ·ç«¯ï¼š</strong>è¯·æ±‚è®¿é—®æœåŠ¡å™¨çš„è®¡ç®—æœº<br><strong>æœåŠ¡å™¨ï¼š</strong>åœ¨ç½‘ç»œä¸Šæä¾›æœåŠ¡çš„è®¡ç®—æœº<br><strong>KDCï¼š</strong>æŒ‡å®šä¸ºç½‘ç»œé€šä¿¡æä¾›å¯†é’¥çš„è®¡ç®—æœº</p></blockquote><p>&emsp;&emsp;Kerberosèº«ä»½éªŒè¯è¿‡ç¨‹å¦‚å›¾11.18ï¼Œ<code>æ³¨æ„</code>,è¿™ä¸ªè¿‡ç¨‹å‡è®¾KDCå·²ç»æœ‰ä¸€ä¸ªå…±æ€§çš„å¯†é’¥å¯ä»¥ç”¨æ¥ä¸è¿™é‡Œçš„å®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡ï¼Œè¿˜æœ‰ä¸€ä¸ªå…±äº«çš„å¯†é’¥å¯ä»¥ç”¨æ¥ä¸è¿™é‡Œçš„æœåŠ¡å™¨è¿›è¡Œé€šä¿¡ã€‚è¿™äº›å¯†é’¥ç”¨æ¥åŠ å¯†ä¸€ä¸ªæ–°çš„ä¼šè¯å¯†é’¥ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å°†ä½¿ç”¨å®ƒè¿›è¡Œç›¸äº’é€šä¿¡ã€‚KDCç”¨æ¥ä¸ºå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŠ å¯†æ•°æ®çš„é‚£ä¸¤ä¸ªå•ç‹¬å¯†é’¥è¢«ç§°ä¸º<code>é•¿æœŸå¯†é’¥</code>ã€‚é•¿æœŸå¯†é’¥é€šå¸¸äº§ç”ŸäºKDCå’Œå¦ä¸€å°è®¡ç®—æœºå…±äº«çš„ä¸€ä¸ªç§˜å¯†ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œå®¢æˆ·ç«¯é•¿æœŸå¯†é’¥å°è¯•ä¸å®¢æˆ·ç«¯å’ŒKDCéƒ½çŸ¥é“çš„ç”¨æˆ·ç™»å½•å¯†ç çš„ä¸€ä¸ªå“ˆå¸Œã€‚<br>                            å›¾11.18<br>&emsp;&emsp;å…·ä½“è¿‡ç¨‹å¦‚ä¸‹ã€‚è®°ä½ï¼ŒKerberosä¸€èˆ¬<code>ä½¿ç”¨</code>å¸¸è§„çš„<code>ï¼ˆå¯¹ç§°ï¼‰åŠ å¯†</code>æŠ€æœ¯ï¼Œè€Œä¸æ˜¯å…¬å¼€å¯†é’¥çš„ï¼ˆéå¯¹ç§°ï¼‰åŠ å¯†æŠ€æœ¯ã€‚</p><blockquote><ol><li>è¿™é‡Œçš„å®¢æˆ·ç«¯æƒ³è¦è®¿é—®æœåŠ¡å™¨Aä¸Šçš„é¢æŸä¸ªæœåŠ¡ã€‚å®ƒå‘KDCæ”¾æ”¾æ¾ä¸€ä¸ªè¯·æ±‚æ¥è®¿é—®æœåŠ¡å™¨Aä¸Šçš„æœåŠ¡ï¼ˆåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯å·²ç»ç»è¿‡èº«ä»½éªŒè¯ï¼Œå¹¶æ¥æ”¶åˆ°ä¸€ä¸ªå•ç‹¬çš„ä¼šè¯å¯†é’¥ï¼Œç”¨äºåŠ å¯†ä¸KDCä¸Šç¥¨è¯æˆäºˆæœåŠ¡çš„é€šä¿¡ï¼‰ã€‚</li><li>è¿™é‡Œçš„KDCæ‰§è¡Œä»¥ä¸‹æ­¥éª¤</li></ol><ul><li>a. KDCç”Ÿæˆä¸€ä¸ªä¼šè¯å¯†é’¥ï¼Œè¯¥å¯†é’¥ç”¨äºåŠ å¯†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨Aä¹‹é—´çš„é€šä¿¡ã€‚</li><li>b. KDCåˆ›å»ºä¸€ä¸ªä¼šè¯ç¥¨è¯ï¼ˆsession ticketï¼‰,å®ƒåŒ…æ‹¬æ­¥éª¤2aä¸­æ‰€ç”Ÿæˆçš„ä¼šè¯å¯†é’¥çš„ä¸€ä¸ªå‰¯æœ¬ã€‚è¯¥ç¥¨è¯è¿˜åŒ…å«æ—¶é—´æˆ³ä¿¡æ¯ä»¥åŠæœ‰å…³æ­£åœ¨è¯·æ±‚è®¿é—®çš„å®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼Œä¾‹å¦‚å®¢æˆ·ç«¯å®‰å…¨è®¾ç½®ã€‚</li><li>c. KDCä½¿ç”¨æœåŠ¡å™¨Açš„é•¿æœŸå¯†é’¥åŠ å¯†åˆšåˆ›å»ºçˆ±ä½ çš„ä¼šè¯ç¥¨è¯</li><li>d. KDCä¸ºå®¢æˆ·ç«¯ç»‘å®šåŠ å¯†åçš„ä¼šè¯ç¥¨è¯ã€ä¼šè¯å¯†é’¥çš„ä¸€ä¸ªå‰¯æœ¬ä»¥åŠå…¶ä»–å“åº”å‚æ•°ï¼Œå¹¶ä½¿ç”¨å®¢æˆ·ç«¯çš„å¯†é’¥åŠ å¯†æ•´ä¸ªæ•°æ®åŒ…ã€‚è¯¥å“åº”ç„¶åè¢«å‘é€ç»™å®¢æˆ·ç«¯ã€‚</li></ul><ol start="3"><li>å®¢æˆ·ç«¯æ¥æ”¶æ¥è‡ªKDCçš„å“åº”å¹¶è§£å¯†ã€‚å®¢æˆ·ç«¯å°†è·å¾—ä¸æœåŠ¡å™¨Aé€šä¿¡æ‰€éœ€çš„ä¼šè¯å¯†é’¥ã€‚å®ƒæ‰€æ¥æ”¶çš„å¯†é’¥åŠ å¯†æ•´ä¸ªæ•°æ®åŒ…ï¼Œè¿˜åŒ…æ‹¬KDCåˆ›å»ºçš„ä¼šè¯ç¥¨è¯ï¼Œé‚£æ˜¯ä½¿ç”¨æ‰€è¯·æ±‚çš„æœåŠ¡å™¨çš„é•¿æœŸå¯†é’¥åŠ å¯†çš„ã€‚å®¢æˆ·ç«¯æ— æ³•è¯»å–è¯¥ä¼šè¯ç¥¨è¯ï¼Œä½†æ˜¯å®ƒçŸ¥é“å¿…é¡»å°†æ­¤ç¥¨è¯å‘é€ç»™ç›¸åº”çš„æœåŠ¡å™¨ï¼Œæ‰èƒ½é€šè¿‡èº«ä»½éªŒè¯ï¼Œå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªé‰´åˆ«ç ï¼ˆä¸€ä¸²èº«ä»½éªŒè¯å‚æ•°ï¼‰ï¼Œå¹¶ä½¿ç”¨è¿™é‡Œçš„ä¼šè¯ç¥¨è¯å¯¹å®ƒè¿›è¡ŒåŠ å¯†ã€‚</li><li>å®¢æˆ·ç«¯å‘æœåŠ¡å™¨Aå‘é€ä¸€ä¸ªè®¿é—®è¯·æ±‚ã€‚è¯¥è¯·æ±‚åŒ…æ‹¬ä¸Šè¿°ä¼šè¯ç¥¨è¯ï¼ˆå·²ä½¿ç”¨æ‰€æƒ…ä¹¦æœåŠ¡å™¨çš„é•¿æœŸå¯†é’¥è¿›è¡ŒåŠ å¯†ï¼‰å’Œé‰´åˆ«ç ï¼ˆå·²ä½¿ç”¨ä¼šè¯å¯†é’¥è¿›è¡ŒåŠ å¯†ï¼‰ã€‚è¿™é‡Œçš„é‰´åˆ«ç åŒ…æ‹¬ç”¨æˆ·çš„åç§°ã€ç½‘ç»œåœ°å€å’Œæ—¶é—´æˆ³ä¿¡æ¯ç­‰ã€‚</li><li>æœåŠ¡å™¨Aæ¥æ”¶ä¸Šè¿°è¯·æ±‚ã€‚æœåŠ¡å™¨Aä½¿ç”¨å…¶é•¿æœŸå¯†é’¥è§£å¯†ä¸Šè¿°ä¼šè¯ç¥¨è¯ï¼ˆè§æ­¥éª¤2cï¼‰ã€‚æœåŠ¡å™¨Aä»ä¼šè¯ç¥¨è¯ä¸­æå–ä¼šè¯å¯†é’¥ï¼Œå¹¶ä½¿ç”¨è¯¥ä¼šè¯å¯†é’¥è§£å¯†é‰´åˆ«ç ã€‚æœåŠ¡å™¨Aæ£€éªŒé‰´åˆ«ç ä¸­çš„ä¿¡æ¯æ˜¯å¦ä¸åŒ…æ‹¬åœ¨ä¼šè¯ç¥¨è¯ä¸­çš„ä¿¡æ¯ç›¸åŒ¹é…ã€‚å¦‚æœæ˜¯ï¼Œåˆ™æˆäºˆå¯¹æ‰€è¯·æ±‚æœåŠ¡çš„è®¿é—®æƒã€‚</li><li>ä½œä¸ºå¯é€‰çš„æœ€åä¸€æ­¥ï¼Œå¦‚æœå®¢æˆ·ç«¯æƒ³è¦æ£€éªŒæœåŠ¡å™¨Açš„æ•´æ•°ï¼ŒæœåŠ¡å™¨Aå°†ç”¨ä¼šè¯å¯†é’¥åŠ å¯†ä¸€ä¸ªé‰´åˆ«ç ï¼Œå¹¶å°†è¿™ä¸ªé‰´åˆ«ç è¿”å›å®¢æˆ·ç«¯ã€‚</li></ol></blockquote><p>ä½œä¸ºä¸€ç§ä¸ºç½‘ç»œæä¾›ç»Ÿä¸€æ ‡å‡†ç™»å½•ç³»ç»Ÿçš„æ‰‹æ®µï¼ŒKerberosç³»ç»Ÿæ­£è¶Šæ¥è¶Šæµè¡Œã€‚Kerberos 4ä½¿ç”¨DESåŠ å¯†æŠ€æœ¯ï¼Œå‰é¢è®²è¿‡ï¼Œè®¸å¤šåŠ å¯†é¢†åŸŸçš„ä¸“å®¶è®¤ä¸ºè¯¥æŠ€æœ¯ä¸å®‰å…¨ã€‚Kerberos 5åˆ™æ”¯æŒAESå’Œå…¶ä»–åŠ å¯†ç±»å‹ã€‚</p><blockquote><p><strong>æ³¨æ„ï¼š</strong> 3ä¸ªå¤´?<br>&emsp;&emsp;Kerberosï¼ˆä¹Ÿç§°Cerberusï¼‰ã€‚ä¸‰ä¸ªå¤´å°±æ˜¯Kerberosèº«ä»½éªŒè¯è¿‡ç¨‹çš„3ä¸ªè¦ç´ ï¼ˆå®¢æˆ·ç«¯ã€æœåŠ¡å™¨å’ŒKDCï¼‰ã€‚Kerberosç³»ç»Ÿæœ€åˆè®¾è®¡ä½¿ç”¨èº«ä»½éªŒè¯ã€è´¦æˆ·ç®¡ç†å’Œå®¡æ ¸è¿™ä¸‰ä¸ªå¤´ï¼Œå®ˆæŠ¤ç½‘ç»œçš„å…¥å£ï¼Œä½†æ˜¯å…¶ä¸­çš„åä¸¤ä¸ªå¤´ï¼ˆè´¦æˆ·ç®¡ç†å’Œå®¡æ ¸ï¼‰ä»æœªå®æ–½ã€‚å®‰å…¨ç•Œå¾ˆè½»æ˜“åœ°å‘ç°ã€‚ç›¸å¯¹äºæŠŠç›¸åº”çš„åè®®é‡æ–°å‘½åä¸ºç›¸å½“å•å¤´çŠ¬æ¥è¯´ã€‚</p></blockquote><p>å…³é”®æœ¯è¯­ï¼š<br><strong><code>é«˜çº§åŠ å¯†æ ‡å‡†ï¼ˆAdvanced Encryption Standard,AESï¼‰:</code></strong>ä¸€ç§å¯¹ç§°åŠ å¯†ï¼Œæ”¯æŒ128,192å’Œ256ä¸ºå¯†é’¥é•¿åº¦<br><strong><code>éå¯¹ç§°åŠ å¯†ï¼š</code></strong>ä½¿ç”¨ä¸ç”¨å¯†é’¥è¿›è¡ŒåŠ å¯†å’Œè§£å¯†çš„åŠ å¯†æ–¹æ³•<br><strong><code>åé—¨ï¼š</code></strong>å¯ä»¥è¿›å…¥è®¡ç®—æœºç³»ç»Ÿçš„ä¸€æ¡éšè—è·¯å¾„ã€‚<br><strong><code>Blowfishï¼š</code></strong>ä¸€ç§å¯¹å”±åŠ å¯†ç®—æ³•ï¼Œæ”¯æŒæœ€å¤š448ä½å¯†é’¥é•¿åº¦<br><strong><code>ç¼“å†²åŒºæº¢å‡ºï¼š</code></strong>ä¸€ç§æ”»å‡»æ–¹æ³•ï¼Œæ”»å‡»è€…å‘ç³»ç»Ÿå‘ç”Ÿæ¶æ„çš„å‘½ä»¤ï¼Œä»è€Œå¯¼è‡´åº”ç”¨ç¨‹åºçš„ç¼“å†²åŒºè¶…å‡ºé™åº¦ã€‚<br><strong><code>è®¤è¯ä¸­å¿ƒï¼ˆCertificate Authority,CAï¼‰:</code></strong>ç›‘è§†è¯ä¹¦åºŠå•Šè¿›å’Œé€’é€è¿‡ç¨‹çš„ä¸­å¤®æƒå¨ã€‚<br><strong><code>æ‹’ç»æœåŠ¡æ”»å‡»ï¼ˆDenial of Service,DOSï¼‰:</code></strong>é€šè¿‡æ¶ˆè€—ç³»ç»Ÿèµ„æºæ¥ä½¿å—å®³è€…çš„ç³»ç»Ÿæ— æ³•æä¾›æ”¿ç­–æœåŠ¡çš„ä¸€ç§æ”»å‡»æ‰‹æ®µã€‚<br><strong><code>æ•°å­—è¯ä¹¦ï¼š</code></strong>ä¸€ç§åŠ å¯†çš„é¢æ•°æ®ç»“æ„ï¼Œç”¨æ¥åˆ†å‘å…¬å®‰å¯†é’¥ã€‚<br><strong><code>æ•°å­—ç­¾åï¼š</code></strong>ç”¨æ¥æ ¡éªŒå‘é€æ–¹èº«ä»½å’Œæ•°æ®å®Œæ•´æ€§çš„åŠ å¯†å­—ç¬¦ä¸²ã€‚<br><strong><code>DMZï¼š</code></strong>å®‰ç½®InternetæœåŠ¡å™¨çš„ä¸€ä¸ªä¸­é—´åœ°å¸¦ï¼Œä½äºå‰ç«¯é˜²ç«å¢™ä¹‹åï¼Œä½†æ˜¯åœ¨å…·æœ‰æ›´ä¸¥æ ¼é™åˆ¶çš„è€Œåæ®µé˜²ç«å¢™ï¼ˆç”¨äºä¿æŠ¤å†…éƒ¨ç½‘ï¼‰ä¹‹å‰ã€‚<br><strong><code>åŠ å¯†ï¼š</code></strong>ç³»ç»Ÿåœ°ä¿®æ”¹æ•°æ®çš„ä¸‡å›½åŸï¼Œä½¿å¾—æœªæˆæƒçš„ç”¨æˆ·æ— æ³•è¯»å–å®ƒä»¬ã€‚<br><strong><code>åŠ å¯†å¯†é’¥ï¼š</code></strong>å’ŒåŠ å¯†ç®—æ³•ä¸€èµ·ç”¨æ¥åŠ å¯†æˆ–è§£å¯†æ•°æ®çš„ä¸€ä¸ªå€¼ï¼ˆé€šå¸¸ç§˜å¯†ä¿ç®¡ï¼‰ã€‚<br><strong><code>é˜²ç«å¢™ï¼š</code></strong>ä¸€ç§ç”¨äºé™åˆ¶ç½‘ç»œè®¿é—®å†…éƒ¨ç½‘æ®µé¢è®¾å¤‡æˆ–åº”ç”¨ç¨‹åºã€‚<br><strong><code>IPSec(IPå®‰å…¨)ï¼š</code></strong>ä¸€ç§æœ‰å¤šä¸ªIPåè®®æ‰©å±•ç»„æˆçš„å®‰å…¨åè®®ç³»ç»Ÿã€‚<br><strong><code>KDCï¼ˆå¯†é’¥åˆ†å‘ä¸­å¿ƒï¼‰ï¼š</code></strong>åœ¨Kerberosç½‘ç»œä¸Šç®¡ç†å¯†é’¥åˆ†å‘è¿‡ç¨‹çš„æœåŠ¡å™¨ã€‚<br><strong><code>Kerberosï¼š</code></strong>ä¸€ç§ç½‘ç»œèº«ä»½éªŒè¯ç³»ç»Ÿï¼Œç”¨æ¥ä¿è¯é€šè¿‡ç¬¬ä¸€ç½‘ç»œè®¿é—®æœåŠ¡çš„å®‰å…¨æ€§ã€‚<br><strong><code>åŒ…è¿‡æ»¤å™¨ï¼š</code></strong>ä¸€ç§é˜²ç«å¢™ï¼Œå¯ä»¥é€šè¿‡ç«¯å£å·æˆ–æ´½è°ˆèƒ½å¤Ÿæ ‡æ˜åŒ…ç›®çš„çš„åè®®ä¿¡æ¯è¿‡æ»¤æ•°æ®åŒ…ã€‚<br><strong><code>ç½‘ç»œé’“é±¼ï¼š</code></strong>åˆ©ç”¨æŸä¸ªä¼ªé€ çš„é“¾æ¥ã€æ¶ˆæ¯æˆ–ç½‘é¡µæ¥è¯±ä½¿ç”¨æˆ·ä¸»åŠ¨è¿æ¥åˆ°æŸä¸ªæ¬ºè¯ˆç½‘ç«™ã€‚<br><strong><code>ç§æœ‰å¯†é’¥ï¼š</code></strong>éå¯¹ç§°åŠ å¯†ä¸­ä½¿ç”¨çš„ä¸€ç§å¯†é’¥ï¼Œå®ƒè¢«ç§˜å¯†ä¿ç®¡ï¼Œå¹¶ä¸”ä¸åœ¨ç½‘ç»œä¸Šåˆ†å‘ã€‚<br><strong><code>ä»£ç†æœåŠ¡å™¨ï¼š</code></strong>ç”¨äºä»£è¡¨å®¢æˆ·ç«¯å¯¹æœåŠ¡å‘å‡ºè¯·æ±‚çš„è®¡ç®—æœºæˆ–åº”ç”¨ç¨‹åºã€‚<br><strong><code>å…¬å¼€å¯†é’¥ï¼š</code></strong>éå¯¹ç§°åŠ å¯†ä¸­ä½¿ç”¨çš„ä¸€ç§å¯†é’¥ï¼Œå®ƒåœ¨ç½‘ç»œä¸Šåˆ†å‘ã€‚<br><strong><code>Rootkitï¼š</code></strong>å…¥ä¾µè€…æ°¸å‡¯æ‰©å±•å’Œä¼ªé€ å…¶å¯¹æŸä¸€ç³»ç»Ÿçš„æ§åˆ¶çš„ä¸€ç»„å·¥å…·ã€‚<br><strong><code>ä¼šè¯åŠ«æŒï¼š</code></strong>ä¸€ç§æ”»å‡»æ–¹æ³•ï¼Œå…è®¸æ”»å‡»è€…åœ¨ç°æœ‰TCPä¼šè¯ä¸­æ’å…¥æ¶æ„æ•°æ®åŒ…ã€‚<br><strong><code>SSLï¼ˆå®‰å…¨å¥—æ¥å­—ï¼‰ï¼š</code></strong>ä¸€ç§æœ€åˆç”±Netscapeå…¬å¸å¼€å‘çš„å®‰å…¨åè®®ç³»ç»Ÿï¼Œå®ƒåœ¨TCPåè®®çš„ä¸Šæ–¹è¿è¡Œã€‚SSLå·²ç»è¢«TLCæ­£å¼å–ä»£ã€‚<br><strong><code>æœ‰çŠ¶æ€é˜²ç«å¢™ï¼š</code></strong>èƒ½å¤Ÿæ„ŸçŸ¥è¿æ¥çŠ¶æ€çš„é˜²ç«å¢™ã€‚<br><strong><code>TLS(ä¼ è¾“å±‚å®‰å…¨)ï¼š</code></strong>åŸºäºSSLçš„ä¸€ç§å®‰å…¨çš„ä¼ è¾“å±‚åè®®ã€‚<br><strong><code>X.509ï¼š</code></strong>ä¸€ç§æè¿°æ•°å­—è¯ä¹¦è¿‡ç¨‹å’Œæ ¼å¼çš„æ ‡å‡†ã€‚</p>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç½‘ç»œ </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>æ­å»ºä¸ªäººåšå®¢</title>
      <link href="/2018/05/13/%E7%AC%94%E8%AE%B0/02%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/"/>
      <url>/2018/05/13/%E7%AC%94%E8%AE%B0/02%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</url>
      <content type="html"><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>æœ€è¿‘æ¯”è¾ƒç©ºé—²ï¼Œä¹‹å‰æ”¶è—äº†å¾ˆå¤šæ–‡ç« ï¼Œä¸€ç›´ä¿å­˜åœ¨æ”¶è¶£ä¸Šï¼Œæœ€è¿‘å¯¹å…¶è¿›è¡Œäº†åˆ†ç±»ï¼Œç„¶åå·¥ä½œä¸­æœ‰æ•´ç†äº†ä¸€äº›ç¬”è®°(.md)ï¼Œä¸€ç›´æƒ³è‡ªå·±å†™ä¸ªç½‘ç«™ä¿å­˜ä¸€ä¸‹ã€‚ç„¶åæœ€è¿‘åˆšå¥½æ¥è§¦äº†ä¸€ä¸‹å°†markdownæ–‡ç« è½¬ä¸ºhtmlï¼Œåˆåœ¨ç½‘ä¸Šæœäº†ä¸€äº›èµ„æ–™ï¼Œå¯¹å…¶æ•´ç†ä¸€ä¸‹ä¾›å¤§å®¶å­¦ä¹ ã€‚</p><p>è¿™é‡Œä¸»è¦ä½¿ç”¨çš„Hexoåšå®¢æ¡†æ¶ã€‚å¼€å§‹é…ç½®çš„æ˜¯linuxç¯å¢ƒï¼Œä¸çŸ¥æ€ä¹ˆä¸€ç›´æ²¡æœ‰æˆåŠŸã€‚å¯åŠ¨æœåŠ¡åï¼Œwebä¸€ç›´å‡ºé”™ã€‚åœ¨è§£å†³é—®é¢˜æ—¶æ— æ„çœ‹åˆ°windowsç¯å¢ƒï¼Œä»¥ä¸‹ä»‹ç»ç»™å¤§å®¶ã€‚</p><p>æœ¬æ–‡windownsç¯å¢ƒæ­å»ºå‚è€ƒï¼š<a href="https://blog.csdn.net/AinUser/article/details/77609180" target="_blank" rel="noopener">https://blog.csdn.net/AinUser/article/details/77609180</a></p><h2 id="ä¸€ã€ä¸‹è½½å·¥å…·ï¼ˆgit-node-js-hexo"><a href="#ä¸€ã€ä¸‹è½½å·¥å…·ï¼ˆgit-node-js-hexo" class="headerlink" title="ä¸€ã€ä¸‹è½½å·¥å…·ï¼ˆgit  node.js hexo)"></a>ä¸€ã€ä¸‹è½½å·¥å…·ï¼ˆgit  node.js hexo)</h2><p><strong>window ä¸‹ç¯å¢ƒæ­å»ºï¼š</strong></p><h3 id="1ã€git"><a href="#1ã€git" class="headerlink" title="1ã€git"></a>1ã€<code>git</code></h3><p>(1)ä¸‹è½½<br>å®˜ç½‘ï¼š<a href="https://git-scm.com/download/win" target="_blank" rel="noopener">https://git-scm.com/download/win</a><br>(2)å®‰è£…</p><div align="left"><p><img src="/img/note_02/01.png" alt></p></div><p></p><div align="left"><p><img src="/img/note_02/02.png" alt></p></div><p></p><div align="left"><p><img src="/img/note_02/03.png" alt></p></div><p></p><div align="left"><p><img src="/img/note_02/04.png" alt></p></div><p></p><p>ä¸­é—´æœªè¯´æ˜å®‰è£…è¿‡ç¨‹ï¼ŒæŒ‰ç…§é»˜è®¤é€‰æ‹©ã€‚</p><h3 id="2ã€node-js"><a href="#2ã€node-js" class="headerlink" title="2ã€node.js"></a>2ã€<code>node.js</code></h3><p>(1)ã€ä¸‹è½½<br>å®˜ç½‘ï¼š<a href="https://nodejs.org/en/" target="_blank" rel="noopener">https://nodejs.org/en/</a><br>(2)ã€å®‰è£…<br>nodejsçš„å®‰è£…ä¸éœ€è¦æ³¨æ„ä»»ä½•é—®é¢˜ï¼Œæœ€å¤šä¿®æ”¹å®‰è£…è·¯å¾„ï¼Œå…¶ä»–ä¸€ç›´ç‚¹å‡»nextï¼Œç›´åˆ°finishã€‚</p><h3 id="3ã€hexo"><a href="#3ã€hexo" class="headerlink" title="3ã€hexo"></a>3ã€<code>hexo</code></h3><p>hexo å®‰è£…ä¸åŒäºgitå’Œnode.jsï¼Œè¿™é‡Œä½¿ç”¨gitå‘½ä»¤è¡Œæ¨¡å¼ä¸‹å®‰è£…<br>é¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¤¹<code>Hexo</code></p><div align="left"><p><img src="/img/note_02/05.png" alt></p></div><p></p><p>ç‚¹å‡»<code>Git Bash Here</code>ä¹‹åï¼Œå‡ºç°å‘½ä»¤è¡Œæ¨¡å¼çª—å£ï¼Œå‘½ä»¤è¡Œçª—å£å®‰è£…hexo;</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹å›¾ï¼š</p><div align="left"><p><img src="/img/note_02/06.png" alt></p></div><p></p><p>ä»¥ä¸ŠåŸºæœ¬çš„éœ€è¦çš„è½¯ä»¶å°±å®‰è£…å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±å¼€å§‹ä½¿ç”¨<code>hexo</code>å»ºç«™äº†.</p><p>** ubuntuä¸‹ç¯å¢ƒæ­å»ºï¼š **<br>æš‚æ— </p><h2 id="äºŒã€Hexoå»ºç«™"><a href="#äºŒã€Hexoå»ºç«™" class="headerlink" title="äºŒã€Hexoå»ºç«™"></a>äºŒã€Hexoå»ºç«™</h2><p>ä½¿ç”¨<code>hexo</code>å»ºç«™å¯å‚è€ƒ<a href="https://hexo.io/zh-cn/docs/index.html" target="_blank" rel="noopener">å®˜æ–¹ç½‘ç«™</a>,è¿™é‡Œä»¥æ¡ˆä¾‹è¯´æ˜ã€‚</p><h3 id="1ã€åˆå§‹åŒ–æ–‡ä»¶å¤¹"><a href="#1ã€åˆå§‹åŒ–æ–‡ä»¶å¤¹" class="headerlink" title="1ã€åˆå§‹åŒ–æ–‡ä»¶å¤¹"></a>1ã€åˆå§‹åŒ–æ–‡ä»¶å¤¹</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo init</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>ls</code>å¯ä»¥çœ‹åˆ°ï¼Œ<code>hexo</code>åˆå§‹åŒ–åˆ›å»ºçš„æ‰€éœ€è¦çš„æ–‡ä»¶ã€‚</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ _config.yml</span><br><span class="line">â”œâ”€â”€ mode_modules   // è¯¥æ–‡ä»¶å¤¹ä¸éœ€è¦è€ƒè™‘</span><br><span class="line">â”œâ”€â”€ package.json</span><br><span class="line">â”œâ”€â”€ scaffolds</span><br><span class="line">â”œâ”€â”€ <span class="built_in">source</span></span><br><span class="line">|   â””â”€â”€ _posts</span><br><span class="line">â””â”€â”€ themes</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/note_02/07.png" alt></p></div><p></p><p><code>_config.yml</code>:<br>ç½‘ç«™çš„<a href="https://hexo.io/zh-cn/docs/configuration.html" target="_blank" rel="noopener">é…ç½®</a>ä¿¡æ¯,ä¸€èˆ¬é»˜è®¤ä¸éœ€è¦ä¿®æ”¹ä»€ä¹ˆï¼Œè¿™é‡Œæˆ‘åªå¯¹<code>theme</code>è¿›è¡Œä¿®æ”¹ï¼Œä¸ä½¿ç”¨é»˜è®¤ä¸»é¢˜ï¼Œä½¿ç”¨<code>snippet</code>ã€‚ä¸»é¢˜<a href="https://hexo.io/themes/" target="_blank" rel="noopener">ä¸‹è½½</a>ã€‚</p><p><code>source</code>:<br>èµ„æºæ–‡ä»¶å¤¹æ˜¯å­˜æ”¾ç”¨æˆ·èµ„æºçš„åœ°æ–¹ã€‚é™¤ _posts æ–‡ä»¶å¤¹ä¹‹å¤–ï¼Œå¼€å¤´å‘½åä¸º _ (ä¸‹åˆ’çº¿)çš„æ–‡ä»¶ / æ–‡ä»¶å¤¹å’Œéšè—çš„æ–‡ä»¶å°†ä¼šè¢«å¿½ç•¥ã€‚Markdown å’Œ HTML æ–‡ä»¶ä¼šè¢«è§£æå¹¶æ”¾åˆ° public æ–‡ä»¶å¤¹ï¼Œè€Œå…¶ä»–æ–‡ä»¶ä¼šè¢«æ‹·è´è¿‡å»ã€‚<code>public</code>æ–‡ä»¶å¤¹ï¼Œä¸ºç¼–è¯‘åäº§ç”Ÿçš„Web,å®Œæ•´ä»£ç ã€‚</p><p><code>themes</code>:<br>ä¸»é¢˜ æ–‡ä»¶å¤¹ã€‚Hexo ä¼šæ ¹æ®ä¸»é¢˜æ¥ç”Ÿæˆé™æ€é¡µé¢ã€‚</p><h3 id="2ã€ä¸»é¢˜ä¸‹è½½"><a href="#2ã€ä¸»é¢˜ä¸‹è½½" class="headerlink" title="2ã€ä¸»é¢˜ä¸‹è½½"></a>2ã€ä¸»é¢˜ä¸‹è½½</h3><p><code>snippet</code><a href="https://github.com/shenliyang/hexo-theme-snippet" target="_blank" rel="noopener">ä¸»é¢˜ä¸‹è½½</a></p><div align="left"><p><img src="/img/note_02/08.png" alt></p></div><br>ä¸‹è½½åè§£å‹ï¼Œå¤åˆ¶åˆ°<code>Hexo-&gt;theme</code>æ–‡ä»¶å¤¹ä¸‹ï¼Œå¹¶ä¿®æ”¹<code>hexo-theme-snippet-master</code>ä¸º<code>snippet</code>ã€‚<p></p><div align="left"><p><img src="/img/note_02/09.png" alt></p></div><h3 id="3ã€ä½¿ç”¨ä¸»é¢˜"><a href="#3ã€ä½¿ç”¨ä¸»é¢˜" class="headerlink" title="3ã€ä½¿ç”¨ä¸»é¢˜"></a>3ã€ä½¿ç”¨ä¸»é¢˜</h3><p>ä¿®æ”¹<code>Hexo-&gt;_config.yml</code>æ–‡ä»¶</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">theme: landscape  ---&gt; ä¿®æ”¹ä¸º: theme: snippet</span><br></pre></td></tr></table></figure><h3 id="4ã€å¯åŠ¨æœåŠ¡"><a href="#4ã€å¯åŠ¨æœåŠ¡" class="headerlink" title="4ã€å¯åŠ¨æœåŠ¡"></a>4ã€å¯åŠ¨æœåŠ¡</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">hexo generate</span><br><span class="line">hexo server</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/note_02/10.png" alt></p></div><h3 id="5ã€æŸ¥çœ‹ç½‘ç«™"><a href="#5ã€æŸ¥çœ‹ç½‘ç«™" class="headerlink" title="5ã€æŸ¥çœ‹ç½‘ç«™"></a>5ã€æŸ¥çœ‹ç½‘ç«™</h3><p><code>http://localhost:4000/</code></p><div align="left"><p><img src="/img/note_02/11.png" alt></p></div><p></p><p>å¦‚æœæµè§ˆå™¨è¾“å…¥<code>http://localhost:4000/</code>ä¸èƒ½å¤Ÿæ­£å¸¸æ˜¾ç¤ºé¡µé¢<code>Cannot GET /***</code>æ—¶ã€‚<br>å‘½ä»¤è¡Œçª—å£<code>ctrl+c</code>åœæ­¢æœåŠ¡ã€‚è§£å†³æ–¹æ³•:</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-devlover-git --save</span><br></pre></td></tr></table></figure><p>éšåé‡æ–°å¯åŠ¨æœåŠ¡ï¼š</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hexo clean</span><br><span class="line">hexo g</span><br><span class="line">hexo s</span><br></pre></td></tr></table></figure><h3 id="6ã€å…¶ä»–ä¿®æ”¹"><a href="#6ã€å…¶ä»–ä¿®æ”¹" class="headerlink" title="6ã€å…¶ä»–ä¿®æ”¹"></a>6ã€å…¶ä»–ä¿®æ”¹</h3><p>å¯¹æ¯”[<a href="https://www.91h5.cc/" target="_blank" rel="noopener">snippetä¸»é¢˜demo</a>]å‘ç°ï¼Œè‡ªå·±çš„åšå®¢æ²¡æœ‰<code>åˆ†ç±»</code>å’Œ<code>æ ‡ç­¾</code>ã€‚åªæœ‰ä»¥æ—¶é—´å½’æ¡£ã€‚å¦‚ä½•æ·»åŠ æ–‡ç« <code>åˆ†ç±»</code>å’Œ<code>æ ‡ç­¾</code>ã€‚å¯å‚è€ƒ[<a href="https://github.com/shenliyang/hexo-theme-snippet/blob/master/README.md#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98" target="_blank" rel="noopener">æ•™ç¨‹</a>]ã€‚</p><p>snippetä¸»é¢˜demoç½‘ç«™:</p><div align="left"><p><img src="/img/note_02/12.png" alt></p></div><p></p><p>æ·»åŠ <code>åˆ†ç±»</code>å’Œ<code>æ ‡ç­¾</code>ï¼Œä¸»è¦åœ¨æ–‡ç« ä¸­æ·»åŠ <code>categories</code>å’Œ<code>tags</code> .<br>eg: <code>source-&gt;_posts-&gt;hello-world.md</code>æ–‡ä»¶ä¸­<code>æ·»åŠ </code></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">title: Hello World  </span><br><span class="line">categories:    //æ·»åŠ </span><br><span class="line">- å‰ç«¯</span><br><span class="line">- èµ„æº</span><br><span class="line">tags:          //æ·»åŠ </span><br><span class="line">- <span class="built_in">test</span></span><br><span class="line">- æµ‹è¯•</span><br></pre></td></tr></table></figure><p>æ·»åŠ åæ•ˆæœå¦‚ä¸‹ï¼š</p><div align="left"><p><img src="/img/note_02/13.png" alt></p></div><p></p><h3 id="7ã€å…¶ä»–æŠ€å·§"><a href="#7ã€å…¶ä»–æŠ€å·§" class="headerlink" title="7ã€å…¶ä»–æŠ€å·§"></a>7ã€å…¶ä»–æŠ€å·§</h3><p>æ–‡ç« ä¸­æ·»åŠ å›¾ç‰‡<code>source</code>ä¸‹æ–°å»º<code>img</code>æ–‡ä»¶å¤¹,è¯¥æ–‡ä»¶å¤¹ä¸‹æ”¾å…¥å›¾ç‰‡,å¯é’ˆå¯¹ä¸åŒæ–‡ç« ï¼Œè¿›è¡Œåˆ›å»ºæ–‡ä»¶å¤¹ã€‚</p><div align="left"><p><img src="/img/note_02/14.png" alt></p></div><p></p><p>markdownæ–‡ä»¶ä¸­ï¼Œå›¾ç‰‡ä½¿ç”¨ï¼ˆdiv æ˜¯ä¸ºäº†å›¾ç‰‡å±…å·¦/å±…ä¸­/å±…å³ï¼‰</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">align</span>=<span class="string">"left"</span>&gt;</span></span><br><span class="line">![](/img/note_01/01.png)</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li><strong>ç«™å†…æœç´¢</strong><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-generator-search --save</span><br><span class="line">npm install hexo-generator-json-content --save</span><br></pre></td></tr></table></figure></li></ul><p>é¡¹ç›®ä¸‹çš„<code>_config.yml</code>æ–‡ä»¶æ·»åŠ </p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">search:</span><br><span class="line">  path: search.xml</span><br><span class="line">  field: post</span><br></pre></td></tr></table></figure><p>è¯„è®ºä½¿ç”¨Valineã€‚ä¹Ÿä½¿ç”¨äº†ä¸€ä¸‹[GitHub Issues][<a href="https://imsun.net/posts/gitment-introduction/]" target="_blank" rel="noopener">https://imsun.net/posts/gitment-introduction/]</a> æ˜¾ç¤ºæ•ˆæœä¸æ˜¯å¾ˆå¥½ã€‚è¿˜æœ‰[æ¥å¿…åŠ›][<a href="https://livere.com/]ï¼Œæ³¨å†Œå¥½äº†ä¸€ç›´ç™»å½•ä¸äº†ï¼Œä¹Ÿå¯¼è‡´æ²¡ç”¨è¿‡ã€‚" target="_blank" rel="noopener">https://livere.com/]ï¼Œæ³¨å†Œå¥½äº†ä¸€ç›´ç™»å½•ä¸äº†ï¼Œä¹Ÿå¯¼è‡´æ²¡ç”¨è¿‡ã€‚</a></p><ul><li><strong>æ·»åŠ éŸ³ä¹ä¸è§†é¢‘</strong><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-tag-dplayer --save</span><br><span class="line">npm install hexo-tag-aplayer --save</span><br></pre></td></tr></table></figure></li></ul><p>éŸ³ä¹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayer <span class="string">"æ­Œæ›²åç§°"</span> <span class="string">"ä½œè€…"</span> <span class="string">"éŸ³ä¹_url"</span> <span class="string">"å°é¢å›¾ç‰‡_url"</span> <span class="string">"autoplay"</span> %&#125;</span><br></pre></td></tr></table></figure>        <div id="aplayer-GbeSGKFE" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;">            <pre class="aplayer-lrc-content"></pre>        </div>        <script>          var ap = new APlayer({            element: document.getElementById("aplayer-GbeSGKFE"),            narrow: false,            autoplay: false,            showlrc: false,            music: {              title: "é™ä¸‹æ¥",              author: "å¤§ä¹”å°ä¹”",              url: "/audio/é™ä¸‹æ¥-å¤§ä¹”å°ä¹”.mp3",              pic: "/audio/å¤§ä¹”å°ä¹”.png",              lrc: ""            }          });          window.aplayers || (window.aplayers = []);          window.aplayers.push(ap);        </script><p>æ­Œå•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% aplayerlist %&#125;&#123;<span class="string">"narrow"</span>: <span class="literal">false</span>,<span class="string">"autoplay"</span>: <span class="literal">true</span>,<span class="string">"showlrc"</span>: <span class="number">3</span>,<span class="string">"mode"</span>: <span class="string">"random"</span>,<span class="string">"music"</span>: [&#123;<span class="string">"title"</span>: <span class="string">"æ­Œå"</span>,<span class="string">"author"</span>: <span class="string">"ä½œè€…"</span>,<span class="string">"url"</span>: <span class="string">"éŸ³ä¹_url"</span>,<span class="string">"pic"</span>: <span class="string">"å°é¢å›¾ç‰‡_url"</span>,<span class="string">"lrc"</span>: <span class="string">"æ­Œè¯_url"</span>&#125;,&#123;<span class="string">"title"</span>: <span class="string">"æˆ‘çš„æœªæ¥ä¸æ˜¯æ¢¦"</span>,<span class="string">"author"</span>: <span class="string">"å¼ é›¨ç”Ÿ"</span>,<span class="string">"url"</span>: <span class="string">"/audio/æˆ‘çš„æœªæ¥ä¸æ˜¯æ¢¦-å¼ é›¨ç”Ÿ.mp3"</span>,<span class="string">"pic"</span>: <span class="string">"/audio/å¼ é›¨ç”Ÿ.png"</span>,<span class="string">"lrc"</span>: <span class="string">"/audio/æˆ‘çš„æœªæ¥ä¸æ˜¯æ¢¦-å¼ é›¨ç”Ÿ.txt"</span>&#125;]&#125;&#123;% endaplayerlist %&#125;</span><br></pre></td></tr></table></figure>        <div id="aplayer-JMMgMEOv" class="aplayer aplayer-tag-marker" style="margin-bottom: 20px;"></div>  <script>  var options = {"narrow":false,"autoplay":false,"showlrc":3,"mode":"random","music":[{"title":"é™ä¸‹æ¥","author":"å¤§ä¹”å°ä¹”","url":"/audio/é™ä¸‹æ¥-å¤§ä¹”å°ä¹”.mp3","pic":"/audio/å¤§ä¹”å°ä¹”.png","lrc":"/audio/é™ä¸‹æ¥-å¤§ä¹”å°ä¹”.txt"},{"title":"æˆ‘çš„æœªæ¥ä¸æ˜¯æ¢¦","author":"å¼ é›¨ç”Ÿ","url":"/audio/æˆ‘çš„æœªæ¥ä¸æ˜¯æ¢¦-å¼ é›¨ç”Ÿ.mp3","pic":"/audio/å¼ é›¨ç”Ÿ.png","lrc":"/audio/æˆ‘çš„æœªæ¥ä¸æ˜¯æ¢¦-å¼ é›¨ç”Ÿ.txt"}]};  options.element = document.getElementById("aplayer-JMMgMEOv");  var ap = new APlayer(options);    window.aplayers || (window.aplayers = []);  window.aplayers.push(ap);  </script><p>ç½‘æ˜“äº‘éŸ³ä¹ï¼š<br>å€ŸåŠ©ç½‘æ˜“äº‘éŸ³ä¹å¤–é“¾</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe frameborder=<span class="string">"no"</span> border=<span class="string">"0"</span> marginwidth=<span class="string">"0"</span> marginheight=<span class="string">"0"</span> width=<span class="number">330</span> height=<span class="number">86</span> src=<span class="string">"//music.163.com/outchain/player?type=2&amp;id=1312734832&amp;auto=1&amp;height=66"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span></span><br></pre></td></tr></table></figure><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="100%" height="86" src="//music.163.com/outchain/player?type=2&id=1312734832&auto=0&height=66"></iframe><p>è§†é¢‘</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% dplayer <span class="string">"url=/video/å¤§åœ£å¨¶äº².mkv"</span> <span class="string">"api=http://dplayer.daoapp.io"</span> <span class="string">"pic=/video/å¤§åœ£å¨¶äº².png"</span> <span class="string">"id="</span> <span class="string">"loop=yes"</span> <span class="string">"theme=#FADFA3"</span> <span class="string">"autoplay=false"</span> <span class="string">"token=tokendemo"</span> %&#125;</span><br></pre></td></tr></table></figure><div id="dplayer0" class="dplayer hexo-tag-dplayer-mark" style="margin-bottom: 20px;"></div><script>(function(){var player = new DPlayer({"container":document.getElementById("dplayer0"),"theme":"#FADFA3","loop":true,"video":{"url":"/video/å¤§åœ£å¨¶äº².mkv","pic":"/video/å¤§åœ£å¨¶äº².png"},"danmaku":{"api":"http://dplayer.daoapp.io","token":"tokendemo"}});window.dplayers||(window.dplayers=[]);window.dplayers.push(player);})()</script><p>ä¼˜é…·ï¼š<br>ä¼˜é…·åˆ†äº«ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe height=<span class="number">498</span> width=<span class="number">510</span> src=<span class="string">'http://player.youku.com/embed/XNDAxNzI5MDE0MA=='</span> frameborder=<span class="number">0</span> <span class="string">'allowfullscreen'</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span></span><br></pre></td></tr></table></figure><iframe height="498" width="100%" src="http://player.youku.com/embed/XNDAxNzI5MDE0MA==" frameborder="0" 'allowfullscreen'></iframe><p>çˆ±å¥‡è‰ºï¼š<br>çˆ±å¥‡è‰ºåˆ†äº«ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src=<span class="string">"http://open.iqiyi.com/developer/player_js/coopPlayerIndex.html?vid=71dc8be37ccbecc77685d8c1619d51fb&amp;tvId=414197600&amp;accessToken=2.f22860a2479ad60d8da7697274de9346&amp;appKey=3955c3425820435e86d0f4cdfe56f5e7&amp;appId=1368&amp;height=100%&amp;width=100%"</span> frameborder=<span class="string">"0"</span> allowfullscreen=<span class="string">"true"</span> width=<span class="string">"100%"</span> height=<span class="number">498</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span></span><br></pre></td></tr></table></figure><iframe src="http://open.iqiyi.com/developer/player_js/coopPlayerIndex.html?vid=71dc8be37ccbecc77685d8c1619d51fb&tvId=414197600&accessToken=2.f22860a2479ad60d8da7697274de9346&appKey=3955c3425820435e86d0f4cdfe56f5e7&appId=1368&height=100%&width=100%" frameborder="0" allowfullscreen="true" width="100%" height="498"></iframe><p>æ›´å¤šæŠ€å·§å¯å‚è€ƒhexo apiæ–‡æ¡£</p><h2 id="ä¸‰ã€ä»£ç ç®¡ç†"><a href="#ä¸‰ã€ä»£ç ç®¡ç†" class="headerlink" title="ä¸‰ã€ä»£ç ç®¡ç†"></a>ä¸‰ã€ä»£ç ç®¡ç†</h2><p>è¿™é‡Œçš„ä»£ç åŒ…æ‹¬ä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ä¸ºç¼–å†™ä»£ç ï¼Œå¦ä¸€éƒ¨åˆ†ä¸ºgenerateåçš„ä¸ªäººåšå®¢webä»£ç ã€‚</p><div align="left"><p><img src="/img/note_02/15.png" alt></p></div><p></p><h3 id="1ã€æ³¨å†Œgithub"><a href="#1ã€æ³¨å†Œgithub" class="headerlink" title="1ã€æ³¨å†Œgithub"></a>1ã€æ³¨å†Œgithub</h3><p>å®˜ç½‘ç½‘ç«™:<a href="https://github.com/" target="_blank" rel="noopener">https://github.com/</a></p><div align="left"><p><img src="/img/note_02/16.png" alt></p></div><p></p><h3 id="2ã€åˆ›å»ºé¡¹ç›®"><a href="#2ã€åˆ›å»ºé¡¹ç›®" class="headerlink" title="2ã€åˆ›å»ºé¡¹ç›®"></a>2ã€åˆ›å»ºé¡¹ç›®</h3><p>è¿™é‡Œå»ºè®®åˆ›å»ºä¸¤ä¸ªé¡¹ç›®ã€‚<code>BlogCode</code>å’Œ<code>Blog</code>é¡¹ç›®ã€‚æ­¤å¤„åªè¯´æ˜<code>Blog</code>åˆ›å»ºè¿‡ç¨‹</p><div align="left"><p><img src="/img/note_02/17.png" alt></p></div><p></p><div align="left"><p><img src="/img/note_02/18.png" alt></p></div><p></p><div align="left"><p><img src="/img/note_02/19.png" alt></p></div><p></p><h3 id="3ã€ä¸Šä¼ ä»£ç "><a href="#3ã€ä¸Šä¼ ä»£ç " class="headerlink" title="3ã€ä¸Šä¼ ä»£ç "></a>3ã€ä¸Šä¼ ä»£ç </h3><p>ï¼ˆ1ï¼‰ã€BlogCode</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hexo clean   // åˆ é™¤publicæ–‡ä»¶å¤¹ï¼Œæ­¤æ“ä½œå¯æœ‰å¯æ—  </span><br><span class="line">git init</span><br><span class="line">git status</span><br><span class="line">git add .</span><br><span class="line">git status</span><br><span class="line">git commit</span><br><span class="line">git <span class="built_in">log</span></span><br><span class="line">git remote add origin http://github.com/****/Blog.git</span><br><span class="line">git push orgin master</span><br></pre></td></tr></table></figure><p><code>git init</code>åˆå§‹åŒ–ä»“åº“<br><code>git status .</code>æŸ¥çœ‹éœ€è¦æäº¤çš„æ–‡ä»¶åŠæ–‡ä»¶å¤¹</p><div align="left"><p><img src="/img/note_02/20.png" alt></p></div><br><code>git add .</code> add æ‰€æœ‰æ–‡ä»¶<p></p><div align="left"><p><img src="/img/note_02/21.png" alt></p></div><br><code>git status .</code> æŸ¥çœ‹å·²addçš„æ–‡ä»¶<p></p><div align="left"><p><img src="/img/note_02/22.png" alt></p></div><br><code>git commit</code>æäº¤æ–‡ä»¶<p></p><div align="left"><p><img src="/img/note_02/23.png" alt></p></div><br>è¾“å…¥æäº¤è®°å½•<p></p><div align="left"><p><img src="/img/note_02/24.png" alt></p></div><br><code>git remote add orgin https://gitbub.com/***/BlogCode.git</code><br><code>git push origin master</code><br>è¾“å…¥git ç”¨æˆ·åå’Œå¯†ç <p></p><div align="left"><p><img src="/img/note_02/25.png" alt></p></div><br>ä¹‹åå¯åœ¨github ä¸Šçœ‹åˆ°å·²å…¥åº“çš„ä»£ç <p></p><div align="left"><p><img src="/img/note_02/26.png" alt></p></div><br>ï¼ˆ2ï¼‰ã€Blog<br>Blogéœ€è¦ä¸Šä¼ çš„ä»£ç ä¸»è¦ä¸º<code>public</code>ç›®å½•ä¸‹çš„æ–‡ä»¶<p></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo g</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/note_02/27.png" alt></p></div><br>Blogä¸Šä¼ æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œéœ€è¦ä¿®æ”¹<code>Hexo-&gt;_config.yml</code>æ–‡ä»¶<p></p><div align="left"><p><img src="/img/note_02/28.png" alt></p></div><br>ä¹‹åæ“ä½œ<p></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br><span class="line">hexo clean</span><br><span class="line">hexo g</span><br><span class="line">hexo deploy</span><br></pre></td></tr></table></figure><div align="left"><p><img src="/img/note_02/29.png" alt></p></div><p></p><h2 id="å››ã€å‘å¸ƒåšå®¢"><a href="#å››ã€å‘å¸ƒåšå®¢" class="headerlink" title="å››ã€å‘å¸ƒåšå®¢"></a>å››ã€å‘å¸ƒåšå®¢</h2><h3 id="1ã€è´­ä¹°åŸŸå-å¯ä¸è´­ä¹°ï¼Œä½¿ç”¨githubè´¦å·å-github-ioè®¿é—®"><a href="#1ã€è´­ä¹°åŸŸå-å¯ä¸è´­ä¹°ï¼Œä½¿ç”¨githubè´¦å·å-github-ioè®¿é—®" class="headerlink" title="1ã€è´­ä¹°åŸŸå (å¯ä¸è´­ä¹°ï¼Œä½¿ç”¨githubè´¦å·å.github.ioè®¿é—®)"></a>1ã€è´­ä¹°åŸŸå (å¯ä¸è´­ä¹°ï¼Œä½¿ç”¨<code>githubè´¦å·å.github.io</code>è®¿é—®)</h3><p><a href="https://wanwang.aliyun.com/domain/newgtld/?spm=5176.8006371.772226.domainshowtop.50277e63zHRWjy#.top" target="_blank" rel="noopener">é˜¿é‡ŒåŸŸå</a>,è¿™é‡Œé€‰ç”¨topåŸŸåï¼Œè´­ä¹°åéœ€å®åè®¤è¯ï¼Œæ²¡è®¤è¯æ— æ³•ä½¿ç”¨ã€‚</p><h3 id="2ã€ä½¿ç”¨github-ioè®¿é—®"><a href="#2ã€ä½¿ç”¨github-ioè®¿é—®" class="headerlink" title="2ã€ä½¿ç”¨github.ioè®¿é—®"></a>2ã€ä½¿ç”¨github.ioè®¿é—®</h3><p>ï¼ˆ1ï¼‰ã€ä¿®æ”¹githubä¸Šä¿®æ”¹Repository name<code>Blog</code>ä¸º<code>è´¦æˆ·å.github.io</code>ã€‚</p><div align="left"><p><img src="/img/note_02/30.png" alt></p></div><p></p><div align="left"><p><img src="/img/note_02/31.png" alt></p></div><br>ï¼ˆ2ï¼‰æµè§ˆå™¨<code>è´¦æˆ·å.github.io</code><p></p><div align="left"><p><img src="/img/note_02/32.png" alt></p></div><p></p><h3 id="3ã€ä½¿ç”¨è´­ä¹°åŸŸå-top-è®¿é—®"><a href="#3ã€ä½¿ç”¨è´­ä¹°åŸŸå-top-è®¿é—®" class="headerlink" title="3ã€ä½¿ç”¨è´­ä¹°åŸŸå(.top)è®¿é—®"></a>3ã€ä½¿ç”¨è´­ä¹°åŸŸå(.top)è®¿é—®</h3><p>å¯ä¸ºè´­ä¹°çš„åŸŸåæ·»åŠ å‰ç¼€æ¯”å¦‚â€œ<code>blog</code>â€ã€‚CNAME è®°å½• å°†â€œblog.xx.topâ€é‡å®šå‘åˆ°â€œxx.github.ioâ€ã€‚<br>åœ¨é˜¿é‡ŒåŸŸåè§£ææ·»åŠ ï¼š</p><div align="left"><p><img src="/img/note_02/33.png" alt></p></div><p></p>]]></content>
      
      <categories>
          
          <category> ç¬”è®° </category>
          
      </categories>
      
      
    </entry>
    
  
  
</search>
